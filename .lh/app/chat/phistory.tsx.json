{
    "sourceFile": "app/chat/phistory.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1757327869512,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1757327908296,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1148 +1,28 @@\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n+import React, { useEffect } from \"react\";\r\n+import { View, Text, ScrollView } from \"react-native\";\r\n+import { useLocalSearchParams } from \"expo-router\";\r\n \r\n-const { width } = Dimensions.get(\"window\");\r\n+export default function ChatRoomDebug() {\r\n+  const params = useLocalSearchParams();\r\n \r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  \r\n   useEffect(() => {\r\n-    AsyncStorage.getItem(\"passengerId\")\r\n-      .then((v) => setPassengerId(v))\r\n-      .catch(() => setPassengerId(null));\r\n-  }, []);\r\n+    console.log(\"ChatRoom params:\", params);\r\n+  }, [params]);\r\n \r\n-  const canShowChatNotice =\r\n-    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+  const bookingId = params.bookingId;\r\n+  const driverId = params.driverId;\r\n+  const passengerId = params.passengerId;\r\n+  const role = params.role;\r\n \r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n-\r\n-      const coords = data.features[0].geometry.coordinates; \r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n-\r\n-      const summary = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM = summary.distance ?? 0;\r\n-      const durationS = summary.duration ?? 0;\r\n-\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60\r\n-        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n-        : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n-      const fareText = `‚Ç±${computedFare} est`;\r\n-      setFare(computedFare);\r\n-\r\n-      mapRef.current?.postMessage(JSON.stringify({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm, \r\n-        distanceText,     \r\n-        durationText,\r\n-        fareText,  \r\n-      }));\r\n-\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n-    }\r\n-  };\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-\r\n-      // bail if we don‚Äôt have the user‚Äôs location yet\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lon = location.longitude;\r\n-        const url = `${API_BASE_URL}/api/geocode?q=${encodeURIComponent(t)}&lat=${lat}&lon=${lon}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lon: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lon };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    mapRef.current?.postMessage(JSON.stringify({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    }));\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      // fire once right away, so the dot appears even before watch ticks\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-      }\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          mapRef.current?.postMessage(JSON.stringify({\r\n-            type: \"updateUserLoc\",\r\n-            latitude: pos.coords.latitude,\r\n-            longitude: pos.coords.longitude,\r\n-            accuracy: pos.coords.accuracy ?? 15,\r\n-            avatarUrl,\r\n-          }));\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            mapRef.current?.postMessage(JSON.stringify({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            }));\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  useEffect(() => {\r\n-    const backAction = () => {\r\n-      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-        { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-        {\r\n-          text: \"Logout\",\r\n-          onPress: async () => {\r\n-            await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\");\r\n-          },\r\n-        },\r\n-      ]);\r\n-      return true;\r\n-    };\r\n-    const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-    return () => backHandler.remove();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location) return;\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        // --- Map init ---\r\n-        const map = L.map('map', { zoomControl:true })\r\n-          .setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        // --- Helpers ---\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip( { permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-        }\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            upsertUserMarker(msg.latitude, msg.longitude);\r\n-            return;\r\n-          }\r\n-\r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n-            clearRoute();\r\n-\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n-              .setContent(label || '')\r\n-              .setLatLng(mid)\r\n-              .addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n-            }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [location]);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-  }, [mapHtml, location, avatarUrl]);\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-\r\n-    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare, paymentMethod, notes, passengerId\r\n-    };\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-      setBookingId(result.booking.id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  \r\n-  \r\n-\r\n-  // Set markers & trigger route drawing when destination is picked\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n-\r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    if (searching && (!bookingId || tripCompleted)) {\r\n-      setSearching(false);\r\n-    }\r\n-  }, [searching, bookingId, tripCompleted]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n-          mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n   return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-          {status === \"accepted\" && bookingId && (\r\n-            <ChatNotice\r\n-              bookingId={bookingId}\r\n-              role=\"passenger\"\r\n-              onGoToChat={() =>\r\n-                router.push({\r\n-                  pathname: \"/chat\",\r\n-                  query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-                })\r\n-              }\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-              {/* Destination search */}\r\n-              <View style={styles.searchWrap}>\r\n-                <TextInput\r\n-                  value={query}\r\n-                  onChangeText={onChangeQuery}\r\n-                  placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                  placeholderTextColor=\"#777\"\r\n-                  style={styles.searchInput}\r\n-                />\r\n-                {hits.length > 0 && (\r\n-                  <View style={styles.searchResults}>\r\n-                    {hits.map((h, i) => (\r\n-                      <TouchableOpacity\r\n-                        key={`${h.lat},${h.lon}-${i}`}\r\n-                        onPress={() => choosePlace(h)}\r\n-                        style={styles.searchItem}\r\n-                      >\r\n-                        <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-                )}\r\n-              </View>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }} style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }} />\r\n-                        )}\r\n-                        <View style={{ flex: 1}}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                        </View>\r\n-                      </View>\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch {}\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n-                            mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                </ScrollView>\r\n-                <View style={styles.fareContainer}>\r\n-                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!matchedDriver && !searching && !showBookingForm && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n+    <ScrollView style={{ flex: 1, padding: 16 }}>\r\n+      <Text style={{ fontWeight: \"700\", fontSize: 18, marginBottom: 8 }}>\r\n+        ChatRoom Debug\r\n+      </Text>\r\n+      <Text>bookingId: {String(bookingId ?? \"‚Äî\")}</Text>\r\n+      <Text>driverId: {String(driverId ?? \"‚Äî\")}</Text>\r\n+      <Text>passengerId: {String(passengerId ?? \"‚Äî\")}</Text>\r\n+      <Text>role: {String(role ?? \"‚Äî\")}</Text>\r\n+    </ScrollView>\r\n   );\r\n }\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-  \r\n-});\r\n"
                }
            ],
            "date": 1757327869512,
            "name": "Commit-0",
            "content": "import React, { useState, useEffect, useRef } from \"react\";\r\nimport { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\nimport { Picker } from \"@react-native-picker/picker\";\r\nimport { WebView } from \"react-native-webview\";\r\nimport type { WebView as WebViewType } from \"react-native-webview\";\r\nimport { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\nimport { useLocation } from \"../location/GlobalLocation\";\r\nimport { router } from 'expo-router';\r\nimport AsyncStorage from '@react-native-async-storage/async-storage';\r\nimport { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\nimport * as Location from 'expo-location';\r\nimport ChatNotice from \"../../components/ChatNotice\";\r\n\r\nconst { width } = Dimensions.get(\"window\");\r\n\r\ntype DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n\r\nconst calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n\r\n  const BASE_FARE = 20;   \r\n  const INCLUDED_KM = 2;\r\n  const PER_KM = 5;      \r\n\r\n  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n\r\n  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n\r\n  // 20% discount for senior/student/PWD\r\n  if (discount !== 'none') fare *= 0.8;\r\n\r\n  return Math.round(fare); \r\n};\r\nconst [currentBooking, setCurrentBooking] = useState<any>(null);\r\n\r\n\r\n\r\nexport default function PHome() {\r\n  const { location, loading } = useLocation();\r\n  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n  const [notes, setNotes] = useState(\"\");\r\n  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n  const [fare, setFare] = useState(0);\r\n  const [mapHtml, setMapHtml] = useState(\"\");\r\n  const mapRef = useRef<WebViewType>(null);\r\n  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n  const [matchedDriver, setMatchedDriver] = useState<{\r\n    driverName: string;\r\n    driverId: string;\r\n    franchiseNumber: string;\r\n    experienceYears: string;\r\n    selfieImage: string;\r\n    location: { latitude: number; longitude: number };\r\n  } | null>(null);\r\n  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n  const [bookingId, setBookingId] = useState<any>(null);\r\n  const [showBookingForm, setShowBookingForm] = useState(false);\r\n  const [searching, setSearching] = useState(false);\r\n  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n  const [showRatingModal, setShowRatingModal] = useState(false);\r\n  const [selectedRating, setSelectedRating] = useState(0);\r\n  const [tripCompleted, setTripCompleted] = useState(false);\r\n  const [showReportModal, setShowReportModal] = useState(false);\r\n  const [reportType, setReportType] = useState(\"\");\r\n  const [otherReport, setOtherReport] = useState(\"\");\r\n  const [pickupName, setPickupName] = useState(\"\");\r\n  const [dropoffName, setDropoffName] = useState(\"\");\r\n  const [showDropdown, setShowDropdown] = useState(false);\r\n  const [discount] = useState<DiscountType>('none'); \r\n  const [query, setQuery] = useState('');\r\n  const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n  const driverId = currentBooking?.driverId;\r\n  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n  \r\n  useEffect(() => {\r\n    AsyncStorage.getItem(\"passengerId\")\r\n      .then((v) => setPassengerId(v))\r\n      .catch(() => setPassengerId(null));\r\n  }, []);\r\n\r\n  const canShowChatNotice =\r\n    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n\r\n  // ---------- ORS: fetch route and draw in WebView ----------\r\n  const fetchORSRoute = async (\r\n    from: { latitude: number; longitude: number },\r\n    to: { latitude: number; longitude: number }\r\n  ) => {\r\n    try {\r\n      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          start: [from.longitude, from.latitude],\r\n          end: [to.longitude, to.latitude],\r\n        }),\r\n      });\r\n\r\n      const data = await res.json();\r\n\r\n      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n        console.error(\"üõë Invalid ORS response:\", data);\r\n        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n        return;\r\n      }\r\n\r\n      const coords = data.features[0].geometry.coordinates; \r\n      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n\r\n      const summary = data.features?.[0]?.properties?.summary || {};\r\n      const distanceM = summary.distance ?? 0;\r\n      const durationS = summary.duration ?? 0;\r\n\r\n      const distanceKm = distanceM / 1000;\r\n\r\n      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n      const mins = Math.round(durationS / 60);\r\n      const durationText = mins >= 60\r\n        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n        : `${mins} min`;\r\n\r\n      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n      const fareText = `‚Ç±${computedFare} est`;\r\n      setFare(computedFare);\r\n\r\n      mapRef.current?.postMessage(JSON.stringify({\r\n        type: 'drawRoute',\r\n        route: polylinePoints,\r\n        distanceKm, \r\n        distanceText,     \r\n        durationText,\r\n        fareText,  \r\n      }));\r\n\r\n    } catch (err) {\r\n      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n    }\r\n  };\r\n\r\n  const onChangeQuery = (t: string) => {\r\n    setQuery(t);\r\n\r\n    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n    searchTimerRef.current = setTimeout(async () => {\r\n      if (!t || t.length < 3) { setHits([]); return; }\r\n\r\n      // bail if we don‚Äôt have the user‚Äôs location yet\r\n      if (!location) { setHits([]); return; }\r\n\r\n      try {\r\n        const lat = location.latitude;\r\n        const lon = location.longitude;\r\n        const url = `${API_BASE_URL}/api/geocode?q=${encodeURIComponent(t)}&lat=${lat}&lon=${lon}`;\r\n        const r = await fetch(url);\r\n        const data = await r.json();\r\n        setHits(Array.isArray(data) ? data : []);\r\n      } catch {\r\n        setHits([]);\r\n      }\r\n    }, 300);\r\n  };\r\n\r\n\r\n  // When a user taps a suggestion\r\n  const choosePlace = (p: { label: string; lat: number; lon: number }) => {\r\n    setQuery(p.label);\r\n    setHits([]);\r\n\r\n    const dest = { latitude: p.lat, longitude: p.lon };\r\n\r\n    // update UI\r\n    setDestination(dest);\r\n    setDropoffName(p.label);\r\n\r\n    // ‚úÖ make sure we actually have current location\r\n    if (!location) {\r\n      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n      return;\r\n    }\r\n\r\n    // draw route immediately\r\n    fetchORSRoute(\r\n      { latitude: location.latitude, longitude: location.longitude },\r\n      dest\r\n    );\r\n\r\n    // (optional) update markers\r\n    mapRef.current?.postMessage(JSON.stringify({\r\n      type: 'setMarkers',\r\n      destination: dest,\r\n      driver: null,\r\n    }));\r\n  };\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n      try {\r\n        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n        if (!passengerId) return setAvatarUrl(fallback);\r\n\r\n        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n        const j = await r.json();\r\n        const img =\r\n          j?.passenger?.profileImage ||\r\n          j?.passenger?.selfieImage ||\r\n          j?.passenger?.avatar;\r\n        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n      } catch {\r\n        setAvatarUrl(fallback);\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    let sub: Location.LocationSubscription | null = null;\r\n\r\n    (async () => {\r\n      const { status } = await Location.requestForegroundPermissionsAsync();\r\n      if (status !== \"granted\") return;\r\n\r\n      // fire once right away, so the dot appears even before watch ticks\r\n      if (location && mapRef.current) {\r\n        mapRef.current.postMessage(JSON.stringify({\r\n          type: \"updateUserLoc\",\r\n          latitude: location.latitude,\r\n          longitude: location.longitude,\r\n          accuracy: 15,\r\n          avatarUrl,\r\n        }));\r\n      }\r\n\r\n      sub = await Location.watchPositionAsync(\r\n        {\r\n          accuracy: Location.Accuracy.Balanced,\r\n          timeInterval: 5000,\r\n          distanceInterval: 5,\r\n        },\r\n        (pos) => {\r\n          mapRef.current?.postMessage(JSON.stringify({\r\n            type: \"updateUserLoc\",\r\n            latitude: pos.coords.latitude,\r\n            longitude: pos.coords.longitude,\r\n            accuracy: pos.coords.accuracy ?? 15,\r\n            avatarUrl,\r\n          }));\r\n        }\r\n      );\r\n    })();\r\n\r\n    return () => sub?.remove();\r\n  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n\r\n  useEffect(() => {\r\n    let headSub: Location.LocationSubscription | null = null;\r\n\r\n    (async () => {\r\n      try {\r\n        headSub = await Location.watchHeadingAsync((h) => {\r\n          const bearing =\r\n            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n          if (bearing !== null) {\r\n            mapRef.current?.postMessage(JSON.stringify({\r\n              type: \"updateHeading\",\r\n              bearingDeg: bearing,\r\n            }));\r\n          }\r\n        });\r\n      } catch {\r\n        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n      }\r\n    })();\r\n\r\n    return () => headSub?.remove();\r\n  }, []);\r\n\r\n\r\n\r\n\r\n  // ---------------------------------------------------------\r\n\r\n  // Reverse geocode for pick-up location\r\n  useEffect(() => {\r\n    if (location) {\r\n      Location.reverseGeocodeAsync({\r\n        latitude: location.latitude,\r\n        longitude: location.longitude,\r\n      }).then((results) => {\r\n        if (results && results.length > 0) {\r\n          const addr = results[0];\r\n          setPickupName(\r\n            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n          );\r\n        } else {\r\n          setPickupName(\"Current Location\");\r\n        }\r\n      }).catch(() => setPickupName(\"Current Location\"));\r\n    }\r\n  }, [location]);\r\n\r\n  // Handle Android hardware back button (logout prompt)\r\n  useEffect(() => {\r\n    const backAction = () => {\r\n      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n        { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n        {\r\n          text: \"Logout\",\r\n          onPress: async () => {\r\n            await AsyncStorage.removeItem(\"passengerId\");\r\n            router.replace(\"/login_and_reg/plogin\");\r\n          },\r\n        },\r\n      ]);\r\n      return true;\r\n    };\r\n    const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n    return () => backHandler.remove();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n        if (!passengerId) return;\r\n        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n        const j = await r.json();\r\n        const path: string | undefined =\r\n          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n        if (path) {\r\n          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n        } else {\r\n          setAvatarUrl(null); // no image, still show blue dot\r\n        }\r\n      } catch {\r\n        setAvatarUrl(null);\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n\r\n  // Generate map HTML when location changes\r\n  useEffect(() => {\r\n  if (!location) return;\r\n\r\n  const html = String.raw`\r\n  <!DOCTYPE html>\r\n  <html>\r\n    <head>\r\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n      <style>\r\n        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n        .distance-label.leaflet-tooltip{\r\n          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n          font-size:12px;line-height:1;white-space:nowrap;\r\n        }\r\n        .distance-label.leaflet-tooltip:before{ display:none; }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div id=\"map\"></div>\r\n      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n      <script>\r\n        // --- Map init ---\r\n        const map = L.map('map', { zoomControl:true })\r\n          .setView([${location.latitude}, ${location.longitude}], 15);\r\n\r\n        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n        }).addTo(map);\r\n\r\n        // --- State ---\r\n        let userMarker = null;       // blue marker for passenger\r\n        let destMarker = null;       // green dot\r\n        let driverMarker = null;     // car icon\r\n        let destinationLocked = false;\r\n\r\n        let routeLine = null;        // drawn polyline\r\n        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n\r\n        // --- Icons ---\r\n        const userIcon = L.icon({\r\n          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n          iconSize: [30, 30],\r\n          iconAnchor: [15, 30], // bottom center\r\n        });\r\n\r\n        const destIcon = L.icon({\r\n          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n          iconSize: [30, 30],\r\n          iconAnchor: [15, 30],\r\n        });\r\n\r\n        const carIcon = L.icon({\r\n          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n          iconSize: [40, 40],\r\n          iconAnchor: [20, 40],\r\n        });\r\n\r\n        // --- Helpers ---\r\n        function upsertUserMarker(lat, lng){\r\n          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n          if (!userMarker){\r\n            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n              .addTo(map)\r\n              .bindTooltip( { permanent:true, direction:\"top\" });\r\n          } else {\r\n            userMarker.setLatLng([lat,lng]);\r\n          }\r\n        }\r\n\r\n        function setDestination(lat, lng){\r\n          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n            .addTo(map)\r\n            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n        }\r\n\r\n        function setDriver(lat, lng){\r\n          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n              .addTo(map)\r\n              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n              .setZIndexOffset(1100);\r\n          }\r\n        }\r\n\r\n        function clearRoute(){\r\n          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n        }\r\n\r\n        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n        map.on('click', function(e){\r\n          if (destinationLocked) return;\r\n          const { lat, lng } = e.latlng;\r\n          setDestination(lat, lng);\r\n          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n        });\r\n\r\n        // --- Message bridge ---\r\n        document.addEventListener('message', function(event){\r\n          let msg = {};\r\n          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n\r\n          // Live passenger location (blue marker only)\r\n          if (msg.type === 'updateUserLoc'){\r\n            upsertUserMarker(msg.latitude, msg.longitude);\r\n            return;\r\n          }\r\n\r\n          // Heading intentionally ignored (no cone)\r\n          if (msg.type === 'updateHeading'){ return; }\r\n\r\n          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n            clearRoute();\r\n\r\n            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n\r\n            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n              .setContent(label || '')\r\n              .setLatLng(mid)\r\n              .addTo(map);\r\n            return;\r\n          }\r\n\r\n          // Clear route\r\n          if (msg.type === 'clearRoute'){\r\n            clearRoute();\r\n            return;\r\n          }\r\n\r\n          // Driver + Destination markers\r\n          if (msg.type === 'setMarkers'){\r\n            destinationLocked = !!msg.driver;\r\n\r\n            // destination\r\n            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n            } else if (destMarker){\r\n              map.removeLayer(destMarker); destMarker = null;\r\n            }\r\n\r\n            // driver\r\n            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n            } else if (driverMarker){\r\n              map.removeLayer(driverMarker); driverMarker = null;\r\n            }\r\n\r\n            return;\r\n          }\r\n        });\r\n      </script>\r\n    </body>\r\n  </html>\r\n  `;\r\n  setMapHtml(html);\r\n  }, [location]);\r\n\r\n\r\n\r\n  useEffect(() => {\r\n    if (!mapRef.current || !location) return;\r\n    mapRef.current.postMessage(JSON.stringify({\r\n      type: \"updateUserLoc\",\r\n      latitude: location.latitude,\r\n      longitude: location.longitude,\r\n      accuracy: 15,\r\n      avatarUrl,\r\n    }));\r\n  }, [mapHtml, location, avatarUrl]);\r\n\r\n\r\n  // Reverse geocode for drop-off location\r\n  const handleMapMessage = async (event: any) => {\r\n    try {\r\n      const parsed = JSON.parse(event.nativeEvent.data);\r\n      if (parsed.latitude && parsed.longitude) {\r\n        setDestination(parsed);\r\n        try {\r\n          const results = await Location.reverseGeocodeAsync({\r\n            latitude: parsed.latitude, longitude: parsed.longitude,\r\n          });\r\n          if (results && results.length > 0) {\r\n            const addr = results[0];\r\n            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n          } else {\r\n            setDropoffName(\"Selected Location\");\r\n          }\r\n        } catch {\r\n          setDropoffName(\"Selected Location\");\r\n        }\r\n      }\r\n    } catch {}\r\n  };\r\n\r\n  const handleBookNow = async () => {\r\n    if (!location || !destination) {\r\n      Alert.alert(\"Missing location info\");\r\n      return;\r\n    }\r\n    setAlertedBookingComplete(false);\r\n    setTripCompleted(false);\r\n\r\n    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n    const bookingData = {\r\n      pickupLat: location.latitude,\r\n      pickupLng: location.longitude,\r\n      destinationLat: destination.latitude,\r\n      destinationLng: destination.longitude,\r\n      fare, paymentMethod, notes, passengerId\r\n    };\r\n\r\n    try {\r\n      // reset any old polling\r\n      if (searchTimeoutRef.current) {\r\n        clearTimeout(searchTimeoutRef.current);\r\n        searchTimeoutRef.current = null;\r\n      }\r\n\r\n      setShowBookingForm(false);\r\n      setSearching(true);\r\n\r\n      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(bookingData),\r\n      });\r\n\r\n      const result = await response.json();\r\n      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n      setBookingId(result.booking.id);\r\n    } catch (e: any) {\r\n      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n      setSearching(false);\r\n    }\r\n  };\r\n\r\n  \r\n  \r\n\r\n  // Set markers & trigger route drawing when destination is picked\r\n  useEffect(() => {\r\n    if (!mapRef.current || bookingConfirmed) return;\r\n\r\n    const driverCoords = matchedDriver?.location\r\n      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n      : null;\r\n\r\n    if (driverCoords && destination) {\r\n      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n    }\r\n\r\n    // üëâ draw route as soon as we have both ends\r\n    if (destination && location) {\r\n      fetchORSRoute(location, destination);\r\n    }\r\n  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n\r\n  useEffect(() => {\r\n    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n    return () => { showSub.remove(); hideSub.remove(); };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const saveDriverId = async () => {\r\n      if (matchedDriver && bookingId) {\r\n        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n      }\r\n    };\r\n    saveDriverId();\r\n  }, [matchedDriver, bookingId]);\r\n\r\n  useEffect(() => {\r\n    let interval: any;\r\n    const pollForDriverMatch = async () => {\r\n      if (!bookingId) return;\r\n      try {\r\n        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n        const allBookings = await res.json();\r\n        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n\r\n        if (!myBooking) return;\r\n\r\n        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n          setBookingConfirmed(true);\r\n          setSearching(false);\r\n          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n\r\n          if (myBooking.driverId) {\r\n            try {\r\n              const [driverRes, statusRes] = await Promise.all([\r\n                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n              ]);\r\n              const driverData = await driverRes.json();\r\n              const statusData = await statusRes.json();\r\n\r\n              if (driverData?.driver) {\r\n                setMatchedDriver({\r\n                  driverName: driverData.driver.driverName,\r\n                  driverId: driverData.driver._id,\r\n                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n                  location: statusData.location || null,\r\n                });\r\n              }\r\n            } catch {}\r\n          }\r\n        }\r\n      } catch {}\r\n    };\r\n    interval = setInterval(pollForDriverMatch, 4000);\r\n    return () => clearInterval(interval);\r\n  }, [bookingId, bookingConfirmed]);\r\n\r\n  useEffect(() => {\r\n    if (searching && (!bookingId || tripCompleted)) {\r\n      setSearching(false);\r\n    }\r\n  }, [searching, bookingId, tripCompleted]);\r\n\r\n  useEffect(() => {\r\n    let interval: any;\r\n    const pollForBookingCompletion = async () => {\r\n      if (!bookingId) return;\r\n      try {\r\n        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n        const allBookings = await res.json();\r\n        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n        setAlertedBookingComplete(false);\r\n        setTripCompleted(false);\r\n\r\n        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n          setAlertedBookingComplete(true);\r\n          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n\r\n          // üîß reset session so user can book again\r\n          setSearching(false);                                     // <-- key line\r\n          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n            clearTimeout(searchTimeoutRef.current);\r\n            searchTimeoutRef.current = null;\r\n          }\r\n\r\n          setBookingConfirmed(false);\r\n          setBookingId(null);\r\n          setMatchedDriver(null);\r\n          setDestination(null);\r\n          setShowBookingForm(false);\r\n          setTripCompleted(true);\r\n\r\n          // optional: tidy UI state\r\n          setQuery('');\r\n          setHits([]);\r\n\r\n          // clear saved ‚Äúsearching:true‚Äù from storage\r\n          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n\r\n          // clear map\r\n          mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n          mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n\r\n          setFare(0);\r\n        }\r\n\r\n      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n    };\r\n    interval = setInterval(pollForBookingCompletion, 4000);\r\n    return () => clearInterval(interval);\r\n  }, [bookingId]);\r\n\r\n  useEffect(() => {\r\n    const saveBookingState = async () => {\r\n      const bookingState = {\r\n        destination, destinationLabel, notes, paymentMethod, fare,\r\n        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n      };\r\n      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n    };\r\n    saveBookingState();\r\n  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n\r\n  useEffect(() => {\r\n    const loadBookingState = async () => {\r\n      try {\r\n        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n        if (savedState) {\r\n          const s = JSON.parse(savedState);\r\n          if (s.destination) setDestination(s.destination);\r\n          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n          if (s.notes) setNotes(s.notes);\r\n          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n          if (s.fare) setFare(s.fare);\r\n          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n          if (s.bookingId) setBookingId(s.bookingId);\r\n          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n          if (s.searching) setSearching(s.searching);\r\n        }\r\n      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n    };\r\n    loadBookingState();\r\n  }, []);\r\n\r\n  const submitDriverRating = async () => {\r\n    try {\r\n      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n      if (!driverIdToRate || !bookingIdToRate) {\r\n        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n        return;\r\n      }\r\n      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n      });\r\n\r\n      if (res.ok && notes) {\r\n        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            bookingId: bookingIdToRate,\r\n            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n            driverId: driverIdToRate,\r\n            feedback: notes,\r\n          }),\r\n        });\r\n      }\r\n\r\n      if (res.ok) {\r\n        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n        setShowRatingModal(false);\r\n        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n      } else {\r\n        const data = await res.json();\r\n        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"‚ùå Failed to submit rating:\", error);\r\n      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n    }\r\n  };\r\n\r\n  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n\r\n  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n\r\n  const submitReport = async () => {\r\n    try {\r\n      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n        }),\r\n      });\r\n      if (res.ok) {\r\n        Alert.alert(\"Success\", \"Report submitted!\");\r\n        setShowReportModal(false);\r\n      } else {\r\n        const data = await res.json();\r\n        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n      }\r\n    } catch (error) {\r\n      console.error(\"‚ùå Failed to submit report:\", error);\r\n      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n    }\r\n  };\r\n\r\n  if (loading || !location) return null;\r\n\r\n  return (\r\n    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n        <View style={styles.container}>\r\n          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n          {mapHtml && (\r\n            <WebView\r\n              scrollEnabled\r\n              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n              originWhitelist={[\"*\"]}\r\n              source={{ html: mapHtml }}\r\n              javaScriptEnabled\r\n              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n              onMessage={handleMapMessage}\r\n              nestedScrollEnabled\r\n            />\r\n          )}\r\n          {status === \"accepted\" && bookingId && (\r\n            <ChatNotice\r\n              bookingId={bookingId}\r\n              role=\"passenger\"\r\n              onGoToChat={() =>\r\n                router.push({\r\n                  pathname: \"/chat\",\r\n                  query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n                })\r\n              }\r\n            />\r\n          )}\r\n\r\n          <View style={styles.overlayContainer}>\r\n            <View style={styles.overlay}>\r\n              {/* Destination search */}\r\n              <View style={styles.searchWrap}>\r\n                <TextInput\r\n                  value={query}\r\n                  onChangeText={onChangeQuery}\r\n                  placeholder=\"Search destination (e.g., SM Lucena)\"\r\n                  placeholderTextColor=\"#777\"\r\n                  style={styles.searchInput}\r\n                />\r\n                {hits.length > 0 && (\r\n                  <View style={styles.searchResults}>\r\n                    {hits.map((h, i) => (\r\n                      <TouchableOpacity\r\n                        key={`${h.lat},${h.lon}-${i}`}\r\n                        onPress={() => choosePlace(h)}\r\n                        style={styles.searchItem}\r\n                      >\r\n                        <Text style={styles.searchItemText}>{h.label}</Text>\r\n                      </TouchableOpacity>\r\n                    ))}\r\n                  </View>\r\n                )}\r\n              </View>\r\n\r\n              {searching && (\r\n                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n                  <TouchableOpacity\r\n                    onPress={() => {\r\n                      setSearching(false);\r\n                      setBookingId(null);\r\n                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                    }}\r\n                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n                  >\r\n                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              )}\r\n\r\n              {matchedDriver && (\r\n                <View\r\n                  style={{\r\n                    position: \"absolute\",\r\n                    bottom: -100,\r\n                    left: 0,\r\n                    right: 0,\r\n                    marginHorizontal: 20,\r\n                    backgroundColor: \"#d1fcd3\",\r\n                    borderRadius: 10,\r\n                    padding: 10,\r\n                    elevation: 3,\r\n                  }}\r\n                >\r\n                  {infoBoxMinimized ? (\r\n                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n                    </TouchableOpacity>\r\n                  ) : (\r\n                    <>\r\n                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n                        {matchedDriver.selfieImage && (\r\n                          <Image source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }} style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }} />\r\n                        )}\r\n                        <View style={{ flex: 1}}>\r\n                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                          <Text>Name: {matchedDriver.driverName}</Text>\r\n                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                        </View>\r\n                      </View>\r\n                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                        </TouchableOpacity>\r\n\r\n                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n                        </TouchableOpacity>\r\n\r\n                        <TouchableOpacity\r\n                          onPress={async () => {\r\n                            try {\r\n                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n                                method: \"POST\",\r\n                                headers: { \"Content-Type\": \"application/json\" },\r\n                                body: JSON.stringify({ bookingId }),\r\n                              });\r\n                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n                            } catch {}\r\n                            setSearching(false);\r\n                            setBookingId(null);\r\n                            setMatchedDriver(null);\r\n                            setDestination(null);\r\n                            setBookingConfirmed(false);\r\n                            mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n                            mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n                            setFare(0);\r\n                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                          }}\r\n                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n                        >\r\n                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n                        </TouchableOpacity>\r\n                      </View>\r\n                    </>\r\n                  )}\r\n                </View>\r\n              )}\r\n            </View>\r\n\r\n            {showBookingForm && (\r\n              <View style={styles.panel}>\r\n                <Text style={styles.panelTitle}>Booking Details</Text>\r\n                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n                </ScrollView>\r\n                <View style={styles.fareContainer}>\r\n                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            )}\r\n\r\n            {!matchedDriver && !searching && !showBookingForm && (\r\n              <TouchableOpacity\r\n                onPress={() => setShowBookingForm(true)}\r\n                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n              >\r\n                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n              </TouchableOpacity>\r\n            )}\r\n\r\n            {showRatingModal && (\r\n              <View style={styles.ratingModalOverlay}>\r\n                <View style={styles.ratingModal}>\r\n                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n                  </TouchableOpacity>\r\n\r\n                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n\r\n                  <View style={styles.starsContainer}>\r\n                    {[1, 2, 3, 4, 5].map((star) => (\r\n                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n                      </TouchableOpacity>\r\n                    ))}\r\n                  </View>\r\n\r\n                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n\r\n                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n                    <Text style={styles.submitButtonText}>Submit</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            )}\r\n\r\n            {showReportModal && (\r\n              <View style={styles.ratingModalOverlay}>\r\n                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n                  </TouchableOpacity>\r\n\r\n                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n\r\n                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n                  <View style={styles.dropdownContainer}>\r\n                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n                    </TouchableOpacity>\r\n\r\n                    {showDropdown && (\r\n                      <View style={styles.dropdownMenu}>\r\n                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n                          </TouchableOpacity>\r\n                        ))}\r\n                      </View>\r\n                    )}\r\n                  </View>\r\n\r\n                  {reportType === \"Other\" && (\r\n                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n                  )}\r\n\r\n                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n                  </TouchableOpacity>\r\n                </View>\r\n              </View>\r\n            )}\r\n          </View>\r\n        </View>\r\n      </TouchableWithoutFeedback>\r\n    </KeyboardAvoidingView>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n  overlay: { width: width, margin: 60 },\r\n  searchWrap: {\r\n    width: '90%',\r\n    alignSelf: 'center',\r\n    zIndex: 20,            // stay above map\r\n  },\r\n  searchInput: {\r\n    backgroundColor: '#FFF',\r\n    borderRadius: 10,\r\n    borderWidth: 1,\r\n    borderColor: '#ddd',\r\n    padding: 10,\r\n  },\r\n  searchResults: {\r\n    marginTop: 4,\r\n    backgroundColor: '#FFF',\r\n    borderRadius: 10,\r\n    borderWidth: 1,\r\n    borderColor: '#ddd',\r\n    maxHeight: 200,\r\n    overflow: 'hidden',\r\n  },\r\n  searchItem: {\r\n    paddingVertical: 10,\r\n    paddingHorizontal: 12,\r\n    borderBottomWidth: 1,\r\n    borderBottomColor: '#eee',\r\n  },\r\n  searchItemText: {\r\n    color: '#111',\r\n  },\r\n\r\n  panel: {\r\n    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n  },\r\n  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n  ratingModalOverlay: {\r\n    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n  },\r\n  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n  dropdownButton: {\r\n    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n  },\r\n  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n  dropdownItem: { padding: 10 },\r\n  totalFare: { fontWeight: 'bold' },\r\n  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n  bottomNav: {\r\n    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n  },\r\n  \r\n});\r\n"
        }
    ]
}