{
    "sourceFile": "app/homedriver/gcashsettings.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 17,
            "patches": [
                {
                    "date": 1762346944488,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1762347203918,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -188,60 +188,89 @@\n                         Help: How to Get My GCash QR Code\r\n                     </Text>\r\n                 </TouchableOpacity>\r\n \r\n-                    {helpOpen && (\r\n-                        <View\r\n+                {helpOpen && (\r\n+                <View\r\n+                    style={{\r\n+                    position: \"absolute\",\r\n+                    top: 0,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    bottom: 0,\r\n+                    backgroundColor: \"rgba(0,0,0,0.5)\",\r\n+                    justifyContent: \"center\",\r\n+                    alignItems: \"center\",\r\n+                    padding: 20,\r\n+                    }}\r\n+                >\r\n+                    <View\r\n+                        style={{\r\n+                        backgroundColor: \"#fff\",\r\n+                        borderRadius: 12,\r\n+                        padding: 16,\r\n+                        width: \"100%\",\r\n+                        maxWidth: 420,\r\n+                        maxHeight: \"90%\",\r\n+                        }}\r\n+                    >\r\n+                        <Text style={{ fontWeight: \"bold\", fontSize: 18, marginBottom: 12, textAlign: \"center\" }}>\r\n+                            How to Get Your Personal GCash QR Code\r\n+                        </Text>\r\n+                        <Image\r\n+                            source={require(\"../../assets/images/gcash/1.png\")}\r\n+                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n+                            resizeMode=\"contain\"\r\n+                        />\r\n+                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n+                            Step 1: Open your GCash app and log in to your account.\r\n+                        </Text>\r\n+\r\n+                        <Image\r\n+                            source={require(\"../../assets/images/gcash/2.png\")}\r\n+                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n+                            resizeMode=\"contain\"\r\n+                        />\r\n+                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n+                            Step 2: Tap your profile or the “QR” option on the main screen.\r\n+                        </Text>\r\n+\r\n+                        <Image\r\n+                            source={require(\"../../assets/images/gcash/3.png\")}\r\n+                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n+                            resizeMode=\"contain\"\r\n+                        />\r\n+                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n+                            Step 3: Select “My QR” to see your personal QR code.\r\n+                        </Text>\r\n+\r\n+                        <Image\r\n+                            source={require(\"../../assets/images/gcash/4.png\")}\r\n+                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n+                            resizeMode=\"contain\"\r\n+                        />\r\n+                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n+                            Step 4: Save or screenshot your QR code to upload here.\r\n+                        </Text>\r\n+\r\n+                        <TouchableOpacity\r\n+                            onPress={() => setHelpOpen(false)}\r\n                             style={{\r\n-                                position: \"absolute\",\r\n-                                top: 0,\r\n-                                left: 0,\r\n-                                right: 0,\r\n-                                bottom: 0,\r\n-                                backgroundColor: \"rgba(0,0,0,0.5)\",\r\n-                                justifyContent: \"center\",\r\n-                                alignItems: \"center\",\r\n-                                padding: 20,\r\n+                            backgroundColor: \"#0ea5e9\",\r\n+                            padding: 10,\r\n+                            borderRadius: 8,\r\n+                            alignSelf: \"center\",\r\n+                            minWidth: 120,\r\n+                            marginTop: 10,\r\n                             }}\r\n                         >\r\n-                            <View\r\n-                                style={{\r\n-                                    backgroundColor: \"#fff\",\r\n-                                    borderRadius: 12,\r\n-                                    padding: 16,\r\n-                                    width: \"100%\",\r\n-                                    maxWidth: 400,\r\n-                                }}\r\n-                            >\r\n-                                <Text style={{ fontWeight: \"bold\", fontSize: 18, marginBottom: 8 }}>\r\n-                                    How to Get Your Personal GCash QR\r\n-                                </Text>\r\n-                                {/* <Image\r\n-                                    source={require(\"../../assets/images/gcash_tutorial_placeholder.png\")} \r\n-                                    style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 10 }}\r\n-                                    resizeMode=\"contain\"\r\n-                                /> */}\r\n+                            <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Close</Text>\r\n+                        </TouchableOpacity>\r\n+                    </View>\r\n+                </View>\r\n+                )}\r\n \r\n-                                <Text style={{ fontSize: 14, color: \"#374151\", marginBottom: 12 }}>\r\n-                                    Replace this image and text with your actual tutorial steps or screenshots.\r\n-                                </Text>\r\n \r\n-                                <TouchableOpacity\r\n-                                    onPress={() => setHelpOpen(false)}\r\n-                                    style={{\r\n-                                    backgroundColor: \"#0ea5e9\",\r\n-                                    padding: 10,\r\n-                                    borderRadius: 8,\r\n-                                    alignSelf: \"center\",\r\n-                                    minWidth: 120,\r\n-                                    }}\r\n-                                >\r\n-                                    <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Close</Text>\r\n-                                </TouchableOpacity>\r\n-                            </View>\r\n-                        </View>\r\n-                    )}\r\n-\r\n             </View>\r\n \r\n         </ScrollView>\r\n     );\r\n"
                },
                {
                    "date": 1762347882687,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -180,98 +180,15 @@\n                     number belong to the same account. This ensures passengers can send payment directly without errors.\r\n                 </Text>\r\n \r\n                 <TouchableOpacity\r\n-                    onPress={() => setHelpOpen(true)}\r\n+                    onPress={() => navigation.navigate(\"gctutorial\")}\r\n                     style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8, marginTop: 4 }}\r\n                 >\r\n                     <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n                         Help: How to Get My GCash QR Code\r\n                     </Text>\r\n                 </TouchableOpacity>\r\n-\r\n-                {helpOpen && (\r\n-                <View\r\n-                    style={{\r\n-                    position: \"absolute\",\r\n-                    top: 0,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    bottom: 0,\r\n-                    backgroundColor: \"rgba(0,0,0,0.5)\",\r\n-                    justifyContent: \"center\",\r\n-                    alignItems: \"center\",\r\n-                    padding: 20,\r\n-                    }}\r\n-                >\r\n-                    <View\r\n-                        style={{\r\n-                        backgroundColor: \"#fff\",\r\n-                        borderRadius: 12,\r\n-                        padding: 16,\r\n-                        width: \"100%\",\r\n-                        maxWidth: 420,\r\n-                        maxHeight: \"90%\",\r\n-                        }}\r\n-                    >\r\n-                        <Text style={{ fontWeight: \"bold\", fontSize: 18, marginBottom: 12, textAlign: \"center\" }}>\r\n-                            How to Get Your Personal GCash QR Code\r\n-                        </Text>\r\n-                        <Image\r\n-                            source={require(\"../../assets/images/gcash/1.png\")}\r\n-                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n-                            resizeMode=\"contain\"\r\n-                        />\r\n-                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n-                            Step 1: Open your GCash app and log in to your account.\r\n-                        </Text>\r\n-\r\n-                        <Image\r\n-                            source={require(\"../../assets/images/gcash/2.png\")}\r\n-                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n-                            resizeMode=\"contain\"\r\n-                        />\r\n-                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n-                            Step 2: Tap your profile or the “QR” option on the main screen.\r\n-                        </Text>\r\n-\r\n-                        <Image\r\n-                            source={require(\"../../assets/images/gcash/3.png\")}\r\n-                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n-                            resizeMode=\"contain\"\r\n-                        />\r\n-                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n-                            Step 3: Select “My QR” to see your personal QR code.\r\n-                        </Text>\r\n-\r\n-                        <Image\r\n-                            source={require(\"../../assets/images/gcash/4.png\")}\r\n-                            style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 6 }}\r\n-                            resizeMode=\"contain\"\r\n-                        />\r\n-                        <Text style={{ fontSize: 13, color: \"#374151\", marginBottom: 10, textAlign: \"center\" }}>\r\n-                            Step 4: Save or screenshot your QR code to upload here.\r\n-                        </Text>\r\n-\r\n-                        <TouchableOpacity\r\n-                            onPress={() => setHelpOpen(false)}\r\n-                            style={{\r\n-                            backgroundColor: \"#0ea5e9\",\r\n-                            padding: 10,\r\n-                            borderRadius: 8,\r\n-                            alignSelf: \"center\",\r\n-                            minWidth: 120,\r\n-                            marginTop: 10,\r\n-                            }}\r\n-                        >\r\n-                            <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Close</Text>\r\n-                        </TouchableOpacity>\r\n-                    </View>\r\n-                </View>\r\n-                )}\r\n-\r\n-\r\n             </View>\r\n-\r\n         </ScrollView>\r\n     );\r\n }\r\n"
                },
                {
                    "date": 1762347893645,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,9 +3,11 @@\n import * as ImagePicker from \"expo-image-picker\";\r\n import * as Clipboard from \"expo-clipboard\";\r\n import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n import { API_BASE_URL } from \"../../config\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n \r\n+\r\n type LocalAsset = { uri: string; name?: string; type?: string };\r\n \r\n export default function GCashSettings() {\r\n     const [driverId, setDriverId] = useState<string>(\"\");\r\n"
                },
                {
                    "date": 1762347903219,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n     const [qrUrl, setQrUrl] = useState<string | null>(null);\r\n     const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n     const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n     const [loading, setLoading] = useState(false);\r\n-    const [helpOpen, setHelpOpen] = useState(false);\r\n+    const navigation = useNavigation<any>();\r\n \r\n \r\n     useEffect(() => {\r\n         (async () => {\r\n"
                },
                {
                    "date": 1762348751560,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,9 +35,8 @@\n                     const url = (j.gcashQRUrl || \"\").trim();\r\n                     setQrUrl(url);\r\n                     setLastGoodQrUrl(url);               \r\n                 } else {\r\n-                    console.log(\"payment-info not ok:\", j);\r\n                 }\r\n             } catch (e) {\r\n                 console.log(\"load driver id/payment-info failed:\", e);\r\n             }\r\n"
                },
                {
                    "date": 1762350098332,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,10 +16,13 @@\n     const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n     const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n     const [loading, setLoading] = useState(false);\r\n     const navigation = useNavigation<any>();\r\n+    const [imgVersion, setImgVersion] = useState(0); \r\n+    const [isFetching, setIsFetching] = useState(false);\r\n \r\n \r\n+\r\n     useEffect(() => {\r\n         (async () => {\r\n             try {\r\n                 const id = await AsyncStorage.getItem(\"driverId\");\r\n"
                },
                {
                    "date": 1762350178644,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,10 +19,29 @@\n     const navigation = useNavigation<any>();\r\n     const [imgVersion, setImgVersion] = useState(0); \r\n     const [isFetching, setIsFetching] = useState(false);\r\n \r\n+    const fetchPaymentInfo = async (id: string) => {\r\n+        try {\r\n+            setIsFetching(true);\r\n+            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, { headers: { Accept: \"application/json\" }});\r\n+            const j = await r.json();\r\n+            if (j?.ok && j.gcashQRUrl) {\r\n+            const url = (j.gcashQRUrl || \"\").trim();\r\n+            setQrUrl(url);\r\n+            setLastGoodQrUrl(url);\r\n+            setImgVersion((v) => v + 1); // force <Image> to reload\r\n+            }\r\n+        } catch (e) {\r\n+            console.log(\"fetchPaymentInfo error:\", e);\r\n+        } finally {\r\n+            setIsFetching(false);\r\n+        }\r\n+        };\r\n \r\n \r\n+\r\n+\r\n     useEffect(() => {\r\n         (async () => {\r\n             try {\r\n                 const id = await AsyncStorage.getItem(\"driverId\");\r\n"
                },
                {
                    "date": 1762350190505,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,12 +25,12 @@\n             setIsFetching(true);\r\n             const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, { headers: { Accept: \"application/json\" }});\r\n             const j = await r.json();\r\n             if (j?.ok && j.gcashQRUrl) {\r\n-            const url = (j.gcashQRUrl || \"\").trim();\r\n-            setQrUrl(url);\r\n-            setLastGoodQrUrl(url);\r\n-            setImgVersion((v) => v + 1); // force <Image> to reload\r\n+                const url = (j.gcashQRUrl || \"\").trim();\r\n+                setQrUrl(url);\r\n+                setLastGoodQrUrl(url);\r\n+                setImgVersion((v) => v + 1); \r\n             }\r\n         } catch (e) {\r\n             console.log(\"fetchPaymentInfo error:\", e);\r\n         } finally {\r\n"
                },
                {
                    "date": 1762350251770,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -49,8 +49,9 @@\n                 Alert.alert(\"Auth\", \"Driver ID not found. Please log in again.\");\r\n                 return;\r\n                 }\r\n                 setDriverId(id);\r\n+                await fetchPaymentInfo(id);\r\n \r\n                 const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`);\r\n                 const j = await r.json();\r\n                 if (j?.ok && j.gcashQRUrl) {\r\n"
                },
                {
                    "date": 1762350333922,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -93,30 +93,34 @@\n             // @ts-ignore\r\n             form.append(\"qr\", { uri: localQR.uri, name: localQR.name || \"gcashqr.jpg\", type: localQR.type || \"image/jpeg\" });\r\n \r\n             const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n-                method: \"POST\",\r\n-                headers: { Accept: \"application/json\" },\r\n-                body: form,\r\n+            method: \"POST\",\r\n+            headers: { Accept: \"application/json\" },\r\n+            body: form,\r\n             });\r\n             const j = await r.json();\r\n             if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n \r\n             const newUrl = (j.gcashQRUrl || \"\").trim();\r\n             if (newUrl) {\r\n-                setQrUrl(newUrl);\r\n-                setLastGoodQrUrl(newUrl);     \r\n-                setLocalQR(null);             \r\n-                Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n+            setQrUrl(newUrl);\r\n+            setLastGoodQrUrl(newUrl);\r\n+            setImgVersion((v) => v + 1);\r\n             } else {\r\n+            await fetchPaymentInfo(driverId);\r\n             }\r\n+\r\n+            setLocalQR(null);\r\n+            Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n         } catch (e: any) {\r\n             Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n         } finally {\r\n             setLoading(false);\r\n         }\r\n-    };\r\n+        };\r\n \r\n+\r\n     const saveNumber = async () => {\r\n         if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n         try {\r\n             setLoading(true);\r\n"
                },
                {
                    "date": 1762350366410,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -141,9 +141,9 @@\n     };\r\n \r\n     // decide what to preview: local (unsaved) first, otherwise remote\r\n     const previewUri = (localQR?.uri || qrUrl || lastGoodQrUrl || \"\").trim();\r\n-    const previewSource = previewUri ? { uri: `${previewUri}?t=${Date.now()}` } : undefined;\r\n+    const previewSource = previewUri ? { uri: `${previewUri}?v=${imgVersion}` } : undefined;\r\n \r\n     return (\r\n         <ScrollView contentContainerStyle={{ padding: 16, gap: 16 }}>\r\n             <Text style={{ fontSize: 22, fontWeight: \"bold\" }}>GCash Settings</Text>\r\n"
                },
                {
                    "date": 1762350502426,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -58,8 +58,9 @@\n                     const url = (j.gcashQRUrl || \"\").trim();\r\n                     setQrUrl(url);\r\n                     setLastGoodQrUrl(url);               \r\n                 } else {\r\n+                    Alert.alert(\"Warning\", \"Upload succeeded but no URL returned. Keeping previous image.\");\r\n                 }\r\n             } catch (e) {\r\n                 console.log(\"load driver id/payment-info failed:\", e);\r\n             }\r\n"
                },
                {
                    "date": 1762351505046,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,32 +16,10 @@\n     const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n     const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n     const [loading, setLoading] = useState(false);\r\n     const navigation = useNavigation<any>();\r\n-    const [imgVersion, setImgVersion] = useState(0); \r\n-    const [isFetching, setIsFetching] = useState(false);\r\n \r\n-    const fetchPaymentInfo = async (id: string) => {\r\n-        try {\r\n-            setIsFetching(true);\r\n-            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, { headers: { Accept: \"application/json\" }});\r\n-            const j = await r.json();\r\n-            if (j?.ok && j.gcashQRUrl) {\r\n-                const url = (j.gcashQRUrl || \"\").trim();\r\n-                setQrUrl(url);\r\n-                setLastGoodQrUrl(url);\r\n-                setImgVersion((v) => v + 1); \r\n-            }\r\n-        } catch (e) {\r\n-            console.log(\"fetchPaymentInfo error:\", e);\r\n-        } finally {\r\n-            setIsFetching(false);\r\n-        }\r\n-        };\r\n \r\n-\r\n-\r\n-\r\n     useEffect(() => {\r\n         (async () => {\r\n             try {\r\n                 const id = await AsyncStorage.getItem(\"driverId\");\r\n@@ -49,18 +27,16 @@\n                 Alert.alert(\"Auth\", \"Driver ID not found. Please log in again.\");\r\n                 return;\r\n                 }\r\n                 setDriverId(id);\r\n-                await fetchPaymentInfo(id);\r\n \r\n                 const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`);\r\n                 const j = await r.json();\r\n                 if (j?.ok && j.gcashQRUrl) {\r\n                     const url = (j.gcashQRUrl || \"\").trim();\r\n                     setQrUrl(url);\r\n                     setLastGoodQrUrl(url);               \r\n                 } else {\r\n-                    Alert.alert(\"Warning\", \"Upload succeeded but no URL returned. Keeping previous image.\");\r\n                 }\r\n             } catch (e) {\r\n                 console.log(\"load driver id/payment-info failed:\", e);\r\n             }\r\n@@ -94,34 +70,30 @@\n             // @ts-ignore\r\n             form.append(\"qr\", { uri: localQR.uri, name: localQR.name || \"gcashqr.jpg\", type: localQR.type || \"image/jpeg\" });\r\n \r\n             const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n-            method: \"POST\",\r\n-            headers: { Accept: \"application/json\" },\r\n-            body: form,\r\n+                method: \"POST\",\r\n+                headers: { Accept: \"application/json\" },\r\n+                body: form,\r\n             });\r\n             const j = await r.json();\r\n             if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n \r\n             const newUrl = (j.gcashQRUrl || \"\").trim();\r\n             if (newUrl) {\r\n-            setQrUrl(newUrl);\r\n-            setLastGoodQrUrl(newUrl);\r\n-            setImgVersion((v) => v + 1);\r\n+                setQrUrl(newUrl);\r\n+                setLastGoodQrUrl(newUrl);     \r\n+                setLocalQR(null);             \r\n+                Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n             } else {\r\n-            await fetchPaymentInfo(driverId);\r\n             }\r\n-\r\n-            setLocalQR(null);\r\n-            Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n         } catch (e: any) {\r\n             Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n         } finally {\r\n             setLoading(false);\r\n         }\r\n-        };\r\n+    };\r\n \r\n-\r\n     const saveNumber = async () => {\r\n         if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n         try {\r\n             setLoading(true);\r\n@@ -142,9 +114,9 @@\n     };\r\n \r\n     // decide what to preview: local (unsaved) first, otherwise remote\r\n     const previewUri = (localQR?.uri || qrUrl || lastGoodQrUrl || \"\").trim();\r\n-    const previewSource = previewUri ? { uri: `${previewUri}?v=${imgVersion}` } : undefined;\r\n+    const previewSource = previewUri ? { uri: `${previewUri}?t=${Date.now()}` } : undefined;\r\n \r\n     return (\r\n         <ScrollView contentContainerStyle={{ padding: 16, gap: 16 }}>\r\n             <Text style={{ fontSize: 22, fontWeight: \"bold\" }}>GCash Settings</Text>\r\n"
                },
                {
                    "date": 1762351988031,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,9 @@\n import * as Clipboard from \"expo-clipboard\";\r\n import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n import { API_BASE_URL } from \"../../config\";\r\n import { useNavigation } from \"@react-navigation/native\";\r\n+import { useFocusEffect } from \"@react-navigation/native\";\r\n \r\n \r\n type LocalAsset = { uri: string; name?: string; type?: string };\r\n \r\n@@ -16,10 +17,15 @@\n     const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n     const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n     const [loading, setLoading] = useState(false);\r\n     const navigation = useNavigation<any>();\r\n+    \r\n+    useFocusEffect(\r\n+    React.useCallback(() => {\r\n+        if (driverId) fetchPaymentInfo(driverId);\r\n+    }, [driverId])\r\n+    );\r\n \r\n-\r\n     useEffect(() => {\r\n         (async () => {\r\n             try {\r\n                 const id = await AsyncStorage.getItem(\"driverId\");\r\n@@ -70,30 +76,34 @@\n             // @ts-ignore\r\n             form.append(\"qr\", { uri: localQR.uri, name: localQR.name || \"gcashqr.jpg\", type: localQR.type || \"image/jpeg\" });\r\n \r\n             const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n-                method: \"POST\",\r\n-                headers: { Accept: \"application/json\" },\r\n-                body: form,\r\n+            method: \"POST\",\r\n+            headers: { Accept: \"application/json\" },\r\n+            body: form,\r\n             });\r\n             const j = await r.json();\r\n             if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n \r\n+            // Prefer the returned URL, but don't depend on it\r\n             const newUrl = (j.gcashQRUrl || \"\").trim();\r\n             if (newUrl) {\r\n-                setQrUrl(newUrl);\r\n-                setLastGoodQrUrl(newUrl);     \r\n-                setLocalQR(null);             \r\n-                Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n-            } else {\r\n+            setQrUrl(newUrl);\r\n+            setLastGoodQrUrl(newUrl);\r\n             }\r\n+\r\n+            setLocalQR(null);                 // disable the Save button\r\n+            Alert.alert(\"Saved\", \"GCash QR updated.\");   // <-- always show success\r\n+            // Re-fetch to be 100% in sync (handles the “new public_id” case)\r\n+            await fetchPaymentInfo(driverId);\r\n         } catch (e: any) {\r\n             Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n         } finally {\r\n             setLoading(false);\r\n         }\r\n-    };\r\n+        };\r\n \r\n+\r\n     const saveNumber = async () => {\r\n         if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n         try {\r\n             setLoading(true);\r\n"
                },
                {
                    "date": 1762352030962,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,8 +17,9 @@\n     const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n     const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n     const [loading, setLoading] = useState(false);\r\n     const navigation = useNavigation<any>();\r\n+    const [imgVersion, setImgVersion] = useState(0);\r\n     \r\n     useFocusEffect(\r\n     React.useCallback(() => {\r\n         if (driverId) fetchPaymentInfo(driverId);\r\n@@ -99,11 +100,31 @@\n             Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n         } finally {\r\n             setLoading(false);\r\n         }\r\n-        };\r\n+    };\r\n \r\n+    const fetchPaymentInfo = async (id: string) => {\r\n+        try {\r\n+            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, {\r\n+            headers: { Accept: \"application/json\" },\r\n+            });\r\n+            const j = await r.json();\r\n+            if (j?.ok && j.gcashQRUrl) {\r\n+            const url = (j.gcashQRUrl || \"\").trim();\r\n+            if (url) {\r\n+                setQrUrl(url);\r\n+                setLastGoodQrUrl(url);\r\n+                setImgVersion(v => v + 1); // cache-bust the <Image>\r\n+            }\r\n+            }\r\n+            // If no url returned, do NOTHING (keep lastGood)\r\n+        } catch (e) {\r\n+            console.log(\"fetchPaymentInfo error:\", e);\r\n+        }\r\n+    };\r\n \r\n+\r\n     const saveNumber = async () => {\r\n         if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n         try {\r\n             setLoading(true);\r\n"
                },
                {
                    "date": 1762353573798,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,224 +3,284 @@\n import * as ImagePicker from \"expo-image-picker\";\r\n import * as Clipboard from \"expo-clipboard\";\r\n import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n import { API_BASE_URL } from \"../../config\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { useFocusEffect } from \"@react-navigation/native\";\r\n+import { useNavigation, useFocusEffect } from \"@react-navigation/native\";\r\n \r\n-\r\n type LocalAsset = { uri: string; name?: string; type?: string };\r\n \r\n export default function GCashSettings() {\r\n-    const [driverId, setDriverId] = useState<string>(\"\");\r\n-    const [gcashNumber, setGcashNumber] = useState(\"\");\r\n-    const [qrUrl, setQrUrl] = useState<string | null>(null);\r\n-    const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n-    const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n-    const [loading, setLoading] = useState(false);\r\n-    const navigation = useNavigation<any>();\r\n-    const [imgVersion, setImgVersion] = useState(0);\r\n-    \r\n-    useFocusEffect(\r\n+  const [driverId, setDriverId] = useState<string>(\"\");\r\n+  const [gcashNumber, setGcashNumber] = useState(\"\");\r\n+  const [qrUrl, setQrUrl] = useState<string | null>(null);            // latest server URL\r\n+  const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null); // sticky fallback\r\n+  const [localQR, setLocalQR] = useState<LocalAsset | null>(null);    // unsaved preview\r\n+  const [loading, setLoading] = useState(false);\r\n+  const navigation = useNavigation<any>();\r\n+  const [imgVersion, setImgVersion] = useState(0);                    // cache-buster for <Image>\r\n+\r\n+  // ---------- DEBUG HELPERS ----------\r\n+  const log = (...args: any[]) => console.log(\"GCASH: \", ...args);\r\n+\r\n+  const logState = (label: string) => {\r\n+    log(`${label} | driverId=`, driverId);\r\n+    log(`${label} | qrUrl=`, qrUrl);\r\n+    log(`${label} | lastGoodQrUrl=`, lastGoodQrUrl);\r\n+    log(`${label} | localQR.uri=`, localQR?.uri);\r\n+  };\r\n+\r\n+  // Centralized fetcher: NEVER blanks a working preview\r\n+  const fetchPaymentInfo = async (id: string, ctx: string = \"fetchPaymentInfo\") => {\r\n+    try {\r\n+      log(`[${ctx}] GET /payment-info for id=`, id);\r\n+      const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, {\r\n+        headers: { Accept: \"application/json\" },\r\n+      });\r\n+      const raw = await r.text();\r\n+      log(`[${ctx}] /payment-info raw=`, raw);\r\n+      let j: any;\r\n+      try { j = JSON.parse(raw); } catch { j = { ok: false, parseError: true, raw }; }\r\n+\r\n+      if (j?.ok && j.gcashQRUrl) {\r\n+        const url = String(j.gcashQRUrl || \"\").trim();\r\n+        if (url) {\r\n+          setQrUrl(url);\r\n+          setLastGoodQrUrl(url);\r\n+          setImgVersion(v => v + 1);\r\n+          log(`[${ctx}] set qrUrl+lastGood ->`, url);\r\n+          return url;\r\n+        }\r\n+      } else {\r\n+        log(`[${ctx}] response missing url or not ok:`, j);\r\n+      }\r\n+      return null;\r\n+    } catch (e: any) {\r\n+      log(`[${ctx}] ERROR /payment-info:`, e?.message || e);\r\n+      return null;\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const id = await AsyncStorage.getItem(\"driverId\");\r\n+        log(\"useEffect: got driverId=\", id);\r\n+        if (!id) {\r\n+          Alert.alert(\"Auth\", \"Driver ID not found. Please log in again.\");\r\n+          return;\r\n+        }\r\n+        setDriverId(id);\r\n+        await fetchPaymentInfo(id, \"mount\");\r\n+      } catch (e) {\r\n+        log(\"useEffect error:\", e);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  // Re-fetch whenever the screen gets focus (and driverId is known)\r\n+  useFocusEffect(\r\n     React.useCallback(() => {\r\n-        if (driverId) fetchPaymentInfo(driverId);\r\n+      if (!driverId) return;\r\n+      log(\"focus: refetching payment info\");\r\n+      fetchPaymentInfo(driverId, \"focus\");\r\n     }, [driverId])\r\n-    );\r\n+  );\r\n \r\n-    useEffect(() => {\r\n-        (async () => {\r\n-            try {\r\n-                const id = await AsyncStorage.getItem(\"driverId\");\r\n-                if (!id) {\r\n-                Alert.alert(\"Auth\", \"Driver ID not found. Please log in again.\");\r\n-                return;\r\n-                }\r\n-                setDriverId(id);\r\n+  const chooseQR = async () => {\r\n+    const perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\r\n+    if (!perm.granted) return Alert.alert(\"Permission needed\", \"Allow Photos to select a QR.\");\r\n \r\n-                const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`);\r\n-                const j = await r.json();\r\n-                if (j?.ok && j.gcashQRUrl) {\r\n-                    const url = (j.gcashQRUrl || \"\").trim();\r\n-                    setQrUrl(url);\r\n-                    setLastGoodQrUrl(url);               \r\n-                } else {\r\n-                }\r\n-            } catch (e) {\r\n-                console.log(\"load driver id/payment-info failed:\", e);\r\n-            }\r\n-        })();\r\n-    }, []);\r\n+    const result = await ImagePicker.launchImageLibraryAsync({\r\n+      mediaTypes: ImagePicker.MediaTypeOptions.Images,\r\n+      quality: 0.9,\r\n+    });\r\n+    if (result.canceled || !result.assets?.length) return;\r\n \r\n-    const chooseQR = async () => {\r\n-        const perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\r\n-            if (!perm.granted) return Alert.alert(\"Permission needed\", \"Allow Photos to select a QR.\");\r\n-            const result = await ImagePicker.launchImageLibraryAsync({\r\n-            mediaTypes: ImagePicker.MediaTypeOptions.Images,\r\n-            quality: 0.9,\r\n-        });\r\n-        if (result.canceled || !result.assets?.length) return;\r\n+    const a = result.assets[0];\r\n+    setLocalQR({\r\n+      uri: a.uri,\r\n+      name: \"gcashqr.jpg\",\r\n+      type: a.mimeType || \"image/jpeg\",\r\n+    });\r\n+    log(\"chooseQR: localQR set to\", a.uri);\r\n+    logState(\"after chooseQR\");\r\n+  };\r\n \r\n-        const a = result.assets[0];\r\n-            setLocalQR({\r\n-            uri: a.uri,\r\n-            name: \"gcashqr.jpg\",\r\n-            type: a.mimeType || \"image/jpeg\",\r\n-        });\r\n-    };\r\n+  const saveQR = async () => {\r\n+    if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n+    if (!localQR) return Alert.alert(\"No image\", \"Choose a QR image first.\");\r\n \r\n-    const saveQR = async () => {\r\n-        if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n-        if (!localQR) return Alert.alert(\"No image\", \"Choose a QR image first.\");\r\n+    try {\r\n+      setLoading(true);\r\n+      logState(\"before saveQR\");\r\n \r\n-        try {\r\n-            setLoading(true);\r\n-            const form = new FormData();\r\n-            // @ts-ignore\r\n-            form.append(\"qr\", { uri: localQR.uri, name: localQR.name || \"gcashqr.jpg\", type: localQR.type || \"image/jpeg\" });\r\n+      const form = new FormData();\r\n+      // @ts-ignore RN file\r\n+      form.append(\"qr\", {\r\n+        uri: localQR.uri,\r\n+        name: localQR.name || \"gcashqr.jpg\",\r\n+        type: localQR.type || \"image/jpeg\",\r\n+      });\r\n \r\n-            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n-            method: \"POST\",\r\n-            headers: { Accept: \"application/json\" },\r\n-            body: form,\r\n-            });\r\n-            const j = await r.json();\r\n-            if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n+      log(\"saveQR: POST /gcash-qr start\");\r\n+      const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n+        method: \"POST\",\r\n+        headers: { Accept: \"application/json\" },\r\n+        body: form,\r\n+      });\r\n+      const raw = await r.text();\r\n+      log(\"saveQR: /gcash-qr raw=\", raw);\r\n \r\n-            // Prefer the returned URL, but don't depend on it\r\n-            const newUrl = (j.gcashQRUrl || \"\").trim();\r\n-            if (newUrl) {\r\n-            setQrUrl(newUrl);\r\n-            setLastGoodQrUrl(newUrl);\r\n-            }\r\n+      let j: any;\r\n+      try { j = JSON.parse(raw); } catch { j = { ok: false, parseError: true, raw }; }\r\n+      if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n \r\n-            setLocalQR(null);                 // disable the Save button\r\n-            Alert.alert(\"Saved\", \"GCash QR updated.\");   // <-- always show success\r\n-            // Re-fetch to be 100% in sync (handles the “new public_id” case)\r\n-            await fetchPaymentInfo(driverId);\r\n-        } catch (e: any) {\r\n-            Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n-        } finally {\r\n-            setLoading(false);\r\n-        }\r\n-    };\r\n+      // Prefer returned URL if present\r\n+      let confirmedUrl = (j.gcashQRUrl ? String(j.gcashQRUrl).trim() : \"\") || \"\";\r\n+      log(\"saveQR: returned newUrl=\", confirmedUrl);\r\n \r\n-    const fetchPaymentInfo = async (id: string) => {\r\n-        try {\r\n-            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, {\r\n-            headers: { Accept: \"application/json\" },\r\n-            });\r\n-            const j = await r.json();\r\n-            if (j?.ok && j.gcashQRUrl) {\r\n-            const url = (j.gcashQRUrl || \"\").trim();\r\n-            if (url) {\r\n-                setQrUrl(url);\r\n-                setLastGoodQrUrl(url);\r\n-                setImgVersion(v => v + 1); // cache-bust the <Image>\r\n-            }\r\n-            }\r\n-            // If no url returned, do NOTHING (keep lastGood)\r\n-        } catch (e) {\r\n-            console.log(\"fetchPaymentInfo error:\", e);\r\n-        }\r\n-    };\r\n+      // If backend did NOT return a URL (race or minimal payload), refetch now\r\n+      if (!confirmedUrl) {\r\n+        log(\"saveQR: no url in response; refetching /payment-info...\");\r\n+        const fetched = await fetchPaymentInfo(driverId, \"after-save-refetch\");\r\n+        confirmedUrl = fetched || \"\";\r\n+        log(\"saveQR: refetched url=\", confirmedUrl);\r\n+      }\r\n \r\n+      if (confirmedUrl) {\r\n+        // Commit the new URL and bust cache\r\n+        setQrUrl(confirmedUrl);\r\n+        setLastGoodQrUrl(confirmedUrl);\r\n+        setImgVersion(v => v + 1);\r\n+        log(\"saveQR: committed url=\", confirmedUrl);\r\n+        // Now we’re safe to clear the local preview (disables button)\r\n+        setLocalQR(null);\r\n+      } else {\r\n+        // Keep local preview to avoid \"No QR\" flash\r\n+        log(\"saveQR: still no confirmed url; keeping localQR for UI safety\");\r\n+      }\r\n \r\n-    const saveNumber = async () => {\r\n-        if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n-        try {\r\n-            setLoading(true);\r\n-            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-number`, {\r\n-                method: \"POST\",\r\n-                headers: { \"Content-Type\": \"application/json\" },\r\n-                body: JSON.stringify({ gcashNumber }),\r\n-            });\r\n-            const j = await r.json();\r\n-            if (!j.ok) throw new Error(j.error || \"Save failed\");\r\n-            setGcashNumber(j.gcashNumber);\r\n-            Alert.alert(\"Saved\", \"GCash number updated.\");\r\n-        } catch (e: any) {\r\n-            Alert.alert(\"Error\", e.message || \"Save failed\");\r\n-        } finally {\r\n-            setLoading(false);\r\n-        }\r\n-    };\r\n+      Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n+      logState(\"after saveQR success\");\r\n+    } catch (e: any) {\r\n+      log(\"saveQR ERROR:\", e?.message || e);\r\n+      Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n+    } finally {\r\n+      setLoading(false);\r\n+    }\r\n+  };\r\n \r\n-    // decide what to preview: local (unsaved) first, otherwise remote\r\n-    const previewUri = (localQR?.uri || qrUrl || lastGoodQrUrl || \"\").trim();\r\n-    const previewSource = previewUri ? { uri: `${previewUri}?t=${Date.now()}` } : undefined;\r\n+  const saveNumber = async () => {\r\n+    if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n+    try {\r\n+      setLoading(true);\r\n+      log(\"saveNumber: POST /gcash-number start\");\r\n+      const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-number`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ gcashNumber }),\r\n+      });\r\n+      const raw = await r.text();\r\n+      log(\"saveNumber: /gcash-number raw=\", raw);\r\n \r\n-    return (\r\n-        <ScrollView contentContainerStyle={{ padding: 16, gap: 16 }}>\r\n-            <Text style={{ fontSize: 22, fontWeight: \"bold\" }}>GCash Settings</Text>\r\n+      let j: any;\r\n+      try { j = JSON.parse(raw); } catch { j = { ok: false, parseError: true, raw }; }\r\n+      if (!j.ok) throw new Error(j.error || \"Save failed\");\r\n \r\n-            <View style={{ gap: 8 }}>\r\n-                <Text style={{ fontWeight: \"600\" }}>GCash Number (09XXXXXXXXX)</Text>\r\n-                <TextInput\r\n-                    value={gcashNumber}\r\n-                    onChangeText={setGcashNumber}\r\n-                    placeholder=\"09171234567\"\r\n-                    keyboardType=\"phone-pad\"\r\n-                    style={{ borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 12 }}\r\n-                />\r\n-                <TouchableOpacity onPress={saveNumber} style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8 }}>\r\n-                    <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Save Number</Text>\r\n-                </TouchableOpacity>\r\n-            </View>\r\n+      setGcashNumber(j.gcashNumber);\r\n+      Alert.alert(\"Saved\", \"GCash number updated.\");\r\n+    } catch (e: any) {\r\n+      log(\"saveNumber ERROR:\", e?.message || e);\r\n+      Alert.alert(\"Error\", e.message || \"Save failed\");\r\n+    } finally {\r\n+      setLoading(false);\r\n+    }\r\n+  };\r\n \r\n-            <View style={{ gap: 12 }}>\r\n-                <Text style={{ fontWeight: \"600\" }}>GCash QR</Text>\r\n+  // Preview priority: local (unsaved) → qrUrl (server) → lastGood (sticky)\r\n+  const previewUri = (localQR?.uri || qrUrl || lastGoodQrUrl || \"\").trim();\r\n+  const previewSource = previewUri ? { uri: `${previewUri}?v=${imgVersion}` } : undefined;\r\n \r\n-                {previewSource ? (\r\n-                    <Image\r\n-                        source={previewSource}\r\n-                        style={{ width: \"100%\", aspectRatio: 1, borderRadius: 12, minHeight: 250 }}\r\n-                        onError={(e) => console.log(\"QR preview error:\", e.nativeEvent?.error)}\r\n-                    />\r\n-                ) : (\r\n-                    <Text style={{ color: \"#6b7280\" }}>No QR uploaded yet.</Text>\r\n-                )}\r\n+  log(\"RENDER: previewUri=\", previewUri);\r\n+  logState(\"render\");\r\n \r\n-                <View style={{ flexDirection: \"row\", gap: 10 }}>\r\n-                    <TouchableOpacity onPress={chooseQR} style={{ flex: 1, backgroundColor: \"#64748b\", padding: 12, borderRadius: 8 }}>\r\n-                        <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n-                            {localQR ? \"Choose Another\" : \"Choose Image\"}\r\n-                        </Text>\r\n-                    </TouchableOpacity>\r\n+  return (\r\n+    <ScrollView contentContainerStyle={{ padding: 16, gap: 16 }}>\r\n+      <Text style={{ fontSize: 22, fontWeight: \"bold\" }}>GCash Settings</Text>\r\n \r\n-                    <TouchableOpacity\r\n-                        onPress={saveQR}\r\n-                        disabled={!localQR || loading}\r\n-                        style={{ flex: 1, backgroundColor: localQR ? \"#22c55e\" : \"#9ca3af\", padding: 12, borderRadius: 8 }}\r\n-                    >\r\n-                        {loading ? <ActivityIndicator color=\"#fff\" /> : (\r\n-                            <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Save QR</Text>\r\n-                        )}\r\n-                    </TouchableOpacity>\r\n-                </View>\r\n+      <View style={{ gap: 8 }}>\r\n+        <Text style={{ fontWeight: \"600\" }}>GCash Number (09XXXXXXXXX)</Text>\r\n+        <TextInput\r\n+          value={gcashNumber}\r\n+          onChangeText={setGcashNumber}\r\n+          placeholder=\"09171234567\"\r\n+          keyboardType=\"phone-pad\"\r\n+          style={{ borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 12 }}\r\n+        />\r\n+        <TouchableOpacity onPress={saveNumber} style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8 }}>\r\n+          <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Save Number</Text>\r\n+        </TouchableOpacity>\r\n+      </View>\r\n \r\n-                {qrUrl ? (\r\n-                    <TouchableOpacity\r\n-                        onPress={() => { if (qrUrl) Clipboard.setStringAsync(qrUrl); Alert.alert(\"Copied\", \"QR URL copied.\"); }}\r\n-                        style={{ backgroundColor: \"#334155\", padding: 10, borderRadius: 8 }}\r\n-                    >\r\n-                        <Text style={{ color: \"#fff\", textAlign: \"center\" }}>Copy Saved QR URL</Text>\r\n-                    </TouchableOpacity>\r\n-                ) : null}\r\n-            </View>\r\n-            <View style={{ marginTop: 30, borderTopWidth: 1, borderColor: \"#e5e7eb\", paddingTop: 16 }}>\r\n-                <Text style={{ fontSize: 14, color: \"#374151\", marginBottom: 10 }}>\r\n-                    💡 <Text style={{ fontWeight: \"bold\" }}>Reminder:</Text> It’s highly recommended that the GCash QR code and GCash\r\n-                    number belong to the same account. This ensures passengers can send payment directly without errors.\r\n-                </Text>\r\n+      <View style={{ gap: 12 }}>\r\n+        <Text style={{ fontWeight: \"600\" }}>GCash QR</Text>\r\n \r\n-                <TouchableOpacity\r\n-                    onPress={() => navigation.navigate(\"gctutorial\")}\r\n-                    style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8, marginTop: 4 }}\r\n-                >\r\n-                    <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n-                        Help: How to Get My GCash QR Code\r\n-                    </Text>\r\n-                </TouchableOpacity>\r\n-            </View>\r\n-        </ScrollView>\r\n-    );\r\n+        {previewSource ? (\r\n+          <Image\r\n+            source={previewSource}\r\n+            style={{ width: \"100%\", aspectRatio: 1, borderRadius: 12, minHeight: 250 }}\r\n+            onLoadStart={() => log(\"IMG onLoadStart:\", previewSource.uri)}\r\n+            onLoadEnd={() => log(\"IMG onLoadEnd\")}\r\n+            onError={(e) => log(\"IMG onError:\", e.nativeEvent?.error)}\r\n+          />\r\n+        ) : (\r\n+          <Text style={{ color: \"#6b7280\" }}>No QR uploaded yet.</Text>\r\n+        )}\r\n+\r\n+        <View style={{ flexDirection: \"row\", gap: 10 }}>\r\n+          <TouchableOpacity onPress={chooseQR} style={{ flex: 1, backgroundColor: \"#64748b\", padding: 12, borderRadius: 8 }}>\r\n+            <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n+              {localQR ? \"Choose Another\" : \"Choose Image\"}\r\n+            </Text>\r\n+          </TouchableOpacity>\r\n+\r\n+          <TouchableOpacity\r\n+            onPress={saveQR}\r\n+            disabled={!localQR || loading}\r\n+            style={{ flex: 1, backgroundColor: (!localQR || loading) ? \"#9ca3af\" : \"#22c55e\", padding: 12, borderRadius: 8 }}\r\n+          >\r\n+            {loading ? <ActivityIndicator color=\"#fff\" /> : (\r\n+              <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n+                Save QR\r\n+              </Text>\r\n+            )}\r\n+          </TouchableOpacity>\r\n+        </View>\r\n+\r\n+        {qrUrl ? (\r\n+          <TouchableOpacity\r\n+            onPress={() => { if (qrUrl) Clipboard.setStringAsync(qrUrl); Alert.alert(\"Copied\", \"QR URL copied.\"); }}\r\n+            style={{ backgroundColor: \"#334155\", padding: 10, borderRadius: 8 }}\r\n+          >\r\n+            <Text style={{ color: \"#fff\", textAlign: \"center\" }}>Copy Saved QR URL</Text>\r\n+          </TouchableOpacity>\r\n+        ) : null}\r\n+      </View>\r\n+\r\n+      <View style={{ marginTop: 30, borderTopWidth: 1, borderColor: \"#e5e7eb\", paddingTop: 16 }}>\r\n+        <Text style={{ fontSize: 14, color: \"#374151\", marginBottom: 10 }}>\r\n+          💡 <Text style={{ fontWeight: \"bold\" }}>Reminder:</Text> It’s highly recommended that the GCash QR code and GCash\r\n+          number belong to the same account. This ensures passengers can send payment directly without errors.\r\n+        </Text>\r\n+\r\n+        <TouchableOpacity\r\n+          onPress={() => navigation.navigate(\"gctutorial\")}\r\n+          style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8, marginTop: 4 }}\r\n+        >\r\n+          <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n+            Help: How to Get My GCash QR Code\r\n+          </Text>\r\n+        </TouchableOpacity>\r\n+      </View>\r\n+    </ScrollView>\r\n+  );\r\n }\r\n"
                },
                {
                    "date": 1762357395150,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,15 @@\n import React, { useEffect, useState } from \"react\";\r\n-import { View, Text, TextInput, TouchableOpacity, Image, Alert, ActivityIndicator, ScrollView } from \"react-native\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  TextInput,\r\n+  TouchableOpacity,\r\n+  Image,\r\n+  Alert,\r\n+  ActivityIndicator,\r\n+  ScrollView,\r\n+} from \"react-native\";\r\n import * as ImagePicker from \"expo-image-picker\";\r\n import * as Clipboard from \"expo-clipboard\";\r\n import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n import { API_BASE_URL } from \"../../config\";\r\n@@ -10,79 +19,59 @@\n \r\n export default function GCashSettings() {\r\n   const [driverId, setDriverId] = useState<string>(\"\");\r\n   const [gcashNumber, setGcashNumber] = useState(\"\");\r\n-  const [qrUrl, setQrUrl] = useState<string | null>(null);            // latest server URL\r\n-  const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null); // sticky fallback\r\n-  const [localQR, setLocalQR] = useState<LocalAsset | null>(null);    // unsaved preview\r\n+  const [qrUrl, setQrUrl] = useState<string | null>(null);\r\n+  const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n+  const [localQR, setLocalQR] = useState<LocalAsset | null>(null);\r\n   const [loading, setLoading] = useState(false);\r\n   const navigation = useNavigation<any>();\r\n-  const [imgVersion, setImgVersion] = useState(0);                    // cache-buster for <Image>\r\n+  const [imgVersion, setImgVersion] = useState(0);\r\n \r\n-  // ---------- DEBUG HELPERS ----------\r\n-  const log = (...args: any[]) => console.log(\"GCASH: \", ...args);\r\n-\r\n-  const logState = (label: string) => {\r\n-    log(`${label} | driverId=`, driverId);\r\n-    log(`${label} | qrUrl=`, qrUrl);\r\n-    log(`${label} | lastGoodQrUrl=`, lastGoodQrUrl);\r\n-    log(`${label} | localQR.uri=`, localQR?.uri);\r\n-  };\r\n-\r\n-  // Centralized fetcher: NEVER blanks a working preview\r\n-  const fetchPaymentInfo = async (id: string, ctx: string = \"fetchPaymentInfo\") => {\r\n+  // Centralized fetcher\r\n+  const fetchPaymentInfo = async (id: string): Promise<string | null> => {\r\n     try {\r\n-      log(`[${ctx}] GET /payment-info for id=`, id);\r\n       const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`, {\r\n         headers: { Accept: \"application/json\" },\r\n       });\r\n-      const raw = await r.text();\r\n-      log(`[${ctx}] /payment-info raw=`, raw);\r\n-      let j: any;\r\n-      try { j = JSON.parse(raw); } catch { j = { ok: false, parseError: true, raw }; }\r\n-\r\n+      const j = await r.json();\r\n       if (j?.ok && j.gcashQRUrl) {\r\n         const url = String(j.gcashQRUrl || \"\").trim();\r\n         if (url) {\r\n           setQrUrl(url);\r\n           setLastGoodQrUrl(url);\r\n-          setImgVersion(v => v + 1);\r\n-          log(`[${ctx}] set qrUrl+lastGood ->`, url);\r\n+          setImgVersion((v) => v + 1);\r\n           return url;\r\n         }\r\n-      } else {\r\n-        log(`[${ctx}] response missing url or not ok:`, j);\r\n       }\r\n       return null;\r\n     } catch (e: any) {\r\n-      log(`[${ctx}] ERROR /payment-info:`, e?.message || e);\r\n-      return null;\r\n+      console.error(\"fetchPaymentInfo error:\", e.message || e);\r\n+      return null; \r\n     }\r\n   };\r\n \r\n+\r\n   useEffect(() => {\r\n     (async () => {\r\n       try {\r\n         const id = await AsyncStorage.getItem(\"driverId\");\r\n-        log(\"useEffect: got driverId=\", id);\r\n         if (!id) {\r\n           Alert.alert(\"Auth\", \"Driver ID not found. Please log in again.\");\r\n           return;\r\n         }\r\n         setDriverId(id);\r\n-        await fetchPaymentInfo(id, \"mount\");\r\n+        await fetchPaymentInfo(id);\r\n       } catch (e) {\r\n-        log(\"useEffect error:\", e);\r\n+        console.error(\"useEffect error:\", e);\r\n       }\r\n     })();\r\n   }, []);\r\n \r\n-  // Re-fetch whenever the screen gets focus (and driverId is known)\r\n+  // Re-fetch whenever screen refocuses\r\n   useFocusEffect(\r\n     React.useCallback(() => {\r\n-      if (!driverId) return;\r\n-      log(\"focus: refetching payment info\");\r\n-      fetchPaymentInfo(driverId, \"focus\");\r\n+      if (driverId) fetchPaymentInfo(driverId);\r\n     }, [driverId])\r\n   );\r\n \r\n   const chooseQR = async () => {\r\n@@ -100,70 +89,49 @@\n       uri: a.uri,\r\n       name: \"gcashqr.jpg\",\r\n       type: a.mimeType || \"image/jpeg\",\r\n     });\r\n-    log(\"chooseQR: localQR set to\", a.uri);\r\n-    logState(\"after chooseQR\");\r\n   };\r\n \r\n   const saveQR = async () => {\r\n     if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n     if (!localQR) return Alert.alert(\"No image\", \"Choose a QR image first.\");\r\n \r\n     try {\r\n       setLoading(true);\r\n-      logState(\"before saveQR\");\r\n-\r\n       const form = new FormData();\r\n       // @ts-ignore RN file\r\n       form.append(\"qr\", {\r\n         uri: localQR.uri,\r\n         name: localQR.name || \"gcashqr.jpg\",\r\n         type: localQR.type || \"image/jpeg\",\r\n       });\r\n \r\n-      log(\"saveQR: POST /gcash-qr start\");\r\n       const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n         method: \"POST\",\r\n         headers: { Accept: \"application/json\" },\r\n         body: form,\r\n       });\r\n-      const raw = await r.text();\r\n-      log(\"saveQR: /gcash-qr raw=\", raw);\r\n \r\n-      let j: any;\r\n-      try { j = JSON.parse(raw); } catch { j = { ok: false, parseError: true, raw }; }\r\n+      const j = await r.json();\r\n       if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n \r\n-      // Prefer returned URL if present\r\n       let confirmedUrl = (j.gcashQRUrl ? String(j.gcashQRUrl).trim() : \"\") || \"\";\r\n-      log(\"saveQR: returned newUrl=\", confirmedUrl);\r\n-\r\n-      // If backend did NOT return a URL (race or minimal payload), refetch now\r\n       if (!confirmedUrl) {\r\n-        log(\"saveQR: no url in response; refetching /payment-info...\");\r\n-        const fetched = await fetchPaymentInfo(driverId, \"after-save-refetch\");\r\n+        const fetched = await fetchPaymentInfo(driverId);\r\n         confirmedUrl = fetched || \"\";\r\n-        log(\"saveQR: refetched url=\", confirmedUrl);\r\n       }\r\n \r\n       if (confirmedUrl) {\r\n-        // Commit the new URL and bust cache\r\n         setQrUrl(confirmedUrl);\r\n         setLastGoodQrUrl(confirmedUrl);\r\n-        setImgVersion(v => v + 1);\r\n-        log(\"saveQR: committed url=\", confirmedUrl);\r\n-        // Now we’re safe to clear the local preview (disables button)\r\n+        setImgVersion((v) => v + 1);\r\n         setLocalQR(null);\r\n-      } else {\r\n-        // Keep local preview to avoid \"No QR\" flash\r\n-        log(\"saveQR: still no confirmed url; keeping localQR for UI safety\");\r\n       }\r\n \r\n       Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n-      logState(\"after saveQR success\");\r\n     } catch (e: any) {\r\n-      log(\"saveQR ERROR:\", e?.message || e);\r\n+      console.error(\"saveQR error:\", e.message || e);\r\n       Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n     } finally {\r\n       setLoading(false);\r\n     }\r\n@@ -172,42 +140,35 @@\n   const saveNumber = async () => {\r\n     if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n     try {\r\n       setLoading(true);\r\n-      log(\"saveNumber: POST /gcash-number start\");\r\n       const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-number`, {\r\n         method: \"POST\",\r\n         headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify({ gcashNumber }),\r\n       });\r\n-      const raw = await r.text();\r\n-      log(\"saveNumber: /gcash-number raw=\", raw);\r\n-\r\n-      let j: any;\r\n-      try { j = JSON.parse(raw); } catch { j = { ok: false, parseError: true, raw }; }\r\n+      const j = await r.json();\r\n       if (!j.ok) throw new Error(j.error || \"Save failed\");\r\n \r\n       setGcashNumber(j.gcashNumber);\r\n       Alert.alert(\"Saved\", \"GCash number updated.\");\r\n     } catch (e: any) {\r\n-      log(\"saveNumber ERROR:\", e?.message || e);\r\n+      console.error(\"saveNumber error:\", e.message || e);\r\n       Alert.alert(\"Error\", e.message || \"Save failed\");\r\n     } finally {\r\n       setLoading(false);\r\n     }\r\n   };\r\n \r\n-  // Preview priority: local (unsaved) → qrUrl (server) → lastGood (sticky)\r\n+  // Preview priority\r\n   const previewUri = (localQR?.uri || qrUrl || lastGoodQrUrl || \"\").trim();\r\n   const previewSource = previewUri ? { uri: `${previewUri}?v=${imgVersion}` } : undefined;\r\n \r\n-  log(\"RENDER: previewUri=\", previewUri);\r\n-  logState(\"render\");\r\n-\r\n   return (\r\n     <ScrollView contentContainerStyle={{ padding: 16, gap: 16 }}>\r\n       <Text style={{ fontSize: 22, fontWeight: \"bold\" }}>GCash Settings</Text>\r\n \r\n+      {/* GCash Number Section */}\r\n       <View style={{ gap: 8 }}>\r\n         <Text style={{ fontWeight: \"600\" }}>GCash Number (09XXXXXXXXX)</Text>\r\n         <TextInput\r\n           value={gcashNumber}\r\n@@ -215,41 +176,54 @@\n           placeholder=\"09171234567\"\r\n           keyboardType=\"phone-pad\"\r\n           style={{ borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 12 }}\r\n         />\r\n-        <TouchableOpacity onPress={saveNumber} style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8 }}>\r\n-          <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Save Number</Text>\r\n+        <TouchableOpacity\r\n+          onPress={saveNumber}\r\n+          style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8 }}\r\n+        >\r\n+          <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n+            Save Number\r\n+          </Text>\r\n         </TouchableOpacity>\r\n       </View>\r\n \r\n+      {/* GCash QR Section */}\r\n       <View style={{ gap: 12 }}>\r\n         <Text style={{ fontWeight: \"600\" }}>GCash QR</Text>\r\n \r\n         {previewSource ? (\r\n           <Image\r\n             source={previewSource}\r\n             style={{ width: \"100%\", aspectRatio: 1, borderRadius: 12, minHeight: 250 }}\r\n-            onLoadStart={() => log(\"IMG onLoadStart:\", previewSource.uri)}\r\n-            onLoadEnd={() => log(\"IMG onLoadEnd\")}\r\n-            onError={(e) => log(\"IMG onError:\", e.nativeEvent?.error)}\r\n           />\r\n         ) : (\r\n           <Text style={{ color: \"#6b7280\" }}>No QR uploaded yet.</Text>\r\n         )}\r\n \r\n         <View style={{ flexDirection: \"row\", gap: 10 }}>\r\n-          <TouchableOpacity onPress={chooseQR} style={{ flex: 1, backgroundColor: \"#64748b\", padding: 12, borderRadius: 8 }}>\r\n+          <TouchableOpacity\r\n+            onPress={chooseQR}\r\n+            style={{ flex: 1, backgroundColor: \"#64748b\", padding: 12, borderRadius: 8 }}\r\n+          >\r\n             <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n               {localQR ? \"Choose Another\" : \"Choose Image\"}\r\n             </Text>\r\n           </TouchableOpacity>\r\n \r\n           <TouchableOpacity\r\n             onPress={saveQR}\r\n             disabled={!localQR || loading}\r\n-            style={{ flex: 1, backgroundColor: (!localQR || loading) ? \"#9ca3af\" : \"#22c55e\", padding: 12, borderRadius: 8 }}\r\n+            style={{\r\n+              flex: 1,\r\n+              backgroundColor: !localQR || loading ? \"#9ca3af\" : \"#22c55e\",\r\n+              padding: 12,\r\n+              borderRadius: 8,\r\n+            }}\r\n           >\r\n-            {loading ? <ActivityIndicator color=\"#fff\" /> : (\r\n+            {loading ? (\r\n+              <ActivityIndicator color=\"#fff\" />\r\n+            ) : (\r\n               <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n                 Save QR\r\n               </Text>\r\n             )}\r\n@@ -257,25 +231,42 @@\n         </View>\r\n \r\n         {qrUrl ? (\r\n           <TouchableOpacity\r\n-            onPress={() => { if (qrUrl) Clipboard.setStringAsync(qrUrl); Alert.alert(\"Copied\", \"QR URL copied.\"); }}\r\n+            onPress={() => {\r\n+              if (qrUrl) Clipboard.setStringAsync(qrUrl);\r\n+              Alert.alert(\"Copied\", \"QR URL copied.\");\r\n+            }}\r\n             style={{ backgroundColor: \"#334155\", padding: 10, borderRadius: 8 }}\r\n           >\r\n             <Text style={{ color: \"#fff\", textAlign: \"center\" }}>Copy Saved QR URL</Text>\r\n           </TouchableOpacity>\r\n         ) : null}\r\n       </View>\r\n \r\n-      <View style={{ marginTop: 30, borderTopWidth: 1, borderColor: \"#e5e7eb\", paddingTop: 16 }}>\r\n+      {/* Footer Info */}\r\n+      <View\r\n+        style={{\r\n+          marginTop: 30,\r\n+          borderTopWidth: 1,\r\n+          borderColor: \"#e5e7eb\",\r\n+          paddingTop: 16,\r\n+        }}\r\n+      >\r\n         <Text style={{ fontSize: 14, color: \"#374151\", marginBottom: 10 }}>\r\n-          💡 <Text style={{ fontWeight: \"bold\" }}>Reminder:</Text> It’s highly recommended that the GCash QR code and GCash\r\n-          number belong to the same account. This ensures passengers can send payment directly without errors.\r\n+          💡 <Text style={{ fontWeight: \"bold\" }}>Reminder:</Text> It’s highly recommended\r\n+          that the GCash QR code and GCash number belong to the same account. This ensures\r\n+          passengers can send payment directly without errors.\r\n         </Text>\r\n \r\n         <TouchableOpacity\r\n           onPress={() => navigation.navigate(\"gctutorial\")}\r\n-          style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8, marginTop: 4 }}\r\n+          style={{\r\n+            backgroundColor: \"#0ea5e9\",\r\n+            padding: 12,\r\n+            borderRadius: 8,\r\n+            marginTop: 4,\r\n+          }}\r\n         >\r\n           <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n             Help: How to Get My GCash QR Code\r\n           </Text>\r\n"
                }
            ],
            "date": 1762346944488,
            "name": "Commit-0",
            "content": "import React, { useEffect, useState } from \"react\";\r\nimport { View, Text, TextInput, TouchableOpacity, Image, Alert, ActivityIndicator, ScrollView } from \"react-native\";\r\nimport * as ImagePicker from \"expo-image-picker\";\r\nimport * as Clipboard from \"expo-clipboard\";\r\nimport AsyncStorage from \"@react-native-async-storage/async-storage\";\r\nimport { API_BASE_URL } from \"../../config\";\r\n\r\ntype LocalAsset = { uri: string; name?: string; type?: string };\r\n\r\nexport default function GCashSettings() {\r\n    const [driverId, setDriverId] = useState<string>(\"\");\r\n    const [gcashNumber, setGcashNumber] = useState(\"\");\r\n    const [qrUrl, setQrUrl] = useState<string | null>(null);\r\n    const [lastGoodQrUrl, setLastGoodQrUrl] = useState<string | null>(null);\r\n    const [localQR, setLocalQR] = useState<{ uri: string; name?: string; type?: string } | null>(null);\r\n    const [loading, setLoading] = useState(false);\r\n    const [helpOpen, setHelpOpen] = useState(false);\r\n\r\n\r\n    useEffect(() => {\r\n        (async () => {\r\n            try {\r\n                const id = await AsyncStorage.getItem(\"driverId\");\r\n                if (!id) {\r\n                Alert.alert(\"Auth\", \"Driver ID not found. Please log in again.\");\r\n                return;\r\n                }\r\n                setDriverId(id);\r\n\r\n                const r = await fetch(`${API_BASE_URL}/api/auth/driver/${id}/payment-info`);\r\n                const j = await r.json();\r\n                if (j?.ok && j.gcashQRUrl) {\r\n                    const url = (j.gcashQRUrl || \"\").trim();\r\n                    setQrUrl(url);\r\n                    setLastGoodQrUrl(url);               \r\n                } else {\r\n                    console.log(\"payment-info not ok:\", j);\r\n                }\r\n            } catch (e) {\r\n                console.log(\"load driver id/payment-info failed:\", e);\r\n            }\r\n        })();\r\n    }, []);\r\n\r\n    const chooseQR = async () => {\r\n        const perm = await ImagePicker.requestMediaLibraryPermissionsAsync();\r\n            if (!perm.granted) return Alert.alert(\"Permission needed\", \"Allow Photos to select a QR.\");\r\n            const result = await ImagePicker.launchImageLibraryAsync({\r\n            mediaTypes: ImagePicker.MediaTypeOptions.Images,\r\n            quality: 0.9,\r\n        });\r\n        if (result.canceled || !result.assets?.length) return;\r\n\r\n        const a = result.assets[0];\r\n            setLocalQR({\r\n            uri: a.uri,\r\n            name: \"gcashqr.jpg\",\r\n            type: a.mimeType || \"image/jpeg\",\r\n        });\r\n    };\r\n\r\n    const saveQR = async () => {\r\n        if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n        if (!localQR) return Alert.alert(\"No image\", \"Choose a QR image first.\");\r\n\r\n        try {\r\n            setLoading(true);\r\n            const form = new FormData();\r\n            // @ts-ignore\r\n            form.append(\"qr\", { uri: localQR.uri, name: localQR.name || \"gcashqr.jpg\", type: localQR.type || \"image/jpeg\" });\r\n\r\n            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-qr`, {\r\n                method: \"POST\",\r\n                headers: { Accept: \"application/json\" },\r\n                body: form,\r\n            });\r\n            const j = await r.json();\r\n            if (!j.ok) throw new Error(j.error || \"Upload failed\");\r\n\r\n            const newUrl = (j.gcashQRUrl || \"\").trim();\r\n            if (newUrl) {\r\n                setQrUrl(newUrl);\r\n                setLastGoodQrUrl(newUrl);     \r\n                setLocalQR(null);             \r\n                Alert.alert(\"Saved\", \"GCash QR updated.\");\r\n            } else {\r\n            }\r\n        } catch (e: any) {\r\n            Alert.alert(\"Error\", e.message || \"Upload failed\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const saveNumber = async () => {\r\n        if (!driverId) return Alert.alert(\"Missing ID\", \"Driver ID is not loaded yet.\");\r\n        try {\r\n            setLoading(true);\r\n            const r = await fetch(`${API_BASE_URL}/api/auth/driver/${driverId}/gcash-number`, {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/json\" },\r\n                body: JSON.stringify({ gcashNumber }),\r\n            });\r\n            const j = await r.json();\r\n            if (!j.ok) throw new Error(j.error || \"Save failed\");\r\n            setGcashNumber(j.gcashNumber);\r\n            Alert.alert(\"Saved\", \"GCash number updated.\");\r\n        } catch (e: any) {\r\n            Alert.alert(\"Error\", e.message || \"Save failed\");\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // decide what to preview: local (unsaved) first, otherwise remote\r\n    const previewUri = (localQR?.uri || qrUrl || lastGoodQrUrl || \"\").trim();\r\n    const previewSource = previewUri ? { uri: `${previewUri}?t=${Date.now()}` } : undefined;\r\n\r\n    return (\r\n        <ScrollView contentContainerStyle={{ padding: 16, gap: 16 }}>\r\n            <Text style={{ fontSize: 22, fontWeight: \"bold\" }}>GCash Settings</Text>\r\n\r\n            <View style={{ gap: 8 }}>\r\n                <Text style={{ fontWeight: \"600\" }}>GCash Number (09XXXXXXXXX)</Text>\r\n                <TextInput\r\n                    value={gcashNumber}\r\n                    onChangeText={setGcashNumber}\r\n                    placeholder=\"09171234567\"\r\n                    keyboardType=\"phone-pad\"\r\n                    style={{ borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 12 }}\r\n                />\r\n                <TouchableOpacity onPress={saveNumber} style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8 }}>\r\n                    <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Save Number</Text>\r\n                </TouchableOpacity>\r\n            </View>\r\n\r\n            <View style={{ gap: 12 }}>\r\n                <Text style={{ fontWeight: \"600\" }}>GCash QR</Text>\r\n\r\n                {previewSource ? (\r\n                    <Image\r\n                        source={previewSource}\r\n                        style={{ width: \"100%\", aspectRatio: 1, borderRadius: 12, minHeight: 250 }}\r\n                        onError={(e) => console.log(\"QR preview error:\", e.nativeEvent?.error)}\r\n                    />\r\n                ) : (\r\n                    <Text style={{ color: \"#6b7280\" }}>No QR uploaded yet.</Text>\r\n                )}\r\n\r\n                <View style={{ flexDirection: \"row\", gap: 10 }}>\r\n                    <TouchableOpacity onPress={chooseQR} style={{ flex: 1, backgroundColor: \"#64748b\", padding: 12, borderRadius: 8 }}>\r\n                        <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n                            {localQR ? \"Choose Another\" : \"Choose Image\"}\r\n                        </Text>\r\n                    </TouchableOpacity>\r\n\r\n                    <TouchableOpacity\r\n                        onPress={saveQR}\r\n                        disabled={!localQR || loading}\r\n                        style={{ flex: 1, backgroundColor: localQR ? \"#22c55e\" : \"#9ca3af\", padding: 12, borderRadius: 8 }}\r\n                    >\r\n                        {loading ? <ActivityIndicator color=\"#fff\" /> : (\r\n                            <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Save QR</Text>\r\n                        )}\r\n                    </TouchableOpacity>\r\n                </View>\r\n\r\n                {qrUrl ? (\r\n                    <TouchableOpacity\r\n                        onPress={() => { if (qrUrl) Clipboard.setStringAsync(qrUrl); Alert.alert(\"Copied\", \"QR URL copied.\"); }}\r\n                        style={{ backgroundColor: \"#334155\", padding: 10, borderRadius: 8 }}\r\n                    >\r\n                        <Text style={{ color: \"#fff\", textAlign: \"center\" }}>Copy Saved QR URL</Text>\r\n                    </TouchableOpacity>\r\n                ) : null}\r\n            </View>\r\n            <View style={{ marginTop: 30, borderTopWidth: 1, borderColor: \"#e5e7eb\", paddingTop: 16 }}>\r\n                <Text style={{ fontSize: 14, color: \"#374151\", marginBottom: 10 }}>\r\n                    💡 <Text style={{ fontWeight: \"bold\" }}>Reminder:</Text> It’s highly recommended that the GCash QR code and GCash\r\n                    number belong to the same account. This ensures passengers can send payment directly without errors.\r\n                </Text>\r\n\r\n                <TouchableOpacity\r\n                    onPress={() => setHelpOpen(true)}\r\n                    style={{ backgroundColor: \"#0ea5e9\", padding: 12, borderRadius: 8, marginTop: 4 }}\r\n                >\r\n                    <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>\r\n                        Help: How to Get My GCash QR Code\r\n                    </Text>\r\n                </TouchableOpacity>\r\n\r\n                    {helpOpen && (\r\n                        <View\r\n                            style={{\r\n                                position: \"absolute\",\r\n                                top: 0,\r\n                                left: 0,\r\n                                right: 0,\r\n                                bottom: 0,\r\n                                backgroundColor: \"rgba(0,0,0,0.5)\",\r\n                                justifyContent: \"center\",\r\n                                alignItems: \"center\",\r\n                                padding: 20,\r\n                            }}\r\n                        >\r\n                            <View\r\n                                style={{\r\n                                    backgroundColor: \"#fff\",\r\n                                    borderRadius: 12,\r\n                                    padding: 16,\r\n                                    width: \"100%\",\r\n                                    maxWidth: 400,\r\n                                }}\r\n                            >\r\n                                <Text style={{ fontWeight: \"bold\", fontSize: 18, marginBottom: 8 }}>\r\n                                    How to Get Your Personal GCash QR\r\n                                </Text>\r\n                                {/* <Image\r\n                                    source={require(\"../../assets/images/gcash_tutorial_placeholder.png\")} \r\n                                    style={{ width: \"100%\", height: 250, borderRadius: 8, marginBottom: 10 }}\r\n                                    resizeMode=\"contain\"\r\n                                /> */}\r\n\r\n                                <Text style={{ fontSize: 14, color: \"#374151\", marginBottom: 12 }}>\r\n                                    Replace this image and text with your actual tutorial steps or screenshots.\r\n                                </Text>\r\n\r\n                                <TouchableOpacity\r\n                                    onPress={() => setHelpOpen(false)}\r\n                                    style={{\r\n                                    backgroundColor: \"#0ea5e9\",\r\n                                    padding: 10,\r\n                                    borderRadius: 8,\r\n                                    alignSelf: \"center\",\r\n                                    minWidth: 120,\r\n                                    }}\r\n                                >\r\n                                    <Text style={{ color: \"#fff\", textAlign: \"center\", fontWeight: \"600\" }}>Close</Text>\r\n                                </TouchableOpacity>\r\n                            </View>\r\n                        </View>\r\n                    )}\r\n\r\n            </View>\r\n\r\n        </ScrollView>\r\n    );\r\n}\r\n"
        }
    ]
}