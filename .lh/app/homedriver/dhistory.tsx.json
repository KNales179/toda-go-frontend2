{
    "sourceFile": "app/homedriver/dhistory.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1748350673087,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1748350701251,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,10 +9,10 @@\n     <View style={styles.container}>\r\n         <Text>Passenger History Page</Text>\r\n         <View style={styles.bottomNav}>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n         </View>\r\n     </View>\r\n   );\r\n"
                },
                {
                    "date": 1748355312885,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,14 +1,16 @@\n import React from 'react';\r\n-import { View, Text, StyleSheet, TouchableOpacity, Dimensions } from 'react-native';\r\n+import { View, Text, StyleSheet, TouchableOpacity, Dimensions, Image } from 'react-native';\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { router } from 'expo-router'; \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHistory() {\r\n   return (\r\n     <View style={styles.container}>\r\n-        <Text>Passenger History Page</Text>\r\n+        <Text style={styles.heading}>History</Text>\r\n+                <Image source={require('../../assets/images/tricycle.png')} style={styles.chatImage} />\r\n+                <Text style={styles.message}>Mag Book na para mag ka history ka.</Text>\r\n         <View style={styles.bottomNav}>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n@@ -18,7 +20,10 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, justifyContent: 'center', alignItems: 'center' },\r\n+  container: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n+  heading: { fontWeight: 'bold', fontSize: 18, marginBottom: 20 },\r\n+  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n+  message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n"
                },
                {
                    "date": 1748355444694,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,10 +7,10 @@\n export default function PHistory() {\r\n   return (\r\n     <View style={styles.container}>\r\n         <Text style={styles.heading}>History</Text>\r\n-                <Image source={require('../../assets/images/tricycle.png')} style={styles.chatImage} />\r\n-                <Text style={styles.message}>Mag Book na para mag ka history ka.</Text>\r\n+        <Image source={require('../../assets/images/tricycle.png')} style={styles.chatImage} />\r\n+        <Text style={styles.message}>Mag Book na para mag ka history ka.</Text>\r\n         <View style={styles.bottomNav}>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n"
                },
                {
                    "date": 1748456566917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,36 @@\n+import React from 'react';\r\n+import { View, Text, StyleSheet, TouchableOpacity, Dimensions, Image } from 'react-native';\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { router } from 'expo-router'; \r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+export default function PHistory() {\r\n+  return (\r\n+    <View style={styles.container}>\r\n+      <View style={styles.topBar}>\r\n+        <Text style={styles.heading}>HISTORY</Text>\r\n+      </View>\r\n+\r\n+      <View style={styles.container2}>\r\n+        <Image source={require('../../assets/images/tricycle.png')} style={styles.chatImage} />\r\n+        <Text style={styles.message}>Mag Book na para mag ka history ka.</Text>\r\n+      </View>\r\n+        <View style={styles.bottomNav}>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homedriver/dprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n+        </View>\r\n+    </View>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { flex: 1, paddingHorizontal: 20 },\r\n+  topBar: { marginTop: 40, marginBottom: 20 }, // Adjust top margin as needed\r\n+  heading: { fontWeight: 'bold', fontSize: 22 },\r\n+  container2: { flex: 1, justifyContent: 'center', alignItems: 'center' },\r\n+  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n+  message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n+  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+});\r\n"
                },
                {
                    "date": 1761427208923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,65 +1,537 @@\n-import React from 'react';\r\n-import { View, Text, StyleSheet, TouchableOpacity, Dimensions, Image } from 'react-native';\r\n+// DHistory.tsx\r\n+import React, { useCallback, useEffect, useState } from \"react\";\r\n+import {\r\n+  View, Text, StyleSheet, Dimensions, Image, FlatList,\r\n+  RefreshControl, TouchableOpacity, Alert, Modal, TextInput,\r\n+  LayoutAnimation, Platform, UIManager,\r\n+} from \"react-native\";\r\n+import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { router } from 'expo-router'; \r\n-const { width, height } = Dimensions.get(\"window\");\r\n+import * as Location from \"expo-location\";\r\n+import { API_BASE_URL } from \"../../config\";\r\n \r\n-export default function PHistory() {\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+if (Platform.OS === \"android\" && UIManager.setLayoutAnimationEnabledExperimental) {\r\n+  UIManager.setLayoutAnimationEnabledExperimental(true);\r\n+}\r\n+\r\n+type RideItem = {\r\n+  _id: string;\r\n+  bookingId?: string;\r\n+  passengerId?: string;\r\n+  driverName?: string;\r\n+\r\n+  pickupLat?: number | undefined;\r\n+  pickupLng?: number | undefined;\r\n+  destinationLat?: number | undefined;\r\n+  destinationLng?: number | undefined;\r\n+\r\n+  pickupPlace?: string | null;\r\n+  destinationPlace?: string | null;\r\n+\r\n+  pickupLabel?: string | undefined | null;\r\n+  destinationLabel?: string | undefined | null;\r\n+\r\n+  fare: number;\r\n+  totalFare?: number;\r\n+  bookingType?: string;\r\n+  groupCount?: number;\r\n+\r\n+  createdAt: string;\r\n+  paymentMethod?: string;\r\n+  notes?: string;\r\n+};\r\n+\r\n+export default function DHistory() {\r\n+  const [driverId, setDriverId] = useState<string | null>(null);\r\n+  const [allItems, setAllItems] = useState<RideItem[]>([]);\r\n+  const [loading, setLoading] = useState(true);\r\n+  const [refreshing, setRefreshing] = useState(false);\r\n+  const [visible, setVisible] = useState(10);\r\n+  const [expandedId, setExpandedId] = useState<string | null>(null);\r\n+\r\n+  // report modal stubs (if you want same functionality as PHistory)\r\n+  const [reportOpen, setReportOpen] = useState<{ id: string | null; bookingId?: string }>({ id: null });\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [sendingReport, setSendingReport] = useState(false);\r\n+\r\n+  const reverseCache = React.useRef<Map<string, string>>(new Map());\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const id = (await AsyncStorage.getItem(\"driverId\")) || (await AsyncStorage.getItem(\"userId\"));\r\n+      setDriverId(id || null);\r\n+      console.log(\"[DHistory] loaded driverId:\", id);\r\n+    })();\r\n+  }, []);\r\n+\r\n+  const php = (n: number) =>\r\n+    new Intl.NumberFormat(\"en-PH\", { style: \"currency\", currency: \"PHP\" }).format(n);\r\n+\r\n+  const when = (iso: string) =>\r\n+    new Date(iso).toLocaleString(\"en-PH\", {\r\n+      year: \"numeric\", month: \"long\", day: \"numeric\", hour: \"numeric\", minute: \"2-digit\",\r\n+    });\r\n+\r\n+  const parseCoordsFromLabel = (s?: string | null) => {\r\n+    if (!s || typeof s !== \"string\") return null;\r\n+    const m = s.trim().match(/^(-?\\d+(?:\\.\\d+)?)[,\\s]+(-?\\d+(?:\\.\\d+)?)$/);\r\n+    if (!m) return null;\r\n+    const lat = Number(m[1]);\r\n+    const lng = Number(m[2]);\r\n+    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;\r\n+    return { lat, lng };\r\n+  };\r\n+\r\n+  const coordKey = (lat?: number, lng?: number) =>\r\n+    lat == null || lng == null ? null : `${lat.toFixed(6)},${lng.toFixed(6)}`;\r\n+\r\n+  const geocodeCoord = async (lat?: number, lng?: number) => {\r\n+    const key = coordKey(lat, lng);\r\n+    if (!key) return null;\r\n+\r\n+    const cached = reverseCache.current.get(key);\r\n+    if (cached) {\r\n+      console.log(\"[DHistory][geocodeCoord] cache HIT:\", key, \"->\", cached);\r\n+      return cached;\r\n+    }\r\n+\r\n+    console.log(\"[DHistory][geocodeCoord] cache MISS, calling reverseGeocodeAsync for:\", key);\r\n+    try {\r\n+      const res = await Location.reverseGeocodeAsync({ latitude: lat!, longitude: lng! });\r\n+      if (Array.isArray(res) && res.length > 0) {\r\n+        const a = res[0];\r\n+        const pieces = [\r\n+          a.name || undefined,\r\n+          a.street || undefined,\r\n+          a.subregion || a.city || a.region || undefined,\r\n+        ].filter(Boolean);\r\n+        const label = pieces.join(\", \") || `${lat!.toFixed(5)}, ${lng!.toFixed(5)}`;\r\n+        reverseCache.current.set(key, label);\r\n+        console.log(\"[DHistory][geocodeCoord] success:\", key, \"->\", label);\r\n+        return label;\r\n+      } else {\r\n+        console.warn(\"[DHistory][geocodeCoord] reverseGeocodeAsync returned empty for:\", key);\r\n+      }\r\n+    } catch (e) {\r\n+      console.warn(\"[DHistory][geocodeCoord] reverse geocode failed for\", key, e);\r\n+    }\r\n+\r\n+    const coordLabel = `${lat!.toFixed(5)}, ${lng!.toFixed(5)}`;\r\n+    reverseCache.current.set(key, coordLabel);\r\n+    console.log(\"[DHistory][geocodeCoord] fallback to coord label:\", key, \"->\", coordLabel);\r\n+    return coordLabel;\r\n+  };\r\n+\r\n+  const normalize = (raw: any[]): RideItem[] =>\r\n+    (raw || []).map((r: any) => {\r\n+      const rawPickupLabel = r.pickupPlace || r.pickupLabel || r.pickupName || r.pickupAddress || null;\r\n+      const rawDestLabel = r.destinationPlace || r.destinationLabel || r.destinationName || r.destinationAddress || null;\r\n+\r\n+      const parsedPickup = parseCoordsFromLabel(typeof rawPickupLabel === \"string\" ? rawPickupLabel : null);\r\n+      const parsedDest = parseCoordsFromLabel(typeof rawDestLabel === \"string\" ? rawDestLabel : null);\r\n+\r\n+      const pickupLat = Number.isFinite(r.pickupLat) ? Number(r.pickupLat) : (parsedPickup ? parsedPickup.lat : undefined);\r\n+      const pickupLng = Number.isFinite(r.pickupLng) ? Number(r.pickupLng) : (parsedPickup ? parsedPickup.lng : undefined);\r\n+      const destinationLat = Number.isFinite(r.destinationLat) ? Number(r.destinationLat) : (parsedDest ? parsedDest.lat : undefined);\r\n+      const destinationLng = Number.isFinite(r.destinationLng) ? Number(r.destinationLng) : (parsedDest ? parsedDest.lng : undefined);\r\n+\r\n+      const pickupLabel = parsedPickup ? undefined : (rawPickupLabel ?? undefined);\r\n+      const destinationLabel = parsedDest ? undefined : (rawDestLabel ?? undefined);\r\n+\r\n+      return {\r\n+        _id: String(r._id),\r\n+        bookingId: r.bookingId,\r\n+        passengerId: r.passengerId,\r\n+        driverName: r.driverName,\r\n+        pickupLat,\r\n+        pickupLng,\r\n+        destinationLat,\r\n+        destinationLng,\r\n+        pickupPlace: r.pickupPlace ?? null,\r\n+        destinationPlace: r.destinationPlace ?? null,\r\n+        pickupLabel,\r\n+        destinationLabel,\r\n+        fare: Number(r.fare || 0),\r\n+        totalFare: r.totalFare != null ? Number(r.totalFare) : undefined,\r\n+        bookingType: r.bookingType,\r\n+        groupCount: r.groupCount != null ? Number(r.groupCount) : undefined,\r\n+        createdAt: r.createdAt || r.completedAt || new Date().toISOString(),\r\n+        paymentMethod: r.paymentMethod || \"\",\r\n+        notes: r.notes || \"\",\r\n+      } as RideItem;\r\n+    });\r\n+\r\n+  const resolvePlaceNames = async (items: RideItem[]) => {\r\n+    console.log(\"[DHistory][resolvePlaceNames] start, items:\", items.length);\r\n+    const tasks: Array<() => Promise<{ id: string; pickupLabel?: string; destinationLabel?: string }>> = [];\r\n+\r\n+    for (const it of items) {\r\n+      const needsPickup = (!it.pickupLabel || it.pickupLabel === \"\") && (it.pickupLat != null && it.pickupLng != null);\r\n+      const needsDest = (!it.destinationLabel || it.destinationLabel === \"\") && (it.destinationLat != null && it.destinationLng != null);\r\n+      if (!needsPickup && !needsDest) continue;\r\n+\r\n+      tasks.push(async () => {\r\n+        const out: any = { id: it._id };\r\n+        if (needsPickup) {\r\n+          try {\r\n+            const lbl = await geocodeCoord(it.pickupLat, it.pickupLng);\r\n+            out.pickupLabel = lbl || (it.pickupPlace || \"Pickup location\");\r\n+          } catch (e) {\r\n+            out.pickupLabel = it.pickupPlace || \"Pickup location\";\r\n+          }\r\n+        }\r\n+        if (needsDest) {\r\n+          try {\r\n+            const lbl = await geocodeCoord(it.destinationLat, it.destinationLng);\r\n+            out.destinationLabel = lbl || (it.destinationPlace || \"Destination\");\r\n+          } catch (e) {\r\n+            out.destinationLabel = it.destinationPlace || \"Destination\";\r\n+          }\r\n+        }\r\n+        return out;\r\n+      });\r\n+    }\r\n+\r\n+    console.log(\"[DHistory][resolvePlaceNames] tasks queued:\", tasks.length);\r\n+    if (tasks.length === 0) return;\r\n+\r\n+    const CONCURRENCY = 5;\r\n+    const results: any[] = [];\r\n+    let idx = 0;\r\n+\r\n+    const runner = async () => {\r\n+      while (idx < tasks.length) {\r\n+        const i = idx++;\r\n+        try {\r\n+          const r = await tasks[i]();\r\n+          results.push(r);\r\n+          console.log(\"[DHistory][resolvePlaceNames] task done for id:\", r.id);\r\n+        } catch (e) {\r\n+          console.warn(\"[DHistory][resolvePlaceNames] task error\", e);\r\n+        }\r\n+      }\r\n+    };\r\n+\r\n+    const workers = [];\r\n+    for (let i = 0; i < CONCURRENCY; i++) workers.push(runner());\r\n+    await Promise.all(workers);\r\n+\r\n+    if (results.length === 0) return;\r\n+\r\n+    setAllItems((prev) => {\r\n+      const byId = new Map(prev.map((p) => [p._id, { ...p }]));\r\n+      for (const r of results) {\r\n+        const entry = byId.get(r.id);\r\n+        if (!entry) continue;\r\n+        if (r.pickupLabel) entry.pickupLabel = r.pickupLabel;\r\n+        if (r.destinationLabel) entry.destinationLabel = r.destinationLabel;\r\n+      }\r\n+      return Array.from(byId.values()).map((e) => ({\r\n+        ...e,\r\n+        pickupLabel: e.pickupLabel ?? e.pickupPlace ?? \"Pickup location\",\r\n+        destinationLabel: e.destinationLabel ?? e.destinationPlace ?? \"Destination\",\r\n+      }));\r\n+    });\r\n+\r\n+    console.log(\"[DHistory][resolvePlaceNames] done and state updated\");\r\n+  };\r\n+\r\n+  const fetchAll = useCallback(async () => {\r\n+    if (!driverId) { setLoading(false); setRefreshing(false); console.log(\"[DHistory][fetchAll] no driverId, abort\"); return; }\r\n+    try {\r\n+      setLoading(true);\r\n+      const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n+      const paths = [\r\n+        `/ridehistory?driverId=${encodeURIComponent(driverId)}`,\r\n+        `/api/ridehistory?driverId=${encodeURIComponent(driverId)}`,\r\n+        `/rides`,\r\n+        `/api/rides`,\r\n+      ];\r\n+      let got: RideItem[] | null = null;\r\n+\r\n+      console.log(\"[DHistory][fetchAll] trying endpoints:\", paths);\r\n+      for (let i = 0; i < paths.length; i++) {\r\n+        const url = `${base}${paths[i]}`;\r\n+        const filterLocally = i >= 2;\r\n+        try {\r\n+          console.log(\"[DHistory][fetchAll] fetching:\", url);\r\n+          const res = await fetch(url, { headers: { \"Cache-Control\": \"no-store\" } });\r\n+          const text = await res.text();\r\n+          let data: any;\r\n+          try { data = JSON.parse(text); } catch {\r\n+            console.warn(\"[DHistory][fetchAll] response not JSON from\", url);\r\n+            continue;\r\n+          }\r\n+          let raw: any[] = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);\r\n+          if (filterLocally) raw = raw.filter((x: any) => String(x.driverId) === String(driverId));\r\n+          got = normalize(raw);\r\n+          console.log(\"[DHistory][fetchAll] success from:\", url, \"items:\", got.length);\r\n+          break;\r\n+        } catch (e) {\r\n+          console.warn(\"[DHistory][fetchAll] fetch failed for\", paths[i], e);\r\n+        }\r\n+      }\r\n+\r\n+      if (!got) got = [];\r\n+      setAllItems(got);\r\n+      setVisible(Math.min(10, got.length));\r\n+\r\n+      // Force geocoding for any item that has coords (either fields or parsed from label)\r\n+      const itemsWithCoords = got.filter(it =>\r\n+        (it.pickupLat != null && it.pickupLng != null) ||\r\n+        (it.destinationLat != null && it.destinationLng != null)\r\n+      );\r\n+      console.log(\"[DHistory][fetchAll] items with coords:\", itemsWithCoords.length);\r\n+\r\n+      if (itemsWithCoords.length > 0) {\r\n+        resolvePlaceNames(itemsWithCoords).catch((e) => console.warn(\"[DHistory][fetchAll] resolvePlaceNames failed\", e));\r\n+      } else {\r\n+        setAllItems((prev) => prev.map(p => ({\r\n+          ...p,\r\n+          pickupLabel: p.pickupLabel ?? p.pickupPlace ?? \"Pickup location\",\r\n+          destinationLabel: p.destinationLabel ?? p.destinationPlace ?? \"Destination\",\r\n+        })));\r\n+      }\r\n+    } finally {\r\n+      setLoading(false);\r\n+      setRefreshing(false);\r\n+      console.log(\"[DHistory][fetchAll] finished\");\r\n+    }\r\n+  }, [driverId]);\r\n+\r\n+  useEffect(() => { fetchAll(); }, [fetchAll]);\r\n+\r\n+  const onRefresh = useCallback(() => {\r\n+    setRefreshing(true);\r\n+    fetchAll();\r\n+  }, [fetchAll]);\r\n+\r\n+  const toggleExpand = (id: string) => {\r\n+    LayoutAnimation.configureNext(LayoutAnimation.Presets.easeInEaseOut);\r\n+    setExpandedId((cur) => (cur === id ? null : id));\r\n+  };\r\n+\r\n+  const askDelete = (id: string) => {\r\n+    Alert.alert(\"Delete ride\", \"Are you sure you want to delete this history item?\", [\r\n+      { text: \"Cancel\", style: \"cancel\" },\r\n+      {\r\n+        text: \"Delete\",\r\n+        style: \"destructive\",\r\n+        onPress: async () => {\r\n+          const prev = allItems;\r\n+          setAllItems((list) => list.filter((x) => x._id !== id));\r\n+          try {\r\n+            const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n+            const candidates = [`${base}/ridehistory/${id}`, `${base}/api/ridehistory/${id}`];\r\n+            let success = false;\r\n+            for (const url of candidates) {\r\n+              try {\r\n+                const res = await fetch(url, { method: \"DELETE\" });\r\n+                if (res.ok) { success = true; break; }\r\n+              } catch (e) {}\r\n+            }\r\n+            if (!success) {\r\n+              setAllItems(prev);\r\n+              Alert.alert(\"Delete failed\", \"Could not delete from the server.\");\r\n+              await fetchAll();\r\n+            }\r\n+          } catch (e) {\r\n+            setAllItems(prev);\r\n+            Alert.alert(\"Delete failed\", \"Unexpected error.\");\r\n+            await fetchAll();\r\n+          }\r\n+        },\r\n+      },\r\n+    ]);\r\n+  };\r\n+\r\n+  const dataToShow = allItems.slice(0, visible);\r\n+  const hasMore = visible < allItems.length;\r\n+\r\n+  if (!loading && allItems.length === 0) {\r\n+    return (\r\n+      <View style={styles.container}>\r\n+        <View style={styles.topBar}><Text style={styles.heading}>HISTORY</Text></View>\r\n+        <View style={styles.emptyWrap}>\r\n+          <Image source={require(\"../../assets/images/tricycle.png\")} style={styles.emptyImage} />\r\n+          <Text style={styles.emptyMsg}>No history yet — drive some trips to see them here.</Text>\r\n+          <TouchableOpacity style={styles.viewMoreBtn} onPress={onRefresh}>\r\n+            <Text style={styles.viewMoreText}>Reload</Text>\r\n+          </TouchableOpacity>\r\n+        </View>\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n-      <View style={styles.topBar}>\r\n-        <Text style={styles.heading}>HISTORY</Text>\r\n-      </View>\r\n+      <View style={styles.topBar}><Text style={styles.heading}>HISTORY</Text></View>\r\n \r\n-      <View style={styles.container2}>\r\n-        <Image source={require('../../assets/images/tricycle.png')} style={styles.chatImage} />\r\n-        <Text style={styles.message}>Mag Book na para mag ka history ka.</Text>\r\n-      </View>\r\n-        <View style={styles.bottomNav}>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n-        </View>\r\n+      <FlatList\r\n+        data={dataToShow}\r\n+        keyExtractor={(it) => it._id}\r\n+        contentContainerStyle={{ paddingHorizontal: 16, paddingBottom: 24 }}\r\n+        refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}\r\n+        renderItem={({ item }) => (\r\n+          <HistoryCard\r\n+            item={item}\r\n+            php={php}\r\n+            when={when}\r\n+            expanded={expandedId === item._id}\r\n+            onToggle={() => toggleExpand(item._id)}\r\n+            onDelete={() => askDelete(item._id)}\r\n+          />\r\n+        )}\r\n+        ListFooterComponent={\r\n+          hasMore ? (\r\n+            <TouchableOpacity style={styles.viewMoreBtn} onPress={() => setVisible(v => Math.min(v + 10, allItems.length))}>\r\n+              <Text style={styles.viewMoreText}>View more</Text>\r\n+            </TouchableOpacity>\r\n+          ) : allItems.length > 0 ? (\r\n+            <Text style={styles.noMoreText}>End of history</Text>\r\n+          ) : null\r\n+        }\r\n+      />\r\n     </View>\r\n   );\r\n }\r\n \r\n-const styles = StyleSheet.create({\r\n-  container: { flex: 1, paddingHorizontal: 20 },\r\n-  topBar: { marginTop: 40, marginBottom: 20 }, // Adjust top margin as needed\r\n-  heading: { fontWeight: 'bold', fontSize: 22 },\r\n-  container2: { flex: 1, justifyContent: 'center', alignItems: 'center' },\r\n-  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n-  message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n-});\r\n-import React from 'react';\r\n-import { View, Text, StyleSheet, TouchableOpacity, Dimensions, Image } from 'react-native';\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { router } from 'expo-router'; \r\n-const { width, height } = Dimensions.get(\"window\");\r\n+function HistoryCard({\r\n+  item, php, when, expanded, onToggle, onDelete,\r\n+}: {\r\n+  item: RideItem;\r\n+  php: (n: number) => string;\r\n+  when: (iso: string) => string;\r\n+  expanded: boolean;\r\n+  onToggle: () => void;\r\n+  onDelete: () => void;\r\n+}) {\r\n+  const pickup = item.pickupLabel || item.pickupPlace || \"Pickup location\";\r\n+  const dest = item.destinationLabel || item.destinationPlace || \"Destination\";\r\n \r\n-export default function PHistory() {\r\n+  // For group: show per-person fare × pax and computed total (if totalFare available use it)\r\n+  const perFare = item.fare ?? 0;\r\n+  const pax = item.groupCount ?? 1;\r\n+  const total = item.totalFare != null ? item.totalFare : (String(item.bookingType).toLowerCase() === \"group\" ? perFare * pax : perFare);\r\n+\r\n   return (\r\n-    <View style={styles.container}>\r\n-        <Text style={styles.heading}>History</Text>\r\n-        <Image source={require('../../assets/images/tricycle.png')} style={styles.chatImage} />\r\n-        <Text style={styles.message}>Mag Book na para mag ka history ka.</Text>\r\n-        <View style={styles.bottomNav}>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homedriver/dprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n+    <TouchableOpacity activeOpacity={0.95} style={styles.card} onPress={onToggle}>\r\n+      <View style={styles.row}>\r\n+        <Image source={require(\"../../assets/images/tricycle.png\")} style={styles.thumb} />\r\n+        <View style={{ flex: 1, paddingRight: 8 }}>\r\n+          <View style={[styles.row, { justifyContent: \"space-between\" }]}>\r\n+            <View style={styles.row}>\r\n+              <Ionicons name=\"location-outline\" size={16} color=\"#444\" style={{ marginTop: 1 }} />\r\n+              <Text style={styles.mainText} numberOfLines={1}>{pickup}</Text>\r\n+            </View>\r\n+\r\n+            {!!item.bookingType && (\r\n+              <View style={[styles.typeChip, typeChipStyle(item.bookingType)]}>\r\n+                <Text style={styles.typeChipText}>{String(item.bookingType).replace(/CLASSIC/i,'Classic').replace(/GROUP/i,'Group').replace(/SOLO/i,'Solo')}</Text>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+\r\n+          <View style={[styles.row, { marginTop: 6 }]}>\r\n+            <MaterialIcons name=\"route\" size={16} color=\"#444\" />\r\n+            <Text style={styles.subText} numberOfLines={1}>{dest}</Text>\r\n+          </View>\r\n+\r\n+          <View style={[styles.row, { marginTop: 6, justifyContent: \"space-between\" }]}>\r\n+            <Text style={styles.timeText}>{when(item.createdAt)}</Text>\r\n+\r\n+            {String(item.bookingType).toLowerCase() === \"group\" && typeof item.groupCount === \"number\" && (\r\n+              <View style={styles.groupChip}>\r\n+                <Ionicons name=\"people-outline\" size={14} color=\"#333\" />\r\n+                <Text style={{ marginLeft: 6, fontSize: 12 }}>{item.groupCount} pax</Text>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n         </View>\r\n-    </View>\r\n+\r\n+        {String(item.bookingType).toLowerCase() === \"group\" && typeof item.groupCount === \"number\" ? (\r\n+          <View style={{ alignItems: \"flex-end\" }}>\r\n+            <Text style={{ fontSize: 12 }}>{php(perFare)}</Text>\r\n+            <Text style={{ fontSize: 12 }}>x {pax}</Text>\r\n+            <Text style={styles.priceText}>{php(total)}</Text>\r\n+          </View>\r\n+        ) : (\r\n+          <Text style={styles.priceText}>{php(total)}</Text>\r\n+        )}\r\n+      </View>\r\n+\r\n+      {expanded && (\r\n+        <View style={styles.expandBox}>\r\n+          <Text style={styles.expandTitle}>Passenger: <Text style={{ fontWeight: \"600\" }}>{item.passengerId || \"—\"}</Text></Text>\r\n+          {!!item.notes && <Text style={styles.expandNote} numberOfLines={4}>Note: {item.notes}</Text>}\r\n+\r\n+          <View style={styles.expandFooter}>\r\n+            <View style={{ flex: 1 }}>\r\n+              {!!item.bookingId && <Text style={styles.meta}>Booking: {item.bookingId}</Text>}\r\n+              {!!item.paymentMethod && <Text style={styles.meta}>Payment: {item.paymentMethod}</Text>}\r\n+            </View>\r\n+            <View style={styles.actionsRow}>\r\n+              <TouchableOpacity onPress={onDelete} style={styles.trashBtn}>\r\n+                <Ionicons name=\"trash-bin-outline\" size={22} color=\"#b00000\" />\r\n+              </TouchableOpacity>\r\n+            </View>\r\n+          </View>\r\n+        </View>\r\n+      )}\r\n+    </TouchableOpacity>\r\n   );\r\n }\r\n \r\n+function typeChipStyle(t?: string) {\r\n+  switch (String(t || \"\").toLowerCase()) {\r\n+    case \"solo\": return { borderColor: \"#c9e7ff\", backgroundColor: \"#f2f9ff\" };\r\n+    case \"group\": return { borderColor: \"#ffe2b6\", backgroundColor: \"#fff7e9\" };\r\n+    default: return { borderColor: \"#e0e0e0\", backgroundColor: \"#f7f7f7\" };\r\n+  }\r\n+}\r\n+\r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n-  heading: { fontWeight: 'bold', fontSize: 18, marginBottom: 20 },\r\n-  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n-  message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+  container: { flex: 1, backgroundColor: \"#fff\" },\r\n+  topBar: { paddingTop: 40, paddingHorizontal: 20, paddingBottom: 12 },\r\n+  heading: { fontWeight: \"bold\", fontSize: 22 },\r\n+  card: {\r\n+    backgroundColor: \"#fff\", borderRadius: 12, padding: 12, marginTop: 12,\r\n+    shadowColor: \"#000\", shadowOpacity: 0.06, shadowRadius: 6, shadowOffset: { width: 0, height: 3 },\r\n+    elevation: 2, borderWidth: 0.5, borderColor: \"#eee\",\r\n+  },\r\n+  row: { flexDirection: \"row\", alignItems: \"center\" },\r\n+  thumb: { width: 48, height: 48, marginRight: 12, resizeMode: \"contain\" },\r\n+  mainText: { marginLeft: 6, fontSize: 14, fontWeight: \"600\", color: \"#111\", flexShrink: 1 },\r\n+  subText: { marginLeft: 6, fontSize: 13, color: \"#333\", flexShrink: 1 },\r\n+  timeText: { fontSize: 12, color: \"#666\" },\r\n+  priceText: { fontSize: 14, fontWeight: \"700\", color: \"#111\" },\r\n+  typeChip: { paddingHorizontal: 10, paddingVertical: 4, borderRadius: 999, borderWidth: 1 },\r\n+  typeChipText: { fontSize: 11, fontWeight: \"700\" },\r\n+  groupChip: { flexDirection: \"row\", alignItems: \"center\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 999, paddingHorizontal: 8, paddingVertical: 2 },\r\n+\r\n+  expandBox: { marginTop: 10, paddingTop: 10, borderTopWidth: 1, borderTopColor: \"#eee\" },\r\n+  expandTitle: { fontSize: 14, marginBottom: 6 },\r\n+  expandNote: { fontSize: 13, color: \"#333\", marginBottom: 8 },\r\n+  expandFooter: { flexDirection: \"row\", alignItems: \"center\", gap: 10 },\r\n+  meta: { fontSize: 12, color: \"#666\" },\r\n+  actionsRow: { flexDirection: \"row\", alignItems: \"center\", gap: 8 },\r\n+  trashBtn: { borderWidth: 1, borderColor: \"#f1b0b0\", backgroundColor: \"#fff5f5\", padding: 8, borderRadius: 12 },\r\n+\r\n+  emptyWrap: { flex: 1, justifyContent: \"center\", alignItems: \"center\", paddingHorizontal: 20 },\r\n+  emptyImage: { width: 150, height: 150, marginBottom: 20, resizeMode: \"contain\" },\r\n+  emptyMsg: { textAlign: \"center\", fontSize: 14, color: \"#333\", marginBottom: 8 },\r\n+\r\n+  viewMoreBtn: { marginTop: 12, alignSelf: \"center\", paddingHorizontal: 16, paddingVertical: 10, borderRadius: 999, borderWidth: 1, borderColor: \"#ddd\" },\r\n+  viewMoreText: { fontWeight: \"600\", color: \"#111\" },\r\n+  noMoreText: { textAlign: \"center\", color: \"#666\", marginTop: 12 },\r\n+\r\n+  modalOverlay: { flex: 1, backgroundColor: \"rgba(0,0,0,0.4)\", justifyContent: \"center\", alignItems: \"center\", padding: 20 },\r\n+  modalCard: { width: \"100%\", maxWidth: 420, backgroundColor: \"#fff\", borderRadius: 12, padding: 16 },\r\n+  feedbackInput: { borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, paddingHorizontal: 12, paddingVertical: 10, minHeight: 80, textAlignVertical: \"top\" },\r\n+  submitButton: { marginTop: 8, borderRadius: 8, paddingVertical: 10, alignItems: \"center\" },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"600\" },\r\n });\r\n"
                }
            ],
            "date": 1748350673087,
            "name": "Commit-0",
            "content": "import React from 'react';\r\nimport { View, Text, StyleSheet, TouchableOpacity, Dimensions } from 'react-native';\r\nimport { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\nimport { router } from 'expo-router'; \r\nconst { width, height } = Dimensions.get(\"window\");\r\n\r\nexport default function PHistory() {\r\n  return (\r\n    <View style={styles.container}>\r\n        <Text>Passenger History Page</Text>\r\n        <View style={styles.bottomNav}>\r\n            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n            <TouchableOpacity onPress={() => router.push(\"/homedriver/dhistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n            <TouchableOpacity onPress={() => router.push(\"/homedriver/dchats\")}><Ionicons name=\"chatbubbles\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n            <TouchableOpacity onPress={() => router.push(\"/homedriver/dprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n        </View>\r\n    </View>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { flex: 1, justifyContent: 'center', alignItems: 'center' },\r\n  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n});\r\n"
        }
    ]
}