{
    "sourceFile": "app/homepassenger/phome.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 677,
            "patches": [
                {
                    "date": 1745770351244,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1745805411053,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,50 +1,192 @@\n-import React from \"react\";\r\n-import { View, Text, TouchableOpacity, StyleSheet, StatusBar, Dimensions } from \"react-native\";\r\n+// üìç Passenger HomePage - phome.tsx\r\n+\r\n+import React, { useState, useEffect } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, TextInput } from \"react-native\";\r\n+import MapView, { Marker } from \"react-native-maps\";\r\n+import * as Location from \"expo-location\";\r\n import { useRouter } from \"expo-router\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { LocationProvider } from \"../location/GlobalLocation\";\r\n \r\n-const { width } = Dimensions.get(\"window\");\r\n \r\n-export default function PassengerHome() {\r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+export default function PHome() {\r\n+  const [location, setLocation] = useState(null);\r\n+  const [loading, setLoading] = useState(true);\r\n   const router = useRouter();\r\n \r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      let { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") {\r\n+        alert(\"Permission to access location was denied\");\r\n+        return;\r\n+      }\r\n+\r\n+      let loc = await Location.getCurrentPositionAsync({});\r\n+      setLocation(loc.coords);\r\n+      setLoading(false);\r\n+    })();\r\n+  }, []);\r\n+\r\n+  if (loading || !location) {\r\n+    return (\r\n+      <View style={styles.loadingContainer}>\r\n+        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n-      <StatusBar barStyle=\"dark-content\" translucent backgroundColor=\"transparent\" />\r\n-      \r\n-      <View style={styles.inner}>\r\n-        <Text style={styles.title}>Welcome, Passenger!</Text>\r\n-        <Text style={styles.subtitle}>You are now logged in.</Text>\r\n+      {/* Map */}\r\n+      <MapView\r\n+        style={StyleSheet.absoluteFillObject}\r\n+        initialRegion={{\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          latitudeDelta: 0.01,\r\n+          longitudeDelta: 0.01,\r\n+        }}\r\n+      >\r\n+        <Marker\r\n+          coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n+          title=\"You are here\"\r\n+        />\r\n+      </MapView>\r\n \r\n-        <TouchableOpacity\r\n-          style={styles.button}\r\n-        //   onPress={() => router.push(\"/somewhere\")} // Replace with your real pages later\r\n-        >\r\n-          <Text style={styles.buttonText}>Go to Available Rides</Text>\r\n+      {/* Floating Card */}\r\n+      <View style={styles.card}>\r\n+        <View style={styles.cardHeader} />\r\n+\r\n+        <TouchableOpacity style={styles.inputBox}>\r\n+          <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+          <Text style={styles.inputText}>Saan ka papunta ngayon?</Text>\r\n+          <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n-        <TouchableOpacity\r\n-          style={[styles.button, { backgroundColor: \"#DD1F1F\" }]}\r\n-          onPress={() => router.push(\"/login_and_reg/plogin\")} // Simulate logout (go back to login)\r\n-        >\r\n-          <Text style={styles.buttonText}>Log Out</Text>\r\n+        <TouchableOpacity style={styles.inputBox}>\r\n+          <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n+          <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n+          <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n+\r\n+        <TouchableOpacity style={styles.inputBoxSimple}>\r\n+          <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n+          <Text style={styles.inputText}>Notes sa driver</Text>\r\n+        </TouchableOpacity>\r\n+\r\n+        <TouchableOpacity style={styles.inputBox}>\r\n+          <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n+          <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n+          <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+        </TouchableOpacity>\r\n+\r\n+        <View style={styles.totalFareContainer}>\r\n+          <View style={styles.fareBox}>\r\n+            <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+          </View>\r\n+          <TouchableOpacity style={styles.bookNowButton}>\r\n+            <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+          </TouchableOpacity>\r\n+        </View>\r\n       </View>\r\n+\r\n+      {/* Bottom Nav */}\r\n+      <View style={styles.bottomNav}>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+          <Text>Home</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+          <Text>History</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+          <Text>Chats</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+          <Text>Profile</Text>\r\n+        </TouchableOpacity>\r\n+      </View>\r\n     </View>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, backgroundColor: \"#fff\", alignItems: \"center\", justifyContent: \"center\" },\r\n-  inner: { width: width * 0.85, alignItems: \"center\" },\r\n-  title: { fontSize: 26, fontWeight: \"bold\", color: \"#414141\", marginBottom: 10 },\r\n-  subtitle: { fontSize: 16, color: \"#666\", marginBottom: 30 },\r\n-  button: {\r\n-    width: \"100%\",\r\n-    backgroundColor: \"#5089A3\",\r\n+  container: { flex: 1 },\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n+  card: {\r\n+    position: \"absolute\",\r\n+    bottom: 80,\r\n+    backgroundColor: \"#87CEEB\",\r\n+    width: width * 0.9,\r\n+    alignSelf: \"center\",\r\n+    borderRadius: 10,\r\n+    padding: 15,\r\n+  },\r\n+  cardHeader: {\r\n+    width: 50,\r\n+    height: 4,\r\n+    backgroundColor: \"black\",\r\n+    alignSelf: \"center\",\r\n+    borderRadius: 5,\r\n+    marginBottom: 10,\r\n+  },\r\n+  inputBox: {\r\n+    backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n-    paddingVertical: 14,\r\n+    flexDirection: \"row\",\r\n     alignItems: \"center\",\r\n-    marginBottom: 15,\r\n+    justifyContent: \"space-between\",\r\n+    paddingHorizontal: 10,\r\n+    height: 45,\r\n+    marginBottom: 10,\r\n   },\r\n-  buttonText: { color: \"#fff\", fontSize: 16, fontWeight: \"bold\" },\r\n+  inputBoxSimple: {\r\n+    backgroundColor: \"white\",\r\n+    borderRadius: 8,\r\n+    flexDirection: \"row\",\r\n+    alignItems: \"center\",\r\n+    paddingHorizontal: 10,\r\n+    height: 45,\r\n+    marginBottom: 10,\r\n+  },\r\n+  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n+  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n+  fareBox: {\r\n+    flex: 1,\r\n+    backgroundColor: \"white\",\r\n+    borderRadius: 8,\r\n+    alignItems: \"center\",\r\n+    justifyContent: \"center\",\r\n+    padding: 10,\r\n+    marginRight: 5,\r\n+  },\r\n+  totalFareText: { fontSize: 16, fontWeight: \"bold\" },\r\n+  bookNowButton: {\r\n+    flex: 1,\r\n+    backgroundColor: \"white\",\r\n+    borderRadius: 8,\r\n+    alignItems: \"center\",\r\n+    justifyContent: \"center\",\r\n+    padding: 10,\r\n+    marginLeft: 5,\r\n+  },\r\n+  bookNowText: { fontSize: 16, fontWeight: \"bold\" },\r\n+  bottomNav: {\r\n+    position: \"absolute\",\r\n+    bottom: 0,\r\n+    flexDirection: \"row\",\r\n+    justifyContent: \"space-around\",\r\n+    width: width,\r\n+    height: 70,\r\n+    backgroundColor: \"white\",\r\n+    borderTopLeftRadius: 30,\r\n+    borderTopRightRadius: 30,\r\n+    alignItems: \"center\",\r\n+  },\r\n });\r\n"
                },
                {
                    "date": 1745805917917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,32 +5,17 @@\n import MapView, { Marker } from \"react-native-maps\";\r\n import * as Location from \"expo-location\";\r\n import { useRouter } from \"expo-router\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { LocationProvider } from \"../location/GlobalLocation\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n \r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n-  const [location, setLocation] = useState(null);\r\n-  const [loading, setLoading] = useState(true);\r\n+  const { location, loading } = useLocation();\r\n   const router = useRouter();\r\n \r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      let { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") {\r\n-        alert(\"Permission to access location was denied\");\r\n-        return;\r\n-      }\r\n-\r\n-      let loc = await Location.getCurrentPositionAsync({});\r\n-      setLocation(loc.coords);\r\n-      setLoading(false);\r\n-    })();\r\n-  }, []);\r\n-\r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n         <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n"
                },
                {
                    "date": 1745806149996,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,18 +12,9 @@\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const router = useRouter();\r\n \r\n-  if (loading || !location) {\r\n-    return (\r\n-      <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n-      </View>\r\n-    );\r\n-  }\r\n-\r\n   return (\r\n     <View style={styles.container}>\r\n       {/* Map */}\r\n       <MapView\r\n"
                },
                {
                    "date": 1745806164429,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,9 +12,18 @@\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n+  const router = useRouter();\r\n \r\n+  if (loading || !location) {\r\n+    return (\r\n+      <View style={styles.loadingContainer}>\r\n+        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       {/* Map */}\r\n       <MapView\r\n"
                },
                {
                    "date": 1745807647183,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,8 +13,9 @@\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const router = useRouter();\r\n+  console.log(location)\r\n \r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n"
                },
                {
                    "date": 1745807794493,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -107,9 +107,9 @@\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 80,\r\n-    backgroundColor: \"#87CEEB\",\r\n+    backgroundColor: \"#81C3E1\",\r\n     width: width * 0.9,\r\n     alignSelf: \"center\",\r\n     borderRadius: 10,\r\n     padding: 15,\r\n"
                },
                {
                    "date": 1745807812485,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -129,9 +129,9 @@\n     alignItems: \"center\",\r\n     justifyContent: \"space-between\",\r\n     paddingHorizontal: 10,\r\n     height: 45,\r\n-    marginBottom: 10,\r\n+    marginBottom: 5,\r\n   },\r\n   inputBoxSimple: {\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n"
                },
                {
                    "date": 1745807853382,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -138,9 +138,9 @@\n     flexDirection: \"row\",\r\n     alignItems: \"center\",\r\n     paddingHorizontal: 10,\r\n     height: 45,\r\n-    marginBottom: 10,\r\n+    marginBottom: 5,\r\n   },\r\n   inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n   totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n   fareBox: {\r\n"
                },
                {
                    "date": 1745807859777,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -136,9 +136,9 @@\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     flexDirection: \"row\",\r\n     alignItems: \"center\",\r\n-    paddingHorizontal: 10,\r\n+    paddingHorizontal: ,\r\n     height: 45,\r\n     marginBottom: 5,\r\n   },\r\n   inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n"
                },
                {
                    "date": 1745807873535,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -136,10 +136,10 @@\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     flexDirection: \"row\",\r\n     alignItems: \"center\",\r\n-    paddingHorizontal: ,\r\n-    height: 45,\r\n+    paddingHorizontal: 10,\r\n+    height: 40,\r\n     marginBottom: 5,\r\n   },\r\n   inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n   totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n"
                },
                {
                    "date": 1745807891337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -128,9 +128,9 @@\n     flexDirection: \"row\",\r\n     alignItems: \"center\",\r\n     justifyContent: \"space-between\",\r\n     paddingHorizontal: 10,\r\n-    height: 45,\r\n+    height: 40,\r\n     marginBottom: 5,\r\n   },\r\n   inputBoxSimple: {\r\n     backgroundColor: \"white\",\r\n"
                },
                {
                    "date": 1745807921066,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -145,9 +145,8 @@\n   totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n   fareBox: {\r\n     flex: 1,\r\n     backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n     padding: 10,\r\n     marginRight: 5,\r\n"
                },
                {
                    "date": 1745807952997,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -147,9 +147,9 @@\n     flex: 1,\r\n     backgroundColor: \"white\",\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n-    padding: 10,\r\n+    paddingHorizontal: 10,\r\n     marginRight: 5,\r\n   },\r\n   totalFareText: { fontSize: 16, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n"
                },
                {
                    "date": 1745807969707,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -144,8 +144,9 @@\n   inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n   totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n   fareBox: {\r\n     flex: 1,\r\n+    borderRadius: 3\r\n     backgroundColor: \"white\",\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n     paddingHorizontal: 10,\r\n"
                },
                {
                    "date": 1745807985134,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -144,13 +144,12 @@\n   inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n   totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n   fareBox: {\r\n     flex: 1,\r\n-    borderRadius: 3\r\n+    borderRadius: 3,\r\n     backgroundColor: \"white\",\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n-    paddingHorizontal: 10,\r\n     marginRight: 5,\r\n   },\r\n   totalFareText: { fontSize: 16, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n"
                },
                {
                    "date": 1745807997411,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,11 +148,12 @@\n     borderRadius: 3,\r\n     backgroundColor: \"white\",\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n+    paddingHorizontal: 10,\r\n     marginRight: 5,\r\n   },\r\n-  totalFareText: { fontSize: 16, fontWeight: \"bold\" },\r\n+  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n     flex: 1,\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n"
                },
                {
                    "date": 1745808007099,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -146,9 +146,8 @@\n   fareBox: {\r\n     flex: 1,\r\n     borderRadius: 3,\r\n     backgroundColor: \"white\",\r\n-    alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n     paddingHorizontal: 10,\r\n     marginRight: 5,\r\n   },\r\n"
                },
                {
                    "date": 1745808014449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -147,9 +147,8 @@\n     flex: 1,\r\n     borderRadius: 3,\r\n     backgroundColor: \"white\",\r\n     justifyContent: \"center\",\r\n-    paddingHorizontal: 10,\r\n     marginRight: 5,\r\n   },\r\n   totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n"
                },
                {
                    "date": 1745808021945,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -147,8 +147,9 @@\n     flex: 1,\r\n     borderRadius: 3,\r\n     backgroundColor: \"white\",\r\n     justifyContent: \"center\",\r\n+    paddingHorizontal: 10,\r\n     marginRight: 5,\r\n   },\r\n   totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n"
                },
                {
                    "date": 1745808041529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -147,10 +147,11 @@\n     flex: 1,\r\n     borderRadius: 3,\r\n     backgroundColor: \"white\",\r\n     justifyContent: \"center\",\r\n-    paddingHorizontal: 10,\r\n+    paddingHorizontal: 5,\r\n     marginRight: 5,\r\n+    width: '50%',\r\n   },\r\n   totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n     flex: 1,\r\n"
                },
                {
                    "date": 1745808102377,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -111,9 +111,9 @@\n     backgroundColor: \"#81C3E1\",\r\n     width: width * 0.9,\r\n     alignSelf: \"center\",\r\n     borderRadius: 10,\r\n-    padding: 15,\r\n+    padding: 10,\r\n   },\r\n   cardHeader: {\r\n     width: 50,\r\n     height: 4,\r\n"
                },
                {
                    "date": 1745808124662,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -108,9 +108,9 @@\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 80,\r\n     backgroundColor: \"#81C3E1\",\r\n-    width: width * 0.9,\r\n+    width: width * 0.95,\r\n     alignSelf: \"center\",\r\n     borderRadius: 10,\r\n     padding: 10,\r\n   },\r\n"
                },
                {
                    "date": 1745808141471,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,9 +106,9 @@\n   container: { flex: 1 },\r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n   card: {\r\n     position: \"absolute\",\r\n-    bottom: 80,\r\n+    bottom: 60,\r\n     backgroundColor: \"#81C3E1\",\r\n     width: width * 0.95,\r\n     alignSelf: \"center\",\r\n     borderRadius: 10,\r\n"
                },
                {
                    "date": 1745808148877,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -106,9 +106,9 @@\n   container: { flex: 1 },\r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n   card: {\r\n     position: \"absolute\",\r\n-    bottom: 60,\r\n+    bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n     width: width * 0.95,\r\n     alignSelf: \"center\",\r\n     borderRadius: 10,\r\n"
                },
                {
                    "date": 1745808167773,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -114,9 +114,9 @@\n     borderRadius: 10,\r\n     padding: 10,\r\n   },\r\n   cardHeader: {\r\n-    width: 50,\r\n+    width: 100,\r\n     height: 4,\r\n     backgroundColor: \"black\",\r\n     alignSelf: \"center\",\r\n     borderRadius: 5,\r\n"
                },
                {
                    "date": 1745808203577,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -114,9 +114,9 @@\n     borderRadius: 10,\r\n     padding: 10,\r\n   },\r\n   cardHeader: {\r\n-    width: 100,\r\n+    width: 150,\r\n     height: 4,\r\n     backgroundColor: \"black\",\r\n     alignSelf: \"center\",\r\n     borderRadius: 5,\r\n@@ -160,8 +160,9 @@\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n     padding: 10,\r\n     marginLeft: 5,\r\n+    width: '50%',\r\n   },\r\n   bookNowText: { fontSize: 16, fontWeight: \"bold\" },\r\n   bottomNav: {\r\n     position: \"absolute\",\r\n"
                },
                {
                    "date": 1745808219059,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,9 +158,9 @@\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n-    padding: 10,\r\n+    paddingHorizontal: 5,\r\n     marginLeft: 5,\r\n     width: '50%',\r\n   },\r\n   bookNowText: { fontSize: 16, fontWeight: \"bold\" },\r\n"
                },
                {
                    "date": 1745808226060,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,9 +158,9 @@\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n-    paddingHorizontal: 5,\r\n+    padding: 5,\r\n     marginLeft: 5,\r\n     width: '50%',\r\n   },\r\n   bookNowText: { fontSize: 16, fontWeight: \"bold\" },\r\n"
                },
                {
                    "date": 1745808242702,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -162,9 +162,9 @@\n     padding: 5,\r\n     marginLeft: 5,\r\n     width: '50%',\r\n   },\r\n-  bookNowText: { fontSize: 16, fontWeight: \"bold\" },\r\n+  bookNowText: { fontSize: 14 },\r\n   bottomNav: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1745808259452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -160,11 +160,11 @@\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n     padding: 5,\r\n     marginLeft: 5,\r\n-    width: '50%',\r\n+    width: '30%',\r\n   },\r\n-  bookNowText: { fontSize: 14 },\r\n+  bookNowText: { fontSize: 16 },\r\n   bottomNav: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1745808264633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -149,9 +149,9 @@\n     backgroundColor: \"white\",\r\n     justifyContent: \"center\",\r\n     paddingHorizontal: 5,\r\n     marginRight: 5,\r\n-    width: '50%',\r\n+    width: '70%',\r\n   },\r\n   totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n     flex: 1,\r\n"
                },
                {
                    "date": 1745808275663,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -149,9 +149,9 @@\n     backgroundColor: \"white\",\r\n     justifyContent: \"center\",\r\n     paddingHorizontal: 5,\r\n     marginRight: 5,\r\n-    width: '70%',\r\n+    width: '50%',\r\n   },\r\n   totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n   bookNowButton: {\r\n     flex: 1,\r\n@@ -160,9 +160,9 @@\n     alignItems: \"center\",\r\n     justifyContent: \"center\",\r\n     padding: 5,\r\n     marginLeft: 5,\r\n-    width: '30%',\r\n+    width: '50%',\r\n   },\r\n   bookNowText: { fontSize: 16 },\r\n   bottomNav: {\r\n     position: \"absolute\",\r\n"
                },
                {
                    "date": 1745808359007,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -174,6 +174,8 @@\n     backgroundColor: \"white\",\r\n     borderTopLeftRadius: 30,\r\n     borderTopRightRadius: 30,\r\n     alignItems: \"center\",\r\n+    borderWidth: 1,\r\n+  borderColor: \"#ccc\",\r\n   },\r\n });\r\n"
                },
                {
                    "date": 1745808364807,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -175,7 +175,7 @@\n     borderTopLeftRadius: 30,\r\n     borderTopRightRadius: 30,\r\n     alignItems: \"center\",\r\n     borderWidth: 1,\r\n-  borderColor: \"#ccc\",\r\n+  borderColor: \"black\",\r\n   },\r\n });\r\n"
                },
                {
                    "date": 1745808405073,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,8 @@\n // üìç Passenger HomePage - phome.tsx\r\n \r\n import React, { useState, useEffect } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, TextInput } from \"react-native\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, TextInput, StatusBar } from \"react-native\";\r\n import MapView, { Marker } from \"react-native-maps\";\r\n import * as Location from \"expo-location\";\r\n import { useRouter } from \"expo-router\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -25,8 +25,11 @@\n   }\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n+      <View style={{paddingTop: 30}}>\r\n+        <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+      </View>\r\n       {/* Map */}\r\n       <MapView\r\n         style={StyleSheet.absoluteFillObject}\r\n         initialRegion={{\r\n"
                },
                {
                    "date": 1745808843490,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,9 +13,8 @@\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const router = useRouter();\r\n-  console.log(location)\r\n \r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n"
                },
                {
                    "date": 1745813855733,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,21 +1,26 @@\n-// üìç Passenger HomePage - phome.tsx\r\n+// üìç Updated Passenger HomePage - phome.tsx\r\n \r\n-import React, { useState, useEffect } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, TextInput, StatusBar } from \"react-native\";\r\n+import React, { useState } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar } from \"react-native\";\r\n import MapView, { Marker } from \"react-native-maps\";\r\n import * as Location from \"expo-location\";\r\n import { useRouter } from \"expo-router\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n \r\n-\r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const router = useRouter();\r\n \r\n+  const [destination, setDestination] = useState<{\r\n+    name: string;\r\n+    latitude: number;\r\n+    longitude: number;\r\n+  } | null>(null);\r\n+\r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n         <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n@@ -24,11 +29,12 @@\n   }\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n-      <View style={{paddingTop: 30}}>\r\n+      <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n+\r\n       {/* Map */}\r\n       <MapView\r\n         style={StyleSheet.absoluteFillObject}\r\n         initialRegion={{\r\n@@ -36,42 +42,65 @@\n           longitude: location.longitude,\r\n           latitudeDelta: 0.01,\r\n           longitudeDelta: 0.01,\r\n         }}\r\n+        showsUserLocation\r\n+        onPoiClick={(e) => {\r\n+          const { coordinate, name } = e.nativeEvent;\r\n+          setDestination({\r\n+            name: name,\r\n+            latitude: coordinate.latitude,\r\n+            longitude: coordinate.longitude,\r\n+          });\r\n+        }}\r\n       >\r\n         <Marker\r\n           coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n           title=\"You are here\"\r\n         />\r\n+        {destination && (\r\n+          <Marker\r\n+            coordinate={{ latitude: destination.latitude, longitude: destination.longitude }}\r\n+            title={destination.name}\r\n+            pinColor=\"blue\"\r\n+          />\r\n+        )}\r\n       </MapView>\r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n \r\n+        {/* Pickup Location */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-          <Text style={styles.inputText}>Saan ka papunta ngayon?</Text>\r\n+          <Text style={styles.inputText}>\r\n+            {destination?.name || \"Saan ka papunta ngayon?\"}\r\n+          </Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n+        {/* Destination (For now static, editable later if needed) */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n+        {/* Notes to Driver */}\r\n         <TouchableOpacity style={styles.inputBoxSimple}>\r\n           <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Notes sa driver</Text>\r\n         </TouchableOpacity>\r\n \r\n+        {/* Payment Method */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n+        {/* Fare and Book Now */}\r\n         <View style={styles.totalFareContainer}>\r\n           <View style={styles.fareBox}>\r\n             <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n           </View>\r\n@@ -177,7 +206,7 @@\n     borderTopLeftRadius: 30,\r\n     borderTopRightRadius: 30,\r\n     alignItems: \"center\",\r\n     borderWidth: 1,\r\n-  borderColor: \"black\",\r\n+    borderColor: \"black\",\r\n   },\r\n });\r\n"
                },
                {
                    "date": 1745814074215,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,9 +51,18 @@\n             latitude: coordinate.latitude,\r\n             longitude: coordinate.longitude,\r\n           });\r\n         }}\r\n+        onPress={(e) => {\r\n+          const { coordinate } = e.nativeEvent;\r\n+          setDestination({\r\n+            name: \"\", // No name\r\n+            latitude: coordinate.latitude,\r\n+            longitude: coordinate.longitude,\r\n+          });\r\n+        }}\r\n       >\r\n+\r\n         <Marker\r\n           coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n           title=\"You are here\"\r\n         />\r\n"
                },
                {
                    "date": 1745814103095,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,8 +72,9 @@\n             title={destination.name}\r\n             pinColor=\"blue\"\r\n           />\r\n         )}\r\n+        \r\n       </MapView>\r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n"
                },
                {
                    "date": 1746348168738,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,9 +22,9 @@\n \r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n+        <Text style={{ fontSize: 20 }}>Loading...</Text>\r\n       </View>\r\n     );\r\n   }\r\n \r\n"
                },
                {
                    "date": 1746355849232,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,26 +1,44 @@\n-// üìç Updated Passenger HomePage - phome.tsx\r\n-\r\n-import React, { useState } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar } from \"react-native\";\r\n-import MapView, { Marker } from \"react-native-maps\";\r\n+import React, { useState, useEffect } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, Alert } from \"react-native\";\r\n+import MapView, { Marker, Polyline } from \"react-native-maps\";\r\n import * as Location from \"expo-location\";\r\n import { useRouter } from \"expo-router\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n+import API_OSRM_URL from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const router = useRouter();\r\n \r\n-  const [destination, setDestination] = useState<{\r\n-    name: string;\r\n-    latitude: number;\r\n-    longitude: number;\r\n-  } | null>(null);\r\n+  const [destination, setDestination] = useState(null);\r\n+  const [routeCoords, setRouteCoords] = useState([]);\r\n \r\n+  useEffect(() => {\r\n+    const fetchRoute = async () => {\r\n+      if (!location || !destination) return;\r\n+\r\n+      const start = `${location.longitude},${location.latitude}`;\r\n+      const end = `${destination.longitude},${destination.latitude}`;\r\n+      const url = `${API_OSRM_URL}/route/v1/driving/${start};${end}?geometries=geojson`;\r\n+\r\n+      try {\r\n+        const res = await fetch(url);\r\n+        const data = await res.json();\r\n+        const coords = data.routes[0].geometry.coordinates.map(([lng, lat]) => ({ latitude: lat, longitude: lng }));\r\n+        setRouteCoords(coords);\r\n+      } catch (err) {\r\n+        console.error(\"Routing error:\", err);\r\n+        Alert.alert(\"Error\", \"Failed to get route from OSRM.\");\r\n+      }\r\n+    };\r\n+\r\n+    fetchRoute();\r\n+  }, [location, destination]);\r\n+\r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n         <Text style={{ fontSize: 20 }}>Loading...</Text>\r\n@@ -33,9 +51,8 @@\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n \r\n-      {/* Map */}\r\n       <MapView\r\n         style={StyleSheet.absoluteFillObject}\r\n         initialRegion={{\r\n           latitude: location.latitude,\r\n@@ -43,26 +60,13 @@\n           latitudeDelta: 0.01,\r\n           longitudeDelta: 0.01,\r\n         }}\r\n         showsUserLocation\r\n-        onPoiClick={(e) => {\r\n-          const { coordinate, name } = e.nativeEvent;\r\n-          setDestination({\r\n-            name: name,\r\n-            latitude: coordinate.latitude,\r\n-            longitude: coordinate.longitude,\r\n-          });\r\n-        }}\r\n         onPress={(e) => {\r\n           const { coordinate } = e.nativeEvent;\r\n-          setDestination({\r\n-            name: \"\", // No name\r\n-            latitude: coordinate.latitude,\r\n-            longitude: coordinate.longitude,\r\n-          });\r\n+          setDestination({ name: \"\", latitude: coordinate.latitude, longitude: coordinate.longitude });\r\n         }}\r\n       >\r\n-\r\n         <Marker\r\n           coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n           title=\"You are here\"\r\n         />\r\n@@ -72,45 +76,36 @@\n             title={destination.name}\r\n             pinColor=\"blue\"\r\n           />\r\n         )}\r\n-        \r\n+        {routeCoords.length > 0 && (\r\n+          <Polyline coordinates={routeCoords} strokeWidth={5} strokeColor=\"#FF5733\" />\r\n+        )}\r\n       </MapView>\r\n \r\n-      {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n-\r\n-        {/* Pickup Location */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>\r\n             {destination?.name || \"Saan ka papunta ngayon?\"}\r\n           </Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n-\r\n-        {/* Destination (For now static, editable later if needed) */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n-\r\n-        {/* Notes to Driver */}\r\n         <TouchableOpacity style={styles.inputBoxSimple}>\r\n           <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Notes sa driver</Text>\r\n         </TouchableOpacity>\r\n-\r\n-        {/* Payment Method */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n-\r\n-        {/* Fare and Book Now */}\r\n         <View style={styles.totalFareContainer}>\r\n           <View style={styles.fareBox}>\r\n             <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n           </View>\r\n@@ -119,9 +114,8 @@\n           </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n \r\n-      {/* Bottom Nav */}\r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity>\r\n           <Ionicons name=\"home\" size={30} color=\"black\" />\r\n           <Text>Home</Text>\r\n"
                },
                {
                    "date": 1746356249385,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,111 +1,138 @@\n-import React, { useState, useEffect } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, Alert } from \"react-native\";\r\n-import MapView, { Marker, Polyline } from \"react-native-maps\";\r\n+import React, { useEffect, useState } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar } from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import * as Location from \"expo-location\";\r\n-import { useRouter } from \"expo-router\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n import API_OSRM_URL from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const router = useRouter();\r\n-\r\n+  const [location, setLocation] = useState(null);\r\n   const [destination, setDestination] = useState(null);\r\n-  const [routeCoords, setRouteCoords] = useState([]);\r\n+  const [html, setHtml] = useState(\"\");\r\n \r\n+  // Get current location\r\n   useEffect(() => {\r\n-    const fetchRoute = async () => {\r\n-      if (!location || !destination) return;\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+      const loc = await Location.getCurrentPositionAsync({});\r\n+      setLocation({\r\n+        latitude: loc.coords.latitude,\r\n+        longitude: loc.coords.longitude\r\n+      });\r\n+    })();\r\n+  }, []);\r\n \r\n-      const start = `${location.longitude},${location.latitude}`;\r\n-      const end = `${destination.longitude},${destination.latitude}`;\r\n-      const url = `${API_OSRM_URL}/route/v1/driving/${start};${end}?geometries=geojson`;\r\n+  // Build map HTML with OpenStreetMap + OSRM\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n \r\n-      try {\r\n-        const res = await fetch(url);\r\n-        const data = await res.json();\r\n-        const coords = data.routes[0].geometry.coordinates.map(([lng, lat]) => ({ latitude: lat, longitude: lng }));\r\n-        setRouteCoords(coords);\r\n-      } catch (err) {\r\n-        console.error(\"Routing error:\", err);\r\n-        Alert.alert(\"Error\", \"Failed to get route from OSRM.\");\r\n-      }\r\n-    };\r\n+    const template = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+      <head>\r\n+        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+        <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+        <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+      </head>\r\n+      <body>\r\n+        <div id=\"map\"></div>\r\n+        <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+        <script>\r\n+          const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 14);\r\n+          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n+            maxZoom: 19,\r\n+            attribution: '¬© OpenStreetMap contributors'\r\n+          }).addTo(map);\r\n \r\n-    fetchRoute();\r\n-  }, [location, destination]);\r\n+          const start = L.marker([${location.latitude}, ${location.longitude}])\r\n+            .addTo(map)\r\n+            .bindPopup('You are here')\r\n+            .openPopup();\r\n \r\n-  if (loading || !location) {\r\n-    return (\r\n-      <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading...</Text>\r\n-      </View>\r\n-    );\r\n-  }\r\n+          let destMarker = null;\r\n+          let routeLine = null;\r\n \r\n+          map.on('click', async function(e) {\r\n+            const lat = e.latlng.lat;\r\n+            const lng = e.latlng.lng;\r\n+\r\n+            if (destMarker) map.removeLayer(destMarker);\r\n+            if (routeLine) map.removeLayer(routeLine);\r\n+\r\n+            destMarker = L.marker([lat, lng]).addTo(map).bindPopup('Destination').openPopup();\r\n+\r\n+            const res = await fetch(\"${API_OSRM_URL}/route/v1/driving/${location.longitude},${location.latitude};\" + lng + \",\" + lat + \"?geometries=geojson\");\r\n+            const data = await res.json();\r\n+            const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+            routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              destination: { latitude: lat, longitude: lng }\r\n+            }));\r\n+          });\r\n+        </script>\r\n+      </body>\r\n+      </html>\r\n+    `;\r\n+\r\n+    setHtml(template);\r\n+  }, [location]);\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n-        <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+        <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n       </View>\r\n \r\n-      <MapView\r\n-        style={StyleSheet.absoluteFillObject}\r\n-        initialRegion={{\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          latitudeDelta: 0.01,\r\n-          longitudeDelta: 0.01,\r\n-        }}\r\n-        showsUserLocation\r\n-        onPress={(e) => {\r\n-          const { coordinate } = e.nativeEvent;\r\n-          setDestination({ name: \"\", latitude: coordinate.latitude, longitude: coordinate.longitude });\r\n-        }}\r\n-      >\r\n-        <Marker\r\n-          coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n-          title=\"You are here\"\r\n+      {location && html ? (\r\n+        <WebView\r\n+          originWhitelist={['*']}\r\n+          source={{ html }}\r\n+          javaScriptEnabled\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data.destination);\r\n+          }}\r\n+          style={StyleSheet.absoluteFillObject}\r\n         />\r\n-        {destination && (\r\n-          <Marker\r\n-            coordinate={{ latitude: destination.latitude, longitude: destination.longitude }}\r\n-            title={destination.name}\r\n-            pinColor=\"blue\"\r\n-          />\r\n-        )}\r\n-        {routeCoords.length > 0 && (\r\n-          <Polyline coordinates={routeCoords} strokeWidth={5} strokeColor=\"#FF5733\" />\r\n-        )}\r\n-      </MapView>\r\n+      ) : (\r\n+        <View style={styles.loadingContainer}>\r\n+          <Text style={{ fontSize: 20 }}>Loading map...</Text>\r\n+        </View>\r\n+      )}\r\n \r\n+      {/* Floating Card UI (unchanged) */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>\r\n-            {destination?.name || \"Saan ka papunta ngayon?\"}\r\n+            {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n           </Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n+\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n+\r\n         <TouchableOpacity style={styles.inputBoxSimple}>\r\n           <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Notes sa driver</Text>\r\n         </TouchableOpacity>\r\n+\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n+\r\n         <View style={styles.totalFareContainer}>\r\n           <View style={styles.fareBox}>\r\n             <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n           </View>\r\n@@ -114,8 +141,9 @@\n           </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n \r\n+      {/* Bottom Navigation (unchanged) */}\r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity>\r\n           <Ionicons name=\"home\" size={30} color=\"black\" />\r\n           <Text>Home</Text>\r\n"
                },
                {
                    "date": 1746356580051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,117 +1,112 @@\n-import React, { useEffect, useState } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar } from \"react-native\";\r\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView\r\n+\r\n+import React, { useState, useEffect } from \"react\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  StyleSheet,\r\n+  Dimensions,\r\n+  TouchableOpacity,\r\n+  StatusBar,\r\n+} from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import * as Location from \"expo-location\";\r\n-import API_OSRM_URL from \"../../config\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import API_BASE_URL from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n-  const [location, setLocation] = useState(null);\r\n+  const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n-  const [html, setHtml] = useState(\"\");\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n \r\n-  // Get current location\r\n   useEffect(() => {\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-      const loc = await Location.getCurrentPositionAsync({});\r\n-      setLocation({\r\n-        latitude: loc.coords.latitude,\r\n-        longitude: loc.coords.longitude\r\n-      });\r\n-    })();\r\n-  }, []);\r\n-\r\n-  // Build map HTML with OpenStreetMap + OSRM\r\n-  useEffect(() => {\r\n     if (!location) return;\r\n \r\n-    const template = `\r\n+    const html = `\r\n       <!DOCTYPE html>\r\n       <html>\r\n-      <head>\r\n-        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-        <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-        <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n-      </head>\r\n-      <body>\r\n-        <div id=\"map\"></div>\r\n-        <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-        <script>\r\n-          const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 14);\r\n-          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n-            maxZoom: 19,\r\n-            attribution: '¬© OpenStreetMap contributors'\r\n-          }).addTo(map);\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n+            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n+              maxZoom: 19,\r\n+              attribution: '¬© OpenStreetMap contributors'\r\n+            }).addTo(map);\r\n \r\n-          const start = L.marker([${location.latitude}, ${location.longitude}])\r\n-            .addTo(map)\r\n-            .bindPopup('You are here')\r\n-            .openPopup();\r\n+            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n \r\n-          let destMarker = null;\r\n-          let routeLine = null;\r\n+            let destMarker = null;\r\n+            let routeLine = null;\r\n \r\n-          map.on('click', async function(e) {\r\n-            const lat = e.latlng.lat;\r\n-            const lng = e.latlng.lng;\r\n+            map.on('click', async function(e) {\r\n+              const { lat, lng } = e.latlng;\r\n+              if (destMarker) map.removeLayer(destMarker);\r\n+              if (routeLine) map.removeLayer(routeLine);\r\n \r\n-            if (destMarker) map.removeLayer(destMarker);\r\n-            if (routeLine) map.removeLayer(routeLine);\r\n+              destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n-            destMarker = L.marker([lat, lng]).addTo(map).bindPopup('Destination').openPopup();\r\n+              const res = await fetch('${API_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+              const data = await res.json();\r\n+              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n \r\n-            const res = await fetch(\"${API_OSRM_URL}/route/v1/driving/${location.longitude},${location.latitude};\" + lng + \",\" + lat + \"?geometries=geojson\");\r\n-            const data = await res.json();\r\n-            const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-            routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              destination: { latitude: lat, longitude: lng }\r\n-            }));\r\n-          });\r\n-        </script>\r\n-      </body>\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+            });\r\n+          </script>\r\n+        </body>\r\n       </html>\r\n     `;\r\n \r\n-    setHtml(template);\r\n+    setMapHtml(html);\r\n   }, [location]);\r\n \r\n+  if (loading || !location) {\r\n+    return (\r\n+      <View style={styles.loadingContainer}>\r\n+        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n-        <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+        <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n \r\n-      {location && html ? (\r\n+      {mapHtml && (\r\n         <WebView\r\n-          originWhitelist={['*']}\r\n-          source={{ html }}\r\n-          javaScriptEnabled\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled={true}\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data.destination);\r\n+            setDestination(data);\r\n           }}\r\n           style={StyleSheet.absoluteFillObject}\r\n         />\r\n-      ) : (\r\n-        <View style={styles.loadingContainer}>\r\n-          <Text style={{ fontSize: 20 }}>Loading map...</Text>\r\n-        </View>\r\n       )}\r\n \r\n-      {/* Floating Card UI (unchanged) */}\r\n+      {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n+\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>\r\n-            {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n+            {destination\r\n+              ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+              : \"Saan ka papunta ngayon?\"}\r\n           </Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n@@ -141,9 +136,8 @@\n           </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n \r\n-      {/* Bottom Navigation (unchanged) */}\r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity>\r\n           <Ionicons name=\"home\" size={30} color=\"black\" />\r\n           <Text>Home</Text>\r\n"
                },
                {
                    "date": 1746356612933,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n       <html>\r\n         <head>\r\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+          <style> html, body, #map { height: height; margin: 0; padding: 0; } </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n"
                },
                {
                    "date": 1746356624691,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n       <html>\r\n         <head>\r\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: height; margin: 0; padding: 0; } </style>\r\n+          <style> html, body, #map { height: 100vh; margin: 0; padding: 0; } </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n"
                },
                {
                    "date": 1746356793876,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,9 +29,9 @@\n       <html>\r\n         <head>\r\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: 100vh; margin: 0; padding: 0; } </style>\r\n+          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n"
                },
                {
                    "date": 1746356949138,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,22 +81,24 @@\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n+      <View style={styles.mapview}>\r\n+        {mapHtml && (\r\n+          <WebView\r\n+            originWhitelist={[\"*\"]}\r\n+            source={{ html: mapHtml }}\r\n+            javaScriptEnabled={true}\r\n+            onMessage={(event) => {\r\n+              const data = JSON.parse(event.nativeEvent.data);\r\n+              setDestination(data);\r\n+            }}\r\n+            style={StyleSheet.absoluteFillObject}\r\n+          />\r\n+        )}\r\n+      </View>\r\n+      \r\n \r\n-      {mapHtml && (\r\n-        <WebView\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled={true}\r\n-          onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n-          }}\r\n-          style={StyleSheet.absoluteFillObject}\r\n-        />\r\n-      )}\r\n-\r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n \r\n@@ -178,8 +180,11 @@\n     alignSelf: \"center\",\r\n     borderRadius: 5,\r\n     marginBottom: 10,\r\n   },\r\n+  mapview: {\r\n+    height: height\r\n+  },\r\n   inputBox: {\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1746356969169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,79 +1,30 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView\r\n+// üìç Updated Passenger HomePage - phome.tsx\r\n \r\n-import React, { useState, useEffect } from \"react\";\r\n-import {\r\n-  View,\r\n-  Text,\r\n-  StyleSheet,\r\n-  Dimensions,\r\n-  TouchableOpacity,\r\n-  StatusBar,\r\n-} from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n+import React, { useState } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar } from \"react-native\";\r\n+import MapView, { Marker } from \"react-native-maps\";\r\n+import * as Location from \"expo-location\";\r\n+import { useRouter } from \"expo-router\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import API_BASE_URL from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState(null);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const router = useRouter();\r\n \r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n+  const [destination, setDestination] = useState<{\r\n+    name: string;\r\n+    latitude: number;\r\n+    longitude: number;\r\n+  } | null>(null);\r\n \r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n-            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n-              maxZoom: 19,\r\n-              attribution: '¬© OpenStreetMap contributors'\r\n-            }).addTo(map);\r\n-\r\n-            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n-\r\n-            let destMarker = null;\r\n-            let routeLine = null;\r\n-\r\n-            map.on('click', async function(e) {\r\n-              const { lat, lng } = e.latlng;\r\n-              if (destMarker) map.removeLayer(destMarker);\r\n-              if (routeLine) map.removeLayer(routeLine);\r\n-\r\n-              destMarker = L.marker([lat, lng]).addTo(map);\r\n-\r\n-              const res = await fetch('${API_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n-              const data = await res.json();\r\n-              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-            });\r\n-          </script>\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-\r\n-    setMapHtml(html);\r\n-  }, [location]);\r\n-\r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n+        <Text style={{ fontSize: 20 }}>Loading Map=...</Text>\r\n       </View>\r\n     );\r\n   }\r\n \r\n@@ -81,55 +32,85 @@\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n-      <View style={styles.mapview}>\r\n-        {mapHtml && (\r\n-          <WebView\r\n-            originWhitelist={[\"*\"]}\r\n-            source={{ html: mapHtml }}\r\n-            javaScriptEnabled={true}\r\n-            onMessage={(event) => {\r\n-              const data = JSON.parse(event.nativeEvent.data);\r\n-              setDestination(data);\r\n-            }}\r\n-            style={StyleSheet.absoluteFillObject}\r\n+\r\n+      {/* Map */}\r\n+      <MapView\r\n+        style={StyleSheet.absoluteFillObject}\r\n+        initialRegion={{\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          latitudeDelta: 0.01,\r\n+          longitudeDelta: 0.01,\r\n+        }}\r\n+        showsUserLocation\r\n+        onPoiClick={(e) => {\r\n+          const { coordinate, name } = e.nativeEvent;\r\n+          setDestination({\r\n+            name: name,\r\n+            latitude: coordinate.latitude,\r\n+            longitude: coordinate.longitude,\r\n+          });\r\n+        }}\r\n+        onPress={(e) => {\r\n+          const { coordinate } = e.nativeEvent;\r\n+          setDestination({\r\n+            name: \"\", // No name\r\n+            latitude: coordinate.latitude,\r\n+            longitude: coordinate.longitude,\r\n+          });\r\n+        }}\r\n+      >\r\n+\r\n+        <Marker\r\n+          coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n+          title=\"You are here\"\r\n+        />\r\n+        {destination && (\r\n+          <Marker\r\n+            coordinate={{ latitude: destination.latitude, longitude: destination.longitude }}\r\n+            title={destination.name}\r\n+            pinColor=\"blue\"\r\n           />\r\n         )}\r\n-      </View>\r\n-      \r\n+        \r\n+      </MapView>\r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n \r\n+        {/* Pickup Location */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>\r\n-            {destination\r\n-              ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-              : \"Saan ka papunta ngayon?\"}\r\n+            {destination?.name || \"Saan ka papunta ngayon?\"}\r\n           </Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n+        {/* Destination (For now static, editable later if needed) */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n+        {/* Notes to Driver */}\r\n         <TouchableOpacity style={styles.inputBoxSimple}>\r\n           <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Notes sa driver</Text>\r\n         </TouchableOpacity>\r\n \r\n+        {/* Payment Method */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n+        {/* Fare and Book Now */}\r\n         <View style={styles.totalFareContainer}>\r\n           <View style={styles.fareBox}>\r\n             <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n           </View>\r\n@@ -138,8 +119,9 @@\n           </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n \r\n+      {/* Bottom Nav */}\r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity>\r\n           <Ionicons name=\"home\" size={30} color=\"black\" />\r\n           <Text>Home</Text>\r\n@@ -180,11 +162,8 @@\n     alignSelf: \"center\",\r\n     borderRadius: 5,\r\n     marginBottom: 10,\r\n   },\r\n-  mapview: {\r\n-    height: height\r\n-  },\r\n   inputBox: {\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1746356975923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,30 +1,79 @@\n-// üìç Updated Passenger HomePage - phome.tsx\r\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView\r\n \r\n-import React, { useState } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar } from \"react-native\";\r\n-import MapView, { Marker } from \"react-native-maps\";\r\n-import * as Location from \"expo-location\";\r\n-import { useRouter } from \"expo-router\";\r\n+import React, { useState, useEffect } from \"react\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  StyleSheet,\r\n+  Dimensions,\r\n+  TouchableOpacity,\r\n+  StatusBar,\r\n+} from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n+import API_BASE_URL from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const router = useRouter();\r\n+  const [destination, setDestination] = useState(null);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n \r\n-  const [destination, setDestination] = useState<{\r\n-    name: string;\r\n-    latitude: number;\r\n-    longitude: number;\r\n-  } | null>(null);\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n \r\n+    const html = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n+            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n+              maxZoom: 19,\r\n+              attribution: '¬© OpenStreetMap contributors'\r\n+            }).addTo(map);\r\n+\r\n+            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+\r\n+            let destMarker = null;\r\n+            let routeLine = null;\r\n+\r\n+            map.on('click', async function(e) {\r\n+              const { lat, lng } = e.latlng;\r\n+              if (destMarker) map.removeLayer(destMarker);\r\n+              if (routeLine) map.removeLayer(routeLine);\r\n+\r\n+              destMarker = L.marker([lat, lng]).addTo(map);\r\n+\r\n+              const res = await fetch('${API_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+              const data = await res.json();\r\n+              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+            });\r\n+          </script>\r\n+        </body>\r\n+      </html>\r\n+    `;\r\n+\r\n+    setMapHtml(html);\r\n+  }, [location]);\r\n+\r\n   if (loading || !location) {\r\n     return (\r\n       <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading Map=...</Text>\r\n+        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n       </View>\r\n     );\r\n   }\r\n \r\n@@ -33,84 +82,52 @@\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n \r\n-      {/* Map */}\r\n-      <MapView\r\n-        style={StyleSheet.absoluteFillObject}\r\n-        initialRegion={{\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          latitudeDelta: 0.01,\r\n-          longitudeDelta: 0.01,\r\n-        }}\r\n-        showsUserLocation\r\n-        onPoiClick={(e) => {\r\n-          const { coordinate, name } = e.nativeEvent;\r\n-          setDestination({\r\n-            name: name,\r\n-            latitude: coordinate.latitude,\r\n-            longitude: coordinate.longitude,\r\n-          });\r\n-        }}\r\n-        onPress={(e) => {\r\n-          const { coordinate } = e.nativeEvent;\r\n-          setDestination({\r\n-            name: \"\", // No name\r\n-            latitude: coordinate.latitude,\r\n-            longitude: coordinate.longitude,\r\n-          });\r\n-        }}\r\n-      >\r\n-\r\n-        <Marker\r\n-          coordinate={{ latitude: location.latitude, longitude: location.longitude }}\r\n-          title=\"You are here\"\r\n+      {mapHtml && (\r\n+        <WebView\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled={true}\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data);\r\n+          }}\r\n+          style={StyleSheet.absoluteFillObject}\r\n         />\r\n-        {destination && (\r\n-          <Marker\r\n-            coordinate={{ latitude: destination.latitude, longitude: destination.longitude }}\r\n-            title={destination.name}\r\n-            pinColor=\"blue\"\r\n-          />\r\n-        )}\r\n-        \r\n-      </MapView>\r\n+      )}\r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n \r\n-        {/* Pickup Location */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>\r\n-            {destination?.name || \"Saan ka papunta ngayon?\"}\r\n+            {destination\r\n+              ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+              : \"Saan ka papunta ngayon?\"}\r\n           </Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n-        {/* Destination (For now static, editable later if needed) */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n-        {/* Notes to Driver */}\r\n         <TouchableOpacity style={styles.inputBoxSimple}>\r\n           <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Notes sa driver</Text>\r\n         </TouchableOpacity>\r\n \r\n-        {/* Payment Method */}\r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n           <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n-        {/* Fare and Book Now */}\r\n         <View style={styles.totalFareContainer}>\r\n           <View style={styles.fareBox}>\r\n             <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n           </View>\r\n@@ -119,9 +136,8 @@\n           </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n \r\n-      {/* Bottom Nav */}\r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity>\r\n           <Ionicons name=\"home\" size={30} color=\"black\" />\r\n           <Text>Home</Text>\r\n"
                },
                {
                    "date": 1746356994942,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,22 +81,24 @@\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n+      <View style={styles.mapview}>\r\n+        {mapHtml && (\r\n+          <WebView\r\n+            originWhitelist={[\"*\"]}\r\n+            source={{ html: mapHtml }}\r\n+            javaScriptEnabled={true}\r\n+            onMessage={(event) => {\r\n+              const data = JSON.parse(event.nativeEvent.data);\r\n+              setDestination(data);\r\n+            }}\r\n+            style={StyleSheet.absoluteFillObject}\r\n+          />\r\n+        )}\r\n+      </View>\r\n+      \r\n \r\n-      {mapHtml && (\r\n-        <WebView\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled={true}\r\n-          onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n-          }}\r\n-          style={StyleSheet.absoluteFillObject}\r\n-        />\r\n-      )}\r\n-\r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n         <View style={styles.cardHeader} />\r\n \r\n@@ -178,8 +180,11 @@\n     alignSelf: \"center\",\r\n     borderRadius: 5,\r\n     marginBottom: 10,\r\n   },\r\n+  mapview: {\r\n+    height: height\r\n+  },\r\n   inputBox: {\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1746357233999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -36,9 +36,9 @@\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n-            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\r\n+            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1746357440809,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,13 +103,13 @@\n         <View style={styles.cardHeader} />\r\n \r\n         <TouchableOpacity style={styles.inputBox}>\r\n           <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-          <Text style={styles.inputText}>\r\n+          {/* <Text style={styles.inputText}>\r\n             {destination\r\n               ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n               : \"Saan ka papunta ngayon?\"}\r\n-          </Text>\r\n+          </Text> */}\r\n           <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n         </TouchableOpacity>\r\n \r\n         <TouchableOpacity style={styles.inputBox}>\r\n"
                },
                {
                    "date": 1746357545608,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,9 +81,9 @@\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n-      <View style={styles.mapview}>\r\n+      {/* <View style={styles.mapview}>\r\n         {mapHtml && (\r\n           <WebView\r\n             originWhitelist={[\"*\"]}\r\n             source={{ html: mapHtml }}\r\n@@ -94,9 +94,9 @@\n             }}\r\n             style={StyleSheet.absoluteFillObject}\r\n           />\r\n         )}\r\n-      </View>\r\n+      </View> */}\r\n       \r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n"
                },
                {
                    "date": 1746357568233,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,9 +81,9 @@\n     <View style={styles.container}>\r\n       <View style={{ paddingTop: 30 }}>\r\n         <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       </View>\r\n-      {/* <View style={styles.mapview}>\r\n+      <View style={styles.mapview}>\r\n         {mapHtml && (\r\n           <WebView\r\n             originWhitelist={[\"*\"]}\r\n             source={{ html: mapHtml }}\r\n@@ -94,9 +94,9 @@\n             }}\r\n             style={StyleSheet.absoluteFillObject}\r\n           />\r\n         )}\r\n-      </View> */}\r\n+      </View>\r\n       \r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.card}>\r\n@@ -161,9 +161,9 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1 },\r\n+  container: { flex: 1, height: height},\r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n"
                },
                {
                    "date": 1746357736693,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -161,9 +161,9 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, height: height},\r\n+  container: { flex: 1, height: height, backgroundColor: \"red\"},\r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n"
                },
                {
                    "date": 1746357801882,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -162,9 +162,9 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { flex: 1, height: height, backgroundColor: \"red\"},\r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\"},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746357826371,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -181,9 +181,10 @@\n     borderRadius: 5,\r\n     marginBottom: 10,\r\n   },\r\n   mapview: {\r\n-    height: height\r\n+    height: height,\r\n+    backgroundColor: \"red\",\r\n   },\r\n   inputBox: {\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n"
                },
                {
                    "date": 1746357854120,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -233,9 +233,9 @@\n     flexDirection: \"row\",\r\n     justifyContent: \"space-around\",\r\n     width: width,\r\n     height: 70,\r\n-    backgroundColor: \"white\",\r\n+    backgroundColor: \"red\",\r\n     borderTopLeftRadius: 30,\r\n     borderTopRightRadius: 30,\r\n     alignItems: \"center\",\r\n     borderWidth: 1,\r\n"
                },
                {
                    "date": 1746357859846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -233,9 +233,9 @@\n     flexDirection: \"row\",\r\n     justifyContent: \"space-around\",\r\n     width: width,\r\n     height: 70,\r\n-    backgroundColor: \"red\",\r\n+    backgroundColor: \"white\",\r\n     borderTopLeftRadius: 30,\r\n     borderTopRightRadius: 30,\r\n     alignItems: \"center\",\r\n     borderWidth: 1,\r\n"
                },
                {
                    "date": 1746357889497,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -225,9 +225,9 @@\n     padding: 5,\r\n     marginLeft: 5,\r\n     width: '50%',\r\n   },\r\n-  bookNowText: { fontSize: 16 },\r\n+  bookNowText: { fontSize: 16, backgroundColor: \"red\", },\r\n   bottomNav: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1746358051531,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,9 +91,9 @@\n             onMessage={(event) => {\r\n               const data = JSON.parse(event.nativeEvent.data);\r\n               setDestination(data);\r\n             }}\r\n-            style={StyleSheet.absoluteFillObject}\r\n+            style={{width: width, height: height}}\r\n           />\r\n         )}\r\n       </View>\r\n       \r\n@@ -225,9 +225,9 @@\n     padding: 5,\r\n     marginLeft: 5,\r\n     width: '50%',\r\n   },\r\n-  bookNowText: { fontSize: 16, backgroundColor: \"red\", },\r\n+  bookNowText: { fontSize: 16 },\r\n   bottomNav: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1746358063488,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,9 +91,9 @@\n             onMessage={(event) => {\r\n               const data = JSON.parse(event.nativeEvent.data);\r\n               setDestination(data);\r\n             }}\r\n-            style={{width: width, height: height}}\r\n+            style={{width: width, height: height - 220}}\r\n           />\r\n         )}\r\n       </View>\r\n       \r\n"
                },
                {
                    "date": 1746358344705,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -78,11 +78,10 @@\n   }\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n-      <View style={{ paddingTop: 30 }}>\r\n-        <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n-      </View>\r\n+      <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+      \r\n       <View style={styles.mapview}>\r\n         {mapHtml && (\r\n           <WebView\r\n             originWhitelist={[\"*\"]}\r\n@@ -91,73 +90,77 @@\n             onMessage={(event) => {\r\n               const data = JSON.parse(event.nativeEvent.data);\r\n               setDestination(data);\r\n             }}\r\n-            style={{width: width, height: height - 220}}\r\n+            style={{ flex: 1 }}\r\n           />\r\n         )}\r\n       </View>\r\n+\r\n       \r\n \r\n       {/* Floating Card */}\r\n-      <View style={styles.card}>\r\n-        <View style={styles.cardHeader} />\r\n+      <View style={styles.overlayContainer}>\r\n+        <View style={styles.card}>\r\n+          <View style={styles.cardHeader} />\r\n \r\n-        <TouchableOpacity style={styles.inputBox}>\r\n-          <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-          {/* <Text style={styles.inputText}>\r\n-            {destination\r\n-              ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-              : \"Saan ka papunta ngayon?\"}\r\n-          </Text> */}\r\n-          <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-        </TouchableOpacity>\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n+            <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+            {/* <Text style={styles.inputText}>\r\n+              {destination\r\n+                ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+                : \"Saan ka papunta ngayon?\"}\r\n+            </Text> */}\r\n+            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+          </TouchableOpacity>\r\n \r\n-        <TouchableOpacity style={styles.inputBox}>\r\n-          <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n-          <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n-          <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-        </TouchableOpacity>\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n+            <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n+            <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n+            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+          </TouchableOpacity>\r\n \r\n-        <TouchableOpacity style={styles.inputBoxSimple}>\r\n-          <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n-          <Text style={styles.inputText}>Notes sa driver</Text>\r\n-        </TouchableOpacity>\r\n+          <TouchableOpacity style={styles.inputBoxSimple}>\r\n+            <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n+            <Text style={styles.inputText}>Notes sa driver</Text>\r\n+          </TouchableOpacity>\r\n \r\n-        <TouchableOpacity style={styles.inputBox}>\r\n-          <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n-          <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n-          <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-        </TouchableOpacity>\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n+            <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n+            <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n+            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+          </TouchableOpacity>\r\n \r\n-        <View style={styles.totalFareContainer}>\r\n-          <View style={styles.fareBox}>\r\n-            <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+          <View style={styles.totalFareContainer}>\r\n+            <View style={styles.fareBox}>\r\n+              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+            </View>\r\n+            <TouchableOpacity style={styles.bookNowButton}>\r\n+              <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+            </TouchableOpacity>\r\n           </View>\r\n-          <TouchableOpacity style={styles.bookNowButton}>\r\n-            <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+        </View>\r\n+\r\n+        <View style={styles.bottomNav}>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+            <Text>Home</Text>\r\n           </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+            <Text>History</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+            <Text>Chats</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+            <Text>Profile</Text>\r\n+          </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n-\r\n-      <View style={styles.bottomNav}>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-          <Text>Home</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-          <Text>History</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-          <Text>Chats</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-          <Text>Profile</Text>\r\n-        </TouchableOpacity>\r\n-      </View>\r\n+      \r\n     </View>\r\n   );\r\n }\r\n \r\n"
                },
                {
                    "date": 1746358369426,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -164,9 +164,22 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, height: height, backgroundColor: \"red\"},\r\n+  container: {\r\n+    flex: 1,\r\n+    backgroundColor: \"#fff\",\r\n+  },\r\n+  mapview: {\r\n+    flex: 1,\r\n+  },\r\n+  overlayContainer: {\r\n+    position: \"absolute\",\r\n+    bottom: 0,\r\n+    width: \"100%\",\r\n+    alignItems: \"center\",\r\n+  },\r\n+  \r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\"},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n"
                },
                {
                    "date": 1746358409636,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -196,12 +196,8 @@\n     alignSelf: \"center\",\r\n     borderRadius: 5,\r\n     marginBottom: 10,\r\n   },\r\n-  mapview: {\r\n-    height: height,\r\n-    backgroundColor: \"red\",\r\n-  },\r\n   inputBox: {\r\n     backgroundColor: \"white\",\r\n     borderRadius: 8,\r\n     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1746358419449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -139,9 +139,9 @@\n             </TouchableOpacity>\r\n           </View>\r\n         </View>\r\n \r\n-        <View style={styles.bottomNav}>\r\n+        {/* <View style={styles.bottomNav}>\r\n           <TouchableOpacity>\r\n             <Ionicons name=\"home\" size={30} color=\"black\" />\r\n             <Text>Home</Text>\r\n           </TouchableOpacity>\r\n@@ -156,9 +156,9 @@\n           <TouchableOpacity>\r\n             <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n             <Text>Profile</Text>\r\n           </TouchableOpacity>\r\n-        </View>\r\n+        </View> */}\r\n       </View>\r\n       \r\n     </View>\r\n   );\r\n"
                },
                {
                    "date": 1746358506403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -99,10 +99,10 @@\n       \r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.overlayContainer}>\r\n-        <View style={styles.card}>\r\n-          <View style={styles.cardHeader} />\r\n+        {/* <View style={styles.card}>\r\n+          <View style={styles.cardHeader} /> */}\r\n \r\n           <TouchableOpacity style={styles.inputBox}>\r\n             <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n             {/* <Text style={styles.inputText}>\r\n@@ -112,9 +112,9 @@\n             </Text> */}\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n           </TouchableOpacity>\r\n \r\n-          <TouchableOpacity style={styles.inputBox}>\r\n+          {/* <TouchableOpacity style={styles.inputBox}>\r\n             <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n             <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n           </TouchableOpacity>\r\n@@ -137,9 +137,9 @@\n             <TouchableOpacity style={styles.bookNowButton}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n           </View>\r\n-        </View>\r\n+        </View> */}\r\n \r\n         {/* <View style={styles.bottomNav}>\r\n           <TouchableOpacity>\r\n             <Ionicons name=\"home\" size={30} color=\"black\" />\r\n"
                },
                {
                    "date": 1746358517861,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -102,17 +102,17 @@\n       <View style={styles.overlayContainer}>\r\n         {/* <View style={styles.card}>\r\n           <View style={styles.cardHeader} /> */}\r\n \r\n-          <TouchableOpacity style={styles.inputBox}>\r\n+          {/* <TouchableOpacity style={styles.inputBox}>\r\n             <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-            {/* <Text style={styles.inputText}>\r\n+            <Text style={styles.inputText}>\r\n               {destination\r\n                 ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n                 : \"Saan ka papunta ngayon?\"}\r\n-            </Text> */}\r\n+            </Text>\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity>\r\n+          </TouchableOpacity> */}\r\n \r\n           {/* <TouchableOpacity style={styles.inputBox}>\r\n             <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n             <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n"
                },
                {
                    "date": 1746358920046,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -80,22 +80,20 @@\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n-      <View style={styles.mapview}>\r\n-        {mapHtml && (\r\n-          <WebView\r\n-            originWhitelist={[\"*\"]}\r\n-            source={{ html: mapHtml }}\r\n-            javaScriptEnabled={true}\r\n-            onMessage={(event) => {\r\n-              const data = JSON.parse(event.nativeEvent.data);\r\n-              setDestination(data);\r\n-            }}\r\n-            style={{ flex: 1 }}\r\n-          />\r\n-        )}\r\n-      </View>\r\n+      {mapHtml && (\r\n+        <WebView\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled={true}\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data);\r\n+          }}\r\n+          style={StyleSheet.absoluteFillObject}\r\n+        />\r\n+      )}\r\n \r\n       \r\n \r\n       {/* Floating Card */}\r\n"
                },
                {
                    "date": 1746358938788,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -164,18 +164,16 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {\r\n     flex: 1,\r\n-    backgroundColor: \"#fff\",\r\n+    position: 'relative',\r\n   },\r\n-  mapview: {\r\n-    flex: 1,\r\n-  },\r\n   overlayContainer: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n+    zIndex: 10,\r\n   },\r\n   \r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\"},\r\n   card: {\r\n"
                },
                {
                    "date": 1746359019325,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,9 @@\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import API_BASE_URL from \"../../config\";\r\n+import { SafeAreaView } from \"react-native-safe-area-context\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1746359043400,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,17 +85,22 @@\n       {mapHtml && (\r\n         <WebView\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n-          javaScriptEnabled={true}\r\n+          javaScriptEnabled\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n             setDestination(data);\r\n           }}\r\n           style={StyleSheet.absoluteFillObject}\r\n         />\r\n       )}\r\n \r\n+      {/* Overlay content above the map */}\r\n+      <SafeAreaView style={styles.overlayContainer}>\r\n+        {/* cards, buttons, nav, etc. */}\r\n+      </SafeAreaView>\r\n+\r\n       \r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.overlayContainer}>\r\n"
                },
                {
                    "date": 1746359060083,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -94,13 +94,8 @@\n           style={StyleSheet.absoluteFillObject}\r\n         />\r\n       )}\r\n \r\n-      {/* Overlay content above the map */}\r\n-      <SafeAreaView style={styles.overlayContainer}>\r\n-        {/* cards, buttons, nav, etc. */}\r\n-      </SafeAreaView>\r\n-\r\n       \r\n \r\n       {/* Floating Card */}\r\n       <View style={styles.overlayContainer}>\r\n"
                },
                {
                    "date": 1746359083410,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -97,9 +97,9 @@\n \r\n       \r\n \r\n       {/* Floating Card */}\r\n-      <View style={styles.overlayContainer}>\r\n+      <SafeAreaView style={styles.overlayContainer}>\r\n         {/* <View style={styles.card}>\r\n           <View style={styles.cardHeader} /> */}\r\n \r\n           {/* <TouchableOpacity style={styles.inputBox}>\r\n@@ -156,9 +156,9 @@\n             <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n             <Text>Profile</Text>\r\n           </TouchableOpacity>\r\n         </View> */}\r\n-      </View>\r\n+      </SafeAreaView>\r\n       \r\n     </View>\r\n   );\r\n }\r\n"
                },
                {
                    "date": 1746359328941,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -98,22 +98,22 @@\n       \r\n \r\n       {/* Floating Card */}\r\n       <SafeAreaView style={styles.overlayContainer}>\r\n-        {/* <View style={styles.card}>\r\n-          <View style={styles.cardHeader} /> */}\r\n+        <View style={styles.card}>\r\n+          <View style={styles.cardHeader} />\r\n \r\n-          {/* <TouchableOpacity style={styles.inputBox}>\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n             <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>\r\n+            {/* <Text style={styles.inputText}>\r\n               {destination\r\n                 ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n                 : \"Saan ka papunta ngayon?\"}\r\n-            </Text>\r\n+            </Text> */}\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity> */}\r\n+          </TouchableOpacity>\r\n \r\n-          {/* <TouchableOpacity style={styles.inputBox}>\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n             <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n             <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n           </TouchableOpacity>\r\n@@ -136,11 +136,11 @@\n             <TouchableOpacity style={styles.bookNowButton}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n           </View>\r\n-        </View> */}\r\n+        </View>\r\n \r\n-        {/* <View style={styles.bottomNav}>\r\n+        <View style={styles.bottomNav}>\r\n           <TouchableOpacity>\r\n             <Ionicons name=\"home\" size={30} color=\"black\" />\r\n             <Text>Home</Text>\r\n           </TouchableOpacity>\r\n@@ -155,9 +155,9 @@\n           <TouchableOpacity>\r\n             <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n             <Text>Profile</Text>\r\n           </TouchableOpacity>\r\n-        </View> */}\r\n+        </View>\r\n       </SafeAreaView>\r\n       \r\n     </View>\r\n   );\r\n"
                },
                {
                    "date": 1746359421638,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,21 +81,26 @@\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n-      {mapHtml && (\r\n+      {mapHtml ? (\r\n         <WebView\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n+            try {\r\n+              const data = JSON.parse(event.nativeEvent.data);\r\n+              setDestination(data);\r\n+            } catch (e) {\r\n+              console.error(\"Invalid map data\", e);\r\n+            }\r\n           }}\r\n-          style={StyleSheet.absoluteFillObject}\r\n+          style={{ flex: 1 }}\r\n         />\r\n-      )}\r\n+      ) : null}\r\n \r\n+\r\n       \r\n \r\n       {/* Floating Card */}\r\n       <SafeAreaView style={styles.overlayContainer}>\r\n"
                },
                {
                    "date": 1746359506220,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,8 +182,9 @@\n   },\r\n   \r\n   loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\"},\r\n   card: {\r\n+    height: height\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n     width: width * 0.95,\r\n"
                },
                {
                    "date": 1746359526182,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -180,11 +180,10 @@\n     alignItems: \"center\",\r\n     zIndex: 10,\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\"},\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\", height: height,},\r\n   card: {\r\n-    height: height\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n     width: width * 0.95,\r\n"
                },
                {
                    "date": 1746359598460,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,9 +12,8 @@\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import API_BASE_URL from \"../../config\";\r\n-import { SafeAreaView } from \"react-native-safe-area-context\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n@@ -81,30 +80,27 @@\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n-      {mapHtml ? (\r\n-        <WebView\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled\r\n-          onMessage={(event) => {\r\n-            try {\r\n+      <View style={styles.mapview}>\r\n+        {mapHtml && (\r\n+          <WebView\r\n+            originWhitelist={[\"*\"]}\r\n+            source={{ html: mapHtml }}\r\n+            javaScriptEnabled={true}\r\n+            onMessage={(event) => {\r\n               const data = JSON.parse(event.nativeEvent.data);\r\n               setDestination(data);\r\n-            } catch (e) {\r\n-              console.error(\"Invalid map data\", e);\r\n-            }\r\n-          }}\r\n-          style={{ flex: 1 }}\r\n-        />\r\n-      ) : null}\r\n+            }}\r\n+            style={{ flex: 1 }}\r\n+          />\r\n+        )}\r\n+      </View>\r\n \r\n-\r\n       \r\n \r\n       {/* Floating Card */}\r\n-      <SafeAreaView style={styles.overlayContainer}>\r\n+      <View style={styles.overlayContainer}>\r\n         <View style={styles.card}>\r\n           <View style={styles.cardHeader} />\r\n \r\n           <TouchableOpacity style={styles.inputBox}>\r\n@@ -161,28 +157,30 @@\n             <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n             <Text>Profile</Text>\r\n           </TouchableOpacity>\r\n         </View>\r\n-      </SafeAreaView>\r\n+      </View>\r\n       \r\n     </View>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: {\r\n     flex: 1,\r\n-    position: 'relative',\r\n+    backgroundColor: \"#fff\",\r\n   },\r\n+  mapview: {\r\n+    flex: 1,\r\n+  },\r\n   overlayContainer: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n-    zIndex: 10,\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\", height: height,},\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\", height: height},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746359615212,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -178,9 +178,9 @@\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", backgroundColor: \"red\", height: height},\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", height: height},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746359639957,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -178,9 +178,9 @@\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", height: height},\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\"},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746359648036,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -178,9 +178,9 @@\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\"},\r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\",height: height},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746359750988,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,16 +68,8 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  if (loading || !location) {\r\n-    return (\r\n-      <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n-      </View>\r\n-    );\r\n-  }\r\n-\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n@@ -178,9 +170,8 @@\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\",height: height},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746359806238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -72,22 +72,20 @@\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n-      <View style={styles.mapview}>\r\n-        {mapHtml && (\r\n-          <WebView\r\n-            originWhitelist={[\"*\"]}\r\n-            source={{ html: mapHtml }}\r\n-            javaScriptEnabled={true}\r\n-            onMessage={(event) => {\r\n-              const data = JSON.parse(event.nativeEvent.data);\r\n-              setDestination(data);\r\n-            }}\r\n-            style={{ flex: 1 }}\r\n-          />\r\n-        )}\r\n-      </View>\r\n+      {mapHtml && (\r\n+        <WebView\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data);\r\n+          }}\r\n+          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+        />\r\n+      )}\r\n \r\n       \r\n \r\n       {/* Floating Card */}\r\n"
                },
                {
                    "date": 1746359832318,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,11 +158,8 @@\n   container: {\r\n     flex: 1,\r\n     backgroundColor: \"#fff\",\r\n   },\r\n-  mapview: {\r\n-    flex: 1,\r\n-  },\r\n   overlayContainer: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     width: \"100%\",\r\n"
                },
                {
                    "date": 1746359869314,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,24 +68,34 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n+  if (loading || !location) {\r\n+    return (\r\n+      <View style={styles.loadingContainer}>\r\n+        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n-      {mapHtml && (\r\n-        <WebView\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled\r\n-          onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n-          }}\r\n-          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-        />\r\n-      )}\r\n+      <View style={styles.mapview}>\r\n+        {mapHtml && (\r\n+          <WebView\r\n+            originWhitelist={[\"*\"]}\r\n+            source={{ html: mapHtml }}\r\n+            javaScriptEnabled={true}\r\n+            onMessage={(event) => {\r\n+              const data = JSON.parse(event.nativeEvent.data);\r\n+              setDestination(data);\r\n+            }}\r\n+            style={{ flex: 1 }}\r\n+          />\r\n+        )}\r\n+      </View>\r\n \r\n       \r\n \r\n       {/* Floating Card */}\r\n@@ -158,15 +168,19 @@\n   container: {\r\n     flex: 1,\r\n     backgroundColor: \"#fff\",\r\n   },\r\n+  mapview: {\r\n+    flex: 1,\r\n+  },\r\n   overlayContainer: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n   \r\n+  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\",height: height},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746359911422,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,34 +68,24 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  if (loading || !location) {\r\n-    return (\r\n-      <View style={styles.loadingContainer}>\r\n-        <Text style={{ fontSize: 20 }}>Loading Map...</Text>\r\n-      </View>\r\n-    );\r\n-  }\r\n-\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n       \r\n-      <View style={styles.mapview}>\r\n-        {mapHtml && (\r\n-          <WebView\r\n-            originWhitelist={[\"*\"]}\r\n-            source={{ html: mapHtml }}\r\n-            javaScriptEnabled={true}\r\n-            onMessage={(event) => {\r\n-              const data = JSON.parse(event.nativeEvent.data);\r\n-              setDestination(data);\r\n-            }}\r\n-            style={{ flex: 1 }}\r\n-          />\r\n-        )}\r\n-      </View>\r\n+      {mapHtml && (\r\n+        <WebView\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data);\r\n+          }}\r\n+          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+        />\r\n+      )}\r\n \r\n       \r\n \r\n       {/* Floating Card */}\r\n@@ -168,19 +158,15 @@\n   container: {\r\n     flex: 1,\r\n     backgroundColor: \"#fff\",\r\n   },\r\n-  mapview: {\r\n-    flex: 1,\r\n-  },\r\n   overlayContainer: {\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n   \r\n-  loadingContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\",height: height},\r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746360057315,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -94,13 +94,13 @@\n           <View style={styles.cardHeader} />\r\n \r\n           <TouchableOpacity style={styles.inputBox}>\r\n             <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-            {/* <Text style={styles.inputText}>\r\n+            <Text style={styles.inputText}>\r\n               {destination\r\n                 ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n                 : \"Saan ka papunta ngayon?\"}\r\n-            </Text> */}\r\n+            </Text>\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n           </TouchableOpacity>\r\n \r\n           <TouchableOpacity style={styles.inputBox}>\r\n"
                },
                {
                    "date": 1746360633537,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView\r\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label\r\n \r\n import React, { useState, useEffect } from \"react\";\r\n import {\r\n   View,\r\n@@ -7,8 +7,9 @@\n   StyleSheet,\r\n   Dimensions,\r\n   TouchableOpacity,\r\n   StatusBar,\r\n+  TextInput,\r\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n@@ -18,8 +19,9 @@\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n@@ -71,9 +73,9 @@\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n-      \r\n+\r\n       {mapHtml && (\r\n         <WebView\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n@@ -85,11 +87,8 @@\n           style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n         />\r\n       )}\r\n \r\n-      \r\n-\r\n-      {/* Floating Card */}\r\n       <View style={styles.overlayContainer}>\r\n         <View style={styles.card}>\r\n           <View style={styles.cardHeader} />\r\n \r\n@@ -102,13 +101,14 @@\n             </Text>\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n           </TouchableOpacity>\r\n \r\n-          <TouchableOpacity style={styles.inputBox}>\r\n-            <MaterialIcons name=\"swap-vert\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>Saan ka ihahatid?</Text>\r\n-            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity>\r\n+          <TextInput\r\n+            style={styles.inputBoxSimple}\r\n+            placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+            value={destinationLabel}\r\n+            onChangeText={setDestinationLabel}\r\n+          />\r\n \r\n           <TouchableOpacity style={styles.inputBoxSimple}>\r\n             <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n             <Text style={styles.inputText}>Notes sa driver</Text>\r\n@@ -148,9 +148,8 @@\n             <Text>Profile</Text>\r\n           </TouchableOpacity>\r\n         </View>\r\n       </View>\r\n-      \r\n     </View>\r\n   );\r\n }\r\n \r\n@@ -164,9 +163,8 @@\n     bottom: 0,\r\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n   },\r\n-  \r\n   card: {\r\n     position: \"absolute\",\r\n     bottom: 75,\r\n     backgroundColor: \"#81C3E1\",\r\n"
                },
                {
                    "date": 1746361085621,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -13,8 +13,9 @@\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import API_BASE_URL from \"../../config\";\r\n+import OSRM_BASE_URL from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1746361115298,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,9 +56,9 @@\n               if (routeLine) map.removeLayer(routeLine);\r\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n-              const res = await fetch('${API_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+              const res = await fetch(`${OSRM_BASE_URL}/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?geometries=geojson`);\r\n               const data = await res.json();\r\n               const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n               routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1746361238631,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,9 +56,9 @@\n               if (routeLine) map.removeLayer(routeLine);\r\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n-              const res = await fetch(`${OSRM_BASE_URL}/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?geometries=geojson`);\r\n+              const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n               const data = await res.json();\r\n               const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n               routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1746361947047,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,10 +12,10 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import API_BASE_URL from \"../../config\";\r\n-import OSRM_BASE_URL from \"../../config\";\r\n+import {API_BASE_URL} from \"../../config\";\r\n+import {OSRM_BASE_URL} from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n@@ -57,8 +57,9 @@\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n               const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+              console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n               const data = await res.json();\r\n               const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n               routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1746361964609,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,8 +22,9 @@\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n+  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n@@ -57,9 +58,8 @@\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n               const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n-              console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n               const data = await res.json();\r\n               const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n               routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1746362001962,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,9 +23,8 @@\n   const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n-\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n"
                },
                {
                    "date": 1746362012233,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,9 +12,8 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import {API_BASE_URL} from \"../../config\";\r\n import {OSRM_BASE_URL} from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n"
                },
                {
                    "date": 1746362676423,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label\r\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Route on BOOK NOW\r\n \r\n import React, { useState, useEffect } from \"react\";\r\n import {\r\n   View,\r\n@@ -12,18 +12,20 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import {OSRM_BASE_URL} from \"../../config\";\r\n+import { OSRM_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [mapRef, setMapRef] = useState(null);\r\n+\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -48,36 +50,51 @@\n \r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n-            map.on('click', async function(e) {\r\n+            map.on('click', function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n-\r\n-              const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n-              const data = await res.json();\r\n-              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n+\r\n+            window.addEventListener('message', async function(event) {\r\n+              const msg = JSON.parse(event.data);\r\n+              if (msg.type === 'drawRoute' && msg.destination) {\r\n+                const { latitude, longitude } = msg.destination;\r\n+                const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n+                const data = await res.json();\r\n+                const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+                if (routeLine) map.removeLayer(routeLine);\r\n+                routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+              }\r\n+            });\r\n           </script>\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n+  const handleBookNow = () => {\r\n+    if (destination && mapRef) {\r\n+      mapRef.postMessage(\r\n+        JSON.stringify({ type: \"drawRoute\", destination })\r\n+      );\r\n+    }\r\n+  };\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n       {mapHtml && (\r\n         <WebView\r\n+          ref={(ref) => setMapRef(ref)}\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n@@ -123,9 +140,9 @@\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n               <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n             </View>\r\n-            <TouchableOpacity style={styles.bookNowButton}>\r\n+            <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n           </View>\r\n         </View>\r\n"
                },
                {
                    "date": 1746362698540,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Route on BOOK NOW\r\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label\r\n \r\n import React, { useState, useEffect } from \"react\";\r\n import {\r\n   View,\r\n@@ -12,20 +12,18 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import { OSRM_BASE_URL } from \"../../config\";\r\n+import {OSRM_BASE_URL} from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [mapRef, setMapRef] = useState(null);\r\n-\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-\r\n+  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -50,51 +48,36 @@\n \r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n-            map.on('click', function(e) {\r\n+            map.on('click', async function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n+\r\n+              const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+              const data = await res.json();\r\n+              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n-\r\n-            window.addEventListener('message', async function(event) {\r\n-              const msg = JSON.parse(event.data);\r\n-              if (msg.type === 'drawRoute' && msg.destination) {\r\n-                const { latitude, longitude } = msg.destination;\r\n-                const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n-                const data = await res.json();\r\n-                const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-                if (routeLine) map.removeLayer(routeLine);\r\n-                routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-              }\r\n-            });\r\n           </script>\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = () => {\r\n-    if (destination && mapRef) {\r\n-      mapRef.postMessage(\r\n-        JSON.stringify({ type: \"drawRoute\", destination })\r\n-      );\r\n-    }\r\n-  };\r\n-\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n       {mapHtml && (\r\n         <WebView\r\n-          ref={(ref) => setMapRef(ref)}\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n@@ -140,9 +123,9 @@\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n               <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n             </View>\r\n-            <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n+            <TouchableOpacity style={styles.bookNowButton}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n           </View>\r\n         </View>\r\n"
                },
                {
                    "date": 1746362725857,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,9 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n+import {API_BASE_URL} from \"../../config\";\r\n import {OSRM_BASE_URL} from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n"
                },
                {
                    "date": 1746364002875,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,244 @@\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label\r\n+\r\n+import React, { useState, useEffect } from \"react\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  StyleSheet,\r\n+  Dimensions,\r\n+  TouchableOpacity,\r\n+  StatusBar,\r\n+  TextInput,\r\n+} from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import {API_BASE_URL} from \"../../config\";\r\n+import {OSRM_BASE_URL} from \"../../config\";\r\n+\r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const [mapRef, setMapRef] = useState(null);\r\n+\r\n+  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n+  \r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n+\r\n+    const html = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n+            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+              maxZoom: 19,\r\n+              attribution: '¬© OpenStreetMap contributors'\r\n+            }).addTo(map);\r\n+\r\n+            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+\r\n+            let destMarker = null;\r\n+            let routeLine = null;\r\n+\r\n+            map.on('click', async function(e) {\r\n+              const { lat, lng } = e.latlng;\r\n+              if (destMarker) map.removeLayer(destMarker);\r\n+              if (routeLine) map.removeLayer(routeLine);\r\n+\r\n+              destMarker = L.marker([lat, lng]).addTo(map);\r\n+\r\n+              const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+              const data = await res.json();\r\n+              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+            });\r\n+          </script>\r\n+        </body>\r\n+      </html>\r\n+    `;\r\n+\r\n+    setMapHtml(html);\r\n+  }, [location]);\r\n+\r\n+  return (\r\n+    <View style={styles.container}>\r\n+      <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+\r\n+      {mapHtml && (\r\n+        <WebView\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data);\r\n+          }}\r\n+          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+        />\r\n+      )}\r\n+\r\n+      <View style={styles.overlayContainer}>\r\n+        <View style={styles.card}>\r\n+          <View style={styles.cardHeader} />\r\n+\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n+            <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+            <Text style={styles.inputText}>\r\n+              {destination && destination.latitude && destination.longitude\r\n+                ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+                : \"Saan ka papunta ngayon?\"}\r\n+            </Text>\r\n+            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+          </TouchableOpacity>\r\n+\r\n+          <TextInput\r\n+            style={styles.inputBoxSimple}\r\n+            placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+            value={destinationLabel}\r\n+            onChangeText={setDestinationLabel}\r\n+          />\r\n+\r\n+          <TouchableOpacity style={styles.inputBoxSimple}>\r\n+            <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n+            <Text style={styles.inputText}>Notes sa driver</Text>\r\n+          </TouchableOpacity>\r\n+\r\n+          <TouchableOpacity style={styles.inputBox}>\r\n+            <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n+            <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n+            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+          </TouchableOpacity>\r\n+\r\n+          <View style={styles.totalFareContainer}>\r\n+            <View style={styles.fareBox}>\r\n+              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+            </View>\r\n+            <TouchableOpacity style={styles.bookNowButton}>\r\n+              <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+            </TouchableOpacity>\r\n+          </View>\r\n+        </View>\r\n+\r\n+        <View style={styles.bottomNav}>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+            <Text>Home</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+            <Text>History</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+            <Text>Chats</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+            <Text>Profile</Text>\r\n+          </TouchableOpacity>\r\n+        </View>\r\n+      </View>\r\n+    </View>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: {\r\n+    flex: 1,\r\n+    backgroundColor: \"#fff\",\r\n+  },\r\n+  overlayContainer: {\r\n+    position: \"absolute\",\r\n+    bottom: 0,\r\n+    width: \"100%\",\r\n+    alignItems: \"center\",\r\n+  },\r\n+  card: {\r\n+    position: \"absolute\",\r\n+    bottom: 75,\r\n+    backgroundColor: \"#81C3E1\",\r\n+    width: width * 0.95,\r\n+    alignSelf: \"center\",\r\n+    borderRadius: 10,\r\n+    padding: 10,\r\n+  },\r\n+  cardHeader: {\r\n+    width: 150,\r\n+    height: 4,\r\n+    backgroundColor: \"black\",\r\n+    alignSelf: \"center\",\r\n+    borderRadius: 5,\r\n+    marginBottom: 10,\r\n+  },\r\n+  inputBox: {\r\n+    backgroundColor: \"white\",\r\n+    borderRadius: 8,\r\n+    flexDirection: \"row\",\r\n+    alignItems: \"center\",\r\n+    justifyContent: \"space-between\",\r\n+    paddingHorizontal: 10,\r\n+    height: 40,\r\n+    marginBottom: 5,\r\n+  },\r\n+  inputBoxSimple: {\r\n+    backgroundColor: \"white\",\r\n+    borderRadius: 8,\r\n+    flexDirection: \"row\",\r\n+    alignItems: \"center\",\r\n+    paddingHorizontal: 10,\r\n+    height: 40,\r\n+    marginBottom: 5,\r\n+  },\r\n+  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n+  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n+  fareBox: {\r\n+    flex: 1,\r\n+    borderRadius: 3,\r\n+    backgroundColor: \"white\",\r\n+    justifyContent: \"center\",\r\n+    paddingHorizontal: 5,\r\n+    marginRight: 5,\r\n+    width: '50%',\r\n+  },\r\n+  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n+  bookNowButton: {\r\n+    flex: 1,\r\n+    backgroundColor: \"white\",\r\n+    borderRadius: 8,\r\n+    alignItems: \"center\",\r\n+    justifyContent: \"center\",\r\n+    padding: 5,\r\n+    marginLeft: 5,\r\n+    width: '50%',\r\n+  },\r\n+  bookNowText: { fontSize: 16 },\r\n+  bottomNav: {\r\n+    position: \"absolute\",\r\n+    bottom: 0,\r\n+    flexDirection: \"row\",\r\n+    justifyContent: \"space-around\",\r\n+    width: width,\r\n+    height: 70,\r\n+    backgroundColor: \"white\",\r\n+    borderTopLeftRadius: 30,\r\n+    borderTopRightRadius: 30,\r\n+    alignItems: \"center\",\r\n+    borderWidth: 1,\r\n+    borderColor: \"black\",\r\n+  },\r\n+});\r\n"
                },
                {
                    "date": 1746364020247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -80,8 +80,9 @@\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n       {mapHtml && (\r\n         <WebView\r\n+          ref={(ref) => setMapRef(ref)}\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n@@ -241,245 +242,4 @@\n     borderWidth: 1,\r\n     borderColor: \"black\",\r\n   },\r\n });\r\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label\r\n-\r\n-import React, { useState, useEffect } from \"react\";\r\n-import {\r\n-  View,\r\n-  Text,\r\n-  StyleSheet,\r\n-  Dimensions,\r\n-  TouchableOpacity,\r\n-  StatusBar,\r\n-  TextInput,\r\n-} from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import {API_BASE_URL} from \"../../config\";\r\n-import {OSRM_BASE_URL} from \"../../config\";\r\n-\r\n-const { width, height } = Dimensions.get(\"window\");\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n-\r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n-            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-              maxZoom: 19,\r\n-              attribution: '¬© OpenStreetMap contributors'\r\n-            }).addTo(map);\r\n-\r\n-            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n-\r\n-            let destMarker = null;\r\n-            let routeLine = null;\r\n-\r\n-            map.on('click', async function(e) {\r\n-              const { lat, lng } = e.latlng;\r\n-              if (destMarker) map.removeLayer(destMarker);\r\n-              if (routeLine) map.removeLayer(routeLine);\r\n-\r\n-              destMarker = L.marker([lat, lng]).addTo(map);\r\n-\r\n-              const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n-              const data = await res.json();\r\n-              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-            });\r\n-          </script>\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-\r\n-    setMapHtml(html);\r\n-  }, [location]);\r\n-\r\n-  return (\r\n-    <View style={styles.container}>\r\n-      <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n-\r\n-      {mapHtml && (\r\n-        <WebView\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled\r\n-          onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n-          }}\r\n-          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-        />\r\n-      )}\r\n-\r\n-      <View style={styles.overlayContainer}>\r\n-        <View style={styles.card}>\r\n-          <View style={styles.cardHeader} />\r\n-\r\n-          <TouchableOpacity style={styles.inputBox}>\r\n-            <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>\r\n-              {destination\r\n-                ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-                : \"Saan ka papunta ngayon?\"}\r\n-            </Text>\r\n-            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity>\r\n-\r\n-          <TextInput\r\n-            style={styles.inputBoxSimple}\r\n-            placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-            value={destinationLabel}\r\n-            onChangeText={setDestinationLabel}\r\n-          />\r\n-\r\n-          <TouchableOpacity style={styles.inputBoxSimple}>\r\n-            <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>Notes sa driver</Text>\r\n-          </TouchableOpacity>\r\n-\r\n-          <TouchableOpacity style={styles.inputBox}>\r\n-            <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n-            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity>\r\n-\r\n-          <View style={styles.totalFareContainer}>\r\n-            <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n-            </View>\r\n-            <TouchableOpacity style={styles.bookNowButton}>\r\n-              <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n-            </TouchableOpacity>\r\n-          </View>\r\n-        </View>\r\n-\r\n-        <View style={styles.bottomNav}>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-            <Text>Home</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-            <Text>History</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-            <Text>Chats</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-            <Text>Profile</Text>\r\n-          </TouchableOpacity>\r\n-        </View>\r\n-      </View>\r\n-    </View>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: {\r\n-    flex: 1,\r\n-    backgroundColor: \"#fff\",\r\n-  },\r\n-  overlayContainer: {\r\n-    position: \"absolute\",\r\n-    bottom: 0,\r\n-    width: \"100%\",\r\n-    alignItems: \"center\",\r\n-  },\r\n-  card: {\r\n-    position: \"absolute\",\r\n-    bottom: 75,\r\n-    backgroundColor: \"#81C3E1\",\r\n-    width: width * 0.95,\r\n-    alignSelf: \"center\",\r\n-    borderRadius: 10,\r\n-    padding: 10,\r\n-  },\r\n-  cardHeader: {\r\n-    width: 150,\r\n-    height: 4,\r\n-    backgroundColor: \"black\",\r\n-    alignSelf: \"center\",\r\n-    borderRadius: 5,\r\n-    marginBottom: 10,\r\n-  },\r\n-  inputBox: {\r\n-    backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n-    flexDirection: \"row\",\r\n-    alignItems: \"center\",\r\n-    justifyContent: \"space-between\",\r\n-    paddingHorizontal: 10,\r\n-    height: 40,\r\n-    marginBottom: 5,\r\n-  },\r\n-  inputBoxSimple: {\r\n-    backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n-    flexDirection: \"row\",\r\n-    alignItems: \"center\",\r\n-    paddingHorizontal: 10,\r\n-    height: 40,\r\n-    marginBottom: 5,\r\n-  },\r\n-  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n-  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n-  fareBox: {\r\n-    flex: 1,\r\n-    borderRadius: 3,\r\n-    backgroundColor: \"white\",\r\n-    justifyContent: \"center\",\r\n-    paddingHorizontal: 5,\r\n-    marginRight: 5,\r\n-    width: '50%',\r\n-  },\r\n-  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n-  bookNowButton: {\r\n-    flex: 1,\r\n-    backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n-    alignItems: \"center\",\r\n-    justifyContent: \"center\",\r\n-    padding: 5,\r\n-    marginLeft: 5,\r\n-    width: '50%',\r\n-  },\r\n-  bookNowText: { fontSize: 16 },\r\n-  bottomNav: {\r\n-    position: \"absolute\",\r\n-    bottom: 0,\r\n-    flexDirection: \"row\",\r\n-    justifyContent: \"space-around\",\r\n-    width: width,\r\n-    height: 70,\r\n-    backgroundColor: \"white\",\r\n-    borderTopLeftRadius: 30,\r\n-    borderTopRightRadius: 30,\r\n-    alignItems: \"center\",\r\n-    borderWidth: 1,\r\n-    borderColor: \"black\",\r\n-  },\r\n-});\r\n"
                },
                {
                    "date": 1746364062383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -73,8 +73,18 @@\n     `;\r\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n+  const handleBookNow = () => {\r\n+    if (destination && mapRef) {\r\n+      mapRef.postMessage(\r\n+        JSON.stringify({\r\n+          type: \"drawRoute\",\r\n+          destination: destination\r\n+        })\r\n+      );\r\n+    }\r\n+  };\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1746365774070,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,5 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label\r\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Route on BOOK NOW\r\n \r\n import React, { useState, useEffect } from \"react\";\r\n import {\r\n   View,\r\n@@ -12,22 +12,19 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import {API_BASE_URL} from \"../../config\";\r\n-import {OSRM_BASE_URL} from \"../../config\";\r\n+import { API_BASE_URL, OSRM_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [mapRef, setMapRef] = useState(null);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const [mapRef, setMapRef] = useState(null);\r\n \r\n-  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n-  \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -52,36 +49,40 @@\n \r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n-            map.on('click', async function(e) {\r\n+            map.on('click', function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n-\r\n-              const res = await fetch('` + OSRM_BASE_URL + `/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n-              const data = await res.json();\r\n-              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n+\r\n+            window.addEventListener('message', async function(event) {\r\n+              const msg = JSON.parse(event.data);\r\n+              if (msg.type === 'drawRoute' && msg.destination) {\r\n+                const { latitude, longitude } = msg.destination;\r\n+                const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n+                const data = await res.json();\r\n+                const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+                if (routeLine) map.removeLayer(routeLine);\r\n+                routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+              }\r\n+            });\r\n           </script>\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n+\r\n   const handleBookNow = () => {\r\n     if (destination && mapRef) {\r\n       mapRef.postMessage(\r\n-        JSON.stringify({\r\n-          type: \"drawRoute\",\r\n-          destination: destination\r\n-        })\r\n+        JSON.stringify({ type: \"drawRoute\", destination })\r\n       );\r\n     }\r\n   };\r\n \r\n@@ -138,9 +139,9 @@\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n               <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n             </View>\r\n-            <TouchableOpacity style={styles.bookNowButton}>\r\n+            <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n           </View>\r\n         </View>\r\n"
                },
                {
                    "date": 1746366081733,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,18 +12,18 @@\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import { API_BASE_URL, OSRM_BASE_URL } from \"../../config\";\r\n+import { OSRM_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n   const [mapRef, setMapRef] = useState(null);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n@@ -53,9 +53,8 @@\n             map.on('click', function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n-\r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n"
                },
                {
                    "date": 1746366337064,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,9 @@\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState(null);\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const [mapRef, setMapRef] = useState(null);\r\n \r\n"
                },
                {
                    "date": 1746366401477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,10 @@\n   TouchableOpacity,\r\n   StatusBar,\r\n   TextInput,\r\n } from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n+import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL } from \"../../config\";\r\n \r\n"
                },
                {
                    "date": 1746366418260,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,9 +22,9 @@\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const [mapRef, setMapRef] = useState(null);\r\n+  const [mapRef, setMapRef] = useState<WebViewType | null>(null);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n"
                },
                {
                    "date": 1746366679485,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,9 +91,11 @@\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n       {mapHtml && (\r\n         <WebView\r\n-          ref={(ref) => setMapRef(ref)}\r\n+          ref={(ref) => {\r\n+            if (ref && !mapRef) setMapRef(ref);\r\n+          }}\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n"
                },
                {
                    "date": 1746366914149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,8 +51,23 @@\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n             map.on('click', function(e) {\r\n+              try {\r\n+              const res = await fetch('http://${OSRM_BASE_URL}/route/v1/driving/...');\r\n+              const data = await res.json();\r\n+\r\n+              if (data.code !== \"Ok\" || !data.routes || data.routes.length === 0) {\r\n+                alert(\"OSRM: No route found.\");\r\n+                return;\r\n+              }\r\n+\r\n+              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+            } catch (err) {\r\n+              alert(\"OSRM Error: \" + err.message);\r\n+              console.error(err);\r\n+            }\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n"
                },
                {
                    "date": 1746366961691,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -51,23 +51,9 @@\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n             map.on('click', function(e) {\r\n-              try {\r\n-              const res = await fetch('http://${OSRM_BASE_URL}/route/v1/driving/...');\r\n-              const data = await res.json();\r\n-\r\n-              if (data.code !== \"Ok\" || !data.routes || data.routes.length === 0) {\r\n-                alert(\"OSRM: No route found.\");\r\n-                return;\r\n-              }\r\n-\r\n-              const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-              routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-            } catch (err) {\r\n-              alert(\"OSRM Error: \" + err.message);\r\n-              console.error(err);\r\n-            }\r\n+            \r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n"
                },
                {
                    "date": 1746366993167,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,17 +50,36 @@\n \r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n-            map.on('click', function(e) {\r\n-            \r\n+            map.on('click', async function(e) {\r\n               const { lat, lng } = e.latlng;\r\n+\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n+\r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n+\r\n+              try {\r\n+                const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n+                const data = await res.json();\r\n+\r\n+                if (data.code !== \"Ok\" || !data.routes || data.routes.length === 0) {\r\n+                  alert(\"OSRM: No route found.\");\r\n+                  return;\r\n+                }\r\n+\r\n+                const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+                routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+              } catch (err) {\r\n+                alert(\"OSRM Error: \" + err.message);\r\n+                console.error(err);\r\n+              }\r\n+\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n+\r\n             window.addEventListener('message', async function(event) {\r\n               const msg = JSON.parse(event.data);\r\n               if (msg.type === 'drawRoute' && msg.destination) {\r\n                 const { latitude, longitude } = msg.destination;\r\n"
                },
                {
                    "date": 1746367141339,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -59,8 +59,9 @@\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n               try {\r\n+                console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n                 const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n                 const data = await res.json();\r\n \r\n                 if (data.code !== \"Ok\" || !data.routes || data.routes.length === 0) {\r\n"
                },
                {
                    "date": 1746367164527,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,8 +26,9 @@\n   const [mapRef, setMapRef] = useState<WebViewType | null>(null);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n+    console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n     const html = `\r\n       <!DOCTYPE html>\r\n       <html>\r\n@@ -59,9 +60,9 @@\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n \r\n               try {\r\n-                console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n+                \r\n                 const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n                 const data = await res.json();\r\n \r\n                 if (data.code !== \"Ok\" || !data.routes || data.routes.length === 0) {\r\n"
                },
                {
                    "date": 1746367171333,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,12 +23,12 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const [mapRef, setMapRef] = useState<WebViewType | null>(null);\r\n+  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n-    console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n     const html = `\r\n       <!DOCTYPE html>\r\n       <html>\r\n"
                },
                {
                    "date": 1746368039320,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,4 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Route on BOOK NOW\r\n-\r\n import React, { useState, useEffect } from \"react\";\r\n import {\r\n   View,\r\n   Text,\r\n"
                },
                {
                    "date": 1746368312337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,13 +82,30 @@\n             window.addEventListener('message', async function(event) {\r\n               const msg = JSON.parse(event.data);\r\n               if (msg.type === 'drawRoute' && msg.destination) {\r\n                 const { latitude, longitude } = msg.destination;\r\n-                const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n-                const data = await res.json();\r\n-                const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-                if (routeLine) map.removeLayer(routeLine);\r\n-                routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+\r\n+                // üîç Add debug messages here:\r\n+                alert(\"Drawing route to: \" + latitude + \", \" + longitude);\r\n+                console.log(\"Drawing route to:\", latitude, longitude);\r\n+                console.log(\"Fetching from:\", '${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n+\r\n+                try {\r\n+                  const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n+                  const data = await res.json();\r\n+\r\n+                  if (!data.routes || data.routes.length === 0) {\r\n+                    alert(\"OSRM: No route found.\");\r\n+                    return;\r\n+                  }\r\n+\r\n+                  const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+                  if (routeLine) map.removeLayer(routeLine);\r\n+                  routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n+                } catch (err) {\r\n+                  alert(\"OSRM Error in drawRoute: \" + err.message);\r\n+                  console.error(err);\r\n+                }\r\n               }\r\n             });\r\n           </script>\r\n         </body>\r\n"
                },
                {
                    "date": 1746368507665,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,8 +119,11 @@\n     if (destination && mapRef) {\r\n       mapRef.postMessage(\r\n         JSON.stringify({ type: \"drawRoute\", destination })\r\n       );\r\n+      console.log(\"üì§ Sent drawRoute message to WebView:\", destination);\r\n+    } else {\r\n+      console.warn(\"‚ùå No destination or mapRef available.\");\r\n     }\r\n   };\r\n \r\n   return (\r\n"
                },
                {
                    "date": 1746368631970,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -38,8 +38,10 @@\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n+            const userLat = ${location.latitude};\r\n+            const userLng = ${location.longitude};\r\n             const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n             L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n"
                },
                {
                    "date": 1746368785055,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,60 +40,38 @@\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             const userLat = ${location.latitude};\r\n             const userLng = ${location.longitude};\r\n-            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+            const map = L.map('map').setView([userLat, userLng], 15);\r\n             L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n \r\n-            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n-\r\n+            const startMarker = L.marker([userLat, userLng]).addTo(map);\r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n             map.on('click', async function(e) {\r\n               const { lat, lng } = e.latlng;\r\n-\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n \r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n-\r\n-              try {\r\n-                \r\n-                const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + lng + ',' + lat + '?geometries=geojson');\r\n-                const data = await res.json();\r\n-\r\n-                if (data.code !== \"Ok\" || !data.routes || data.routes.length === 0) {\r\n-                  alert(\"OSRM: No route found.\");\r\n-                  return;\r\n-                }\r\n-\r\n-                const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-                routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-              } catch (err) {\r\n-                alert(\"OSRM Error: \" + err.message);\r\n-                console.error(err);\r\n-              }\r\n-\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n-\r\n             window.addEventListener('message', async function(event) {\r\n               const msg = JSON.parse(event.data);\r\n               if (msg.type === 'drawRoute' && msg.destination) {\r\n                 const { latitude, longitude } = msg.destination;\r\n \r\n-                // üîç Add debug messages here:\r\n-                alert(\"Drawing route to: \" + latitude + \", \" + longitude);\r\n-                console.log(\"Drawing route to:\", latitude, longitude);\r\n-                console.log(\"Fetching from:\", '${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n+                alert(\"üìç Drawing route to: \" + latitude + \", \" + longitude);\r\n+                console.log(\"Fetching from:\", '${OSRM_BASE_URL}/route/v1/driving/' + userLng + ',' + userLat + ';' + longitude + ',' + latitude + '?geometries=geojson');\r\n \r\n                 try {\r\n-                  const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};' + longitude + ',' + latitude + '?geometries=geojson');\r\n+                  const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/' + userLng + ',' + userLat + ';' + longitude + ',' + latitude + '?geometries=geojson');\r\n                   const data = await res.json();\r\n \r\n                   if (!data.routes || data.routes.length === 0) {\r\n                     alert(\"OSRM: No route found.\");\r\n@@ -111,10 +89,11 @@\n             });\r\n           </script>\r\n         </body>\r\n       </html>\r\n-    `;\r\n+      `;\r\n \r\n+\r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   const handleBookNow = () => {\r\n"
                },
                {
                    "date": 1746368913629,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -97,16 +97,22 @@\n   }, [location]);\r\n \r\n   const handleBookNow = () => {\r\n     if (destination && mapRef) {\r\n-      mapRef.postMessage(\r\n-        JSON.stringify({ type: \"drawRoute\", destination })\r\n-      );\r\n-      console.log(\"üì§ Sent drawRoute message to WebView:\", destination);\r\n-    } else {\r\n-      console.warn(\"‚ùå No destination or mapRef available.\");\r\n+      const message = JSON.stringify({\r\n+        type: \"drawRoute\",\r\n+        destination,\r\n+      });\r\n+  \r\n+      console.log(\"üì§ Sent drawRoute message to WebView:\", message);\r\n+  \r\n+      // Send after 300ms to ensure WebView loaded and message listener is ready\r\n+      setTimeout(() => {\r\n+        mapRef.postMessage(message);\r\n+      }, 300);\r\n     }\r\n   };\r\n+  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1746369287728,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,6 @@\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Native Fetch on BOOK NOW\r\n+\r\n import React, { useState, useEffect } from \"react\";\r\n import {\r\n   View,\r\n   Text,\r\n@@ -6,24 +8,23 @@\n   Dimensions,\r\n   TouchableOpacity,\r\n   StatusBar,\r\n   TextInput,\r\n+  Alert,\r\n } from \"react-native\";\r\n-import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { WebView } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [mapRef, setMapRef] = useState(null);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const [mapRef, setMapRef] = useState<WebViewType | null>(null);\r\n-  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n@@ -38,91 +39,74 @@\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n-            const userLat = ${location.latitude};\r\n-            const userLng = ${location.longitude};\r\n-\r\n-            const map = L.map('map').setView([userLat, userLng], 15);\r\n+            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n             L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n \r\n-            const startMarker = L.marker([userLat, userLng]).addTo(map);\r\n+            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+\r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n-            map.on('click', async function(e) {\r\n+            map.on('click', function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               if (routeLine) map.removeLayer(routeLine);\r\n-\r\n               destMarker = L.marker([lat, lng]).addTo(map);\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n-            window.addEventListener('message', async function(event) {\r\n+            window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n-              if (msg.type === 'drawRoute' && msg.destination) {\r\n-                const { latitude, longitude } = msg.destination;\r\n-\r\n-                alert(\"üìç Drawing route to: \" + latitude + \", \" + longitude);\r\n-                console.log(\"Fetching from:\", '${OSRM_BASE_URL}/route/v1/driving/' + userLng + ',' + userLat + ';' + longitude + ',' + latitude + '?geometries=geojson');\r\n-\r\n-                try {\r\n-                  const res = await fetch('${OSRM_BASE_URL}/route/v1/driving/' + userLng + ',' + userLat + ';' + longitude + ',' + latitude + '?geometries=geojson');\r\n-                  const data = await res.json();\r\n-\r\n-                  if (!data.routes || data.routes.length === 0) {\r\n-                    alert(\"OSRM: No route found.\");\r\n-                    return;\r\n-                  }\r\n-\r\n-                  const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n-                  if (routeLine) map.removeLayer(routeLine);\r\n-                  routeLine = L.polyline(coords, { color: 'red' }).addTo(map);\r\n-                } catch (err) {\r\n-                  alert(\"OSRM Error in drawRoute: \" + err.message);\r\n-                  console.error(err);\r\n-                }\r\n+              if (msg.type === 'drawRoute' && msg.coords) {\r\n+                if (routeLine) map.removeLayer(routeLine);\r\n+                routeLine = L.polyline(msg.coords, { color: 'red' }).addTo(map);\r\n               }\r\n             });\r\n           </script>\r\n         </body>\r\n       </html>\r\n-      `;\r\n+    `;\r\n \r\n-\r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = () => {\r\n-    if (destination && mapRef) {\r\n-      const message = JSON.stringify({\r\n-        type: \"drawRoute\",\r\n-        destination,\r\n-      });\r\n-  \r\n-      console.log(\"üì§ Sent drawRoute message to WebView:\", message);\r\n-  \r\n-      // Send after 300ms to ensure WebView loaded and message listener is ready\r\n-      setTimeout(() => {\r\n-        mapRef.postMessage(message);\r\n-      }, 300);\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination || !mapRef) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n     }\r\n+\r\n+    try {\r\n+      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n+      const res = await fetch(url);\r\n+      const data = await res.json();\r\n+\r\n+      if (!data.routes || data.routes.length === 0) {\r\n+        Alert.alert(\"OSRM\", \"No route found\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+      mapRef.postMessage(message);\r\n+    } catch (err) {\r\n+      Alert.alert(\"OSRM Error\", err.message);\r\n+      console.error(\"OSRM fetch failed:\", err);\r\n+    }\r\n   };\r\n-  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n       {mapHtml && (\r\n         <WebView\r\n-          ref={(ref) => {\r\n-            if (ref && !mapRef) setMapRef(ref);\r\n-          }}\r\n+          ref={(ref) => setMapRef(ref)}\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n@@ -139,9 +123,9 @@\n \r\n           <TouchableOpacity style={styles.inputBox}>\r\n             <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n             <Text style={styles.inputText}>\r\n-              {destination && destination.latitude && destination.longitude\r\n+              {destination\r\n                 ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n                 : \"Saan ka papunta ngayon?\"}\r\n             </Text>\r\n             <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n"
                },
                {
                    "date": 1746369353849,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,21 +10,23 @@\n   StatusBar,\r\n   TextInput,\r\n   Alert,\r\n } from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n+import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState(null);\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [mapRef, setMapRef] = useState(null);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const [mapRef, setMapRef] = useState<WebViewType | null>(null);\r\n+  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n"
                },
                {
                    "date": 1746369556182,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,12 +91,12 @@\n         Alert.alert(\"OSRM\", \"No route found\");\r\n         return;\r\n       }\r\n \r\n-      const coords = data.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);\r\n+      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n       const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n       mapRef.postMessage(message);\r\n-    } catch (err) {\r\n+    } catch (err: any) {\r\n       Alert.alert(\"OSRM Error\", err.message);\r\n       console.error(\"OSRM fetch failed:\", err);\r\n     }\r\n   };\r\n"
                },
                {
                    "date": 1746369933658,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,6 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Native Fetch on BOOK NOW\r\n \r\n-import React, { useState, useEffect } from \"react\";\r\n+import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n   Text,\r\n   StyleSheet,\r\n@@ -23,9 +22,9 @@\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const [mapRef, setMapRef] = useState<WebViewType | null>(null);\r\n+  const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n@@ -76,9 +75,9 @@\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   const handleBookNow = async () => {\r\n-    if (!location || !destination || !mapRef) {\r\n+    if (!location || !destination || !mapRef.current) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n \r\n@@ -93,9 +92,9 @@\n       }\r\n \r\n       const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n       const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.postMessage(message);\r\n+      mapRef.current.postMessage(message);\r\n     } catch (err: any) {\r\n       Alert.alert(\"OSRM Error\", err.message);\r\n       console.error(\"OSRM fetch failed:\", err);\r\n     }\r\n@@ -106,9 +105,11 @@\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n       {mapHtml && (\r\n         <WebView\r\n-          ref={(ref) => setMapRef(ref)}\r\n+          ref={(ref) => {\r\n+            if (ref && !mapRef.current) mapRef.current = ref;\r\n+          }}\r\n           originWhitelist={[\"*\"]}\r\n           source={{ html: mapHtml }}\r\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n"
                },
                {
                    "date": 1746370946891,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,9 +82,14 @@\n     }\r\n \r\n     try {\r\n       const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n+      console.log(\"üì° Fetching route from:\", url);\r\n       const res = await fetch(url);\r\n+      if (!res.ok) {\r\n+        const text = await res.text(); // Try to read response even if it's not JSON\r\n+        throw new Error(`HTTP ${res.status} ${res.statusText}: ${text}`);\r\n+      }\r\n       const data = await res.json();\r\n \r\n       if (!data.routes || data.routes.length === 0) {\r\n         Alert.alert(\"OSRM\", \"No route found\");\r\n"
                },
                {
                    "date": 1747044391168,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -21,8 +21,11 @@\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n"
                },
                {
                    "date": 1747044445727,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,10 +22,9 @@\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n-const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n@@ -148,18 +147,21 @@\n             value={destinationLabel}\r\n             onChangeText={setDestinationLabel}\r\n           />\r\n \r\n-          <TouchableOpacity style={styles.inputBoxSimple}>\r\n-            <MaterialIcons name=\"edit\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>Notes sa driver</Text>\r\n-          </TouchableOpacity>\r\n+          <TextInput\r\n+            style={styles.inputBoxSimple}\r\n+            placeholder=\"Notes sa driver\"\r\n+            value={notes}\r\n+            onChangeText={setNotes}\r\n+          />\r\n \r\n-          <TouchableOpacity style={styles.inputBox}>\r\n-            <MaterialIcons name=\"payments\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>Paano ka magbabayad</Text>\r\n-            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity>\r\n+          <TextInput\r\n+            style={styles.inputBox}\r\n+            placeholder=\"Paano ka magbabayad\"\r\n+            value={paymentMethod}\r\n+            onChangeText={setPaymentMethod}\r\n+          />\r\n \r\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n               <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n"
                },
                {
                    "date": 1747044477747,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -77,36 +77,43 @@\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   const handleBookNow = async () => {\r\n-    if (!location || !destination || !mapRef.current) {\r\n+    if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n-\r\n+  \r\n+    const bookingData = {\r\n+      currentLocation: location,\r\n+      destination,\r\n+      destinationLabel,\r\n+      notes,\r\n+      paymentMethod,\r\n+    };\r\n+  \r\n     try {\r\n-      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n-      console.log(\"üì° Fetching route from:\", url);\r\n-      const res = await fetch(url);\r\n-      if (!res.ok) {\r\n-        const text = await res.text(); // Try to read response even if it's not JSON\r\n-        throw new Error(`HTTP ${res.status} ${res.statusText}: ${text}`);\r\n+      const res = await fetch(\"https://your-backend-url.com/api/book\", {\r\n+        method: \"POST\",\r\n+        headers: {\r\n+          \"Content-Type\": \"application/json\",\r\n+        },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+  \r\n+      const result = await res.json();\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Booking submitted!\");\r\n+        console.log(\"Booking response:\", result);\r\n+      } else {\r\n+        Alert.alert(\"Failed\", result.message || \"Booking failed\");\r\n       }\r\n-      const data = await res.json();\r\n-\r\n-      if (!data.routes || data.routes.length === 0) {\r\n-        Alert.alert(\"OSRM\", \"No route found\");\r\n-        return;\r\n-      }\r\n-\r\n-      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.current.postMessage(message);\r\n     } catch (err: any) {\r\n-      Alert.alert(\"OSRM Error\", err.message);\r\n-      console.error(\"OSRM fetch failed:\", err);\r\n+      Alert.alert(\"Error\", err.message);\r\n+      console.error(\"Booking failed:\", err);\r\n     }\r\n   };\r\n+  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747044903231,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Booking + Fare Calculation\r\n \r\n import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n@@ -23,8 +24,9 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n@@ -77,43 +79,54 @@\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n+    if (!location || !destination || !mapRef.current) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n-  \r\n-    const bookingData = {\r\n-      currentLocation: location,\r\n-      destination,\r\n-      destinationLabel,\r\n-      notes,\r\n-      paymentMethod,\r\n-    };\r\n-  \r\n+\r\n     try {\r\n-      const res = await fetch(\"https://your-backend-url.com/api/book\", {\r\n-        method: \"POST\",\r\n-        headers: {\r\n-          \"Content-Type\": \"application/json\",\r\n-        },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-  \r\n-      const result = await res.json();\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Booking submitted!\");\r\n-        console.log(\"Booking response:\", result);\r\n-      } else {\r\n-        Alert.alert(\"Failed\", result.message || \"Booking failed\");\r\n+      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n+      console.log(\"üì° Fetching route from:\", url);\r\n+      const res = await fetch(url);\r\n+      if (!res.ok) {\r\n+        const text = await res.text();\r\n+        throw new Error(`HTTP ${res.status} ${res.statusText}: ${text}`);\r\n       }\r\n+      const data = await res.json();\r\n+\r\n+      if (!data.routes || data.routes.length === 0) {\r\n+        Alert.alert(\"OSRM\", \"No route found\");\r\n+        return;\r\n+      }\r\n+\r\n+      const distanceKm = data.routes[0].distance / 1000;\r\n+      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n+      setFare(calculatedFare);\r\n+\r\n+      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n+      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+      mapRef.current.postMessage(message);\r\n+\r\n+      // Optional: send data to backend\r\n+      const bookingData = {\r\n+        currentLocation: location,\r\n+        destination,\r\n+        destinationLabel,\r\n+        notes,\r\n+        paymentMethod,\r\n+        fare: calculatedFare,\r\n+      };\r\n+\r\n+      console.log(\"üì§ Sending booking:\", bookingData);\r\n+      // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n+\r\n     } catch (err: any) {\r\n-      Alert.alert(\"Error\", err.message);\r\n-      console.error(\"Booking failed:\", err);\r\n+      Alert.alert(\"OSRM Error\", err.message);\r\n+      console.error(\"OSRM fetch failed:\", err);\r\n     }\r\n   };\r\n-  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n@@ -170,9 +183,9 @@\n           />\r\n \r\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+              <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n             </View>\r\n             <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n"
                },
                {
                    "date": 1747045454129,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,8 +29,31 @@\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n+  const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n+    if (!location) return;\r\n+    try {\r\n+      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n+      console.log(\"üì° Fetching route from:\", url);\r\n+      const res = await fetch(url);\r\n+      if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n+\r\n+      const data = await res.json();\r\n+      if (!data.routes || data.routes.length === 0) return;\r\n+\r\n+      const distanceKm = data.routes[0].distance / 1000;\r\n+      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n+      setFare(calculatedFare);\r\n+\r\n+      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n+      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+      mapRef.current?.postMessage(message);\r\n+    } catch (err) {\r\n+      console.error(\"Fare calculation error:\", err);\r\n+    }\r\n+  };\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -78,54 +101,25 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = async () => {\r\n+  const handleBookNow = () => {\r\n     if (!location || !destination || !mapRef.current) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n \r\n-    try {\r\n-      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n-      console.log(\"üì° Fetching route from:\", url);\r\n-      const res = await fetch(url);\r\n-      if (!res.ok) {\r\n-        const text = await res.text();\r\n-        throw new Error(`HTTP ${res.status} ${res.statusText}: ${text}`);\r\n-      }\r\n-      const data = await res.json();\r\n+    const bookingData = {\r\n+      currentLocation: location,\r\n+      destination,\r\n+      destinationLabel,\r\n+      notes,\r\n+      paymentMethod,\r\n+      fare,\r\n+    };\r\n \r\n-      if (!data.routes || data.routes.length === 0) {\r\n-        Alert.alert(\"OSRM\", \"No route found\");\r\n-        return;\r\n-      }\r\n-\r\n-      const distanceKm = data.routes[0].distance / 1000;\r\n-      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n-      setFare(calculatedFare);\r\n-\r\n-      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.current.postMessage(message);\r\n-\r\n-      // Optional: send data to backend\r\n-      const bookingData = {\r\n-        currentLocation: location,\r\n-        destination,\r\n-        destinationLabel,\r\n-        notes,\r\n-        paymentMethod,\r\n-        fare: calculatedFare,\r\n-      };\r\n-\r\n-      console.log(\"üì§ Sending booking:\", bookingData);\r\n-      // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n-\r\n-    } catch (err: any) {\r\n-      Alert.alert(\"OSRM Error\", err.message);\r\n-      console.error(\"OSRM fetch failed:\", err);\r\n-    }\r\n+    console.log(\"üì§ Sending booking:\", bookingData);\r\n+    // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n   };\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n@@ -141,8 +135,9 @@\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n             setDestination(data);\r\n+            calculateFare(data);\r\n           }}\r\n           style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n         />\r\n       )}\r\n"
                },
                {
                    "date": 1747045661852,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,4 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Booking + Fare Calculation\r\n \r\n import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n@@ -24,36 +23,12 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n-  const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n-    if (!location) return;\r\n-    try {\r\n-      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n-      console.log(\"üì° Fetching route from:\", url);\r\n-      const res = await fetch(url);\r\n-      if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n-\r\n-      const data = await res.json();\r\n-      if (!data.routes || data.routes.length === 0) return;\r\n-\r\n-      const distanceKm = data.routes[0].distance / 1000;\r\n-      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n-      setFare(calculatedFare);\r\n-\r\n-      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.current?.postMessage(message);\r\n-    } catch (err) {\r\n-      console.error(\"Fare calculation error:\", err);\r\n-    }\r\n-  };\r\n-\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -101,26 +76,44 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = () => {\r\n-    if (!location || !destination || !mapRef.current) {\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n-\r\n+  \r\n     const bookingData = {\r\n       currentLocation: location,\r\n       destination,\r\n       destinationLabel,\r\n       notes,\r\n       paymentMethod,\r\n-      fare,\r\n     };\r\n-\r\n-    console.log(\"üì§ Sending booking:\", bookingData);\r\n-    // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n+  \r\n+    try {\r\n+      const res = await fetch(\"https://your-backend-url.com/api/book\", {\r\n+        method: \"POST\",\r\n+        headers: {\r\n+          \"Content-Type\": \"application/json\",\r\n+        },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+  \r\n+      const result = await res.json();\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Booking submitted!\");\r\n+        console.log(\"Booking response:\", result);\r\n+      } else {\r\n+        Alert.alert(\"Failed\", result.message || \"Booking failed\");\r\n+      }\r\n+    } catch (err: any) {\r\n+      Alert.alert(\"Error\", err.message);\r\n+      console.error(\"Booking failed:\", err);\r\n+    }\r\n   };\r\n+  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n@@ -135,9 +128,8 @@\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n             setDestination(data);\r\n-            calculateFare(data);\r\n           }}\r\n           style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n         />\r\n       )}\r\n@@ -178,9 +170,9 @@\n           />\r\n \r\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n             </View>\r\n             <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n"
                },
                {
                    "date": 1747045695874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Booking + Fare Calculation\r\n \r\n import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n@@ -23,8 +24,9 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n@@ -77,43 +79,54 @@\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n+    if (!location || !destination || !mapRef.current) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n-  \r\n-    const bookingData = {\r\n-      currentLocation: location,\r\n-      destination,\r\n-      destinationLabel,\r\n-      notes,\r\n-      paymentMethod,\r\n-    };\r\n-  \r\n+\r\n     try {\r\n-      const res = await fetch(\"https://your-backend-url.com/api/book\", {\r\n-        method: \"POST\",\r\n-        headers: {\r\n-          \"Content-Type\": \"application/json\",\r\n-        },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-  \r\n-      const result = await res.json();\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Booking submitted!\");\r\n-        console.log(\"Booking response:\", result);\r\n-      } else {\r\n-        Alert.alert(\"Failed\", result.message || \"Booking failed\");\r\n+      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n+      console.log(\"üì° Fetching route from:\", url);\r\n+      const res = await fetch(url);\r\n+      if (!res.ok) {\r\n+        const text = await res.text();\r\n+        throw new Error(`HTTP ${res.status} ${res.statusText}: ${text}`);\r\n       }\r\n+      const data = await res.json();\r\n+\r\n+      if (!data.routes || data.routes.length === 0) {\r\n+        Alert.alert(\"OSRM\", \"No route found\");\r\n+        return;\r\n+      }\r\n+\r\n+      const distanceKm = data.routes[0].distance / 1000;\r\n+      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n+      setFare(calculatedFare);\r\n+\r\n+      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n+      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+      mapRef.current.postMessage(message);\r\n+\r\n+      // Optional: send data to backend\r\n+      const bookingData = {\r\n+        currentLocation: location,\r\n+        destination,\r\n+        destinationLabel,\r\n+        notes,\r\n+        paymentMethod,\r\n+        fare: calculatedFare,\r\n+      };\r\n+\r\n+      console.log(\"üì§ Sending booking:\", bookingData);\r\n+      // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n+\r\n     } catch (err: any) {\r\n-      Alert.alert(\"Error\", err.message);\r\n-      console.error(\"Booking failed:\", err);\r\n+      Alert.alert(\"OSRM Error\", err.message);\r\n+      console.error(\"OSRM fetch failed:\", err);\r\n     }\r\n   };\r\n-  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n@@ -170,9 +183,9 @@\n           />\r\n \r\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+              <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n             </View>\r\n             <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n"
                },
                {
                    "date": 1747045701806,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,8 +29,31 @@\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n+  const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n+    if (!location) return;\r\n+    try {\r\n+      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n+      console.log(\"üì° Fetching route from:\", url);\r\n+      const res = await fetch(url);\r\n+      if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n+\r\n+      const data = await res.json();\r\n+      if (!data.routes || data.routes.length === 0) return;\r\n+\r\n+      const distanceKm = data.routes[0].distance / 1000;\r\n+      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n+      setFare(calculatedFare);\r\n+\r\n+      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n+      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+      mapRef.current?.postMessage(message);\r\n+    } catch (err) {\r\n+      console.error(\"Fare calculation error:\", err);\r\n+    }\r\n+  };\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -78,54 +101,25 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = async () => {\r\n+  const handleBookNow = () => {\r\n     if (!location || !destination || !mapRef.current) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n \r\n-    try {\r\n-      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${destination.longitude},${destination.latitude}?geometries=geojson`;\r\n-      console.log(\"üì° Fetching route from:\", url);\r\n-      const res = await fetch(url);\r\n-      if (!res.ok) {\r\n-        const text = await res.text();\r\n-        throw new Error(`HTTP ${res.status} ${res.statusText}: ${text}`);\r\n-      }\r\n-      const data = await res.json();\r\n+    const bookingData = {\r\n+      currentLocation: location,\r\n+      destination,\r\n+      destinationLabel,\r\n+      notes,\r\n+      paymentMethod,\r\n+      fare,\r\n+    };\r\n \r\n-      if (!data.routes || data.routes.length === 0) {\r\n-        Alert.alert(\"OSRM\", \"No route found\");\r\n-        return;\r\n-      }\r\n-\r\n-      const distanceKm = data.routes[0].distance / 1000;\r\n-      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n-      setFare(calculatedFare);\r\n-\r\n-      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.current.postMessage(message);\r\n-\r\n-      // Optional: send data to backend\r\n-      const bookingData = {\r\n-        currentLocation: location,\r\n-        destination,\r\n-        destinationLabel,\r\n-        notes,\r\n-        paymentMethod,\r\n-        fare: calculatedFare,\r\n-      };\r\n-\r\n-      console.log(\"üì§ Sending booking:\", bookingData);\r\n-      // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n-\r\n-    } catch (err: any) {\r\n-      Alert.alert(\"OSRM Error\", err.message);\r\n-      console.error(\"OSRM fetch failed:\", err);\r\n-    }\r\n+    console.log(\"üì§ Sending booking:\", bookingData);\r\n+    // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n   };\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n@@ -141,8 +135,9 @@\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n             setDestination(data);\r\n+            calculateFare(data);\r\n           }}\r\n           style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n         />\r\n       )}\r\n"
                },
                {
                    "date": 1747045713361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,5 +1,4 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Booking + Fare Calculation\r\n \r\n import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n@@ -24,36 +23,12 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n-  const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n-    if (!location) return;\r\n-    try {\r\n-      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n-      console.log(\"üì° Fetching route from:\", url);\r\n-      const res = await fetch(url);\r\n-      if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n-\r\n-      const data = await res.json();\r\n-      if (!data.routes || data.routes.length === 0) return;\r\n-\r\n-      const distanceKm = data.routes[0].distance / 1000;\r\n-      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n-      setFare(calculatedFare);\r\n-\r\n-      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.current?.postMessage(message);\r\n-    } catch (err) {\r\n-      console.error(\"Fare calculation error:\", err);\r\n-    }\r\n-  };\r\n-\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -101,26 +76,44 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = () => {\r\n-    if (!location || !destination || !mapRef.current) {\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n-\r\n+  \r\n     const bookingData = {\r\n       currentLocation: location,\r\n       destination,\r\n       destinationLabel,\r\n       notes,\r\n       paymentMethod,\r\n-      fare,\r\n     };\r\n-\r\n-    console.log(\"üì§ Sending booking:\", bookingData);\r\n-    // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n+  \r\n+    try {\r\n+      const res = await fetch(\"https://your-backend-url.com/api/book\", {\r\n+        method: \"POST\",\r\n+        headers: {\r\n+          \"Content-Type\": \"application/json\",\r\n+        },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+  \r\n+      const result = await res.json();\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Booking submitted!\");\r\n+        console.log(\"Booking response:\", result);\r\n+      } else {\r\n+        Alert.alert(\"Failed\", result.message || \"Booking failed\");\r\n+      }\r\n+    } catch (err: any) {\r\n+      Alert.alert(\"Error\", err.message);\r\n+      console.error(\"Booking failed:\", err);\r\n+    }\r\n   };\r\n+  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n@@ -135,9 +128,8 @@\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n             setDestination(data);\r\n-            calculateFare(data);\r\n           }}\r\n           style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n         />\r\n       )}\r\n@@ -178,9 +170,9 @@\n           />\r\n \r\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n             </View>\r\n             <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n"
                },
                {
                    "date": 1747046890413,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,5 @@\n+// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Booking + Fare Calculation\r\n \r\n import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n@@ -23,12 +24,38 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n+  const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n+    if (!location) return;\r\n+    try {\r\n+      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n+      console.log(\"üì° Fetching route from:\", url);\r\n+      const res = await fetch(url);\r\n+      if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n+\r\n+      const data = await res.json();\r\n+      if (!data.routes || data.routes.length === 0) return;\r\n+\r\n+      const distanceKm = data.routes[0].distance / 1000;\r\n+      console.log(distanceKm)\r\n+      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n+      console.log(calculatedFare)\r\n+      setFare(calculatedFare);\r\n+\r\n+      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n+      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+      mapRef.current?.postMessage(message);\r\n+    } catch (err) {\r\n+      console.error(\"Fare calculation error:\", err);\r\n+    }\r\n+  };\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -76,44 +103,26 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n+  const handleBookNow = () => {\r\n+    if (!location || !destination || !mapRef.current) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n-  \r\n+\r\n     const bookingData = {\r\n       currentLocation: location,\r\n       destination,\r\n       destinationLabel,\r\n       notes,\r\n       paymentMethod,\r\n+      fare,\r\n     };\r\n-  \r\n-    try {\r\n-      const res = await fetch(\"https://your-backend-url.com/api/book\", {\r\n-        method: \"POST\",\r\n-        headers: {\r\n-          \"Content-Type\": \"application/json\",\r\n-        },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-  \r\n-      const result = await res.json();\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Booking submitted!\");\r\n-        console.log(\"Booking response:\", result);\r\n-      } else {\r\n-        Alert.alert(\"Failed\", result.message || \"Booking failed\");\r\n-      }\r\n-    } catch (err: any) {\r\n-      Alert.alert(\"Error\", err.message);\r\n-      console.error(\"Booking failed:\", err);\r\n-    }\r\n+\r\n+    console.log(\"üì§ Sending booking:\", bookingData);\r\n+    // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n   };\r\n-  \r\n \r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n@@ -128,8 +137,9 @@\n           javaScriptEnabled\r\n           onMessage={(event) => {\r\n             const data = JSON.parse(event.nativeEvent.data);\r\n             setDestination(data);\r\n+            calculateFare(data);\r\n           }}\r\n           style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n         />\r\n       )}\r\n@@ -170,9 +180,9 @@\n           />\r\n \r\n           <View style={styles.totalFareContainer}>\r\n             <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: 9999</Text>\r\n+              <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n             </View>\r\n             <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n               <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n             </TouchableOpacity>\r\n"
                },
                {
                    "date": 1747228517579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,9 +24,9 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n+  const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n@@ -104,26 +104,29 @@\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   const handleBookNow = () => {\r\n-    if (!location || !destination || !mapRef.current) {\r\n+    if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n \r\n-    const bookingData = {\r\n-      currentLocation: location,\r\n-      destination,\r\n-      destinationLabel,\r\n+    const simulatedBookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare: 20,\r\n+      paymentMethod: \"cash\",\r\n       notes,\r\n-      paymentMethod,\r\n-      fare,\r\n     };\r\n \r\n-    console.log(\"üì§ Sending booking:\", bookingData);\r\n-    // await fetch(\"https://your-backend-url.com/api/book\", {...})\r\n+    console.log(\"üì§ Simulated passenger booking sent to backend:\", simulatedBookingData);\r\n+\r\n+    Alert.alert(\"Booking Sent\", \"Booking data has been logged to console for backend testing.\");\r\n   };\r\n \r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n"
                },
                {
                    "date": 1747228953073,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -103,9 +103,9 @@\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n-  const handleBookNow = () => {\r\n+  const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n@@ -119,14 +119,28 @@\n       paymentMethod: \"cash\",\r\n       notes,\r\n     };\r\n \r\n-    console.log(\"üì§ Simulated passenger booking sent to backend:\", simulatedBookingData);\r\n+    try {\r\n+      const res = await fetch(\"https://your-backend-url/api/book\", {\r\n+        method: \"POST\",\r\n+        headers: {\r\n+          \"Content-Type\": \"application/json\",\r\n+        },\r\n+        body: JSON.stringify(simulatedBookingData),\r\n+      });\r\n \r\n-    Alert.alert(\"Booking Sent\", \"Booking data has been logged to console for backend testing.\");\r\n+      const data = await res.json();\r\n+      console.log(\"‚úÖ Backend response:\", data);\r\n+      Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Booking error:\", error);\r\n+      Alert.alert(\"Error\", \"Failed to send booking.\");\r\n+    }\r\n   };\r\n \r\n \r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n       <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n"
                },
                {
                    "date": 1747229589238,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,6 +1,4 @@\n-// üìç Updated Passenger HomePage - phome.tsx using Leaflet + WebView + Destination Label + Booking + Fare Calculation\r\n-\r\n import React, { useState, useEffect, useRef } from \"react\";\r\n import {\r\n   View,\r\n   Text,\r\n@@ -9,8 +7,13 @@\n   TouchableOpacity,\r\n   StatusBar,\r\n   TextInput,\r\n   Alert,\r\n+  KeyboardAvoidingView,\r\n+  Platform,\r\n+  ScrollView,\r\n+  TouchableWithoutFeedback,\r\n+  Keyboard,\r\n } from \"react-native\";\r\n import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -137,96 +140,106 @@\n       Alert.alert(\"Error\", \"Failed to send booking.\");\r\n     }\r\n   };\r\n \r\n+  if (loading || !location) {\r\n+    return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n+  }\r\n \r\n-\r\n   return (\r\n-    <View style={styles.container}>\r\n-      <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+    <KeyboardAvoidingView\r\n+      style={{ flex: 1 }}\r\n+      behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n+    >\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n-      {mapHtml && (\r\n-        <WebView\r\n-          ref={(ref) => {\r\n-            if (ref && !mapRef.current) mapRef.current = ref;\r\n-          }}\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled\r\n-          onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n-            calculateFare(data);\r\n-          }}\r\n-          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-        />\r\n-      )}\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) mapRef.current = ref;\r\n+              }}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onMessage={(event) => {\r\n+                const data = JSON.parse(event.nativeEvent.data);\r\n+                setDestination(data);\r\n+                calculateFare(data);\r\n+              }}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+            />\r\n+          )}\r\n \r\n-      <View style={styles.overlayContainer}>\r\n-        <View style={styles.card}>\r\n-          <View style={styles.cardHeader} />\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.card}>\r\n+              <View style={styles.cardHeader} />\r\n \r\n-          <TouchableOpacity style={styles.inputBox}>\r\n-            <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-            <Text style={styles.inputText}>\r\n-              {destination\r\n-                ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-                : \"Saan ka papunta ngayon?\"}\r\n-            </Text>\r\n-            <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-          </TouchableOpacity>\r\n+              <TouchableOpacity style={styles.inputBox}>\r\n+                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                <Text style={styles.inputText}>\r\n+                  {destination\r\n+                    ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+                    : \"Saan ka papunta ngayon?\"}\r\n+                </Text>\r\n+                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+              </TouchableOpacity>\r\n \r\n-          <TextInput\r\n-            style={styles.inputBoxSimple}\r\n-            placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-            value={destinationLabel}\r\n-            onChangeText={setDestinationLabel}\r\n-          />\r\n+              <TextInput\r\n+                style={styles.inputBoxSimple}\r\n+                placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                value={destinationLabel}\r\n+                onChangeText={setDestinationLabel}\r\n+              />\r\n \r\n-          <TextInput\r\n-            style={styles.inputBoxSimple}\r\n-            placeholder=\"Notes sa driver\"\r\n-            value={notes}\r\n-            onChangeText={setNotes}\r\n-          />\r\n+              <TextInput\r\n+                style={styles.inputBoxSimple}\r\n+                placeholder=\"Notes sa driver\"\r\n+                value={notes}\r\n+                onChangeText={setNotes}\r\n+              />\r\n \r\n-          <TextInput\r\n-            style={styles.inputBox}\r\n-            placeholder=\"Paano ka magbabayad\"\r\n-            value={paymentMethod}\r\n-            onChangeText={setPaymentMethod}\r\n-          />\r\n+              <TextInput\r\n+                style={styles.inputBox}\r\n+                placeholder=\"Paano ka magbabayad\"\r\n+                value={paymentMethod}\r\n+                onChangeText={setPaymentMethod}\r\n+              />\r\n \r\n-          <View style={styles.totalFareContainer}>\r\n-            <View style={styles.fareBox}>\r\n-              <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+              <View style={styles.totalFareContainer}>\r\n+                <View style={styles.fareBox}>\r\n+                  <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+                </View>\r\n+                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n+                  <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+                </TouchableOpacity>\r\n+              </View>\r\n             </View>\r\n-            <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n-              <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n-            </TouchableOpacity>\r\n+\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+                <Text>Home</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+                <Text>History</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+                <Text>Chats</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+                <Text>Profile</Text>\r\n+              </TouchableOpacity>\r\n+            </View>\r\n           </View>\r\n         </View>\r\n-\r\n-        <View style={styles.bottomNav}>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-            <Text>Home</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-            <Text>History</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-            <Text>Chats</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-            <Text>Profile</Text>\r\n-          </TouchableOpacity>\r\n-        </View>\r\n-      </View>\r\n-    </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n"
                },
                {
                    "date": 1747229742031,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -145,35 +145,35 @@\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n   return (\r\n-    <KeyboardAvoidingView\r\n-      style={{ flex: 1 }}\r\n-      behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n-    >\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+    <View style={styles.container}>\r\n+      <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n-          {mapHtml && (\r\n-            <WebView\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) mapRef.current = ref;\r\n-              }}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onMessage={(event) => {\r\n-                const data = JSON.parse(event.nativeEvent.data);\r\n-                setDestination(data);\r\n-                calculateFare(data);\r\n-              }}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-            />\r\n-          )}\r\n+      {mapHtml && (\r\n+        <WebView\r\n+          ref={(ref) => {\r\n+            if (ref && !mapRef.current) mapRef.current = ref;\r\n+          }}\r\n+          originWhitelist={[\"*\"]}\r\n+          source={{ html: mapHtml }}\r\n+          javaScriptEnabled\r\n+          onMessage={(event) => {\r\n+            const data = JSON.parse(event.nativeEvent.data);\r\n+            setDestination(data);\r\n+            calculateFare(data);\r\n+          }}\r\n+          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+        />\r\n+      )}\r\n \r\n-          <View style={styles.overlayContainer}>\r\n+      <View style={styles.overlayContainer}>\r\n+        {/* Only this part is affected by the keyboard */}\r\n+        <KeyboardAvoidingView\r\n+          behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n+          keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n+        >\r\n+          <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n             <View style={styles.card}>\r\n               <View style={styles.cardHeader} />\r\n \r\n               <TouchableOpacity style={styles.inputBox}>\r\n@@ -215,32 +215,34 @@\n                   <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n               </View>\r\n             </View>\r\n+          </TouchableWithoutFeedback>\r\n+        </KeyboardAvoidingView>\r\n \r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-                <Text>Home</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-                <Text>History</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-                <Text>Chats</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-                <Text>Profile</Text>\r\n-              </TouchableOpacity>\r\n-            </View>\r\n-          </View>\r\n+        {/* Bottom nav stays fixed */}\r\n+        <View style={styles.bottomNav}>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+            <Text>Home</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+            <Text>History</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+            <Text>Chats</Text>\r\n+          </TouchableOpacity>\r\n+          <TouchableOpacity>\r\n+            <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+            <Text>Profile</Text>\r\n+          </TouchableOpacity>\r\n         </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n+      </View>\r\n+    </View>\r\n   );\r\n+\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: {\r\n"
                },
                {
                    "date": 1747229824562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -145,35 +145,35 @@\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n   return (\r\n-    <View style={styles.container}>\r\n-      <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+    <KeyboardAvoidingView\r\n+      style={{ flex: 1 }}\r\n+      behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n+    >\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n-      {mapHtml && (\r\n-        <WebView\r\n-          ref={(ref) => {\r\n-            if (ref && !mapRef.current) mapRef.current = ref;\r\n-          }}\r\n-          originWhitelist={[\"*\"]}\r\n-          source={{ html: mapHtml }}\r\n-          javaScriptEnabled\r\n-          onMessage={(event) => {\r\n-            const data = JSON.parse(event.nativeEvent.data);\r\n-            setDestination(data);\r\n-            calculateFare(data);\r\n-          }}\r\n-          style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-        />\r\n-      )}\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) mapRef.current = ref;\r\n+              }}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onMessage={(event) => {\r\n+                const data = JSON.parse(event.nativeEvent.data);\r\n+                setDestination(data);\r\n+                calculateFare(data);\r\n+              }}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+            />\r\n+          )}\r\n \r\n-      <View style={styles.overlayContainer}>\r\n-        {/* Only this part is affected by the keyboard */}\r\n-        <KeyboardAvoidingView\r\n-          behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-          keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n-        >\r\n-          <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+          <View style={styles.overlayContainer}>\r\n             <View style={styles.card}>\r\n               <View style={styles.cardHeader} />\r\n \r\n               <TouchableOpacity style={styles.inputBox}>\r\n@@ -215,34 +215,32 @@\n                   <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n               </View>\r\n             </View>\r\n-          </TouchableWithoutFeedback>\r\n-        </KeyboardAvoidingView>\r\n \r\n-        {/* Bottom nav stays fixed */}\r\n-        <View style={styles.bottomNav}>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-            <Text>Home</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-            <Text>History</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-            <Text>Chats</Text>\r\n-          </TouchableOpacity>\r\n-          <TouchableOpacity>\r\n-            <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-            <Text>Profile</Text>\r\n-          </TouchableOpacity>\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+                <Text>Home</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+                <Text>History</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+                <Text>Chats</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+                <Text>Profile</Text>\r\n+              </TouchableOpacity>\r\n+            </View>\r\n+          </View>\r\n         </View>\r\n-      </View>\r\n-    </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n   );\r\n-\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: {\r\n"
                },
                {
                    "date": 1747229844726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 0}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747230292089,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,32 +32,32 @@\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n \r\n-  const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n-    if (!location) return;\r\n-    try {\r\n-      const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n-      console.log(\"üì° Fetching route from:\", url);\r\n-      const res = await fetch(url);\r\n-      if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n+  // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n+  //   if (!location) return;\r\n+  //   try {\r\n+  //     const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n+  //     console.log(\"üì° Fetching route from:\", url);\r\n+  //     const res = await fetch(url);\r\n+  //     if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n \r\n-      const data = await res.json();\r\n-      if (!data.routes || data.routes.length === 0) return;\r\n+  //     const data = await res.json();\r\n+  //     if (!data.routes || data.routes.length === 0) return;\r\n \r\n-      const distanceKm = data.routes[0].distance / 1000;\r\n-      console.log(distanceKm)\r\n-      const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n-      console.log(calculatedFare)\r\n-      setFare(calculatedFare);\r\n+  //     const distanceKm = data.routes[0].distance / 1000;\r\n+  //     console.log(distanceKm)\r\n+  //     const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n+  //     console.log(calculatedFare)\r\n+  //     setFare(calculatedFare);\r\n \r\n-      const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-      const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-      mapRef.current?.postMessage(message);\r\n-    } catch (err) {\r\n-      console.error(\"Fare calculation error:\", err);\r\n-    }\r\n-  };\r\n+  //     const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n+  //     const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n+  //     mapRef.current?.postMessage(message);\r\n+  //   } catch (err) {\r\n+  //     console.error(\"Fare calculation error:\", err);\r\n+  //   }\r\n+  // };\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n@@ -165,9 +165,8 @@\n               javaScriptEnabled\r\n               onMessage={(event) => {\r\n                 const data = JSON.parse(event.nativeEvent.data);\r\n                 setDestination(data);\r\n-                calculateFare(data);\r\n               }}\r\n               style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n"
                },
                {
                    "date": 1747230482125,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 0}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : -300}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747230489023,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : -300}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : -30}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747230503072,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : -30}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : -31}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747230541223,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : -31}\r\n+      keyboardVerticalOffset={0}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747230949637,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -214,30 +214,29 @@\n                   <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n               </View>\r\n             </View>\r\n-\r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-                <Text>Home</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-                <Text>History</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-                <Text>Chats</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-                <Text>Profile</Text>\r\n-              </TouchableOpacity>\r\n-            </View>\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n+      <View style={styles.bottomNav}>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+          <Text>Home</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+          <Text>History</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+          <Text>Chats</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity>\r\n+          <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+          <Text>Profile</Text>\r\n+        </TouchableOpacity>\r\n+      </View>\r\n     </KeyboardAvoidingView>\r\n   );\r\n }\r\n \r\n"
                },
                {
                    "date": 1747230968225,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -214,29 +214,30 @@\n                   <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n               </View>\r\n             </View>\r\n+\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+                <Text>Home</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+                <Text>History</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+                <Text>Chats</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+                <Text>Profile</Text>\r\n+              </TouchableOpacity>\r\n+            </View>\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n-      <View style={styles.bottomNav}>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-          <Text>Home</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-          <Text>History</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-          <Text>Chats</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity>\r\n-          <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-          <Text>Profile</Text>\r\n-        </TouchableOpacity>\r\n-      </View>\r\n     </KeyboardAvoidingView>\r\n   );\r\n }\r\n \r\n"
                },
                {
                    "date": 1747231021794,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,8 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={0}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747231765941,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,8 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? -31 : 0}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747231791909,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? -31 : 0}\r\n+      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747231810086,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -148,9 +148,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={Platform.OS === \"ios\" ? 0 : 30}\r\n+      keyboardVerticalOffset={0}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747231829717,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,10 +30,11 @@\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n-  console.log(\"OSRM_BASE_URL is\", OSRM_BASE_URL);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n \r\n+\r\n   // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n   //   if (!location) return;\r\n   //   try {\r\n   //     const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n"
                },
                {
                    "date": 1747231852829,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -140,9 +140,24 @@\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking.\");\r\n     }\r\n   };\r\n+  \r\n+  useEffect(() => {\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n+      setKeyboardOffset(0); // or positive value if needed\r\n+    });\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n+      setKeyboardOffset(-30); // adjust to neutralize bottom nav padding\r\n+    });\r\n \r\n+    return () => {\r\n+      showSub.remove();\r\n+      hideSub.remove();\r\n+    };\r\n+  }, []);\r\n+\r\n+\r\n   if (loading || !location) {\r\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n"
                },
                {
                    "date": 1747231875763,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -140,9 +140,9 @@\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking.\");\r\n     }\r\n   };\r\n-  \r\n+\r\n   useEffect(() => {\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n       setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n@@ -164,9 +164,9 @@\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={0}\r\n+      keyboardVerticalOffset={keyboardOffset}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n"
                },
                {
                    "date": 1747231891664,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -146,9 +146,9 @@\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n       setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      setKeyboardOffset(-30); // adjust to neutralize bottom nav padding\r\n+      setKeyboardOffset(-31); // adjust to neutralize bottom nav padding\r\n     });\r\n \r\n     return () => {\r\n       showSub.remove();\r\n"
                },
                {
                    "date": 1747231898505,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -146,9 +146,9 @@\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n       setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      setKeyboardOffset(-31); // adjust to neutralize bottom nav padding\r\n+      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n     });\r\n \r\n     return () => {\r\n       showSub.remove();\r\n"
                },
                {
                    "date": 1747231917906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -142,14 +142,16 @@\n     }\r\n   };\r\n \r\n   useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n+      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n+    });\r\n+    \r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n       setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n-    });\r\n+    \r\n \r\n     return () => {\r\n       showSub.remove();\r\n       hideSub.remove();\r\n"
                },
                {
                    "date": 1747232023056,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,10 @@\n   Platform,\r\n   ScrollView,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n+  Animated,\r\n+  Easing,\r\n } from \"react-native\";\r\n import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -30,8 +32,9 @@\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n+  const animatedOffset = useRef(new Animated.Value(0)).current;\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n \r\n \r\n   // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n@@ -145,14 +148,13 @@\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n       setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n     });\r\n-    \r\n+\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n       setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n     \r\n-\r\n     return () => {\r\n       showSub.remove();\r\n       hideSub.remove();\r\n     };\r\n"
                },
                {
                    "date": 1747232048221,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -145,23 +145,34 @@\n     }\r\n   };\r\n \r\n   useEffect(() => {\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n+      Animated.timing(animatedOffset, {\r\n+        toValue: 0, // adjust if needed\r\n+        duration: 200,\r\n+        useNativeDriver: false,\r\n+        easing: Easing.out(Easing.ease),\r\n+      }).start();\r\n+    });\r\n+\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n+      Animated.timing(animatedOffset, {\r\n+        toValue: -30, // or whatever offset you need to fix nav gap\r\n+        duration: 200,\r\n+        useNativeDriver: false,\r\n+        easing: Easing.inOut(Easing.ease),\r\n+      }).start();\r\n     });\r\n \r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n-      setKeyboardOffset(0); // or positive value if needed\r\n-    });\r\n-    \r\n     return () => {\r\n       showSub.remove();\r\n       hideSub.remove();\r\n     };\r\n   }, []);\r\n \r\n \r\n+\r\n   if (loading || !location) {\r\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n"
                },
                {
                    "date": 1747232102757,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,92 +182,94 @@\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n       keyboardVerticalOffset={keyboardOffset}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+        <Animated.View style={[styles.card, { marginBottom: animatedOffset }]}>\r\n+          <View style={styles.container}>\r\n+            <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n-          {mapHtml && (\r\n-            <WebView\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) mapRef.current = ref;\r\n-              }}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onMessage={(event) => {\r\n-                const data = JSON.parse(event.nativeEvent.data);\r\n-                setDestination(data);\r\n-              }}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-            />\r\n-          )}\r\n+            {mapHtml && (\r\n+              <WebView\r\n+                ref={(ref) => {\r\n+                  if (ref && !mapRef.current) mapRef.current = ref;\r\n+                }}\r\n+                originWhitelist={[\"*\"]}\r\n+                source={{ html: mapHtml }}\r\n+                javaScriptEnabled\r\n+                onMessage={(event) => {\r\n+                  const data = JSON.parse(event.nativeEvent.data);\r\n+                  setDestination(data);\r\n+                }}\r\n+                style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+              />\r\n+            )}\r\n \r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.card}>\r\n-              <View style={styles.cardHeader} />\r\n+            <View style={styles.overlayContainer}>\r\n+              <View style={styles.card}>\r\n+                <View style={styles.cardHeader} />\r\n \r\n-              <TouchableOpacity style={styles.inputBox}>\r\n-                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                <Text style={styles.inputText}>\r\n-                  {destination\r\n-                    ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-                    : \"Saan ka papunta ngayon?\"}\r\n-                </Text>\r\n-                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-              </TouchableOpacity>\r\n+                <TouchableOpacity style={styles.inputBox}>\r\n+                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                  <Text style={styles.inputText}>\r\n+                    {destination\r\n+                      ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+                      : \"Saan ka papunta ngayon?\"}\r\n+                  </Text>\r\n+                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+                </TouchableOpacity>\r\n \r\n-              <TextInput\r\n-                style={styles.inputBoxSimple}\r\n-                placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                value={destinationLabel}\r\n-                onChangeText={setDestinationLabel}\r\n-              />\r\n+                <TextInput\r\n+                  style={styles.inputBoxSimple}\r\n+                  placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                  value={destinationLabel}\r\n+                  onChangeText={setDestinationLabel}\r\n+                />\r\n \r\n-              <TextInput\r\n-                style={styles.inputBoxSimple}\r\n-                placeholder=\"Notes sa driver\"\r\n-                value={notes}\r\n-                onChangeText={setNotes}\r\n-              />\r\n+                <TextInput\r\n+                  style={styles.inputBoxSimple}\r\n+                  placeholder=\"Notes sa driver\"\r\n+                  value={notes}\r\n+                  onChangeText={setNotes}\r\n+                />\r\n \r\n-              <TextInput\r\n-                style={styles.inputBox}\r\n-                placeholder=\"Paano ka magbabayad\"\r\n-                value={paymentMethod}\r\n-                onChangeText={setPaymentMethod}\r\n-              />\r\n+                <TextInput\r\n+                  style={styles.inputBox}\r\n+                  placeholder=\"Paano ka magbabayad\"\r\n+                  value={paymentMethod}\r\n+                  onChangeText={setPaymentMethod}\r\n+                />\r\n \r\n-              <View style={styles.totalFareContainer}>\r\n-                <View style={styles.fareBox}>\r\n-                  <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+                <View style={styles.totalFareContainer}>\r\n+                  <View style={styles.fareBox}>\r\n+                    <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+                  </View>\r\n+                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n+                    <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n                 </View>\r\n-                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n-                  <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+              </View>\r\n+\r\n+              <View style={styles.bottomNav}>\r\n+                <TouchableOpacity>\r\n+                  <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+                  <Text>Home</Text>\r\n                 </TouchableOpacity>\r\n+                <TouchableOpacity>\r\n+                  <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+                  <Text>History</Text>\r\n+                </TouchableOpacity>\r\n+                <TouchableOpacity>\r\n+                  <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+                  <Text>Chats</Text>\r\n+                </TouchableOpacity>\r\n+                <TouchableOpacity>\r\n+                  <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+                  <Text>Profile</Text>\r\n+                </TouchableOpacity>\r\n               </View>\r\n             </View>\r\n-\r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-                <Text>Home</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-                <Text>History</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-                <Text>Chats</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-                <Text>Profile</Text>\r\n-              </TouchableOpacity>\r\n-            </View>\r\n           </View>\r\n-        </View>\r\n+        </Animated.View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n   );\r\n }\r\n"
                },
                {
                    "date": 1747232133712,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -182,94 +182,92 @@\n       behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n       keyboardVerticalOffset={keyboardOffset}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <Animated.View style={[styles.card, { marginBottom: animatedOffset }]}>\r\n-          <View style={styles.container}>\r\n-            <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n-            {mapHtml && (\r\n-              <WebView\r\n-                ref={(ref) => {\r\n-                  if (ref && !mapRef.current) mapRef.current = ref;\r\n-                }}\r\n-                originWhitelist={[\"*\"]}\r\n-                source={{ html: mapHtml }}\r\n-                javaScriptEnabled\r\n-                onMessage={(event) => {\r\n-                  const data = JSON.parse(event.nativeEvent.data);\r\n-                  setDestination(data);\r\n-                }}\r\n-                style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-              />\r\n-            )}\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) mapRef.current = ref;\r\n+              }}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onMessage={(event) => {\r\n+                const data = JSON.parse(event.nativeEvent.data);\r\n+                setDestination(data);\r\n+              }}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+            />\r\n+          )}\r\n \r\n-            <View style={styles.overlayContainer}>\r\n-              <View style={styles.card}>\r\n-                <View style={styles.cardHeader} />\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.card}>\r\n+              <View style={styles.cardHeader} />\r\n \r\n-                <TouchableOpacity style={styles.inputBox}>\r\n-                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                  <Text style={styles.inputText}>\r\n-                    {destination\r\n-                      ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-                      : \"Saan ka papunta ngayon?\"}\r\n-                  </Text>\r\n-                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-                </TouchableOpacity>\r\n+              <TouchableOpacity style={styles.inputBox}>\r\n+                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                <Text style={styles.inputText}>\r\n+                  {destination\r\n+                    ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+                    : \"Saan ka papunta ngayon?\"}\r\n+                </Text>\r\n+                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+              </TouchableOpacity>\r\n \r\n-                <TextInput\r\n-                  style={styles.inputBoxSimple}\r\n-                  placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                  value={destinationLabel}\r\n-                  onChangeText={setDestinationLabel}\r\n-                />\r\n+              <TextInput\r\n+                style={styles.inputBoxSimple}\r\n+                placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                value={destinationLabel}\r\n+                onChangeText={setDestinationLabel}\r\n+              />\r\n \r\n-                <TextInput\r\n-                  style={styles.inputBoxSimple}\r\n-                  placeholder=\"Notes sa driver\"\r\n-                  value={notes}\r\n-                  onChangeText={setNotes}\r\n-                />\r\n+              <TextInput\r\n+                style={styles.inputBoxSimple}\r\n+                placeholder=\"Notes sa driver\"\r\n+                value={notes}\r\n+                onChangeText={setNotes}\r\n+              />\r\n \r\n-                <TextInput\r\n-                  style={styles.inputBox}\r\n-                  placeholder=\"Paano ka magbabayad\"\r\n-                  value={paymentMethod}\r\n-                  onChangeText={setPaymentMethod}\r\n-                />\r\n+              <TextInput\r\n+                style={styles.inputBox}\r\n+                placeholder=\"Paano ka magbabayad\"\r\n+                value={paymentMethod}\r\n+                onChangeText={setPaymentMethod}\r\n+              />\r\n \r\n-                <View style={styles.totalFareContainer}>\r\n-                  <View style={styles.fareBox}>\r\n-                    <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  </View>\r\n-                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n-                    <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n+              <View style={styles.totalFareContainer}>\r\n+                <View style={styles.fareBox}>\r\n+                  <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n                 </View>\r\n-              </View>\r\n-\r\n-              <View style={styles.bottomNav}>\r\n-                <TouchableOpacity>\r\n-                  <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-                  <Text>Home</Text>\r\n+                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n+                  <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n-                <TouchableOpacity>\r\n-                  <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-                  <Text>History</Text>\r\n-                </TouchableOpacity>\r\n-                <TouchableOpacity>\r\n-                  <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-                  <Text>Chats</Text>\r\n-                </TouchableOpacity>\r\n-                <TouchableOpacity>\r\n-                  <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-                  <Text>Profile</Text>\r\n-                </TouchableOpacity>\r\n               </View>\r\n             </View>\r\n+\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n+                <Text>Home</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+                <Text>History</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n+                <Text>Chats</Text>\r\n+              </TouchableOpacity>\r\n+              <TouchableOpacity>\r\n+                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+                <Text>Profile</Text>\r\n+              </TouchableOpacity>\r\n+            </View>\r\n           </View>\r\n-        </Animated.View>\r\n+        </View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n   );\r\n }\r\n"
                },
                {
                    "date": 1747232163442,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,10 +12,8 @@\n   Platform,\r\n   ScrollView,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n-  Animated,\r\n-  Easing,\r\n } from \"react-native\";\r\n import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -32,9 +30,8 @@\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n-  const animatedOffset = useRef(new Animated.Value(0)).current;\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n \r\n \r\n   // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n@@ -145,34 +142,23 @@\n     }\r\n   };\r\n \r\n   useEffect(() => {\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n-      Animated.timing(animatedOffset, {\r\n-        toValue: 0, // adjust if needed\r\n-        duration: 200,\r\n-        useNativeDriver: false,\r\n-        easing: Easing.out(Easing.ease),\r\n-      }).start();\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n+      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n     });\r\n \r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      Animated.timing(animatedOffset, {\r\n-        toValue: -30, // or whatever offset you need to fix nav gap\r\n-        duration: 200,\r\n-        useNativeDriver: false,\r\n-        easing: Easing.inOut(Easing.ease),\r\n-      }).start();\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n+      setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n-\r\n+    \r\n     return () => {\r\n       showSub.remove();\r\n       hideSub.remove();\r\n     };\r\n   }, []);\r\n \r\n \r\n-\r\n   if (loading || !location) {\r\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n"
                },
                {
                    "date": 1747234017537,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,8 +12,10 @@\n   Platform,\r\n   ScrollView,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n+  Animated, \r\n+  Easing\r\n } from \"react-native\";\r\n import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -31,8 +33,9 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const animatedOffset = useRef(new Animated.Value(0)).current;\r\n \r\n \r\n   // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n   //   if (!location) return;\r\n@@ -142,33 +145,40 @@\n     }\r\n   };\r\n \r\n   useEffect(() => {\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n+      Animated.timing(animatedOffset, {\r\n+        toValue: 0,\r\n+        duration: 200,\r\n+        easing: Easing.out(Easing.ease),\r\n+        useNativeDriver: false,\r\n+      }).start();\r\n+    });\r\n+\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n+      Animated.timing(animatedOffset, {\r\n+        toValue: -35,\r\n+        duration: 200,\r\n+        easing: Easing.out(Easing.ease),\r\n+        useNativeDriver: false,\r\n+      }).start();\r\n     });\r\n \r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n-      setKeyboardOffset(0); // or positive value if needed\r\n-    });\r\n-    \r\n     return () => {\r\n       showSub.remove();\r\n       hideSub.remove();\r\n     };\r\n   }, []);\r\n \r\n \r\n+\r\n   if (loading || !location) {\r\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n   return (\r\n-    <KeyboardAvoidingView\r\n-      style={{ flex: 1 }}\r\n-      behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n-      keyboardVerticalOffset={keyboardOffset}\r\n-    >\r\n+    <View style={[styles.overlayContainer, { marginBottom: animatedOffset }]}>\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n@@ -253,9 +263,9 @@\n             </View>\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n+    </View>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n"
                },
                {
                    "date": 1747234246717,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,10 +34,12 @@\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const animatedOffset = useRef(new Animated.Value(0)).current;\r\n+  const cardOffsetAnim = useRef(new Animated.Value(0)).current;\r\n \r\n \r\n+\r\n   // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n   //   if (!location) return;\r\n   //   try {\r\n   //     const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n@@ -145,34 +147,33 @@\n     }\r\n   };\r\n \r\n   useEffect(() => {\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n-      Animated.timing(animatedOffset, {\r\n-        toValue: 0,\r\n+    const show = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n+      Animated.timing(cardOffsetAnim, {\r\n+        toValue: 35, // move card up\r\n         duration: 200,\r\n-        easing: Easing.out(Easing.ease),\r\n         useNativeDriver: false,\r\n       }).start();\r\n     });\r\n \r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      Animated.timing(animatedOffset, {\r\n-        toValue: -35,\r\n+    const hide = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n+      Animated.timing(cardOffsetAnim, {\r\n+        toValue: 0, // move card back down\r\n         duration: 200,\r\n-        easing: Easing.out(Easing.ease),\r\n         useNativeDriver: false,\r\n       }).start();\r\n     });\r\n \r\n     return () => {\r\n-      showSub.remove();\r\n-      hideSub.remove();\r\n+      show.remove();\r\n+      hide.remove();\r\n     };\r\n   }, []);\r\n \r\n \r\n \r\n+\r\n   if (loading || !location) {\r\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n@@ -198,9 +199,9 @@\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n-            <View style={styles.card}>\r\n+            <Animated.View style={[styles.card, { bottom: 75 + cardOffsetAnim }]}>\r\n               <View style={styles.cardHeader} />\r\n \r\n               <TouchableOpacity style={styles.inputBox}>\r\n                 <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n@@ -240,9 +241,9 @@\n                 <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n                   <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n               </View>\r\n-            </View>\r\n+            </Animated.View>\r\n \r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity>\r\n                 <Ionicons name=\"home\" size={30} color=\"black\" />\r\n"
                },
                {
                    "date": 1747234309069,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,10 +12,8 @@\n   Platform,\r\n   ScrollView,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n-  Animated, \r\n-  Easing\r\n } from \"react-native\";\r\n import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -33,13 +31,10 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType | null>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const animatedOffset = useRef(new Animated.Value(0)).current;\r\n-  const cardOffsetAnim = useRef(new Animated.Value(0)).current;\r\n \r\n \r\n-\r\n   // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n   //   if (!location) return;\r\n   //   try {\r\n   //     const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n@@ -147,39 +142,33 @@\n     }\r\n   };\r\n \r\n   useEffect(() => {\r\n-    const show = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n-      Animated.timing(cardOffsetAnim, {\r\n-        toValue: 35, // move card up\r\n-        duration: 200,\r\n-        useNativeDriver: false,\r\n-      }).start();\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n+      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n     });\r\n \r\n-    const hide = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      Animated.timing(cardOffsetAnim, {\r\n-        toValue: 0, // move card back down\r\n-        duration: 200,\r\n-        useNativeDriver: false,\r\n-      }).start();\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n+      setKeyboardOffset(0); // or positive value if needed\r\n     });\r\n-\r\n+    \r\n     return () => {\r\n-      show.remove();\r\n-      hide.remove();\r\n+      showSub.remove();\r\n+      hideSub.remove();\r\n     };\r\n   }, []);\r\n \r\n \r\n-\r\n-\r\n   if (loading || !location) {\r\n     return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n   }\r\n \r\n   return (\r\n-    <View style={[styles.overlayContainer, { marginBottom: animatedOffset }]}>\r\n+    <KeyboardAvoidingView\r\n+      style={{ flex: 1 }}\r\n+      behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n+      keyboardVerticalOffset={keyboardOffset}\r\n+    >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n \r\n@@ -199,9 +188,9 @@\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n-            <Animated.View style={[styles.card, { bottom: 75 + cardOffsetAnim }]}>\r\n+            <View style={styles.card}>\r\n               <View style={styles.cardHeader} />\r\n \r\n               <TouchableOpacity style={styles.inputBox}>\r\n                 <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n@@ -241,9 +230,9 @@\n                 <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n                   <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                 </TouchableOpacity>\r\n               </View>\r\n-            </Animated.View>\r\n+            </View>\r\n \r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity>\r\n                 <Ionicons name=\"home\" size={30} color=\"black\" />\r\n@@ -264,9 +253,9 @@\n             </View>\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n-    </View>\r\n+    </KeyboardAvoidingView>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n"
                },
                {
                    "date": 1747234369502,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -164,9 +164,9 @@\n \r\n   return (\r\n     <KeyboardAvoidingView\r\n       style={{ flex: 1 }}\r\n-      behavior={Platform.OS === \"ios\" ? \"padding\" : \"height\"}\r\n+      behavior={Platform.OS === \"ios\" ? \"padding\" : undefined}\r\n       keyboardVerticalOffset={keyboardOffset}\r\n     >\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n"
                },
                {
                    "date": 1747234553648,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,54 +186,57 @@\n               }}\r\n               style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n-\r\n           <View style={styles.overlayContainer}>\r\n-            <View style={styles.card}>\r\n-              <View style={styles.cardHeader} />\r\n+            <ScrollView\r\n+              contentContainerStyle={{ flexGrow: 1 }}\r\n+              keyboardShouldPersistTaps=\"handled\"\r\n+            >\r\n+              <View style={styles.card}>\r\n+                <View style={styles.cardHeader} />\r\n \r\n-              <TouchableOpacity style={styles.inputBox}>\r\n-                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                <Text style={styles.inputText}>\r\n-                  {destination\r\n-                    ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-                    : \"Saan ka papunta ngayon?\"}\r\n-                </Text>\r\n-                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-              </TouchableOpacity>\r\n+                <TouchableOpacity style={styles.inputBox}>\r\n+                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                  <Text style={styles.inputText}>\r\n+                    {destination\r\n+                      ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n+                      : \"Saan ka papunta ngayon?\"}\r\n+                  </Text>\r\n+                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+                </TouchableOpacity>\r\n \r\n-              <TextInput\r\n-                style={styles.inputBoxSimple}\r\n-                placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                value={destinationLabel}\r\n-                onChangeText={setDestinationLabel}\r\n-              />\r\n+                <TextInput\r\n+                  style={styles.inputBoxSimple}\r\n+                  placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                  value={destinationLabel}\r\n+                  onChangeText={setDestinationLabel}\r\n+                />\r\n \r\n-              <TextInput\r\n-                style={styles.inputBoxSimple}\r\n-                placeholder=\"Notes sa driver\"\r\n-                value={notes}\r\n-                onChangeText={setNotes}\r\n-              />\r\n+                <TextInput\r\n+                  style={styles.inputBoxSimple}\r\n+                  placeholder=\"Notes sa driver\"\r\n+                  value={notes}\r\n+                  onChangeText={setNotes}\r\n+                />\r\n \r\n-              <TextInput\r\n-                style={styles.inputBox}\r\n-                placeholder=\"Paano ka magbabayad\"\r\n-                value={paymentMethod}\r\n-                onChangeText={setPaymentMethod}\r\n-              />\r\n+                <TextInput\r\n+                  style={styles.inputBox}\r\n+                  placeholder=\"Paano ka magbabayad\"\r\n+                  value={paymentMethod}\r\n+                  onChangeText={setPaymentMethod}\r\n+                />\r\n \r\n-              <View style={styles.totalFareContainer}>\r\n-                <View style={styles.fareBox}>\r\n-                  <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+                <View style={styles.totalFareContainer}>\r\n+                  <View style={styles.fareBox}>\r\n+                    <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n+                  </View>\r\n+                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n+                    <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n                 </View>\r\n-                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n-                  <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n-                </TouchableOpacity>\r\n               </View>\r\n-            </View>\r\n-\r\n+            </ScrollView>            \r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity>\r\n                 <Ionicons name=\"home\" size={30} color=\"black\" />\r\n                 <Text>Home</Text>\r\n"
                },
                {
                    "date": 1747234575252,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -190,8 +190,9 @@\n           <View style={styles.overlayContainer}>\r\n             <ScrollView\r\n               contentContainerStyle={{ flexGrow: 1 }}\r\n               keyboardShouldPersistTaps=\"handled\"\r\n+              \r\n             >\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n \r\n@@ -266,8 +267,9 @@\n     flex: 1,\r\n     backgroundColor: \"#fff\",\r\n   },\r\n   overlayContainer: {\r\n+    paddingBottom: Platform.OS === \"android\" ? 20 : 0,\r\n     position: \"absolute\",\r\n     bottom: 0,\r\n     width: \"100%\",\r\n     alignItems: \"center\",\r\n"
                },
                {
                    "date": 1747234601403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,9 +158,9 @@\n   }, []);\r\n \r\n \r\n   if (loading || !location) {\r\n-    return <View style={{ flex: 1, backgroundColor: \"#fff\" }} />;\r\n+    return null;\r\n   }\r\n \r\n   return (\r\n     <KeyboardAvoidingView\r\n@@ -190,9 +190,8 @@\n           <View style={styles.overlayContainer}>\r\n             <ScrollView\r\n               contentContainerStyle={{ flexGrow: 1 }}\r\n               keyboardShouldPersistTaps=\"handled\"\r\n-              \r\n             >\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n \r\n"
                },
                {
                    "date": 1747234617788,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -187,12 +187,8 @@\n               style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n           <View style={styles.overlayContainer}>\r\n-            <ScrollView\r\n-              contentContainerStyle={{ flexGrow: 1 }}\r\n-              keyboardShouldPersistTaps=\"handled\"\r\n-            >\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n \r\n                 <TouchableOpacity style={styles.inputBox}>\r\n@@ -233,10 +229,9 @@\n                   <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n                     <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n                   </TouchableOpacity>\r\n                 </View>\r\n-              </View>\r\n-            </ScrollView>            \r\n+              </View>          \r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity>\r\n                 <Ionicons name=\"home\" size={30} color=\"black\" />\r\n                 <Text>Home</Text>\r\n"
                },
                {
                    "date": 1747235946746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,8 +18,9 @@\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL } from \"../../config\";\r\n+import { API_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1747236015860,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,9 +125,9 @@\n       notes,\r\n     };\r\n \r\n     try {\r\n-      const res = await fetch(\"https://your-backend-url/api/book\", {\r\n+      const res = await fetch(\"${API_BASE_URL}/api/book\", {\r\n         method: \"POST\",\r\n         headers: {\r\n           \"Content-Type\": \"application/json\",\r\n         },\r\n"
                },
                {
                    "date": 1747236033680,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,9 +125,9 @@\n       notes,\r\n     };\r\n \r\n     try {\r\n-      const res = await fetch(\"${API_BASE_URL}/api/book\", {\r\n+      const res = await fetch(\"https://your-backend-url/api/book\", {\r\n         method: \"POST\",\r\n         headers: {\r\n           \"Content-Type\": \"application/json\",\r\n         },\r\n"
                },
                {
                    "date": 1747236194635,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -114,36 +114,42 @@\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n \r\n-    const simulatedBookingData = {\r\n+    const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n       destinationLng: destination.longitude,\r\n-      fare: 20,\r\n-      paymentMethod: \"cash\",\r\n+      fare: 20, // static fare for now\r\n+      paymentMethod: \"cash\", // assuming default\r\n       notes,\r\n     };\r\n \r\n     try {\r\n-      const res = await fetch(\"https://your-backend-url/api/book\", {\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n         method: \"POST\",\r\n         headers: {\r\n           \"Content-Type\": \"application/json\",\r\n         },\r\n-        body: JSON.stringify(simulatedBookingData),\r\n+        body: JSON.stringify(bookingData),\r\n       });\r\n \r\n-      const data = await res.json();\r\n-      console.log(\"‚úÖ Backend response:\", data);\r\n+      const result = await response.json();\r\n+\r\n+      if (!response.ok) {\r\n+        throw new Error(result.message || \"Something went wrong\");\r\n+      }\r\n+\r\n+      console.log(\"‚úÖ Booking sent:\", result);\r\n       Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n     } catch (error) {\r\n       console.error(\"‚ùå Booking error:\", error);\r\n-      Alert.alert(\"Error\", \"Failed to send booking.\");\r\n+      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n     }\r\n   };\r\n \r\n+\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n       setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n     });\r\n"
                },
                {
                    "date": 1747246718004,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,58 +9,32 @@\n   TextInput,\r\n   Alert,\r\n   KeyboardAvoidingView,\r\n   Platform,\r\n-  ScrollView,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n } from \"react-native\";\r\n-import { WebViewMessageEvent, WebView } from \"react-native-webview\";\r\n+import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import { OSRM_BASE_URL } from \"../../config\";\r\n-import { API_BASE_URL } from \"../../config\";\r\n+import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destination, setDestination] = useState(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType | null>(null);\r\n+  const mapRef = useRef(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState(null);\r\n+  const [bookingId, setBookingId] = useState(null);\r\n \r\n-\r\n-  // const calculateFare = async (dest: { latitude: number; longitude: number }) => {\r\n-  //   if (!location) return;\r\n-  //   try {\r\n-  //     const url = `${OSRM_BASE_URL}/route/v1/driving/${location.longitude},${location.latitude};${dest.longitude},${dest.latitude}?geometries=geojson`;\r\n-  //     console.log(\"üì° Fetching route from:\", url);\r\n-  //     const res = await fetch(url);\r\n-  //     if (!res.ok) throw new Error(\"Failed to fetch route\");\r\n-\r\n-  //     const data = await res.json();\r\n-  //     if (!data.routes || data.routes.length === 0) return;\r\n-\r\n-  //     const distanceKm = data.routes[0].distance / 1000;\r\n-  //     console.log(distanceKm)\r\n-  //     const calculatedFare = distanceKm <= 2 ? 20 : 20 + Math.ceil(distanceKm - 2) * 5;\r\n-  //     console.log(calculatedFare)\r\n-  //     setFare(calculatedFare);\r\n-\r\n-  //     const coords = data.routes[0].geometry.coordinates.map((p: [number, number]) => [p[1], p[0]]);\r\n-  //     const message = JSON.stringify({ type: \"drawRoute\", coords });\r\n-  //     mapRef.current?.postMessage(message);\r\n-  //   } catch (err) {\r\n-  //     console.error(\"Fare calculation error:\", err);\r\n-  //   }\r\n-  // };\r\n-\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -119,10 +93,10 @@\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n       destinationLng: destination.longitude,\r\n-      fare: 20, // static fare for now\r\n-      paymentMethod: \"cash\", // assuming default\r\n+      fare: 20,\r\n+      paymentMethod: \"cash\",\r\n       notes,\r\n     };\r\n \r\n     try {\r\n@@ -134,128 +108,112 @@\n         body: JSON.stringify(bookingData),\r\n       });\r\n \r\n       const result = await response.json();\r\n-\r\n-      if (!response.ok) {\r\n-        throw new Error(result.message || \"Something went wrong\");\r\n-      }\r\n-\r\n-      console.log(\"‚úÖ Booking sent:\", result);\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+      setBookingId(result.booking.id);\r\n       Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n     } catch (error) {\r\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n     }\r\n   };\r\n \r\n-\r\n   useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => {\r\n-      setKeyboardOffset(-35); // adjust to neutralize bottom nav padding\r\n-    });\r\n-\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => {\r\n-      setKeyboardOffset(0); // or positive value if needed\r\n-    });\r\n-    \r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => {\r\n       showSub.remove();\r\n       hideSub.remove();\r\n     };\r\n   }, []);\r\n \r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find(b => b.id === bookingId);\r\n+        if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n+          setMatchedDriver(myBooking);\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Poll error:\", err);\r\n+      }\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n \r\n-  if (loading || !location) {\r\n-    return null;\r\n-  }\r\n+  if (loading || !location) return null;\r\n \r\n   return (\r\n-    <KeyboardAvoidingView\r\n-      style={{ flex: 1 }}\r\n-      behavior={Platform.OS === \"ios\" ? \"padding\" : undefined}\r\n-      keyboardVerticalOffset={keyboardOffset}\r\n-    >\r\n+    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent={true} backgroundColor=\"black\" />\r\n-\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n           {mapHtml && (\r\n             <WebView\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) mapRef.current = ref;\r\n-              }}\r\n+              ref={(ref) => ref && !mapRef.current && (mapRef.current = ref)}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n-              onMessage={(event) => {\r\n-                const data = JSON.parse(event.nativeEvent.data);\r\n-                setDestination(data);\r\n-              }}\r\n+              onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n               style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n+\r\n           <View style={styles.overlayContainer}>\r\n-              <View style={styles.card}>\r\n-                <View style={styles.cardHeader} />\r\n-\r\n-                <TouchableOpacity style={styles.inputBox}>\r\n-                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                  <Text style={styles.inputText}>\r\n-                    {destination\r\n-                      ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}`\r\n-                      : \"Saan ka papunta ngayon?\"}\r\n-                  </Text>\r\n-                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-                </TouchableOpacity>\r\n-\r\n-                <TextInput\r\n-                  style={styles.inputBoxSimple}\r\n-                  placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                  value={destinationLabel}\r\n-                  onChangeText={setDestinationLabel}\r\n-                />\r\n-\r\n-                <TextInput\r\n-                  style={styles.inputBoxSimple}\r\n-                  placeholder=\"Notes sa driver\"\r\n-                  value={notes}\r\n-                  onChangeText={setNotes}\r\n-                />\r\n-\r\n-                <TextInput\r\n-                  style={styles.inputBox}\r\n-                  placeholder=\"Paano ka magbabayad\"\r\n-                  value={paymentMethod}\r\n-                  onChangeText={setPaymentMethod}\r\n-                />\r\n-\r\n-                <View style={styles.totalFareContainer}>\r\n-                  <View style={styles.fareBox}>\r\n-                    <Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  </View>\r\n-                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}>\r\n-                    <Text style={styles.bookNowText}>BOOK NOW</Text>\r\n+            <View style={styles.card}>\r\n+              <View style={styles.cardHeader} />\r\n+              <TouchableOpacity style={styles.inputBox}>\r\n+                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                <Text style={styles.inputText}>\r\n+                  {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n+                </Text>\r\n+                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+              </TouchableOpacity>\r\n+              <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+              <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+              <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+              <View style={styles.totalFareContainer}>\r\n+                <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n+                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n+              </View>\r\n+              {matchedDriver && (\r\n+                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  <Text>Driver ID: {matchedDriver.driverId}</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={async () => {\r\n+                      try {\r\n+                        const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n+                          method: \"POST\",\r\n+                          headers: { \"Content-Type\": \"application/json\" },\r\n+                          body: JSON.stringify({ bookingId }),\r\n+                        });\r\n+                        const data = await res.json();\r\n+                        Alert.alert(\"Confirmed\", \"You accepted the driver!\");\r\n+                        setMatchedDriver(null);\r\n+                      } catch (error) {\r\n+                        console.error(\"‚ùå Confirm error:\", error);\r\n+                      }\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#3cba54\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CONFIRM DRIVER</Text>\r\n                   </TouchableOpacity>\r\n                 </View>\r\n-              </View>          \r\n+              )}\r\n+            </View>\r\n+\r\n             <View style={styles.bottomNav}>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"home\" size={30} color=\"black\" />\r\n-                <Text>Home</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-                <Text>History</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" />\r\n-                <Text>Chats</Text>\r\n-              </TouchableOpacity>\r\n-              <TouchableOpacity>\r\n-                <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-                <Text>Profile</Text>\r\n-              </TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n             </View>\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n@@ -263,89 +221,18 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: {\r\n-    flex: 1,\r\n-    backgroundColor: \"#fff\",\r\n-  },\r\n-  overlayContainer: {\r\n-    paddingBottom: Platform.OS === \"android\" ? 20 : 0,\r\n-    position: \"absolute\",\r\n-    bottom: 0,\r\n-    width: \"100%\",\r\n-    alignItems: \"center\",\r\n-  },\r\n-  card: {\r\n-    position: \"absolute\",\r\n-    bottom: 75,\r\n-    backgroundColor: \"#81C3E1\",\r\n-    width: width * 0.95,\r\n-    alignSelf: \"center\",\r\n-    borderRadius: 10,\r\n-    padding: 10,\r\n-  },\r\n-  cardHeader: {\r\n-    width: 150,\r\n-    height: 4,\r\n-    backgroundColor: \"black\",\r\n-    alignSelf: \"center\",\r\n-    borderRadius: 5,\r\n-    marginBottom: 10,\r\n-  },\r\n-  inputBox: {\r\n-    backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n-    flexDirection: \"row\",\r\n-    alignItems: \"center\",\r\n-    justifyContent: \"space-between\",\r\n-    paddingHorizontal: 10,\r\n-    height: 40,\r\n-    marginBottom: 5,\r\n-  },\r\n-  inputBoxSimple: {\r\n-    backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n-    flexDirection: \"row\",\r\n-    alignItems: \"center\",\r\n-    paddingHorizontal: 10,\r\n-    height: 40,\r\n-    marginBottom: 5,\r\n-  },\r\n+  container: { flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n+  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n+  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n+  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n   totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n-  fareBox: {\r\n-    flex: 1,\r\n-    borderRadius: 3,\r\n-    backgroundColor: \"white\",\r\n-    justifyContent: \"center\",\r\n-    paddingHorizontal: 5,\r\n-    marginRight: 5,\r\n-    width: '50%',\r\n-  },\r\n+  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n   totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n-  bookNowButton: {\r\n-    flex: 1,\r\n-    backgroundColor: \"white\",\r\n-    borderRadius: 8,\r\n-    alignItems: \"center\",\r\n-    justifyContent: \"center\",\r\n-    padding: 5,\r\n-    marginLeft: 5,\r\n-    width: '50%',\r\n-  },\r\n+  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n   bookNowText: { fontSize: 16 },\r\n-  bottomNav: {\r\n-    position: \"absolute\",\r\n-    bottom: 0,\r\n-    flexDirection: \"row\",\r\n-    justifyContent: \"space-around\",\r\n-    width: width,\r\n-    height: 70,\r\n-    backgroundColor: \"white\",\r\n-    borderTopLeftRadius: 30,\r\n-    borderTopRightRadius: 30,\r\n-    alignItems: \"center\",\r\n-    borderWidth: 1,\r\n-    borderColor: \"black\",\r\n-  },\r\n+  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n"
                },
                {
                    "date": 1747247186770,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,9 +22,9 @@\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState(null);\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [fare, setFare] = useState(20);\r\n@@ -133,9 +133,9 @@\n       if (!bookingId) return;\r\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n         const allBookings = await res.json();\r\n-        const myBooking = allBookings.find(b => b.id === bookingId);\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n         if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n           setMatchedDriver(myBooking);\r\n         }\r\n       } catch (err) {\r\n@@ -154,9 +154,11 @@\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n           {mapHtml && (\r\n             <WebView\r\n-              ref={(ref) => ref && !mapRef.current && (mapRef.current = ref)}\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) mapRef.current = ref;\r\n+              }}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n               onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n@@ -183,9 +185,9 @@\n               </View>\r\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  <Text>Driver ID: {matchedDriver.driverId}</Text>\r\n+                  <Text>Driver ID: {matchedDriver?.driverId}</Text>\r\n                   <TouchableOpacity\r\n                     onPress={async () => {\r\n                       try {\r\n                         const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n"
                },
                {
                    "date": 1747247543146,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -28,9 +28,9 @@\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef(null);\r\n+  const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n@@ -155,9 +155,11 @@\n           <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n           {mapHtml && (\r\n             <WebView\r\n               ref={(ref) => {\r\n-                if (ref && !mapRef.current) mapRef.current = ref;\r\n+                if (ref && !mapRef.current) {\r\n+                  mapRef.current = ref;\r\n+                }\r\n               }}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n"
                },
                {
                    "date": 1747247754703,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -109,16 +109,23 @@\n       });\r\n \r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      // ‚¨áÔ∏è Save booking ID for polling\r\n       setBookingId(result.booking.id);\r\n+\r\n+      // ‚¨áÔ∏è Manually attach driverId (this is the key fix)\r\n+      setMatchedDriver({ ...result.booking, driverId: result.matchedDriverId });\r\n+\r\n       Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n     } catch (error) {\r\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n     }\r\n   };\r\n \r\n+\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => {\r\n"
                },
                {
                    "date": 1747248648487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,9 +30,9 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState(null);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{ driverId: string } | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n"
                },
                {
                    "date": 1747251726198,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -194,9 +194,8 @@\n               </View>\r\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  <Text>Driver ID: {matchedDriver?.driverId}</Text>\r\n                   <TouchableOpacity\r\n                     onPress={async () => {\r\n                       try {\r\n                         const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n"
                },
                {
                    "date": 1747252019158,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,9 +30,9 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{ driverId: string } | null>(null);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n@@ -194,8 +194,9 @@\n               </View>\r\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  <Text> Name: {matchedDriver?.driverName}</Text>\r\n                   <TouchableOpacity\r\n                     onPress={async () => {\r\n                       try {\r\n                         const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n"
                },
                {
                    "date": 1747252114361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,8 +33,10 @@\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n+  console.log(matchedDriver?.driverName)\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -195,8 +197,9 @@\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   <Text> Name: {matchedDriver?.driverName}</Text>\r\n+                  \r\n                   <TouchableOpacity\r\n                     onPress={async () => {\r\n                       try {\r\n                         const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n"
                },
                {
                    "date": 1747252568360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,8 +17,9 @@\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n@@ -30,13 +31,11 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n+  const [matchedDriver, setMatchedDriver] = useState(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n-  console.log(matchedDriver?.driverName)\r\n-\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -83,8 +82,14 @@\n     `;\r\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n+  try {\r\n+    const driverId = await AsyncStorage.getItem(\"driverId\");\r\n+    const driverName = await AsyncStorage.getItem(\"driverName\");\r\n+  } catch (error) {\r\n+    console.error(\"‚ùå Failed to update driver status:\", error);\r\n+  }\r\n \r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n"
                },
                {
                    "date": 1747252892464,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,9 +17,8 @@\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n@@ -31,11 +30,13 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState(null);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n+  console.log(matchedDriver?.driverName)\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -82,14 +83,8 @@\n     `;\r\n \r\n     setMapHtml(html);\r\n   }, [location]);\r\n-  try {\r\n-    const driverId = await AsyncStorage.getItem(\"driverId\");\r\n-    const driverName = await AsyncStorage.getItem(\"driverName\");\r\n-  } catch (error) {\r\n-    console.error(\"‚ùå Failed to update driver status:\", error);\r\n-  }\r\n \r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n"
                },
                {
                    "date": 1747408380173,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,259 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  StyleSheet,\r\n+  Dimensions,\r\n+  TouchableOpacity,\r\n+  StatusBar,\r\n+  TextInput,\r\n+  Alert,\r\n+  KeyboardAvoidingView,\r\n+  Platform,\r\n+  TouchableWithoutFeedback,\r\n+  Keyboard,\r\n+} from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+\r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(20);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n+  const [bookingId, setBookingId] = useState(null);\r\n+\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n+\r\n+    const html = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n+            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+              maxZoom: 19,\r\n+              attribution: '¬© OpenStreetMap contributors'\r\n+            }).addTo(map);\r\n+\r\n+            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+\r\n+            let destMarker = null;\r\n+            let routeLine = null;\r\n+\r\n+            map.on('click', function(e) {\r\n+              const { lat, lng } = e.latlng;\r\n+              if (destMarker) map.removeLayer(destMarker);\r\n+              if (routeLine) map.removeLayer(routeLine);\r\n+              destMarker = L.marker([lat, lng]).addTo(map);\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+            });\r\n+\r\n+            window.addEventListener('message', function(event) {\r\n+              const msg = JSON.parse(event.data);\r\n+              if (msg.type === 'drawRoute' && msg.coords) {\r\n+                if (routeLine) map.removeLayer(routeLine);\r\n+                routeLine = L.polyline(msg.coords, { color: 'red' }).addTo(map);\r\n+              }\r\n+            });\r\n+          </script>\r\n+        </body>\r\n+      </html>\r\n+    `;\r\n+\r\n+    setMapHtml(html);\r\n+  }, [location]);\r\n+\r\n+  \r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare: 20,\r\n+      paymentMethod: \"cash\",\r\n+      notes,\r\n+    };\r\n+\r\n+    try {\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: {\r\n+          \"Content-Type\": \"application/json\",\r\n+        },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      // ‚¨áÔ∏è Save booking ID for polling\r\n+      setBookingId(result.booking.id);\r\n+\r\n+      // ‚¨áÔ∏è Manually attach driverId (this is the key fix)\r\n+      setMatchedDriver({ ...result.booking, driverId: result.matchedDriverId });\r\n+\r\n+      Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Booking error:\", error);\r\n+      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => {\r\n+      showSub.remove();\r\n+      hideSub.remove();\r\n+    };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n+          setMatchedDriver(myBooking);\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Poll error:\", err);\r\n+      }\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    if (matchedDriver) {\r\n+      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n+    }\r\n+  }, [matchedDriver]);\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) {\r\n+                  mapRef.current = ref;\r\n+                }\r\n+              }}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.card}>\r\n+              <View style={styles.cardHeader} />\r\n+              <TouchableOpacity style={styles.inputBox}>\r\n+                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                <Text style={styles.inputText}>\r\n+                  {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n+                </Text>\r\n+                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+              </TouchableOpacity>\r\n+              <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+              <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+              <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+              <View style={styles.totalFareContainer}>\r\n+                <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n+                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n+              </View>\r\n+              {matchedDriver && (\r\n+                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  <Text> Name: {matchedDriver?.driverName}</Text>\r\n+                  \r\n+                  <TouchableOpacity\r\n+                    onPress={async () => {\r\n+                      try {\r\n+                        const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n+                          method: \"POST\",\r\n+                          headers: { \"Content-Type\": \"application/json\" },\r\n+                          body: JSON.stringify({ bookingId }),\r\n+                        });\r\n+                        const data = await res.json();\r\n+                        Alert.alert(\"Confirmed\", \"You accepted the driver!\");\r\n+                        setMatchedDriver(null);\r\n+                      } catch (error) {\r\n+                        console.error(\"‚ùå Confirm error:\", error);\r\n+                      }\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#3cba54\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CONFIRM DRIVER</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n+            </View>\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n+  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n+  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n+  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n+  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n+  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n+  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n+  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n+  bookNowText: { fontSize: 16 },\r\n+  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+});\r\n"
                },
                {
                    "date": 1747410096323,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,9 +30,9 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string; driverId:string} | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n \r\n   useEffect(() => {\r\n     if (!location) return;\r\n@@ -156,8 +156,9 @@\n   }, [bookingId]);\r\n \r\n   useEffect(() => {\r\n     if (matchedDriver) {\r\n+      console.log(\"üéØ Matched driver name (from state):\", matchedId.driverName);\r\n       console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n     }\r\n   }, [matchedDriver]);\r\n \r\n@@ -256,256 +257,4 @@\n   bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n   bookNowText: { fontSize: 16 },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import {\r\n-  View,\r\n-  Text,\r\n-  StyleSheet,\r\n-  Dimensions,\r\n-  TouchableOpacity,\r\n-  StatusBar,\r\n-  TextInput,\r\n-  Alert,\r\n-  KeyboardAvoidingView,\r\n-  Platform,\r\n-  TouchableWithoutFeedback,\r\n-  Keyboard,\r\n-} from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n-\r\n-const { width, height } = Dimensions.get(\"window\");\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(20);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string } | null>(null);\r\n-  const [bookingId, setBookingId] = useState(null);\r\n-\r\n-  console.log(matchedDriver?.driverName)\r\n-\r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n-\r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n-            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-              maxZoom: 19,\r\n-              attribution: '¬© OpenStreetMap contributors'\r\n-            }).addTo(map);\r\n-\r\n-            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n-\r\n-            let destMarker = null;\r\n-            let routeLine = null;\r\n-\r\n-            map.on('click', function(e) {\r\n-              const { lat, lng } = e.latlng;\r\n-              if (destMarker) map.removeLayer(destMarker);\r\n-              if (routeLine) map.removeLayer(routeLine);\r\n-              destMarker = L.marker([lat, lng]).addTo(map);\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-            });\r\n-\r\n-            window.addEventListener('message', function(event) {\r\n-              const msg = JSON.parse(event.data);\r\n-              if (msg.type === 'drawRoute' && msg.coords) {\r\n-                if (routeLine) map.removeLayer(routeLine);\r\n-                routeLine = L.polyline(msg.coords, { color: 'red' }).addTo(map);\r\n-              }\r\n-            });\r\n-          </script>\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-\r\n-    setMapHtml(html);\r\n-  }, [location]);\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare: 20,\r\n-      paymentMethod: \"cash\",\r\n-      notes,\r\n-    };\r\n-\r\n-    try {\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: {\r\n-          \"Content-Type\": \"application/json\",\r\n-        },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      // ‚¨áÔ∏è Save booking ID for polling\r\n-      setBookingId(result.booking.id);\r\n-\r\n-      // ‚¨áÔ∏è Manually attach driverId (this is the key fix)\r\n-      setMatchedDriver({ ...result.booking, driverId: result.matchedDriverId });\r\n-\r\n-      Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Booking error:\", error);\r\n-      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => {\r\n-      showSub.remove();\r\n-      hideSub.remove();\r\n-    };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let interval;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n-          setMatchedDriver(myBooking);\r\n-        }\r\n-      } catch (err) {\r\n-        console.error(\"‚ùå Poll error:\", err);\r\n-      }\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) {\r\n-                  mapRef.current = ref;\r\n-                }\r\n-              }}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.card}>\r\n-              <View style={styles.cardHeader} />\r\n-              <TouchableOpacity style={styles.inputBox}>\r\n-                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                <Text style={styles.inputText}>\r\n-                  {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n-                </Text>\r\n-                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-              </TouchableOpacity>\r\n-              <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-              <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-              <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-              <View style={styles.totalFareContainer}>\r\n-                <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n-                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n-              </View>\r\n-              {matchedDriver && (\r\n-                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  <Text> Name: {matchedDriver?.driverName}</Text>\r\n-                  \r\n-                  <TouchableOpacity\r\n-                    onPress={async () => {\r\n-                      try {\r\n-                        const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n-                          method: \"POST\",\r\n-                          headers: { \"Content-Type\": \"application/json\" },\r\n-                          body: JSON.stringify({ bookingId }),\r\n-                        });\r\n-                        const data = await res.json();\r\n-                        Alert.alert(\"Confirmed\", \"You accepted the driver!\");\r\n-                        setMatchedDriver(null);\r\n-                      } catch (error) {\r\n-                        console.error(\"‚ùå Confirm error:\", error);\r\n-                      }\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#3cba54\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CONFIRM DRIVER</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n-            </View>\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n-  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n-  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n-  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n-  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n-  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n-  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n-  bookNowText: { fontSize: 16 },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n-});\r\n"
                },
                {
                    "date": 1747410113524,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,9 +156,9 @@\n   }, [bookingId]);\r\n \r\n   useEffect(() => {\r\n     if (matchedDriver) {\r\n-      console.log(\"üéØ Matched driver name (from state):\", matchedId.driverName);\r\n+      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverId);\r\n       console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n     }\r\n   }, [matchedDriver]);\r\n \r\n"
                },
                {
                    "date": 1747412546631,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -204,9 +204,9 @@\n               </View>\r\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  <Text> Name: {matchedDriver?.driverName}</Text>\r\n+                  <Text>Name: {matchedDriver?.driverName}</Text>\r\n                   \r\n                   <TouchableOpacity\r\n                     onPress={async () => {\r\n                       try {\r\n"
                },
                {
                    "date": 1747412742102,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -112,14 +112,17 @@\n \r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n \r\n-      // ‚¨áÔ∏è Save booking ID for polling\r\n-      setBookingId(result.booking.id);\r\n+      setBookingId(result.booking.id); \r\n+      setMatchedDriver(result.booking.driverId);\r\n \r\n-      // ‚¨áÔ∏è Manually attach driverId (this is the key fix)\r\n-      setMatchedDriver({ ...result.booking, driverId: result.matchedDriverId });\r\n+      // Fetch full driver info using the returned driverId\r\n+      const res = await fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`);\r\n+      const data = await res.json();\r\n+      setMatchedDriver(data.driver); \r\n \r\n+\r\n       Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n     } catch (error) {\r\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n"
                },
                {
                    "date": 1747412803051,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,42 +95,43 @@\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n       destinationLng: destination.longitude,\r\n-      fare: 20,\r\n-      paymentMethod: \"cash\",\r\n+      fare,\r\n+      paymentMethod,\r\n       notes,\r\n+      passengerName: \"Anonymous\", // or retrieve from storage if needed\r\n     };\r\n \r\n     try {\r\n       const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n         method: \"POST\",\r\n-        headers: {\r\n-          \"Content-Type\": \"application/json\",\r\n-        },\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify(bookingData),\r\n       });\r\n \r\n       const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n \r\n-      setBookingId(result.booking.id); \r\n+      if (!response.ok) {\r\n+        throw new Error(result.message || \"Something went wrong\");\r\n+      }\r\n+\r\n+      setBookingId(result.booking.id);\r\n       setMatchedDriver(result.booking.driverId);\r\n \r\n-      // Fetch full driver info using the returned driverId\r\n       const res = await fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`);\r\n       const data = await res.json();\r\n-      setMatchedDriver(data.driver); \r\n+      setMatchedDriver(data.driver);\r\n \r\n-\r\n       Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n     } catch (error) {\r\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n     }\r\n   };\r\n \r\n \r\n+\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => {\r\n"
                },
                {
                    "date": 1747415641348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,9 +32,11 @@\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{ driverName: string; driverId:string} | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n \r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n"
                },
                {
                    "date": 1747415750874,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -191,52 +191,70 @@\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n-            <View style={styles.card}>\r\n-              <View style={styles.cardHeader} />\r\n-              <TouchableOpacity style={styles.inputBox}>\r\n-                <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                <Text style={styles.inputText}>\r\n-                  {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n-                </Text>\r\n-                <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-              </TouchableOpacity>\r\n-              <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-              <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-              <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-              <View style={styles.totalFareContainer}>\r\n-                <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n-                <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n+            {showBookingForm && (\r\n+              <View style={styles.card}>\r\n+                <View style={styles.cardHeader} />\r\n+                <TouchableOpacity style={styles.inputBox}>\r\n+                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                  <Text style={styles.inputText}>\r\n+                    {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n+                  </Text>\r\n+                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+                </TouchableOpacity>\r\n+                <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                <View style={styles.totalFareContainer}>\r\n+                  <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n+                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n+                </View>\r\n+                {matchedDriver && (\r\n+                  <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                    <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                    <Text>Name: {matchedDriver?.driverName}</Text>\r\n+                    \r\n+                    <TouchableOpacity\r\n+                      onPress={async () => {\r\n+                        try {\r\n+                          const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n+                            method: \"POST\",\r\n+                            headers: { \"Content-Type\": \"application/json\" },\r\n+                            body: JSON.stringify({ bookingId }),\r\n+                          });\r\n+                          const data = await res.json();\r\n+                          Alert.alert(\"Confirmed\", \"You accepted the driver!\");\r\n+                          setMatchedDriver(null);\r\n+                        } catch (error) {\r\n+                          console.error(\"‚ùå Confirm error:\", error);\r\n+                        }\r\n+                      }}\r\n+                      style={{ backgroundColor: \"#3cba54\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                    >\r\n+                      <Text style={{ color: \"white\", textAlign: \"center\" }}>CONFIRM DRIVER</Text>\r\n+                    </TouchableOpacity>\r\n+                  </View>\r\n+                )}\r\n               </View>\r\n-              {matchedDriver && (\r\n-                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                  \r\n-                  <TouchableOpacity\r\n-                    onPress={async () => {\r\n-                      try {\r\n-                        const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n-                          method: \"POST\",\r\n-                          headers: { \"Content-Type\": \"application/json\" },\r\n-                          body: JSON.stringify({ bookingId }),\r\n-                        });\r\n-                        const data = await res.json();\r\n-                        Alert.alert(\"Confirmed\", \"You accepted the driver!\");\r\n-                        setMatchedDriver(null);\r\n-                      } catch (error) {\r\n-                        console.error(\"‚ùå Confirm error:\", error);\r\n-                      }\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#3cba54\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CONFIRM DRIVER</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n+            )}\r\n \r\n+            {!showBookingForm && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{\r\n+                  position: \"absolute\",\r\n+                  bottom: 85,\r\n+                  backgroundColor: \"#81C3E1\",\r\n+                  padding: 10,\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+\r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n"
                },
                {
                    "date": 1747415853376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,10 +56,23 @@\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n \r\n-            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+            const map = L.map('map', {\r\n+              zoomControl: false, // we'll reposition it manually\r\n+              dragging: true,\r\n+              scrollWheelZoom: true,\r\n+              touchZoom: true,\r\n+              doubleClickZoom: true,\r\n+              boxZoom: true,\r\n+            }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n+            L.control.zoom({\r\n+              position: 'topleft' // or 'topright', adjust based on UI\r\n+            }).addTo(map);\r\n+\r\n+\r\n+\r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n             map.on('click', function(e) {\r\n"
                },
                {
                    "date": 1747415906632,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -55,42 +55,9 @@\n             L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n-\r\n-            const map = L.map('map', {\r\n-              zoomControl: false, // we'll reposition it manually\r\n-              dragging: true,\r\n-              scrollWheelZoom: true,\r\n-              touchZoom: true,\r\n-              doubleClickZoom: true,\r\n-              boxZoom: true,\r\n-            }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-            L.control.zoom({\r\n-              position: 'topleft' // or 'topright', adjust based on UI\r\n-            }).addTo(map);\r\n-\r\n-\r\n-\r\n-            let destMarker = null;\r\n-            let routeLine = null;\r\n-\r\n-            map.on('click', function(e) {\r\n-              const { lat, lng } = e.latlng;\r\n-              if (destMarker) map.removeLayer(destMarker);\r\n-              if (routeLine) map.removeLayer(routeLine);\r\n-              destMarker = L.marker([lat, lng]).addTo(map);\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-            });\r\n-\r\n-            window.addEventListener('message', function(event) {\r\n-              const msg = JSON.parse(event.data);\r\n-              if (msg.type === 'drawRoute' && msg.coords) {\r\n-                if (routeLine) map.removeLayer(routeLine);\r\n-                routeLine = L.polyline(msg.coords, { color: 'red' }).addTo(map);\r\n-              }\r\n-            });\r\n+            L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n           </script>\r\n         </body>\r\n       </html>\r\n     `;\r\n"
                },
                {
                    "date": 1747415959391,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -166,9 +166,8 @@\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n               onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n"
                },
                {
                    "date": 1747416023267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -158,16 +158,14 @@\n           <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n           {mapHtml && (\r\n             <WebView\r\n               ref={(ref) => {\r\n-                if (ref && !mapRef.current) {\r\n-                  mapRef.current = ref;\r\n-                }\r\n+                if (ref && !mapRef.current) mapRef.current = ref;\r\n               }}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n-              onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n+              style={styles.map}\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n@@ -246,8 +244,9 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n+  map: { width: width, height: height, position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0,},\r\n   container: { flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n"
                },
                {
                    "date": 1747416144925,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -44,9 +44,14 @@\n       <html>\r\n         <head>\r\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style> html, body, #map { height: 100%; margin: 0; padding: 0; } </style>\r\n+          <style>\r\n+            html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }\r\n+            #map { height: 100vh; width: 100vw; position: relative; }\r\n+            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n+          </style>\r\n+\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n@@ -55,9 +60,42 @@\n             L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n-            L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+\r\n+            const map = L.map('map', {\r\n+              zoomControl: false, // we'll reposition it manually\r\n+              dragging: true,\r\n+              scrollWheelZoom: true,\r\n+              touchZoom: true,\r\n+              doubleClickZoom: true,\r\n+              boxZoom: true,\r\n+            }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+            L.control.zoom({\r\n+              position: 'topleft' // or 'topright', adjust based on UI\r\n+            }).addTo(map);\r\n+\r\n+\r\n+\r\n+            let destMarker = null;\r\n+            let routeLine = null;\r\n+\r\n+            map.on('click', function(e) {\r\n+              const { lat, lng } = e.latlng;\r\n+              if (destMarker) map.removeLayer(destMarker);\r\n+              if (routeLine) map.removeLayer(routeLine);\r\n+              destMarker = L.marker([lat, lng]).addTo(map);\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+            });\r\n+\r\n+            window.addEventListener('message', function(event) {\r\n+              const msg = JSON.parse(event.data);\r\n+              if (msg.type === 'drawRoute' && msg.coords) {\r\n+                if (routeLine) map.removeLayer(routeLine);\r\n+                routeLine = L.polyline(msg.coords, { color: 'red' }).addTo(map);\r\n+              }\r\n+            });\r\n           </script>\r\n         </body>\r\n       </html>\r\n     `;\r\n@@ -158,14 +196,17 @@\n           <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n           {mapHtml && (\r\n             <WebView\r\n               ref={(ref) => {\r\n-                if (ref && !mapRef.current) mapRef.current = ref;\r\n+                if (ref && !mapRef.current) {\r\n+                  mapRef.current = ref;\r\n+                }\r\n               }}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n-              style={styles.map}\r\n+              onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n@@ -244,9 +285,8 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  map: { width: width, height: height, position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0,},\r\n   container: { flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n"
                },
                {
                    "date": 1747416219642,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -49,35 +49,31 @@\n             html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }\r\n             #map { height: 100vh; width: 100vw; position: relative; }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n           </style>\r\n-\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n-            const map = L.map('map').setView([${location.latitude}, ${location.longitude}], 15);\r\n-            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-              maxZoom: 19,\r\n-              attribution: '¬© OpenStreetMap contributors'\r\n-            }).addTo(map);\r\n-\r\n             const map = L.map('map', {\r\n-              zoomControl: false, // we'll reposition it manually\r\n+              zoomControl: false,\r\n               dragging: true,\r\n               scrollWheelZoom: true,\r\n               touchZoom: true,\r\n               doubleClickZoom: true,\r\n               boxZoom: true,\r\n             }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n-            L.control.zoom({\r\n-              position: 'topleft' // or 'topright', adjust based on UI\r\n+            L.control.zoom({ position: 'topleft' }).addTo(map);\r\n+\r\n+            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+              maxZoom: 19,\r\n+              attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n \r\n+            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n \r\n-\r\n             let destMarker = null;\r\n             let routeLine = null;\r\n \r\n             map.on('click', function(e) {\r\n@@ -99,8 +95,9 @@\n         </body>\r\n       </html>\r\n     `;\r\n \r\n+\r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n   \r\n"
                },
                {
                    "date": 1747416297539,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -46,9 +46,16 @@\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n           <style>\r\n             html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }\r\n-            #map { height: 100vh; width: 100vw; position: relative; }\r\n+            #map {\r\n+              height: 100vh;\r\n+              width: 100vw;\r\n+              position: relative;\r\n+              padding-top: 40px;   /* Top padding for zoom controls */\r\n+              padding-bottom: 80px; /* Bottom padding for booking panel */\r\n+              box-sizing: border-box;\r\n+            }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n           </style>\r\n         </head>\r\n         <body>\r\n"
                },
                {
                    "date": 1747416328443,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -289,9 +289,9 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, backgroundColor: \"#fff\" },\r\n+  container: {paddingTop: 10,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747416337837,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -289,9 +289,9 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: {paddingTop: 10,flex: 1, backgroundColor: \"#fff\" },\r\n+  container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747416587447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -206,14 +206,30 @@\n                 }\r\n               }}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n+              javaScriptEnabled={true}\r\n+              scrollEnabled={false} // Let the map handle scrolling\r\n+              allowsFullscreenVideo={true}\r\n+              androidHardwareAccelerationDisabled={false}\r\n+              androidLayerType=\"hardware\"\r\n+              mixedContentMode=\"always\"\r\n+              overScrollMode=\"never\"\r\n+              setSupportMultipleWindows={false}\r\n+              allowUniversalAccessFromFileURLs={true}\r\n+              style={{\r\n+                position: \"absolute\",\r\n+                top: 0,\r\n+                left: 0,\r\n+                right: 0,\r\n+                bottom: 0,\r\n+                zIndex: 0,\r\n+              }}\r\n               onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}\r\n             />\r\n           )}\r\n \r\n+\r\n           <View style={styles.overlayContainer}>\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n"
                },
                {
                    "date": 1747416874637,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -210,9 +210,9 @@\n               javaScriptEnabled={true}\r\n               scrollEnabled={false} // Let the map handle scrolling\r\n               allowsFullscreenVideo={true}\r\n               androidHardwareAccelerationDisabled={false}\r\n-              androidLayerType=\"hardware\"\r\n+              androidLayerType=\"none\"\r\n               mixedContentMode=\"always\"\r\n               overScrollMode=\"never\"\r\n               setSupportMultipleWindows={false}\r\n               allowUniversalAccessFromFileURLs={true}\r\n"
                },
                {
                    "date": 1747416908977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,8 +68,9 @@\n               scrollWheelZoom: true,\r\n               touchZoom: true,\r\n               doubleClickZoom: true,\r\n               boxZoom: true,\r\n+              gestureHandling: true,\r\n             }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n             L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1747417070024,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -45,9 +45,16 @@\n         <head>\r\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n           <style>\r\n-            html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }\r\n+            html, body, #map {\r\n+              height: 100%;\r\n+              margin: 0;\r\n+              padding: 0;\r\n+              overflow: hidden;\r\n+              touch-action: auto;\r\n+            }\r\n+\r\n             #map {\r\n               height: 100vh;\r\n               width: 100vw;\r\n               position: relative;\r\n"
                },
                {
                    "date": 1747417130842,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -52,17 +52,8 @@\n               padding: 0;\r\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n-\r\n-            #map {\r\n-              height: 100vh;\r\n-              width: 100vw;\r\n-              position: relative;\r\n-              padding-top: 40px;   /* Top padding for zoom controls */\r\n-              padding-bottom: 80px; /* Bottom padding for booking panel */\r\n-              box-sizing: border-box;\r\n-            }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n           </style>\r\n         </head>\r\n         <body>\r\n@@ -215,16 +206,8 @@\n               }}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled={true}\r\n-              scrollEnabled={false} // Let the map handle scrolling\r\n-              allowsFullscreenVideo={true}\r\n-              androidHardwareAccelerationDisabled={false}\r\n-              androidLayerType=\"none\"\r\n-              mixedContentMode=\"always\"\r\n-              overScrollMode=\"never\"\r\n-              setSupportMultipleWindows={false}\r\n-              allowUniversalAccessFromFileURLs={true}\r\n               style={{\r\n                 position: \"absolute\",\r\n                 top: 0,\r\n                 left: 0,\r\n"
                },
                {
                    "date": 1747417169592,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,8 +57,9 @@\n           </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet-gesture-handling\"></script>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             const map = L.map('map', {\r\n               zoomControl: false,\r\n@@ -66,9 +67,8 @@\n               scrollWheelZoom: true,\r\n               touchZoom: true,\r\n               doubleClickZoom: true,\r\n               boxZoom: true,\r\n-              gestureHandling: true,\r\n             }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n             L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1747417384216,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,9 +16,8 @@\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n-import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1747417407252,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -16,8 +16,9 @@\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n+import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1747417583265,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,10 +33,13 @@\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{ driverName: string; driverId:string} | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n \r\n \r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n"
                },
                {
                    "date": 1747417605669,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,35 +124,56 @@\n       destinationLng: destination.longitude,\r\n       fare,\r\n       paymentMethod,\r\n       notes,\r\n-      passengerName: \"Anonymous\", // or retrieve from storage if needed\r\n+      passengerName: \"Anonymous\",\r\n     };\r\n \r\n     try {\r\n+      setShowBookingForm(false); // hide form\r\n+      setSearching(true);        // show searching state\r\n+\r\n       const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n         method: \"POST\",\r\n         headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify(bookingData),\r\n       });\r\n \r\n       const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n \r\n-      if (!response.ok) {\r\n-        throw new Error(result.message || \"Something went wrong\");\r\n-      }\r\n-\r\n       setBookingId(result.booking.id);\r\n-      setMatchedDriver(result.booking.driverId);\r\n \r\n-      const res = await fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`);\r\n-      const data = await res.json();\r\n-      setMatchedDriver(data.driver);\r\n+      // Start polling for driver for up to 10 minutes\r\n+      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n+      const startTime = Date.now();\r\n \r\n-      Alert.alert(\"Success\", \"Booking sent successfully.\");\r\n+      const poll = async () => {\r\n+        try {\r\n+          const res = await fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`);\r\n+          const data = await res.json();\r\n+          if (data?.driver) {\r\n+            setMatchedDriver(data.driver);\r\n+            setSearching(false);\r\n+            return;\r\n+          }\r\n+        } catch (err) {\r\n+          console.log(\"‚è≥ Still waiting for driver...\");\r\n+        }\r\n+\r\n+        if (Date.now() - startTime < maxWaitTime) {\r\n+          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n+        } else {\r\n+          setSearching(false); // stop searching silently\r\n+          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n+        }\r\n+      };\r\n+\r\n+      poll(); // start polling\r\n     } catch (error) {\r\n       console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n     }\r\n   };\r\n \r\n \r\n"
                },
                {
                    "date": 1747417775334,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -261,31 +261,42 @@\n                 <View style={styles.totalFareContainer}>\r\n                   <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n                   <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n                 </View>\r\n+                {searching && (\r\n+                  <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                    <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                    <TouchableOpacity\r\n+                      onPress={() => {\r\n+                        setSearching(false);\r\n+                        setBookingId(null);\r\n+                        if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                      }}\r\n+                      style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                    >\r\n+                      <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                    </TouchableOpacity>\r\n+                  </View>\r\n+                )}\r\n+\r\n+                {/* ‚úÖ Show this if driver is found */}\r\n                 {matchedDriver && (\r\n                   <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                     <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                    <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                    \r\n+                    <Text>Name: {matchedDriver.driverName}</Text>\r\n+                    <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                    <Text>Experience: {matchedDriver.experienceYears ?? \"N/A\"} years</Text>\r\n+\r\n                     <TouchableOpacity\r\n-                      onPress={async () => {\r\n-                        try {\r\n-                          const res = await fetch(`${API_BASE_URL}/api/confirm-driver`, {\r\n-                            method: \"POST\",\r\n-                            headers: { \"Content-Type\": \"application/json\" },\r\n-                            body: JSON.stringify({ bookingId }),\r\n-                          });\r\n-                          const data = await res.json();\r\n-                          Alert.alert(\"Confirmed\", \"You accepted the driver!\");\r\n-                          setMatchedDriver(null);\r\n-                        } catch (error) {\r\n-                          console.error(\"‚ùå Confirm error:\", error);\r\n-                        }\r\n+                      onPress={() => {\r\n+                        setMatchedDriver(null);\r\n+                        setBookingId(null);\r\n+                        setSearching(false);\r\n+                        if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                       }}\r\n-                      style={{ backgroundColor: \"#3cba54\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                      style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n                     >\r\n-                      <Text style={{ color: \"white\", textAlign: \"center\" }}>CONFIRM DRIVER</Text>\r\n+                      <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n                     </TouchableOpacity>\r\n                   </View>\r\n                 )}\r\n               </View>\r\n"
                },
                {
                    "date": 1747417849184,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -34,12 +34,13 @@\n   const [matchedDriver, setMatchedDriver] = useState<{ driverName: string; driverId:string} | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n \r\n \r\n \r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n"
                },
                {
                    "date": 1747417906362,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -284,10 +284,9 @@\n                   <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                     <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                     <Text>Name: {matchedDriver.driverName}</Text>\r\n                     <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                    <Text>Experience: {matchedDriver.experienceYears ?? \"N/A\"} years</Text>\r\n-\r\n+                    <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                     <TouchableOpacity\r\n                       onPress={() => {\r\n                         setMatchedDriver(null);\r\n                         setBookingId(null);\r\n"
                },
                {
                    "date": 1747418004496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,9 +30,14 @@\n   const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{ driverName: string; driverId:string} | null>(null);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber?: string;\r\n+    experienceYears?: string;\r\n+  } | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n"
                },
                {
                    "date": 1747418177696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,9 +66,8 @@\n           </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet-gesture-handling\"></script>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             const map = L.map('map', {\r\n               zoomControl: false,\r\n@@ -85,37 +84,63 @@\n               maxZoom: 19,\r\n               attribution: '¬© OpenStreetMap contributors'\r\n             }).addTo(map);\r\n \r\n-            const startMarker = L.marker([${location.latitude}, ${location.longitude}]).addTo(map);\r\n+            const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n+              icon: L.icon({\r\n+                iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+                iconSize: [30, 30],\r\n+              })\r\n+            }).addTo(map);\r\n \r\n             let destMarker = null;\r\n-            let routeLine = null;\r\n+            let driverMarker = null;\r\n \r\n             map.on('click', function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n-              if (routeLine) map.removeLayer(routeLine);\r\n-              destMarker = L.marker([lat, lng]).addTo(map);\r\n+              destMarker = L.marker([lat, lng], {\r\n+                icon: L.icon({\r\n+                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                  iconSize: [30, 30],\r\n+                })\r\n+              }).addTo(map);\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n-              if (msg.type === 'drawRoute' && msg.coords) {\r\n-                if (routeLine) map.removeLayer(routeLine);\r\n-                routeLine = L.polyline(msg.coords, { color: 'red' }).addTo(map);\r\n+              if (msg.type === 'setMarkers') {\r\n+                if (destMarker) map.removeLayer(destMarker);\r\n+                if (msg.destination) {\r\n+                  destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                    icon: L.icon({\r\n+                      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                      iconSize: [30, 30],\r\n+                    })\r\n+                  }).addTo(map);\r\n+                }\r\n+\r\n+                if (driverMarker) map.removeLayer(driverMarker);\r\n+                if (msg.driver) {\r\n+                  driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n+                    icon: L.icon({\r\n+                      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n+                      iconSize: [30, 30],\r\n+                    })\r\n+                  }).addTo(map);\r\n+                }\r\n               }\r\n             });\r\n           </script>\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n-\r\n     setMapHtml(html);\r\n   }, [location]);\r\n \r\n+\r\n   \r\n \r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n"
                },
                {
                    "date": 1747418210427,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -136,13 +136,29 @@\n       </html>\r\n     `;\r\n \r\n     setMapHtml(html);\r\n-  }, [location]);\r\n+    }, [location]);\r\n \r\n+    useEffect(() => {\r\n+    if (!mapRef.current) return;\r\n \r\n-  \r\n+    const driverCoords = matchedDriver?.location\r\n+      ? {\r\n+          latitude: matchedDriver.location.latitude,\r\n+          longitude: matchedDriver.location.longitude,\r\n+        }\r\n+      : null;\r\n \r\n+    mapRef.current.postMessage(\r\n+      JSON.stringify({\r\n+        type: \"setMarkers\",\r\n+        destination,\r\n+        driver: driverCoords,\r\n+      })\r\n+    );\r\n+  }, [destination, matchedDriver]);\r\n+\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n"
                },
                {
                    "date": 1747418338797,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,10 +33,10 @@\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{\r\n     driverName: string;\r\n     driverId: string;\r\n-    franchiseNumber?: string;\r\n-    experienceYears?: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n   } | null>(null);\r\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n"
                },
                {
                    "date": 1747418443121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,11 +33,13 @@\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{\r\n     driverName: string;\r\n     driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n+    franchiseNumber?: string;\r\n+    experienceYears?: string;\r\n+    location?: { latitude: number; longitude: number }; \r\n   } | null>(null);\r\n+\r\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n"
                },
                {
                    "date": 1747547744293,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,15 +33,15 @@\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{\r\n     driverName: string;\r\n     driverId: string;\r\n-    franchiseNumber?: string;\r\n-    experienceYears?: string;\r\n-    location?: { latitude: number; longitude: number }; \r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    location: { latitude: number; longitude: number }; \r\n   } | null>(null);\r\n \r\n   const [bookingId, setBookingId] = useState(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false); \r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n \r\n \r\n@@ -255,15 +255,28 @@\n     return () => clearInterval(interval);\r\n   }, [bookingId]);\r\n \r\n   useEffect(() => {\r\n-    if (matchedDriver) {\r\n-      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverId);\r\n-      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n-    }\r\n-  }, [matchedDriver]);\r\n+    if (!mapRef.current) return;\r\n \r\n+    const driverCoords = matchedDriver?.location\r\n+      ? {\r\n+          latitude: matchedDriver.location.latitude,\r\n+          longitude: matchedDriver.location.longitude,\r\n+        }\r\n+      : null;\r\n \r\n+    mapRef.current.postMessage(\r\n+      JSON.stringify({\r\n+        type: \"setMarkers\",\r\n+        destination,\r\n+        driver: driverCoords,\r\n+      })\r\n+    );\r\n+  }, [destination, matchedDriver]);\r\n+\r\n+\r\n+\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1747547801744,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -255,28 +255,15 @@\n     return () => clearInterval(interval);\r\n   }, [bookingId]);\r\n \r\n   useEffect(() => {\r\n-    if (!mapRef.current) return;\r\n+    if (matchedDriver) {\r\n+      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverId);\r\n+      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n+    }\r\n+  }, [matchedDriver]);\r\n+  \r\n \r\n-    const driverCoords = matchedDriver?.location\r\n-      ? {\r\n-          latitude: matchedDriver.location.latitude,\r\n-          longitude: matchedDriver.location.longitude,\r\n-        }\r\n-      : null;\r\n-\r\n-    mapRef.current.postMessage(\r\n-      JSON.stringify({\r\n-        type: \"setMarkers\",\r\n-        destination,\r\n-        driver: driverCoords,\r\n-      })\r\n-    );\r\n-  }, [destination, matchedDriver]);\r\n-\r\n-\r\n-\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1747548748894,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,9 +91,9 @@\n               icon: L.icon({\r\n                 iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n                 iconSize: [30, 30],\r\n               })\r\n-            }).addTo(map);\r\n+            }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n \r\n             let destMarker = null;\r\n             let driverMarker = null;\r\n \r\n@@ -104,23 +104,25 @@\n                 icon: L.icon({\r\n                   iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n                   iconSize: [30, 30],\r\n                 })\r\n-              }).addTo(map);\r\n+              }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+\r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n+\r\n               if (msg.type === 'setMarkers') {\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n                 if (msg.destination) {\r\n                   destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n                       iconSize: [30, 30],\r\n                     })\r\n-                  }).addTo(map);\r\n+                  }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n                 }\r\n \r\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n                 if (msg.driver) {\r\n@@ -128,13 +130,14 @@\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n                       iconSize: [30, 30],\r\n                     })\r\n-                  }).addTo(map);\r\n+                  }).addTo(map).bindTooltip(\"Driver\", { permanent: true, direction: \"top\" });\r\n                 }\r\n               }\r\n             });\r\n           </script>\r\n+\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n@@ -260,10 +263,10 @@\n       console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverId);\r\n       console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n     }\r\n   }, [matchedDriver]);\r\n-  \r\n \r\n+\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1747548945047,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -204,8 +204,9 @@\n           const res = await fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`);\r\n           const data = await res.json();\r\n           if (data?.driver) {\r\n             setMatchedDriver(data.driver);\r\n+            console.log(\"üö® DRIVER DATA FROM BACKEND:\", data.driver);\r\n             setSearching(false);\r\n             return;\r\n           }\r\n         } catch (err) {\r\n@@ -227,10 +228,8 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-\r\n-\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => {\r\n"
                },
                {
                    "date": 1747549092428,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -330,8 +330,9 @@\n                 )}\r\n \r\n                 {/* ‚úÖ Show this if driver is found */}\r\n                 {matchedDriver && (\r\n+                  console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n                   <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                     <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                     <Text>Name: {matchedDriver.driverName}</Text>\r\n                     <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n"
                },
                {
                    "date": 1747551585767,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -200,26 +200,31 @@\n       const startTime = Date.now();\r\n \r\n       const poll = async () => {\r\n         try {\r\n-          const res = await fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`);\r\n-          const data = await res.json();\r\n-          if (data?.driver) {\r\n-            setMatchedDriver(data.driver);\r\n-            console.log(\"üö® DRIVER DATA FROM BACKEND:\", data.driver);\r\n+          const [driverRes, statusRes] = await Promise.all([\r\n+            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n+            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n+          ]);\r\n+\r\n+          const driverData = await driverRes.json();\r\n+          const statusData = await statusRes.json();\r\n+\r\n+          if (driverData?.driver) {\r\n+            setMatchedDriver({\r\n+              driverName: driverData.driver.driverName,\r\n+              driverId: driverData.driver._id,\r\n+              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+              location: statusData.location || null, // Live GPS\r\n+            });\r\n+\r\n+            console.log(\"üö® DRIVER DATA FROM BACKEND:\", driverData.driver);\r\n+            console.log(\"üìç LIVE LOCATION:\", statusData.location);\r\n             setSearching(false);\r\n             return;\r\n           }\r\n-        } catch (err) {\r\n-          console.log(\"‚è≥ Still waiting for driver...\");\r\n         }\r\n-\r\n-        if (Date.now() - startTime < maxWaitTime) {\r\n-          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n-        } else {\r\n-          setSearching(false); // stop searching silently\r\n-          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n-        }\r\n       };\r\n \r\n       poll(); // start polling\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1747551635083,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -222,9 +222,19 @@\n             console.log(\"üìç LIVE LOCATION:\", statusData.location);\r\n             setSearching(false);\r\n             return;\r\n           }\r\n+\r\n+        } catch (err) {\r\n+          console.log(\"‚è≥ Still waiting for driver...\");\r\n         }\r\n+\r\n+        if (Date.now() - startTime < maxWaitTime) {\r\n+          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n+        } else {\r\n+          setSearching(false); // stop searching silently\r\n+          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n+        }\r\n       };\r\n \r\n       poll(); // start polling\r\n     } catch (error) {\r\n"
                },
                {
                    "date": 1747551736379,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -222,9 +222,8 @@\n             console.log(\"üìç LIVE LOCATION:\", statusData.location);\r\n             setSearching(false);\r\n             return;\r\n           }\r\n-\r\n         } catch (err) {\r\n           console.log(\"‚è≥ Still waiting for driver...\");\r\n         }\r\n \r\n@@ -310,8 +309,45 @@\n           )}\r\n \r\n \r\n           <View style={styles.overlayContainer}>\r\n+            {searching && (\r\n+              <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    setSearching(false);\r\n+                    setBookingId(null);\r\n+                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                  }}\r\n+                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                >\r\n+                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                </TouchableOpacity>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {/* ‚úÖ Show this if driver is found */}\r\n+            {matchedDriver && (\r\n+              console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n+              <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                <Text>Name: {matchedDriver.driverName}</Text>\r\n+                <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    setMatchedDriver(null);\r\n+                    setBookingId(null);\r\n+                    setSearching(false);\r\n+                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                  }}\r\n+                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                >\r\n+                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                </TouchableOpacity>\r\n+              </View>\r\n+            )}\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n                 <TouchableOpacity style={styles.inputBox}>\r\n@@ -327,45 +363,8 @@\n                 <View style={styles.totalFareContainer}>\r\n                   <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n                   <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n                 </View>\r\n-                {searching && (\r\n-                  <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                    <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                    <TouchableOpacity\r\n-                      onPress={() => {\r\n-                        setSearching(false);\r\n-                        setBookingId(null);\r\n-                        if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                      }}\r\n-                      style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                    >\r\n-                      <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                    </TouchableOpacity>\r\n-                  </View>\r\n-                )}\r\n-\r\n-                {/* ‚úÖ Show this if driver is found */}\r\n-                {matchedDriver && (\r\n-                  console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n-                  <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                    <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                    <Text>Name: {matchedDriver.driverName}</Text>\r\n-                    <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                    <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                    <TouchableOpacity\r\n-                      onPress={() => {\r\n-                        setMatchedDriver(null);\r\n-                        setBookingId(null);\r\n-                        setSearching(false);\r\n-                        if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                      }}\r\n-                      style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                    >\r\n-                      <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                    </TouchableOpacity>\r\n-                  </View>\r\n-                )}\r\n               </View>\r\n             )}\r\n \r\n             {!showBookingForm && (\r\n"
                },
                {
                    "date": 1747551767282,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -308,46 +308,48 @@\n             />\r\n           )}\r\n \r\n \r\n+          {searching && (\r\n+            <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+              <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+              <TouchableOpacity\r\n+                onPress={() => {\r\n+                  setSearching(false);\r\n+                  setBookingId(null);\r\n+                  if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                }}\r\n+                style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+              >\r\n+                <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+              </TouchableOpacity>\r\n+            </View>\r\n+          )}\r\n+\r\n+          {/* ‚úÖ Show this if driver is found */}\r\n+          {matchedDriver && (\r\n+            console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n+            <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+              <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+              <Text>Name: {matchedDriver.driverName}</Text>\r\n+              <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+              <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+              <TouchableOpacity\r\n+                onPress={() => {\r\n+                  setMatchedDriver(null);\r\n+                  setBookingId(null);\r\n+                  setSearching(false);\r\n+                  if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                }}\r\n+                style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+              >\r\n+                <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+              </TouchableOpacity>\r\n+            </View>\r\n+          )}\r\n+\r\n+\r\n           <View style={styles.overlayContainer}>\r\n-            {searching && (\r\n-              <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    setSearching(false);\r\n-                    setBookingId(null);\r\n-                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                  }}\r\n-                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                >\r\n-                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                </TouchableOpacity>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {/* ‚úÖ Show this if driver is found */}\r\n-            {matchedDriver && (\r\n-              console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n-              <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                <Text>Name: {matchedDriver.driverName}</Text>\r\n-                <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    setMatchedDriver(null);\r\n-                    setBookingId(null);\r\n-                    setSearching(false);\r\n-                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                  }}\r\n-                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                >\r\n-                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                </TouchableOpacity>\r\n-              </View>\r\n-            )}\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n                 <TouchableOpacity style={styles.inputBox}>\r\n"
                },
                {
                    "date": 1747551795812,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,49 +306,51 @@\n               }}\r\n               onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n             />\r\n           )}\r\n+          \r\n \r\n+          <View>\r\n+            {searching && (\r\n+              <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    setSearching(false);\r\n+                    setBookingId(null);\r\n+                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                  }}\r\n+                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                >\r\n+                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                </TouchableOpacity>\r\n+              </View>\r\n+            )}\r\n \r\n-          {searching && (\r\n-            <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-              <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-              <TouchableOpacity\r\n-                onPress={() => {\r\n-                  setSearching(false);\r\n-                  setBookingId(null);\r\n-                  if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                }}\r\n-                style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-              >\r\n-                <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-              </TouchableOpacity>\r\n-            </View>\r\n-          )}\r\n+            {/* ‚úÖ Show this if driver is found */}\r\n+            {matchedDriver && (\r\n+              console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n+              <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                <Text>Name: {matchedDriver.driverName}</Text>\r\n+                <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    setMatchedDriver(null);\r\n+                    setBookingId(null);\r\n+                    setSearching(false);\r\n+                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                  }}\r\n+                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                >\r\n+                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                </TouchableOpacity>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n \r\n-          {/* ‚úÖ Show this if driver is found */}\r\n-          {matchedDriver && (\r\n-            console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n-            <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-              <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-              <Text>Name: {matchedDriver.driverName}</Text>\r\n-              <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-              <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-              <TouchableOpacity\r\n-                onPress={() => {\r\n-                  setMatchedDriver(null);\r\n-                  setBookingId(null);\r\n-                  setSearching(false);\r\n-                  if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                }}\r\n-                style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-              >\r\n-                <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-              </TouchableOpacity>\r\n-            </View>\r\n-          )}\r\n \r\n-\r\n           <View style={styles.overlayContainer}>\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n"
                },
                {
                    "date": 1747551860213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -306,52 +306,49 @@\n               }}\r\n               onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n             />\r\n           )}\r\n-          \r\n \r\n-          <View>\r\n-            {searching && (\r\n-              <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    setSearching(false);\r\n-                    setBookingId(null);\r\n-                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                  }}\r\n-                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                >\r\n-                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                </TouchableOpacity>\r\n-              </View>\r\n-            )}\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n \r\n-            {/* ‚úÖ Show this if driver is found */}\r\n-            {matchedDriver && (\r\n-              console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n-              <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                <Text>Name: {matchedDriver.driverName}</Text>\r\n-                <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    setMatchedDriver(null);\r\n-                    setBookingId(null);\r\n-                    setSearching(false);\r\n-                    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                  }}\r\n-                  style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                >\r\n-                  <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                </TouchableOpacity>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n+              {/* ‚úÖ Show this if driver is found */}\r\n+              {matchedDriver && (\r\n+                console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n+                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  <Text>Name: {matchedDriver.driverName}</Text>\r\n+                  <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                  <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setMatchedDriver(null);\r\n+                      setBookingId(null);\r\n+                      setSearching(false);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n                 <TouchableOpacity style={styles.inputBox}>\r\n@@ -402,8 +399,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n+  overlay: {},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747551882202,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,9 +399,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {},\r\n+  overlay: {width: width},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747551895698,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,9 +399,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width},\r\n+  overlay: {width: width, marginHorizontal: 30},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747551915296,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,9 +399,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, marginHorizontal: 30},\r\n+  overlay: {width: width, marginHorizontal: 30, marginVertical: 30},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747551927075,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,9 +399,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, marginHorizontal: 30, marginVertical: 30},\r\n+  overlay: {width: width, margin: 50},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747551935068,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -399,9 +399,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, margin: 50},\r\n+  overlay: {width: width, margin: 60},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747552059119,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -35,8 +35,9 @@\n     driverName: string;\r\n     driverId: string;\r\n     franchiseNumber: string;\r\n     experienceYears: string;\r\n+    selfieImage: string;\r\n     location: { latitude: number; longitude: number }; \r\n   } | null>(null);\r\n \r\n   const [bookingId, setBookingId] = useState(null);\r\n"
                },
                {
                    "date": 1747552081010,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -215,8 +215,9 @@\n               driverName: driverData.driver.driverName,\r\n               driverId: driverData.driver._id,\r\n               franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n               experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n               location: statusData.location || null, // Live GPS\r\n             });\r\n \r\n             console.log(\"üö® DRIVER DATA FROM BACKEND:\", driverData.driver);\r\n"
                },
                {
                    "date": 1747552211887,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -401,9 +401,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, margin: 60},\r\n+  overlay: {width: width, margin: 100},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747552229993,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -401,9 +401,9 @@\n \r\n const styles = StyleSheet.create({\r\n   container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, margin: 100},\r\n+  overlay: {width: width, margin: 60},\r\n   card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n   cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n   inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n   inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n"
                },
                {
                    "date": 1747552905835,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,9 @@\n   KeyboardAvoidingView,\r\n   Platform,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n+  Image\r\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n@@ -329,11 +330,17 @@\n               )}\r\n \r\n               {/* ‚úÖ Show this if driver is found */}\r\n               {matchedDriver && (\r\n-                console.log(\"üß™ matchedDriver in UI:\", matchedDriver),\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  {matchedDriver.selfieImage && (\r\n+                    <Image\r\n+                      source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                      style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n+                    />\r\n+                  )}\r\n                   <Text>Name: {matchedDriver.driverName}</Text>\r\n                   <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                   <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                   <TouchableOpacity\r\n@@ -369,9 +376,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            {!showBookingForm && (\r\n+            {!matchedDriver && !searching && !showBookingForm && (\r\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n                 style={{\r\n                   position: \"absolute\",\r\n"
                },
                {
                    "date": 1747552927114,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -376,9 +376,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            {!matchedDriver && !searching && !showBookingForm && (\r\n+            {matchedDriver && !searching && !showBookingForm && (\r\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n                 style={{\r\n                   position: \"absolute\",\r\n"
                },
                {
                    "date": 1747552937480,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -376,9 +376,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            {matchedDriver && !searching && !showBookingForm && (\r\n+            {!matchedDriver && !searching && !showBookingForm && (\r\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n                 style={{\r\n                   position: \"absolute\",\r\n"
                },
                {
                    "date": 1747553190845,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -332,9 +332,8 @@\n               {/* ‚úÖ Show this if driver is found */}\r\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   {matchedDriver.selfieImage && (\r\n                     <Image\r\n                       source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n                       style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n"
                },
                {
                    "date": 1747555171264,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -333,8 +333,9 @@\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   {matchedDriver.selfieImage && (\r\n+                    console.log(\"üñº Selfie Image URL:\", matchedDriver.selfieImage),\r\n                     <Image\r\n                       source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n                       style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n                     />\r\n"
                },
                {
                    "date": 1747556637539,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,9 +65,20 @@\n               padding: 0;\r\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n-            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n+            .leaflet-control-zoom {\r\n+              top: 10px !important;\r\n+              left: 10px !important;\r\n+            }\r\n+            .driver-label {\r\n+              font-weight: bold;\r\n+              color: red;\r\n+              background: white;\r\n+              padding: 2px 5px;\r\n+              border-radius: 4px;\r\n+              font-size: 14px;\r\n+            }\r\n           </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n@@ -93,14 +104,16 @@\n               icon: L.icon({\r\n                 iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n                 iconSize: [30, 30],\r\n               })\r\n-            }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n+            }).addTo(map)\r\n+              .bindTooltip(\"üßç You\", { permanent: true, direction: \"top\" })\r\n+              .bringToBack();\r\n \r\n             let destMarker = null;\r\n             let driverMarker = null;\r\n \r\n-            map.on('click', function(e) {\r\n+            map.on('click', function (e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               destMarker = L.marker([lat, lng], {\r\n                 icon: L.icon({\r\n@@ -111,9 +124,9 @@\n \r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n-            window.addEventListener('message', function(event) {\r\n+            window.addEventListener('message', function (event) {\r\n               const msg = JSON.parse(event.data);\r\n \r\n               if (msg.type === 'setMarkers') {\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n@@ -126,20 +139,27 @@\n                   }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n                 }\r\n \r\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n-                if (msg.driver) {\r\n+                if (msg.driver && msg.driver.latitude && msg.driver.longitude) {\r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                      iconSize: [30, 30],\r\n+                      iconSize: [40, 40],\r\n+                      iconAnchor: [20, 40],\r\n+                      popupAnchor: [0, -40],\r\n                     })\r\n-                  }).addTo(map).bindTooltip(\"Driver\", { permanent: true, direction: \"top\" });\r\n+                  }).addTo(map)\r\n+                    .bindTooltip(\"üöï Driver\", {\r\n+                      permanent: true,\r\n+                      direction: \"top\",\r\n+                      className: \"driver-label\"\r\n+                    })\r\n+                    .bringToFront();\r\n                 }\r\n               }\r\n             });\r\n           </script>\r\n-\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n"
                },
                {
                    "date": 1747557081696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -65,12 +65,9 @@\n               padding: 0;\r\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n-            .leaflet-control-zoom {\r\n-              top: 10px !important;\r\n-              left: 10px !important;\r\n-            }\r\n+            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n             .driver-label {\r\n               font-weight: bold;\r\n               color: red;\r\n               background: white;\r\n@@ -79,8 +76,9 @@\n               font-size: 14px;\r\n             }\r\n           </style>\r\n         </head>\r\n+\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n@@ -124,8 +122,22 @@\n \r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n+            map.on('click', function(e) {\r\n+              const { lat, lng } = e.latlng;\r\n+              if (destMarker) map.removeLayer(destMarker);\r\n+              destMarker = L.marker([lat, lng], {\r\n+                icon: L.icon({\r\n+                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                  iconSize: [30, 30],\r\n+                })\r\n+              }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+            });\r\n+\r\n+\r\n             window.addEventListener('message', function (event) {\r\n               const msg = JSON.parse(event.data);\r\n \r\n               if (msg.type === 'setMarkers') {\r\n"
                },
                {
                    "date": 1747557174106,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,8 +66,9 @@\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n+\r\n             .driver-label {\r\n               font-weight: bold;\r\n               color: red;\r\n               background: white;\r\n@@ -151,9 +152,9 @@\n                   }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n                 }\r\n \r\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n-                if (msg.driver && msg.driver.latitude && msg.driver.longitude) {\r\n+                if (msg.driver) {\r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n                       iconSize: [40, 40],\r\n"
                },
                {
                    "date": 1747557192019,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,20 +66,10 @@\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n-\r\n-            .driver-label {\r\n-              font-weight: bold;\r\n-              color: red;\r\n-              background: white;\r\n-              padding: 2px 5px;\r\n-              border-radius: 4px;\r\n-              font-size: 14px;\r\n-            }\r\n           </style>\r\n         </head>\r\n-\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n@@ -103,28 +93,13 @@\n               icon: L.icon({\r\n                 iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n                 iconSize: [30, 30],\r\n               })\r\n-            }).addTo(map)\r\n-              .bindTooltip(\"üßç You\", { permanent: true, direction: \"top\" })\r\n-              .bringToBack();\r\n+            }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n \r\n             let destMarker = null;\r\n             let driverMarker = null;\r\n \r\n-            map.on('click', function (e) {\r\n-              const { lat, lng } = e.latlng;\r\n-              if (destMarker) map.removeLayer(destMarker);\r\n-              destMarker = L.marker([lat, lng], {\r\n-                icon: L.icon({\r\n-                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                  iconSize: [30, 30],\r\n-                })\r\n-              }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-            });\r\n-\r\n             map.on('click', function(e) {\r\n               const { lat, lng } = e.latlng;\r\n               if (destMarker) map.removeLayer(destMarker);\r\n               destMarker = L.marker([lat, lng], {\r\n@@ -136,10 +111,9 @@\n \r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n-\r\n-            window.addEventListener('message', function (event) {\r\n+            window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n \r\n               if (msg.type === 'setMarkers') {\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n@@ -156,23 +130,16 @@\n                 if (msg.driver) {\r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                      iconSize: [40, 40],\r\n-                      iconAnchor: [20, 40],\r\n-                      popupAnchor: [0, -40],\r\n+                      iconSize: [30, 30],\r\n                     })\r\n-                  }).addTo(map)\r\n-                    .bindTooltip(\"üöï Driver\", {\r\n-                      permanent: true,\r\n-                      direction: \"top\",\r\n-                      className: \"driver-label\"\r\n-                    })\r\n-                    .bringToFront();\r\n+                  }).addTo(map).bindTooltip(\"Driver\", { permanent: true, direction: \"top\" });\r\n                 }\r\n               }\r\n             });\r\n           </script>\r\n+\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n"
                },
                {
                    "date": 1747557224648,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -66,8 +66,17 @@\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n+\r\n+            .driver-label {\r\n+              font-weight: bold;\r\n+              color: red;\r\n+              background: white;\r\n+              padding: 2px 5px;\r\n+              border-radius: 4px;\r\n+              font-size: 14px;\r\n+            }\r\n           </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n"
                },
                {
                    "date": 1747557279792,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -139,11 +139,16 @@\n                 if (msg.driver) {\r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                      iconSize: [30, 30],\r\n+                      iconSize: [40, 40], // Bigger marker\r\n+                      iconAnchor: [20, 40],\r\n+                      popupAnchor: [0, -40],\r\n                     })\r\n-                  }).addTo(map).bindTooltip(\"Driver\", { permanent: true, direction: \"top\" });\r\n+                  })\r\n+                  .addTo(map)\r\n+                  .bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\", className: 'driver-label' })\r\n+                  .bringToFront(); // Always on top\r\n                 }\r\n               }\r\n             });\r\n           </script>\r\n"
                },
                {
                    "date": 1747558007336,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -136,12 +136,20 @@\n                 }\r\n \r\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n                 if (msg.driver) {\r\n+                  const { latitude, longitude } = msg.driver;\r\n+                  L.circle([latitude, longitude], {\r\n+                    color: 'red',\r\n+                    radius: 10,\r\n+                    fillOpacity: 0.9\r\n+                  }).addTo(map);\r\n+\r\n+                  console.log(\"üß≠ DEBUG: Driver marker at\", latitude, longitude);\r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                      iconSize: [40, 40], // Bigger marker\r\n+                      iconSize: [40, 40],\r\n                       iconAnchor: [20, 40],\r\n                       popupAnchor: [0, -40],\r\n                     })\r\n                   })\r\n"
                },
                {
                    "date": 1747558025787,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -144,8 +144,9 @@\n                     fillOpacity: 0.9\r\n                   }).addTo(map);\r\n \r\n                   console.log(\"üß≠ DEBUG: Driver marker at\", latitude, longitude);\r\n+                  \r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n                       iconSize: [40, 40],\r\n"
                },
                {
                    "date": 1747558345186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,8 +81,9 @@\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n+            window.ReactNativeWebView.postMessage(\"üß≠ DEBUG: Driver marker placed\");\r\n             const map = L.map('map', {\r\n               zoomControl: false,\r\n               dragging: true,\r\n               scrollWheelZoom: true,\r\n@@ -144,9 +145,9 @@\n                     fillOpacity: 0.9\r\n                   }).addTo(map);\r\n \r\n                   console.log(\"üß≠ DEBUG: Driver marker at\", latitude, longitude);\r\n-                  \r\n+\r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n                       iconSize: [40, 40],\r\n"
                },
                {
                    "date": 1747558377131,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -82,8 +82,9 @@\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             window.ReactNativeWebView.postMessage(\"üß≠ DEBUG: Driver marker placed\");\r\n+\r\n             const map = L.map('map', {\r\n               zoomControl: false,\r\n               dragging: true,\r\n               scrollWheelZoom: true,\r\n"
                },
                {
                    "date": 1747558391179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,10 +81,8 @@\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n-            window.ReactNativeWebView.postMessage(\"üß≠ DEBUG: Driver marker placed\");\r\n-\r\n             const map = L.map('map', {\r\n               zoomControl: false,\r\n               dragging: true,\r\n               scrollWheelZoom: true,\r\n@@ -146,9 +144,9 @@\n                     fillOpacity: 0.9\r\n                   }).addTo(map);\r\n \r\n                   console.log(\"üß≠ DEBUG: Driver marker at\", latitude, longitude);\r\n-\r\n+                  \r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n                       iconSize: [40, 40],\r\n"
                },
                {
                    "date": 1747558461695,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -168,8 +168,20 @@\n \r\n     setMapHtml(html);\r\n     }, [location]);\r\n \r\n+    onMessage={(event) => {\r\n+  console.log(\"üì• WebView message:\", event.nativeEvent.data);\r\n+  try {\r\n+    const data = JSON.parse(event.nativeEvent.data);\r\n+    setDestination(data);\r\n+  } catch (e) {\r\n+    // Log any raw debug messages sent\r\n+    console.log(\"üì• Raw WebView msg:\", event.nativeEvent.data);\r\n+  }\r\n+}}\r\n+\r\n+\r\n     useEffect(() => {\r\n     if (!mapRef.current) return;\r\n \r\n     const driverCoords = matchedDriver?.location\r\n"
                },
                {
                    "date": 1747558478673,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -168,20 +168,8 @@\n \r\n     setMapHtml(html);\r\n     }, [location]);\r\n \r\n-    onMessage={(event) => {\r\n-  console.log(\"üì• WebView message:\", event.nativeEvent.data);\r\n-  try {\r\n-    const data = JSON.parse(event.nativeEvent.data);\r\n-    setDestination(data);\r\n-  } catch (e) {\r\n-    // Log any raw debug messages sent\r\n-    console.log(\"üì• Raw WebView msg:\", event.nativeEvent.data);\r\n-  }\r\n-}}\r\n-\r\n-\r\n     useEffect(() => {\r\n     if (!mapRef.current) return;\r\n \r\n     const driverCoords = matchedDriver?.location\r\n"
                },
                {
                    "date": 1747558722082,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -143,9 +143,9 @@\n                     radius: 10,\r\n                     fillOpacity: 0.9\r\n                   }).addTo(map);\r\n \r\n-                  console.log(\"üß≠ DEBUG: Driver marker at\", latitude, longitude);\r\n+                  window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER: \" + latitude + \", \" + longitude);\r\n                   \r\n                   driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n"
                },
                {
                    "date": 1747558760591,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -137,28 +137,28 @@\n \r\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n                 if (msg.driver) {\r\n                   const { latitude, longitude } = msg.driver;\r\n+\r\n+                  // ‚úÖ Send debug message to Metro log\r\n+                  window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER: \" + latitude + \", \" + longitude);\r\n+\r\n                   L.circle([latitude, longitude], {\r\n                     color: 'red',\r\n                     radius: 10,\r\n                     fillOpacity: 0.9\r\n                   }).addTo(map);\r\n \r\n-                  window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER: \" + latitude + \", \" + longitude);\r\n-                  \r\n-                  driverMarker = L.marker([msg.driver.latitude, msg.driver.longitude], {\r\n+                  driverMarker = L.marker([latitude, longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n                       iconSize: [40, 40],\r\n                       iconAnchor: [20, 40],\r\n-                      popupAnchor: [0, -40],\r\n                     })\r\n-                  })\r\n-                  .addTo(map)\r\n-                  .bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\", className: 'driver-label' })\r\n-                  .bringToFront(); // Always on top\r\n+                  }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                    .setZIndexOffset(1000);\r\n                 }\r\n+\r\n               }\r\n             });\r\n           </script>\r\n \r\n"
                },
                {
                    "date": 1747558793385,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,9 +156,8 @@\n                     })\r\n                   }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n                     .setZIndexOffset(1000);\r\n                 }\r\n-\r\n               }\r\n             });\r\n           </script>\r\n \r\n@@ -168,8 +167,23 @@\n \r\n     setMapHtml(html);\r\n     }, [location]);\r\n \r\n+    onMessage={(event) => {\r\n+      const msg = event.nativeEvent.data;\r\n+      console.log(\"üì• WebView message:\", msg);\r\n+\r\n+      try {\r\n+        const parsed = JSON.parse(msg);\r\n+        if (parsed.latitude && parsed.longitude) {\r\n+          setDestination(parsed); // location selection\r\n+        }\r\n+      } catch (e) {\r\n+        // It was just a debug string like \"üß≠ DRIVER MARKER: ...\"\r\n+      }\r\n+    }}\r\n+\r\n+\r\n     useEffect(() => {\r\n     if (!mapRef.current) return;\r\n \r\n     const driverCoords = matchedDriver?.location\r\n"
                },
                {
                    "date": 1747558871403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -167,9 +167,9 @@\n \r\n     setMapHtml(html);\r\n     }, [location]);\r\n \r\n-    onMessage={(event) => {\r\n+    onMessage={(event: any) => {\r\n       const msg = event.nativeEvent.data;\r\n       console.log(\"üì• WebView message:\", msg);\r\n \r\n       try {\r\n"
                },
                {
                    "date": 1747558887705,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,8 +18,9 @@\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+import { WebViewMessageEvent } from 'react-native-webview';\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1747558940257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,8 @@\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n-import { WebViewMessageEvent } from 'react-native-webview';\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n@@ -167,24 +166,10 @@\n     `;\r\n \r\n     setMapHtml(html);\r\n     }, [location]);\r\n+    \r\n \r\n-    onMessage={(event: any) => {\r\n-      const msg = event.nativeEvent.data;\r\n-      console.log(\"üì• WebView message:\", msg);\r\n-\r\n-      try {\r\n-        const parsed = JSON.parse(msg);\r\n-        if (parsed.latitude && parsed.longitude) {\r\n-          setDestination(parsed); // location selection\r\n-        }\r\n-      } catch (e) {\r\n-        // It was just a debug string like \"üß≠ DRIVER MARKER: ...\"\r\n-      }\r\n-    }}\r\n-\r\n-\r\n     useEffect(() => {\r\n     if (!mapRef.current) return;\r\n \r\n     const driverCoords = matchedDriver?.location\r\n"
                },
                {
                    "date": 1747559038064,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,8 +76,23 @@\n               border-radius: 4px;\r\n               font-size: 14px;\r\n             }\r\n           </style>\r\n+\r\n+          onMessage={(event: WebViewMessageEvent) => {\r\n+            const msg = event.nativeEvent.data;\r\n+            console.log(\"üì• WebView message:\", msg);\r\n+\r\n+            try {\r\n+              const parsed = JSON.parse(msg);\r\n+              if (parsed.latitude && parsed.longitude) {\r\n+                setDestination(parsed);\r\n+              }\r\n+            } catch (e) {\r\n+              // message is a raw debug string\r\n+            }\r\n+          }}\r\n+\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n"
                },
                {
                    "date": 1747559060880,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -77,22 +77,8 @@\n               font-size: 14px;\r\n             }\r\n           </style>\r\n \r\n-          onMessage={(event: WebViewMessageEvent) => {\r\n-            const msg = event.nativeEvent.data;\r\n-            console.log(\"üì• WebView message:\", msg);\r\n-\r\n-            try {\r\n-              const parsed = JSON.parse(msg);\r\n-              if (parsed.latitude && parsed.longitude) {\r\n-                setDestination(parsed);\r\n-              }\r\n-            } catch (e) {\r\n-              // message is a raw debug string\r\n-            }\r\n-          }}\r\n-\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n"
                },
                {
                    "date": 1747559076699,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -160,9 +160,22 @@\n                 }\r\n               }\r\n             });\r\n           </script>\r\n+          onMessage={(event: WebViewMessageEvent) => {\r\n+            const msg = event.nativeEvent.data;\r\n+            console.log(\"üì• WebView message:\", msg);\r\n \r\n+            try {\r\n+              const parsed = JSON.parse(msg);\r\n+              if (parsed.latitude && parsed.longitude) {\r\n+                setDestination(parsed);\r\n+              }\r\n+            } catch (e) {\r\n+              // message is a raw debug string\r\n+            }\r\n+          }}\r\n+\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n"
                },
                {
                    "date": 1747559208264,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,9 +76,8 @@\n               border-radius: 4px;\r\n               font-size: 14px;\r\n             }\r\n           </style>\r\n-\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n@@ -160,22 +159,9 @@\n                 }\r\n               }\r\n             });\r\n           </script>\r\n-          onMessage={(event: WebViewMessageEvent) => {\r\n-            const msg = event.nativeEvent.data;\r\n-            console.log(\"üì• WebView message:\", msg);\r\n \r\n-            try {\r\n-              const parsed = JSON.parse(msg);\r\n-              if (parsed.latitude && parsed.longitude) {\r\n-                setDestination(parsed);\r\n-              }\r\n-            } catch (e) {\r\n-              // message is a raw debug string\r\n-            }\r\n-          }}\r\n-\r\n         </body>\r\n       </html>\r\n     `;\r\n \r\n@@ -343,9 +329,21 @@\n                 right: 0,\r\n                 bottom: 0,\r\n                 zIndex: 0,\r\n               }}\r\n-              onMessage={(event) => setDestination(JSON.parse(event.nativeEvent.data))}\r\n+              onMessage={(event) => {\r\n+                const msg = event.nativeEvent.data;\r\n+                console.log(\"üì• WebView message:\", msg);\r\n+\r\n+                try {\r\n+                  const parsed = JSON.parse(msg);\r\n+                  if (parsed.latitude && parsed.longitude) {\r\n+                    setDestination(parsed);\r\n+                  }\r\n+                } catch (e) {\r\n+                  // Debug string from inside the WebView like \"üß≠ DRIVER MARKER: ...\"\r\n+                }\r\n+              }}\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n"
                },
                {
                    "date": 1747559269538,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -138,9 +138,8 @@\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n                 if (msg.driver) {\r\n                   const { latitude, longitude } = msg.driver;\r\n \r\n-                  // ‚úÖ Send debug message to Metro log\r\n                   window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER: \" + latitude + \", \" + longitude);\r\n \r\n                   L.circle([latitude, longitude], {\r\n                     color: 'red',\r\n"
                },
                {
                    "date": 1747559338337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -329,8 +329,9 @@\n                 bottom: 0,\r\n                 zIndex: 0,\r\n               }}\r\n               onMessage={(event) => {\r\n+                console.log(\"‚úÖ Received from WebView:\", event.nativeEvent.data);\r\n                 const msg = event.nativeEvent.data;\r\n                 console.log(\"üì• WebView message:\", msg);\r\n \r\n                 try {\r\n"
                },
                {
                    "date": 1747559454133,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -138,9 +138,9 @@\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n                 if (msg.driver) {\r\n                   const { latitude, longitude } = msg.driver;\r\n \r\n-                  window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER: \" + latitude + \", \" + longitude);\r\n+                  window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n \r\n                   L.circle([latitude, longitude], {\r\n                     color: 'red',\r\n                     radius: 10,\r\n"
                },
                {
                    "date": 1747560787395,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -177,8 +177,15 @@\n           longitude: matchedDriver.location.longitude,\r\n         }\r\n       : null;\r\n \r\n+    console.log(\"üì§ Sending to WebView:\", {\r\n+      type: \"setMarkers\",\r\n+      destination,\r\n+      driver: matchedDriver?.location,\r\n+    });\r\n+\r\n+\r\n     mapRef.current.postMessage(\r\n       JSON.stringify({\r\n         type: \"setMarkers\",\r\n         destination,\r\n"
                },
                {
                    "date": 1747560837901,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,8 +122,9 @@\n             });\r\n \r\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n+              window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n \r\n               if (msg.type === 'setMarkers') {\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n                 if (msg.destination) {\r\n"
                },
                {
                    "date": 1747560857162,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -123,8 +123,16 @@\n \r\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n               window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+              if (msg.type === 'setMarkers') {\r\n+                if (msg.driver) {\r\n+                  const { latitude, longitude } = msg.driver;\r\n+                  window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n+                } else {\r\n+                  window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n+                }\r\n+              }\r\n \r\n               if (msg.type === 'setMarkers') {\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n                 if (msg.destination) {\r\n"
                },
                {
                    "date": 1747560944800,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,9 +124,9 @@\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n               window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n               if (msg.type === 'setMarkers') {\r\n-                if (msg.driver) {\r\n+                if (msg.destination) {\r\n                   const { latitude, longitude } = msg.driver;\r\n                   window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n                 } else {\r\n                   window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n"
                },
                {
                    "date": 1747561037414,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -311,16 +311,9 @@\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId]);\r\n \r\n-  useEffect(() => {\r\n-    if (matchedDriver) {\r\n-      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverId);\r\n-      console.log(\"üéØ Matched driver name (from state):\", matchedDriver.driverName);\r\n-    }\r\n-  }, [matchedDriver]);\r\n \r\n-\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1747561056257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -377,9 +377,8 @@\n               {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   {matchedDriver.selfieImage && (\r\n-                    console.log(\"üñº Selfie Image URL:\", matchedDriver.selfieImage),\r\n                     <Image\r\n                       source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n                       style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n                     />\r\n"
                },
                {
                    "date": 1747561161852,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -116,10 +116,8 @@\n                   iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n                   iconSize: [30, 30],\r\n                 })\r\n               }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n"
                },
                {
                    "date": 1747561351974,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -116,8 +116,10 @@\n                   iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n                   iconSize: [30, 30],\r\n                 })\r\n               }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n"
                },
                {
                    "date": 1747561400991,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,9 +124,9 @@\n             window.addEventListener('message', function(event) {\r\n               const msg = JSON.parse(event.data);\r\n               window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n               if (msg.type === 'setMarkers') {\r\n-                if (msg.destination) {\r\n+                if (msg.driver) {\r\n                   const { latitude, longitude } = msg.driver;\r\n                   window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n                 } else {\r\n                   window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n"
                },
                {
                    "date": 1747561467962,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -135,8 +135,9 @@\n \r\n               if (msg.type === 'setMarkers') {\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n                 if (msg.destination) {\r\n+                  window.ReactNativeWebView.postMessage(\"msg destination trigger\");\r\n                   destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n                     icon: L.icon({\r\n                       iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n                       iconSize: [30, 30],\r\n"
                },
                {
                    "date": 1747561482012,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -146,8 +146,9 @@\n                 }\r\n \r\n                 if (driverMarker) map.removeLayer(driverMarker);\r\n                 if (msg.driver) {\r\n+                  window.ReactNativeWebView.postMessage(\"msg driver trigger\");\r\n                   const { latitude, longitude } = msg.driver;\r\n \r\n                   window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n \r\n"
                },
                {
                    "date": 1747561788841,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -120,56 +120,55 @@\n \r\n               window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n             });\r\n \r\n-            window.addEventListener('message', function(event) {\r\n-              const msg = JSON.parse(event.data);\r\n-              window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n-              if (msg.type === 'setMarkers') {\r\n-                if (msg.driver) {\r\n-                  const { latitude, longitude } = msg.driver;\r\n-                  window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n-                } else {\r\n-                  window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n-                }\r\n-              }\r\n+            setTimeout(() => {\r\n+              window.addEventListener('message', function(event) {\r\n+                const msg = JSON.parse(event.data);\r\n+                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n \r\n-              if (msg.type === 'setMarkers') {\r\n-                if (destMarker) map.removeLayer(destMarker);\r\n-                if (msg.destination) {\r\n-                  window.ReactNativeWebView.postMessage(\"msg destination trigger\");\r\n-                  destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                    icon: L.icon({\r\n-                      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                      iconSize: [30, 30],\r\n-                    })\r\n-                  }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                }\r\n+                if (msg.type === 'setMarkers') {\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n+                  } else {\r\n+                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n+                  }\r\n \r\n-                if (driverMarker) map.removeLayer(driverMarker);\r\n-                if (msg.driver) {\r\n-                  window.ReactNativeWebView.postMessage(\"msg driver trigger\");\r\n-                  const { latitude, longitude } = msg.driver;\r\n+                  if (destMarker) map.removeLayer(destMarker);\r\n+                  if (msg.destination) {\r\n+                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                        iconSize: [30, 30],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                  }\r\n \r\n-                  window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n+                  if (driverMarker) map.removeLayer(driverMarker);\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n \r\n-                  L.circle([latitude, longitude], {\r\n-                    color: 'red',\r\n-                    radius: 10,\r\n-                    fillOpacity: 0.9\r\n-                  }).addTo(map);\r\n+                    L.circle([latitude, longitude], {\r\n+                      color: 'red',\r\n+                      radius: 10,\r\n+                      fillOpacity: 0.9\r\n+                    }).addTo(map);\r\n \r\n-                  driverMarker = L.marker([latitude, longitude], {\r\n-                    icon: L.icon({\r\n-                      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                      iconSize: [40, 40],\r\n-                      iconAnchor: [20, 40],\r\n-                    })\r\n-                  }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                    .setZIndexOffset(1000);\r\n+                    driverMarker = L.marker([latitude, longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n+                        iconSize: [40, 40],\r\n+                        iconAnchor: [20, 40],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                      .setZIndexOffset(1000);\r\n+                  }\r\n                 }\r\n-              }\r\n-            });\r\n+              });\r\n+            }, 100); // wait 100ms for WebView to attach\r\n+\r\n           </script>\r\n \r\n         </body>\r\n       </html>\r\n"
                },
                {
                    "date": 1747570043892,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -165,9 +165,9 @@\n                       .setZIndexOffset(1000);\r\n                   }\r\n                 }\r\n               });\r\n-            }, 100); // wait 100ms for WebView to attach\r\n+            }, 1000); \r\n \r\n           </script>\r\n \r\n         </body>\r\n"
                },
                {
                    "date": 1747570529676,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -81,94 +81,95 @@\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n-            const map = L.map('map', {\r\n-              zoomControl: false,\r\n-              dragging: true,\r\n-              scrollWheelZoom: true,\r\n-              touchZoom: true,\r\n-              doubleClickZoom: true,\r\n-              boxZoom: true,\r\n-            }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+            window.onload = function () {\r\n+              const map = L.map('map', {\r\n+                zoomControl: false,\r\n+                dragging: true,\r\n+                scrollWheelZoom: true,\r\n+                touchZoom: true,\r\n+                doubleClickZoom: true,\r\n+                boxZoom: true,\r\n+              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n-            L.control.zoom({ position: 'topleft' }).addTo(map);\r\n+              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-              maxZoom: 19,\r\n-              attribution: '¬© OpenStreetMap contributors'\r\n-            }).addTo(map);\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 19,\r\n+                attribution: '¬© OpenStreetMap contributors'\r\n+              }).addTo(map);\r\n \r\n-            const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n-              icon: L.icon({\r\n-                iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-                iconSize: [30, 30],\r\n-              })\r\n-            }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n-\r\n-            let destMarker = null;\r\n-            let driverMarker = null;\r\n-\r\n-            map.on('click', function(e) {\r\n-              const { lat, lng } = e.latlng;\r\n-              if (destMarker) map.removeLayer(destMarker);\r\n-              destMarker = L.marker([lat, lng], {\r\n+              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n-                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n                   iconSize: [30, 30],\r\n                 })\r\n-              }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n \r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-            });\r\n+              let destMarker = null;\r\n+              let driverMarker = null;\r\n \r\n-            setTimeout(() => {\r\n-              window.addEventListener('message', function(event) {\r\n-                const msg = JSON.parse(event.data);\r\n-                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+              map.on('click', function(e) {\r\n+                const { lat, lng } = e.latlng;\r\n+                if (destMarker) map.removeLayer(destMarker);\r\n+                destMarker = L.marker([lat, lng], {\r\n+                  icon: L.icon({\r\n+                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                    iconSize: [30, 30],\r\n+                  })\r\n+                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n \r\n-                if (msg.type === 'setMarkers') {\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n-                  } else {\r\n-                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n-                  }\r\n+                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+              });\r\n \r\n-                  if (destMarker) map.removeLayer(destMarker);\r\n-                  if (msg.destination) {\r\n-                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                        iconSize: [30, 30],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                  }\r\n+              setTimeout(() => {\r\n+                window.addEventListener('message', function(event) {\r\n+                  const msg = JSON.parse(event.data);\r\n+                  window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n \r\n-                  if (driverMarker) map.removeLayer(driverMarker);\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n+                  if (msg.type === 'setMarkers') {\r\n+                    if (msg.driver) {\r\n+                      const { latitude, longitude } = msg.driver;\r\n+                      window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n+                    } else {\r\n+                      window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n+                    }\r\n \r\n-                    L.circle([latitude, longitude], {\r\n-                      color: 'red',\r\n-                      radius: 10,\r\n-                      fillOpacity: 0.9\r\n-                    }).addTo(map);\r\n+                    if (destMarker) map.removeLayer(destMarker);\r\n+                    if (msg.destination) {\r\n+                      destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                        icon: L.icon({\r\n+                          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                          iconSize: [30, 30],\r\n+                        })\r\n+                      }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                    }\r\n \r\n-                    driverMarker = L.marker([latitude, longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                        iconSize: [40, 40],\r\n-                        iconAnchor: [20, 40],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                      .setZIndexOffset(1000);\r\n+                    if (driverMarker) map.removeLayer(driverMarker);\r\n+                    if (msg.driver) {\r\n+                      const { latitude, longitude } = msg.driver;\r\n+                      window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n+\r\n+                      L.circle([latitude, longitude], {\r\n+                        color: 'red',\r\n+                        radius: 10,\r\n+                        fillOpacity: 0.9\r\n+                      }).addTo(map);\r\n+\r\n+                      driverMarker = L.marker([latitude, longitude], {\r\n+                        icon: L.icon({\r\n+                          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n+                          iconSize: [40, 40],\r\n+                          iconAnchor: [20, 40],\r\n+                        })\r\n+                      }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                        .setZIndexOffset(1000);\r\n+                    }\r\n                   }\r\n-                }\r\n-              });\r\n-            }, 1000); \r\n-\r\n+                });\r\n+              }, 1000); \r\n+            }\r\n           </script>\r\n \r\n         </body>\r\n       </html>\r\n"
                },
                {
                    "date": 1747581431746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -122,9 +122,9 @@\n                 window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n               });\r\n \r\n               setTimeout(() => {\r\n-                window.addEventListener('message', function(event) {\r\n+                document.addEventListener('message', function(event) {\r\n                   const msg = JSON.parse(event.data);\r\n                   window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n \r\n                   if (msg.type === 'setMarkers') {\r\n"
                },
                {
                    "date": 1747581494563,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -120,55 +120,52 @@\n                 }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n \r\n                 window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n               });\r\n+              document.addEventListener('message', function(event) {\r\n+                const msg = JSON.parse(event.data);\r\n+                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n \r\n-              setTimeout(() => {\r\n-                document.addEventListener('message', function(event) {\r\n-                  const msg = JSON.parse(event.data);\r\n-                  window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+                if (msg.type === 'setMarkers') {\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n+                  } else {\r\n+                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n+                  }\r\n \r\n-                  if (msg.type === 'setMarkers') {\r\n-                    if (msg.driver) {\r\n-                      const { latitude, longitude } = msg.driver;\r\n-                      window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n-                    } else {\r\n-                      window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n-                    }\r\n+                  if (destMarker) map.removeLayer(destMarker);\r\n+                  if (msg.destination) {\r\n+                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                        iconSize: [30, 30],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                  }\r\n \r\n-                    if (destMarker) map.removeLayer(destMarker);\r\n-                    if (msg.destination) {\r\n-                      destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                        icon: L.icon({\r\n-                          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                          iconSize: [30, 30],\r\n-                        })\r\n-                      }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                    }\r\n+                  if (driverMarker) map.removeLayer(driverMarker);\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n \r\n-                    if (driverMarker) map.removeLayer(driverMarker);\r\n-                    if (msg.driver) {\r\n-                      const { latitude, longitude } = msg.driver;\r\n-                      window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n+                    L.circle([latitude, longitude], {\r\n+                      color: 'red',\r\n+                      radius: 10,\r\n+                      fillOpacity: 0.9\r\n+                    }).addTo(map);\r\n \r\n-                      L.circle([latitude, longitude], {\r\n-                        color: 'red',\r\n-                        radius: 10,\r\n-                        fillOpacity: 0.9\r\n-                      }).addTo(map);\r\n-\r\n-                      driverMarker = L.marker([latitude, longitude], {\r\n-                        icon: L.icon({\r\n-                          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n-                          iconSize: [40, 40],\r\n-                          iconAnchor: [20, 40],\r\n-                        })\r\n-                      }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                        .setZIndexOffset(1000);\r\n-                    }\r\n+                    driverMarker = L.marker([latitude, longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n+                        iconSize: [40, 40],\r\n+                        iconAnchor: [20, 40],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                      .setZIndexOffset(1000);\r\n                   }\r\n-                });\r\n-              }, 1000); \r\n+                }\r\n+              });\r\n             }\r\n           </script>\r\n \r\n         </body>\r\n"
                },
                {
                    "date": 1747582188321,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -155,9 +155,9 @@\n                     }).addTo(map);\r\n \r\n                     driverMarker = L.marker([latitude, longitude], {\r\n                       icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',\r\n+                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', // üõ∫ yellow tricycle/taxi icon\r\n                         iconSize: [40, 40],\r\n                         iconAnchor: [20, 40],\r\n                       })\r\n                     }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n"
                },
                {
                    "date": 1747582321681,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -108,9 +108,13 @@\n \r\n               let destMarker = null;\r\n               let driverMarker = null;\r\n \r\n+              let destinationLocked = false;\r\n+\r\n               map.on('click', function(e) {\r\n+                if (destinationLocked) return;\r\n+\r\n                 const { lat, lng } = e.latlng;\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n                 destMarker = L.marker([lat, lng], {\r\n                   icon: L.icon({\r\n@@ -155,9 +159,9 @@\n                     }).addTo(map);\r\n \r\n                     driverMarker = L.marker([latitude, longitude], {\r\n                       icon: L.icon({\r\n-                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', // üõ∫ yellow tricycle/taxi icon\r\n+                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', \r\n                         iconSize: [40, 40],\r\n                         iconAnchor: [20, 40],\r\n                       })\r\n                     }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n"
                },
                {
                    "date": 1747582367856,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -109,9 +109,8 @@\n               let destMarker = null;\r\n               let driverMarker = null;\r\n \r\n               let destinationLocked = false;\r\n-\r\n               map.on('click', function(e) {\r\n                 if (destinationLocked) return;\r\n \r\n                 const { lat, lng } = e.latlng;\r\n@@ -129,8 +128,9 @@\n                 const msg = JSON.parse(event.data);\r\n                 window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n \r\n                 if (msg.type === 'setMarkers') {\r\n+                  destinationLocked = !!msg.driver;\r\n                   if (msg.driver) {\r\n                     const { latitude, longitude } = msg.driver;\r\n                     window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n                   } else {\r\n"
                },
                {
                    "date": 1747582419346,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -393,8 +393,9 @@\n                     onPress={() => {\r\n                       setMatchedDriver(null);\r\n                       setBookingId(null);\r\n                       setSearching(false);\r\n+                      setDestination(null);\r\n                       if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                     }}\r\n                     style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n                   >\r\n"
                },
                {
                    "date": 1747656134594,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,14 +11,17 @@\n   KeyboardAvoidingView,\r\n   Platform,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n-  Image\r\n+  Image,\r\n+  BackHandler\r\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router'; // or useNavigation if you're using react-navigation\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n"
                },
                {
                    "date": 1747656200081,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,11 +48,37 @@\n   const [showBookingForm, setShowBookingForm] = useState(false); \r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n \r\n+  useEffect(() => {\r\n+    const backAction = () => {\r\n+      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+        {\r\n+          text: \"Cancel\",\r\n+          onPress: () => null,\r\n+          style: \"cancel\"\r\n+        },\r\n+        {\r\n+          text: \"Logout\",\r\n+          onPress: async () => {\r\n+            await AsyncStorage.removeItem(\"passengerId\");\r\n+            router.replace(\"/login_and_reg/plogin\"); // or whatever your login screen is\r\n+          }\r\n+        }\r\n+      ]);\r\n+      return true; // prevent default back action\r\n+    };\r\n \r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n \r\n+    return () => backHandler.remove(); // clean up on unmount\r\n+  }, []);\r\n \r\n+\r\n+\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n"
                },
                {
                    "date": 1747656238187,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -60,21 +60,16 @@\n         {\r\n           text: \"Logout\",\r\n           onPress: async () => {\r\n             await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\"); // or whatever your login screen is\r\n+            router.replace(\"/login_and_reg/plogin\"); \r\n           }\r\n         }\r\n       ]);\r\n-      return true; // prevent default back action\r\n+      return true; \r\n     };\r\n \r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n-\r\n-    return () => backHandler.remove(); // clean up on unmount\r\n+    ?\r\n   }, []);\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1747656256081,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -67,9 +67,13 @@\n       ]);\r\n       return true; \r\n     };\r\n \r\n-    ?\r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n+    return () => backHandler.remove();\r\n   }, []);\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1747657507617,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -47,8 +47,9 @@\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false); \r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  \r\n \r\n   useEffect(() => {\r\n     const backAction = () => {\r\n       Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n@@ -238,8 +239,9 @@\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n+    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n \r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n"
                },
                {
                    "date": 1747657537224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -250,8 +250,9 @@\n       fare,\r\n       paymentMethod,\r\n       notes,\r\n       passengerName: \"Anonymous\",\r\n+      passengerId\r\n     };\r\n \r\n     try {\r\n       setShowBookingForm(false); // hide form\r\n"
                },
                {
                    "date": 1747657588905,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -249,9 +249,8 @@\n       destinationLng: destination.longitude,\r\n       fare,\r\n       paymentMethod,\r\n       notes,\r\n-      passengerName: \"Anonymous\",\r\n       passengerId\r\n     };\r\n \r\n     try {\r\n"
                },
                {
                    "date": 1747670172383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,501 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  StyleSheet,\r\n+  Dimensions,\r\n+  TouchableOpacity,\r\n+  StatusBar,\r\n+  TextInput,\r\n+  Alert,\r\n+  KeyboardAvoidingView,\r\n+  Platform,\r\n+  TouchableWithoutFeedback,\r\n+  Keyboard,\r\n+  Image,\r\n+  BackHandler\r\n+} from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router'; // or useNavigation if you're using react-navigation\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+\r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(20);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number }; \r\n+  } | null>(null);\r\n+\r\n+  const [bookingId, setBookingId] = useState(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false); \r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  \r\n+  \r\n+\r\n+  useEffect(() => {\r\n+    const backAction = () => {\r\n+      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+        {\r\n+          text: \"Cancel\",\r\n+          onPress: () => null,\r\n+          style: \"cancel\"\r\n+        },\r\n+        {\r\n+          text: \"Logout\",\r\n+          onPress: async () => {\r\n+            await AsyncStorage.removeItem(\"passengerId\");\r\n+            router.replace(\"/login_and_reg/plogin\"); \r\n+          }\r\n+        }\r\n+      ]);\r\n+      return true; \r\n+    };\r\n+\r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n+    return () => backHandler.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n+\r\n+    const html = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style>\r\n+            html, body, #map {\r\n+              height: 100%;\r\n+              margin: 0;\r\n+              padding: 0;\r\n+              overflow: hidden;\r\n+              touch-action: auto;\r\n+            }\r\n+            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n+\r\n+            .driver-label {\r\n+              font-weight: bold;\r\n+              color: red;\r\n+              background: white;\r\n+              padding: 2px 5px;\r\n+              border-radius: 4px;\r\n+              font-size: 14px;\r\n+            }\r\n+          </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            window.onload = function () {\r\n+              const map = L.map('map', {\r\n+                zoomControl: false,\r\n+                dragging: true,\r\n+                scrollWheelZoom: true,\r\n+                touchZoom: true,\r\n+                doubleClickZoom: true,\r\n+                boxZoom: true,\r\n+              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n+\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 19,\r\n+                attribution: '¬© OpenStreetMap contributors'\r\n+              }).addTo(map);\r\n+\r\n+              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n+                icon: L.icon({\r\n+                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+                  iconSize: [30, 30],\r\n+                })\r\n+              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n+\r\n+              let destMarker = null;\r\n+              let driverMarker = null;\r\n+\r\n+              let destinationLocked = false;\r\n+              map.on('click', function(e) {\r\n+                if (destinationLocked) return;\r\n+\r\n+                const { lat, lng } = e.latlng;\r\n+                if (destMarker) map.removeLayer(destMarker);\r\n+                destMarker = L.marker([lat, lng], {\r\n+                  icon: L.icon({\r\n+                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                    iconSize: [30, 30],\r\n+                  })\r\n+                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+\r\n+                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+              });\r\n+              document.addEventListener('message', function(event) {\r\n+                const msg = JSON.parse(event.data);\r\n+                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+\r\n+                if (msg.type === 'setMarkers') {\r\n+                  destinationLocked = !!msg.driver;\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n+                  } else {\r\n+                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n+                  }\r\n+\r\n+                  if (destMarker) map.removeLayer(destMarker);\r\n+                  if (msg.destination) {\r\n+                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                        iconSize: [30, 30],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                  }\r\n+\r\n+                  if (driverMarker) map.removeLayer(driverMarker);\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n+\r\n+                    L.circle([latitude, longitude], {\r\n+                      color: 'red',\r\n+                      radius: 10,\r\n+                      fillOpacity: 0.9\r\n+                    }).addTo(map);\r\n+\r\n+                    driverMarker = L.marker([latitude, longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', \r\n+                        iconSize: [40, 40],\r\n+                        iconAnchor: [20, 40],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                      .setZIndexOffset(1000);\r\n+                  }\r\n+                }\r\n+              });\r\n+            }\r\n+          </script>\r\n+\r\n+        </body>\r\n+      </html>\r\n+    `;\r\n+\r\n+    setMapHtml(html);\r\n+    }, [location]);\r\n+    \r\n+\r\n+    useEffect(() => {\r\n+    if (!mapRef.current) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? {\r\n+          latitude: matchedDriver.location.latitude,\r\n+          longitude: matchedDriver.location.longitude,\r\n+        }\r\n+      : null;\r\n+\r\n+    console.log(\"üì§ Sending to WebView:\", {\r\n+      type: \"setMarkers\",\r\n+      destination,\r\n+      driver: matchedDriver?.location,\r\n+    });\r\n+\r\n+\r\n+    mapRef.current.postMessage(\r\n+      JSON.stringify({\r\n+        type: \"setMarkers\",\r\n+        destination,\r\n+        driver: driverCoords,\r\n+      })\r\n+    );\r\n+  }, [destination, matchedDriver]);\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId\r\n+    };\r\n+\r\n+    try {\r\n+      setShowBookingForm(false); // hide form\r\n+      setSearching(true);        // show searching state\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      setBookingId(result.booking.id);\r\n+\r\n+      // Start polling for driver for up to 10 minutes\r\n+      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n+      const startTime = Date.now();\r\n+\r\n+      const poll = async () => {\r\n+        try {\r\n+          const [driverRes, statusRes] = await Promise.all([\r\n+            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n+            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n+          ]);\r\n+\r\n+          const driverData = await driverRes.json();\r\n+          const statusData = await statusRes.json();\r\n+\r\n+          if (driverData?.driver) {\r\n+            setMatchedDriver({\r\n+              driverName: driverData.driver.driverName,\r\n+              driverId: driverData.driver._id,\r\n+              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+              location: statusData.location || null, // Live GPS\r\n+            });\r\n+\r\n+            setSearching(false);\r\n+            return;\r\n+          }\r\n+        } catch (err) {\r\n+          console.log(\"‚è≥ Still waiting for driver...\");\r\n+        }\r\n+\r\n+        if (Date.now() - startTime < maxWaitTime) {\r\n+          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n+        } else {\r\n+          setSearching(false); // stop searching silently\r\n+          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n+        }\r\n+      };\r\n+\r\n+      poll(); // start polling\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Booking error:\", error);\r\n+      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => {\r\n+      showSub.remove();\r\n+      hideSub.remove();\r\n+    };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n+          setMatchedDriver(myBooking);\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Poll error:\", err);\r\n+      }\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) {\r\n+                  mapRef.current = ref;\r\n+                }\r\n+              }}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled={true}\r\n+              style={{\r\n+                position: \"absolute\",\r\n+                top: 0,\r\n+                left: 0,\r\n+                right: 0,\r\n+                bottom: 0,\r\n+                zIndex: 0,\r\n+              }}\r\n+              onMessage={(event) => {\r\n+                console.log(\"‚úÖ Received from WebView:\", event.nativeEvent.data);\r\n+                const msg = event.nativeEvent.data;\r\n+                console.log(\"üì• WebView message:\", msg);\r\n+\r\n+                try {\r\n+                  const parsed = JSON.parse(msg);\r\n+                  if (parsed.latitude && parsed.longitude) {\r\n+                    setDestination(parsed);\r\n+                  }\r\n+                } catch (e) {\r\n+                  // Debug string from inside the WebView like \"üß≠ DRIVER MARKER: ...\"\r\n+                }\r\n+              }}\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {/* ‚úÖ Show this if driver is found */}\r\n+              {matchedDriver && (\r\n+                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                  {matchedDriver.selfieImage && (\r\n+                    <Image\r\n+                      source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                      style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n+                    />\r\n+                  )}\r\n+                  <Text>Name: {matchedDriver.driverName}</Text>\r\n+                  <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                  <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setMatchedDriver(null);\r\n+                      setBookingId(null);\r\n+                      setSearching(false);\r\n+                      setDestination(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            {showBookingForm && (\r\n+              <View style={styles.card}>\r\n+                <View style={styles.cardHeader} />\r\n+                <TouchableOpacity style={styles.inputBox}>\r\n+                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                  <Text style={styles.inputText}>\r\n+                    {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n+                  </Text>\r\n+                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+                </TouchableOpacity>\r\n+                <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                <View style={styles.totalFareContainer}>\r\n+                  <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n+                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {!matchedDriver && !searching && !showBookingForm && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{\r\n+                  position: \"absolute\",\r\n+                  bottom: 85,\r\n+                  backgroundColor: \"#81C3E1\",\r\n+                  padding: 10,\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+              <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n+            </View>\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n+  overlay: {width: width, margin: 60},\r\n+  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n+  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n+  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n+  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n+  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n+  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n+  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n+  bookNowText: { fontSize: 16 },\r\n+  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+});\r\n"
                },
                {
                    "date": 1747732693045,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,12 +70,12 @@\n       ]);\r\n       return true; \r\n     };\r\n \r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n+    // const backHandler = BackHandler.addEventListener(\r\n+    //   \"hardwareBackPress\",\r\n+    //   backAction\r\n+    // );\r\n     return () => backHandler.remove();\r\n   }, []);\r\n \r\n \r\n@@ -498,505 +498,4 @@\n   bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n   bookNowText: { fontSize: 16 },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import {\r\n-  View,\r\n-  Text,\r\n-  StyleSheet,\r\n-  Dimensions,\r\n-  TouchableOpacity,\r\n-  StatusBar,\r\n-  TextInput,\r\n-  Alert,\r\n-  KeyboardAvoidingView,\r\n-  Platform,\r\n-  TouchableWithoutFeedback,\r\n-  Keyboard,\r\n-  Image,\r\n-  BackHandler\r\n-} from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router'; // or useNavigation if you're using react-navigation\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n-\r\n-const { width, height } = Dimensions.get(\"window\");\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(20);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number }; \r\n-  } | null>(null);\r\n-\r\n-  const [bookingId, setBookingId] = useState(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false); \r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  \r\n-\r\n-  useEffect(() => {\r\n-    const backAction = () => {\r\n-      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-        {\r\n-          text: \"Cancel\",\r\n-          onPress: () => null,\r\n-          style: \"cancel\"\r\n-        },\r\n-        {\r\n-          text: \"Logout\",\r\n-          onPress: async () => {\r\n-            await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\"); \r\n-          }\r\n-        }\r\n-      ]);\r\n-      return true; \r\n-    };\r\n-\r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n-    return () => backHandler.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n-\r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style>\r\n-            html, body, #map {\r\n-              height: 100%;\r\n-              margin: 0;\r\n-              padding: 0;\r\n-              overflow: hidden;\r\n-              touch-action: auto;\r\n-            }\r\n-            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n-\r\n-            .driver-label {\r\n-              font-weight: bold;\r\n-              color: red;\r\n-              background: white;\r\n-              padding: 2px 5px;\r\n-              border-radius: 4px;\r\n-              font-size: 14px;\r\n-            }\r\n-          </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            window.onload = function () {\r\n-              const map = L.map('map', {\r\n-                zoomControl: false,\r\n-                dragging: true,\r\n-                scrollWheelZoom: true,\r\n-                touchZoom: true,\r\n-                doubleClickZoom: true,\r\n-                boxZoom: true,\r\n-              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n-\r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 19,\r\n-                attribution: '¬© OpenStreetMap contributors'\r\n-              }).addTo(map);\r\n-\r\n-              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n-                icon: L.icon({\r\n-                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-                  iconSize: [30, 30],\r\n-                })\r\n-              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n-\r\n-              let destMarker = null;\r\n-              let driverMarker = null;\r\n-\r\n-              let destinationLocked = false;\r\n-              map.on('click', function(e) {\r\n-                if (destinationLocked) return;\r\n-\r\n-                const { lat, lng } = e.latlng;\r\n-                if (destMarker) map.removeLayer(destMarker);\r\n-                destMarker = L.marker([lat, lng], {\r\n-                  icon: L.icon({\r\n-                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                    iconSize: [30, 30],\r\n-                  })\r\n-                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-\r\n-                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-              });\r\n-              document.addEventListener('message', function(event) {\r\n-                const msg = JSON.parse(event.data);\r\n-                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n-\r\n-                if (msg.type === 'setMarkers') {\r\n-                  destinationLocked = !!msg.driver;\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n-                  } else {\r\n-                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n-                  }\r\n-\r\n-                  if (destMarker) map.removeLayer(destMarker);\r\n-                  if (msg.destination) {\r\n-                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                        iconSize: [30, 30],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                  }\r\n-\r\n-                  if (driverMarker) map.removeLayer(driverMarker);\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n-\r\n-                    L.circle([latitude, longitude], {\r\n-                      color: 'red',\r\n-                      radius: 10,\r\n-                      fillOpacity: 0.9\r\n-                    }).addTo(map);\r\n-\r\n-                    driverMarker = L.marker([latitude, longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', \r\n-                        iconSize: [40, 40],\r\n-                        iconAnchor: [20, 40],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                      .setZIndexOffset(1000);\r\n-                  }\r\n-                }\r\n-              });\r\n-            }\r\n-          </script>\r\n-\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-\r\n-    setMapHtml(html);\r\n-    }, [location]);\r\n-    \r\n-\r\n-    useEffect(() => {\r\n-    if (!mapRef.current) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? {\r\n-          latitude: matchedDriver.location.latitude,\r\n-          longitude: matchedDriver.location.longitude,\r\n-        }\r\n-      : null;\r\n-\r\n-    console.log(\"üì§ Sending to WebView:\", {\r\n-      type: \"setMarkers\",\r\n-      destination,\r\n-      driver: matchedDriver?.location,\r\n-    });\r\n-\r\n-\r\n-    mapRef.current.postMessage(\r\n-      JSON.stringify({\r\n-        type: \"setMarkers\",\r\n-        destination,\r\n-        driver: driverCoords,\r\n-      })\r\n-    );\r\n-  }, [destination, matchedDriver]);\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId\r\n-    };\r\n-\r\n-    try {\r\n-      setShowBookingForm(false); // hide form\r\n-      setSearching(true);        // show searching state\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      setBookingId(result.booking.id);\r\n-\r\n-      // Start polling for driver for up to 10 minutes\r\n-      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n-      const startTime = Date.now();\r\n-\r\n-      const poll = async () => {\r\n-        try {\r\n-          const [driverRes, statusRes] = await Promise.all([\r\n-            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n-            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n-          ]);\r\n-\r\n-          const driverData = await driverRes.json();\r\n-          const statusData = await statusRes.json();\r\n-\r\n-          if (driverData?.driver) {\r\n-            setMatchedDriver({\r\n-              driverName: driverData.driver.driverName,\r\n-              driverId: driverData.driver._id,\r\n-              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-              location: statusData.location || null, // Live GPS\r\n-            });\r\n-\r\n-            console.log(\"üö® DRIVER DATA FROM BACKEND:\", driverData.driver);\r\n-            console.log(\"üìç LIVE LOCATION:\", statusData.location);\r\n-            setSearching(false);\r\n-            return;\r\n-          }\r\n-        } catch (err) {\r\n-          console.log(\"‚è≥ Still waiting for driver...\");\r\n-        }\r\n-\r\n-        if (Date.now() - startTime < maxWaitTime) {\r\n-          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n-        } else {\r\n-          setSearching(false); // stop searching silently\r\n-          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n-        }\r\n-      };\r\n-\r\n-      poll(); // start polling\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Booking error:\", error);\r\n-      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => {\r\n-      showSub.remove();\r\n-      hideSub.remove();\r\n-    };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let interval;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n-          setMatchedDriver(myBooking);\r\n-        }\r\n-      } catch (err) {\r\n-        console.error(\"‚ùå Poll error:\", err);\r\n-      }\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) {\r\n-                  mapRef.current = ref;\r\n-                }\r\n-              }}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled={true}\r\n-              style={{\r\n-                position: \"absolute\",\r\n-                top: 0,\r\n-                left: 0,\r\n-                right: 0,\r\n-                bottom: 0,\r\n-                zIndex: 0,\r\n-              }}\r\n-              onMessage={(event) => {\r\n-                console.log(\"‚úÖ Received from WebView:\", event.nativeEvent.data);\r\n-                const msg = event.nativeEvent.data;\r\n-                console.log(\"üì• WebView message:\", msg);\r\n-\r\n-                try {\r\n-                  const parsed = JSON.parse(msg);\r\n-                  if (parsed.latitude && parsed.longitude) {\r\n-                    setDestination(parsed);\r\n-                  }\r\n-                } catch (e) {\r\n-                  // Debug string from inside the WebView like \"üß≠ DRIVER MARKER: ...\"\r\n-                }\r\n-              }}\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {/* ‚úÖ Show this if driver is found */}\r\n-              {matchedDriver && (\r\n-                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  {matchedDriver.selfieImage && (\r\n-                    <Image\r\n-                      source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                      style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n-                    />\r\n-                  )}\r\n-                  <Text>Name: {matchedDriver.driverName}</Text>\r\n-                  <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                  <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setMatchedDriver(null);\r\n-                      setBookingId(null);\r\n-                      setSearching(false);\r\n-                      setDestination(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            {showBookingForm && (\r\n-              <View style={styles.card}>\r\n-                <View style={styles.cardHeader} />\r\n-                <TouchableOpacity style={styles.inputBox}>\r\n-                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                  <Text style={styles.inputText}>\r\n-                    {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n-                  </Text>\r\n-                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-                </TouchableOpacity>\r\n-                <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-                <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                <View style={styles.totalFareContainer}>\r\n-                  <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n-                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!matchedDriver && !searching && !showBookingForm && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{\r\n-                  position: \"absolute\",\r\n-                  bottom: 85,\r\n-                  backgroundColor: \"#81C3E1\",\r\n-                  padding: 10,\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-\r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n-            </View>\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, margin: 60},\r\n-  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n-  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n-  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n-  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n-  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n-  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n-  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n-  bookNowText: { fontSize: 16 },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n-});\r\n"
                },
                {
                    "date": 1747737668279,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,9 +74,9 @@\n     // const backHandler = BackHandler.addEventListener(\r\n     //   \"hardwareBackPress\",\r\n     //   backAction\r\n     // );\r\n-    return () => backHandler.remove();\r\n+    // return () => backHandler.remove();\r\n   }, []);\r\n \r\n \r\n \r\n@@ -406,9 +406,9 @@\n                 </View>\r\n               )}\r\n \r\n               {/* ‚úÖ Show this if driver is found */}\r\n-              {matchedDriver && (\r\n+              {matchedDriver && !bookingConfirmed && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   {matchedDriver.selfieImage && (\r\n                     <Image\r\n"
                },
                {
                    "date": 1747737676846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -406,9 +406,9 @@\n                 </View>\r\n               )}\r\n \r\n               {/* ‚úÖ Show this if driver is found */}\r\n-              {matchedDriver && !bookingConfirmed && (\r\n+              {matchedDriver && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   {matchedDriver.selfieImage && (\r\n                     <Image\r\n"
                },
                {
                    "date": 1747737778957,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,13 +70,13 @@\n       ]);\r\n       return true; \r\n     };\r\n \r\n-    // const backHandler = BackHandler.addEventListener(\r\n-    //   \"hardwareBackPress\",\r\n-    //   backAction\r\n-    // );\r\n-    // return () => backHandler.remove();\r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n+    return () => backHandler.remove();\r\n   }, []);\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1747748209247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,13 +70,13 @@\n       ]);\r\n       return true; \r\n     };\r\n \r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n-    return () => backHandler.remove();\r\n+    // const backHandler = BackHandler.addEventListener(\r\n+    //   \"hardwareBackPress\",\r\n+    //   backAction\r\n+    // );\r\n+    // return () => backHandler.remove();\r\n   }, []);\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1747748412403,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -43,9 +43,9 @@\n     experienceYears: string;\r\n     selfieImage: string;\r\n     location: { latitude: number; longitude: number }; \r\n   } | null>(null);\r\n-\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false); \r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n"
                },
                {
                    "date": 1747748429805,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -70,13 +70,13 @@\n       ]);\r\n       return true; \r\n     };\r\n \r\n-    // const backHandler = BackHandler.addEventListener(\r\n-    //   \"hardwareBackPress\",\r\n-    //   backAction\r\n-    // );\r\n-    // return () => backHandler.remove();\r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n+    return () => backHandler.remove();\r\n   }, []);\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1747749349705,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -333,10 +333,11 @@\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n         const allBookings = await res.json();\r\n         const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !myBooking.passengerConfirmed) {\r\n-          setMatchedDriver(myBooking);\r\n+        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          console.log(\"‚úÖ Driver accepted the booking!\");\r\n         }\r\n       } catch (err) {\r\n         console.error(\"‚ùå Poll error:\", err);\r\n       }\r\n"
                },
                {
                    "date": 1747749495987,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -207,37 +207,39 @@\n       </html>\r\n     `;\r\n \r\n     setMapHtml(html);\r\n-    }, [location]);\r\n+  }, [location]);\r\n     \r\n \r\n-    useEffect(() => {\r\n-    if (!mapRef.current) return;\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n \r\n     const driverCoords = matchedDriver?.location\r\n       ? {\r\n           latitude: matchedDriver.location.latitude,\r\n           longitude: matchedDriver.location.longitude,\r\n         }\r\n       : null;\r\n \r\n-    console.log(\"üì§ Sending to WebView:\", {\r\n-      type: \"setMarkers\",\r\n-      destination,\r\n-      driver: matchedDriver?.location,\r\n-    });\r\n-\r\n-\r\n-    mapRef.current.postMessage(\r\n-      JSON.stringify({\r\n+    if (driverCoords && destination) {\r\n+      console.log(\"üì§ Sending to WebView:\", {\r\n         type: \"setMarkers\",\r\n         destination,\r\n         driver: driverCoords,\r\n-      })\r\n-    );\r\n-  }, [destination, matchedDriver]);\r\n+      });\r\n \r\n+      mapRef.current.postMessage(\r\n+        JSON.stringify({\r\n+          type: \"setMarkers\",\r\n+          destination,\r\n+          driver: driverCoords,\r\n+        })\r\n+      );\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed]);\r\n+\r\n+\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n"
                },
                {
                    "date": 1747749553977,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -409,9 +409,9 @@\n                 </View>\r\n               )}\r\n \r\n               {/* ‚úÖ Show this if driver is found */}\r\n-              {matchedDriver && (\r\n+              {matchedDriver && !bookingConfirmed && (\r\n                 <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n                   {matchedDriver.selfieImage && (\r\n                     <Image\r\n"
                },
                {
                    "date": 1748018171951,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -422,14 +422,27 @@\n                   <Text>Name: {matchedDriver.driverName}</Text>\r\n                   <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                   <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                   <TouchableOpacity\r\n-                    onPress={() => {\r\n+                    onPress={async () => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n                       setMatchedDriver(null);\r\n-                      setBookingId(null);\r\n-                      setSearching(false);\r\n                       setDestination(null);\r\n+                      setBookingConfirmed(false);\r\n+\r\n                       if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+\r\n+                      try {\r\n+                        await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                          method: \"POST\",\r\n+                          headers: { \"Content-Type\": \"application/json\" },\r\n+                          body: JSON.stringify({ bookingId }),\r\n+                        });\r\n+                        console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n+                      } catch (err) {\r\n+                        console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n+                      }\r\n                     }}\r\n                     style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n                   >\r\n                     <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n"
                },
                {
                    "date": 1748018226939,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -452,15 +452,15 @@\n             </View>\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n-                <TouchableOpacity style={styles.inputBox}>\r\n+                <View style={styles.inputBox}>\r\n                   <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n                   <Text style={styles.inputText}>\r\n                     {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n                   </Text>\r\n                   <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-                </TouchableOpacity>\r\n+                </View>\r\n                 <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n                 <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n                 <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n                 <View style={styles.totalFareContainer}>\r\n"
                },
                {
                    "date": 1748018954264,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -423,16 +423,8 @@\n                   <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                   <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                   <TouchableOpacity\r\n                     onPress={async () => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      setMatchedDriver(null);\r\n-                      setDestination(null);\r\n-                      setBookingConfirmed(false);\r\n-\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-\r\n                       try {\r\n                         await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n                           method: \"POST\",\r\n                           headers: { \"Content-Type\": \"application/json\" },\r\n@@ -441,8 +433,24 @@\n                         console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n                       } catch (err) {\r\n                         console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n                       }\r\n+\r\n+                      // ‚úÖ Reset all state\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      setMatchedDriver(null);\r\n+                      setDestination(null);\r\n+                      setBookingConfirmed(false);\r\n+\r\n+                      // ‚úÖ Re-enable map clicks (by removing destinationLocked)\r\n+                      mapRef.current?.postMessage(JSON.stringify({\r\n+                        type: \"setMarkers\",\r\n+                        destination: null,\r\n+                        driver: null\r\n+                      }));\r\n+\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                     }}\r\n                     style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n                   >\r\n                     <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n"
                },
                {
                    "date": 1748327575305,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -329,27 +329,38 @@\n   }, []);\r\n \r\n   useEffect(() => {\r\n     let interval;\r\n+    let alertShown = false; // ‚úÖ new\r\n+\r\n     const pollForDriverMatch = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n         const allBookings = await res.json();\r\n         const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          console.log(\"‚úÖ Driver accepted the booking!\");\r\n+\r\n+        if (myBooking) {\r\n+          if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+            setBookingConfirmed(true);\r\n+            console.log(\"‚úÖ Driver accepted the booking!\");\r\n+          }\r\n+          if (myBooking.driverConfirmed && !alertShown) {\r\n+            alertShown = true;\r\n+            Alert.alert(\"Driver Confirmed\", \"The driver confirmed your ride and is on the way!\");\r\n+          }\r\n         }\r\n       } catch (err) {\r\n         console.error(\"‚ùå Poll error:\", err);\r\n       }\r\n     };\r\n+\r\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n+  }, [bookingId, bookingConfirmed]);\r\n \r\n \r\n+\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1748330028990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -48,8 +48,10 @@\n   const [bookingId, setBookingId] = useState(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false); \r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+\r\n   \r\n   \r\n \r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1748334202074,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -422,53 +422,64 @@\n                 </View>\r\n               )}\r\n \r\n               {/* ‚úÖ Show this if driver is found */}\r\n-              {matchedDriver && !bookingConfirmed && (\r\n-                <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                  {matchedDriver.selfieImage && (\r\n-                    <Image\r\n-                      source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                      style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n-                    />\r\n-                  )}\r\n-                  <Text>Name: {matchedDriver.driverName}</Text>\r\n-                  <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                  <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={async () => {\r\n-                      try {\r\n-                        await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                          method: \"POST\",\r\n-                          headers: { \"Content-Type\": \"application/json\" },\r\n-                          body: JSON.stringify({ bookingId }),\r\n-                        });\r\n-                        console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n-                      } catch (err) {\r\n-                        console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n-                      }\r\n+              {matchedDriver && (\r\n+                <View style={{ position: \"absolute\", bottom: 100, right: 20 }}>\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity\r\n+                      style={{ backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+                      onPress={() => setInfoBoxMinimized(false)}\r\n+                    >\r\n+                      <Text style={{ color: \"white\", fontWeight: \"bold\" }}>View Driver</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                      <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                      {matchedDriver.selfieImage && (\r\n+                        <Image\r\n+                          source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                          style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n+                        />\r\n+                      )}\r\n+                      <Text>Name: {matchedDriver.driverName}</Text>\r\n+                      <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                      <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                      <TouchableOpacity\r\n+                        onPress={async () => {\r\n+                          try {\r\n+                            await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                              method: \"POST\",\r\n+                              headers: { \"Content-Type\": \"application/json\" },\r\n+                              body: JSON.stringify({ bookingId }),\r\n+                            });\r\n+                            console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n+                          } catch (err) {\r\n+                            console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n+                          }\r\n \r\n-                      // ‚úÖ Reset all state\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      setMatchedDriver(null);\r\n-                      setDestination(null);\r\n-                      setBookingConfirmed(false);\r\n+                          // ‚úÖ Reset all state\r\n+                          setSearching(false);\r\n+                          setBookingId(null);\r\n+                          setMatchedDriver(null);\r\n+                          setDestination(null);\r\n+                          setBookingConfirmed(false);\r\n \r\n-                      // ‚úÖ Re-enable map clicks (by removing destinationLocked)\r\n-                      mapRef.current?.postMessage(JSON.stringify({\r\n-                        type: \"setMarkers\",\r\n-                        destination: null,\r\n-                        driver: null\r\n-                      }));\r\n+                          // ‚úÖ Re-enable map clicks (by removing destinationLocked)\r\n+                          mapRef.current?.postMessage(JSON.stringify({\r\n+                            type: \"setMarkers\",\r\n+                            destination: null,\r\n+                            driver: null\r\n+                          }));\r\n \r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n+                          if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                        }}\r\n+                        style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                      >\r\n+                        <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  )}\r\n                 </View>\r\n               )}\r\n             </View>\r\n             {showBookingForm && (\r\n"
                },
                {
                    "date": 1748334592583,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -421,67 +421,95 @@\n                   </TouchableOpacity>\r\n                 </View>\r\n               )}\r\n \r\n-              {/* ‚úÖ Show this if driver is found */}\r\n               {matchedDriver && (\r\n-                <View style={{ position: \"absolute\", bottom: 100, right: 20 }}>\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: 80, // just above the bottom nav\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n                   {infoBoxMinimized ? (\r\n                     <TouchableOpacity\r\n-                      style={{ backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+                      style={{\r\n+                        alignItems: \"center\",\r\n+                        padding: 10,\r\n+                      }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n-                      <Text style={{ color: \"white\", fontWeight: \"bold\" }}>View Driver</Text>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n-                    <View style={{ backgroundColor: \"#d1fcd3\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                      <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                      {matchedDriver.selfieImage && (\r\n-                        <Image\r\n-                          source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                          style={{ width: 80, height: 80, borderRadius: 40, marginVertical: 8 }}\r\n-                        />\r\n-                      )}\r\n-                      <Text>Name: {matchedDriver.driverName}</Text>\r\n-                      <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                      <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                      <TouchableOpacity\r\n-                        onPress={async () => {\r\n-                          try {\r\n-                            await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                              method: \"POST\",\r\n-                              headers: { \"Content-Type\": \"application/json\" },\r\n-                              body: JSON.stringify({ bookingId }),\r\n-                            });\r\n-                            console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n-                          } catch (err) {\r\n-                            console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n-                          }\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                        </View>\r\n+                      </View>\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity\r\n+                          onPress={() => setInfoBoxMinimized(true)}\r\n+                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n+                            } catch (err) {\r\n+                              console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n+                            }\r\n \r\n-                          // ‚úÖ Reset all state\r\n-                          setSearching(false);\r\n-                          setBookingId(null);\r\n-                          setMatchedDriver(null);\r\n-                          setDestination(null);\r\n-                          setBookingConfirmed(false);\r\n+                            // Reset all state\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n \r\n-                          // ‚úÖ Re-enable map clicks (by removing destinationLocked)\r\n-                          mapRef.current?.postMessage(JSON.stringify({\r\n-                            type: \"setMarkers\",\r\n-                            destination: null,\r\n-                            driver: null\r\n-                          }));\r\n+                            mapRef.current?.postMessage(\r\n+                              JSON.stringify({\r\n+                                type: \"setMarkers\",\r\n+                                destination: null,\r\n+                                driver: null,\r\n+                              })\r\n+                            );\r\n \r\n-                          if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                        }}\r\n-                        style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                      >\r\n-                        <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n                   )}\r\n                 </View>\r\n               )}\r\n+\r\n             </View>\r\n             {showBookingForm && (\r\n               <View style={styles.card}>\r\n                 <View style={styles.cardHeader} />\r\n"
                },
                {
                    "date": 1748334606938,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,9 +425,8 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: 80, // just above the bottom nav\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1748334616195,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,8 +425,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n+                    bottom: 40, // just above the bottom nav\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1748334624983,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,9 +425,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: 40, // just above the bottom nav\r\n+                    bottom: 20, // just above the bottom nav\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1748334655251,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -425,9 +425,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: 20, // just above the bottom nav\r\n+                    bottom: 10, // just above the bottom nav\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n@@ -443,9 +443,9 @@\n                         padding: 10,\r\n                       }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>--------------</Text>\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n"
                },
                {
                    "date": 1748334925953,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -438,14 +438,25 @@\n                 >\r\n                   {infoBoxMinimized ? (\r\n                     <TouchableOpacity\r\n                       style={{\r\n-                        alignItems: \"center\",\r\n-                        padding: 10,\r\n+                        position: \"absolute\",\r\n+                        bottom: 80, // above bottom nav\r\n+                        left: 20,\r\n+                        width: 50,\r\n+                        height: 50,\r\n+                        borderRadius: 25,\r\n+                        overflow: \"hidden\",\r\n+                        borderWidth: 2,\r\n+                        borderColor: \"white\",\r\n+                        elevation: 3,\r\n                       }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>--------------</Text>\r\n+                      <Image\r\n+                        source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                        style={{ width: \"100%\", height: \"100%\" }}\r\n+                      />\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n"
                },
                {
                    "date": 1748335152998,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,85 +439,74 @@\n                   {infoBoxMinimized ? (\r\n                     <TouchableOpacity\r\n                       style={{\r\n                         position: \"absolute\",\r\n-                        bottom: 80, // above bottom nav\r\n+                        bottom: 85, // or adjust slightly above bottom nav\r\n                         left: 20,\r\n-                        width: 50,\r\n-                        height: 50,\r\n-                        borderRadius: 25,\r\n+                        width: 60,\r\n+                        height: 60,\r\n+                        borderRadius: 30,\r\n                         overflow: \"hidden\",\r\n+                        backgroundColor: \"#fff\",\r\n                         borderWidth: 2,\r\n-                        borderColor: \"white\",\r\n-                        elevation: 3,\r\n+                        borderColor: \"#fff\",\r\n+                        elevation: 5,\r\n+                        shadowColor: \"#000\",\r\n+                        shadowOpacity: 0.3,\r\n+                        shadowRadius: 3,\r\n+                        shadowOffset: { width: 0, height: 2 },\r\n                       }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n                       <Image\r\n                         source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                        style={{ width: \"100%\", height: \"100%\" }}\r\n+                        style={{ width: \"100%\", height: \"100%\", borderRadius: 30 }}\r\n                       />\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n-                    <>\r\n+                    <View\r\n+                      style={{\r\n+                        position: \"absolute\",\r\n+                        bottom: 85,\r\n+                        left: 20,\r\n+                        backgroundColor: \"#d1fcd3\",\r\n+                        padding: 10,\r\n+                        borderRadius: 10,\r\n+                        elevation: 5,\r\n+                        shadowColor: \"#000\",\r\n+                        shadowOpacity: 0.2,\r\n+                        shadowRadius: 3,\r\n+                        shadowOffset: { width: 0, height: 2 },\r\n+                      }}\r\n+                    >\r\n+                      {/* Driver info here */}\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                        <Image\r\n+                          source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                          style={{ width: 40, height: 40, borderRadius: 20, marginRight: 10 }}\r\n+                        />\r\n+                        <View>\r\n+                          <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text style={{ fontSize: 12 }}>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text style={{ fontSize: 12 }}>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                         </View>\r\n                       </View>\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity\r\n-                          onPress={() => setInfoBoxMinimized(true)}\r\n-                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n-                            } catch (err) {\r\n-                              console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n-                            }\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setInfoBoxMinimized(true)}\r\n+                        style={{\r\n+                          backgroundColor: \"#f44336\",\r\n+                          padding: 5,\r\n+                          borderRadius: 5,\r\n+                          marginTop: 5,\r\n+                        }}\r\n+                      >\r\n+                        <Text style={{ color: \"white\", textAlign: \"center\", fontSize: 12 }}>\r\n+                          MINIMIZE\r\n+                        </Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  )}\r\n \r\n-                            // Reset all state\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-\r\n-                            mapRef.current?.postMessage(\r\n-                              JSON.stringify({\r\n-                                type: \"setMarkers\",\r\n-                                destination: null,\r\n-                                driver: null,\r\n-                              })\r\n-                            );\r\n-\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n                 </View>\r\n               )}\r\n \r\n             </View>\r\n"
                },
                {
                    "date": 1748335165759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,9 +439,9 @@\n                   {infoBoxMinimized ? (\r\n                     <TouchableOpacity\r\n                       style={{\r\n                         position: \"absolute\",\r\n-                        bottom: 85, // or adjust slightly above bottom nav\r\n+                        bottom: 10,\r\n                         left: 20,\r\n                         width: 60,\r\n                         height: 60,\r\n                         borderRadius: 30,\r\n"
                },
                {
                    "date": 1748335208579,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -439,74 +439,85 @@\n                   {infoBoxMinimized ? (\r\n                     <TouchableOpacity\r\n                       style={{\r\n                         position: \"absolute\",\r\n-                        bottom: 10,\r\n+                        bottom: 80, // above bottom nav\r\n                         left: 20,\r\n-                        width: 60,\r\n-                        height: 60,\r\n-                        borderRadius: 30,\r\n+                        width: 50,\r\n+                        height: 50,\r\n+                        borderRadius: 25,\r\n                         overflow: \"hidden\",\r\n-                        backgroundColor: \"#fff\",\r\n                         borderWidth: 2,\r\n-                        borderColor: \"#fff\",\r\n-                        elevation: 5,\r\n-                        shadowColor: \"#000\",\r\n-                        shadowOpacity: 0.3,\r\n-                        shadowRadius: 3,\r\n-                        shadowOffset: { width: 0, height: 2 },\r\n+                        borderColor: \"white\",\r\n+                        elevation: 3,\r\n                       }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n                       <Image\r\n                         source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                        style={{ width: \"100%\", height: \"100%\", borderRadius: 30 }}\r\n+                        style={{ width: \"100%\", height: \"100%\" }}\r\n                       />\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n-                    <View\r\n-                      style={{\r\n-                        position: \"absolute\",\r\n-                        bottom: 85,\r\n-                        left: 20,\r\n-                        backgroundColor: \"#d1fcd3\",\r\n-                        padding: 10,\r\n-                        borderRadius: 10,\r\n-                        elevation: 5,\r\n-                        shadowColor: \"#000\",\r\n-                        shadowOpacity: 0.2,\r\n-                        shadowRadius: 3,\r\n-                        shadowOffset: { width: 0, height: 2 },\r\n-                      }}\r\n-                    >\r\n-                      {/* Driver info here */}\r\n+                    <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        <Image\r\n-                          source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                          style={{ width: 40, height: 40, borderRadius: 20, marginRight: 10 }}\r\n-                        />\r\n-                        <View>\r\n-                          <Text style={{ fontWeight: \"bold\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text style={{ fontSize: 12 }}>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text style={{ fontSize: 12 }}>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                         </View>\r\n                       </View>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setInfoBoxMinimized(true)}\r\n-                        style={{\r\n-                          backgroundColor: \"#f44336\",\r\n-                          padding: 5,\r\n-                          borderRadius: 5,\r\n-                          marginTop: 5,\r\n-                        }}\r\n-                      >\r\n-                        <Text style={{ color: \"white\", textAlign: \"center\", fontSize: 12 }}>\r\n-                          MINIMIZE\r\n-                        </Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity\r\n+                          onPress={() => setInfoBoxMinimized(true)}\r\n+                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n+                            } catch (err) {\r\n+                              console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n+                            }\r\n+\r\n+                            // Reset all state\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+\r\n+                            mapRef.current?.postMessage(\r\n+                              JSON.stringify({\r\n+                                type: \"setMarkers\",\r\n+                                destination: null,\r\n+                                driver: null,\r\n+                              })\r\n+                            );\r\n+\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n                   )}\r\n-\r\n                 </View>\r\n               )}\r\n \r\n             </View>\r\n"
                },
                {
                    "date": 1748335285234,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -429,9 +429,9 @@\n                     bottom: 10, // just above the bottom nav\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n+                    backgroundColor: \"#fff\",\r\n                     borderRadius: 10,\r\n                     padding: 10,\r\n                     elevation: 3,\r\n                   }}\r\n"
                },
                {
                    "date": 1748335675160,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -429,34 +429,23 @@\n                     bottom: 10, // just above the bottom nav\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n-                    backgroundColor: \"#fff\",\r\n+                    backgroundColor: \"#d1fcd3\",\r\n                     borderRadius: 10,\r\n                     padding: 10,\r\n                     elevation: 3,\r\n                   }}\r\n                 >\r\n                   {infoBoxMinimized ? (\r\n                     <TouchableOpacity\r\n                       style={{\r\n-                        position: \"absolute\",\r\n-                        bottom: 80, // above bottom nav\r\n-                        left: 20,\r\n-                        width: 50,\r\n-                        height: 50,\r\n-                        borderRadius: 25,\r\n-                        overflow: \"hidden\",\r\n-                        borderWidth: 2,\r\n-                        borderColor: \"white\",\r\n-                        elevation: 3,\r\n+                        alignItems: \"center\",\r\n+                        padding: 10,\r\n                       }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n-                      <Image\r\n-                        source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                        style={{ width: \"100%\", height: \"100%\" }}\r\n-                      />\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}></Text>\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n"
                },
                {
                    "date": 1748335680429,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -443,9 +443,9 @@\n                         padding: 10,\r\n                       }}\r\n                       onPress={() => setInfoBoxMinimized(false)}\r\n                     >\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}></Text>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n"
                },
                {
                    "date": 1748336208700,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -331,38 +331,30 @@\n   }, []);\r\n \r\n   useEffect(() => {\r\n     let interval;\r\n-    let alertShown = false; // ‚úÖ new\r\n-\r\n     const pollForDriverMatch = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n         const allBookings = await res.json();\r\n         const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (myBooking) {\r\n-          if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-            setBookingConfirmed(true);\r\n-            console.log(\"‚úÖ Driver accepted the booking!\");\r\n-          }\r\n-          if (myBooking.driverConfirmed && !alertShown) {\r\n-            alertShown = true;\r\n-            Alert.alert(\"Driver Confirmed\", \"The driver confirmed your ride and is on the way!\");\r\n-          }\r\n+        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          console.log(\"‚úÖ Driver accepted the booking!\");\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n         }\r\n       } catch (err) {\r\n         console.error(\"‚ùå Poll error:\", err);\r\n       }\r\n     };\r\n-\r\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n \r\n \r\n+\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1748350200647,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -538,9 +538,9 @@\n             )}\r\n \r\n \r\n             <View style={styles.bottomNav}>\r\n-              <TouchableOpacity><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"./phome.tsx\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n             </View>\r\n"
                },
                {
                    "date": 1748350221691,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -538,9 +538,9 @@\n             )}\r\n \r\n \r\n             <View style={styles.bottomNav}>\r\n-              <TouchableOpacity onPress={() => router.push(\"./phome.tsx\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n             </View>\r\n"
                },
                {
                    "date": 1748350242082,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -539,9 +539,9 @@\n \r\n \r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n               <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n             </View>\r\n           </View>\r\n"
                },
                {
                    "date": 1748350260383,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -540,10 +540,10 @@\n \r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n               <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-              <TouchableOpacity><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n             </View>\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n"
                },
                {
                    "date": 1748356701891,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,569 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import {\r\n+  View,\r\n+  Text,\r\n+  StyleSheet,\r\n+  Dimensions,\r\n+  TouchableOpacity,\r\n+  StatusBar,\r\n+  TextInput,\r\n+  Alert,\r\n+  KeyboardAvoidingView,\r\n+  Platform,\r\n+  TouchableWithoutFeedback,\r\n+  Keyboard,\r\n+  Image,\r\n+  BackHandler\r\n+} from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+\r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(20);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number }; \r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false); \r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+\r\n+  \r\n+  \r\n+\r\n+  useEffect(() => {\r\n+    const backAction = () => {\r\n+      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+        {\r\n+          text: \"Cancel\",\r\n+          onPress: () => null,\r\n+          style: \"cancel\"\r\n+        },\r\n+        {\r\n+          text: \"Logout\",\r\n+          onPress: async () => {\r\n+            await AsyncStorage.removeItem(\"passengerId\");\r\n+            router.replace(\"/login_and_reg/plogin\"); \r\n+          }\r\n+        }\r\n+      ]);\r\n+      return true; \r\n+    };\r\n+\r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n+    return () => backHandler.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n+\r\n+    const html = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style>\r\n+            html, body, #map {\r\n+              height: 100%;\r\n+              margin: 0;\r\n+              padding: 0;\r\n+              overflow: hidden;\r\n+              touch-action: auto;\r\n+            }\r\n+            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n+\r\n+            .driver-label {\r\n+              font-weight: bold;\r\n+              color: red;\r\n+              background: white;\r\n+              padding: 2px 5px;\r\n+              border-radius: 4px;\r\n+              font-size: 14px;\r\n+            }\r\n+          </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            window.onload = function () {\r\n+              const map = L.map('map', {\r\n+                zoomControl: false,\r\n+                dragging: true,\r\n+                scrollWheelZoom: true,\r\n+                touchZoom: true,\r\n+                doubleClickZoom: true,\r\n+                boxZoom: true,\r\n+              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n+\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 19,\r\n+                attribution: '¬© OpenStreetMap contributors'\r\n+              }).addTo(map);\r\n+\r\n+              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n+                icon: L.icon({\r\n+                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+                  iconSize: [30, 30],\r\n+                })\r\n+              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n+\r\n+              let destMarker = null;\r\n+              let driverMarker = null;\r\n+\r\n+              let destinationLocked = false;\r\n+              map.on('click', function(e) {\r\n+                if (destinationLocked) return;\r\n+\r\n+                const { lat, lng } = e.latlng;\r\n+                if (destMarker) map.removeLayer(destMarker);\r\n+                destMarker = L.marker([lat, lng], {\r\n+                  icon: L.icon({\r\n+                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                    iconSize: [30, 30],\r\n+                  })\r\n+                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+\r\n+                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+              });\r\n+              document.addEventListener('message', function(event) {\r\n+                const msg = JSON.parse(event.data);\r\n+                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+\r\n+                if (msg.type === 'setMarkers') {\r\n+                  destinationLocked = !!msg.driver;\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n+                  } else {\r\n+                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n+                  }\r\n+\r\n+                  if (destMarker) map.removeLayer(destMarker);\r\n+                  if (msg.destination) {\r\n+                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                        iconSize: [30, 30],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                  }\r\n+\r\n+                  if (driverMarker) map.removeLayer(driverMarker);\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n+\r\n+                    L.circle([latitude, longitude], {\r\n+                      color: 'red',\r\n+                      radius: 10,\r\n+                      fillOpacity: 0.9\r\n+                    }).addTo(map);\r\n+\r\n+                    driverMarker = L.marker([latitude, longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', \r\n+                        iconSize: [40, 40],\r\n+                        iconAnchor: [20, 40],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                      .setZIndexOffset(1000);\r\n+                  }\r\n+                }\r\n+              });\r\n+            }\r\n+          </script>\r\n+\r\n+        </body>\r\n+      </html>\r\n+    `;\r\n+\r\n+    setMapHtml(html);\r\n+  }, [location]);\r\n+    \r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? {\r\n+          latitude: matchedDriver.location.latitude,\r\n+          longitude: matchedDriver.location.longitude,\r\n+        }\r\n+      : null;\r\n+\r\n+    if (driverCoords && destination) {\r\n+      console.log(\"üì§ Sending to WebView:\", {\r\n+        type: \"setMarkers\",\r\n+        destination,\r\n+        driver: driverCoords,\r\n+      });\r\n+\r\n+      mapRef.current.postMessage(\r\n+        JSON.stringify({\r\n+          type: \"setMarkers\",\r\n+          destination,\r\n+          driver: driverCoords,\r\n+        })\r\n+      );\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed]);\r\n+\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId\r\n+    };\r\n+\r\n+    try {\r\n+      setShowBookingForm(false); // hide form\r\n+      setSearching(true);        // show searching state\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      setBookingId(result.booking.id);\r\n+\r\n+      // Start polling for driver for up to 10 minutes\r\n+      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n+      const startTime = Date.now();\r\n+\r\n+      const poll = async () => {\r\n+        try {\r\n+          const [driverRes, statusRes] = await Promise.all([\r\n+            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n+            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n+          ]);\r\n+\r\n+          const driverData = await driverRes.json();\r\n+          const statusData = await statusRes.json();\r\n+\r\n+          if (driverData?.driver) {\r\n+            setMatchedDriver({\r\n+              driverName: driverData.driver.driverName,\r\n+              driverId: driverData.driver._id,\r\n+              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+              location: statusData.location || null, // Live GPS\r\n+            });\r\n+\r\n+            setSearching(false);\r\n+            return;\r\n+          }\r\n+        } catch (err) {\r\n+          console.log(\"‚è≥ Still waiting for driver...\");\r\n+        }\r\n+\r\n+        if (Date.now() - startTime < maxWaitTime) {\r\n+          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n+        } else {\r\n+          setSearching(false); // stop searching silently\r\n+          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n+        }\r\n+      };\r\n+\r\n+      poll(); // start polling\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Booking error:\", error);\r\n+      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => {\r\n+      showSub.remove();\r\n+      hideSub.remove();\r\n+    };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          console.log(\"‚úÖ Driver accepted the booking!\");\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Poll error:\", err);\r\n+      }\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) {\r\n+                  mapRef.current = ref;\r\n+                }\r\n+              }}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled={true}\r\n+              style={{\r\n+                position: \"absolute\",\r\n+                top: 0,\r\n+                left: 0,\r\n+                right: 0,\r\n+                bottom: 0,\r\n+                zIndex: 0,\r\n+              }}\r\n+              onMessage={(event) => {\r\n+                console.log(\"‚úÖ Received from WebView:\", event.nativeEvent.data);\r\n+                const msg = event.nativeEvent.data;\r\n+                console.log(\"üì• WebView message:\", msg);\r\n+\r\n+                try {\r\n+                  const parsed = JSON.parse(msg);\r\n+                  if (parsed.latitude && parsed.longitude) {\r\n+                    setDestination(parsed);\r\n+                  }\r\n+                } catch (e) {\r\n+                  // Debug string from inside the WebView like \"üß≠ DRIVER MARKER: ...\"\r\n+                }\r\n+              }}\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: 10, // just above the bottom nav\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity\r\n+                      style={{\r\n+                        alignItems: \"center\",\r\n+                        padding: 10,\r\n+                      }}\r\n+                      onPress={() => setInfoBoxMinimized(false)}\r\n+                    >\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                        </View>\r\n+                      </View>\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity\r\n+                          onPress={() => setInfoBoxMinimized(true)}\r\n+                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n+                            } catch (err) {\r\n+                              console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n+                            }\r\n+\r\n+                            // Reset all state\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+\r\n+                            mapRef.current?.postMessage(\r\n+                              JSON.stringify({\r\n+                                type: \"setMarkers\",\r\n+                                destination: null,\r\n+                                driver: null,\r\n+                              })\r\n+                            );\r\n+\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+\r\n+            </View>\r\n+            {showBookingForm && (\r\n+              <View style={styles.card}>\r\n+                <View style={styles.cardHeader} />\r\n+                <View style={styles.inputBox}>\r\n+                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n+                  <Text style={styles.inputText}>\r\n+                    {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n+                  </Text>\r\n+                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+                </View>\r\n+                <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                <View style={styles.totalFareContainer}>\r\n+                  <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n+                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {!matchedDriver && !searching && !showBookingForm && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{\r\n+                  position: \"absolute\",\r\n+                  bottom: 85,\r\n+                  backgroundColor: \"#81C3E1\",\r\n+                  padding: 10,\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+\r\n+            <View style={styles.bottomNav}>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n+            </View>\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n+  overlay: {width: width, margin: 60},\r\n+  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n+  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n+  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n+  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n+  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n+  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n+  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n+  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n+  bookNowText: { fontSize: 16 },\r\n+  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+});\r\n"
                },
                {
                    "date": 1748428167422,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -566,573 +566,4 @@\n   bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n   bookNowText: { fontSize: 16 },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import {\r\n-  View,\r\n-  Text,\r\n-  StyleSheet,\r\n-  Dimensions,\r\n-  TouchableOpacity,\r\n-  StatusBar,\r\n-  TextInput,\r\n-  Alert,\r\n-  KeyboardAvoidingView,\r\n-  Platform,\r\n-  TouchableWithoutFeedback,\r\n-  Keyboard,\r\n-  Image,\r\n-  BackHandler\r\n-} from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router'; // or useNavigation if you're using react-navigation\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n-\r\n-const { width, height } = Dimensions.get(\"window\");\r\n-\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(20);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number }; \r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false); \r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-\r\n-  \r\n-  \r\n-\r\n-  useEffect(() => {\r\n-    const backAction = () => {\r\n-      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-        {\r\n-          text: \"Cancel\",\r\n-          onPress: () => null,\r\n-          style: \"cancel\"\r\n-        },\r\n-        {\r\n-          text: \"Logout\",\r\n-          onPress: async () => {\r\n-            await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\"); \r\n-          }\r\n-        }\r\n-      ]);\r\n-      return true; \r\n-    };\r\n-\r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n-    return () => backHandler.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n-\r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style>\r\n-            html, body, #map {\r\n-              height: 100%;\r\n-              margin: 0;\r\n-              padding: 0;\r\n-              overflow: hidden;\r\n-              touch-action: auto;\r\n-            }\r\n-            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n-\r\n-            .driver-label {\r\n-              font-weight: bold;\r\n-              color: red;\r\n-              background: white;\r\n-              padding: 2px 5px;\r\n-              border-radius: 4px;\r\n-              font-size: 14px;\r\n-            }\r\n-          </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            window.onload = function () {\r\n-              const map = L.map('map', {\r\n-                zoomControl: false,\r\n-                dragging: true,\r\n-                scrollWheelZoom: true,\r\n-                touchZoom: true,\r\n-                doubleClickZoom: true,\r\n-                boxZoom: true,\r\n-              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n-\r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 19,\r\n-                attribution: '¬© OpenStreetMap contributors'\r\n-              }).addTo(map);\r\n-\r\n-              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n-                icon: L.icon({\r\n-                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-                  iconSize: [30, 30],\r\n-                })\r\n-              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n-\r\n-              let destMarker = null;\r\n-              let driverMarker = null;\r\n-\r\n-              let destinationLocked = false;\r\n-              map.on('click', function(e) {\r\n-                if (destinationLocked) return;\r\n-\r\n-                const { lat, lng } = e.latlng;\r\n-                if (destMarker) map.removeLayer(destMarker);\r\n-                destMarker = L.marker([lat, lng], {\r\n-                  icon: L.icon({\r\n-                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                    iconSize: [30, 30],\r\n-                  })\r\n-                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-\r\n-                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-              });\r\n-              document.addEventListener('message', function(event) {\r\n-                const msg = JSON.parse(event.data);\r\n-                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n-\r\n-                if (msg.type === 'setMarkers') {\r\n-                  destinationLocked = !!msg.driver;\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n-                  } else {\r\n-                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n-                  }\r\n-\r\n-                  if (destMarker) map.removeLayer(destMarker);\r\n-                  if (msg.destination) {\r\n-                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                        iconSize: [30, 30],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                  }\r\n-\r\n-                  if (driverMarker) map.removeLayer(driverMarker);\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n-\r\n-                    L.circle([latitude, longitude], {\r\n-                      color: 'red',\r\n-                      radius: 10,\r\n-                      fillOpacity: 0.9\r\n-                    }).addTo(map);\r\n-\r\n-                    driverMarker = L.marker([latitude, longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', \r\n-                        iconSize: [40, 40],\r\n-                        iconAnchor: [20, 40],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                      .setZIndexOffset(1000);\r\n-                  }\r\n-                }\r\n-              });\r\n-            }\r\n-          </script>\r\n-\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-\r\n-    setMapHtml(html);\r\n-  }, [location]);\r\n-    \r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? {\r\n-          latitude: matchedDriver.location.latitude,\r\n-          longitude: matchedDriver.location.longitude,\r\n-        }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      console.log(\"üì§ Sending to WebView:\", {\r\n-        type: \"setMarkers\",\r\n-        destination,\r\n-        driver: driverCoords,\r\n-      });\r\n-\r\n-      mapRef.current.postMessage(\r\n-        JSON.stringify({\r\n-          type: \"setMarkers\",\r\n-          destination,\r\n-          driver: driverCoords,\r\n-        })\r\n-      );\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed]);\r\n-\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId\r\n-    };\r\n-\r\n-    try {\r\n-      setShowBookingForm(false); // hide form\r\n-      setSearching(true);        // show searching state\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      setBookingId(result.booking.id);\r\n-\r\n-      // Start polling for driver for up to 10 minutes\r\n-      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n-      const startTime = Date.now();\r\n-\r\n-      const poll = async () => {\r\n-        try {\r\n-          const [driverRes, statusRes] = await Promise.all([\r\n-            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n-            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n-          ]);\r\n-\r\n-          const driverData = await driverRes.json();\r\n-          const statusData = await statusRes.json();\r\n-\r\n-          if (driverData?.driver) {\r\n-            setMatchedDriver({\r\n-              driverName: driverData.driver.driverName,\r\n-              driverId: driverData.driver._id,\r\n-              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-              location: statusData.location || null, // Live GPS\r\n-            });\r\n-\r\n-            setSearching(false);\r\n-            return;\r\n-          }\r\n-        } catch (err) {\r\n-          console.log(\"‚è≥ Still waiting for driver...\");\r\n-        }\r\n-\r\n-        if (Date.now() - startTime < maxWaitTime) {\r\n-          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n-        } else {\r\n-          setSearching(false); // stop searching silently\r\n-          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n-        }\r\n-      };\r\n-\r\n-      poll(); // start polling\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Booking error:\", error);\r\n-      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => {\r\n-      showSub.remove();\r\n-      hideSub.remove();\r\n-    };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let interval;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          console.log(\"‚úÖ Driver accepted the booking!\");\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-        }\r\n-      } catch (err) {\r\n-        console.error(\"‚ùå Poll error:\", err);\r\n-      }\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) {\r\n-                  mapRef.current = ref;\r\n-                }\r\n-              }}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled={true}\r\n-              style={{\r\n-                position: \"absolute\",\r\n-                top: 0,\r\n-                left: 0,\r\n-                right: 0,\r\n-                bottom: 0,\r\n-                zIndex: 0,\r\n-              }}\r\n-              onMessage={(event) => {\r\n-                console.log(\"‚úÖ Received from WebView:\", event.nativeEvent.data);\r\n-                const msg = event.nativeEvent.data;\r\n-                console.log(\"üì• WebView message:\", msg);\r\n-\r\n-                try {\r\n-                  const parsed = JSON.parse(msg);\r\n-                  if (parsed.latitude && parsed.longitude) {\r\n-                    setDestination(parsed);\r\n-                  }\r\n-                } catch (e) {\r\n-                  // Debug string from inside the WebView like \"üß≠ DRIVER MARKER: ...\"\r\n-                }\r\n-              }}\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: 10, // just above the bottom nav\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity\r\n-                      style={{\r\n-                        alignItems: \"center\",\r\n-                        padding: 10,\r\n-                      }}\r\n-                      onPress={() => setInfoBoxMinimized(false)}\r\n-                    >\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                        </View>\r\n-                      </View>\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity\r\n-                          onPress={() => setInfoBoxMinimized(true)}\r\n-                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n-                            } catch (err) {\r\n-                              console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n-                            }\r\n-\r\n-                            // Reset all state\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-\r\n-                            mapRef.current?.postMessage(\r\n-                              JSON.stringify({\r\n-                                type: \"setMarkers\",\r\n-                                destination: null,\r\n-                                driver: null,\r\n-                              })\r\n-                            );\r\n-\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-\r\n-            </View>\r\n-            {showBookingForm && (\r\n-              <View style={styles.card}>\r\n-                <View style={styles.cardHeader} />\r\n-                <View style={styles.inputBox}>\r\n-                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                  <Text style={styles.inputText}>\r\n-                    {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n-                  </Text>\r\n-                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n-                </View>\r\n-                <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-                <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                <View style={styles.totalFareContainer}>\r\n-                  <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n-                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!matchedDriver && !searching && !showBookingForm && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{\r\n-                  position: \"absolute\",\r\n-                  bottom: 85,\r\n-                  backgroundColor: \"#81C3E1\",\r\n-                  padding: 10,\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-\r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n-            </View>\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, margin: 60},\r\n-  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n-  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n-  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n-  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n-  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n-  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n-  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n-  bookNowText: { fontSize: 16 },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n-});\r\n"
                },
                {
                    "date": 1748448727807,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -12,21 +12,22 @@\n   Platform,\r\n   TouchableWithoutFeedback,\r\n   Keyboard,\r\n   Image,\r\n-  BackHandler\r\n+  BackHandler,\r\n+  ScrollView\r\n } from \"react-native\";\r\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { router } from 'expo-router';\r\n import AsyncStorage from '@react-native-async-storage/async-storage';\r\n import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n \r\n const { width, height } = Dimensions.get(\"window\");\r\n \r\n-\r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n@@ -41,37 +42,54 @@\n     driverId: string;\r\n     franchiseNumber: string;\r\n     experienceYears: string;\r\n     selfieImage: string;\r\n-    location: { latitude: number; longitude: number }; \r\n+    location: { latitude: number; longitude: number };\r\n   } | null>(null);\r\n   const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n   const [bookingId, setBookingId] = useState(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false); \r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n \r\n-  \r\n-  \r\n+  // NEW: For address names\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n \r\n+  // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  useEffect(() => {\r\n     const backAction = () => {\r\n       Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+        { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n         {\r\n-          text: \"Cancel\",\r\n-          onPress: () => null,\r\n-          style: \"cancel\"\r\n-        },\r\n-        {\r\n           text: \"Logout\",\r\n           onPress: async () => {\r\n             await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\"); \r\n-          }\r\n-        }\r\n+            router.replace(\"/login_and_reg/plogin\");\r\n+          },\r\n+        },\r\n       ]);\r\n-      return true; \r\n+      return true;\r\n     };\r\n \r\n     const backHandler = BackHandler.addEventListener(\r\n       \"hardwareBackPress\",\r\n@@ -79,10 +97,9 @@\n     );\r\n     return () => backHandler.remove();\r\n   }, []);\r\n \r\n-\r\n-\r\n+  // Generate map HTML when location changes\r\n   useEffect(() => {\r\n     if (!location) return;\r\n \r\n     const html = `\r\n@@ -99,9 +116,8 @@\n               overflow: hidden;\r\n               touch-action: auto;\r\n             }\r\n             .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n-\r\n             .driver-label {\r\n               font-weight: bold;\r\n               color: red;\r\n               background: white;\r\n@@ -140,37 +156,26 @@\n               }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n \r\n               let destMarker = null;\r\n               let driverMarker = null;\r\n-\r\n               let destinationLocked = false;\r\n               map.on('click', function(e) {\r\n                 if (destinationLocked) return;\r\n-\r\n                 const { lat, lng } = e.latlng;\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n                 destMarker = L.marker([lat, lng], {\r\n                   icon: L.icon({\r\n                     iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n                     iconSize: [30, 30],\r\n                   })\r\n                 }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-\r\n                 window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n               });\r\n               document.addEventListener('message', function(event) {\r\n                 const msg = JSON.parse(event.data);\r\n                 window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n-\r\n                 if (msg.type === 'setMarkers') {\r\n                   destinationLocked = !!msg.driver;\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"‚úÖ DRIVER FOUND AT: \" + latitude + \", \" + longitude);\r\n-                  } else {\r\n-                    window.ReactNativeWebView.postMessage(\"‚ùå NO DRIVER IN MESSAGE\");\r\n-                  }\r\n-\r\n                   if (destMarker) map.removeLayer(destMarker);\r\n                   if (msg.destination) {\r\n                     destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n                       icon: L.icon({\r\n@@ -178,23 +183,19 @@\n                         iconSize: [30, 30],\r\n                       })\r\n                     }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n                   }\r\n-\r\n                   if (driverMarker) map.removeLayer(driverMarker);\r\n                   if (msg.driver) {\r\n                     const { latitude, longitude } = msg.driver;\r\n-                    window.ReactNativeWebView.postMessage(\"üß≠ DRIVER MARKER REQUESTED: \" + JSON.stringify(msg.driver));\r\n-\r\n                     L.circle([latitude, longitude], {\r\n                       color: 'red',\r\n                       radius: 10,\r\n                       fillOpacity: 0.9\r\n                     }).addTo(map);\r\n-\r\n                     driverMarker = L.marker([latitude, longitude], {\r\n                       icon: L.icon({\r\n-                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png', \r\n+                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n                         iconSize: [40, 40],\r\n                         iconAnchor: [20, 40],\r\n                       })\r\n                     }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n@@ -203,34 +204,53 @@\n                 }\r\n               });\r\n             }\r\n           </script>\r\n-\r\n         </body>\r\n       </html>\r\n     `;\r\n-\r\n     setMapHtml(html);\r\n   }, [location]);\r\n-    \r\n \r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        // Get address for destination\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude,\r\n+            longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(\r\n+              `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+            );\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+    } catch (e) {\r\n+      // handle parse error\r\n+    }\r\n+  };\r\n+\r\n+  // Set destination/driver markers after booking confirmed, etc\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n     const driverCoords = matchedDriver?.location\r\n       ? {\r\n           latitude: matchedDriver.location.latitude,\r\n           longitude: matchedDriver.location.longitude,\r\n         }\r\n       : null;\r\n-\r\n     if (driverCoords && destination) {\r\n-      console.log(\"üì§ Sending to WebView:\", {\r\n-        type: \"setMarkers\",\r\n-        destination,\r\n-        driver: driverCoords,\r\n-      });\r\n-\r\n       mapRef.current.postMessage(\r\n         JSON.stringify({\r\n           type: \"setMarkers\",\r\n           destination,\r\n@@ -239,16 +259,15 @@\n       );\r\n     }\r\n   }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n-\r\n+  // BOOK NOW logic unchanged\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n     const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-\r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n@@ -257,38 +276,30 @@\n       paymentMethod,\r\n       notes,\r\n       passengerId\r\n     };\r\n-\r\n     try {\r\n-      setShowBookingForm(false); // hide form\r\n-      setSearching(true);        // show searching state\r\n-\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n       const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n         method: \"POST\",\r\n         headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify(bookingData),\r\n       });\r\n-\r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n       setBookingId(result.booking.id);\r\n-\r\n       // Start polling for driver for up to 10 minutes\r\n       const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n       const startTime = Date.now();\r\n-\r\n       const poll = async () => {\r\n         try {\r\n           const [driverRes, statusRes] = await Promise.all([\r\n             fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n             fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n           ]);\r\n-\r\n           const driverData = await driverRes.json();\r\n           const statusData = await statusRes.json();\r\n-\r\n           if (driverData?.driver) {\r\n             setMatchedDriver({\r\n               driverName: driverData.driver.driverName,\r\n               driverId: driverData.driver._id,\r\n@@ -296,27 +307,22 @@\n               experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n               selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n               location: statusData.location || null, // Live GPS\r\n             });\r\n-\r\n             setSearching(false);\r\n             return;\r\n           }\r\n         } catch (err) {\r\n-          console.log(\"‚è≥ Still waiting for driver...\");\r\n+          // Still waiting\r\n         }\r\n-\r\n         if (Date.now() - startTime < maxWaitTime) {\r\n-          searchTimeoutRef.current = setTimeout(poll, 5000); // try again in 5 sec\r\n+          searchTimeoutRef.current = setTimeout(poll, 5000);\r\n         } else {\r\n-          setSearching(false); // stop searching silently\r\n-          console.log(\"‚ùå No driver found within 10 minutes.\");\r\n+          setSearching(false);\r\n         }\r\n       };\r\n-\r\n-      poll(); // start polling\r\n+      poll();\r\n     } catch (error) {\r\n-      console.error(\"‚ùå Booking error:\", error);\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n@@ -339,22 +345,18 @@\n         const allBookings = await res.json();\r\n         const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n         if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n           setBookingConfirmed(true);\r\n-          console.log(\"‚úÖ Driver accepted the booking!\");\r\n           Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n         }\r\n       } catch (err) {\r\n-        console.error(\"‚ùå Poll error:\", err);\r\n+        // error polling\r\n       }\r\n     };\r\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n-\r\n-\r\n-\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n@@ -378,22 +380,9 @@\n                 right: 0,\r\n                 bottom: 0,\r\n                 zIndex: 0,\r\n               }}\r\n-              onMessage={(event) => {\r\n-                console.log(\"‚úÖ Received from WebView:\", event.nativeEvent.data);\r\n-                const msg = event.nativeEvent.data;\r\n-                console.log(\"üì• WebView message:\", msg);\r\n-\r\n-                try {\r\n-                  const parsed = JSON.parse(msg);\r\n-                  if (parsed.latitude && parsed.longitude) {\r\n-                    setDestination(parsed);\r\n-                  }\r\n-                } catch (e) {\r\n-                  // Debug string from inside the WebView like \"üß≠ DRIVER MARKER: ...\"\r\n-                }\r\n-              }}\r\n+              onMessage={handleMapMessage}\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n@@ -417,9 +406,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: 10, // just above the bottom nav\r\n+                    bottom: 10,\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n@@ -468,28 +457,21 @@\n                                 method: \"POST\",\r\n                                 headers: { \"Content-Type\": \"application/json\" },\r\n                                 body: JSON.stringify({ bookingId }),\r\n                               });\r\n-                              console.log(\"‚úÖ Ride cancellation sent to backend\");\r\n-                            } catch (err) {\r\n-                              console.error(\"‚ùå Failed to notify backend of cancellation\", err);\r\n-                            }\r\n-\r\n-                            // Reset all state\r\n+                            } catch (err) { }\r\n                             setSearching(false);\r\n                             setBookingId(null);\r\n                             setMatchedDriver(null);\r\n                             setDestination(null);\r\n                             setBookingConfirmed(false);\r\n-\r\n                             mapRef.current?.postMessage(\r\n                               JSON.stringify({\r\n                                 type: \"setMarkers\",\r\n                                 destination: null,\r\n                                 driver: null,\r\n                               })\r\n                             );\r\n-\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n                           style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n@@ -499,27 +481,51 @@\n                     </>\r\n                   )}\r\n                 </View>\r\n               )}\r\n-\r\n             </View>\r\n+            {/* -- NEW BOOKING PANEL LAYOUT -- */}\r\n             {showBookingForm && (\r\n-              <View style={styles.card}>\r\n-                <View style={styles.cardHeader} />\r\n-                <View style={styles.inputBox}>\r\n-                  <Ionicons name=\"location-outline\" size={20} color=\"#616161\" />\r\n-                  <Text style={styles.inputText}>\r\n-                    {destination ? `Going to: ${destination.latitude.toFixed(4)}, ${destination.longitude.toFixed(4)}` : \"Saan ka papunta ngayon?\"}\r\n-                  </Text>\r\n-                  <MaterialIcons name=\"keyboard-arrow-right\" size={24} color=\"#616161\" />\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+                <ScrollView style={styles.inputsContainer}>\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Saan ang pick-up?\"\r\n+                    value={pickupName}\r\n+                    editable={true}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Saan ang drop-off?\"\r\n+                    value={dropoffName}\r\n+                    editable={true}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Notes sa driver\"\r\n+                    value={notes}\r\n+                    onChangeText={setNotes}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Paano ka magbabayad?\"\r\n+                    value={paymentMethod}\r\n+                    onChangeText={setPaymentMethod}\r\n+                  />\r\n+                </ScrollView>\r\n+                <View style={styles.fareContainer}>\r\n+                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n+                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n                 </View>\r\n-                <TextInput style={styles.inputBoxSimple} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-                <TextInput style={styles.inputBoxSimple} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                <TextInput style={styles.inputBox} placeholder=\"Paano ka magbabayad\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                <View style={styles.totalFareContainer}>\r\n-                  <View style={styles.fareBox}><Text style={styles.totalFareText}>Total Fare: ‚Ç±{fare}</Text></View>\r\n-                  <TouchableOpacity style={styles.bookNowButton} onPress={handleBookNow}><Text style={styles.bookNowText}>BOOK NOW</Text></TouchableOpacity>\r\n-                </View>\r\n               </View>\r\n             )}\r\n \r\n             {!matchedDriver && !searching && !showBookingForm && (\r\n@@ -536,9 +542,8 @@\n                 <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n               </TouchableOpacity>\r\n             )}\r\n \r\n-\r\n             <View style={styles.bottomNav}>\r\n               <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n               <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n               <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n@@ -551,19 +556,34 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: {paddingTop: 30 ,flex: 1, backgroundColor: \"#fff\" },\r\n+  container: { paddingTop: 30, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n-  overlay: {width: width, margin: 60},\r\n-  card: { position: \"absolute\", bottom: 75, backgroundColor: \"#81C3E1\", width: width * 0.95, alignSelf: \"center\", borderRadius: 10, padding: 10 },\r\n-  cardHeader: { width: 150, height: 4, backgroundColor: \"black\", alignSelf: \"center\", borderRadius: 5, marginBottom: 10 },\r\n-  inputBox: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", justifyContent: \"space-between\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputBoxSimple: { backgroundColor: \"white\", borderRadius: 8, flexDirection: \"row\", alignItems: \"center\", paddingHorizontal: 10, height: 40, marginBottom: 5 },\r\n-  inputText: { flex: 1, marginLeft: 10, fontSize: 15, color: \"#616161\" },\r\n-  totalFareContainer: { flexDirection: \"row\", marginTop: 10 },\r\n-  fareBox: { flex: 1, borderRadius: 3, backgroundColor: \"white\", justifyContent: \"center\", paddingHorizontal: 5, marginRight: 5, width: '50%' },\r\n-  totalFareText: { fontSize: 14, fontWeight: \"bold\" },\r\n-  bookNowButton: { flex: 1, backgroundColor: \"white\", borderRadius: 8, alignItems: \"center\", justifyContent: \"center\", padding: 5, marginLeft: 5, width: '50%' },\r\n-  bookNowText: { fontSize: 16 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  panel: {\r\n+    position: 'absolute',\r\n+    bottom: 85,\r\n+    width: '100%',\r\n+    backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20,\r\n+    borderTopRightRadius: 20,\r\n+    padding: 15,\r\n+    zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  radioContainer: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 5 },\r\n+  radioButton: { padding: 10, backgroundColor: '#FFF', borderRadius: 10, marginRight: 10 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: {\r\n+    flexDirection: 'row',\r\n+    justifyContent: 'space-between',\r\n+    alignItems: 'center',\r\n+    marginTop: 10,\r\n+  },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n+\r\n"
                },
                {
                    "date": 1749437552215,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,22 +1,7 @@\n import React, { useState, useEffect, useRef } from \"react\";\r\n-import {\r\n-  View,\r\n-  Text,\r\n-  StyleSheet,\r\n-  Dimensions,\r\n-  TouchableOpacity,\r\n-  StatusBar,\r\n-  TextInput,\r\n-  Alert,\r\n-  KeyboardAvoidingView,\r\n-  Platform,\r\n-  TouchableWithoutFeedback,\r\n-  Keyboard,\r\n-  Image,\r\n-  BackHandler,\r\n-  ScrollView\r\n-} from \"react-native\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n@@ -50,13 +35,20 @@\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-\r\n-  // NEW: For address names\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n   const [pickupName, setPickupName] = useState(\"\");\r\n   const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n \r\n+\r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n     if (location) {\r\n       Location.reverseGeocodeAsync({\r\n@@ -112,12 +104,9 @@\n             html, body, #map {\r\n               height: 100%;\r\n               margin: 0;\r\n               padding: 0;\r\n-              overflow: hidden;\r\n-              touch-action: auto;\r\n             }\r\n-            .leaflet-control-zoom { top: 10px !important; left: 10px !important; }\r\n             .driver-label {\r\n               font-weight: bold;\r\n               color: red;\r\n               background: white;\r\n@@ -259,14 +248,45 @@\n       );\r\n     }\r\n   }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n-  // BOOK NOW logic unchanged\r\n+  \r\n+\r\n+\r\n+\r\n+\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+    const fetchORSRoute = async (from: { latitude: number, longitude: number }, to: { latitude: number, longitude: number }) => {\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+          method: 'POST',\r\n+          headers: { 'Content-Type': 'application/json' },\r\n+          body: JSON.stringify({\r\n+            start: [from.longitude, from.latitude],\r\n+            end: [to.longitude, to.latitude],\r\n+          }),\r\n+        });\r\n+        const data = await res.json();\r\n+        const coords = data.features[0].geometry.coordinates;\r\n+\r\n+        const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n+\r\n+        if (mapRef.current) {\r\n+          mapRef.current.postMessage(JSON.stringify({\r\n+            type: 'drawRoute',\r\n+            route: polylinePoints,\r\n+          }));\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+      }\r\n+    };\r\n     const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n@@ -306,9 +326,9 @@\n               franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n               experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n               selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n               location: statusData.location || null, // Live GPS\r\n-            });\r\n+            }); \r\n             setSearching(false);\r\n             return;\r\n           }\r\n         } catch (err) {\r\n@@ -326,8 +346,13 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n+\r\n+\r\n+\r\n+\r\n+\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => {\r\n@@ -336,8 +361,23 @@\n     };\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        console.log(\"driver match\");\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId)); // üëà Fix here\r\n+        console.log(matchedDriver.driverId, bookingId);\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n     let interval;\r\n     const pollForDriverMatch = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n@@ -355,34 +395,245 @@\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          if (mapRef.current) {\r\n+            mapRef.current.postMessage(\r\n+              JSON.stringify({\r\n+                type: \"setMarkers\",\r\n+                destination: null,\r\n+                driver: null,\r\n+              })\r\n+            );\r\n+          }\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Poll error:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination,\r\n+        destinationLabel,\r\n+        notes,\r\n+        paymentMethod,\r\n+        fare,\r\n+        matchedDriver,\r\n+        bookingConfirmed,\r\n+        bookingId,\r\n+        showBookingForm,\r\n+        searching,\r\n+      };\r\n+      try {\r\n+        await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState));\r\n+      } catch (err) {\r\n+        console.warn(\"Error saving booking state:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    saveBookingState();\r\n+  }, [\r\n+    destination,\r\n+    destinationLabel,\r\n+    notes,\r\n+    paymentMethod,\r\n+    fare,\r\n+    matchedDriver,\r\n+    bookingConfirmed,\r\n+    bookingId,\r\n+    showBookingForm,\r\n+    searching,\r\n+  ]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const {\r\n+            destination,\r\n+            destinationLabel,\r\n+            notes,\r\n+            paymentMethod,\r\n+            fare,\r\n+            matchedDriver,\r\n+            bookingConfirmed,\r\n+            bookingId,\r\n+            showBookingForm,\r\n+            searching,\r\n+          } = JSON.parse(savedState);\r\n+\r\n+          if (destination) setDestination(destination);\r\n+          if (destinationLabel) setDestinationLabel(destinationLabel);\r\n+          if (notes) setNotes(notes);\r\n+          if (paymentMethod) setPaymentMethod(paymentMethod);\r\n+          if (fare) setFare(fare);\r\n+          if (matchedDriver) setMatchedDriver(matchedDriver);\r\n+          if (bookingConfirmed) setBookingConfirmed(bookingConfirmed);\r\n+          if (bookingId) setBookingId(bookingId);\r\n+          if (showBookingForm) setShowBookingForm(showBookingForm);\r\n+          if (searching) setSearching(searching);\r\n+        }\r\n+      } catch (err) {\r\n+        console.warn(\"Error loading booking state:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          driverId: driverIdToRate,\r\n+          rating: selectedRating,\r\n+        }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        // Save the feedback separately if there's a note\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (tripCompleted) {\r\n+      setShowRatingModal(true);\r\n+    }\r\n+  }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\r\n+    \"Overcharging\",\r\n+    \"Harassment\",\r\n+    \"Unproper Attire\",\r\n+    \"Refusal to Convey Passenger\",\r\n+    \"Other\",\r\n+  ];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId,\r\n+          passengerId,\r\n+          driverId: matchedDriver?.driverId,\r\n+          reportType,\r\n+          otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n-    <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+\r\n+\r\n           {mapHtml && (\r\n             <WebView\r\n+              scrollEnabled={true}\r\n               ref={(ref) => {\r\n                 if (ref && !mapRef.current) {\r\n                   mapRef.current = ref;\r\n                 }\r\n               }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n-              javaScriptEnabled={true}\r\n+              javaScriptEnabled\r\n               style={{\r\n                 position: \"absolute\",\r\n                 top: 0,\r\n                 left: 0,\r\n                 right: 0,\r\n-                bottom: 0,\r\n+                bottom: -30,\r\n                 zIndex: 0,\r\n               }}\r\n               onMessage={handleMapMessage}\r\n+              nestedScrollEnabled={true}\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n@@ -406,9 +657,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: 10,\r\n+                    bottom: -100,\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n@@ -435,9 +686,9 @@\n                             source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n                             style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n                           />\r\n                         )}\r\n-                        <View style={{ flex: 1 }}>\r\n+                        <View style={{ flex: 1}}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver.driverName}</Text>\r\n                           <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n@@ -449,16 +700,25 @@\n                           style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n+\r\n                         <TouchableOpacity\r\n+                          onPress={() => setShowReportModal(true)}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n                           onPress={async () => {\r\n                             try {\r\n                               await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n                                 method: \"POST\",\r\n                                 headers: { \"Content-Type\": \"application/json\" },\r\n                                 body: JSON.stringify({ bookingId }),\r\n                               });\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n                             } catch (err) { }\r\n                             setSearching(false);\r\n                             setBookingId(null);\r\n                             setMatchedDriver(null);\r\n@@ -482,9 +742,8 @@\n                   )}\r\n                 </View>\r\n               )}\r\n             </View>\r\n-            {/* -- NEW BOOKING PANEL LAYOUT -- */}\r\n             {showBookingForm && (\r\n               <View style={styles.panel}>\r\n                 <Text style={styles.panelTitle}>Booking Details</Text>\r\n                 <ScrollView style={styles.inputsContainer}>\r\n@@ -532,9 +791,9 @@\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n                 style={{\r\n                   position: \"absolute\",\r\n-                  bottom: 85,\r\n+                  bottom: 10,\r\n                   backgroundColor: \"#81C3E1\",\r\n                   padding: 10,\r\n                   borderRadius: 8,\r\n                 }}\r\n@@ -542,28 +801,138 @@\n                 <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n               </TouchableOpacity>\r\n             )}\r\n \r\n-            <View style={styles.bottomNav}>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-              <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n-            </View>\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+\r\n+                  <TouchableOpacity\r\n+                    style={styles.dismissButton}\r\n+                    onPress={() => {\r\n+                      setShowRatingModal(false);\r\n+                      AsyncStorage.removeItem(\"driverIdToRate\");\r\n+                    }}\r\n+                  >\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity\r\n+                        key={star}\r\n+                        onPress={() => setSelectedRating(star)}\r\n+                      >\r\n+                        <Ionicons\r\n+                          name={selectedRating >= star ? \"star\" : \"star-outline\"}\r\n+                          size={30}\r\n+                          color=\"#FFD700\"\r\n+                        />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput\r\n+                    style={styles.feedbackInput}\r\n+                    placeholder=\"Leave a comment (optional)\"\r\n+                    multiline\r\n+                    numberOfLines={3}\r\n+                    onChangeText={(text) => setNotes(text)}\r\n+                    value={notes}\r\n+                  />\r\n+\r\n+                  <TouchableOpacity\r\n+                    style={styles.submitButton}\r\n+                    onPress={submitDriverRating}\r\n+                  >\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity\r\n+                    style={styles.dismissButton}\r\n+                    onPress={() => setShowReportModal(false)}\r\n+                  >\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity\r\n+                      style={styles.dropdownButton}\r\n+                      onPress={() => setShowDropdown(!showDropdown)}\r\n+                    >\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>\r\n+                        {reportType || \"Select a violation\"}\r\n+                      </Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {reportOptions.map((option) => (\r\n+                          <TouchableOpacity\r\n+                            key={option}\r\n+                            style={styles.dropdownItem}\r\n+                            onPress={() => {\r\n+                              setReportType(option);\r\n+                              setShowDropdown(false);\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput\r\n+                      style={styles.feedbackInput}\r\n+                      placeholder=\"Describe the issue\"\r\n+                      multiline\r\n+                      numberOfLines={3}\r\n+                      value={otherReport}\r\n+                      onChangeText={setOtherReport}\r\n+                    />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity\r\n+                    style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]}\r\n+                    onPress={submitReport}\r\n+                  >\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { paddingTop: 30, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { paddingBottom: Platform.OS === \"android\" ? 20 : 0, position: \"absolute\", bottom: 0, width: \"100%\", alignItems: \"center\" },\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: {position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   panel: {\r\n     position: 'absolute',\r\n-    bottom: 85,\r\n+    bottom: 10, \r\n     width: '100%',\r\n     backgroundColor: '#E0F0FF',\r\n     borderTopLeftRadius: 20,\r\n     borderTopRightRadius: 20,\r\n@@ -580,8 +949,105 @@\n     justifyContent: 'space-between',\r\n     alignItems: 'center',\r\n     marginTop: 10,\r\n   },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\",\r\n+    top: -100,\r\n+    left: 0,\r\n+    right: 0,\r\n+    bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\",\r\n+    justifyContent: \"center\",\r\n+    alignItems: \"center\",\r\n+    zIndex: 999,\r\n+  },\r\n+  ratingModal: {\r\n+    width: \"80%\",\r\n+    backgroundColor: \"#fff\",\r\n+    borderRadius: 10,\r\n+    padding: 20,\r\n+    alignItems: \"center\",\r\n+  },\r\n+\r\n+  dismissButton: {\r\n+    position: \"absolute\",\r\n+    top: 10,\r\n+    right: 10,\r\n+    zIndex: 10,\r\n+  },\r\n+\r\n+  modalTitle: {\r\n+    fontSize: 18,\r\n+    fontWeight: \"bold\",\r\n+    marginBottom: 5,\r\n+  },\r\n+  starsContainer: {\r\n+    flexDirection: \"row\",\r\n+    marginBottom: 10,\r\n+  },\r\n+  feedbackInput: {\r\n+    width: \"100%\",\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ddd\",\r\n+    borderRadius: 8,\r\n+    padding: 10,\r\n+    marginBottom: 10,\r\n+    textAlignVertical: \"top\",\r\n+  },\r\n+  submitButton: {\r\n+    backgroundColor: \"#4caf50\",\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 20,\r\n+    borderRadius: 8,\r\n+  },\r\n+  submitButtonText: {\r\n+    color: \"#fff\",\r\n+    fontWeight: \"bold\",\r\n+  },\r\n+\r\n+  modalLabel: {\r\n+    marginTop: 5,\r\n+    marginBottom: 5,\r\n+    fontSize: 14,\r\n+    color: \"#333\",\r\n+    fontWeight: \"500\",\r\n+  },\r\n+  pickerContainer: {\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ddd\",\r\n+    borderRadius: 8,\r\n+    marginBottom: 10,\r\n+    overflow: \"hidden\",\r\n+  },\r\n+  picker: {\r\n+    height: 50,\r\n+    padding: 0,\r\n+    width: \"100%\",\r\n+  },\r\n+\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\",\r\n+    justifyContent: \"space-between\",\r\n+    alignItems: \"center\",\r\n+    padding: 10,\r\n+    backgroundColor: \"#FFF\",\r\n+    borderRadius: 8,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: {\r\n+    backgroundColor: \"#FFF\",\r\n+    borderRadius: 8,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+    marginTop: 2,\r\n+  },\r\n+  dropdownItem: { padding: 10 },\r\n+\r\n+\r\n+\r\n   totalFare: { fontWeight: 'bold' },\r\n   bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n   bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n"
                },
                {
                    "date": 1749437682985,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -246,8 +246,11 @@\n           driver: driverCoords,\r\n         })\r\n       );\r\n     }\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination); // üëà call route drawer\r\n+    }\r\n   }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n   \r\n \r\n"
                },
                {
                    "date": 1749437747618,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -228,36 +228,9 @@\n       // handle parse error\r\n     }\r\n   };\r\n \r\n-  // Set destination/driver markers after booking confirmed, etc\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? {\r\n-          latitude: matchedDriver.location.latitude,\r\n-          longitude: matchedDriver.location.longitude,\r\n-        }\r\n-      : null;\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(\r\n-        JSON.stringify({\r\n-          type: \"setMarkers\",\r\n-          destination,\r\n-          driver: driverCoords,\r\n-        })\r\n-      );\r\n-    }\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination); // üëà call route drawer\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n-  \r\n-\r\n-\r\n-\r\n-\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n@@ -350,12 +323,33 @@\n     }\r\n   };\r\n \r\n \r\n+    // Set destination/driver markers after booking confirmed, etc\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? {\r\n+          latitude: matchedDriver.location.latitude,\r\n+          longitude: matchedDriver.location.longitude,\r\n+        }\r\n+      : null;\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(\r\n+        JSON.stringify({\r\n+          type: \"setMarkers\",\r\n+          destination,\r\n+          driver: driverCoords,\r\n+        })\r\n+      );\r\n+    }\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n \r\n \r\n-\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => {\r\n"
                },
                {
                    "date": 1749437904428,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -228,41 +228,47 @@\n       // handle parse error\r\n     }\r\n   };\r\n \r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n+      const data = await res.json();\r\n+      const coords = data.features[0].geometry.coordinates;\r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n \r\n+      if (mapRef.current) {\r\n+        mapRef.current.postMessage(\r\n+          JSON.stringify({\r\n+            type: \"drawRoute\",\r\n+            route: polylinePoints,\r\n+          })\r\n+        );\r\n+      }\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n     setAlertedBookingComplete(false);\r\n     setTripCompleted(false);\r\n-    const fetchORSRoute = async (from: { latitude: number, longitude: number }, to: { latitude: number, longitude: number }) => {\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-          method: 'POST',\r\n-          headers: { 'Content-Type': 'application/json' },\r\n-          body: JSON.stringify({\r\n-            start: [from.longitude, from.latitude],\r\n-            end: [to.longitude, to.latitude],\r\n-          }),\r\n-        });\r\n-        const data = await res.json();\r\n-        const coords = data.features[0].geometry.coordinates;\r\n-\r\n-        const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n-\r\n-        if (mapRef.current) {\r\n-          mapRef.current.postMessage(JSON.stringify({\r\n-            type: 'drawRoute',\r\n-            route: polylinePoints,\r\n-          }));\r\n-        }\r\n-      } catch (err) {\r\n-        console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      }\r\n-    };\r\n     const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n"
                },
                {
                    "date": 1749438029606,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,8 +119,9 @@\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n+            let routeLine = null;\r\n             window.onload = function () {\r\n               const map = L.map('map', {\r\n                 zoomControl: false,\r\n                 dragging: true,\r\n"
                },
                {
                    "date": 1749438243186,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -162,8 +162,13 @@\n               });\r\n               document.addEventListener('message', function(event) {\r\n                 const msg = JSON.parse(event.data);\r\n                 window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+                if (msg.type === 'drawRoute' && Array.isArray(msg.route)) {\r\n+                  if (routeLine) map.removeLayer(routeLine);\r\n+                  routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n+                  map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n+                }\r\n                 if (msg.type === 'setMarkers') {\r\n                   destinationLocked = !!msg.driver;\r\n                   if (destMarker) map.removeLayer(destMarker);\r\n                   if (msg.destination) {\r\n"
                },
                {
                    "date": 1749517686654,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1073 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+\r\n+const { width, height } = Dimensions.get(\"window\");\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(20);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  useEffect(() => {\r\n+    const backAction = () => {\r\n+      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+        { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+        {\r\n+          text: \"Logout\",\r\n+          onPress: async () => {\r\n+            await AsyncStorage.removeItem(\"passengerId\");\r\n+            router.replace(\"/login_and_reg/plogin\");\r\n+          },\r\n+        },\r\n+      ]);\r\n+      return true;\r\n+    };\r\n+\r\n+    const backHandler = BackHandler.addEventListener(\r\n+      \"hardwareBackPress\",\r\n+      backAction\r\n+    );\r\n+    return () => backHandler.remove();\r\n+  }, []);\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n+\r\n+    const html = `\r\n+      <!DOCTYPE html>\r\n+      <html>\r\n+        <head>\r\n+          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+          <style>\r\n+            html, body, #map {\r\n+              height: 100%;\r\n+              margin: 0;\r\n+              padding: 0;\r\n+            }\r\n+            .driver-label {\r\n+              font-weight: bold;\r\n+              color: red;\r\n+              background: white;\r\n+              padding: 2px 5px;\r\n+              border-radius: 4px;\r\n+              font-size: 14px;\r\n+            }\r\n+          </style>\r\n+        </head>\r\n+        <body>\r\n+          <div id=\"map\"></div>\r\n+          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+          <script>\r\n+            let routeLine = null;\r\n+            window.onload = function () {\r\n+              const map = L.map('map', {\r\n+                zoomControl: false,\r\n+                dragging: true,\r\n+                scrollWheelZoom: true,\r\n+                touchZoom: true,\r\n+                doubleClickZoom: true,\r\n+                boxZoom: true,\r\n+              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n+\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 19,\r\n+                attribution: '¬© OpenStreetMap contributors'\r\n+              }).addTo(map);\r\n+\r\n+              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n+                icon: L.icon({\r\n+                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+                  iconSize: [30, 30],\r\n+                })\r\n+              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n+\r\n+              let destMarker = null;\r\n+              let driverMarker = null;\r\n+              let destinationLocked = false;\r\n+              map.on('click', function(e) {\r\n+                if (destinationLocked) return;\r\n+                const { lat, lng } = e.latlng;\r\n+                if (destMarker) map.removeLayer(destMarker);\r\n+                destMarker = L.marker([lat, lng], {\r\n+                  icon: L.icon({\r\n+                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                    iconSize: [30, 30],\r\n+                  })\r\n+                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+              });\r\n+              document.addEventListener('message', function(event) {\r\n+                const msg = JSON.parse(event.data);\r\n+                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+                if (msg.type === 'drawRoute' && Array.isArray(msg.route)) {\r\n+                  if (routeLine) map.removeLayer(routeLine);\r\n+                  routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n+                  map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n+                }\r\n+                if (msg.type === 'setMarkers') {\r\n+                  destinationLocked = !!msg.driver;\r\n+                  if (destMarker) map.removeLayer(destMarker);\r\n+                  if (msg.destination) {\r\n+                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+                        iconSize: [30, 30],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n+                  }\r\n+                  if (driverMarker) map.removeLayer(driverMarker);\r\n+                  if (msg.driver) {\r\n+                    const { latitude, longitude } = msg.driver;\r\n+                    L.circle([latitude, longitude], {\r\n+                      color: 'red',\r\n+                      radius: 10,\r\n+                      fillOpacity: 0.9\r\n+                    }).addTo(map);\r\n+                    driverMarker = L.marker([latitude, longitude], {\r\n+                      icon: L.icon({\r\n+                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+                        iconSize: [40, 40],\r\n+                        iconAnchor: [20, 40],\r\n+                      })\r\n+                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n+                      .setZIndexOffset(1000);\r\n+                  }\r\n+                }\r\n+              });\r\n+            }\r\n+          </script>\r\n+        </body>\r\n+      </html>\r\n+    `;\r\n+    setMapHtml(html);\r\n+  }, [location]);\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        // Get address for destination\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude,\r\n+            longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(\r\n+              `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+            );\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+    } catch (e) {\r\n+      // handle parse error\r\n+    }\r\n+  };\r\n+\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+        console.error(\"üõë Invalid ORS response:\", data);\r\n+        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.features[0].geometry.coordinates;\r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n+\r\n+      if (mapRef.current) {\r\n+        mapRef.current.postMessage(\r\n+          JSON.stringify({\r\n+            type: 'drawRoute',\r\n+            route: polylinePoints,\r\n+          })\r\n+        );\r\n+      }\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId\r\n+    };\r\n+    try {\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+      setBookingId(result.booking.id);\r\n+      // Start polling for driver for up to 10 minutes\r\n+      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n+      const startTime = Date.now();\r\n+      const poll = async () => {\r\n+        try {\r\n+          const [driverRes, statusRes] = await Promise.all([\r\n+            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n+            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n+          ]);\r\n+          const driverData = await driverRes.json();\r\n+          const statusData = await statusRes.json();\r\n+          if (driverData?.driver) {\r\n+            setMatchedDriver({\r\n+              driverName: driverData.driver.driverName,\r\n+              driverId: driverData.driver._id,\r\n+              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+              location: statusData.location || null, // Live GPS\r\n+            }); \r\n+            setSearching(false);\r\n+            return;\r\n+          }\r\n+        } catch (err) {\r\n+          // Still waiting\r\n+        }\r\n+        if (Date.now() - startTime < maxWaitTime) {\r\n+          searchTimeoutRef.current = setTimeout(poll, 5000);\r\n+        } else {\r\n+          setSearching(false);\r\n+        }\r\n+      };\r\n+      poll();\r\n+    } catch (error) {\r\n+      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+\r\n+    // Set destination/driver markers after booking confirmed, etc\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? {\r\n+          latitude: matchedDriver.location.latitude,\r\n+          longitude: matchedDriver.location.longitude,\r\n+        }\r\n+      : null;\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(\r\n+        JSON.stringify({\r\n+          type: \"setMarkers\",\r\n+          destination,\r\n+          driver: driverCoords,\r\n+        })\r\n+      );\r\n+    }\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed]);\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => {\r\n+      showSub.remove();\r\n+      hideSub.remove();\r\n+    };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        console.log(\"driver match\");\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId)); // üëà Fix here\r\n+        console.log(matchedDriver.driverId, bookingId);\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+        }\r\n+      } catch (err) {\r\n+        // error polling\r\n+      }\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          if (mapRef.current) {\r\n+            mapRef.current.postMessage(\r\n+              JSON.stringify({\r\n+                type: \"setMarkers\",\r\n+                destination: null,\r\n+                driver: null,\r\n+              })\r\n+            );\r\n+          }\r\n+        }\r\n+      } catch (err) {\r\n+        console.error(\"‚ùå Poll error:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination,\r\n+        destinationLabel,\r\n+        notes,\r\n+        paymentMethod,\r\n+        fare,\r\n+        matchedDriver,\r\n+        bookingConfirmed,\r\n+        bookingId,\r\n+        showBookingForm,\r\n+        searching,\r\n+      };\r\n+      try {\r\n+        await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState));\r\n+      } catch (err) {\r\n+        console.warn(\"Error saving booking state:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    saveBookingState();\r\n+  }, [\r\n+    destination,\r\n+    destinationLabel,\r\n+    notes,\r\n+    paymentMethod,\r\n+    fare,\r\n+    matchedDriver,\r\n+    bookingConfirmed,\r\n+    bookingId,\r\n+    showBookingForm,\r\n+    searching,\r\n+  ]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const {\r\n+            destination,\r\n+            destinationLabel,\r\n+            notes,\r\n+            paymentMethod,\r\n+            fare,\r\n+            matchedDriver,\r\n+            bookingConfirmed,\r\n+            bookingId,\r\n+            showBookingForm,\r\n+            searching,\r\n+          } = JSON.parse(savedState);\r\n+\r\n+          if (destination) setDestination(destination);\r\n+          if (destinationLabel) setDestinationLabel(destinationLabel);\r\n+          if (notes) setNotes(notes);\r\n+          if (paymentMethod) setPaymentMethod(paymentMethod);\r\n+          if (fare) setFare(fare);\r\n+          if (matchedDriver) setMatchedDriver(matchedDriver);\r\n+          if (bookingConfirmed) setBookingConfirmed(bookingConfirmed);\r\n+          if (bookingId) setBookingId(bookingId);\r\n+          if (showBookingForm) setShowBookingForm(showBookingForm);\r\n+          if (searching) setSearching(searching);\r\n+        }\r\n+      } catch (err) {\r\n+        console.warn(\"Error loading booking state:\", err);\r\n+      }\r\n+    };\r\n+\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          driverId: driverIdToRate,\r\n+          rating: selectedRating,\r\n+        }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        // Save the feedback separately if there's a note\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (tripCompleted) {\r\n+      setShowRatingModal(true);\r\n+    }\r\n+  }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\r\n+    \"Overcharging\",\r\n+    \"Harassment\",\r\n+    \"Unproper Attire\",\r\n+    \"Refusal to Convey Passenger\",\r\n+    \"Other\",\r\n+  ];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId,\r\n+          passengerId,\r\n+          driverId: matchedDriver?.driverId,\r\n+          reportType,\r\n+          otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+\r\n+\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled={true}\r\n+              ref={(ref) => {\r\n+                if (ref && !mapRef.current) {\r\n+                  mapRef.current = ref;\r\n+                }\r\n+              }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              style={{\r\n+                position: \"absolute\",\r\n+                top: 0,\r\n+                left: 0,\r\n+                right: 0,\r\n+                bottom: -30,\r\n+                zIndex: 0,\r\n+              }}\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled={true}\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity\r\n+                      style={{\r\n+                        alignItems: \"center\",\r\n+                        padding: 10,\r\n+                      }}\r\n+                      onPress={() => setInfoBoxMinimized(false)}\r\n+                    >\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1}}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                        </View>\r\n+                      </View>\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity\r\n+                          onPress={() => setInfoBoxMinimized(true)}\r\n+                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={() => setShowReportModal(true)}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch (err) { }\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            mapRef.current?.postMessage(\r\n+                              JSON.stringify({\r\n+                                type: \"setMarkers\",\r\n+                                destination: null,\r\n+                                driver: null,\r\n+                              })\r\n+                            );\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+                <ScrollView style={styles.inputsContainer}>\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Saan ang pick-up?\"\r\n+                    value={pickupName}\r\n+                    editable={true}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Saan ang drop-off?\"\r\n+                    value={dropoffName}\r\n+                    editable={true}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Notes sa driver\"\r\n+                    value={notes}\r\n+                    onChangeText={setNotes}\r\n+                  />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Paano ka magbabayad?\"\r\n+                    value={paymentMethod}\r\n+                    onChangeText={setPaymentMethod}\r\n+                  />\r\n+                </ScrollView>\r\n+                <View style={styles.fareContainer}>\r\n+                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n+                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {!matchedDriver && !searching && !showBookingForm && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{\r\n+                  position: \"absolute\",\r\n+                  bottom: 10,\r\n+                  backgroundColor: \"#81C3E1\",\r\n+                  padding: 10,\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+\r\n+                  <TouchableOpacity\r\n+                    style={styles.dismissButton}\r\n+                    onPress={() => {\r\n+                      setShowRatingModal(false);\r\n+                      AsyncStorage.removeItem(\"driverIdToRate\");\r\n+                    }}\r\n+                  >\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity\r\n+                        key={star}\r\n+                        onPress={() => setSelectedRating(star)}\r\n+                      >\r\n+                        <Ionicons\r\n+                          name={selectedRating >= star ? \"star\" : \"star-outline\"}\r\n+                          size={30}\r\n+                          color=\"#FFD700\"\r\n+                        />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput\r\n+                    style={styles.feedbackInput}\r\n+                    placeholder=\"Leave a comment (optional)\"\r\n+                    multiline\r\n+                    numberOfLines={3}\r\n+                    onChangeText={(text) => setNotes(text)}\r\n+                    value={notes}\r\n+                  />\r\n+\r\n+                  <TouchableOpacity\r\n+                    style={styles.submitButton}\r\n+                    onPress={submitDriverRating}\r\n+                  >\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity\r\n+                    style={styles.dismissButton}\r\n+                    onPress={() => setShowReportModal(false)}\r\n+                  >\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity\r\n+                      style={styles.dropdownButton}\r\n+                      onPress={() => setShowDropdown(!showDropdown)}\r\n+                    >\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>\r\n+                        {reportType || \"Select a violation\"}\r\n+                      </Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {reportOptions.map((option) => (\r\n+                          <TouchableOpacity\r\n+                            key={option}\r\n+                            style={styles.dropdownItem}\r\n+                            onPress={() => {\r\n+                              setReportType(option);\r\n+                              setShowDropdown(false);\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput\r\n+                      style={styles.feedbackInput}\r\n+                      placeholder=\"Describe the issue\"\r\n+                      multiline\r\n+                      numberOfLines={3}\r\n+                      value={otherReport}\r\n+                      onChangeText={setOtherReport}\r\n+                    />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity\r\n+                    style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]}\r\n+                    onPress={submitReport}\r\n+                  >\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: {position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  panel: {\r\n+    position: 'absolute',\r\n+    bottom: 10, \r\n+    width: '100%',\r\n+    backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20,\r\n+    borderTopRightRadius: 20,\r\n+    padding: 15,\r\n+    zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  radioContainer: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 5 },\r\n+  radioButton: { padding: 10, backgroundColor: '#FFF', borderRadius: 10, marginRight: 10 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: {\r\n+    flexDirection: 'row',\r\n+    justifyContent: 'space-between',\r\n+    alignItems: 'center',\r\n+    marginTop: 10,\r\n+  },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\",\r\n+    top: -100,\r\n+    left: 0,\r\n+    right: 0,\r\n+    bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\",\r\n+    justifyContent: \"center\",\r\n+    alignItems: \"center\",\r\n+    zIndex: 999,\r\n+  },\r\n+  ratingModal: {\r\n+    width: \"80%\",\r\n+    backgroundColor: \"#fff\",\r\n+    borderRadius: 10,\r\n+    padding: 20,\r\n+    alignItems: \"center\",\r\n+  },\r\n+\r\n+  dismissButton: {\r\n+    position: \"absolute\",\r\n+    top: 10,\r\n+    right: 10,\r\n+    zIndex: 10,\r\n+  },\r\n+\r\n+  modalTitle: {\r\n+    fontSize: 18,\r\n+    fontWeight: \"bold\",\r\n+    marginBottom: 5,\r\n+  },\r\n+  starsContainer: {\r\n+    flexDirection: \"row\",\r\n+    marginBottom: 10,\r\n+  },\r\n+  feedbackInput: {\r\n+    width: \"100%\",\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ddd\",\r\n+    borderRadius: 8,\r\n+    padding: 10,\r\n+    marginBottom: 10,\r\n+    textAlignVertical: \"top\",\r\n+  },\r\n+  submitButton: {\r\n+    backgroundColor: \"#4caf50\",\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 20,\r\n+    borderRadius: 8,\r\n+  },\r\n+  submitButtonText: {\r\n+    color: \"#fff\",\r\n+    fontWeight: \"bold\",\r\n+  },\r\n+\r\n+  modalLabel: {\r\n+    marginTop: 5,\r\n+    marginBottom: 5,\r\n+    fontSize: 14,\r\n+    color: \"#333\",\r\n+    fontWeight: \"500\",\r\n+  },\r\n+  pickerContainer: {\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ddd\",\r\n+    borderRadius: 8,\r\n+    marginBottom: 10,\r\n+    overflow: \"hidden\",\r\n+  },\r\n+  picker: {\r\n+    height: 50,\r\n+    padding: 0,\r\n+    width: \"100%\",\r\n+  },\r\n+\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\",\r\n+    justifyContent: \"space-between\",\r\n+    alignItems: \"center\",\r\n+    padding: 10,\r\n+    backgroundColor: \"#FFF\",\r\n+    borderRadius: 8,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: {\r\n+    backgroundColor: \"#FFF\",\r\n+    borderRadius: 8,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+    marginTop: 2,\r\n+  },\r\n+  dropdownItem: { padding: 10 },\r\n+\r\n+\r\n+\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+});\r\n+\r\n"
                },
                {
                    "date": 1749517687322,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1070,1068 +1070,4 @@\n   bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n \r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-\r\n-const { width, height } = Dimensions.get(\"window\");\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(20);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  useEffect(() => {\r\n-    const backAction = () => {\r\n-      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-        { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-        {\r\n-          text: \"Logout\",\r\n-          onPress: async () => {\r\n-            await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\");\r\n-          },\r\n-        },\r\n-      ]);\r\n-      return true;\r\n-    };\r\n-\r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n-    return () => backHandler.remove();\r\n-  }, []);\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n-\r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style>\r\n-            html, body, #map {\r\n-              height: 100%;\r\n-              margin: 0;\r\n-              padding: 0;\r\n-            }\r\n-            .driver-label {\r\n-              font-weight: bold;\r\n-              color: red;\r\n-              background: white;\r\n-              padding: 2px 5px;\r\n-              border-radius: 4px;\r\n-              font-size: 14px;\r\n-            }\r\n-          </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            let routeLine = null;\r\n-            window.onload = function () {\r\n-              const map = L.map('map', {\r\n-                zoomControl: false,\r\n-                dragging: true,\r\n-                scrollWheelZoom: true,\r\n-                touchZoom: true,\r\n-                doubleClickZoom: true,\r\n-                boxZoom: true,\r\n-              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n-\r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 19,\r\n-                attribution: '¬© OpenStreetMap contributors'\r\n-              }).addTo(map);\r\n-\r\n-              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n-                icon: L.icon({\r\n-                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-                  iconSize: [30, 30],\r\n-                })\r\n-              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n-\r\n-              let destMarker = null;\r\n-              let driverMarker = null;\r\n-              let destinationLocked = false;\r\n-              map.on('click', function(e) {\r\n-                if (destinationLocked) return;\r\n-                const { lat, lng } = e.latlng;\r\n-                if (destMarker) map.removeLayer(destMarker);\r\n-                destMarker = L.marker([lat, lng], {\r\n-                  icon: L.icon({\r\n-                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                    iconSize: [30, 30],\r\n-                  })\r\n-                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-              });\r\n-              document.addEventListener('message', function(event) {\r\n-                const msg = JSON.parse(event.data);\r\n-                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n-                if (msg.type === 'drawRoute' && Array.isArray(msg.route)) {\r\n-                  if (routeLine) map.removeLayer(routeLine);\r\n-                  routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n-                  map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n-                }\r\n-                if (msg.type === 'setMarkers') {\r\n-                  destinationLocked = !!msg.driver;\r\n-                  if (destMarker) map.removeLayer(destMarker);\r\n-                  if (msg.destination) {\r\n-                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                        iconSize: [30, 30],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                  }\r\n-                  if (driverMarker) map.removeLayer(driverMarker);\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    L.circle([latitude, longitude], {\r\n-                      color: 'red',\r\n-                      radius: 10,\r\n-                      fillOpacity: 0.9\r\n-                    }).addTo(map);\r\n-                    driverMarker = L.marker([latitude, longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-                        iconSize: [40, 40],\r\n-                        iconAnchor: [20, 40],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                      .setZIndexOffset(1000);\r\n-                  }\r\n-                }\r\n-              });\r\n-            }\r\n-          </script>\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-    setMapHtml(html);\r\n-  }, [location]);\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        // Get address for destination\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude,\r\n-            longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(\r\n-              `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-            );\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-    } catch (e) {\r\n-      // handle parse error\r\n-    }\r\n-  };\r\n-\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n-      const data = await res.json();\r\n-      const coords = data.features[0].geometry.coordinates;\r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n-\r\n-      if (mapRef.current) {\r\n-        mapRef.current.postMessage(\r\n-          JSON.stringify({\r\n-            type: \"drawRoute\",\r\n-            route: polylinePoints,\r\n-          })\r\n-        );\r\n-      }\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-    }\r\n-  };\r\n-\r\n-\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId\r\n-    };\r\n-    try {\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-      setBookingId(result.booking.id);\r\n-      // Start polling for driver for up to 10 minutes\r\n-      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n-      const startTime = Date.now();\r\n-      const poll = async () => {\r\n-        try {\r\n-          const [driverRes, statusRes] = await Promise.all([\r\n-            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n-            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n-          ]);\r\n-          const driverData = await driverRes.json();\r\n-          const statusData = await statusRes.json();\r\n-          if (driverData?.driver) {\r\n-            setMatchedDriver({\r\n-              driverName: driverData.driver.driverName,\r\n-              driverId: driverData.driver._id,\r\n-              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-              location: statusData.location || null, // Live GPS\r\n-            }); \r\n-            setSearching(false);\r\n-            return;\r\n-          }\r\n-        } catch (err) {\r\n-          // Still waiting\r\n-        }\r\n-        if (Date.now() - startTime < maxWaitTime) {\r\n-          searchTimeoutRef.current = setTimeout(poll, 5000);\r\n-        } else {\r\n-          setSearching(false);\r\n-        }\r\n-      };\r\n-      poll();\r\n-    } catch (error) {\r\n-      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-\r\n-    // Set destination/driver markers after booking confirmed, etc\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? {\r\n-          latitude: matchedDriver.location.latitude,\r\n-          longitude: matchedDriver.location.longitude,\r\n-        }\r\n-      : null;\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(\r\n-        JSON.stringify({\r\n-          type: \"setMarkers\",\r\n-          destination,\r\n-          driver: driverCoords,\r\n-        })\r\n-      );\r\n-    }\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed]);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => {\r\n-      showSub.remove();\r\n-      hideSub.remove();\r\n-    };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        console.log(\"driver match\");\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId)); // üëà Fix here\r\n-        console.log(matchedDriver.driverId, bookingId);\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    let interval;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-        }\r\n-      } catch (err) {\r\n-        // error polling\r\n-      }\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          if (mapRef.current) {\r\n-            mapRef.current.postMessage(\r\n-              JSON.stringify({\r\n-                type: \"setMarkers\",\r\n-                destination: null,\r\n-                driver: null,\r\n-              })\r\n-            );\r\n-          }\r\n-        }\r\n-      } catch (err) {\r\n-        console.error(\"‚ùå Poll error:\", err);\r\n-      }\r\n-    };\r\n-\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination,\r\n-        destinationLabel,\r\n-        notes,\r\n-        paymentMethod,\r\n-        fare,\r\n-        matchedDriver,\r\n-        bookingConfirmed,\r\n-        bookingId,\r\n-        showBookingForm,\r\n-        searching,\r\n-      };\r\n-      try {\r\n-        await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState));\r\n-      } catch (err) {\r\n-        console.warn(\"Error saving booking state:\", err);\r\n-      }\r\n-    };\r\n-\r\n-    saveBookingState();\r\n-  }, [\r\n-    destination,\r\n-    destinationLabel,\r\n-    notes,\r\n-    paymentMethod,\r\n-    fare,\r\n-    matchedDriver,\r\n-    bookingConfirmed,\r\n-    bookingId,\r\n-    showBookingForm,\r\n-    searching,\r\n-  ]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const {\r\n-            destination,\r\n-            destinationLabel,\r\n-            notes,\r\n-            paymentMethod,\r\n-            fare,\r\n-            matchedDriver,\r\n-            bookingConfirmed,\r\n-            bookingId,\r\n-            showBookingForm,\r\n-            searching,\r\n-          } = JSON.parse(savedState);\r\n-\r\n-          if (destination) setDestination(destination);\r\n-          if (destinationLabel) setDestinationLabel(destinationLabel);\r\n-          if (notes) setNotes(notes);\r\n-          if (paymentMethod) setPaymentMethod(paymentMethod);\r\n-          if (fare) setFare(fare);\r\n-          if (matchedDriver) setMatchedDriver(matchedDriver);\r\n-          if (bookingConfirmed) setBookingConfirmed(bookingConfirmed);\r\n-          if (bookingId) setBookingId(bookingId);\r\n-          if (showBookingForm) setShowBookingForm(showBookingForm);\r\n-          if (searching) setSearching(searching);\r\n-        }\r\n-      } catch (err) {\r\n-        console.warn(\"Error loading booking state:\", err);\r\n-      }\r\n-    };\r\n-\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          driverId: driverIdToRate,\r\n-          rating: selectedRating,\r\n-        }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        // Save the feedback separately if there's a note\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (tripCompleted) {\r\n-      setShowRatingModal(true);\r\n-    }\r\n-  }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\r\n-    \"Overcharging\",\r\n-    \"Harassment\",\r\n-    \"Unproper Attire\",\r\n-    \"Refusal to Convey Passenger\",\r\n-    \"Other\",\r\n-  ];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId,\r\n-          passengerId,\r\n-          driverId: matchedDriver?.driverId,\r\n-          reportType,\r\n-          otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-\r\n-\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled={true}\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) {\r\n-                  mapRef.current = ref;\r\n-                }\r\n-              }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              style={{\r\n-                position: \"absolute\",\r\n-                top: 0,\r\n-                left: 0,\r\n-                right: 0,\r\n-                bottom: -30,\r\n-                zIndex: 0,\r\n-              }}\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled={true}\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity\r\n-                      style={{\r\n-                        alignItems: \"center\",\r\n-                        padding: 10,\r\n-                      }}\r\n-                      onPress={() => setInfoBoxMinimized(false)}\r\n-                    >\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1}}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-                        </View>\r\n-                      </View>\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity\r\n-                          onPress={() => setInfoBoxMinimized(true)}\r\n-                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={() => setShowReportModal(true)}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch (err) { }\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            mapRef.current?.postMessage(\r\n-                              JSON.stringify({\r\n-                                type: \"setMarkers\",\r\n-                                destination: null,\r\n-                                driver: null,\r\n-                              })\r\n-                            );\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-                <ScrollView style={styles.inputsContainer}>\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Saan ang pick-up?\"\r\n-                    value={pickupName}\r\n-                    editable={true}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Saan ang drop-off?\"\r\n-                    value={dropoffName}\r\n-                    editable={true}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                    value={destinationLabel}\r\n-                    onChangeText={setDestinationLabel}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Notes sa driver\"\r\n-                    value={notes}\r\n-                    onChangeText={setNotes}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Paano ka magbabayad?\"\r\n-                    value={paymentMethod}\r\n-                    onChangeText={setPaymentMethod}\r\n-                  />\r\n-                </ScrollView>\r\n-                <View style={styles.fareContainer}>\r\n-                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!matchedDriver && !searching && !showBookingForm && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{\r\n-                  position: \"absolute\",\r\n-                  bottom: 10,\r\n-                  backgroundColor: \"#81C3E1\",\r\n-                  padding: 10,\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-\r\n-                  <TouchableOpacity\r\n-                    style={styles.dismissButton}\r\n-                    onPress={() => {\r\n-                      setShowRatingModal(false);\r\n-                      AsyncStorage.removeItem(\"driverIdToRate\");\r\n-                    }}\r\n-                  >\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity\r\n-                        key={star}\r\n-                        onPress={() => setSelectedRating(star)}\r\n-                      >\r\n-                        <Ionicons\r\n-                          name={selectedRating >= star ? \"star\" : \"star-outline\"}\r\n-                          size={30}\r\n-                          color=\"#FFD700\"\r\n-                        />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput\r\n-                    style={styles.feedbackInput}\r\n-                    placeholder=\"Leave a comment (optional)\"\r\n-                    multiline\r\n-                    numberOfLines={3}\r\n-                    onChangeText={(text) => setNotes(text)}\r\n-                    value={notes}\r\n-                  />\r\n-\r\n-                  <TouchableOpacity\r\n-                    style={styles.submitButton}\r\n-                    onPress={submitDriverRating}\r\n-                  >\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity\r\n-                    style={styles.dismissButton}\r\n-                    onPress={() => setShowReportModal(false)}\r\n-                  >\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity\r\n-                      style={styles.dropdownButton}\r\n-                      onPress={() => setShowDropdown(!showDropdown)}\r\n-                    >\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>\r\n-                        {reportType || \"Select a violation\"}\r\n-                      </Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {reportOptions.map((option) => (\r\n-                          <TouchableOpacity\r\n-                            key={option}\r\n-                            style={styles.dropdownItem}\r\n-                            onPress={() => {\r\n-                              setReportType(option);\r\n-                              setShowDropdown(false);\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput\r\n-                      style={styles.feedbackInput}\r\n-                      placeholder=\"Describe the issue\"\r\n-                      multiline\r\n-                      numberOfLines={3}\r\n-                      value={otherReport}\r\n-                      onChangeText={setOtherReport}\r\n-                    />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity\r\n-                    style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]}\r\n-                    onPress={submitReport}\r\n-                  >\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-\r\n-\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: {position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  panel: {\r\n-    position: 'absolute',\r\n-    bottom: 10, \r\n-    width: '100%',\r\n-    backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20,\r\n-    borderTopRightRadius: 20,\r\n-    padding: 15,\r\n-    zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  radioContainer: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 5 },\r\n-  radioButton: { padding: 10, backgroundColor: '#FFF', borderRadius: 10, marginRight: 10 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: {\r\n-    flexDirection: 'row',\r\n-    justifyContent: 'space-between',\r\n-    alignItems: 'center',\r\n-    marginTop: 10,\r\n-  },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\",\r\n-    top: -100,\r\n-    left: 0,\r\n-    right: 0,\r\n-    bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\",\r\n-    justifyContent: \"center\",\r\n-    alignItems: \"center\",\r\n-    zIndex: 999,\r\n-  },\r\n-  ratingModal: {\r\n-    width: \"80%\",\r\n-    backgroundColor: \"#fff\",\r\n-    borderRadius: 10,\r\n-    padding: 20,\r\n-    alignItems: \"center\",\r\n-  },\r\n-\r\n-  dismissButton: {\r\n-    position: \"absolute\",\r\n-    top: 10,\r\n-    right: 10,\r\n-    zIndex: 10,\r\n-  },\r\n-\r\n-  modalTitle: {\r\n-    fontSize: 18,\r\n-    fontWeight: \"bold\",\r\n-    marginBottom: 5,\r\n-  },\r\n-  starsContainer: {\r\n-    flexDirection: \"row\",\r\n-    marginBottom: 10,\r\n-  },\r\n-  feedbackInput: {\r\n-    width: \"100%\",\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ddd\",\r\n-    borderRadius: 8,\r\n-    padding: 10,\r\n-    marginBottom: 10,\r\n-    textAlignVertical: \"top\",\r\n-  },\r\n-  submitButton: {\r\n-    backgroundColor: \"#4caf50\",\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 20,\r\n-    borderRadius: 8,\r\n-  },\r\n-  submitButtonText: {\r\n-    color: \"#fff\",\r\n-    fontWeight: \"bold\",\r\n-  },\r\n-\r\n-  modalLabel: {\r\n-    marginTop: 5,\r\n-    marginBottom: 5,\r\n-    fontSize: 14,\r\n-    color: \"#333\",\r\n-    fontWeight: \"500\",\r\n-  },\r\n-  pickerContainer: {\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ddd\",\r\n-    borderRadius: 8,\r\n-    marginBottom: 10,\r\n-    overflow: \"hidden\",\r\n-  },\r\n-  picker: {\r\n-    height: 50,\r\n-    padding: 0,\r\n-    width: \"100%\",\r\n-  },\r\n-\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\",\r\n-    justifyContent: \"space-between\",\r\n-    alignItems: \"center\",\r\n-    padding: 10,\r\n-    backgroundColor: \"#FFF\",\r\n-    borderRadius: 8,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: {\r\n-    backgroundColor: \"#FFF\",\r\n-    borderRadius: 8,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n-    marginTop: 2,\r\n-  },\r\n-  dropdownItem: { padding: 10 },\r\n-\r\n-\r\n-\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n-});\r\n-\r\n"
                },
                {
                    "date": 1749517708726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -234,45 +234,45 @@\n       // handle parse error\r\n     }\r\n   };\r\n \r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n+  // const fetchORSRoute = async (\r\n+  //   from: { latitude: number; longitude: number },\r\n+  //   to: { latitude: number; longitude: number }\r\n+  // ) => {\r\n+  //   try {\r\n+  //     const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+  //       method: 'POST',\r\n+  //       headers: { 'Content-Type': 'application/json' },\r\n+  //       body: JSON.stringify({\r\n+  //         start: [from.longitude, from.latitude],\r\n+  //         end: [to.longitude, to.latitude],\r\n+  //       }),\r\n+  //     });\r\n \r\n-      const data = await res.json();\r\n+  //     const data = await res.json();\r\n \r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n+  //     if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+  //       console.error(\"üõë Invalid ORS response:\", data);\r\n+  //       Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+  //       return;\r\n+  //     }\r\n \r\n-      const coords = data.features[0].geometry.coordinates;\r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n+  //     const coords = data.features[0].geometry.coordinates;\r\n+  //     const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n \r\n-      if (mapRef.current) {\r\n-        mapRef.current.postMessage(\r\n-          JSON.stringify({\r\n-            type: 'drawRoute',\r\n-            route: polylinePoints,\r\n-          })\r\n-        );\r\n-      }\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-    }\r\n-  };\r\n+  //     if (mapRef.current) {\r\n+  //       mapRef.current.postMessage(\r\n+  //         JSON.stringify({\r\n+  //           type: 'drawRoute',\r\n+  //           route: polylinePoints,\r\n+  //         })\r\n+  //       );\r\n+  //     }\r\n+  //   } catch (err) {\r\n+  //     console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+  //   }\r\n+  // };\r\n \r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1749517722042,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -362,11 +362,11 @@\n           driver: driverCoords,\r\n         })\r\n       );\r\n     }\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n+    // if (destination && location) {\r\n+    //   fetchORSRoute(location, destination);\r\n+    // }\r\n   }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n \r\n \r\n"
                },
                {
                    "date": 1754895830947,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,12 +6,12 @@\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { router } from 'expo-router';\r\n import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { OSRM_BASE_URL, API_BASE_URL } from \"../../config\";\r\n+import { API_BASE_URL } from \"../../config\";\r\n import * as Location from 'expo-location';\r\n \r\n-const { width, height } = Dimensions.get(\"window\");\r\n+const { width } = Dimensions.get(\"window\");\r\n \r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n@@ -30,9 +30,9 @@\n     selfieImage: string;\r\n     location: { latitude: number; longitude: number };\r\n   } | null>(null);\r\n   const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState(null);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n   const [showBookingForm, setShowBookingForm] = useState(false);\r\n   const [searching, setSearching] = useState(false);\r\n   const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n@@ -46,9 +46,43 @@\n   const [pickupName, setPickupName] = useState(\"\");\r\n   const [dropoffName, setDropoffName] = useState(\"\");\r\n   const [showDropdown, setShowDropdown] = useState(false);\r\n \r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n \r\n+      const data = await res.json();\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+        console.error(\"üõë Invalid ORS response:\", data);\r\n+        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.features[0].geometry.coordinates; // [lng, lat][]\r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); // Leaflet expects [lat, lng]\r\n+\r\n+      mapRef.current?.postMessage(\r\n+        JSON.stringify({ type: 'drawRoute', route: polylinePoints })\r\n+      );\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n+    }\r\n+  };\r\n+  // ---------------------------------------------------------\r\n+\r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n     if (location) {\r\n       Location.reverseGeocodeAsync({\r\n@@ -81,13 +115,9 @@\n         },\r\n       ]);\r\n       return true;\r\n     };\r\n-\r\n-    const backHandler = BackHandler.addEventListener(\r\n-      \"hardwareBackPress\",\r\n-      backAction\r\n-    );\r\n+    const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n     return () => backHandler.remove();\r\n   }, []);\r\n \r\n   // Generate map HTML when location changes\r\n@@ -100,20 +130,12 @@\n         <head>\r\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n           <style>\r\n-            html, body, #map {\r\n-              height: 100%;\r\n-              margin: 0;\r\n-              padding: 0;\r\n-            }\r\n+            html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n             .driver-label {\r\n-              font-weight: bold;\r\n-              color: red;\r\n-              background: white;\r\n-              padding: 2px 5px;\r\n-              border-radius: 4px;\r\n-              font-size: 14px;\r\n+              font-weight: bold; color: red; background: white;\r\n+              padding: 2px 5px; border-radius: 4px; font-size: 14px;\r\n             }\r\n           </style>\r\n         </head>\r\n         <body>\r\n@@ -122,21 +144,16 @@\n           <script>\r\n             let routeLine = null;\r\n             window.onload = function () {\r\n               const map = L.map('map', {\r\n-                zoomControl: false,\r\n-                dragging: true,\r\n-                scrollWheelZoom: true,\r\n-                touchZoom: true,\r\n-                doubleClickZoom: true,\r\n-                boxZoom: true,\r\n+                zoomControl: false, dragging: true, scrollWheelZoom: true,\r\n+                touchZoom: true, doubleClickZoom: true, boxZoom: true,\r\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n               L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 19,\r\n-                attribution: '¬© OpenStreetMap contributors'\r\n+                maxZoom: 19, attribution: '¬© OpenStreetMap contributors'\r\n               }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n@@ -147,8 +164,9 @@\n \r\n               let destMarker = null;\r\n               let driverMarker = null;\r\n               let destinationLocked = false;\r\n+\r\n               map.on('click', function(e) {\r\n                 if (destinationLocked) return;\r\n                 const { lat, lng } = e.latlng;\r\n                 if (destMarker) map.removeLayer(destMarker);\r\n@@ -159,16 +177,18 @@\n                   })\r\n                 }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n                 window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n               });\r\n+\r\n               document.addEventListener('message', function(event) {\r\n                 const msg = JSON.parse(event.data);\r\n-                window.ReactNativeWebView.postMessage(\"üì• RECEIVED IN MAP: \" + JSON.stringify(msg));\r\n+\r\n                 if (msg.type === 'drawRoute' && Array.isArray(msg.route)) {\r\n                   if (routeLine) map.removeLayer(routeLine);\r\n                   routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n                   map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n                 }\r\n+\r\n                 if (msg.type === 'setMarkers') {\r\n                   destinationLocked = !!msg.driver;\r\n                   if (destMarker) map.removeLayer(destMarker);\r\n                   if (msg.destination) {\r\n@@ -182,17 +202,14 @@\n                   if (driverMarker) map.removeLayer(driverMarker);\r\n                   if (msg.driver) {\r\n                     const { latitude, longitude } = msg.driver;\r\n                     L.circle([latitude, longitude], {\r\n-                      color: 'red',\r\n-                      radius: 10,\r\n-                      fillOpacity: 0.9\r\n+                      color: 'red', radius: 10, fillOpacity: 0.9\r\n                     }).addTo(map);\r\n                     driverMarker = L.marker([latitude, longitude], {\r\n                       icon: L.icon({\r\n                         iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-                        iconSize: [40, 40],\r\n-                        iconAnchor: [20, 40],\r\n+                        iconSize: [40, 40], iconAnchor: [20, 40],\r\n                       })\r\n                     }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n                       .setZIndexOffset(1000);\r\n                   }\r\n@@ -211,90 +228,42 @@\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n       if (parsed.latitude && parsed.longitude) {\r\n         setDestination(parsed);\r\n-        // Get address for destination\r\n         try {\r\n           const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude,\r\n-            longitude: parsed.longitude,\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n           });\r\n           if (results && results.length > 0) {\r\n             const addr = results[0];\r\n-            setDropoffName(\r\n-              `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-            );\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n           } else {\r\n             setDropoffName(\"Selected Location\");\r\n           }\r\n         } catch {\r\n           setDropoffName(\"Selected Location\");\r\n         }\r\n       }\r\n-    } catch (e) {\r\n-      // handle parse error\r\n-    }\r\n+    } catch {}\r\n   };\r\n \r\n-  // const fetchORSRoute = async (\r\n-  //   from: { latitude: number; longitude: number },\r\n-  //   to: { latitude: number; longitude: number }\r\n-  // ) => {\r\n-  //   try {\r\n-  //     const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-  //       method: 'POST',\r\n-  //       headers: { 'Content-Type': 'application/json' },\r\n-  //       body: JSON.stringify({\r\n-  //         start: [from.longitude, from.latitude],\r\n-  //         end: [to.longitude, to.latitude],\r\n-  //       }),\r\n-  //     });\r\n-\r\n-  //     const data = await res.json();\r\n-\r\n-  //     if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-  //       console.error(\"üõë Invalid ORS response:\", data);\r\n-  //       Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-  //       return;\r\n-  //     }\r\n-\r\n-  //     const coords = data.features[0].geometry.coordinates;\r\n-  //     const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n-\r\n-  //     if (mapRef.current) {\r\n-  //       mapRef.current.postMessage(\r\n-  //         JSON.stringify({\r\n-  //           type: 'drawRoute',\r\n-  //           route: polylinePoints,\r\n-  //         })\r\n-  //       );\r\n-  //     }\r\n-  //   } catch (err) {\r\n-  //     console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-  //   }\r\n-  // };\r\n-\r\n-\r\n-\r\n-\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n     setAlertedBookingComplete(false);\r\n     setTripCompleted(false);\r\n+\r\n     const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n       destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId\r\n+      fare, paymentMethod, notes, passengerId\r\n     };\r\n+\r\n     try {\r\n       setShowBookingForm(false);\r\n       setSearching(true);\r\n       const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n@@ -304,10 +273,11 @@\n       });\r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n       setBookingId(result.booking.id);\r\n-      // Start polling for driver for up to 10 minutes\r\n-      const maxWaitTime = 10 * 60 * 1000; // 10 minutes\r\n+\r\n+      // poll for driver match\r\n+      const maxWaitTime = 10 * 60 * 1000;\r\n       const startTime = Date.now();\r\n       const poll = async () => {\r\n         try {\r\n           const [driverRes, statusRes] = await Promise.all([\r\n@@ -322,81 +292,63 @@\n               driverId: driverData.driver._id,\r\n               franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n               experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n               selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-              location: statusData.location || null, // Live GPS\r\n-            }); \r\n+              location: statusData.location || null,\r\n+            });\r\n             setSearching(false);\r\n             return;\r\n           }\r\n-        } catch (err) {\r\n-          // Still waiting\r\n-        }\r\n+        } catch {}\r\n         if (Date.now() - startTime < maxWaitTime) {\r\n           searchTimeoutRef.current = setTimeout(poll, 5000);\r\n         } else {\r\n           setSearching(false);\r\n         }\r\n       };\r\n       poll();\r\n-    } catch (error) {\r\n+    } catch {\r\n       Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-\r\n-    // Set destination/driver markers after booking confirmed, etc\r\n+  // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n     const driverCoords = matchedDriver?.location\r\n-      ? {\r\n-          latitude: matchedDriver.location.latitude,\r\n-          longitude: matchedDriver.location.longitude,\r\n-        }\r\n+      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n       : null;\r\n+\r\n     if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(\r\n-        JSON.stringify({\r\n-          type: \"setMarkers\",\r\n-          destination,\r\n-          driver: driverCoords,\r\n-        })\r\n-      );\r\n+      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n     }\r\n-    // if (destination && location) {\r\n-    //   fetchORSRoute(location, destination);\r\n-    // }\r\n-  }, [destination, matchedDriver, bookingConfirmed]);\r\n \r\n+    // üëâ draw route as soon as we have both ends\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n \r\n-\r\n   useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => {\r\n-      showSub.remove();\r\n-      hideSub.remove();\r\n-    };\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n     const saveDriverId = async () => {\r\n       if (matchedDriver && bookingId) {\r\n-        console.log(\"driver match\");\r\n         await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId)); // üëà Fix here\r\n-        console.log(matchedDriver.driverId, bookingId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n       }\r\n     };\r\n     saveDriverId();\r\n   }, [matchedDriver, bookingId]);\r\n \r\n-\r\n-\r\n-\r\n   useEffect(() => {\r\n-    let interval;\r\n+    let interval: any;\r\n     const pollForDriverMatch = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n@@ -405,18 +357,16 @@\n         if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n           setBookingConfirmed(true);\r\n           Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n         }\r\n-      } catch (err) {\r\n-        // error polling\r\n-      }\r\n+      } catch {}\r\n     };\r\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n   useEffect(() => {\r\n-    let interval;\r\n+    let interval: any;\r\n     const pollForBookingCompletion = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n@@ -435,121 +385,65 @@\n           setDestination(null);\r\n           setShowBookingForm(false);\r\n           setTripCompleted(true);\r\n \r\n-          if (mapRef.current) {\r\n-            mapRef.current.postMessage(\r\n-              JSON.stringify({\r\n-                type: \"setMarkers\",\r\n-                destination: null,\r\n-                driver: null,\r\n-              })\r\n-            );\r\n-          }\r\n+          mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n         }\r\n-      } catch (err) {\r\n-        console.error(\"‚ùå Poll error:\", err);\r\n-      }\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n     };\r\n-\r\n     interval = setInterval(pollForBookingCompletion, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId]);\r\n \r\n-\r\n   useEffect(() => {\r\n     const saveBookingState = async () => {\r\n       const bookingState = {\r\n-        destination,\r\n-        destinationLabel,\r\n-        notes,\r\n-        paymentMethod,\r\n-        fare,\r\n-        matchedDriver,\r\n-        bookingConfirmed,\r\n-        bookingId,\r\n-        showBookingForm,\r\n-        searching,\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n       };\r\n-      try {\r\n-        await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState));\r\n-      } catch (err) {\r\n-        console.warn(\"Error saving booking state:\", err);\r\n-      }\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n     };\r\n-\r\n     saveBookingState();\r\n-  }, [\r\n-    destination,\r\n-    destinationLabel,\r\n-    notes,\r\n-    paymentMethod,\r\n-    fare,\r\n-    matchedDriver,\r\n-    bookingConfirmed,\r\n-    bookingId,\r\n-    showBookingForm,\r\n-    searching,\r\n-  ]);\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n \r\n   useEffect(() => {\r\n     const loadBookingState = async () => {\r\n       try {\r\n         const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n         if (savedState) {\r\n-          const {\r\n-            destination,\r\n-            destinationLabel,\r\n-            notes,\r\n-            paymentMethod,\r\n-            fare,\r\n-            matchedDriver,\r\n-            bookingConfirmed,\r\n-            bookingId,\r\n-            showBookingForm,\r\n-            searching,\r\n-          } = JSON.parse(savedState);\r\n-\r\n-          if (destination) setDestination(destination);\r\n-          if (destinationLabel) setDestinationLabel(destinationLabel);\r\n-          if (notes) setNotes(notes);\r\n-          if (paymentMethod) setPaymentMethod(paymentMethod);\r\n-          if (fare) setFare(fare);\r\n-          if (matchedDriver) setMatchedDriver(matchedDriver);\r\n-          if (bookingConfirmed) setBookingConfirmed(bookingConfirmed);\r\n-          if (bookingId) setBookingId(bookingId);\r\n-          if (showBookingForm) setShowBookingForm(showBookingForm);\r\n-          if (searching) setSearching(searching);\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n         }\r\n-      } catch (err) {\r\n-        console.warn(\"Error loading booking state:\", err);\r\n-      }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n     };\r\n-\r\n     loadBookingState();\r\n   }, []);\r\n \r\n   const submitDriverRating = async () => {\r\n     try {\r\n       const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n       const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-\r\n       if (!driverIdToRate || !bookingIdToRate) {\r\n         Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n         return;\r\n       }\r\n-\r\n       const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n         method: \"POST\",\r\n         headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          driverId: driverIdToRate,\r\n-          rating: selectedRating,\r\n-        }),\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n       });\r\n \r\n       if (res.ok && notes) {\r\n-        // Save the feedback separately if there's a note\r\n         await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n           method: \"POST\",\r\n           headers: { \"Content-Type\": \"application/json\" },\r\n           body: JSON.stringify({\r\n@@ -575,36 +469,20 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n \r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n \r\n-  useEffect(() => {\r\n-    if (tripCompleted) {\r\n-      setShowRatingModal(true);\r\n-    }\r\n-  }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\r\n-    \"Overcharging\",\r\n-    \"Harassment\",\r\n-    \"Unproper Attire\",\r\n-    \"Refusal to Convey Passenger\",\r\n-    \"Other\",\r\n-  ];\r\n-\r\n   const submitReport = async () => {\r\n     try {\r\n       const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n       const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n         method: \"POST\",\r\n         headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify({\r\n-          bookingId,\r\n-          passengerId,\r\n-          driverId: matchedDriver?.driverId,\r\n-          reportType,\r\n-          otherReport,\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n         }),\r\n       });\r\n       if (res.ok) {\r\n         Alert.alert(\"Success\", \"Report submitted!\");\r\n@@ -618,40 +496,26 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n-\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n           <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-\r\n-\r\n           {mapHtml && (\r\n             <WebView\r\n-              scrollEnabled={true}\r\n-              ref={(ref) => {\r\n-                if (ref && !mapRef.current) {\r\n-                  mapRef.current = ref;\r\n-                }\r\n-              }}\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n               pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n-              style={{\r\n-                position: \"absolute\",\r\n-                top: 0,\r\n-                left: 0,\r\n-                right: 0,\r\n-                bottom: -30,\r\n-                zIndex: 0,\r\n-              }}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n               onMessage={handleMapMessage}\r\n-              nestedScrollEnabled={true}\r\n+              nestedScrollEnabled\r\n             />\r\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n@@ -686,25 +550,16 @@\n                     elevation: 3,\r\n                   }}\r\n                 >\r\n                   {infoBoxMinimized ? (\r\n-                    <TouchableOpacity\r\n-                      style={{\r\n-                        alignItems: \"center\",\r\n-                        padding: 10,\r\n-                      }}\r\n-                      onPress={() => setInfoBoxMinimized(false)}\r\n-                    >\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n                       <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n                     </TouchableOpacity>\r\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n                         {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n-                          />\r\n+                          <Image source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }} style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }} />\r\n                         )}\r\n                         <View style={{ flex: 1}}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver.driverName}</Text>\r\n@@ -712,19 +567,13 @@\n                           <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n                         </View>\r\n                       </View>\r\n                       <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity\r\n-                          onPress={() => setInfoBoxMinimized(true)}\r\n-                          style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n-                        <TouchableOpacity\r\n-                          onPress={() => setShowReportModal(true)}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n@@ -735,21 +584,15 @@\n                                 headers: { \"Content-Type\": \"application/json\" },\r\n                                 body: JSON.stringify({ bookingId }),\r\n                               });\r\n                               await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch (err) { }\r\n+                            } catch {}\r\n                             setSearching(false);\r\n                             setBookingId(null);\r\n                             setMatchedDriver(null);\r\n                             setDestination(null);\r\n                             setBookingConfirmed(false);\r\n-                            mapRef.current?.postMessage(\r\n-                              JSON.stringify({\r\n-                                type: \"setMarkers\",\r\n-                                destination: null,\r\n-                                driver: null,\r\n-                              })\r\n-                            );\r\n+                            mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n                           style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n@@ -760,42 +603,18 @@\n                   )}\r\n                 </View>\r\n               )}\r\n             </View>\r\n+\r\n             {showBookingForm && (\r\n               <View style={styles.panel}>\r\n                 <Text style={styles.panelTitle}>Booking Details</Text>\r\n                 <ScrollView style={styles.inputsContainer}>\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Saan ang pick-up?\"\r\n-                    value={pickupName}\r\n-                    editable={true}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Saan ang drop-off?\"\r\n-                    value={dropoffName}\r\n-                    editable={true}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                    value={destinationLabel}\r\n-                    onChangeText={setDestinationLabel}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Notes sa driver\"\r\n-                    value={notes}\r\n-                    onChangeText={setNotes}\r\n-                  />\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Paano ka magbabayad?\"\r\n-                    value={paymentMethod}\r\n-                    onChangeText={setPaymentMethod}\r\n-                  />\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n                 </ScrollView>\r\n                 <View style={styles.fareContainer}>\r\n                   <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n                   <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n@@ -807,64 +626,34 @@\n \r\n             {!matchedDriver && !searching && !showBookingForm && (\r\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n-                style={{\r\n-                  position: \"absolute\",\r\n-                  bottom: 10,\r\n-                  backgroundColor: \"#81C3E1\",\r\n-                  padding: 10,\r\n-                  borderRadius: 8,\r\n-                }}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n               >\r\n                 <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n               </TouchableOpacity>\r\n             )}\r\n \r\n             {showRatingModal && (\r\n               <View style={styles.ratingModalOverlay}>\r\n                 <View style={styles.ratingModal}>\r\n-\r\n-                  <TouchableOpacity\r\n-                    style={styles.dismissButton}\r\n-                    onPress={() => {\r\n-                      setShowRatingModal(false);\r\n-                      AsyncStorage.removeItem(\"driverIdToRate\");\r\n-                    }}\r\n-                  >\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n                     <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n                   </TouchableOpacity>\r\n \r\n                   <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n \r\n                   <View style={styles.starsContainer}>\r\n                     {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity\r\n-                        key={star}\r\n-                        onPress={() => setSelectedRating(star)}\r\n-                      >\r\n-                        <Ionicons\r\n-                          name={selectedRating >= star ? \"star\" : \"star-outline\"}\r\n-                          size={30}\r\n-                          color=\"#FFD700\"\r\n-                        />\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n                       </TouchableOpacity>\r\n                     ))}\r\n                   </View>\r\n \r\n-                  <TextInput\r\n-                    style={styles.feedbackInput}\r\n-                    placeholder=\"Leave a comment (optional)\"\r\n-                    multiline\r\n-                    numberOfLines={3}\r\n-                    onChangeText={(text) => setNotes(text)}\r\n-                    value={notes}\r\n-                  />\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n \r\n-                  <TouchableOpacity\r\n-                    style={styles.submitButton}\r\n-                    onPress={submitDriverRating}\r\n-                  >\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n                     <Text style={styles.submitButtonText}>Submit</Text>\r\n                   </TouchableOpacity>\r\n                 </View>\r\n               </View>\r\n@@ -872,71 +661,42 @@\n \r\n             {showReportModal && (\r\n               <View style={styles.ratingModalOverlay}>\r\n                 <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity\r\n-                    style={styles.dismissButton}\r\n-                    onPress={() => setShowReportModal(false)}\r\n-                  >\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n                     <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n                   </TouchableOpacity>\r\n \r\n                   <Text style={styles.modalTitle}>Report Driver</Text>\r\n \r\n                   <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n                   <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity\r\n-                      style={styles.dropdownButton}\r\n-                      onPress={() => setShowDropdown(!showDropdown)}\r\n-                    >\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>\r\n-                        {reportType || \"Select a violation\"}\r\n-                      </Text>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n                       <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n                     </TouchableOpacity>\r\n \r\n                     {showDropdown && (\r\n                       <View style={styles.dropdownMenu}>\r\n-                        {reportOptions.map((option) => (\r\n-                          <TouchableOpacity\r\n-                            key={option}\r\n-                            style={styles.dropdownItem}\r\n-                            onPress={() => {\r\n-                              setReportType(option);\r\n-                              setShowDropdown(false);\r\n-                            }}\r\n-                          >\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n                             <Text style={{ color: \"#000\" }}>{option}</Text>\r\n                           </TouchableOpacity>\r\n                         ))}\r\n                       </View>\r\n                     )}\r\n                   </View>\r\n \r\n-\r\n                   {reportType === \"Other\" && (\r\n-                    <TextInput\r\n-                      style={styles.feedbackInput}\r\n-                      placeholder=\"Describe the issue\"\r\n-                      multiline\r\n-                      numberOfLines={3}\r\n-                      value={otherReport}\r\n-                      onChangeText={setOtherReport}\r\n-                    />\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n                   )}\r\n \r\n-                  <TouchableOpacity\r\n-                    style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]}\r\n-                    onPress={submitReport}\r\n-                  >\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n                     <Text style={styles.submitButtonText}>Submit Report</Text>\r\n                   </TouchableOpacity>\r\n                 </View>\r\n               </View>\r\n             )}\r\n-\r\n-\r\n-\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n@@ -944,130 +704,42 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: {position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   panel: {\r\n-    position: 'absolute',\r\n-    bottom: 10, \r\n-    width: '100%',\r\n-    backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20,\r\n-    borderTopRightRadius: 20,\r\n-    padding: 15,\r\n-    zIndex: 10,\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n   },\r\n   panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  radioContainer: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 5 },\r\n-  radioButton: { padding: 10, backgroundColor: '#FFF', borderRadius: 10, marginRight: 10 },\r\n   inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n   input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: {\r\n-    flexDirection: 'row',\r\n-    justifyContent: 'space-between',\r\n-    alignItems: 'center',\r\n-    marginTop: 10,\r\n-  },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n   ratingModalOverlay: {\r\n-    position: \"absolute\",\r\n-    top: -100,\r\n-    left: 0,\r\n-    right: 0,\r\n-    bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\",\r\n-    justifyContent: \"center\",\r\n-    alignItems: \"center\",\r\n-    zIndex: 999,\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n   },\r\n-  ratingModal: {\r\n-    width: \"80%\",\r\n-    backgroundColor: \"#fff\",\r\n-    borderRadius: 10,\r\n-    padding: 20,\r\n-    alignItems: \"center\",\r\n-  },\r\n-\r\n-  dismissButton: {\r\n-    position: \"absolute\",\r\n-    top: 10,\r\n-    right: 10,\r\n-    zIndex: 10,\r\n-  },\r\n-\r\n-  modalTitle: {\r\n-    fontSize: 18,\r\n-    fontWeight: \"bold\",\r\n-    marginBottom: 5,\r\n-  },\r\n-  starsContainer: {\r\n-    flexDirection: \"row\",\r\n-    marginBottom: 10,\r\n-  },\r\n-  feedbackInput: {\r\n-    width: \"100%\",\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ddd\",\r\n-    borderRadius: 8,\r\n-    padding: 10,\r\n-    marginBottom: 10,\r\n-    textAlignVertical: \"top\",\r\n-  },\r\n-  submitButton: {\r\n-    backgroundColor: \"#4caf50\",\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 20,\r\n-    borderRadius: 8,\r\n-  },\r\n-  submitButtonText: {\r\n-    color: \"#fff\",\r\n-    fontWeight: \"bold\",\r\n-  },\r\n-\r\n-  modalLabel: {\r\n-    marginTop: 5,\r\n-    marginBottom: 5,\r\n-    fontSize: 14,\r\n-    color: \"#333\",\r\n-    fontWeight: \"500\",\r\n-  },\r\n-  pickerContainer: {\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ddd\",\r\n-    borderRadius: 8,\r\n-    marginBottom: 10,\r\n-    overflow: \"hidden\",\r\n-  },\r\n-  picker: {\r\n-    height: 50,\r\n-    padding: 0,\r\n-    width: \"100%\",\r\n-  },\r\n-\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n   dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n   dropdownButton: {\r\n-    flexDirection: \"row\",\r\n-    justifyContent: \"space-between\",\r\n-    alignItems: \"center\",\r\n-    padding: 10,\r\n-    backgroundColor: \"#FFF\",\r\n-    borderRadius: 8,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n   },\r\n-  dropdownMenu: {\r\n-    backgroundColor: \"#FFF\",\r\n-    borderRadius: 8,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n-    marginTop: 2,\r\n-  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n   dropdownItem: { padding: 10 },\r\n-\r\n-\r\n-\r\n   totalFare: { fontWeight: 'bold' },\r\n   bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n   bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n });\r\n-\r\n"
                },
                {
                    "date": 1754899182116,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,17 +62,38 @@\n         }),\r\n       });\r\n \r\n       const data = await res.json();\r\n+\r\n       if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n         console.error(\"üõë Invalid ORS response:\", data);\r\n         Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n         return;\r\n       }\r\n \r\n-      const coords = data.features[0].geometry.coordinates; // [lng, lat][]\r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); // Leaflet expects [lat, lng]\r\n+      const coords = data.features[0].geometry.coordinates; \r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n \r\n+      const summary = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM = summary.distance ?? 0;\r\n+      const durationS = summary.duration ?? 0;\r\n+\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60\r\n+        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n+        : `${mins} min`;\r\n+\r\n+      mapRef.current?.postMessage(JSON.stringify({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm,       // for fare calculations\r\n+        distanceText,     \r\n+        durationText,     \r\n+      }));\r\n+\r\n       mapRef.current?.postMessage(\r\n         JSON.stringify({ type: 'drawRoute', route: polylinePoints })\r\n       );\r\n     } catch (err) {\r\n"
                },
                {
                    "date": 1754899594304,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -156,15 +156,27 @@\n             .driver-label {\r\n               font-weight: bold; color: red; background: white;\r\n               padding: 2px 5px; border-radius: 4px; font-size: 14px;\r\n             }\r\n+            /* Distance pill */\r\n+            .distance-label {\r\n+              background: rgba(0,0,0,0.75);\r\n+              color: #fff;\r\n+              padding: 4px 8px;\r\n+              border-radius: 12px;\r\n+              font-size: 12px;\r\n+              white-space: nowrap;\r\n+              box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n+            }\r\n           </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             let routeLine = null;\r\n+            let distanceMarker = null;\r\n+\r\n             window.onload = function () {\r\n               const map = L.map('map', {\r\n                 zoomControl: false, dragging: true, scrollWheelZoom: true,\r\n                 touchZoom: true, doubleClickZoom: true, boxZoom: true,\r\n@@ -202,12 +214,33 @@\n \r\n               document.addEventListener('message', function(event) {\r\n                 const msg = JSON.parse(event.data);\r\n \r\n+                /* Draw route + distance label (expects: route, distanceText, durationText optional) */\r\n                 if (msg.type === 'drawRoute' && Array.isArray(msg.route)) {\r\n                   if (routeLine) map.removeLayer(routeLine);\r\n+                  if (distanceMarker) map.removeLayer(distanceMarker);\r\n+\r\n                   routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n                   map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n+\r\n+                  // midpoint of the route\r\n+                  const midIdx = Math.floor(msg.route.length / 2);\r\n+                  const mid = msg.route[midIdx]; // [lat, lng]\r\n+\r\n+                  const label = msg.durationText\r\n+                    ? \\`\\${msg.distanceText} ‚Ä¢ \\${msg.durationText}\\`\r\n+                    : msg.distanceText;\r\n+\r\n+                  distanceMarker = L.marker(mid, {\r\n+                    icon: L.divIcon({\r\n+                      className: 'distance-label',\r\n+                      html: label,\r\n+                      iconSize: [0, 0],\r\n+                      iconAnchor: [0, 0],\r\n+                    }),\r\n+                    interactive: false\r\n+                  }).addTo(map);\r\n                 }\r\n \r\n                 if (msg.type === 'setMarkers') {\r\n                   destinationLocked = !!msg.driver;\r\n"
                },
                {
                    "date": 1754900063966,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,12 +91,8 @@\n         distanceKm,       // for fare calculations\r\n         distanceText,     \r\n         durationText,     \r\n       }));\r\n-\r\n-      mapRef.current?.postMessage(\r\n-        JSON.stringify({ type: 'drawRoute', route: polylinePoints })\r\n-      );\r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n     }\r\n"
                },
                {
                    "date": 1754900072390,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,8 +91,9 @@\n         distanceKm,       // for fare calculations\r\n         distanceText,     \r\n         durationText,     \r\n       }));\r\n+      \r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n     }\r\n"
                },
                {
                    "date": 1754900780444,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,9 +91,9 @@\n         distanceKm,       // for fare calculations\r\n         distanceText,     \r\n         durationText,     \r\n       }));\r\n-      \r\n+\r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n     }\r\n@@ -155,15 +155,18 @@\n               padding: 2px 5px; border-radius: 4px; font-size: 14px;\r\n             }\r\n             /* Distance pill */\r\n             .distance-label {\r\n-              background: rgba(0,0,0,0.75);\r\n+              background: rgba(0,0,0,0.85);\r\n               color: #fff;\r\n               padding: 4px 8px;\r\n               border-radius: 12px;\r\n               font-size: 12px;\r\n+              line-height: 1;\r\n+              display: inline-block;   /* let it size to content */\r\n               white-space: nowrap;\r\n               box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n+              pointer-events: none;    /* don‚Äôt block map gestures */\r\n             }\r\n           </style>\r\n         </head>\r\n         <body>\r\n"
                },
                {
                    "date": 1754900788387,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -161,12 +161,12 @@\n               padding: 4px 8px;\r\n               border-radius: 12px;\r\n               font-size: 12px;\r\n               line-height: 1;\r\n-              display: inline-block;   /* let it size to content */\r\n+              display: inline-block;   \r\n               white-space: nowrap;\r\n               box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n-              pointer-events: none;    /* don‚Äôt block map gestures */\r\n+              pointer-events: none;   \r\n             }\r\n           </style>\r\n         </head>\r\n         <body>\r\n"
                },
                {
                    "date": 1754900883915,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -234,10 +234,8 @@\n                   distanceMarker = L.marker(mid, {\r\n                     icon: L.divIcon({\r\n                       className: 'distance-label',\r\n                       html: label,\r\n-                      iconSize: [0, 0],\r\n-                      iconAnchor: [0, 0],\r\n                     }),\r\n                     interactive: false\r\n                   }).addTo(map);\r\n                 }\r\n"
                },
                {
                    "date": 1754900937120,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -232,10 +232,11 @@\n                     : msg.distanceText;\r\n \r\n                   distanceMarker = L.marker(mid, {\r\n                     icon: L.divIcon({\r\n-                      className: 'distance-label',\r\n+                      className: 'leaflet-div-icon distance-label',\r\n                       html: label,\r\n+                      iconAnchor: [0, 0],\r\n                     }),\r\n                     interactive: false\r\n                   }).addTo(map);\r\n                 }\r\n"
                },
                {
                    "date": 1754901128021,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -149,21 +149,18 @@\n           <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n           <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n           <style>\r\n             html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-            .driver-label {\r\n-              font-weight: bold; color: red; background: white;\r\n-              padding: 2px 5px; border-radius: 4px; font-size: 14px;\r\n-            }\r\n-            /* Distance pill */\r\n+            .driver-label { font-weight: bold; color: red; background: white; padding: 2px 5px; border-radius: 4px; font-size: 14px; }\r\n+\r\n             .distance-label {\r\n               background: rgba(0,0,0,0.85);\r\n               color: #fff;\r\n               padding: 4px 8px;\r\n               border-radius: 12px;\r\n               font-size: 12px;\r\n               line-height: 1;\r\n-              display: inline-block;   \r\n+              display: inline-block;   /* let it size to content */\r\n               white-space: nowrap;\r\n               box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n               pointer-events: none;   \r\n             }\r\n@@ -232,10 +229,11 @@\n                     : msg.distanceText;\r\n \r\n                   distanceMarker = L.marker(mid, {\r\n                     icon: L.divIcon({\r\n-                      className: 'leaflet-div-icon distance-label',\r\n+                      className: 'distance-label',\r\n                       html: label,\r\n+                      iconSize: [0, 0],\r\n                       iconAnchor: [0, 0],\r\n                     }),\r\n                     interactive: false\r\n                   }).addTo(map);\r\n"
                },
                {
                    "date": 1754901158396,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,20 +151,20 @@\n           <style>\r\n             html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n             .driver-label { font-weight: bold; color: red; background: white; padding: 2px 5px; border-radius: 4px; font-size: 14px; }\r\n \r\n-            .distance-label {\r\n+            .distance-label.leaflet-tooltip {\r\n               background: rgba(0,0,0,0.85);\r\n               color: #fff;\r\n+              border: none;\r\n+              border-radius: 12px;\r\n               padding: 4px 8px;\r\n-              border-radius: 12px;\r\n+              box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n               font-size: 12px;\r\n               line-height: 1;\r\n-              display: inline-block;   /* let it size to content */\r\n               white-space: nowrap;\r\n-              box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n-              pointer-events: none;   \r\n             }\r\n+            .distance-label.leaflet-tooltip:before { display: none; }\r\n           </style>\r\n         </head>\r\n         <body>\r\n           <div id=\"map\"></div>\r\n"
                },
                {
                    "date": 1754901207099,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -170,10 +170,11 @@\n           <div id=\"map\"></div>\r\n           <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n           <script>\r\n             let routeLine = null;\r\n-            let distanceMarker = null;\r\n+            let distanceTooltip = null;\r\n \r\n+\r\n             window.onload = function () {\r\n               const map = L.map('map', {\r\n                 zoomControl: false, dragging: true, scrollWheelZoom: true,\r\n                 touchZoom: true, doubleClickZoom: true, boxZoom: true,\r\n"
                },
                {
                    "date": 1754901265228,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -213,11 +213,11 @@\n               document.addEventListener('message', function(event) {\r\n                 const msg = JSON.parse(event.data);\r\n \r\n                 /* Draw route + distance label (expects: route, distanceText, durationText optional) */\r\n-                if (msg.type === 'drawRoute' && Array.isArray(msg.route)) {\r\n+                if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n                   if (routeLine) map.removeLayer(routeLine);\r\n-                  if (distanceMarker) map.removeLayer(distanceMarker);\r\n+                  if (distanceTooltip) map.removeLayer(distanceTooltip);\r\n \r\n                   routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n                   map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n \r\n@@ -228,19 +228,21 @@\n                   const label = msg.durationText\r\n                     ? \\`\\${msg.distanceText} ‚Ä¢ \\${msg.durationText}\\`\r\n                     : msg.distanceText;\r\n \r\n-                  distanceMarker = L.marker(mid, {\r\n-                    icon: L.divIcon({\r\n-                      className: 'distance-label',\r\n-                      html: label,\r\n-                      iconSize: [0, 0],\r\n-                      iconAnchor: [0, 0],\r\n-                    }),\r\n-                    interactive: false\r\n-                  }).addTo(map);\r\n+                  // Permanent, centered pill. Offset lifts it slightly above the line.\r\n+                  distanceTooltip = L.tooltip({\r\n+                    permanent: true,\r\n+                    direction: 'top',\r\n+                    offset: [0, -6],\r\n+                    className: 'distance-label'\r\n+                  })\r\n+                    .setContent(label || '')\r\n+                    .setLatLng(mid)\r\n+                    .addTo(map);\r\n                 }\r\n \r\n+\r\n                 if (msg.type === 'setMarkers') {\r\n                   destinationLocked = !!msg.driver;\r\n                   if (destMarker) map.removeLayer(destMarker);\r\n                   if (msg.destination) {\r\n"
                },
                {
                    "date": 1754902328986,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -11,8 +11,26 @@\n import * as Location from 'expo-location';\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n \r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  const BASE_FARE = 20;      // first 2 km\r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;          // succeeding km\r\n+\r\n+  // per-started-km after 2 km (use Math.max to avoid negatives)\r\n+  const extraKm = Math.max(0, Math.ceil(distanceKm - INCLUDED_KM));\r\n+  let fare = BASE_FARE + extraKm * PER_KM;\r\n+\r\n+  // 20% off for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); // nearest peso\r\n+};\r\n+\r\n+\r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n@@ -45,9 +63,11 @@\n   const [otherReport, setOtherReport] = useState(\"\");\r\n   const [pickupName, setPickupName] = useState(\"\");\r\n   const [dropoffName, setDropoffName] = useState(\"\");\r\n   const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); // we‚Äôll wire UI later\r\n \r\n+\r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n     to: { latitude: number; longitude: number }\r\n"
                },
                {
                    "date": 1754902346208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -63,9 +63,9 @@\n   const [otherReport, setOtherReport] = useState(\"\");\r\n   const [pickupName, setPickupName] = useState(\"\");\r\n   const [dropoffName, setDropoffName] = useState(\"\");\r\n   const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); // we‚Äôll wire UI later\r\n+  const [discount] = useState<DiscountType>('none'); \r\n \r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n"
                },
                {
                    "date": 1754902423177,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -104,8 +104,11 @@\n       const durationText = mins >= 60\r\n         ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n         : `${mins} min`;\r\n \r\n+      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n+      const fareText = `‚Ç±${computedFare} est`;\r\n+\r\n       mapRef.current?.postMessage(JSON.stringify({\r\n         type: 'drawRoute',\r\n         route: polylinePoints,\r\n         distanceKm,       // for fare calculations\r\n"
                },
                {
                    "date": 1754902455424,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -110,11 +110,12 @@\n \r\n       mapRef.current?.postMessage(JSON.stringify({\r\n         type: 'drawRoute',\r\n         route: polylinePoints,\r\n-        distanceKm,       // for fare calculations\r\n+        distanceKm, \r\n         distanceText,     \r\n-        durationText,     \r\n+        durationText,\r\n+        fareText,  \r\n       }));\r\n \r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n"
                },
                {
                    "date": 1754902591699,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -248,12 +248,15 @@\n                   // midpoint of the route\r\n                   const midIdx = Math.floor(msg.route.length / 2);\r\n                   const mid = msg.route[midIdx]; // [lat, lng]\r\n \r\n-                  const label = msg.durationText\r\n-                    ? \\`\\${msg.distanceText} ‚Ä¢ \\${msg.durationText}\\`\r\n-                    : msg.distanceText;\r\n+                  const parts = [];\r\n+                  if (msg.distanceText) parts.push(msg.distanceText);\r\n+                  if (msg.durationText) parts.push(msg.durationText);\r\n+                  if (msg.fareText)     parts.push(msg.fareText);\r\n \r\n+                  const label = parts.join(' ‚Ä¢ ');\r\n+\r\n                   // Permanent, centered pill. Offset lifts it slightly above the line.\r\n                   distanceTooltip = L.tooltip({\r\n                     permanent: true,\r\n                     direction: 'top',\r\n"
                },
                {
                    "date": 1754902838425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,8 +22,13 @@\n   // per-started-km after 2 km (use Math.max to avoid negatives)\r\n   const extraKm = Math.max(0, Math.ceil(distanceKm - INCLUDED_KM));\r\n   let fare = BASE_FARE + extraKm * PER_KM;\r\n \r\n+  if (distanceKm > INCLUDED_KM) {\r\n+    const extraKm = Math.floor(distanceKm - INCLUDED_KM); \r\n+    fare += extraKm * PER_KM;\r\n+  }\r\n+\r\n   // 20% off for senior/student/PWD\r\n   if (discount !== 'none') fare *= 0.8;\r\n \r\n   return Math.round(fare); // nearest peso\r\n"
                },
                {
                    "date": 1754902859157,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n   const BASE_FARE = 20;      // first 2 km\r\n-  const INCLUDED_KM = 2;\r\n+  const INCLUDED_KM = 3;\r\n   const PER_KM = 5;          // succeeding km\r\n \r\n   // per-started-km after 2 km (use Math.max to avoid negatives)\r\n   const extraKm = Math.max(0, Math.ceil(distanceKm - INCLUDED_KM));\r\n"
                },
                {
                    "date": 1754903150398,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n   const BASE_FARE = 20;      // first 2 km\r\n-  const INCLUDED_KM = 3;\r\n+  const INCLUDED_KM = 2.99;\r\n   const PER_KM = 5;          // succeeding km\r\n \r\n   // per-started-km after 2 km (use Math.max to avoid negatives)\r\n   const extraKm = Math.max(0, Math.ceil(distanceKm - INCLUDED_KM));\r\n"
                },
                {
                    "date": 1754903545316,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,9 +40,8 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(20);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{\r\n"
                },
                {
                    "date": 1754903577508,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -125,8 +125,9 @@\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n     }\r\n   };\r\n+  const [fare, setFare] = useState(computedFare);\r\n   // ---------------------------------------------------------\r\n \r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1754903871104,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -40,8 +40,9 @@\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n   const [mapHtml, setMapHtml] = useState(\"\");\r\n   const mapRef = useRef<WebViewType>(null);\r\n   const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n   const [matchedDriver, setMatchedDriver] = useState<{\r\n@@ -110,8 +111,9 @@\n         : `${mins} min`;\r\n \r\n       const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n       const fareText = `‚Ç±${computedFare} est`;\r\n+      setFare(computedFare);\r\n \r\n       mapRef.current?.postMessage(JSON.stringify({\r\n         type: 'drawRoute',\r\n         route: polylinePoints,\r\n@@ -125,9 +127,8 @@\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n     }\r\n   };\r\n-  const [fare, setFare] = useState(computedFare);\r\n   // ---------------------------------------------------------\r\n \r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1754920791252,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,9 +18,8 @@\n   const BASE_FARE = 20;      // first 2 km\r\n   const INCLUDED_KM = 2.99;\r\n   const PER_KM = 5;          // succeeding km\r\n \r\n-  // per-started-km after 2 km (use Math.max to avoid negatives)\r\n   const extraKm = Math.max(0, Math.ceil(distanceKm - INCLUDED_KM));\r\n   let fare = BASE_FARE + extraKm * PER_KM;\r\n \r\n   if (distanceKm > INCLUDED_KM) {\r\n@@ -258,18 +257,10 @@\n                   const parts = [];\r\n                   if (msg.distanceText) parts.push(msg.distanceText);\r\n                   if (msg.durationText) parts.push(msg.durationText);\r\n                   if (msg.fareText)     parts.push(msg.fareText);\r\n-\r\n                   const label = parts.join(' ‚Ä¢ ');\r\n-\r\n-                  // Permanent, centered pill. Offset lifts it slightly above the line.\r\n-                  distanceTooltip = L.tooltip({\r\n-                    permanent: true,\r\n-                    direction: 'top',\r\n-                    offset: [0, -6],\r\n-                    className: 'distance-label'\r\n-                  })\r\n+                  distanceTooltip = L.tooltip({permanent: true, direction: 'top', offset: [0, -6], className: 'distance-label'})\r\n                     .setContent(label || '')\r\n                     .setLatLng(mid)\r\n                     .addTo(map);\r\n                 }\r\n"
                },
                {
                    "date": 1754921935917,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -291,8 +291,13 @@\n                     }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n                       .setZIndexOffset(1000);\r\n                   }\r\n                 }\r\n+\r\n+                if (msg.type === 'clearRoute') {\r\n+                  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }\r\n+                  if (distanceTooltip) { map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+                }\r\n               });\r\n             }\r\n           </script>\r\n         </body>\r\n"
                },
                {
                    "date": 1754922326850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -674,8 +674,10 @@\n                             setMatchedDriver(null);\r\n                             setDestination(null);\r\n                             setBookingConfirmed(false);\r\n                             mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n+                            mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n+                            setFare(0);\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n                           style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n"
                },
                {
                    "date": 1754923214541,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -292,9 +292,9 @@\n                       .setZIndexOffset(1000);\r\n                   }\r\n                 }\r\n \r\n-                if (msg.type === 'clearRoute') {\r\n+                if (msg.type === '') {\r\n                   if (routeLine) { map.removeLayer(routeLine); routeLine = null; }\r\n                   if (distanceTooltip) { map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n                 }\r\n               });\r\n"
                },
                {
                    "date": 1754923302418,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -292,11 +292,12 @@\n                       .setZIndexOffset(1000);\r\n                   }\r\n                 }\r\n \r\n-                if (msg.type === '') {\r\n+                if (msg.type === 'clearRoute') {\r\n                   if (routeLine) { map.removeLayer(routeLine); routeLine = null; }\r\n                   if (distanceTooltip) { map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+                  if (typeof distanceMarker !== 'undefined' && distanceMarker) {map.removeLayer(distanceMarker); distanceMarker = null;}\r\n                 }\r\n               });\r\n             }\r\n           </script>\r\n"
                },
                {
                    "date": 1754923419261,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -470,8 +470,10 @@\n           setShowBookingForm(false);\r\n           setTripCompleted(true);\r\n \r\n           mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n+          mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n+          setFare(0);\r\n         }\r\n       } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n     };\r\n     interval = setInterval(pollForBookingCompletion, 4000);\r\n"
                },
                {
                    "date": 1754925671368,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -68,8 +68,11 @@\n   const [pickupName, setPickupName] = useState(\"\");\r\n   const [dropoffName, setDropoffName] = useState(\"\");\r\n   const [showDropdown, setShowDropdown] = useState(false);\r\n   const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n \r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n"
                },
                {
                    "date": 1754925753514,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -129,8 +129,46 @@\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n     }\r\n   };\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      try {\r\n+        const url = `${API_BASE_URL}/api/geocode?q=${encodeURIComponent(t)}&lat=${location.latitude}&lon=${location.longitude}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lon: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+    const dest = { latitude: p.lat, longitude: p.lon };\r\n+\r\n+    // update UI + names you already show\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // draw route immediately\r\n+    fetchORSRoute(location, dest);\r\n+\r\n+    // (optional) update markers on the map right away\r\n+    mapRef.current?.postMessage(JSON.stringify({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    }));\r\n+  };\r\n   // ---------------------------------------------------------\r\n \r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1754926179106,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -136,10 +136,16 @@\n \r\n     if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n     searchTimerRef.current = setTimeout(async () => {\r\n       if (!t || t.length < 3) { setHits([]); return; }\r\n+\r\n+      // bail if we don‚Äôt have the user‚Äôs location yet\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n       try {\r\n-        const url = `${API_BASE_URL}/api/geocode?q=${encodeURIComponent(t)}&lat=${location.latitude}&lon=${location.longitude}`;\r\n+        const lat = location.latitude;\r\n+        const lon = location.longitude;\r\n+        const url = `${API_BASE_URL}/api/geocode?q=${encodeURIComponent(t)}&lat=${lat}&lon=${lon}`;\r\n         const r = await fetch(url);\r\n         const data = await r.json();\r\n         setHits(Array.isArray(data) ? data : []);\r\n       } catch {\r\n@@ -147,28 +153,40 @@\n       }\r\n     }, 300);\r\n   };\r\n \r\n+\r\n   // When a user taps a suggestion\r\n   const choosePlace = (p: { label: string; lat: number; lon: number }) => {\r\n     setQuery(p.label);\r\n     setHits([]);\r\n+\r\n     const dest = { latitude: p.lat, longitude: p.lon };\r\n \r\n-    // update UI + names you already show\r\n+    // update UI\r\n     setDestination(dest);\r\n     setDropoffName(p.label);\r\n \r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n     // draw route immediately\r\n-    fetchORSRoute(location, dest);\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest\r\n+    );\r\n \r\n-    // (optional) update markers on the map right away\r\n+    // (optional) update markers\r\n     mapRef.current?.postMessage(JSON.stringify({\r\n       type: 'setMarkers',\r\n       destination: dest,\r\n       driver: null,\r\n     }));\r\n   };\r\n+\r\n   // ---------------------------------------------------------\r\n \r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1754926273626,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -664,8 +664,32 @@\n           )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n+              {/* Destination search */}\r\n+              <View style={styles.searchWrap}>\r\n+                <TextInput\r\n+                  value={query}\r\n+                  onChangeText={onChangeQuery}\r\n+                  placeholder=\"Search destination (e.g., SM Lipa)\"\r\n+                  placeholderTextColor=\"#777\"\r\n+                  style={styles.searchInput}\r\n+                />\r\n+                {hits.length > 0 && (\r\n+                  <View style={styles.searchResults}>\r\n+                    {hits.map((h, i) => (\r\n+                      <TouchableOpacity\r\n+                        key={`${h.lat},${h.lon}-${i}`}\r\n+                        onPress={() => choosePlace(h)}\r\n+                        style={styles.searchItem}\r\n+                      >\r\n+                        <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+                )}\r\n+              </View>\r\n+\r\n               {searching && (\r\n                 <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n                   <TouchableOpacity\r\n"
                },
                {
                    "date": 1754926308427,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -877,8 +877,39 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n   panel: {\r\n     position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n     borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n   },\r\n"
                },
                {
                    "date": 1754927420830,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,10 +269,11 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 19, attribution: '¬© OpenStreetMap contributors'\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 19,\r\n+                attribution: '¬© OpenStreetMap contributors ¬© CARTO'\r\n               }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n"
                },
                {
                    "date": 1754927646417,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,10 +269,11 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 19,\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 20,\r\n+                subdomains: 'abcd',\r\n                 attribution: '¬© OpenStreetMap contributors ¬© CARTO'\r\n               }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n"
                },
                {
                    "date": 1754927673574,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,12 +269,11 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {\r\n+              L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png?api_key=YOUR_KEY', {\r\n                 maxZoom: 20,\r\n-                subdomains: 'abcd',\r\n-                attribution: '¬© OpenStreetMap contributors ¬© CARTO'\r\n+                attribution: '¬© OpenStreetMap contributors, ¬© Stadia Maps, ¬© Stamen Design'\r\n               }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n"
                },
                {
                    "date": 1754927795537,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,11 +269,12 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png?api_key=YOUR_KEY', {\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {\r\n                 maxZoom: 20,\r\n-                attribution: '¬© OpenStreetMap contributors, ¬© Stadia Maps, ¬© Stamen Design'\r\n+                subdomains: 'abcd',\r\n+                attribution: '¬© OpenStreetMap contributors, ¬© CARTO'\r\n               }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n"
                },
                {
                    "date": 1754927819063,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,13 +269,12 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {\r\n-                maxZoom: 20,\r\n-                subdomains: 'abcd',\r\n-                attribution: '¬© OpenStreetMap contributors, ¬© CARTO'\r\n-              }).addTo(map);\r\n+L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {\r\n+  maxZoom: 19,\r\n+  attribution: '¬© OpenStreetMap contributors, ¬© CARTO'\r\n+}).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n                   iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n"
                },
                {
                    "date": 1754927826128,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,12 +269,13 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {\r\n-  maxZoom: 19,\r\n-  attribution: '¬© OpenStreetMap contributors, ¬© CARTO'\r\n-}).addTo(map);\r\n+              L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {\r\n+                maxZoom: 20,\r\n+                subdomains: 'abcd',\r\n+                attribution: '¬© OpenStreetMap contributors, ¬© CARTO'\r\n+              }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n                   iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n"
                },
                {
                    "date": 1754928590387,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,12 +269,11 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/dataviz-dark/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n-                subdomains: 'abcd',\r\n-                attribution: '¬© OpenStreetMap contributors, ¬© CARTO'\r\n+                attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n               const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n                 icon: L.icon({\r\n"
                },
                {
                    "date": 1754928652305,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,9 +6,9 @@\n import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n import { useLocation } from \"../location/GlobalLocation\";\r\n import { router } from 'expo-router';\r\n import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL } from \"../../config\";\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n import * as Location from 'expo-location';\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n \r\n"
                },
                {
                    "date": 1754928726050,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/dataviz-dark/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/aquarelle/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928756920,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/aquarelle/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928798208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928812674,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928819260,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/aquarelle/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928839012,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/aquarelle/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928884381,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/outdoor/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928909764,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/outdoor/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928943587,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/dark_basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928953531,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/dark_basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928966731,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/nl_cartiqo/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1754928981125,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -269,9 +269,9 @@\n               }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n               L.control.zoom({ position: 'topleft' }).addTo(map);\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/nl_cartiqo/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n+              L.tileLayer('https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n                 maxZoom: 20,\r\n                 attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n               }).addTo(map);\r\n \r\n"
                },
                {
                    "date": 1756806438195,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,24 +14,22 @@\n \r\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  const BASE_FARE = 20;      // first 2 km\r\n-  const INCLUDED_KM = 2.99;\r\n-  const PER_KM = 5;          // succeeding km\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n \r\n-  const extraKm = Math.max(0, Math.ceil(distanceKm - INCLUDED_KM));\r\n-  let fare = BASE_FARE + extraKm * PER_KM;\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n \r\n-  if (distanceKm > INCLUDED_KM) {\r\n-    const extraKm = Math.floor(distanceKm - INCLUDED_KM); \r\n-    fare += extraKm * PER_KM;\r\n-  }\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n \r\n-  // 20% off for senior/student/PWD\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n   if (discount !== 'none') fare *= 0.8;\r\n \r\n-  return Math.round(fare); // nearest peso\r\n+  return Math.round(fare); \r\n };\r\n \r\n \r\n export default function PHome() {\r\n@@ -71,8 +69,9 @@\n   const [discount] = useState<DiscountType>('none'); \r\n   const [query, setQuery] = useState('');\r\n   const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n   const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n \r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n@@ -185,8 +184,94 @@\n       driver: null,\r\n     }));\r\n   };\r\n \r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      // fire once right away, so the dot appears even before watch ticks\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+      }\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          mapRef.current?.postMessage(JSON.stringify({\r\n+            type: \"updateUserLoc\",\r\n+            latitude: pos.coords.latitude,\r\n+            longitude: pos.coords.longitude,\r\n+            accuracy: pos.coords.accuracy ?? 15,\r\n+            avatarUrl,\r\n+          }));\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            mapRef.current?.postMessage(JSON.stringify({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            }));\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n   // ---------------------------------------------------------\r\n \r\n   // Reverse geocode for pick-up location\r\n   useEffect(() => {\r\n@@ -225,149 +310,209 @@\n     const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n     return () => backHandler.remove();\r\n   }, []);\r\n \r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n   // Generate map HTML when location changes\r\n   useEffect(() => {\r\n-    if (!location) return;\r\n+  if (!location) return;\r\n \r\n-    const html = `\r\n-      <!DOCTYPE html>\r\n-      <html>\r\n-        <head>\r\n-          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-          <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-          <style>\r\n-            html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-            .driver-label { font-weight: bold; color: red; background: white; padding: 2px 5px; border-radius: 4px; font-size: 14px; }\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        // --- Map init ---\r\n+        const map = L.map('map', { zoomControl:true })\r\n+          .setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n-            .distance-label.leaflet-tooltip {\r\n-              background: rgba(0,0,0,0.85);\r\n-              color: #fff;\r\n-              border: none;\r\n-              border-radius: 12px;\r\n-              padding: 4px 8px;\r\n-              box-shadow: 0 1px 4px rgba(0,0,0,0.3);\r\n-              font-size: 12px;\r\n-              line-height: 1;\r\n-              white-space: nowrap;\r\n-            }\r\n-            .distance-label.leaflet-tooltip:before { display: none; }\r\n-          </style>\r\n-        </head>\r\n-        <body>\r\n-          <div id=\"map\"></div>\r\n-          <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-          <script>\r\n-            let routeLine = null;\r\n-            let distanceTooltip = null;\r\n+        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n+        }).addTo(map);\r\n \r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n \r\n-            window.onload = function () {\r\n-              const map = L.map('map', {\r\n-                zoomControl: false, dragging: true, scrollWheelZoom: true,\r\n-                touchZoom: true, doubleClickZoom: true, boxZoom: true,\r\n-              }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n \r\n-              L.control.zoom({ position: 'topleft' }).addTo(map);\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n \r\n-              L.tileLayer('https://api.maptiler.com/maps/topo/{z}/{x}/{y}.png?key=${MAPTILER_KEY}', {\r\n-                maxZoom: 20,\r\n-                attribution: '¬© OpenStreetMap contributors, ¬© MapTiler'\r\n-              }).addTo(map);\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n \r\n-              const currentMarker = L.marker([${location.latitude}, ${location.longitude}], {\r\n-                icon: L.icon({\r\n-                  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-                  iconSize: [30, 30],\r\n-                })\r\n-              }).addTo(map).bindTooltip(\"You\", { permanent: true, direction: \"top\" });\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n \r\n-              let destMarker = null;\r\n-              let driverMarker = null;\r\n-              let destinationLocked = false;\r\n+        // --- Helpers ---\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip( { permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+        }\r\n \r\n-              map.on('click', function(e) {\r\n-                if (destinationLocked) return;\r\n-                const { lat, lng } = e.latlng;\r\n-                if (destMarker) map.removeLayer(destMarker);\r\n-                destMarker = L.marker([lat, lng], {\r\n-                  icon: L.icon({\r\n-                    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                    iconSize: [30, 30],\r\n-                  })\r\n-                }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-              });\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n \r\n-              document.addEventListener('message', function(event) {\r\n-                const msg = JSON.parse(event.data);\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n \r\n-                /* Draw route + distance label (expects: route, distanceText, durationText optional) */\r\n-                if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n-                  if (routeLine) map.removeLayer(routeLine);\r\n-                  if (distanceTooltip) map.removeLayer(distanceTooltip);\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n \r\n-                  routeLine = L.polyline(msg.route, { color: 'blue', weight: 4 }).addTo(map);\r\n-                  map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n \r\n-                  // midpoint of the route\r\n-                  const midIdx = Math.floor(msg.route.length / 2);\r\n-                  const mid = msg.route[midIdx]; // [lat, lng]\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n \r\n-                  const parts = [];\r\n-                  if (msg.distanceText) parts.push(msg.distanceText);\r\n-                  if (msg.durationText) parts.push(msg.durationText);\r\n-                  if (msg.fareText)     parts.push(msg.fareText);\r\n-                  const label = parts.join(' ‚Ä¢ ');\r\n-                  distanceTooltip = L.tooltip({permanent: true, direction: 'top', offset: [0, -6], className: 'distance-label'})\r\n-                    .setContent(label || '')\r\n-                    .setLatLng(mid)\r\n-                    .addTo(map);\r\n-                }\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            upsertUserMarker(msg.latitude, msg.longitude);\r\n+            return;\r\n+          }\r\n \r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n \r\n-                if (msg.type === 'setMarkers') {\r\n-                  destinationLocked = !!msg.driver;\r\n-                  if (destMarker) map.removeLayer(destMarker);\r\n-                  if (msg.destination) {\r\n-                    destMarker = L.marker([msg.destination.latitude, msg.destination.longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-                        iconSize: [30, 30],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"Destination\", { permanent: true, direction: \"top\" });\r\n-                  }\r\n-                  if (driverMarker) map.removeLayer(driverMarker);\r\n-                  if (msg.driver) {\r\n-                    const { latitude, longitude } = msg.driver;\r\n-                    L.circle([latitude, longitude], {\r\n-                      color: 'red', radius: 10, fillOpacity: 0.9\r\n-                    }).addTo(map);\r\n-                    driverMarker = L.marker([latitude, longitude], {\r\n-                      icon: L.icon({\r\n-                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-                        iconSize: [40, 40], iconAnchor: [20, 40],\r\n-                      })\r\n-                    }).addTo(map).bindTooltip(\"üöï Driver\", { permanent: true, direction: \"top\" })\r\n-                      .setZIndexOffset(1000);\r\n-                  }\r\n-                }\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+            clearRoute();\r\n \r\n-                if (msg.type === 'clearRoute') {\r\n-                  if (routeLine) { map.removeLayer(routeLine); routeLine = null; }\r\n-                  if (distanceTooltip) { map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-                  if (typeof distanceMarker !== 'undefined' && distanceMarker) {map.removeLayer(distanceMarker); distanceMarker = null;}\r\n-                }\r\n-              });\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n+              .setContent(label || '')\r\n+              .setLatLng(mid)\r\n+              .addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n             }\r\n-          </script>\r\n-        </body>\r\n-      </html>\r\n-    `;\r\n-    setMapHtml(html);\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n   }, [location]);\r\n \r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+  }, [mapHtml, location, avatarUrl]);\r\n+\r\n+\r\n   // Reverse geocode for drop-off location\r\n   const handleMapMessage = async (event: any) => {\r\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n@@ -407,54 +552,31 @@\n       fare, paymentMethod, notes, passengerId\r\n     };\r\n \r\n     try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n       setShowBookingForm(false);\r\n       setSearching(true);\r\n+\r\n       const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n         method: \"POST\",\r\n         headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify(bookingData),\r\n       });\r\n+\r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n       setBookingId(result.booking.id);\r\n-\r\n-      // poll for driver match\r\n-      const maxWaitTime = 10 * 60 * 1000;\r\n-      const startTime = Date.now();\r\n-      const poll = async () => {\r\n-        try {\r\n-          const [driverRes, statusRes] = await Promise.all([\r\n-            fetch(`${API_BASE_URL}/api/driver/${result.booking.driverId}`),\r\n-            fetch(`${API_BASE_URL}/api/driver-status/${result.booking.driverId}`)\r\n-          ]);\r\n-          const driverData = await driverRes.json();\r\n-          const statusData = await statusRes.json();\r\n-          if (driverData?.driver) {\r\n-            setMatchedDriver({\r\n-              driverName: driverData.driver.driverName,\r\n-              driverId: driverData.driver._id,\r\n-              franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-              experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-              selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-              location: statusData.location || null,\r\n-            });\r\n-            setSearching(false);\r\n-            return;\r\n-          }\r\n-        } catch {}\r\n-        if (Date.now() - startTime < maxWaitTime) {\r\n-          searchTimeoutRef.current = setTimeout(poll, 5000);\r\n-        } else {\r\n-          setSearching(false);\r\n-        }\r\n-      };\r\n-      poll();\r\n-    } catch {\r\n-      Alert.alert(\"Error\", \"Failed to send booking. Please try again.\");\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n+\r\n   };\r\n \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n@@ -497,19 +619,51 @@\n       try {\r\n         const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n         const allBookings = await res.json();\r\n         const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (myBooking && myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n           setBookingConfirmed(true);\r\n+          setSearching(false);\r\n           Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n         }\r\n       } catch {}\r\n     };\r\n     interval = setInterval(pollForDriverMatch, 4000);\r\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n   useEffect(() => {\r\n+    if (searching && (!bookingId || tripCompleted)) {\r\n+      setSearching(false);\r\n+    }\r\n+  }, [searching, bookingId, tripCompleted]);\r\n+\r\n+  useEffect(() => {\r\n     let interval: any;\r\n     const pollForBookingCompletion = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n@@ -522,19 +676,36 @@\n         if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n           setAlertedBookingComplete(true);\r\n           Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n \r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n           setBookingConfirmed(false);\r\n           setBookingId(null);\r\n           setMatchedDriver(null);\r\n           setDestination(null);\r\n           setShowBookingForm(false);\r\n           setTripCompleted(true);\r\n \r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n           mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n           mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n+\r\n           setFare(0);\r\n         }\r\n+\r\n       } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n     };\r\n     interval = setInterval(pollForBookingCompletion, 4000);\r\n     return () => clearInterval(interval);\r\n@@ -670,9 +841,9 @@\n               <View style={styles.searchWrap}>\r\n                 <TextInput\r\n                   value={query}\r\n                   onChangeText={onChangeQuery}\r\n-                  placeholder=\"Search destination (e.g., SM Lipa)\"\r\n+                  placeholder=\"Search destination (e.g., SM Lucena)\"\r\n                   placeholderTextColor=\"#777\"\r\n                   style={styles.searchInput}\r\n                 />\r\n                 {hits.length > 0 && (\r\n@@ -779,9 +950,9 @@\n \r\n             {showBookingForm && (\r\n               <View style={styles.panel}>\r\n                 <Text style={styles.panelTitle}>Booking Details</Text>\r\n-                <ScrollView style={styles.inputsContainer}>\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n                   <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n                   <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n                   <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n@@ -944,5 +1115,6 @@\n     position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n     width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n+  \r\n });\r\n"
                },
                {
                    "date": 1757088081568,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,8 +8,9 @@\n import { router } from 'expo-router';\r\n import AsyncStorage from '@react-native-async-storage/async-storage';\r\n import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n \r\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n"
                },
                {
                    "date": 1757088138284,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -71,8 +71,9 @@\n   const [query, setQuery] = useState('');\r\n   const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n   const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  \r\n \r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n"
                },
                {
                    "date": 1757327894114,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,10 +30,12 @@\n   if (discount !== 'none') fare *= 0.8;\r\n \r\n   return Math.round(fare); \r\n };\r\n+const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n \r\n \r\n+\r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n@@ -71,10 +73,20 @@\n   const [query, setQuery] = useState('');\r\n   const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n   const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n   \r\n+  useEffect(() => {\r\n+    AsyncStorage.getItem(\"passengerId\")\r\n+      .then((v) => setPassengerId(v))\r\n+      .catch(() => setPassengerId(null));\r\n+  }, []);\r\n \r\n+  const canShowChatNotice =\r\n+    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n@@ -576,11 +588,13 @@\n     } catch (e: any) {\r\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n-\r\n   };\r\n \r\n+  \r\n+  \r\n+\r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n \r\n@@ -835,8 +849,20 @@\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n+          {status === \"accepted\" && bookingId && (\r\n+            <ChatNotice\r\n+              bookingId={bookingId}\r\n+              role=\"passenger\"\r\n+              onGoToChat={() =>\r\n+                router.push({\r\n+                  pathname: \"/chat/phistory\",\r\n+                  query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+                })\r\n+              }\r\n+            />\r\n+          )}\r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n               {/* Destination search */}\r\n"
                },
                {
                    "date": 1757328036591,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -856,9 +856,9 @@\n               role=\"passenger\"\r\n               onGoToChat={() =>\r\n                 router.push({\r\n                   pathname: \"/chat/phistory\",\r\n-                  query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+                  params: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n                 })\r\n               }\r\n             />\r\n           )}\r\n"
                },
                {
                    "date": 1757329295643,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -855,9 +855,9 @@\n               bookingId={bookingId}\r\n               role=\"passenger\"\r\n               onGoToChat={() =>\r\n                 router.push({\r\n-                  pathname: \"/chat/phistory\",\r\n+                  pathname: \"/chat/chatroom\",\r\n                   params: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n                 })\r\n               }\r\n             />\r\n"
                },
                {
                    "date": 1757329381011,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -856,9 +856,14 @@\n               role=\"passenger\"\r\n               onGoToChat={() =>\r\n                 router.push({\r\n                   pathname: \"/chat/chatroom\",\r\n-                  params: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+                  params: {\r\n+                    bookingId,\r\n+                    driverId,\r\n+                    passengerId,\r\n+                    role: \"passenger\"\r\n+                  },\r\n                 })\r\n               }\r\n             />\r\n           )}\r\n"
                },
                {
                    "date": 1757329405552,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -854,15 +854,16 @@\n             <ChatNotice\r\n               bookingId={bookingId}\r\n               role=\"passenger\"\r\n               onGoToChat={() =>\r\n+                // Correct syntax for Expo Router\r\n                 router.push({\r\n                   pathname: \"/chat/chatroom\",\r\n                   params: {\r\n                     bookingId,\r\n                     driverId,\r\n                     passengerId,\r\n-                    role: \"passenger\"\r\n+                    role: \"passenger\",\r\n                   },\r\n                 })\r\n               }\r\n             />\r\n"
                },
                {
                    "date": 1757329616683,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -856,9 +856,9 @@\n               role=\"passenger\"\r\n               onGoToChat={() =>\r\n                 // Correct syntax for Expo Router\r\n                 router.push({\r\n-                  pathname: \"/chat/chatroom\",\r\n+                  pathname: \"/chat/[bookingId]\",\r\n                   params: {\r\n                     bookingId,\r\n                     driverId,\r\n                     passengerId,\r\n"
                },
                {
                    "date": 1757330121096,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -849,27 +849,33 @@\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n-          {status === \"accepted\" && bookingId && (\r\n-            <ChatNotice\r\n-              bookingId={bookingId}\r\n-              role=\"passenger\"\r\n-              onGoToChat={() =>\r\n-                // Correct syntax for Expo Router\r\n-                router.push({\r\n-                  pathname: \"/chat/[bookingId]\",\r\n-                  params: {\r\n-                    bookingId,\r\n-                    driverId,\r\n-                    passengerId,\r\n-                    role: \"passenger\",\r\n-                  },\r\n-                })\r\n-              }\r\n-            />\r\n+          {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+            <View style={styles.chatNotice}>\r\n+              <Text style={styles.chatText}>\r\n+                ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+              </Text>\r\n+              <Text\r\n+                style={styles.chatLink}\r\n+                onPress={() =>\r\n+                  router.push({\r\n+                    pathname: `/chat/${bookingId}`,\r\n+                    params: {\r\n+                      bookingId,\r\n+                      driverId: matchedDriver.driverId,\r\n+                      passengerId,\r\n+                      role: \"passenger\",\r\n+                    },\r\n+                  })\r\n+                }\r\n+              >\r\n+                üëâ Pumunta sa Chat\r\n+              </Text>\r\n+            </View>\r\n           )}\r\n \r\n+\r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n               {/* Destination search */}\r\n               <View style={styles.searchWrap}>\r\n"
                },
                {
                    "date": 1757330136217,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1155,6 +1155,25 @@\n     position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n     width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n+    chatNotice: {\r\n+    backgroundColor: \"#f1f1f1\",\r\n+    padding: 12,\r\n+    margin: 10,\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+  },\r\n+  chatText: {\r\n+    fontSize: 14,\r\n+    color: \"#333\",\r\n+    marginBottom: 6,\r\n+  },\r\n+  chatLink: {\r\n+    fontSize: 15,\r\n+    fontWeight: \"bold\",\r\n+    color: \"#007bff\",\r\n+  },\r\n+\r\n   \r\n });\r\n"
                },
                {
                    "date": 1757330204204,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -858,9 +858,9 @@\n               <Text\r\n                 style={styles.chatLink}\r\n                 onPress={() =>\r\n                   router.push({\r\n-                    pathname: `/chat/${bookingId}`,\r\n+                    pathname: `/chat/[bookingId]`,\r\n                     params: {\r\n                       bookingId,\r\n                       driverId: matchedDriver.driverId,\r\n                       passengerId,\r\n"
                },
                {
                    "date": 1757330252167,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -858,9 +858,9 @@\n               <Text\r\n                 style={styles.chatLink}\r\n                 onPress={() =>\r\n                   router.push({\r\n-                    pathname: `/chat/[bookingId]`,\r\n+                    pathname: \"/chat/[bookingId]\",\r\n                     params: {\r\n                       bookingId,\r\n                       driverId: matchedDriver.driverId,\r\n                       passengerId,\r\n"
                },
                {
                    "date": 1757330626216,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -850,8 +850,9 @@\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n           {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+            console.log('accepted'),\r\n             <View style={styles.chatNotice}>\r\n               <Text style={styles.chatText}>\r\n                 ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n               </Text>\r\n"
                },
                {
                    "date": 1757330745529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -590,11 +590,32 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-  \r\n-  \r\n-\r\n+  {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+    console.log('accepted'),\r\n+    <View style={styles.chatNotice}>\r\n+      <Text style={styles.chatText}>\r\n+        ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+      </Text>\r\n+      <Text\r\n+        style={styles.chatLink}\r\n+        onPress={() =>\r\n+          router.push({\r\n+            pathname: \"/chat/[bookingId]\",\r\n+            params: {\r\n+              bookingId,\r\n+              driverId: matchedDriver.driverId,\r\n+              passengerId,\r\n+              role: \"passenger\",\r\n+            },\r\n+          })\r\n+        }\r\n+      >\r\n+        üëâ Pumunta sa Chat\r\n+      </Text>\r\n+    </View>\r\n+  )}\r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n \r\n@@ -849,32 +870,9 @@\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n-          {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-            console.log('accepted'),\r\n-            <View style={styles.chatNotice}>\r\n-              <Text style={styles.chatText}>\r\n-                ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-              </Text>\r\n-              <Text\r\n-                style={styles.chatLink}\r\n-                onPress={() =>\r\n-                  router.push({\r\n-                    pathname: \"/chat/[bookingId]\",\r\n-                    params: {\r\n-                      bookingId,\r\n-                      driverId: matchedDriver.driverId,\r\n-                      passengerId,\r\n-                      role: \"passenger\",\r\n-                    },\r\n-                  })\r\n-                }\r\n-              >\r\n-                üëâ Pumunta sa Chat\r\n-              </Text>\r\n-            </View>\r\n-          )}\r\n+          \r\n \r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n"
                },
                {
                    "date": 1757330756562,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -614,8 +614,9 @@\n         üëâ Pumunta sa Chat\r\n       </Text>\r\n     </View>\r\n   )}\r\n+  \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n \r\n"
                },
                {
                    "date": 1757330766985,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -610,13 +610,13 @@\n             },\r\n           })\r\n         }\r\n       >\r\n-        üëâ Pumunta sa Chat\r\n+        üëâ Pumunta sa Chat page\r\n       </Text>\r\n     </View>\r\n   )}\r\n-  \r\n+\r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n \r\n"
                },
                {
                    "date": 1757330842490,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -589,8 +589,13 @@\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n+  {status === \"accepted\" && bookingId && (\r\n+    <View style={{ padding: 10, backgroundColor: \"orange\" }}>\r\n+      <Text>‚úÖ Chat available! bookingId: {bookingId}</Text>\r\n+    </View>\r\n+  )}\r\n \r\n   {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n     console.log('accepted'),\r\n     <View style={styles.chatNotice}>\r\n"
                },
                {
                    "date": 1757330855657,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -595,32 +595,32 @@\n       <Text>‚úÖ Chat available! bookingId: {bookingId}</Text>\r\n     </View>\r\n   )}\r\n \r\n-  {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-    console.log('accepted'),\r\n-    <View style={styles.chatNotice}>\r\n-      <Text style={styles.chatText}>\r\n-        ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-      </Text>\r\n-      <Text\r\n-        style={styles.chatLink}\r\n-        onPress={() =>\r\n-          router.push({\r\n-            pathname: \"/chat/[bookingId]\",\r\n-            params: {\r\n-              bookingId,\r\n-              driverId: matchedDriver.driverId,\r\n-              passengerId,\r\n-              role: \"passenger\",\r\n-            },\r\n-          })\r\n-        }\r\n-      >\r\n-        üëâ Pumunta sa Chat page\r\n-      </Text>\r\n-    </View>\r\n-  )}\r\n+  // {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+  //   console.log('accepted'),\r\n+  //   <View style={styles.chatNotice}>\r\n+  //     <Text style={styles.chatText}>\r\n+  //       ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+  //     </Text>\r\n+  //     <Text\r\n+  //       style={styles.chatLink}\r\n+  //       onPress={() =>\r\n+  //         router.push({\r\n+  //           pathname: \"/chat/[bookingId]\",\r\n+  //           params: {\r\n+  //             bookingId,\r\n+  //             driverId: matchedDriver.driverId,\r\n+  //             passengerId,\r\n+  //             role: \"passenger\",\r\n+  //           },\r\n+  //         })\r\n+  //       }\r\n+  //     >\r\n+  //       üëâ Pumunta sa Chat page\r\n+  //     </Text>\r\n+  //   </View>\r\n+  // )}\r\n \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n"
                },
                {
                    "date": 1757330990893,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -589,39 +589,34 @@\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n-  {status === \"accepted\" && bookingId && (\r\n-    <View style={{ padding: 10, backgroundColor: \"orange\" }}>\r\n-      <Text>‚úÖ Chat available! bookingId: {bookingId}</Text>\r\n+\r\n+  {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+    console.log('accepted'),\r\n+    <View style={styles.chatNotice}>\r\n+      <Text style={styles.chatText}>\r\n+        ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+      </Text>\r\n+      <Text\r\n+        style={styles.chatLink}\r\n+        onPress={() =>\r\n+          router.push({\r\n+            pathname: \"/chat/[bookingId]\",\r\n+            params: {\r\n+              bookingId,\r\n+              driverId: matchedDriver.driverId,\r\n+              passengerId,\r\n+              role: \"passenger\",\r\n+            },\r\n+          })\r\n+        }\r\n+      >\r\n+        üëâ Pumunta sa Chat page\r\n+      </Text>\r\n     </View>\r\n   )}\r\n \r\n-  // {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-  //   console.log('accepted'),\r\n-  //   <View style={styles.chatNotice}>\r\n-  //     <Text style={styles.chatText}>\r\n-  //       ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-  //     </Text>\r\n-  //     <Text\r\n-  //       style={styles.chatLink}\r\n-  //       onPress={() =>\r\n-  //         router.push({\r\n-  //           pathname: \"/chat/[bookingId]\",\r\n-  //           params: {\r\n-  //             bookingId,\r\n-  //             driverId: matchedDriver.driverId,\r\n-  //             passengerId,\r\n-  //             role: \"passenger\",\r\n-  //           },\r\n-  //         })\r\n-  //       }\r\n-  //     >\r\n-  //       üëâ Pumunta sa Chat page\r\n-  //     </Text>\r\n-  //   </View>\r\n-  // )}\r\n-\r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n \r\n"
                },
                {
                    "date": 1757331054828,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -610,9 +610,9 @@\n             },\r\n           })\r\n         }\r\n       >\r\n-        üëâ Pumunta sa Chat page\r\n+        üëâ Pumunta sa Chat\r\n       </Text>\r\n     </View>\r\n   )}\r\n \r\n"
                },
                {
                    "date": 1757331152449,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -591,9 +591,8 @@\n     }\r\n   };\r\n \r\n   {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-    console.log('accepted'),\r\n     <View style={styles.chatNotice}>\r\n       <Text style={styles.chatText}>\r\n         ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n       </Text>\r\n"
                },
                {
                    "date": 1757331265361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -662,9 +662,8 @@\n \r\n         if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n           setBookingConfirmed(true);\r\n           setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n \r\n           if (myBooking.driverId) {\r\n             try {\r\n               const [driverRes, statusRes] = await Promise.all([\r\n"
                },
                {
                    "date": 1757331421533,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -421,9 +421,9 @@\n         function setDestination(lat, lng){\r\n           if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n           destMarker = L.marker([lat,lng], { icon: destIcon })\r\n             .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+            .bindTooltip({ permanent:true, direction:\"top\" });\r\n         }\r\n \r\n         function setDriver(lat, lng){\r\n           if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n"
                },
                {
                    "date": 1757331427754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -421,9 +421,9 @@\n         function setDestination(lat, lng){\r\n           if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n           destMarker = L.marker([lat,lng], { icon: destIcon })\r\n             .addTo(map)\r\n-            .bindTooltip({ permanent:true, direction:\"top\" });\r\n+            .bindTooltip(\"\", { permanent:true, direction:\"top\" });\r\n         }\r\n \r\n         function setDriver(lat, lng){\r\n           if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n"
                },
                {
                    "date": 1757331472170,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -590,31 +590,31 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-  {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-    <View style={styles.chatNotice}>\r\n-      <Text style={styles.chatText}>\r\n-        ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-      </Text>\r\n-      <Text\r\n-        style={styles.chatLink}\r\n-        onPress={() =>\r\n-          router.push({\r\n-            pathname: \"/chat/[bookingId]\",\r\n-            params: {\r\n-              bookingId,\r\n-              driverId: matchedDriver.driverId,\r\n-              passengerId,\r\n-              role: \"passenger\",\r\n-            },\r\n-          })\r\n-        }\r\n-      >\r\n-        üëâ Pumunta sa Chat\r\n-      </Text>\r\n-    </View>\r\n-  )}\r\n+  // {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+  //   <View style={styles.chatNotice}>\r\n+  //     <Text style={styles.chatText}>\r\n+  //       ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+  //     </Text>\r\n+  //     <Text\r\n+  //       style={styles.chatLink}\r\n+  //       onPress={() =>\r\n+  //         router.push({\r\n+  //           pathname: \"/chat/[bookingId]\",\r\n+  //           params: {\r\n+  //             bookingId,\r\n+  //             driverId: matchedDriver.driverId,\r\n+  //             passengerId,\r\n+  //             role: \"passenger\",\r\n+  //           },\r\n+  //         })\r\n+  //       }\r\n+  //     >\r\n+  //       üëâ Pumunta sa Chat\r\n+  //     </Text>\r\n+  //   </View>\r\n+  // )}\r\n \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n"
                },
                {
                    "date": 1757333858559,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -421,9 +421,9 @@\n         function setDestination(lat, lng){\r\n           if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n           destMarker = L.marker([lat,lng], { icon: destIcon })\r\n             .addTo(map)\r\n-            .bindTooltip(\"\", { permanent:true, direction:\"top\" });\r\n+            .bindTooltip({ permanent:true, direction:\"top\" });\r\n         }\r\n \r\n         function setDriver(lat, lng){\r\n           if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n"
                },
                {
                    "date": 1757333960785,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -590,31 +590,31 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-  // {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-  //   <View style={styles.chatNotice}>\r\n-  //     <Text style={styles.chatText}>\r\n-  //       ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-  //     </Text>\r\n-  //     <Text\r\n-  //       style={styles.chatLink}\r\n-  //       onPress={() =>\r\n-  //         router.push({\r\n-  //           pathname: \"/chat/[bookingId]\",\r\n-  //           params: {\r\n-  //             bookingId,\r\n-  //             driverId: matchedDriver.driverId,\r\n-  //             passengerId,\r\n-  //             role: \"passenger\",\r\n-  //           },\r\n-  //         })\r\n-  //       }\r\n-  //     >\r\n-  //       üëâ Pumunta sa Chat\r\n-  //     </Text>\r\n-  //   </View>\r\n-  // )}\r\n+  {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+    <View style={styles.chatNotice}>\r\n+      <Text style={styles.chatText}>\r\n+        ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+      </Text>\r\n+      <Text\r\n+        style={styles.chatLink}\r\n+        onPress={() =>\r\n+          router.push({\r\n+            pathname: \"/chat/[bookingId]\",\r\n+            params: {\r\n+              bookingId,\r\n+              driverId: matchedDriver.driverId,\r\n+              passengerId,\r\n+              role: \"passenger\",\r\n+            },\r\n+          })\r\n+        }\r\n+      >\r\n+        üëâ Pumunta sa Chat\r\n+      </Text>\r\n+    </View>\r\n+  )}\r\n \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n"
                },
                {
                    "date": 1757334222919,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -598,17 +598,9 @@\n       </Text>\r\n       <Text\r\n         style={styles.chatLink}\r\n         onPress={() =>\r\n-          router.push({\r\n-            pathname: \"/chat/[bookingId]\",\r\n-            params: {\r\n-              bookingId,\r\n-              driverId: matchedDriver.driverId,\r\n-              passengerId,\r\n-              role: \"passenger\",\r\n-            },\r\n-          })\r\n+          router.push(`/chat/${bookingId}?driverId=${driverId}&passengerId=${passengerId}&role=passenger`)\r\n         }\r\n       >\r\n         üëâ Pumunta sa Chat\r\n       </Text>\r\n"
                },
                {
                    "date": 1757360809694,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -590,23 +590,23 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-  {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-    <View style={styles.chatNotice}>\r\n-      <Text style={styles.chatText}>\r\n-        ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-      </Text>\r\n-      <Text\r\n-        style={styles.chatLink}\r\n-        onPress={() =>\r\n-          router.push(`/chat/${bookingId}?driverId=${driverId}&passengerId=${passengerId}&role=passenger`)\r\n-        }\r\n-      >\r\n-        üëâ Pumunta sa Chat\r\n-      </Text>\r\n-    </View>\r\n-  )}\r\n+  // {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n+  //   <View style={styles.chatNotice}>\r\n+  //     <Text style={styles.chatText}>\r\n+  //       ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n+  //     </Text>\r\n+  //     <Text\r\n+  //       style={styles.chatLink}\r\n+  //       onPress={() =>\r\n+  //         router.push(`/chat/${bookingId}?driverId=${driverId}&passengerId=${passengerId}&role=passenger`)\r\n+  //       }\r\n+  //     >\r\n+  //       üëâ Pumunta sa Chat\r\n+  //     </Text>\r\n+  //   </View>\r\n+  // )}\r\n \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n"
                },
                {
                    "date": 1757361415804,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1077,9 +1077,9 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlayContainer: { position: \"absolute\", width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n"
                },
                {
                    "date": 1757361448843,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1077,9 +1077,9 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlayContainer: { position: \"fixed\", width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n"
                },
                {
                    "date": 1757361589337,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1077,9 +1077,9 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"fixed\", width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlayContainer: { position: \"absolute\", width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n"
                },
                {
                    "date": 1757361610297,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1077,9 +1077,9 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlayContainer: { position: \"absolute\", top: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n"
                },
                {
                    "date": 1757361649787,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -867,30 +867,8 @@\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n               {/* Destination search */}\r\n-              <View style={styles.searchWrap}>\r\n-                <TextInput\r\n-                  value={query}\r\n-                  onChangeText={onChangeQuery}\r\n-                  placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                  placeholderTextColor=\"#777\"\r\n-                  style={styles.searchInput}\r\n-                />\r\n-                {hits.length > 0 && (\r\n-                  <View style={styles.searchResults}>\r\n-                    {hits.map((h, i) => (\r\n-                      <TouchableOpacity\r\n-                        key={`${h.lat},${h.lon}-${i}`}\r\n-                        onPress={() => choosePlace(h)}\r\n-                        style={styles.searchItem}\r\n-                      >\r\n-                        <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-                )}\r\n-              </View>\r\n \r\n               {searching && (\r\n                 <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n"
                },
                {
                    "date": 1757361663266,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -866,9 +866,8 @@\n \r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n-              {/* Destination search */}\r\n \r\n               {searching && (\r\n                 <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n"
                },
                {
                    "date": 1757361775902,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1054,9 +1054,9 @@\n }\r\n \r\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", top: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n"
                },
                {
                    "date": 1757361893739,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -861,8 +861,33 @@\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n+          <View>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lon}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+          </View>\r\n           \r\n \r\n \r\n           <View style={styles.overlayContainer}>\r\n"
                },
                {
                    "date": 1757361937731,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -421,9 +421,9 @@\n         function setDestination(lat, lng){\r\n           if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n           destMarker = L.marker([lat,lng], { icon: destIcon })\r\n             .addTo(map)\r\n-            .bindTooltip({ permanent:true, direction:\"top\" });\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n         }\r\n \r\n         function setDriver(lat, lng){\r\n           if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n@@ -590,23 +590,10 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n-  // {status === \"accepted\" && bookingId && matchedDriver?.driverId && passengerId && (\r\n-  //   <View style={styles.chatNotice}>\r\n-  //     <Text style={styles.chatText}>\r\n-  //       ‚úÖ Nakahanap ka na ng driver! Maaari mo siyang makausap kung nais mo linawin ang iyong lokasyon.\r\n-  //     </Text>\r\n-  //     <Text\r\n-  //       style={styles.chatLink}\r\n-  //       onPress={() =>\r\n-  //         router.push(`/chat/${bookingId}?driverId=${driverId}&passengerId=${passengerId}&role=passenger`)\r\n-  //       }\r\n-  //     >\r\n-  //       üëâ Pumunta sa Chat\r\n-  //     </Text>\r\n-  //   </View>\r\n-  // )}\r\n+  \r\n+  \r\n \r\n   // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n     if (!mapRef.current || bookingConfirmed) return;\r\n@@ -654,8 +641,9 @@\n \r\n         if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n           setBookingConfirmed(true);\r\n           setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n \r\n           if (myBooking.driverId) {\r\n             try {\r\n               const [driverRes, statusRes] = await Promise.all([\r\n@@ -861,38 +849,46 @@\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n-          <View>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lon}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-          </View>\r\n-          \r\n+          {/* {status === \"accepted\" && bookingId && (\r\n+            <ChatNotice\r\n+              bookingId={bookingId}\r\n+              role=\"passenger\"\r\n+              onGoToChat={() =>\r\n+                router.push({\r\n+                  pathname: \"/chatcomponent\",\r\n+                  query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+                })\r\n+              }\r\n+            />\r\n+          )} */}\r\n \r\n-\r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n+              {/* Destination search */}\r\n+              <View style={styles.searchWrap}>\r\n+                <TextInput\r\n+                  value={query}\r\n+                  onChangeText={onChangeQuery}\r\n+                  placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                  placeholderTextColor=\"#777\"\r\n+                  style={styles.searchInput}\r\n+                />\r\n+                {hits.length > 0 && (\r\n+                  <View style={styles.searchResults}>\r\n+                    {hits.map((h, i) => (\r\n+                      <TouchableOpacity\r\n+                        key={`${h.lat},${h.lon}-${i}`}\r\n+                        onPress={() => choosePlace(h)}\r\n+                        style={styles.searchItem}\r\n+                      >\r\n+                        <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+                )}\r\n+              </View>\r\n \r\n               {searching && (\r\n                 <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n@@ -1147,25 +1143,6 @@\n     position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n     width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n-    chatNotice: {\r\n-    backgroundColor: \"#f1f1f1\",\r\n-    padding: 12,\r\n-    margin: 10,\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n-  },\r\n-  chatText: {\r\n-    fontSize: 14,\r\n-    color: \"#333\",\r\n-    marginBottom: 6,\r\n-  },\r\n-  chatLink: {\r\n-    fontSize: 15,\r\n-    fontWeight: \"bold\",\r\n-    color: \"#007bff\",\r\n-  },\r\n-\r\n   \r\n });\r\n"
                },
                {
                    "date": 1757361977600,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -589,8 +589,20 @@\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n \r\n   \r\n   \r\n \r\n@@ -849,20 +861,8 @@\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n-          {/* {status === \"accepted\" && bookingId && (\r\n-            <ChatNotice\r\n-              bookingId={bookingId}\r\n-              role=\"passenger\"\r\n-              onGoToChat={() =>\r\n-                router.push({\r\n-                  pathname: \"/chatcomponent\",\r\n-                  query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-                })\r\n-              }\r\n-            />\r\n-          )} */}\r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n               {/* Destination search */}\r\n"
                },
                {
                    "date": 1757362039493,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -30,9 +30,8 @@\n   if (discount !== 'none') fare *= 0.8;\r\n \r\n   return Math.round(fare); \r\n };\r\n-const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n \r\n \r\n \r\n export default function PHome() {\r\n"
                },
                {
                    "date": 1757362056762,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,8 +33,9 @@\n };\r\n \r\n \r\n \r\n+\r\n export default function PHome() {\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n@@ -72,8 +73,9 @@\n   const [query, setQuery] = useState('');\r\n   const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n   const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n   const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n   const driverId = currentBooking?.driverId;\r\n   const [passengerId, setPassengerId] = useState<string | null>(null);\r\n   \r\n"
                },
                {
                    "date": 1757362159729,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -863,33 +863,36 @@\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n \r\n+          <View>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lon}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+          </View>\r\n+\r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n-              {/* Destination search */}\r\n-              <View style={styles.searchWrap}>\r\n-                <TextInput\r\n-                  value={query}\r\n-                  onChangeText={onChangeQuery}\r\n-                  placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                  placeholderTextColor=\"#777\"\r\n-                  style={styles.searchInput}\r\n-                />\r\n-                {hits.length > 0 && (\r\n-                  <View style={styles.searchResults}>\r\n-                    {hits.map((h, i) => (\r\n-                      <TouchableOpacity\r\n-                        key={`${h.lat},${h.lon}-${i}`}\r\n-                        onPress={() => choosePlace(h)}\r\n-                        style={styles.searchItem}\r\n-                      >\r\n-                        <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-                )}\r\n-              </View>\r\n \r\n               {searching && (\r\n                 <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n                   <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n"
                },
                {
                    "date": 1757362211865,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -863,9 +863,9 @@\n               nestedScrollEnabled\r\n             />\r\n           )}\r\n \r\n-          <View>\r\n+          <View style={styles.searchcont}>\r\n             {/* Destination search */}\r\n             <View style={styles.searchWrap}>\r\n               <TextInput\r\n                 value={query}\r\n@@ -1081,8 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 0,}\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362225477,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 0,}\r\n+  searchcont: {position: \"absolute\", top: 10,},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362243991,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 10,},\r\n+  searchcont: {position: \"absolute\", top: 10, margin:10, },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362253994,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 10, margin:10, },\r\n+  searchcont: {position: \"absolute\", top: 50, margin:10, },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362271575,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, margin:10, },\r\n+  searchcont: {position: \"absolute\", top: 50, margin:10, width: \"100%\"},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362281503,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, margin:10, width: \"100%\"},\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"100%\", },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362296114,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"100%\", },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\" },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362305053,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\" },\r\n+  searchcont: {position: \"absolute\", top: 100, width: \"100%\", alignItems: \"center\" },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362312396,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 100, width: \"100%\", alignItems: \"center\" },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\" },\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362394282,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\" },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\", marginLeft: 10},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362402348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\", marginLeft: 10},\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\", marginLeft: 20},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362414393,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"100%\", alignItems: \"center\", marginLeft: 20},\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"80%\", alignItems: \"center\", marginLeft: 30},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362420115,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"80%\", alignItems: \"center\", marginLeft: 30},\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 30},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362448372,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1081,9 +1081,9 @@\n const styles = StyleSheet.create({\r\n   container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n   overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n   overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 30},\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n   searchWrap: {\r\n     width: '90%',\r\n     alignSelf: 'center',\r\n     zIndex: 20,            // stay above map\r\n"
                },
                {
                    "date": 1757362581555,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -554,8 +554,9 @@\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n+    setSearching(true)\r\n     setAlertedBookingComplete(false);\r\n     setTripCompleted(false);\r\n \r\n     const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n"
                },
                {
                    "date": 1757362751538,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -931,17 +931,44 @@\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n                         {matchedDriver.selfieImage && (\r\n-                          <Image source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }} style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }} />\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{\r\n+                              width: 50,\r\n+                              height: 50,\r\n+                              borderRadius: 25,\r\n+                              marginRight: 10,\r\n+                            }}\r\n+                          />\r\n                         )}\r\n-                        <View style={{ flex: 1}}>\r\n+                        <View style={{ flex: 1 }}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver.driverName}</Text>\r\n                           <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          {/* Chat button here */}\r\n+                          <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              // üëá navigate to chat screen or open chat modal\r\n+                              navigation.navigate(\"ChatScreen\", { driverId: matchedDriver._id });\r\n+                            }}\r\n+                            style={{\r\n+                              marginTop: 8,\r\n+                              backgroundColor: \"#007bff\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 16,\r\n+                              borderRadius: 8,\r\n+                              alignSelf: \"flex-start\",\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                          </TouchableOpacity>\r\n                         </View>\r\n                       </View>\r\n+\r\n                       <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n                         <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n"
                },
                {
                    "date": 1757362812886,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -950,10 +950,9 @@\n \r\n                           {/* Chat button here */}\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n-                              // üëá navigate to chat screen or open chat modal\r\n-                              navigation.navigate(\"ChatScreen\", { driverId: matchedDriver._id });\r\n+                              navigation.navigate(\"ChatScreen\", { driverId: matchedDriver.driverId });\r\n                             }}\r\n                             style={{\r\n                               marginTop: 8,\r\n                               backgroundColor: \"#007bff\",\r\n"
                },
                {
                    "date": 1757362889151,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,9 +9,11 @@\n import AsyncStorage from '@react-native-async-storage/async-storage';\r\n import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n import * as Location from 'expo-location';\r\n import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n \r\n+\r\n const { width } = Dimensions.get(\"window\");\r\n \r\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n@@ -70,8 +72,9 @@\n   const [dropoffName, setDropoffName] = useState(\"\");\r\n   const [showDropdown, setShowDropdown] = useState(false);\r\n   const [discount] = useState<DiscountType>('none'); \r\n   const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n   const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n   const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n   const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n"
                },
                {
                    "date": 1757362949155,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -953,9 +953,9 @@\n \r\n                           {/* Chat button here */}\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n-                              navigation.navigate(\"ChatScreen\", { driverId: matchedDriver.driverId });\r\n+                              navigation.navigate(\"ChatRoom\", { driverId: matchedDriver.driverId });\r\n                             }}\r\n                             style={{\r\n                               marginTop: 8,\r\n                               backgroundColor: \"#007bff\",\r\n"
                },
                {
                    "date": 1757363344572,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -953,9 +953,17 @@\n \r\n                           {/* Chat button here */}\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n-                              navigation.navigate(\"ChatRoom\", { driverId: matchedDriver.driverId });\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId: bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId: passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n                             }}\r\n                             style={{\r\n                               marginTop: 8,\r\n                               backgroundColor: \"#007bff\",\r\n"
                },
                {
                    "date": 1760604837928,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,10 +10,37 @@\n import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n import * as Location from 'expo-location';\r\n import ChatNotice from \"../../components/ChatNotice\";\r\n import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n \r\n \r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n const { width } = Dimensions.get(\"window\");\r\n \r\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n@@ -73,22 +100,91 @@\n   const [showDropdown, setShowDropdown] = useState(false);\r\n   const [discount] = useState<DiscountType>('none'); \r\n   const [query, setQuery] = useState('');\r\n   const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lon: number }>>([]);\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n   const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n   const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n   const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n   const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n   const driverId = currentBooking?.driverId;\r\n   const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+\r\n   \r\n   useEffect(() => {\r\n-    AsyncStorage.getItem(\"passengerId\")\r\n-      .then((v) => setPassengerId(v))\r\n-      .catch(() => setPassengerId(null));\r\n+    (async () => {\r\n+      try {\r\n+        // 1) prefer unified auth\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n   }, []);\r\n \r\n+\r\n   const canShowChatNotice =\r\n     bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n@@ -132,16 +228,16 @@\n       const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n       const fareText = `‚Ç±${computedFare} est`;\r\n       setFare(computedFare);\r\n \r\n-      mapRef.current?.postMessage(JSON.stringify({\r\n+      sendToMap({\r\n         type: 'drawRoute',\r\n         route: polylinePoints,\r\n         distanceKm, \r\n         distanceText,     \r\n         durationText,\r\n         fareText,  \r\n-      }));\r\n+      });\r\n \r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n       Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n@@ -153,16 +249,14 @@\n \r\n     if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n     searchTimerRef.current = setTimeout(async () => {\r\n       if (!t || t.length < 3) { setHits([]); return; }\r\n-\r\n-      // bail if we don‚Äôt have the user‚Äôs location yet\r\n       if (!location) { setHits([]); return; }\r\n \r\n       try {\r\n         const lat = location.latitude;\r\n-        const lon = location.longitude;\r\n-        const url = `${API_BASE_URL}/api/geocode?q=${encodeURIComponent(t)}&lat=${lat}&lon=${lon}`;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n         const r = await fetch(url);\r\n         const data = await r.json();\r\n         setHits(Array.isArray(data) ? data : []);\r\n       } catch {\r\n@@ -171,14 +265,15 @@\n     }, 300);\r\n   };\r\n \r\n \r\n+\r\n   // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lon: number }) => {\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n     setQuery(p.label);\r\n     setHits([]);\r\n \r\n-    const dest = { latitude: p.lat, longitude: p.lon };\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n \r\n     // update UI\r\n     setDestination(dest);\r\n     setDropoffName(p.label);\r\n@@ -195,13 +290,13 @@\n       dest\r\n     );\r\n \r\n     // (optional) update markers\r\n-    mapRef.current?.postMessage(JSON.stringify({\r\n+    sendToMap({\r\n       type: 'setMarkers',\r\n       destination: dest,\r\n       driver: null,\r\n-    }));\r\n+    });\r\n   };\r\n \r\n   useEffect(() => {\r\n     (async () => {\r\n@@ -247,15 +342,15 @@\n           timeInterval: 5000,\r\n           distanceInterval: 5,\r\n         },\r\n         (pos) => {\r\n-          mapRef.current?.postMessage(JSON.stringify({\r\n+          sendToMap({\r\n             type: \"updateUserLoc\",\r\n             latitude: pos.coords.latitude,\r\n             longitude: pos.coords.longitude,\r\n             accuracy: pos.coords.accuracy ?? 15,\r\n             avatarUrl,\r\n-          }));\r\n+          });\r\n         }\r\n       );\r\n     })();\r\n \r\n@@ -271,12 +366,12 @@\n           const bearing =\r\n             Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n             (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n           if (bearing !== null) {\r\n-            mapRef.current?.postMessage(JSON.stringify({\r\n+            sendToMap({\r\n               type: \"updateHeading\",\r\n               bearingDeg: bearing,\r\n-            }));\r\n+            });\r\n           }\r\n         });\r\n       } catch {\r\n         // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n@@ -310,25 +405,25 @@\n     }\r\n   }, [location]);\r\n \r\n   // Handle Android hardware back button (logout prompt)\r\n-  useEffect(() => {\r\n-    const backAction = () => {\r\n-      Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-        { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-        {\r\n-          text: \"Logout\",\r\n-          onPress: async () => {\r\n-            await AsyncStorage.removeItem(\"passengerId\");\r\n-            router.replace(\"/login_and_reg/plogin\");\r\n-          },\r\n-        },\r\n-      ]);\r\n-      return true;\r\n-    };\r\n-    const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-    return () => backHandler.remove();\r\n-  }, []);\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n \r\n   useEffect(() => {\r\n     (async () => {\r\n       try {\r\n@@ -352,8 +447,9 @@\n \r\n   // Generate map HTML when location changes\r\n   useEffect(() => {\r\n   if (!location) return;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n \r\n   const html = String.raw`\r\n   <!DOCTYPE html>\r\n   <html>\r\n@@ -374,11 +470,18 @@\n       <div id=\"map\"></div>\r\n       <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n       <script>\r\n         // --- Map init ---\r\n-        const map = L.map('map', { zoomControl:true })\r\n-          .setView([${location.latitude}, ${location.longitude}], 15);\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 20, \r\n+          noWrap: true\r\n+        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n+\r\n         L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n           maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n         }).addTo(map);\r\n \r\n@@ -390,8 +493,25 @@\n \r\n         let routeLine = null;        // drawn polyline\r\n         let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n \r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(),\r\n+              minLat: b.getSouth(),\r\n+              maxLng: b.getEast(),\r\n+              maxLat: b.getNorth()\r\n+            }\r\n+          }));\r\n+        })();\r\n+\r\n+\r\n         // --- Icons ---\r\n         const userIcon = L.icon({\r\n           iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n           iconSize: [30, 30],\r\n@@ -451,8 +571,20 @@\n           setDestination(lat, lng);\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n         });\r\n \r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const z = map.getZoom();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: { minLng: b.getWest(), minLat: b.getSouth(), maxLng: b.getEast(), maxLat: b.getNorth() },\r\n+            zoom: z,\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n         // --- Message bridge ---\r\n         document.addEventListener('message', function(event){\r\n           let msg = {};\r\n           try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n@@ -507,15 +639,80 @@\n             }\r\n \r\n             return;\r\n           }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            poiLayer.clearLayers();\r\n+\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+\r\n+              // choose icon: use local base64 if present, else fallback CDN\r\n+              const iconUrl = (poiIcons[it.category] && poiIcons[it.category].includes('base64,'))\r\n+                ? poiIcons[it.category]\r\n+                : 'https://cdn-icons-png.flaticon.com/512/854/854878.png';\r\n+\r\n+              const icon = L.icon({\r\n+                iconUrl,\r\n+                iconSize: [28, 28],\r\n+                iconAnchor: [14, 28],\r\n+              });\r\n+\r\n+              const marker = L.marker([it.lat, it.lng], { icon });\r\n+              const poiName = it.name || it.category || 'POI';\r\n+\r\n+              // Popup DOM\r\n+              const container = document.createElement('div');\r\n+              const title = document.createElement('b');\r\n+              title.textContent = poiName;\r\n+              container.appendChild(title);\r\n+              container.appendChild(document.createElement('br'));\r\n+\r\n+              const btn = document.createElement('button');\r\n+              btn.textContent = 'Set Destination';\r\n+              btn.style.marginTop = '6px';\r\n+              btn.onclick = function () {\r\n+                window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                  type: 'setDestinationFromPOI',\r\n+                  lat: it.lat,\r\n+                  lng: it.lng,\r\n+                  label: poiName\r\n+                }));\r\n+              };\r\n+              container.appendChild(btn);\r\n+\r\n+              marker.bindPopup(container);\r\n+              marker.addTo(poiLayer);\r\n+            });\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n         });\r\n       </script>\r\n     </body>\r\n   </html>\r\n   `;\r\n   setMapHtml(html);\r\n-  }, [location]);\r\n+  }, [location, iconData]);\r\n \r\n \r\n \r\n   useEffect(() => {\r\n@@ -549,21 +746,83 @@\n         } catch {\r\n           setDropoffName(\"Selected Location\");\r\n         }\r\n       }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = parsed.zoom ?? 15;\r\n+        if (zoom < 14) return;\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = `${zoom}|${minLng.toFixed(3)},${minLat.toFixed(3)},${maxLng.toFixed(3)},${maxLat.toFixed(3)}`;\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 750);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n     } catch {}\r\n   };\r\n \r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n     }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n     setSearching(true)\r\n     setAlertedBookingComplete(false);\r\n     setTripCompleted(false);\r\n-\r\n-    const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n@@ -588,9 +847,9 @@\n       });\r\n \r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-      setBookingId(result.booking.id);\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n     } catch (e: any) {\r\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n@@ -689,14 +948,8 @@\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n   useEffect(() => {\r\n-    if (searching && (!bookingId || tripCompleted)) {\r\n-      setSearching(false);\r\n-    }\r\n-  }, [searching, bookingId, tripCompleted]);\r\n-\r\n-  useEffect(() => {\r\n     let interval: any;\r\n     const pollForBookingCompletion = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n@@ -731,10 +984,10 @@\n           // clear saved ‚Äúsearching:true‚Äù from storage\r\n           AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n \r\n           // clear map\r\n-          mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n-          mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n \r\n           setFare(0);\r\n         }\r\n \r\n@@ -846,8 +1099,19 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n   if (loading || !location) return null;\r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n@@ -861,8 +1125,9 @@\n               pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n+              onLoadEnd={() => setMapReady(true)}\r\n               style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n               onMessage={handleMapMessage}\r\n               nestedScrollEnabled\r\n             />\r\n@@ -881,9 +1146,9 @@\n               {hits.length > 0 && (\r\n                 <View style={styles.searchResults}>\r\n                   {hits.map((h, i) => (\r\n                     <TouchableOpacity\r\n-                      key={`${h.lat},${h.lon}-${i}`}\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n                       onPress={() => choosePlace(h)}\r\n                       style={styles.searchItem}\r\n                     >\r\n                       <Text style={styles.searchItemText}>{h.label}</Text>\r\n@@ -891,8 +1156,30 @@\n                   ))}\r\n                 </View>\r\n               )}\r\n             </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n           </View>\r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n@@ -1001,10 +1288,10 @@\n                             setBookingId(null);\r\n                             setMatchedDriver(null);\r\n                             setDestination(null);\r\n                             setBookingConfirmed(false);\r\n-                            mapRef.current?.postMessage(JSON.stringify({ type: \"setMarkers\", destination: null, driver: null }));\r\n-                            mapRef.current?.postMessage(JSON.stringify({ type: \"clearRoute\" }));\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n                             setFare(0);\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n                           style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n@@ -1036,9 +1323,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            {!matchedDriver && !searching && !showBookingForm && (\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n                 style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n               >\r\n"
                },
                {
                    "date": 1760604857267,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -766,9 +766,9 @@\n         if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n         poiFetchTimerRef.current = setTimeout(async () => {\r\n           try {\r\n             const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,hospital,school,market,parking,terminal')}`,\r\n               `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n               `zoom=${zoom}`,\r\n             ];\r\n             if (center?.lat != null && center?.lng != null) {\r\n"
                },
                {
                    "date": 1760605167184,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -766,9 +766,9 @@\n         if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n         poiFetchTimerRef.current = setTimeout(async () => {\r\n           try {\r\n             const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,hospital,school,market,parking,terminal')}`,\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n               `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n               `zoom=${zoom}`,\r\n             ];\r\n             if (center?.lat != null && center?.lng != null) {\r\n"
                },
                {
                    "date": 1760605186501,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -766,9 +766,9 @@\n         if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n         poiFetchTimerRef.current = setTimeout(async () => {\r\n           try {\r\n             const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restauran,fast_food,hospital,school,market,parking,terminal')}`,\r\n               `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n               `zoom=${zoom}`,\r\n             ];\r\n             if (center?.lat != null && center?.lng != null) {\r\n"
                },
                {
                    "date": 1760605360386,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -766,9 +766,9 @@\n         if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n         poiFetchTimerRef.current = setTimeout(async () => {\r\n           try {\r\n             const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restauran,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n               `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n               `zoom=${zoom}`,\r\n             ];\r\n             if (center?.lat != null && center?.lng != null) {\r\n"
                },
                {
                    "date": 1760607744407,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -496,8 +496,12 @@\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n \r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n         (function sendInitialBBox(){\r\n           const b = map.getBounds();\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({\r\n             type: 'bbox',\r\n"
                },
                {
                    "date": 1760607776000,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -500,8 +500,24 @@\n         const poiMarkers = new Map();        // id -> L.Marker\r\n         const iconCache  = {};               // category -> L.Icon\r\n         let poiBatchHandle = null;           // cancel previous batch\r\n \r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+\r\n         (function sendInitialBBox(){\r\n           const b = map.getBounds();\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({\r\n             type: 'bbox',\r\n"
                },
                {
                    "date": 1760607926436,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -662,55 +662,83 @@\n           }\r\n \r\n           const poiIcons = ${iconJson};\r\n           if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            poiLayer.clearLayers();\r\n+            // cancel any ongoing batch\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n \r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n \r\n-              // choose icon: use local base64 if present, else fallback CDN\r\n-              const iconUrl = (poiIcons[it.category] && poiIcons[it.category].includes('base64,'))\r\n-                ? poiIcons[it.category]\r\n-                : 'https://cdn-icons-png.flaticon.com/512/854/854878.png';\r\n+            // remove markers no longer present\r\n+            for (const [id, marker] of poiMarkers) {\r\n+              if (!desired.has(id)) {\r\n+                poiLayer.removeLayer(marker);\r\n+                poiMarkers.delete(id);\r\n+              }\r\n+            }\r\n \r\n-              const icon = L.icon({\r\n-                iconUrl,\r\n-                iconSize: [28, 28],\r\n-                iconAnchor: [14, 28],\r\n-              });\r\n+            // build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n \r\n-              const marker = L.marker([it.lat, it.lng], { icon });\r\n-              const poiName = it.name || it.category || 'POI';\r\n+            // batched add (40 per frame is a good sweet spot)\r\n+            const BATCH = 40;\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n \r\n-              // Popup DOM\r\n-              const container = document.createElement('div');\r\n-              const title = document.createElement('b');\r\n-              title.textContent = poiName;\r\n-              container.appendChild(title);\r\n-              container.appendChild(document.createElement('br'));\r\n+            const addBatch = (startIdx = 0) => {\r\n+              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n \r\n-              const btn = document.createElement('button');\r\n-              btn.textContent = 'Set Destination';\r\n-              btn.style.marginTop = '6px';\r\n-              btn.onclick = function () {\r\n-                window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                  type: 'setDestinationFromPOI',\r\n-                  lat: it.lat,\r\n-                  lng: it.lng,\r\n-                  label: poiName\r\n-                }));\r\n-              };\r\n-              container.appendChild(btn);\r\n+                const marker = L.marker([it.lat, it.lng], { icon });\r\n \r\n-              marker.bindPopup(container);\r\n-              marker.addTo(poiLayer);\r\n-            });\r\n+                // popup with \"Set Destination\"\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n \r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+              }\r\n+\r\n+              if (startIdx + BATCH < toAdd.length) {\r\n+                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n+              } else {\r\n+                poiBatchHandle = null; // done\r\n+              }\r\n+            };\r\n+\r\n+            // start batching\r\n+            addBatch(0);\r\n+\r\n             return;\r\n           }\r\n \r\n \r\n+\r\n           // Render Landmarks (pin markers)\r\n           if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n             landmarkLayer.clearLayers();\r\n             msg.items.forEach(it => {\r\n"
                },
                {
                    "date": 1760607945530,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -662,83 +662,55 @@\n           }\r\n \r\n           const poiIcons = ${iconJson};\r\n           if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            // cancel any ongoing batch\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n+            poiLayer.clearLayers();\r\n \r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n \r\n-            // remove markers no longer present\r\n-            for (const [id, marker] of poiMarkers) {\r\n-              if (!desired.has(id)) {\r\n-                poiLayer.removeLayer(marker);\r\n-                poiMarkers.delete(id);\r\n-              }\r\n-            }\r\n+              // choose icon: use local base64 if present, else fallback CDN\r\n+              const iconUrl = (poiIcons[it.category] && poiIcons[it.category].includes('base64,'))\r\n+                ? poiIcons[it.category]\r\n+                : 'https://cdn-icons-png.flaticon.com/512/854/854878.png';\r\n \r\n-            // build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n+              const icon = L.icon({\r\n+                iconUrl,\r\n+                iconSize: [28, 28],\r\n+                iconAnchor: [14, 28],\r\n+              });\r\n \r\n-            // batched add (40 per frame is a good sweet spot)\r\n-            const BATCH = 40;\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+              const marker = L.marker([it.lat, it.lng], { icon });\r\n+              const poiName = it.name || it.category || 'POI';\r\n \r\n-            const addBatch = (startIdx = 0) => {\r\n-              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n+              // Popup DOM\r\n+              const container = document.createElement('div');\r\n+              const title = document.createElement('b');\r\n+              title.textContent = poiName;\r\n+              container.appendChild(title);\r\n+              container.appendChild(document.createElement('br'));\r\n \r\n-                const marker = L.marker([it.lat, it.lng], { icon });\r\n+              const btn = document.createElement('button');\r\n+              btn.textContent = 'Set Destination';\r\n+              btn.style.marginTop = '6px';\r\n+              btn.onclick = function () {\r\n+                window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                  type: 'setDestinationFromPOI',\r\n+                  lat: it.lat,\r\n+                  lng: it.lng,\r\n+                  label: poiName\r\n+                }));\r\n+              };\r\n+              container.appendChild(btn);\r\n \r\n-                // popup with \"Set Destination\"\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n+              marker.bindPopup(container);\r\n+              marker.addTo(poiLayer);\r\n+            });\r\n \r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-              }\r\n-\r\n-              if (startIdx + BATCH < toAdd.length) {\r\n-                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n-              } else {\r\n-                poiBatchHandle = null; // done\r\n-              }\r\n-            };\r\n-\r\n-            // start batching\r\n-            addBatch(0);\r\n-\r\n             return;\r\n           }\r\n \r\n \r\n-\r\n           // Render Landmarks (pin markers)\r\n           if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n             landmarkLayer.clearLayers();\r\n             msg.items.forEach(it => {\r\n"
                },
                {
                    "date": 1760608103668,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -474,9 +474,9 @@\n         const map = L.map('map', {\r\n           zoomControl: true,\r\n           maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n           maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n+          minZoom: 14,\r\n           maxZoom: 20, \r\n           noWrap: true\r\n         }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n@@ -662,55 +662,83 @@\n           }\r\n \r\n           const poiIcons = ${iconJson};\r\n           if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            poiLayer.clearLayers();\r\n+            // cancel any ongoing batch\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n \r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n \r\n-              // choose icon: use local base64 if present, else fallback CDN\r\n-              const iconUrl = (poiIcons[it.category] && poiIcons[it.category].includes('base64,'))\r\n-                ? poiIcons[it.category]\r\n-                : 'https://cdn-icons-png.flaticon.com/512/854/854878.png';\r\n+            // remove markers no longer present\r\n+            for (const [id, marker] of poiMarkers) {\r\n+              if (!desired.has(id)) {\r\n+                poiLayer.removeLayer(marker);\r\n+                poiMarkers.delete(id);\r\n+              }\r\n+            }\r\n \r\n-              const icon = L.icon({\r\n-                iconUrl,\r\n-                iconSize: [28, 28],\r\n-                iconAnchor: [14, 28],\r\n-              });\r\n+            // build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n \r\n-              const marker = L.marker([it.lat, it.lng], { icon });\r\n-              const poiName = it.name || it.category || 'POI';\r\n+            // batched add (40 per frame is a good sweet spot)\r\n+            const BATCH = 40;\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n \r\n-              // Popup DOM\r\n-              const container = document.createElement('div');\r\n-              const title = document.createElement('b');\r\n-              title.textContent = poiName;\r\n-              container.appendChild(title);\r\n-              container.appendChild(document.createElement('br'));\r\n+            const addBatch = (startIdx = 0) => {\r\n+              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n \r\n-              const btn = document.createElement('button');\r\n-              btn.textContent = 'Set Destination';\r\n-              btn.style.marginTop = '6px';\r\n-              btn.onclick = function () {\r\n-                window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                  type: 'setDestinationFromPOI',\r\n-                  lat: it.lat,\r\n-                  lng: it.lng,\r\n-                  label: poiName\r\n-                }));\r\n-              };\r\n-              container.appendChild(btn);\r\n+                const marker = L.marker([it.lat, it.lng], { icon });\r\n \r\n-              marker.bindPopup(container);\r\n-              marker.addTo(poiLayer);\r\n-            });\r\n+                // popup with \"Set Destination\"\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n \r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+              }\r\n+\r\n+              if (startIdx + BATCH < toAdd.length) {\r\n+                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n+              } else {\r\n+                poiBatchHandle = null; // done\r\n+              }\r\n+            };\r\n+\r\n+            // start batching\r\n+            addBatch(0);\r\n+\r\n             return;\r\n           }\r\n \r\n \r\n+\r\n           // Render Landmarks (pin markers)\r\n           if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n             landmarkLayer.clearLayers();\r\n             msg.items.forEach(it => {\r\n"
                },
                {
                    "date": 1760608124454,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -474,9 +474,9 @@\n         const map = L.map('map', {\r\n           zoomControl: true,\r\n           maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n           maxBoundsViscosity: 0.5,\r\n-          minZoom: 14,\r\n+          minZoom: 15,\r\n           maxZoom: 20, \r\n           noWrap: true\r\n         }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n"
                },
                {
                    "date": 1760608146338,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -474,10 +474,10 @@\n         const map = L.map('map', {\r\n           zoomControl: true,\r\n           maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n           maxBoundsViscosity: 0.5,\r\n-          minZoom: 15,\r\n-          maxZoom: 20, \r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n           noWrap: true\r\n         }).setView([${location.latitude}, ${location.longitude}], 15);\r\n \r\n \r\n"
                },
                {
                    "date": 1760610727339,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -591,16 +591,36 @@\n           setDestination(lat, lng);\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n         });\r\n \r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(),\r\n+              minLat: b.getSouth(),\r\n+              maxLng: b.getEast(),\r\n+              maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n         map.on('moveend', function () {\r\n           const b = map.getBounds();\r\n-          const z = map.getZoom();\r\n           const c = map.getCenter();\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({\r\n             type: 'bbox',\r\n-            bbox: { minLng: b.getWest(), minLat: b.getSouth(), maxLng: b.getEast(), maxLat: b.getNorth() },\r\n-            zoom: z,\r\n+            bbox: {\r\n+              minLng: b.getWest(),\r\n+              minLat: b.getSouth(),\r\n+              maxLng: b.getEast(),\r\n+              maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n         });\r\n \r\n"
                },
                {
                    "date": 1760612560606,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -597,12 +597,10 @@\n           const c = map.getCenter();\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({\r\n             type: 'bbox',\r\n             bbox: {\r\n-              minLng: b.getWest(),\r\n-              minLat: b.getSouth(),\r\n-              maxLng: b.getEast(),\r\n-              maxLat: b.getNorth()\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n             },\r\n             zoom: map.getZoom(),\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n@@ -613,18 +611,17 @@\n           const c = map.getCenter();\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({\r\n             type: 'bbox',\r\n             bbox: {\r\n-              minLng: b.getWest(),\r\n-              minLat: b.getSouth(),\r\n-              maxLng: b.getEast(),\r\n-              maxLat: b.getNorth()\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n             },\r\n             zoom: map.getZoom(),\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n         });\r\n \r\n+\r\n         // --- Message bridge ---\r\n         document.addEventListener('message', function(event){\r\n           let msg = {};\r\n           try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n"
                },
                {
                    "date": 1760612626168,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -839,8 +839,9 @@\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n           } catch {\r\n"
                },
                {
                    "date": 1760612992630,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -617,8 +617,12 @@\n             },\r\n             zoom: map.getZoom(),\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n+          console.log('[WEBVIEW] sending bbox ‚Üí', {\r\n+            zoom: map.getZoom(),\r\n+            center: map.getCenter()\r\n+          });\r\n         });\r\n \r\n \r\n         // --- Message bridge ---\r\n"
                },
                {
                    "date": 1760613059910,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -527,8 +527,12 @@\n               maxLng: b.getEast(),\r\n               maxLat: b.getNorth()\r\n             }\r\n           }));\r\n+          console.log('[WEBVIEW] sendInitialBBox ‚Üí', {\r\n+            zoom: map.getZoom(),\r\n+            center: map.getCenter()\r\n+          });\r\n         })();\r\n \r\n \r\n         // --- Icons ---\r\n@@ -617,9 +621,9 @@\n             },\r\n             zoom: map.getZoom(),\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n-          console.log('[WEBVIEW] sending bbox ‚Üí', {\r\n+          console.log('[WEBVIEW] moveend ‚Üí', {\r\n             zoom: map.getZoom(),\r\n             center: map.getCenter()\r\n           });\r\n         });\r\n"
                },
                {
                    "date": 1760613678724,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -512,8 +512,9 @@\n             iconUrl: url,\r\n             iconSize: [28, 28],\r\n             iconAnchor: [14, 28],\r\n           });\r\n+          console.log('[RN] Fetching POIs URL:', url);\r\n           return iconCache[cat];\r\n         }\r\n \r\n \r\n@@ -879,8 +880,9 @@\n           driver: null,\r\n         });\r\n         return;\r\n       }\r\n+      console.log('[RN] WebView message:', parsed);\r\n     } catch {}\r\n   };\r\n \r\n   const handleBookNow = async () => {\r\n"
                },
                {
                    "date": 1760615778809,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -534,9 +534,19 @@\n             center: map.getCenter()\r\n           });\r\n         })();\r\n \r\n+        (function () {\r\n+          const orig = console.log;\r\n+          console.log = function (...args) {\r\n+            try {\r\n+              window.ReactNativeWebView.postMessage(JSON.stringify({ type: '__log__', args }));\r\n+            } catch {}\r\n+            try { orig.apply(console, args); } catch {}\r\n+          };\r\n+        })();\r\n \r\n+\r\n         // --- Icons ---\r\n         const userIcon = L.icon({\r\n           iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n           iconSize: [30, 30],\r\n"
                },
                {
                    "date": 1760615846111,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -519,23 +519,23 @@\n \r\n \r\n         (function sendInitialBBox(){\r\n           const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          const z = map.getZoom();\r\n           window.ReactNativeWebView.postMessage(JSON.stringify({\r\n             type: 'bbox',\r\n             bbox: {\r\n-              minLng: b.getWest(),\r\n-              minLat: b.getSouth(),\r\n-              maxLng: b.getEast(),\r\n-              maxLat: b.getNorth()\r\n-            }\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: z,\r\n+            center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n-          console.log('[WEBVIEW] sendInitialBBox ‚Üí', {\r\n-            zoom: map.getZoom(),\r\n-            center: map.getCenter()\r\n-          });\r\n+          console.log('[WEBVIEW] sendInitialBBox ‚Üí', { zoom: z, center: c });\r\n         })();\r\n \r\n+\r\n         (function () {\r\n           const orig = console.log;\r\n           console.log = function (...args) {\r\n             try {\r\n"
                },
                {
                    "date": 1760615898755,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -814,8 +814,10 @@\n   // Reverse geocode for drop-off location\r\n   const handleMapMessage = async (event: any) => {\r\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      console.log('[RN] WebView message:', parsed);\r\n       if (parsed.latitude && parsed.longitude) {\r\n         setDestination(parsed);\r\n         try {\r\n           const results = await Location.reverseGeocodeAsync({\r\n@@ -890,9 +892,8 @@\n           driver: null,\r\n         });\r\n         return;\r\n       }\r\n-      console.log('[RN] WebView message:', parsed);\r\n     } catch {}\r\n   };\r\n \r\n   const handleBookNow = async () => {\r\n"
                },
                {
                    "date": 1760615922035,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -860,9 +860,9 @@\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-\r\n+            console.log('[RN] Fetching POIs URL:', url);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n           } catch {\r\n"
                },
                {
                    "date": 1760616135890,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -859,9 +859,8 @@\n             ];\r\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n             console.log('[RN] Fetching POIs URL:', url);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n"
                },
                {
                    "date": 1760616183867,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -859,8 +859,9 @@\n             ];\r\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n             console.log('[RN] Fetching POIs URL:', url);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n"
                },
                {
                    "date": 1760616196622,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -860,9 +860,8 @@\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            console.log('[RN] Fetching POIs URL:', url);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n           } catch {\r\n"
                },
                {
                    "date": 1760616209941,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -860,8 +860,9 @@\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            console.log('[RN] Fetching POIs URL:', url);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n           } catch {\r\n"
                },
                {
                    "date": 1760618405697,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -512,9 +512,8 @@\n             iconUrl: url,\r\n             iconSize: [28, 28],\r\n             iconAnchor: [14, 28],\r\n           });\r\n-          console.log('[RN] Fetching POIs URL:', url);\r\n           return iconCache[cat];\r\n         }\r\n \r\n \r\n@@ -530,9 +529,8 @@\n             },\r\n             zoom: z,\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n-          console.log('[WEBVIEW] sendInitialBBox ‚Üí', { zoom: z, center: c });\r\n         })();\r\n \r\n \r\n         (function () {\r\n"
                },
                {
                    "date": 1760618440151,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -531,20 +531,8 @@\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n         })();\r\n \r\n-\r\n-        (function () {\r\n-          const orig = console.log;\r\n-          console.log = function (...args) {\r\n-            try {\r\n-              window.ReactNativeWebView.postMessage(JSON.stringify({ type: '__log__', args }));\r\n-            } catch {}\r\n-            try { orig.apply(console, args); } catch {}\r\n-          };\r\n-        })();\r\n-\r\n-\r\n         // --- Icons ---\r\n         const userIcon = L.icon({\r\n           iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n           iconSize: [30, 30],\r\n@@ -630,12 +618,8 @@\n             },\r\n             zoom: map.getZoom(),\r\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n-          console.log('[WEBVIEW] moveend ‚Üí', {\r\n-            zoom: map.getZoom(),\r\n-            center: map.getCenter()\r\n-          });\r\n         });\r\n \r\n \r\n         // --- Message bridge ---\r\n@@ -813,9 +797,8 @@\n   const handleMapMessage = async (event: any) => {\r\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n       // Always see what's coming in:\r\n-      console.log('[RN] WebView message:', parsed);\r\n       if (parsed.latitude && parsed.longitude) {\r\n         setDestination(parsed);\r\n         try {\r\n           const results = await Location.reverseGeocodeAsync({\r\n@@ -858,9 +841,8 @@\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            console.log('[RN] Fetching POIs URL:', url);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n           } catch {\r\n"
                },
                {
                    "date": 1760620680192,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -114,9 +114,11 @@\n   const lastPoiKeyRef = useRef<string>('');\r\n   const [showLandmarks, setShowLandmarks] = useState(false);\r\n   const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n   const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n \r\n+\r\n   function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n     const R = 6371000;\r\n     const toRad = (x:number)=>x*Math.PI/180;\r\n     const dLat = toRad(b.lat-a.lat);\r\n@@ -841,11 +843,23 @@\n             if (center?.lat != null && center?.lng != null) {\r\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            // ‚úÖ caching layer\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              console.log('[CACHE] using cached POIs for', key);\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            console.log('[FETCH] requesting fresh POIs for', key);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n-            sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({ type: 'setPOIs', items });\r\n+            }\r\n+\r\n           } catch {\r\n             sendToMap({ type: 'setPOIs', items: [] });\r\n           }\r\n         }, 750);\r\n"
                },
                {
                    "date": 1760623231681,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1563 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n+\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n+\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); \r\n+};\r\n+\r\n+\r\n+\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+\r\n+  \r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        // 1) prefer unified auth\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  const canShowChatNotice =\r\n+    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+\r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+        console.error(\"üõë Invalid ORS response:\", data);\r\n+        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.features[0].geometry.coordinates; \r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n+\r\n+      const summary = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM = summary.distance ?? 0;\r\n+      const durationS = summary.duration ?? 0;\r\n+\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60\r\n+        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n+        : `${mins} min`;\r\n+\r\n+      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n+      const fareText = `‚Ç±${computedFare} est`;\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm, \r\n+        distanceText,     \r\n+        durationText,\r\n+        fareText,  \r\n+      });\r\n+\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n+    }\r\n+  };\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n+      try {\r\n+        const lat = location.latitude;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+\r\n+    // update UI\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n+    // draw route immediately\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest\r\n+    );\r\n+\r\n+    // (optional) update markers\r\n+    sendToMap({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    });\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      // fire once right away, so the dot appears even before watch ticks\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+      }\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          sendToMap({\r\n+            type: \"updateUserLoc\",\r\n+            latitude: pos.coords.latitude,\r\n+            longitude: pos.coords.longitude,\r\n+            accuracy: pos.coords.accuracy ?? 15,\r\n+            avatarUrl,\r\n+          });\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            sendToMap({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            });\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n+  // ---------------------------------------------------------\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+  if (!location) return;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n+\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        // --- Map init ---\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n+          noWrap: true\r\n+        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+\r\n+        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n+        }).addTo(map);\r\n+\r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n+\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n+\r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+\r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          const z = map.getZoom();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: z,\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n+\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n+\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n+\r\n+        // --- Helpers ---\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip( { permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+        }\r\n+\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n+\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n+\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n+\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n+\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n+\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            upsertUserMarker(msg.latitude, msg.longitude);\r\n+            return;\r\n+          }\r\n+\r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n+\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+            clearRoute();\r\n+\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n+              .setContent(label || '')\r\n+              .setLatLng(mid)\r\n+              .addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n+            }\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            // cancel any ongoing batch\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n+\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n+\r\n+            // remove markers no longer present\r\n+            for (const [id, marker] of poiMarkers) {\r\n+              if (!desired.has(id)) {\r\n+                poiLayer.removeLayer(marker);\r\n+                poiMarkers.delete(id);\r\n+              }\r\n+            }\r\n+\r\n+            // build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n+\r\n+            // batched add (40 per frame is a good sweet spot)\r\n+            const BATCH = 40;\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+\r\n+            const addBatch = (startIdx = 0) => {\r\n+              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n+\r\n+                const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+                // popup with \"Set Destination\"\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n+\r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+              }\r\n+\r\n+              if (startIdx + BATCH < toAdd.length) {\r\n+                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n+              } else {\r\n+                poiBatchHandle = null; // done\r\n+              }\r\n+            };\r\n+\r\n+            // start batching\r\n+            addBatch(0);\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n+  }, [location, iconData]);\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+  }, [mapHtml, location, avatarUrl]);\r\n+\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = parsed.zoom ?? 15;\r\n+        if (zoom < 14) return;\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = `${zoom}|${minLng.toFixed(3)},${minLat.toFixed(3)},${maxLng.toFixed(3)},${maxLat.toFixed(3)}`;\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              console.log('[CACHE] using cached POIs for', key);\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            console.log('[FETCH] requesting fresh POIs for', key);\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({\r\n+                type: 'setPOIs',\r\n+                items,\r\n+                zoom,                       \r\n+                bbox: { minLng, minLat, maxLng, maxLat },  \r\n+              });\r\n+            }\r\n+\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 750);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+    setSearching(true)\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare, paymentMethod, notes, passengerId\r\n+    };\r\n+\r\n+    try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n+\r\n+  \r\n+  \r\n+\r\n+  // Set markers & trigger route drawing when destination is picked\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+      : null;\r\n+\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+    }\r\n+\r\n+    // üëâ draw route as soon as we have both ends\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+\r\n+          setFare(0);\r\n+        }\r\n+\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n+        }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n+    };\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.searchcont}>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{\r\n+                              width: 50,\r\n+                              height: 50,\r\n+                              borderRadius: 25,\r\n+                              marginRight: 10,\r\n+                            }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          {/* Chat button here */}\r\n+                          <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId: bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId: passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n+                            }}\r\n+                            style={{\r\n+                              marginTop: 8,\r\n+                              backgroundColor: \"#007bff\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 16,\r\n+                              borderRadius: 8,\r\n+                              alignSelf: \"flex-start\",\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                          </TouchableOpacity>\r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch {}\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n+                            setFare(0);\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                </ScrollView>\r\n+                <View style={styles.fareContainer}>\r\n+                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n+                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n+  panel: {\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n+  },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n+  dropdownItem: { padding: 10 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n+  \r\n+});\r\n"
                },
                {
                    "date": 1760623554000,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -497,8 +497,9 @@\n         let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n+        let currentZoomLevel = map.getZoom();\r\n \r\n         const poiMarkers = new Map();        // id -> L.Marker\r\n         const iconCache  = {};               // category -> L.Icon\r\n         let poiBatchHandle = null;           // cancel previous batch\r\n@@ -1560,1563 +1561,4 @@\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n   \r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync(); // ensures we have a real file on device\r\n-  const uri = asset.localUri || asset.uri; // localUri preferred\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),          \r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-\r\n-\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1)); \r\n-  }\r\n-\r\n-\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) {\r\n-      messageQueue.current.push(json);\r\n-      return;\r\n-    }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-\r\n-  \r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        // 1) prefer unified auth\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-\r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  const canShowChatNotice =\r\n-    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n-\r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n-\r\n-      const coords = data.features[0].geometry.coordinates; \r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n-\r\n-      const summary = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM = summary.distance ?? 0;\r\n-      const durationS = summary.duration ?? 0;\r\n-\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60\r\n-        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n-        : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n-      const fareText = `‚Ç±${computedFare} est`;\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm, \r\n-        distanceText,     \r\n-        durationText,\r\n-        fareText,  \r\n-      });\r\n-\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n-    }\r\n-  };\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lng = location.longitude; // NOTE: lng\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    sendToMap({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    });\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      // fire once right away, so the dot appears even before watch ticks\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-      }\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          sendToMap({\r\n-            type: \"updateUserLoc\",\r\n-            latitude: pos.coords.latitude,\r\n-            longitude: pos.coords.longitude,\r\n-            accuracy: pos.coords.accuracy ?? 15,\r\n-            avatarUrl,\r\n-          });\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            sendToMap({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            });\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  // useEffect(() => {\r\n-  //   const backAction = () => {\r\n-  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-  //       {\r\n-  //         text: \"Logout\",\r\n-  //         onPress: async () => {\r\n-  //           await AsyncStorage.removeItem(\"passengerId\");\r\n-  //           router.replace(\"/login_and_reg/plogin\");\r\n-  //         },\r\n-  //       },\r\n-  //     ]);\r\n-  //     return true;\r\n-  //   };\r\n-  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-  //   return () => backHandler.remove();\r\n-  // }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location) return;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        // --- Map init ---\r\n-        const map = L.map('map', {\r\n-          zoomControl: true,\r\n-          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n-          maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n-          maxZoom: 19, \r\n-          noWrap: true\r\n-        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        let poiLayer = L.layerGroup().addTo(map);\r\n-        let landmarkLayer = L.layerGroup().addTo(map);\r\n-\r\n-        const poiMarkers = new Map();        // id -> L.Marker\r\n-        const iconCache  = {};               // category -> L.Icon\r\n-        let poiBatchHandle = null;           // cancel previous batch\r\n-\r\n-        function getPoiIcon(cat, poiIcons) {\r\n-          if (iconCache[cat]) return iconCache[cat];\r\n-\r\n-          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n-            ? poiIcons[cat]\r\n-            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n-\r\n-          iconCache[cat] = L.icon({\r\n-            iconUrl: url,\r\n-            iconSize: [28, 28],\r\n-            iconAnchor: [14, 28],\r\n-          });\r\n-          return iconCache[cat];\r\n-        }\r\n-\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          const z = map.getZoom();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: z,\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        // --- Helpers ---\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip( { permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-        }\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        map.on('moveend', function () {\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        });\r\n-\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            upsertUserMarker(msg.latitude, msg.longitude);\r\n-            return;\r\n-          }\r\n-\r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n-            clearRoute();\r\n-\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n-              .setContent(label || '')\r\n-              .setLatLng(mid)\r\n-              .addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n-            }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-          const poiIcons = ${iconJson};\r\n-          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            // cancel any ongoing batch\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n-\r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n-\r\n-            // remove markers no longer present\r\n-            for (const [id, marker] of poiMarkers) {\r\n-              if (!desired.has(id)) {\r\n-                poiLayer.removeLayer(marker);\r\n-                poiMarkers.delete(id);\r\n-              }\r\n-            }\r\n-\r\n-            // build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n-\r\n-            // batched add (40 per frame is a good sweet spot)\r\n-            const BATCH = 40;\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n-\r\n-            const addBatch = (startIdx = 0) => {\r\n-              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n-\r\n-                const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-                // popup with \"Set Destination\"\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n-\r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-              }\r\n-\r\n-              if (startIdx + BATCH < toAdd.length) {\r\n-                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n-              } else {\r\n-                poiBatchHandle = null; // done\r\n-              }\r\n-            };\r\n-\r\n-            // start batching\r\n-            addBatch(0);\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-\r\n-          // Render Landmarks (pin markers)\r\n-          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n-            landmarkLayer.clearLayers();\r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n-              L.marker([it.lat, it.lng])\r\n-                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n-                .addTo(landmarkLayer);\r\n-            });\r\n-            return;\r\n-          }\r\n-          if (msg.type === 'clearLandmarks') {\r\n-            landmarkLayer.clearLayers();\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [location, iconData]);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-  }, [mapHtml, location, avatarUrl]);\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      // Always see what's coming in:\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = parsed.zoom ?? 15;\r\n-        if (zoom < 14) return;\r\n-\r\n-        const center = parsed.center;\r\n-        if (center && lastCenterRef.current) {\r\n-          const moved = haversine(lastCenterRef.current, center);\r\n-          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n-        }\r\n-        if (center) lastCenterRef.current = center;\r\n-\r\n-        const key = `${zoom}|${minLng.toFixed(3)},${minLat.toFixed(3)},${maxLng.toFixed(3)},${maxLat.toFixed(3)}`;\r\n-        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n-        lastPoiKeyRef.current = key;\r\n-\r\n-        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-        poiFetchTimerRef.current = setTimeout(async () => {\r\n-          try {\r\n-            const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-              `zoom=${zoom}`,\r\n-            ];\r\n-            if (center?.lat != null && center?.lng != null) {\r\n-              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-            }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            // ‚úÖ caching layer\r\n-            if (poiCacheRef.current.has(key)) {\r\n-              console.log('[CACHE] using cached POIs for', key);\r\n-              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n-              return;\r\n-            }\r\n-\r\n-            console.log('[FETCH] requesting fresh POIs for', key);\r\n-            const r = await fetch(url);\r\n-            const items = await r.json();\r\n-            if (Array.isArray(items)) {\r\n-              poiCacheRef.current.set(key, items);\r\n-              sendToMap({ type: 'setPOIs', items });\r\n-            }\r\n-\r\n-          } catch {\r\n-            sendToMap({ type: 'setPOIs', items: [] });\r\n-          }\r\n-        }, 750);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'setDestinationFromPOI') {\r\n-        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n-        setDestination(dest);\r\n-        setDropoffName(parsed.label || 'POI Destination');\r\n-\r\n-        if (!location) {\r\n-          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-          return;\r\n-        }\r\n-        const { latitude, longitude } = location;\r\n-\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          dest\r\n-        );\r\n-        sendToMap({\r\n-          type: 'setMarkers',\r\n-          destination: dest,\r\n-          driver: null,\r\n-        });\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-    setSearching(true)\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare, paymentMethod, notes, passengerId\r\n-    };\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-  // {status === \"accepted\" && bookingId && (\r\n-  //   <ChatNotice\r\n-  //     bookingId={bookingId}\r\n-  //     role=\"passenger\"\r\n-  //     onGoToChat={() =>\r\n-  //       router.push({\r\n-  //         pathname: \"/chatcomponent\",\r\n-  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-  //       })\r\n-  //     }\r\n-  //   />\r\n-  // )}\r\n-\r\n-  \r\n-  \r\n-\r\n-  // Set markers & trigger route drawing when destination is picked\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n-\r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.searchcont}>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lng}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showLandmarks) {\r\n-                  sendToMap({ type: 'clearLandmarks' });\r\n-                  setShowLandmarks(false);\r\n-                } else {\r\n-                  loadLandmarks(); // same function we made before\r\n-                  setShowLandmarks(true);\r\n-                }\r\n-              }}\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n-            </TouchableOpacity>\r\n-\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{\r\n-                              width: 50,\r\n-                              height: 50,\r\n-                              borderRadius: 25,\r\n-                              marginRight: 10,\r\n-                            }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-\r\n-                          {/* Chat button here */}\r\n-                          <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              router.push({\r\n-                                pathname: \"/ChatRoom\",\r\n-                                params: {\r\n-                                  bookingId: bookingId,\r\n-                                  driverId: matchedDriver?.driverId,\r\n-                                  passengerId: passengerId,\r\n-                                  role: \"passenger\",\r\n-                                },\r\n-                              });\r\n-                            }}\r\n-                            style={{\r\n-                              marginTop: 8,\r\n-                              backgroundColor: \"#007bff\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 16,\r\n-                              borderRadius: 8,\r\n-                              alignSelf: \"flex-start\",\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n-                          </TouchableOpacity>\r\n-                        </View>\r\n-                      </View>\r\n-\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch {}\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-                            sendToMap({ type: \"clearRoute\" });\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                </ScrollView>\r\n-                <View style={styles.fareContainer}>\r\n-                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-  \r\n-});\r\n"
                },
                {
                    "date": 1760623594198,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -534,8 +534,43 @@\n             center: { lat: c.lat, lng: c.lng }\r\n           }));\r\n         })();\r\n \r\n+        function addOrUpdatePOIMarker(it, poiIcons) {\r\n+          const existing = poiMarkers.get(it.id);\r\n+          if (existing) {\r\n+            // update position if it changed\r\n+            const curr = existing.getLatLng();\r\n+            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n+              existing.setLatLng([it.lat, it.lng]);\r\n+            }\r\n+            return;\r\n+          }\r\n+          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n+          const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+          // build popup with \"Set Destination\"\r\n+          const container = document.createElement('div');\r\n+          const title = document.createElement('b');\r\n+          title.textContent = it.name || it.category || 'POI';\r\n+          container.appendChild(title);\r\n+          container.appendChild(document.createElement('br'));\r\n+          const btn = document.createElement('button');\r\n+          btn.textContent = 'Set Destination';\r\n+          btn.style.marginTop = '6px';\r\n+          btn.onclick = function () {\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'setDestinationFromPOI',\r\n+              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+            }));\r\n+          };\r\n+          container.appendChild(btn);\r\n+          marker.bindPopup(container);\r\n+\r\n+          marker.addTo(poiLayer);\r\n+          poiMarkers.set(it.id, marker);\r\n+        }\r\n+\r\n         // --- Icons ---\r\n         const userIcon = L.icon({\r\n           iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n           iconSize: [30, 30],\r\n"
                },
                {
                    "date": 1760623618754,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -568,8 +568,12 @@\n \r\n           marker.addTo(poiLayer);\r\n           poiMarkers.set(it.id, marker);\r\n         }\r\n+        \r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n \r\n         // --- Icons ---\r\n         const userIcon = L.icon({\r\n           iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n"
                },
                {
                    "date": 1760624269515,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -497,9 +497,12 @@\n         let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n-        let currentZoomLevel = map.getZoom();\r\n+        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n \r\n         const poiMarkers = new Map();        // id -> L.Marker\r\n         const iconCache  = {};               // category -> L.Icon\r\n         let poiBatchHandle = null;           // cancel previous batch\r\n@@ -728,37 +731,69 @@\n               cancelAnimationFrame(poiBatchHandle);\r\n               poiBatchHandle = null;\r\n             }\r\n \r\n+            const z = Number(msg.zoom) || currentZoomLevel;\r\n+            const b = msg.bbox || null;\r\n+\r\n+            // Collect desired items from payload\r\n             const desired = new Map();\r\n             for (const it of msg.items) {\r\n               if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n               desired.set(it.id, it);\r\n             }\r\n+            const desiredIds = new Set(desired.keys());\r\n \r\n-            // remove markers no longer present\r\n-            for (const [id, marker] of poiMarkers) {\r\n-              if (!desired.has(id)) {\r\n-                poiLayer.removeLayer(marker);\r\n-                poiMarkers.delete(id);\r\n+            // Decide strategy based on zoom direction\r\n+            if (z > currentZoomLevel) {\r\n+              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n+              if (b) {\r\n+                for (const [id, marker] of poiMarkers) {\r\n+                  const p = marker.getLatLng();\r\n+                  if (!bboxContains(b, p.lat, p.lng)) {\r\n+                    poiLayer.removeLayer(marker);\r\n+                    poiMarkers.delete(id);\r\n+                  }\r\n+                }\r\n               }\r\n+              // we'll only add new markers below (no blanket removal)\r\n+            } else if (z < currentZoomLevel) {\r\n+              // ---- ZOOM OUT: shrink to what backend sent\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const keep = desiredIds.has(id);\r\n+                const p = marker.getLatLng();\r\n+                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n+                if (!keep || !onScreen) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            } else {\r\n+              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const p = marker.getLatLng();\r\n+                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n+                if (drop) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n             }\r\n \r\n-            // build list of new ones to add\r\n+            // Build list of new ones to add\r\n             const toAdd = [];\r\n             for (const [id, it] of desired) {\r\n               if (!poiMarkers.has(id)) toAdd.push(it);\r\n             }\r\n \r\n-            // batched add (40 per frame is a good sweet spot)\r\n+            // Batched add (keep your sweet spot)\r\n             const BATCH = 40;\r\n             const poiIcons = ${JSON.stringify(iconData || {})};\r\n \r\n             const addBatch = (startIdx = 0) => {\r\n               for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n                 const it = toAdd[i];\r\n                 const icon = getPoiIcon(it.category, poiIcons);\r\n-\r\n                 const marker = L.marker([it.lat, it.lng], { icon });\r\n \r\n                 // popup with \"Set Destination\"\r\n                 const container = document.createElement('div');\r\n@@ -789,16 +824,18 @@\n                 poiBatchHandle = null; // done\r\n               }\r\n             };\r\n \r\n-            // start batching\r\n             addBatch(0);\r\n \r\n+            // remember zoom for next comparison\r\n+            currentZoomLevel = z;\r\n             return;\r\n           }\r\n \r\n \r\n \r\n+\r\n           // Render Landmarks (pin markers)\r\n           if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n             landmarkLayer.clearLayers();\r\n             msg.items.forEach(it => {\r\n"
                },
                {
                    "date": 1760627752150,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1657 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n+\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n+\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); \r\n+};\r\n+\r\n+\r\n+\r\n+\r\n+export default function PHome() {\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+\r\n+  function roundByZoom(value: number, zoom: number) {\r\n+    const decimals =\r\n+      zoom >= 18 ? 3 :\r\n+      zoom >= 16 ? 3 :\r\n+      zoom >= 15 ? 2 :\r\n+      /* <=14 */   2;\r\n+    const m = Math.pow(10, decimals);\r\n+    return Math.round(value * m) / m;\r\n+  }\r\n+\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+\r\n+  \r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        // 1) prefer unified auth\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  const canShowChatNotice =\r\n+    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+\r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+        console.error(\"üõë Invalid ORS response:\", data);\r\n+        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.features[0].geometry.coordinates; \r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n+\r\n+      const summary = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM = summary.distance ?? 0;\r\n+      const durationS = summary.duration ?? 0;\r\n+\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60\r\n+        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n+        : `${mins} min`;\r\n+\r\n+      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n+      const fareText = `‚Ç±${computedFare} est`;\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm, \r\n+        distanceText,     \r\n+        durationText,\r\n+        fareText,  \r\n+      });\r\n+\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n+    }\r\n+  };\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n+      try {\r\n+        const lat = location.latitude;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+\r\n+    // update UI\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n+    // draw route immediately\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest\r\n+    );\r\n+\r\n+    // (optional) update markers\r\n+    sendToMap({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    });\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      // fire once right away, so the dot appears even before watch ticks\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+      }\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          sendToMap({\r\n+            type: \"updateUserLoc\",\r\n+            latitude: pos.coords.latitude,\r\n+            longitude: pos.coords.longitude,\r\n+            accuracy: pos.coords.accuracy ?? 15,\r\n+            avatarUrl,\r\n+          });\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            sendToMap({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            });\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n+  // ---------------------------------------------------------\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+  if (!location) return;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n+\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        // --- Map init ---\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n+          noWrap: true\r\n+        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+\r\n+        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n+        }).addTo(map);\r\n+\r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n+\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n+\r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          const z = map.getZoom();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: z,\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        function addOrUpdatePOIMarker(it, poiIcons) {\r\n+          const existing = poiMarkers.get(it.id);\r\n+          if (existing) {\r\n+            // update position if it changed\r\n+            const curr = existing.getLatLng();\r\n+            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n+              existing.setLatLng([it.lat, it.lng]);\r\n+            }\r\n+            return;\r\n+          }\r\n+          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n+          const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+          // build popup with \"Set Destination\"\r\n+          const container = document.createElement('div');\r\n+          const title = document.createElement('b');\r\n+          title.textContent = it.name || it.category || 'POI';\r\n+          container.appendChild(title);\r\n+          container.appendChild(document.createElement('br'));\r\n+          const btn = document.createElement('button');\r\n+          btn.textContent = 'Set Destination';\r\n+          btn.style.marginTop = '6px';\r\n+          btn.onclick = function () {\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'setDestinationFromPOI',\r\n+              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+            }));\r\n+          };\r\n+          container.appendChild(btn);\r\n+          marker.bindPopup(container);\r\n+\r\n+          marker.addTo(poiLayer);\r\n+          poiMarkers.set(it.id, marker);\r\n+        }\r\n+        \r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n+\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n+\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n+\r\n+        // --- Helpers ---\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip( { permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+        }\r\n+\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n+\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n+\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n+\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n+\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n+\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            upsertUserMarker(msg.latitude, msg.longitude);\r\n+            return;\r\n+          }\r\n+\r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n+\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+            clearRoute();\r\n+\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n+              .setContent(label || '')\r\n+              .setLatLng(mid)\r\n+              .addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n+            }\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            // cancel any ongoing batch\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n+\r\n+            const z = Number(msg.zoom) || currentZoomLevel;\r\n+            const b = msg.bbox || null;\r\n+\r\n+            // Collect desired items from payload\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n+            const desiredIds = new Set(desired.keys());\r\n+\r\n+            // Decide strategy based on zoom direction\r\n+            if (z > currentZoomLevel) {\r\n+              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n+              if (b) {\r\n+                for (const [id, marker] of poiMarkers) {\r\n+                  const p = marker.getLatLng();\r\n+                  if (!bboxContains(b, p.lat, p.lng)) {\r\n+                    poiLayer.removeLayer(marker);\r\n+                    poiMarkers.delete(id);\r\n+                  }\r\n+                }\r\n+              }\r\n+              // we'll only add new markers below (no blanket removal)\r\n+            } else if (z < currentZoomLevel) {\r\n+              // ---- ZOOM OUT: shrink to what backend sent\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const keep = desiredIds.has(id);\r\n+                const p = marker.getLatLng();\r\n+                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n+                if (!keep || !onScreen) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            } else {\r\n+              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const p = marker.getLatLng();\r\n+                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n+                if (drop) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            }\r\n+\r\n+            // Build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n+\r\n+            // Batched add (keep your sweet spot)\r\n+            const BATCH = 40;\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+\r\n+            const addBatch = (startIdx = 0) => {\r\n+              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n+                const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+                // popup with \"Set Destination\"\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n+\r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+              }\r\n+\r\n+              if (startIdx + BATCH < toAdd.length) {\r\n+                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n+              } else {\r\n+                poiBatchHandle = null; // done\r\n+              }\r\n+            };\r\n+\r\n+            addBatch(0);\r\n+\r\n+            // remember zoom for next comparison\r\n+            currentZoomLevel = z;\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n+  }, [location, iconData]);\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+  }, [mapHtml, location, avatarUrl]);\r\n+\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = parsed.zoom ?? 15;\r\n+        if (zoom < 14) return;\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = [\r\n+          zoom,\r\n+          roundByZoom(minLng, zoom),\r\n+          roundByZoom(minLat, zoom),\r\n+          roundByZoom(maxLng, zoom),\r\n+          roundByZoom(maxLat, zoom),\r\n+        ].join('|');\r\n+\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              console.log('[CACHE] using cached POIs for', key);\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            console.log('[FETCH] requesting fresh POIs for', key);\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({\r\n+                type: 'setPOIs',\r\n+                items,\r\n+                zoom,                       \r\n+                bbox: { minLng, minLat, maxLng, maxLat },  \r\n+              });\r\n+            }\r\n+\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 750);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+    setSearching(true)\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare, paymentMethod, notes, passengerId\r\n+    };\r\n+\r\n+    try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n+\r\n+  \r\n+  \r\n+\r\n+  // Set markers & trigger route drawing when destination is picked\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+      : null;\r\n+\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+    }\r\n+\r\n+    // üëâ draw route as soon as we have both ends\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+\r\n+          setFare(0);\r\n+        }\r\n+\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n+        }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n+    };\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.searchcont}>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      setSearching(false);\r\n+                      setBookingId(null);\r\n+                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                    }}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{\r\n+                              width: 50,\r\n+                              height: 50,\r\n+                              borderRadius: 25,\r\n+                              marginRight: 10,\r\n+                            }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          {/* Chat button here */}\r\n+                          <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId: bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId: passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n+                            }}\r\n+                            style={{\r\n+                              marginTop: 8,\r\n+                              backgroundColor: \"#007bff\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 16,\r\n+                              borderRadius: 8,\r\n+                              alignSelf: \"flex-start\",\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                          </TouchableOpacity>\r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch {}\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n+                            setFare(0);\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                </ScrollView>\r\n+                <View style={styles.fareContainer}>\r\n+                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n+                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n+  panel: {\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n+  },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n+  dropdownItem: { padding: 10 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n+  \r\n+});\r\n"
                },
                {
                    "date": 1760627853008,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -115,9 +115,12 @@\n   const [showLandmarks, setShowLandmarks] = useState(false);\r\n   const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n   const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n   const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+  const inflightRef  = useRef<Set<string>>(new Set());\r\n+  const lastReqIdRef = useRef(0);\r\n \r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n@@ -1654,1644 +1657,4 @@\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n   \r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync(); // ensures we have a real file on device\r\n-  const uri = asset.localUri || asset.uri; // localUri preferred\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),          \r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-\r\n-\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1)); \r\n-  }\r\n-\r\n-\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) {\r\n-      messageQueue.current.push(json);\r\n-      return;\r\n-    }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-\r\n-  \r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        // 1) prefer unified auth\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-\r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  const canShowChatNotice =\r\n-    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n-\r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n-\r\n-      const coords = data.features[0].geometry.coordinates; \r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n-\r\n-      const summary = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM = summary.distance ?? 0;\r\n-      const durationS = summary.duration ?? 0;\r\n-\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60\r\n-        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n-        : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n-      const fareText = `‚Ç±${computedFare} est`;\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm, \r\n-        distanceText,     \r\n-        durationText,\r\n-        fareText,  \r\n-      });\r\n-\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n-    }\r\n-  };\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lng = location.longitude; // NOTE: lng\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    sendToMap({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    });\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      // fire once right away, so the dot appears even before watch ticks\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-      }\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          sendToMap({\r\n-            type: \"updateUserLoc\",\r\n-            latitude: pos.coords.latitude,\r\n-            longitude: pos.coords.longitude,\r\n-            accuracy: pos.coords.accuracy ?? 15,\r\n-            avatarUrl,\r\n-          });\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            sendToMap({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            });\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  // useEffect(() => {\r\n-  //   const backAction = () => {\r\n-  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-  //       {\r\n-  //         text: \"Logout\",\r\n-  //         onPress: async () => {\r\n-  //           await AsyncStorage.removeItem(\"passengerId\");\r\n-  //           router.replace(\"/login_and_reg/plogin\");\r\n-  //         },\r\n-  //       },\r\n-  //     ]);\r\n-  //     return true;\r\n-  //   };\r\n-  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-  //   return () => backHandler.remove();\r\n-  // }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location) return;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        // --- Map init ---\r\n-        const map = L.map('map', {\r\n-          zoomControl: true,\r\n-          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n-          maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n-          maxZoom: 19, \r\n-          noWrap: true\r\n-        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        let poiLayer = L.layerGroup().addTo(map);\r\n-        let landmarkLayer = L.layerGroup().addTo(map);\r\n-        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        const poiMarkers = new Map();        // id -> L.Marker\r\n-        const iconCache  = {};               // category -> L.Icon\r\n-        let poiBatchHandle = null;           // cancel previous batch\r\n-\r\n-        function getPoiIcon(cat, poiIcons) {\r\n-          if (iconCache[cat]) return iconCache[cat];\r\n-\r\n-          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n-            ? poiIcons[cat]\r\n-            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n-\r\n-          iconCache[cat] = L.icon({\r\n-            iconUrl: url,\r\n-            iconSize: [28, 28],\r\n-            iconAnchor: [14, 28],\r\n-          });\r\n-          return iconCache[cat];\r\n-        }\r\n-\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          const z = map.getZoom();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: z,\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        function addOrUpdatePOIMarker(it, poiIcons) {\r\n-          const existing = poiMarkers.get(it.id);\r\n-          if (existing) {\r\n-            // update position if it changed\r\n-            const curr = existing.getLatLng();\r\n-            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n-              existing.setLatLng([it.lat, it.lng]);\r\n-            }\r\n-            return;\r\n-          }\r\n-          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n-          const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-          // build popup with \"Set Destination\"\r\n-          const container = document.createElement('div');\r\n-          const title = document.createElement('b');\r\n-          title.textContent = it.name || it.category || 'POI';\r\n-          container.appendChild(title);\r\n-          container.appendChild(document.createElement('br'));\r\n-          const btn = document.createElement('button');\r\n-          btn.textContent = 'Set Destination';\r\n-          btn.style.marginTop = '6px';\r\n-          btn.onclick = function () {\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'setDestinationFromPOI',\r\n-              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-            }));\r\n-          };\r\n-          container.appendChild(btn);\r\n-          marker.bindPopup(container);\r\n-\r\n-          marker.addTo(poiLayer);\r\n-          poiMarkers.set(it.id, marker);\r\n-        }\r\n-        \r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        // --- Helpers ---\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip( { permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-        }\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        map.on('moveend', function () {\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        });\r\n-\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            upsertUserMarker(msg.latitude, msg.longitude);\r\n-            return;\r\n-          }\r\n-\r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n-            clearRoute();\r\n-\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n-              .setContent(label || '')\r\n-              .setLatLng(mid)\r\n-              .addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n-            }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-          const poiIcons = ${iconJson};\r\n-          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            // cancel any ongoing batch\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n-\r\n-            const z = Number(msg.zoom) || currentZoomLevel;\r\n-            const b = msg.bbox || null;\r\n-\r\n-            // Collect desired items from payload\r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n-            const desiredIds = new Set(desired.keys());\r\n-\r\n-            // Decide strategy based on zoom direction\r\n-            if (z > currentZoomLevel) {\r\n-              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n-              if (b) {\r\n-                for (const [id, marker] of poiMarkers) {\r\n-                  const p = marker.getLatLng();\r\n-                  if (!bboxContains(b, p.lat, p.lng)) {\r\n-                    poiLayer.removeLayer(marker);\r\n-                    poiMarkers.delete(id);\r\n-                  }\r\n-                }\r\n-              }\r\n-              // we'll only add new markers below (no blanket removal)\r\n-            } else if (z < currentZoomLevel) {\r\n-              // ---- ZOOM OUT: shrink to what backend sent\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const keep = desiredIds.has(id);\r\n-                const p = marker.getLatLng();\r\n-                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n-                if (!keep || !onScreen) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            } else {\r\n-              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const p = marker.getLatLng();\r\n-                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n-                if (drop) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            }\r\n-\r\n-            // Build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n-\r\n-            // Batched add (keep your sweet spot)\r\n-            const BATCH = 40;\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n-\r\n-            const addBatch = (startIdx = 0) => {\r\n-              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n-                const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-                // popup with \"Set Destination\"\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n-\r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-              }\r\n-\r\n-              if (startIdx + BATCH < toAdd.length) {\r\n-                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n-              } else {\r\n-                poiBatchHandle = null; // done\r\n-              }\r\n-            };\r\n-\r\n-            addBatch(0);\r\n-\r\n-            // remember zoom for next comparison\r\n-            currentZoomLevel = z;\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-\r\n-\r\n-          // Render Landmarks (pin markers)\r\n-          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n-            landmarkLayer.clearLayers();\r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n-              L.marker([it.lat, it.lng])\r\n-                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n-                .addTo(landmarkLayer);\r\n-            });\r\n-            return;\r\n-          }\r\n-          if (msg.type === 'clearLandmarks') {\r\n-            landmarkLayer.clearLayers();\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [location, iconData]);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-  }, [mapHtml, location, avatarUrl]);\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      // Always see what's coming in:\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = parsed.zoom ?? 15;\r\n-        if (zoom < 14) return;\r\n-\r\n-        const center = parsed.center;\r\n-        if (center && lastCenterRef.current) {\r\n-          const moved = haversine(lastCenterRef.current, center);\r\n-          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n-        }\r\n-        if (center) lastCenterRef.current = center;\r\n-\r\n-        const key = `${zoom}|${minLng.toFixed(3)},${minLat.toFixed(3)},${maxLng.toFixed(3)},${maxLat.toFixed(3)}`;\r\n-        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n-        lastPoiKeyRef.current = key;\r\n-\r\n-        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-        poiFetchTimerRef.current = setTimeout(async () => {\r\n-          try {\r\n-            const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-              `zoom=${zoom}`,\r\n-            ];\r\n-            if (center?.lat != null && center?.lng != null) {\r\n-              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-            }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            if (poiCacheRef.current.has(key)) {\r\n-              console.log('[CACHE] using cached POIs for', key);\r\n-              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n-              return;\r\n-            }\r\n-\r\n-            console.log('[FETCH] requesting fresh POIs for', key);\r\n-            const r = await fetch(url);\r\n-            const items = await r.json();\r\n-            if (Array.isArray(items)) {\r\n-              poiCacheRef.current.set(key, items);\r\n-              sendToMap({\r\n-                type: 'setPOIs',\r\n-                items,\r\n-                zoom,                       \r\n-                bbox: { minLng, minLat, maxLng, maxLat },  \r\n-              });\r\n-            }\r\n-\r\n-          } catch {\r\n-            sendToMap({ type: 'setPOIs', items: [] });\r\n-          }\r\n-        }, 750);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'setDestinationFromPOI') {\r\n-        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n-        setDestination(dest);\r\n-        setDropoffName(parsed.label || 'POI Destination');\r\n-\r\n-        if (!location) {\r\n-          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-          return;\r\n-        }\r\n-        const { latitude, longitude } = location;\r\n-\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          dest\r\n-        );\r\n-        sendToMap({\r\n-          type: 'setMarkers',\r\n-          destination: dest,\r\n-          driver: null,\r\n-        });\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-    setSearching(true)\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare, paymentMethod, notes, passengerId\r\n-    };\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-  // {status === \"accepted\" && bookingId && (\r\n-  //   <ChatNotice\r\n-  //     bookingId={bookingId}\r\n-  //     role=\"passenger\"\r\n-  //     onGoToChat={() =>\r\n-  //       router.push({\r\n-  //         pathname: \"/chatcomponent\",\r\n-  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-  //       })\r\n-  //     }\r\n-  //   />\r\n-  // )}\r\n-\r\n-  \r\n-  \r\n-\r\n-  // Set markers & trigger route drawing when destination is picked\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n-\r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.searchcont}>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lng}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showLandmarks) {\r\n-                  sendToMap({ type: 'clearLandmarks' });\r\n-                  setShowLandmarks(false);\r\n-                } else {\r\n-                  loadLandmarks(); // same function we made before\r\n-                  setShowLandmarks(true);\r\n-                }\r\n-              }}\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n-            </TouchableOpacity>\r\n-\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{\r\n-                              width: 50,\r\n-                              height: 50,\r\n-                              borderRadius: 25,\r\n-                              marginRight: 10,\r\n-                            }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-\r\n-                          {/* Chat button here */}\r\n-                          <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              router.push({\r\n-                                pathname: \"/ChatRoom\",\r\n-                                params: {\r\n-                                  bookingId: bookingId,\r\n-                                  driverId: matchedDriver?.driverId,\r\n-                                  passengerId: passengerId,\r\n-                                  role: \"passenger\",\r\n-                                },\r\n-                              });\r\n-                            }}\r\n-                            style={{\r\n-                              marginTop: 8,\r\n-                              backgroundColor: \"#007bff\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 16,\r\n-                              borderRadius: 8,\r\n-                              alignSelf: \"flex-start\",\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n-                          </TouchableOpacity>\r\n-                        </View>\r\n-                      </View>\r\n-\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch {}\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-                            sendToMap({ type: \"clearRoute\" });\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                </ScrollView>\r\n-                <View style={styles.fareContainer}>\r\n-                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-  \r\n-});\r\n"
                },
                {
                    "date": 1760627935273,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -946,8 +946,17 @@\n               sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n               return;\r\n             }\r\n \r\n+            if (inflightRef.current.has(key)) {\r\n+              console.log('[INFLIGHT] skip duplicate for', key);\r\n+              return;\r\n+            }\r\n+\r\n+            inflightRef.current.add(key);\r\n+            \r\n+            const reqId = ++lastReqIdRef.current;\r\n+\r\n             console.log('[FETCH] requesting fresh POIs for', key);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             if (Array.isArray(items)) {\r\n"
                },
                {
                    "date": 1760627990203,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -952,11 +952,44 @@\n               return;\r\n             }\r\n \r\n             inflightRef.current.add(key);\r\n+\r\n+            const reqId = ++lastReqIdRef.current;\r\n             \r\n-            const reqId = ++lastReqIdRef.current;\r\n+            try {\r\n+              const qs: string[] = [\r\n+                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+                `zoom=${zoom}`,\r\n+              ];\r\n+              if (center?.lat != null && center?.lng != null) {\r\n+                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+              }\r\n+              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n \r\n+              console.log('[FETCH] requesting fresh POIs for', key);\r\n+              const r = await fetch(url);\r\n+              const items = await r.json();\r\n+\r\n+              if (reqId !== lastReqIdRef.current) {\r\n+                console.log('[STALE] dropping older response for', key);\r\n+                return; // a newer request finished after this one\r\n+              }\r\n+\r\n+              if (Array.isArray(items)) {\r\n+                poiCacheRef.current.set(key, items);\r\n+                sendToMap({ type: 'setPOIs', items });\r\n+              } else {\r\n+                sendToMap({ type: 'setPOIs', items: [] });\r\n+              }\r\n+            } catch (e) {\r\n+              console.log('[ERR] POI fetch failed for', key, e);\r\n+              sendToMap({ type: 'setPOIs', items: [] });\r\n+            } finally {\r\n+              inflightRef.current.delete(key);\r\n+            }\r\n+            \r\n             console.log('[FETCH] requesting fresh POIs for', key);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             if (Array.isArray(items)) {\r\n"
                },
                {
                    "date": 1760628318279,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -738,9 +738,8 @@\n           }\r\n \r\n           const poiIcons = ${iconJson};\r\n           if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            // cancel any ongoing batch\r\n             if (poiBatchHandle) {\r\n               cancelAnimationFrame(poiBatchHandle);\r\n               poiBatchHandle = null;\r\n             }\r\n@@ -767,9 +766,8 @@\n                     poiMarkers.delete(id);\r\n                   }\r\n                 }\r\n               }\r\n-              // we'll only add new markers below (no blanket removal)\r\n             } else if (z < currentZoomLevel) {\r\n               // ---- ZOOM OUT: shrink to what backend sent\r\n               for (const [id, marker] of poiMarkers) {\r\n                 const keep = desiredIds.has(id);\r\n@@ -797,19 +795,27 @@\n             for (const [id, it] of desired) {\r\n               if (!poiMarkers.has(id)) toAdd.push(it);\r\n             }\r\n \r\n-            // Batched add (keep your sweet spot)\r\n-            const BATCH = 40;\r\n+            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n+            const total = toAdd.length;\r\n+            const BATCH =\r\n+              total > 300 ? 80 :\r\n+              total > 150 ? 50 :\r\n+              total > 60  ? 35 :\r\n+              25; // small = faster draw\r\n+            const DELAY = total > 150 ? 12 : 6;\r\n+\r\n             const poiIcons = ${JSON.stringify(iconData || {})};\r\n \r\n-            const addBatch = (startIdx = 0) => {\r\n-              for (let i = startIdx; i < Math.min(startIdx + BATCH, toAdd.length); i++) {\r\n+            let i = 0;\r\n+            const addBatch = () => {\r\n+              const end = Math.min(i + BATCH, total);\r\n+              for (; i < end; i++) {\r\n                 const it = toAdd[i];\r\n                 const icon = getPoiIcon(it.category, poiIcons);\r\n                 const marker = L.marker([it.lat, it.lng], { icon });\r\n \r\n-                // popup with \"Set Destination\"\r\n                 const container = document.createElement('div');\r\n                 const title = document.createElement('b');\r\n                 title.textContent = it.name || it.category || 'POI';\r\n                 container.appendChild(title);\r\n@@ -830,25 +836,25 @@\n                 marker.addTo(poiLayer);\r\n                 poiMarkers.set(it.id, marker);\r\n               }\r\n \r\n-              if (startIdx + BATCH < toAdd.length) {\r\n-                poiBatchHandle = requestAnimationFrame(() => addBatch(startIdx + BATCH));\r\n+              if (i < total) {\r\n+                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n               } else {\r\n-                poiBatchHandle = null; // done\r\n+                poiBatchHandle = null;\r\n               }\r\n             };\r\n \r\n-            addBatch(0);\r\n+            addBatch();\r\n \r\n-            // remember zoom for next comparison\r\n             currentZoomLevel = z;\r\n             return;\r\n           }\r\n \r\n \r\n \r\n \r\n+\r\n           // Render Landmarks (pin markers)\r\n           if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n             landmarkLayer.clearLayers();\r\n             msg.items.forEach(it => {\r\n@@ -987,9 +993,9 @@\n               sendToMap({ type: 'setPOIs', items: [] });\r\n             } finally {\r\n               inflightRef.current.delete(key);\r\n             }\r\n-            \r\n+\r\n             console.log('[FETCH] requesting fresh POIs for', key);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             if (Array.isArray(items)) {\r\n"
                },
                {
                    "date": 1760628604573,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -812,9 +812,9 @@\n               const end = Math.min(i + BATCH, total);\r\n               for (; i < end; i++) {\r\n                 const it = toAdd[i];\r\n                 const icon = getPoiIcon(it.category, poiIcons);\r\n-                const marker = L.marker([it.lat, it.lng], { icon });\r\n+                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n \r\n                 const container = document.createElement('div');\r\n                 const title = document.createElement('b');\r\n                 title.textContent = it.name || it.category || 'POI';\r\n@@ -834,8 +834,21 @@\n \r\n                 marker.bindPopup(container);\r\n                 marker.addTo(poiLayer);\r\n                 poiMarkers.set(it.id, marker);\r\n+\r\n+                // üî• Fade-in animation\r\n+                let op = 0;\r\n+                const fade = () => {\r\n+                  op += 0.15;\r\n+                  if (op <= 1) {\r\n+                    marker.setOpacity(op);\r\n+                    requestAnimationFrame(fade);\r\n+                  } else {\r\n+                    marker.setOpacity(1);\r\n+                  }\r\n+                };\r\n+                requestAnimationFrame(fade);\r\n               }\r\n \r\n               if (i < total) {\r\n                 poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n@@ -843,8 +856,9 @@\n                 poiBatchHandle = null;\r\n               }\r\n             };\r\n \r\n+\r\n             addBatch();\r\n \r\n             currentZoomLevel = z;\r\n             return;\r\n"
                },
                {
                    "date": 1760628668832,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -802,9 +802,9 @@\n               total > 300 ? 80 :\r\n               total > 150 ? 50 :\r\n               total > 60  ? 35 :\r\n               25; // small = faster draw\r\n-            const DELAY = total > 150 ? 12 : 6;\r\n+            const DELAY = total > 150 ? 20 : 10;\r\n \r\n             const poiIcons = ${JSON.stringify(iconData || {})};\r\n \r\n             let i = 0;\r\n"
                },
                {
                    "date": 1760631612785,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -117,10 +117,12 @@\n   const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n   const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n   const inflightRef  = useRef<Set<string>>(new Set());\r\n   const lastReqIdRef = useRef(0);\r\n+  const [showPOIs, setShowPOIs] = useState(false);\r\n \r\n \r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n"
                },
                {
                    "date": 1760631756179,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -536,24 +536,8 @@\n           });\r\n           return iconCache[cat];\r\n         }\r\n \r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          const z = map.getZoom();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: z,\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n         function addOrUpdatePOIMarker(it, poiIcons) {\r\n           const existing = poiMarkers.get(it.id);\r\n           if (existing) {\r\n             // update position if it changed\r\n"
                },
                {
                    "date": 1760631945369,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1407,9 +1407,32 @@\n               }}\r\n             >\r\n               <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n             </TouchableOpacity>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showPOIs) {\r\n+                  // turn OFF\r\n+                  setShowPOIs(false);\r\n+                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                  sendToMap({ type: 'setPOIs', items: [] }); // clear layer\r\n+                } else {\r\n+                  setShowPOIs(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n+            </TouchableOpacity>\r\n \r\n+\r\n           </View>\r\n \r\n           <View style={styles.overlayContainer}>\r\n             <View style={styles.overlay}>\r\n"
                },
                {
                    "date": 1760632091377,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -914,9 +914,12 @@\n       }\r\n       if (parsed.type === 'bbox' && parsed.bbox) {\r\n         const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n         const zoom = parsed.zoom ?? 15;\r\n-        if (zoom < 14) return;\r\n+        if (!showPOIs || zoom < 14) {\r\n+          sendToMap({ type: 'setPOIs', items: [] });\r\n+          return;\r\n+        };\r\n \r\n         const center = parsed.center;\r\n         if (center && lastCenterRef.current) {\r\n           const moved = haversine(lastCenterRef.current, center);\r\n"
                },
                {
                    "date": 1760632156045,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -913,9 +913,9 @@\n         }\r\n       }\r\n       if (parsed.type === 'bbox' && parsed.bbox) {\r\n         const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = parsed.zoom ?? 15;\r\n+        const zoom = Number(parsed.zoom) || 0;\r\n         if (!showPOIs || zoom < 14) {\r\n           sendToMap({ type: 'setPOIs', items: [] });\r\n           return;\r\n         };\r\n@@ -1013,9 +1013,9 @@\n \r\n           } catch {\r\n             sendToMap({ type: 'setPOIs', items: [] });\r\n           }\r\n-        }, 750);\r\n+        }, 500);\r\n         return;\r\n       }\r\n       if (parsed.type === 'setDestinationFromPOI') {\r\n         const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n"
                },
                {
                    "date": 1760632669047,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -118,11 +118,13 @@\n   const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n   const inflightRef  = useRef<Set<string>>(new Set());\r\n   const lastReqIdRef = useRef(0);\r\n   const [showPOIs, setShowPOIs] = useState(false);\r\n+  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n \r\n \r\n \r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n@@ -914,8 +916,9 @@\n       }\r\n       if (parsed.type === 'bbox' && parsed.bbox) {\r\n         const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n         const zoom = Number(parsed.zoom) || 0;\r\n+        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n         if (!showPOIs || zoom < 14) {\r\n           sendToMap({ type: 'setPOIs', items: [] });\r\n           return;\r\n         };\r\n"
                },
                {
                    "date": 1760632733650,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -724,8 +724,23 @@\n \r\n             return;\r\n           }\r\n \r\n+          if (msg.type === 'requestBbox') {\r\n+            const b = map.getBounds();\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'bbox',\r\n+              bbox: {\r\n+                minLng: b.getWest(),\r\n+                minLat: b.getSouth(),\r\n+                maxLng: b.getEast(),\r\n+                maxLat: b.getNorth()\r\n+              },\r\n+              zoom: map.getZoom()\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n           const poiIcons = ${iconJson};\r\n           if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n             if (poiBatchHandle) {\r\n               cancelAnimationFrame(poiBatchHandle);\r\n"
                },
                {
                    "date": 1760632821736,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1431,16 +1431,38 @@\n             </TouchableOpacity>\r\n             <TouchableOpacity\r\n               onPress={() => {\r\n                 if (showPOIs) {\r\n-                  // turn OFF\r\n                   setShowPOIs(false);\r\n                   if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                  sendToMap({ type: 'setPOIs', items: [] }); // clear layer\r\n+                  sendToMap({ type: 'setPOIs', items: [] });\r\n                 } else {\r\n                   setShowPOIs(true);\r\n+                  const b = lastBBoxRef.current;\r\n+                  if (b) {\r\n+                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n+                    if (zoom >= 14) {\r\n+                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                      poiFetchTimerRef.current = setTimeout(async () => {\r\n+                        try {\r\n+                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n+                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n+                          const r = await fetch(url);\r\n+                          const items = await r.json();\r\n+                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+                        } catch {\r\n+                          sendToMap({ type: 'setPOIs', items: [] });\r\n+                        }\r\n+                      }, 0);\r\n+                    } else {\r\n+                      sendToMap({ type: 'setPOIs', items: [] });\r\n+                    }\r\n+                  } else {\r\n+                    sendToMap({ type: 'requestBbox' });\r\n+                  }\r\n                 }\r\n               }}\r\n+\r\n               style={{\r\n                 alignSelf: 'center',\r\n                 marginTop: 6,\r\n                 backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n"
                },
                {
                    "date": 1760787801696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -119,12 +119,16 @@\n   const inflightRef  = useRef<Set<string>>(new Set());\r\n   const lastReqIdRef = useRef(0);\r\n   const [showPOIs, setShowPOIs] = useState(false);\r\n   const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n+  // --- Booking type + party size ---\r\n+  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n+  const [partySize, setPartySize] = useState<number>(1);\r\n \r\n \r\n \r\n \r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n"
                },
                {
                    "date": 1760787837512,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -124,11 +124,8 @@\n   const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n   const [partySize, setPartySize] = useState<number>(1);\r\n \r\n \r\n-\r\n-\r\n-\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n@@ -1073,17 +1070,32 @@\n       Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n       router.replace(\"/login_and_reg/plogin\");\r\n       return;\r\n     }\r\n-    setSearching(true)\r\n+\r\n+    // Normalize party size based on type\r\n+    const normalizedParty =\r\n+      bookingType === 'GROUP'\r\n+        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n+        : 1; // CLASSIC & SOLO always 1\r\n+\r\n+    setSearching(true);\r\n     setAlertedBookingComplete(false);\r\n     setTripCompleted(false);\r\n+\r\n     const bookingData = {\r\n       pickupLat: location.latitude,\r\n       pickupLng: location.longitude,\r\n       destinationLat: destination.latitude,\r\n       destinationLng: destination.longitude,\r\n-      fare, paymentMethod, notes, passengerId\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId,\r\n+\r\n+      // NEW: booking type + group seats\r\n+      bookingType,\r\n+      partySize: normalizedParty,\r\n     };\r\n \r\n     try {\r\n       // reset any old polling\r\n@@ -1102,14 +1114,16 @@\n       });\r\n \r\n       const result = await response.json();\r\n       if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n       setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n     } catch (e: any) {\r\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n+\r\n   // {status === \"accepted\" && bookingId && (\r\n   //   <ChatNotice\r\n   //     bookingId={bookingId}\r\n   //     role=\"passenger\"\r\n"
                },
                {
                    "date": 1760787911224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1621,24 +1621,109 @@\n \r\n             {showBookingForm && (\r\n               <View style={styles.panel}>\r\n                 <Text style={styles.panelTitle}>Booking Details</Text>\r\n+\r\n+                {/* Booking Type Selector */}\r\n+                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n+                  {[\r\n+                    { key: 'CLASSIC', label: 'Classic' },\r\n+                    { key: 'GROUP', label: 'Group' },\r\n+                    { key: 'SOLO', label: 'Solo (VIP)' },\r\n+                  ].map((opt) => {\r\n+                    const active = bookingType === (opt.key as any);\r\n+                    return (\r\n+                      <TouchableOpacity\r\n+                        key={opt.key}\r\n+                        onPress={() => {\r\n+                          setBookingType(opt.key as any);\r\n+                          if (opt.key !== 'GROUP') setPartySize(1);\r\n+                        }}\r\n+                        style={{\r\n+                          flex: 1,\r\n+                          backgroundColor: active ? '#111' : '#fff',\r\n+                          borderWidth: 1,\r\n+                          borderColor: active ? '#111' : '#ccc',\r\n+                          paddingVertical: 10,\r\n+                          borderRadius: 10,\r\n+                          alignItems: 'center',\r\n+                        }}\r\n+                      >\r\n+                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n+                          {opt.label}\r\n+                        </Text>\r\n+                      </TouchableOpacity>\r\n+                    );\r\n+                  })}\r\n+                </View>\r\n+\r\n+                {/* Notes for Solo & Group */}\r\n+                {bookingType === 'SOLO' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n+                  </Text>\r\n+                )}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n+                  </Text>\r\n+                )}\r\n+\r\n+                {/* Group Party Size Stepper */}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (1‚Äì5)</Text>\r\n+                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.max(1, p - 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n+                      </TouchableOpacity>\r\n+                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.min(5, p + 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+                )}\r\n+\r\n                 <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n                   <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n                   <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  <TextInput style={styles.input} placeholder=\"Name this location (optional: Home, Work, etc.)\" value={destinationLabel} onChangeText={setDestinationLabel} />\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  />\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n                   <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n                 </ScrollView>\r\n+\r\n                 <View style={styles.fareContainer}>\r\n-                  <Text style={styles.totalFare}>Total Fare: ‚Ç±{fare}</Text>\r\n-                  <TouchableOpacity style={styles.bookButton} onPress={handleBookNow}>\r\n+                  <Text style={styles.totalFare}>\r\n+                    Total Fare: ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `(x${partySize})` : ''}\r\n+                  </Text>\r\n+                  <TouchableOpacity\r\n+                    style={[\r\n+                      styles.bookButton,\r\n+                      // disable if invalid group count or no destination\r\n+                      ((bookingType === 'GROUP' && (partySize < 1 || partySize > 5)) || !destination) && { opacity: 0.4 },\r\n+                    ]}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 1 || partySize > 5)) || !destination}\r\n+                    onPress={handleBookNow}\r\n+                  >\r\n                     <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n                   </TouchableOpacity>\r\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n+\r\n             {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n               <TouchableOpacity\r\n                 onPress={() => setShowBookingForm(true)}\r\n                 style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n"
                },
                {
                    "date": 1760788034443,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1499,9 +1499,11 @@\n             <View style={styles.overlay}>\r\n \r\n               {searching && (\r\n                 <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>üîç Finding a driver...</Text>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>\r\n+                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n+                  </Text>\r\n                   <TouchableOpacity\r\n                     onPress={() => {\r\n                       setSearching(false);\r\n                       setBookingId(null);\r\n"
                },
                {
                    "date": 1760794178514,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1629,9 +1629,9 @@\n                 <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n                   {[\r\n                     { key: 'CLASSIC', label: 'Classic' },\r\n                     { key: 'GROUP', label: 'Group' },\r\n-                    { key: 'SOLO', label: 'Solo (VIP)' },\r\n+                    { key: 'SOLO', label: 'Solo' },\r\n                   ].map((opt) => {\r\n                     const active = bookingType === (opt.key as any);\r\n                     return (\r\n                       <TouchableOpacity\r\n"
                },
                {
                    "date": 1760794353830,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1672,9 +1672,9 @@\n \r\n                 {/* Group Party Size Stepper */}\r\n                 {bookingType === 'GROUP' && (\r\n                   <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n-                    <Text style={{ fontWeight: '600' }}>Passengers (1‚Äì5)</Text>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n                     <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                       <TouchableOpacity\r\n                         onPress={() => setPartySize((p) => Math.max(1, p - 1))}\r\n                         style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n"
                },
                {
                    "date": 1760794384234,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1675,9 +1675,9 @@\n                   <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n                     <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n                     <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n                       <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.max(1, p - 1))}\r\n+                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n                         style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n                       >\r\n                         <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n                       </TouchableOpacity>\r\n"
                },
                {
                    "date": 1760794433057,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1682,9 +1682,9 @@\n                         <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n                       </TouchableOpacity>\r\n                       <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n                       <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.min(5, p + 1))}\r\n+                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n                         style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n                       >\r\n                         <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n                       </TouchableOpacity>\r\n"
                },
                {
                    "date": 1760794466963,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1712,11 +1712,11 @@\n                   <TouchableOpacity\r\n                     style={[\r\n                       styles.bookButton,\r\n                       // disable if invalid group count or no destination\r\n-                      ((bookingType === 'GROUP' && (partySize < 1 || partySize > 5)) || !destination) && { opacity: 0.4 },\r\n+                      ((bookingType === 'GROUP' && (partySize < 1 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n                     ]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 1 || partySize > 5)) || !destination}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 1 || partySize > 6)) || !destination}\r\n                     onPress={handleBookNow}\r\n                   >\r\n                     <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n                   </TouchableOpacity>\r\n"
                },
                {
                    "date": 1760795050089,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -121,9 +121,9 @@\n   const [showPOIs, setShowPOIs] = useState(false);\r\n   const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n   // --- Booking type + party size ---\r\n   const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n-  const [partySize, setPartySize] = useState<number>(1);\r\n+  const [partySize, setPartySize] = useState<number>(2);\r\n \r\n \r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n"
                },
                {
                    "date": 1760796024389,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1592,15 +1592,21 @@\n \r\n                         <TouchableOpacity\r\n                           onPress={async () => {\r\n                             try {\r\n-                              await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                              console.log(\"[PHOME] Cancel pressed, bookingId=\", bookingId);\r\n+                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n                                 method: \"POST\",\r\n                                 headers: { \"Content-Type\": \"application/json\" },\r\n                                 body: JSON.stringify({ bookingId }),\r\n                               });\r\n+                              const body = await resp.text();\r\n+                              console.log(\"[PHOME] /cancel-booking resp\", resp.status, body.slice(0, 300));\r\n+\r\n                               await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch {}\r\n+                            } catch (e) {\r\n+                              console.log(\"[PHOME] cancel error\", e);\r\n+                            }\r\n                             setSearching(false);\r\n                             setBookingId(null);\r\n                             setMatchedDriver(null);\r\n                             setDestination(null);\r\n"
                },
                {
                    "date": 1760796333831,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1299,8 +1299,49 @@\n     };\r\n     loadBookingState();\r\n   }, []);\r\n \r\n+\r\n+  const cancelRideNow = async () => {\r\n+    try {\r\n+      console.log(\"[PHOME] Cancel pressed, bookingId=\", bookingId);\r\n+\r\n+      if (!bookingId) {\r\n+        console.log(\"[PHOME] No bookingId in state ‚Äî nothing to cancel.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ bookingId }),\r\n+      });\r\n+      const body = await resp.text();\r\n+      console.log(\"[PHOME] /cancel-booking resp\", resp.status, body.slice(0, 300));\r\n+\r\n+      // UI reset after server confirms\r\n+      setSearching(false);\r\n+      setBookingId(null);\r\n+      setMatchedDriver(null);\r\n+      setBookingConfirmed(false);\r\n+      setDestination(null);\r\n+      setTripCompleted(false);\r\n+      setAlertedBookingComplete(false);\r\n+      setShowBookingForm(false);\r\n+\r\n+      // Clear map + cached state\r\n+      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+      sendToMap({ type: \"clearRoute\" });\r\n+      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+      setFare(0);\r\n+    } catch (e) {\r\n+      console.log(\"[PHOME] cancel error\", e);\r\n+      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n   const submitDriverRating = async () => {\r\n     try {\r\n       const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n       const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n@@ -1503,13 +1544,9 @@\n                   <Text style={{ fontWeight: \"bold\" }}>\r\n                     üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n                   </Text>\r\n                   <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      setSearching(false);\r\n-                      setBookingId(null);\r\n-                      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                    }}\r\n+                    onPress={cancelRideNow}\r\n                     style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n                   >\r\n                     <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n                   </TouchableOpacity>\r\n"
                },
                {
                    "date": 1760960976323,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -64,8 +64,36 @@\n \r\n \r\n \r\n export default function PHome() {\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n   const { location, loading } = useLocation();\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n@@ -174,37 +202,9 @@\n       messageQueue.current = [];\r\n     }\r\n   }, [mapReady]);\r\n \r\n-  \r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        // 1) prefer unified auth\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n \r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n   const canShowChatNotice =\r\n     bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n@@ -969,15 +969,13 @@\n               qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n             }\r\n             const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n             if (poiCacheRef.current.has(key)) {\r\n-              console.log('[CACHE] using cached POIs for', key);\r\n               sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n               return;\r\n             }\r\n \r\n             if (inflightRef.current.has(key)) {\r\n-              console.log('[INFLIGHT] skip duplicate for', key);\r\n               return;\r\n             }\r\n \r\n             inflightRef.current.add(key);\r\n@@ -994,14 +992,12 @@\n                 qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n               }\r\n               const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n \r\n-              console.log('[FETCH] requesting fresh POIs for', key);\r\n               const r = await fetch(url);\r\n               const items = await r.json();\r\n \r\n               if (reqId !== lastReqIdRef.current) {\r\n-                console.log('[STALE] dropping older response for', key);\r\n                 return; // a newer request finished after this one\r\n               }\r\n \r\n               if (Array.isArray(items)) {\r\n@@ -1015,10 +1011,8 @@\n               sendToMap({ type: 'setPOIs', items: [] });\r\n             } finally {\r\n               inflightRef.current.delete(key);\r\n             }\r\n-\r\n-            console.log('[FETCH] requesting fresh POIs for', key);\r\n             const r = await fetch(url);\r\n             const items = await r.json();\r\n             if (Array.isArray(items)) {\r\n               poiCacheRef.current.set(key, items);\r\n@@ -1302,12 +1296,9 @@\n \r\n \r\n   const cancelRideNow = async () => {\r\n     try {\r\n-      console.log(\"[PHOME] Cancel pressed, bookingId=\", bookingId);\r\n-\r\n       if (!bookingId) {\r\n-        console.log(\"[PHOME] No bookingId in state ‚Äî nothing to cancel.\");\r\n         return;\r\n       }\r\n \r\n       const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n@@ -1315,9 +1306,8 @@\n         headers: { \"Content-Type\": \"application/json\" },\r\n         body: JSON.stringify({ bookingId }),\r\n       });\r\n       const body = await resp.text();\r\n-      console.log(\"[PHOME] /cancel-booking resp\", resp.status, body.slice(0, 300));\r\n \r\n       // UI reset after server confirms\r\n       setSearching(false);\r\n       setBookingId(null);\r\n@@ -1629,16 +1619,14 @@\n \r\n                         <TouchableOpacity\r\n                           onPress={async () => {\r\n                             try {\r\n-                              console.log(\"[PHOME] Cancel pressed, bookingId=\", bookingId);\r\n                               const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n                                 method: \"POST\",\r\n                                 headers: { \"Content-Type\": \"application/json\" },\r\n                                 body: JSON.stringify({ bookingId }),\r\n                               });\r\n                               const body = await resp.text();\r\n-                              console.log(\"[PHOME] /cancel-booking resp\", resp.status, body.slice(0, 300));\r\n \r\n                               await AsyncStorage.removeItem(\"phomeBookingState\");\r\n                             } catch (e) {\r\n                               console.log(\"[PHOME] cancel error\", e);\r\n@@ -1680,9 +1668,9 @@\n                       <TouchableOpacity\r\n                         key={opt.key}\r\n                         onPress={() => {\r\n                           setBookingType(opt.key as any);\r\n-                          if (opt.key !== 'GROUP') setPartySize(1);\r\n+                          if (opt.key !== 'GROUP') setPartySize(2);\r\n                         }}\r\n                         style={{\r\n                           flex: 1,\r\n                           backgroundColor: active ? '#111' : '#fff',\r\n@@ -1735,31 +1723,42 @@\n                   </View>\r\n                 )}\r\n \r\n                 <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <Text>From:</Text>\r\n                   <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <Text>To:</Text>\r\n                   <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  <TextInput\r\n+                  {/* <TextInput\r\n                     style={styles.input}\r\n                     placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n                     value={destinationLabel}\r\n                     onChangeText={setDestinationLabel}\r\n-                  />\r\n+                  /> */}\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n                   <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n                 </ScrollView>\r\n \r\n                 <View style={styles.fareContainer}>\r\n-                  <Text style={styles.totalFare}>\r\n-                    Total Fare: ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `(x${partySize})` : ''}\r\n-                  </Text>\r\n+                  <View>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Fare:\r\n+                    </Text>\r\n+                    <Text style={{ paddingLeft: 20 }}>\r\n+                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n+                    </Text>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Total Fare: ‚Ç±\r\n+                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n+                    </Text>\r\n+                  </View>\r\n                   <TouchableOpacity\r\n                     style={[\r\n                       styles.bookButton,\r\n                       // disable if invalid group count or no destination\r\n-                      ((bookingType === 'GROUP' && (partySize < 1 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n+                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n                     ]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 1 || partySize > 6)) || !destination}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n                     onPress={handleBookNow}\r\n                   >\r\n                     <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n                   </TouchableOpacity>\r\n@@ -1889,9 +1888,9 @@\n   },\r\n   panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n   inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n   input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n   ratingModalOverlay: {\r\n     position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n     backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n   },\r\n"
                },
                {
                    "date": 1760987973463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1937 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n+\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n+\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); \r\n+};\r\n+\r\n+\r\n+\r\n+\r\n+export default function PHome() {\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+  const inflightRef  = useRef<Set<string>>(new Set());\r\n+  const lastReqIdRef = useRef(0);\r\n+  const [showPOIs, setShowPOIs] = useState(false);\r\n+  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n+  // --- Booking type + party size ---\r\n+  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n+  const [partySize, setPartySize] = useState<number>(2);\r\n+\r\n+\r\n+  function roundByZoom(value: number, zoom: number) {\r\n+    const decimals =\r\n+      zoom >= 18 ? 3 :\r\n+      zoom >= 16 ? 3 :\r\n+      zoom >= 15 ? 2 :\r\n+      /* <=14 */   2;\r\n+    const m = Math.pow(10, decimals);\r\n+    return Math.round(value * m) / m;\r\n+  }\r\n+\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+\r\n+\r\n+  const canShowChatNotice =\r\n+    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+\r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+        console.error(\"üõë Invalid ORS response:\", data);\r\n+        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.features[0].geometry.coordinates; \r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n+\r\n+      const summary = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM = summary.distance ?? 0;\r\n+      const durationS = summary.duration ?? 0;\r\n+\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60\r\n+        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n+        : `${mins} min`;\r\n+\r\n+      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n+      const fareText = `‚Ç±${computedFare} est`;\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm, \r\n+        distanceText,     \r\n+        durationText,\r\n+        fareText,  \r\n+      });\r\n+\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n+    }\r\n+  };\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n+      try {\r\n+        const lat = location.latitude;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+\r\n+    // update UI\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n+    // draw route immediately\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest\r\n+    );\r\n+\r\n+    // (optional) update markers\r\n+    sendToMap({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    });\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      // fire once right away, so the dot appears even before watch ticks\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+      }\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          sendToMap({\r\n+            type: \"updateUserLoc\",\r\n+            latitude: pos.coords.latitude,\r\n+            longitude: pos.coords.longitude,\r\n+            accuracy: pos.coords.accuracy ?? 15,\r\n+            avatarUrl,\r\n+          });\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            sendToMap({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            });\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n+  // ---------------------------------------------------------\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+  if (!location) return;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n+\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        // --- Map init ---\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n+          noWrap: true\r\n+        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n+\r\n+\r\n+        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n+        }).addTo(map);\r\n+\r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n+\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n+\r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        let userMarker = null;\r\n+        let userMarkerPlaced = false; \r\n+\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip({ permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+          userMarkerPlaced = true; \r\n+        }\r\n+\r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+        function addOrUpdatePOIMarker(it, poiIcons) {\r\n+          const existing = poiMarkers.get(it.id);\r\n+          if (existing) {\r\n+            // update position if it changed\r\n+            const curr = existing.getLatLng();\r\n+            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n+              existing.setLatLng([it.lat, it.lng]);\r\n+            }\r\n+            return;\r\n+          }\r\n+          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n+          const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+          // build popup with \"Set Destination\"\r\n+          const container = document.createElement('div');\r\n+          const title = document.createElement('b');\r\n+          title.textContent = it.name || it.category || 'POI';\r\n+          container.appendChild(title);\r\n+          container.appendChild(document.createElement('br'));\r\n+          const btn = document.createElement('button');\r\n+          btn.textContent = 'Set Destination';\r\n+          btn.style.marginTop = '6px';\r\n+          btn.onclick = function () {\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'setDestinationFromPOI',\r\n+              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+            }));\r\n+          };\r\n+          container.appendChild(btn);\r\n+          marker.bindPopup(container);\r\n+\r\n+          marker.addTo(poiLayer);\r\n+          poiMarkers.set(it.id, marker);\r\n+        }\r\n+        \r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n+\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n+\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n+\r\n+        // --- Helpers ---\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip( { permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+        }\r\n+\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n+\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n+\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n+\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n+\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n+\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            upsertUserMarker(msg.latitude, msg.longitude);\r\n+            return;\r\n+          }\r\n+\r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n+\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+            clearRoute();\r\n+\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n+              .setContent(label || '')\r\n+              .setLatLng(mid)\r\n+              .addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n+            }\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+          if (msg.type === 'requestBbox') {\r\n+            const b = map.getBounds();\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'bbox',\r\n+              bbox: {\r\n+                minLng: b.getWest(),\r\n+                minLat: b.getSouth(),\r\n+                maxLng: b.getEast(),\r\n+                maxLat: b.getNorth()\r\n+              },\r\n+              zoom: map.getZoom()\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n+\r\n+            const z = Number(msg.zoom) || currentZoomLevel;\r\n+            const b = msg.bbox || null;\r\n+\r\n+            // Collect desired items from payload\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n+            const desiredIds = new Set(desired.keys());\r\n+\r\n+            // Decide strategy based on zoom direction\r\n+            if (z > currentZoomLevel) {\r\n+              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n+              if (b) {\r\n+                for (const [id, marker] of poiMarkers) {\r\n+                  const p = marker.getLatLng();\r\n+                  if (!bboxContains(b, p.lat, p.lng)) {\r\n+                    poiLayer.removeLayer(marker);\r\n+                    poiMarkers.delete(id);\r\n+                  }\r\n+                }\r\n+              }\r\n+            } else if (z < currentZoomLevel) {\r\n+              // ---- ZOOM OUT: shrink to what backend sent\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const keep = desiredIds.has(id);\r\n+                const p = marker.getLatLng();\r\n+                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n+                if (!keep || !onScreen) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            } else {\r\n+              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const p = marker.getLatLng();\r\n+                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n+                if (drop) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            }\r\n+\r\n+            // Build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n+\r\n+            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n+            const total = toAdd.length;\r\n+            const BATCH =\r\n+              total > 300 ? 80 :\r\n+              total > 150 ? 50 :\r\n+              total > 60  ? 35 :\r\n+              25; // small = faster draw\r\n+            const DELAY = total > 150 ? 20 : 10;\r\n+\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+\r\n+            let i = 0;\r\n+            const addBatch = () => {\r\n+              const end = Math.min(i + BATCH, total);\r\n+              for (; i < end; i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n+                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n+\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n+\r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+\r\n+                // üî• Fade-in animation\r\n+                let op = 0;\r\n+                const fade = () => {\r\n+                  op += 0.15;\r\n+                  if (op <= 1) {\r\n+                    marker.setOpacity(op);\r\n+                    requestAnimationFrame(fade);\r\n+                  } else {\r\n+                    marker.setOpacity(1);\r\n+                  }\r\n+                };\r\n+                requestAnimationFrame(fade);\r\n+              }\r\n+\r\n+              if (i < total) {\r\n+                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n+              } else {\r\n+                poiBatchHandle = null;\r\n+              }\r\n+            };\r\n+\r\n+\r\n+            addBatch();\r\n+\r\n+            currentZoomLevel = z;\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n+  }, [location, iconData]);\r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+  }, [mapHtml, location, avatarUrl]);\r\n+\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = Number(parsed.zoom) || 0;\r\n+        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n+        if (!showPOIs || zoom < 14) {\r\n+          sendToMap({ type: 'setPOIs', items: [] });\r\n+          return;\r\n+        };\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = [\r\n+          zoom,\r\n+          roundByZoom(minLng, zoom),\r\n+          roundByZoom(minLat, zoom),\r\n+          roundByZoom(maxLng, zoom),\r\n+          roundByZoom(maxLat, zoom),\r\n+        ].join('|');\r\n+\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            if (inflightRef.current.has(key)) {\r\n+              return;\r\n+            }\r\n+\r\n+            inflightRef.current.add(key);\r\n+\r\n+            const reqId = ++lastReqIdRef.current;\r\n+            \r\n+            try {\r\n+              const qs: string[] = [\r\n+                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+                `zoom=${zoom}`,\r\n+              ];\r\n+              if (center?.lat != null && center?.lng != null) {\r\n+                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+              }\r\n+              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+\r\n+              const r = await fetch(url);\r\n+              const items = await r.json();\r\n+\r\n+              if (reqId !== lastReqIdRef.current) {\r\n+                return; // a newer request finished after this one\r\n+              }\r\n+\r\n+              if (Array.isArray(items)) {\r\n+                poiCacheRef.current.set(key, items);\r\n+                sendToMap({ type: 'setPOIs', items });\r\n+              } else {\r\n+                sendToMap({ type: 'setPOIs', items: [] });\r\n+              }\r\n+            } catch (e) {\r\n+              console.log('[ERR] POI fetch failed for', key, e);\r\n+              sendToMap({ type: 'setPOIs', items: [] });\r\n+            } finally {\r\n+              inflightRef.current.delete(key);\r\n+            }\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({\r\n+                type: 'setPOIs',\r\n+                items,\r\n+                zoom,                       \r\n+                bbox: { minLng, minLat, maxLng, maxLat },  \r\n+              });\r\n+            }\r\n+\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 500);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+\r\n+    // Normalize party size based on type\r\n+    const normalizedParty =\r\n+      bookingType === 'GROUP'\r\n+        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n+        : 1; // CLASSIC & SOLO always 1\r\n+\r\n+    setSearching(true);\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId,\r\n+\r\n+      // NEW: booking type + group seats\r\n+      bookingType,\r\n+      partySize: normalizedParty,\r\n+    };\r\n+\r\n+    try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n+\r\n+  \r\n+  \r\n+\r\n+  // Set markers & trigger route drawing when destination is picked\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+      : null;\r\n+\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+    }\r\n+\r\n+    // üëâ draw route as soon as we have both ends\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+\r\n+          setFare(0);\r\n+        }\r\n+\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n+        }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n+    };\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+\r\n+  const cancelRideNow = async () => {\r\n+    try {\r\n+      if (!bookingId) {\r\n+        return;\r\n+      }\r\n+\r\n+      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ bookingId }),\r\n+      });\r\n+      const body = await resp.text();\r\n+\r\n+      // UI reset after server confirms\r\n+      setSearching(false);\r\n+      setBookingId(null);\r\n+      setMatchedDriver(null);\r\n+      setBookingConfirmed(false);\r\n+      setDestination(null);\r\n+      setTripCompleted(false);\r\n+      setAlertedBookingComplete(false);\r\n+      setShowBookingForm(false);\r\n+\r\n+      // Clear map + cached state\r\n+      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+      sendToMap({ type: \"clearRoute\" });\r\n+      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+      setFare(0);\r\n+    } catch (e) {\r\n+      console.log(\"[PHOME] cancel error\", e);\r\n+      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.searchcont}>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showPOIs) {\r\n+                  setShowPOIs(false);\r\n+                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                  sendToMap({ type: 'setPOIs', items: [] });\r\n+                } else {\r\n+                  setShowPOIs(true);\r\n+                  const b = lastBBoxRef.current;\r\n+                  if (b) {\r\n+                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n+                    if (zoom >= 14) {\r\n+                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                      poiFetchTimerRef.current = setTimeout(async () => {\r\n+                        try {\r\n+                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n+                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n+                          const r = await fetch(url);\r\n+                          const items = await r.json();\r\n+                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+                        } catch {\r\n+                          sendToMap({ type: 'setPOIs', items: [] });\r\n+                        }\r\n+                      }, 0);\r\n+                    } else {\r\n+                      sendToMap({ type: 'setPOIs', items: [] });\r\n+                    }\r\n+                  } else {\r\n+                    sendToMap({ type: 'requestBbox' });\r\n+                  }\r\n+                }\r\n+              }}\r\n+\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n+\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>\r\n+                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n+                  </Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={cancelRideNow}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{\r\n+                              width: 50,\r\n+                              height: 50,\r\n+                              borderRadius: 25,\r\n+                              marginRight: 10,\r\n+                            }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          {/* Chat button here */}\r\n+                          <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId: bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId: passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n+                            }}\r\n+                            style={{\r\n+                              marginTop: 8,\r\n+                              backgroundColor: \"#007bff\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 16,\r\n+                              borderRadius: 8,\r\n+                              alignSelf: \"flex-start\",\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                          </TouchableOpacity>\r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              const body = await resp.text();\r\n+\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch (e) {\r\n+                              console.log(\"[PHOME] cancel error\", e);\r\n+                            }\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n+                            setFare(0);\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+\r\n+                {/* Booking Type Selector */}\r\n+                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n+                  {[\r\n+                    { key: 'CLASSIC', label: 'Classic' },\r\n+                    { key: 'GROUP', label: 'Group' },\r\n+                    { key: 'SOLO', label: 'Solo' },\r\n+                  ].map((opt) => {\r\n+                    const active = bookingType === (opt.key as any);\r\n+                    return (\r\n+                      <TouchableOpacity\r\n+                        key={opt.key}\r\n+                        onPress={() => {\r\n+                          setBookingType(opt.key as any);\r\n+                          if (opt.key !== 'GROUP') setPartySize(2);\r\n+                        }}\r\n+                        style={{\r\n+                          flex: 1,\r\n+                          backgroundColor: active ? '#111' : '#fff',\r\n+                          borderWidth: 1,\r\n+                          borderColor: active ? '#111' : '#ccc',\r\n+                          paddingVertical: 10,\r\n+                          borderRadius: 10,\r\n+                          alignItems: 'center',\r\n+                        }}\r\n+                      >\r\n+                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n+                          {opt.label}\r\n+                        </Text>\r\n+                      </TouchableOpacity>\r\n+                    );\r\n+                  })}\r\n+                </View>\r\n+\r\n+                {/* Notes for Solo & Group */}\r\n+                {bookingType === 'SOLO' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n+                  </Text>\r\n+                )}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n+                  </Text>\r\n+                )}\r\n+\r\n+                {/* Group Party Size Stepper */}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n+                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n+                      </TouchableOpacity>\r\n+                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+                )}\r\n+\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <Text>From:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <Text>To:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  {/* <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  /> */}\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n+                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                </ScrollView>\r\n+\r\n+                <View style={styles.fareContainer}>\r\n+                  <View>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Fare:\r\n+                    </Text>\r\n+                    <Text style={{ paddingLeft: 20 }}>\r\n+                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n+                    </Text>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Total Fare: ‚Ç±\r\n+                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n+                    </Text>\r\n+                  </View>\r\n+                  <TouchableOpacity\r\n+                    style={[\r\n+                      styles.bookButton,\r\n+                      // disable if invalid group count or no destination\r\n+                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n+                    ]}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n+                    onPress={handleBookNow}\r\n+                  >\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n+  panel: {\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n+  },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n+  dropdownItem: { padding: 10 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n+  \r\n+});\r\n"
                },
                {
                    "date": 1760988015252,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -698,1929 +698,21 @@\n \r\n           // Heading intentionally ignored (no cone)\r\n           if (msg.type === 'updateHeading'){ return; }\r\n \r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n-            clearRoute();\r\n-\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n-              .setContent(label || '')\r\n-              .setLatLng(mid)\r\n-              .addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n+          if (msg.type === 'ensureUserMarker') {\r\n+            const lat = Number(msg.latitude);\r\n+            const lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n+              upsertUserMarker(lat, lng);\r\n             }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-          if (msg.type === 'requestBbox') {\r\n-            const b = map.getBounds();\r\n             window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'bbox',\r\n-              bbox: {\r\n-                minLng: b.getWest(),\r\n-                minLat: b.getSouth(),\r\n-                maxLng: b.getEast(),\r\n-                maxLat: b.getNorth()\r\n-              },\r\n-              zoom: map.getZoom()\r\n+              type: 'userMarkerEnsured',\r\n+              placed: !!userMarker,\r\n             }));\r\n             return;\r\n           }\r\n \r\n-          const poiIcons = ${iconJson};\r\n-          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n-\r\n-            const z = Number(msg.zoom) || currentZoomLevel;\r\n-            const b = msg.bbox || null;\r\n-\r\n-            // Collect desired items from payload\r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n-            const desiredIds = new Set(desired.keys());\r\n-\r\n-            // Decide strategy based on zoom direction\r\n-            if (z > currentZoomLevel) {\r\n-              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n-              if (b) {\r\n-                for (const [id, marker] of poiMarkers) {\r\n-                  const p = marker.getLatLng();\r\n-                  if (!bboxContains(b, p.lat, p.lng)) {\r\n-                    poiLayer.removeLayer(marker);\r\n-                    poiMarkers.delete(id);\r\n-                  }\r\n-                }\r\n-              }\r\n-            } else if (z < currentZoomLevel) {\r\n-              // ---- ZOOM OUT: shrink to what backend sent\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const keep = desiredIds.has(id);\r\n-                const p = marker.getLatLng();\r\n-                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n-                if (!keep || !onScreen) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            } else {\r\n-              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const p = marker.getLatLng();\r\n-                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n-                if (drop) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            }\r\n-\r\n-            // Build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n-\r\n-            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n-            const total = toAdd.length;\r\n-            const BATCH =\r\n-              total > 300 ? 80 :\r\n-              total > 150 ? 50 :\r\n-              total > 60  ? 35 :\r\n-              25; // small = faster draw\r\n-            const DELAY = total > 150 ? 20 : 10;\r\n-\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n-\r\n-            let i = 0;\r\n-            const addBatch = () => {\r\n-              const end = Math.min(i + BATCH, total);\r\n-              for (; i < end; i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n-                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n-\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n-\r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-\r\n-                // üî• Fade-in animation\r\n-                let op = 0;\r\n-                const fade = () => {\r\n-                  op += 0.15;\r\n-                  if (op <= 1) {\r\n-                    marker.setOpacity(op);\r\n-                    requestAnimationFrame(fade);\r\n-                  } else {\r\n-                    marker.setOpacity(1);\r\n-                  }\r\n-                };\r\n-                requestAnimationFrame(fade);\r\n-              }\r\n-\r\n-              if (i < total) {\r\n-                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n-              } else {\r\n-                poiBatchHandle = null;\r\n-              }\r\n-            };\r\n-\r\n-\r\n-            addBatch();\r\n-\r\n-            currentZoomLevel = z;\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-          // Render Landmarks (pin markers)\r\n-          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n-            landmarkLayer.clearLayers();\r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n-              L.marker([it.lat, it.lng])\r\n-                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n-                .addTo(landmarkLayer);\r\n-            });\r\n-            return;\r\n-          }\r\n-          if (msg.type === 'clearLandmarks') {\r\n-            landmarkLayer.clearLayers();\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [location, iconData]);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-  }, [mapHtml, location, avatarUrl]);\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      // Always see what's coming in:\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = Number(parsed.zoom) || 0;\r\n-        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n-        if (!showPOIs || zoom < 14) {\r\n-          sendToMap({ type: 'setPOIs', items: [] });\r\n-          return;\r\n-        };\r\n-\r\n-        const center = parsed.center;\r\n-        if (center && lastCenterRef.current) {\r\n-          const moved = haversine(lastCenterRef.current, center);\r\n-          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n-        }\r\n-        if (center) lastCenterRef.current = center;\r\n-\r\n-        const key = [\r\n-          zoom,\r\n-          roundByZoom(minLng, zoom),\r\n-          roundByZoom(minLat, zoom),\r\n-          roundByZoom(maxLng, zoom),\r\n-          roundByZoom(maxLat, zoom),\r\n-        ].join('|');\r\n-\r\n-        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n-        lastPoiKeyRef.current = key;\r\n-\r\n-        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-        poiFetchTimerRef.current = setTimeout(async () => {\r\n-          try {\r\n-            const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-              `zoom=${zoom}`,\r\n-            ];\r\n-            if (center?.lat != null && center?.lng != null) {\r\n-              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-            }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            if (poiCacheRef.current.has(key)) {\r\n-              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n-              return;\r\n-            }\r\n-\r\n-            if (inflightRef.current.has(key)) {\r\n-              return;\r\n-            }\r\n-\r\n-            inflightRef.current.add(key);\r\n-\r\n-            const reqId = ++lastReqIdRef.current;\r\n-            \r\n-            try {\r\n-              const qs: string[] = [\r\n-                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-                `zoom=${zoom}`,\r\n-              ];\r\n-              if (center?.lat != null && center?.lng != null) {\r\n-                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-              }\r\n-              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-\r\n-              const r = await fetch(url);\r\n-              const items = await r.json();\r\n-\r\n-              if (reqId !== lastReqIdRef.current) {\r\n-                return; // a newer request finished after this one\r\n-              }\r\n-\r\n-              if (Array.isArray(items)) {\r\n-                poiCacheRef.current.set(key, items);\r\n-                sendToMap({ type: 'setPOIs', items });\r\n-              } else {\r\n-                sendToMap({ type: 'setPOIs', items: [] });\r\n-              }\r\n-            } catch (e) {\r\n-              console.log('[ERR] POI fetch failed for', key, e);\r\n-              sendToMap({ type: 'setPOIs', items: [] });\r\n-            } finally {\r\n-              inflightRef.current.delete(key);\r\n-            }\r\n-            const r = await fetch(url);\r\n-            const items = await r.json();\r\n-            if (Array.isArray(items)) {\r\n-              poiCacheRef.current.set(key, items);\r\n-              sendToMap({\r\n-                type: 'setPOIs',\r\n-                items,\r\n-                zoom,                       \r\n-                bbox: { minLng, minLat, maxLng, maxLat },  \r\n-              });\r\n-            }\r\n-\r\n-          } catch {\r\n-            sendToMap({ type: 'setPOIs', items: [] });\r\n-          }\r\n-        }, 500);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'setDestinationFromPOI') {\r\n-        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n-        setDestination(dest);\r\n-        setDropoffName(parsed.label || 'POI Destination');\r\n-\r\n-        if (!location) {\r\n-          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-          return;\r\n-        }\r\n-        const { latitude, longitude } = location;\r\n-\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          dest\r\n-        );\r\n-        sendToMap({\r\n-          type: 'setMarkers',\r\n-          destination: dest,\r\n-          driver: null,\r\n-        });\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-\r\n-    // Normalize party size based on type\r\n-    const normalizedParty =\r\n-      bookingType === 'GROUP'\r\n-        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n-        : 1; // CLASSIC & SOLO always 1\r\n-\r\n-    setSearching(true);\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId,\r\n-\r\n-      // NEW: booking type + group seats\r\n-      bookingType,\r\n-      partySize: normalizedParty,\r\n-    };\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  // {status === \"accepted\" && bookingId && (\r\n-  //   <ChatNotice\r\n-  //     bookingId={bookingId}\r\n-  //     role=\"passenger\"\r\n-  //     onGoToChat={() =>\r\n-  //       router.push({\r\n-  //         pathname: \"/chatcomponent\",\r\n-  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-  //       })\r\n-  //     }\r\n-  //   />\r\n-  // )}\r\n-\r\n-  \r\n-  \r\n-\r\n-  // Set markers & trigger route drawing when destination is picked\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n-\r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-\r\n-  const cancelRideNow = async () => {\r\n-    try {\r\n-      if (!bookingId) {\r\n-        return;\r\n-      }\r\n-\r\n-      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ bookingId }),\r\n-      });\r\n-      const body = await resp.text();\r\n-\r\n-      // UI reset after server confirms\r\n-      setSearching(false);\r\n-      setBookingId(null);\r\n-      setMatchedDriver(null);\r\n-      setBookingConfirmed(false);\r\n-      setDestination(null);\r\n-      setTripCompleted(false);\r\n-      setAlertedBookingComplete(false);\r\n-      setShowBookingForm(false);\r\n-\r\n-      // Clear map + cached state\r\n-      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-      sendToMap({ type: \"clearRoute\" });\r\n-      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-      setFare(0);\r\n-    } catch (e) {\r\n-      console.log(\"[PHOME] cancel error\", e);\r\n-      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.searchcont}>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lng}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showLandmarks) {\r\n-                  sendToMap({ type: 'clearLandmarks' });\r\n-                  setShowLandmarks(false);\r\n-                } else {\r\n-                  loadLandmarks(); // same function we made before\r\n-                  setShowLandmarks(true);\r\n-                }\r\n-              }}\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n-            </TouchableOpacity>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showPOIs) {\r\n-                  setShowPOIs(false);\r\n-                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                  sendToMap({ type: 'setPOIs', items: [] });\r\n-                } else {\r\n-                  setShowPOIs(true);\r\n-                  const b = lastBBoxRef.current;\r\n-                  if (b) {\r\n-                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n-                    if (zoom >= 14) {\r\n-                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                      poiFetchTimerRef.current = setTimeout(async () => {\r\n-                        try {\r\n-                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n-                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n-                          const r = await fetch(url);\r\n-                          const items = await r.json();\r\n-                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n-                        } catch {\r\n-                          sendToMap({ type: 'setPOIs', items: [] });\r\n-                        }\r\n-                      }, 0);\r\n-                    } else {\r\n-                      sendToMap({ type: 'setPOIs', items: [] });\r\n-                    }\r\n-                  } else {\r\n-                    sendToMap({ type: 'requestBbox' });\r\n-                  }\r\n-                }\r\n-              }}\r\n-\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n-            </TouchableOpacity>\r\n-\r\n-\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>\r\n-                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n-                  </Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={cancelRideNow}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{\r\n-                              width: 50,\r\n-                              height: 50,\r\n-                              borderRadius: 25,\r\n-                              marginRight: 10,\r\n-                            }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-\r\n-                          {/* Chat button here */}\r\n-                          <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              router.push({\r\n-                                pathname: \"/ChatRoom\",\r\n-                                params: {\r\n-                                  bookingId: bookingId,\r\n-                                  driverId: matchedDriver?.driverId,\r\n-                                  passengerId: passengerId,\r\n-                                  role: \"passenger\",\r\n-                                },\r\n-                              });\r\n-                            }}\r\n-                            style={{\r\n-                              marginTop: 8,\r\n-                              backgroundColor: \"#007bff\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 16,\r\n-                              borderRadius: 8,\r\n-                              alignSelf: \"flex-start\",\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n-                          </TouchableOpacity>\r\n-                        </View>\r\n-                      </View>\r\n-\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              const body = await resp.text();\r\n-\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch (e) {\r\n-                              console.log(\"[PHOME] cancel error\", e);\r\n-                            }\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-                            sendToMap({ type: \"clearRoute\" });\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-\r\n-                {/* Booking Type Selector */}\r\n-                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n-                  {[\r\n-                    { key: 'CLASSIC', label: 'Classic' },\r\n-                    { key: 'GROUP', label: 'Group' },\r\n-                    { key: 'SOLO', label: 'Solo' },\r\n-                  ].map((opt) => {\r\n-                    const active = bookingType === (opt.key as any);\r\n-                    return (\r\n-                      <TouchableOpacity\r\n-                        key={opt.key}\r\n-                        onPress={() => {\r\n-                          setBookingType(opt.key as any);\r\n-                          if (opt.key !== 'GROUP') setPartySize(2);\r\n-                        }}\r\n-                        style={{\r\n-                          flex: 1,\r\n-                          backgroundColor: active ? '#111' : '#fff',\r\n-                          borderWidth: 1,\r\n-                          borderColor: active ? '#111' : '#ccc',\r\n-                          paddingVertical: 10,\r\n-                          borderRadius: 10,\r\n-                          alignItems: 'center',\r\n-                        }}\r\n-                      >\r\n-                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n-                          {opt.label}\r\n-                        </Text>\r\n-                      </TouchableOpacity>\r\n-                    );\r\n-                  })}\r\n-                </View>\r\n-\r\n-                {/* Notes for Solo & Group */}\r\n-                {bookingType === 'SOLO' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n-                  </Text>\r\n-                )}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n-                  </Text>\r\n-                )}\r\n-\r\n-                {/* Group Party Size Stepper */}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n-                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n-                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n-                      </TouchableOpacity>\r\n-                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n-                  </View>\r\n-                )}\r\n-\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <Text>From:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <Text>To:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  {/* <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                    value={destinationLabel}\r\n-                    onChangeText={setDestinationLabel}\r\n-                  /> */}\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                </ScrollView>\r\n-\r\n-                <View style={styles.fareContainer}>\r\n-                  <View>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Fare:\r\n-                    </Text>\r\n-                    <Text style={{ paddingLeft: 20 }}>\r\n-                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n-                    </Text>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Total Fare: ‚Ç±\r\n-                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n-                    </Text>\r\n-                  </View>\r\n-                  <TouchableOpacity\r\n-                    style={[\r\n-                      styles.bookButton,\r\n-                      // disable if invalid group count or no destination\r\n-                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n-                    ]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n-                    onPress={handleBookNow}\r\n-                  >\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-  \r\n-});\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync(); // ensures we have a real file on device\r\n-  const uri = asset.localUri || asset.uri; // localUri preferred\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),          \r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-\r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-  const inflightRef  = useRef<Set<string>>(new Set());\r\n-  const lastReqIdRef = useRef(0);\r\n-  const [showPOIs, setShowPOIs] = useState(false);\r\n-  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n-  // --- Booking type + party size ---\r\n-  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n-  const [partySize, setPartySize] = useState<number>(2);\r\n-\r\n-\r\n-  function roundByZoom(value: number, zoom: number) {\r\n-    const decimals =\r\n-      zoom >= 18 ? 3 :\r\n-      zoom >= 16 ? 3 :\r\n-      zoom >= 15 ? 2 :\r\n-      /* <=14 */   2;\r\n-    const m = Math.pow(10, decimals);\r\n-    return Math.round(value * m) / m;\r\n-  }\r\n-\r\n-\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1)); \r\n-  }\r\n-\r\n-\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) {\r\n-      messageQueue.current.push(json);\r\n-      return;\r\n-    }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-\r\n-\r\n-  const canShowChatNotice =\r\n-    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n-\r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n-\r\n-      const coords = data.features[0].geometry.coordinates; \r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n-\r\n-      const summary = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM = summary.distance ?? 0;\r\n-      const durationS = summary.duration ?? 0;\r\n-\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60\r\n-        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n-        : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n-      const fareText = `‚Ç±${computedFare} est`;\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm, \r\n-        distanceText,     \r\n-        durationText,\r\n-        fareText,  \r\n-      });\r\n-\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n-    }\r\n-  };\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lng = location.longitude; // NOTE: lng\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    sendToMap({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    });\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      // fire once right away, so the dot appears even before watch ticks\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-      }\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          sendToMap({\r\n-            type: \"updateUserLoc\",\r\n-            latitude: pos.coords.latitude,\r\n-            longitude: pos.coords.longitude,\r\n-            accuracy: pos.coords.accuracy ?? 15,\r\n-            avatarUrl,\r\n-          });\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            sendToMap({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            });\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  // useEffect(() => {\r\n-  //   const backAction = () => {\r\n-  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-  //       {\r\n-  //         text: \"Logout\",\r\n-  //         onPress: async () => {\r\n-  //           await AsyncStorage.removeItem(\"passengerId\");\r\n-  //           router.replace(\"/login_and_reg/plogin\");\r\n-  //         },\r\n-  //       },\r\n-  //     ]);\r\n-  //     return true;\r\n-  //   };\r\n-  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-  //   return () => backHandler.remove();\r\n-  // }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location) return;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        // --- Map init ---\r\n-        const map = L.map('map', {\r\n-          zoomControl: true,\r\n-          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n-          maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n-          maxZoom: 19, \r\n-          noWrap: true\r\n-        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        let poiLayer = L.layerGroup().addTo(map);\r\n-        let landmarkLayer = L.layerGroup().addTo(map);\r\n-        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        const poiMarkers = new Map();        // id -> L.Marker\r\n-        const iconCache  = {};               // category -> L.Icon\r\n-        let poiBatchHandle = null;           // cancel previous batch\r\n-\r\n-        function getPoiIcon(cat, poiIcons) {\r\n-          if (iconCache[cat]) return iconCache[cat];\r\n-\r\n-          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n-            ? poiIcons[cat]\r\n-            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n-\r\n-          iconCache[cat] = L.icon({\r\n-            iconUrl: url,\r\n-            iconSize: [28, 28],\r\n-            iconAnchor: [14, 28],\r\n-          });\r\n-          return iconCache[cat];\r\n-        }\r\n-\r\n-        function addOrUpdatePOIMarker(it, poiIcons) {\r\n-          const existing = poiMarkers.get(it.id);\r\n-          if (existing) {\r\n-            // update position if it changed\r\n-            const curr = existing.getLatLng();\r\n-            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n-              existing.setLatLng([it.lat, it.lng]);\r\n-            }\r\n-            return;\r\n-          }\r\n-          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n-          const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-          // build popup with \"Set Destination\"\r\n-          const container = document.createElement('div');\r\n-          const title = document.createElement('b');\r\n-          title.textContent = it.name || it.category || 'POI';\r\n-          container.appendChild(title);\r\n-          container.appendChild(document.createElement('br'));\r\n-          const btn = document.createElement('button');\r\n-          btn.textContent = 'Set Destination';\r\n-          btn.style.marginTop = '6px';\r\n-          btn.onclick = function () {\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'setDestinationFromPOI',\r\n-              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-            }));\r\n-          };\r\n-          container.appendChild(btn);\r\n-          marker.bindPopup(container);\r\n-\r\n-          marker.addTo(poiLayer);\r\n-          poiMarkers.set(it.id, marker);\r\n-        }\r\n-        \r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        // --- Helpers ---\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip( { permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-        }\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        map.on('moveend', function () {\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        });\r\n-\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            upsertUserMarker(msg.latitude, msg.longitude);\r\n-            return;\r\n-          }\r\n-\r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n           // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n           if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n             clearRoute();\r\n \r\n"
                },
                {
                    "date": 1760988036923,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,8 +151,9 @@\n   const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n   // --- Booking type + party size ---\r\n   const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n   const [partySize, setPartySize] = useState<number>(2);\r\n+  const userMarkerOkRef = useRef(false);\r\n \r\n \r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n"
                },
                {
                    "date": 1760988066017,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -154,8 +154,25 @@\n   const [partySize, setPartySize] = useState<number>(2);\r\n   const userMarkerOkRef = useRef(false);\r\n \r\n \r\n+  function ensureUserMarker(lat: number, lng: number) {\r\n+    let attempts = 0;\r\n+    userMarkerOkRef.current = false;\r\n+\r\n+    const tryOnce = () => {\r\n+      attempts += 1;\r\n+      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n+\r\n+      if (!userMarkerOkRef.current && attempts < 6) {\r\n+        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n+      }\r\n+    };\r\n+\r\n+    tryOnce();\r\n+  }\r\n+\r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n"
                },
                {
                    "date": 1760988092557,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -976,8 +976,12 @@\n         } catch {\r\n           setDropoffName(\"Selected Location\");\r\n         }\r\n       }\r\n+      if (parsed.type === 'userMarkerEnsured') {\r\n+        userMarkerOkRef.current = !!parsed.placed;\r\n+        return;\r\n+      }\r\n       if (parsed.type === 'bbox' && parsed.bbox) {\r\n         const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n         const zoom = Number(parsed.zoom) || 0;\r\n         lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n"
                },
                {
                    "date": 1760988167975,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1167,8 +1167,15 @@\n       setSearching(false);\r\n     }\r\n   };\r\n \r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapReady, location]);\r\n+\r\n+\r\n   // {status === \"accepted\" && bookingId && (\r\n   //   <ChatNotice\r\n   //     bookingId={bookingId}\r\n   //     role=\"passenger\"\r\n"
                },
                {
                    "date": 1760988331949,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -372,10 +372,13 @@\n           longitude: location.longitude,\r\n           accuracy: 15,\r\n           avatarUrl,\r\n         }));\r\n+        // NEW: force-check pin\r\n+        ensureUserMarker(location.latitude, location.longitude);\r\n       }\r\n \r\n+\r\n       sub = await Location.watchPositionAsync(\r\n         {\r\n           accuracy: Location.Accuracy.Balanced,\r\n           timeInterval: 5000,\r\n@@ -1457,8 +1460,15 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapHtml]);\r\n+\r\n+\r\n   const loadLandmarks = async () => {\r\n     try {\r\n       const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n       const items = await r.json();\r\n"
                },
                {
                    "date": 1760988460820,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1460,15 +1460,10 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapHtml]);\r\n+  \r\n \r\n-\r\n   const loadLandmarks = async () => {\r\n     try {\r\n       const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n       const items = await r.json();\r\n"
                },
                {
                    "date": 1760988469716,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -372,13 +372,10 @@\n           longitude: location.longitude,\r\n           accuracy: 15,\r\n           avatarUrl,\r\n         }));\r\n-        // NEW: force-check pin\r\n-        ensureUserMarker(location.latitude, location.longitude);\r\n       }\r\n \r\n-\r\n       sub = await Location.watchPositionAsync(\r\n         {\r\n           accuracy: Location.Accuracy.Balanced,\r\n           timeInterval: 5000,\r\n@@ -1460,10 +1457,8 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n-  \r\n-\r\n   const loadLandmarks = async () => {\r\n     try {\r\n       const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n       const items = await r.json();\r\n"
                },
                {
                    "date": 1760988477536,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1166,16 +1166,10 @@\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n+  \r\n \r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapReady, location]);\r\n-\r\n-\r\n   // {status === \"accepted\" && bookingId && (\r\n   //   <ChatNotice\r\n   //     bookingId={bookingId}\r\n   //     role=\"passenger\"\r\n"
                },
                {
                    "date": 1760988485335,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -976,12 +976,8 @@\n         } catch {\r\n           setDropoffName(\"Selected Location\");\r\n         }\r\n       }\r\n-      if (parsed.type === 'userMarkerEnsured') {\r\n-        userMarkerOkRef.current = !!parsed.placed;\r\n-        return;\r\n-      }\r\n       if (parsed.type === 'bbox' && parsed.bbox) {\r\n         const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n         const zoom = Number(parsed.zoom) || 0;\r\n         lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n@@ -1166,9 +1162,8 @@\n       Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n       setSearching(false);\r\n     }\r\n   };\r\n-  \r\n \r\n   // {status === \"accepted\" && bookingId && (\r\n   //   <ChatNotice\r\n   //     bookingId={bookingId}\r\n"
                },
                {
                    "date": 1760988497658,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -152,27 +152,11 @@\n   // --- Booking type + party size ---\r\n   const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n   const [partySize, setPartySize] = useState<number>(2);\r\n   const userMarkerOkRef = useRef(false);\r\n+  \r\n \r\n \r\n-  function ensureUserMarker(lat: number, lng: number) {\r\n-    let attempts = 0;\r\n-    userMarkerOkRef.current = false;\r\n-\r\n-    const tryOnce = () => {\r\n-      attempts += 1;\r\n-      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n-\r\n-      if (!userMarkerOkRef.current && attempts < 6) {\r\n-        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n-      }\r\n-    };\r\n-\r\n-    tryOnce();\r\n-  }\r\n-\r\n-\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n"
                },
                {
                    "date": 1760988506190,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,10 +151,8 @@\n   const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n   // --- Booking type + party size ---\r\n   const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n   const [partySize, setPartySize] = useState<number>(2);\r\n-  const userMarkerOkRef = useRef(false);\r\n-  \r\n \r\n \r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n@@ -700,20 +698,9 @@\n \r\n           // Heading intentionally ignored (no cone)\r\n           if (msg.type === 'updateHeading'){ return; }\r\n \r\n-          if (msg.type === 'ensureUserMarker') {\r\n-            const lat = Number(msg.latitude);\r\n-            const lng = Number(msg.longitude);\r\n-            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n-              upsertUserMarker(lat, lng);\r\n-            }\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'userMarkerEnsured',\r\n-              placed: !!userMarker,\r\n-            }));\r\n-            return;\r\n-          }\r\n+          \r\n \r\n           // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n           if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n             clearRoute();\r\n"
                },
                {
                    "date": 1760988514090,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -517,23 +517,8 @@\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n         let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        let userMarker = null;\r\n-        let userMarkerPlaced = false; \r\n-\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip({ permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-          userMarkerPlaced = true; \r\n-        }\r\n-\r\n         function bboxContains(b, lat, lng) {\r\n           return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n         }\r\n \r\n@@ -698,10 +683,8 @@\n \r\n           // Heading intentionally ignored (no cone)\r\n           if (msg.type === 'updateHeading'){ return; }\r\n \r\n-          \r\n-\r\n           // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n           if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n             clearRoute();\r\n \r\n"
                },
                {
                    "date": 1760988523121,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -517,8 +517,23 @@\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n         let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        let userMarker = null;\r\n+        let userMarkerPlaced = false; // <‚Äî NEW\r\n+\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip({ permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+          userMarkerPlaced = true; // <‚Äî NEW\r\n+        }\r\n+\r\n         function bboxContains(b, lat, lng) {\r\n           return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n         }\r\n \r\n"
                },
                {
                    "date": 1760988579705,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,9 +39,8 @@\n   parking: require('../../assets/images/pios/parking.png'),\r\n };\r\n \r\n \r\n-\r\n const { width } = Dimensions.get(\"window\");\r\n \r\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n@@ -517,23 +516,8 @@\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n         let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        let userMarker = null;\r\n-        let userMarkerPlaced = false; // <‚Äî NEW\r\n-\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip({ permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-          userMarkerPlaced = true; // <‚Äî NEW\r\n-        }\r\n-\r\n         function bboxContains(b, lat, lng) {\r\n           return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n         }\r\n \r\n"
                },
                {
                    "date": 1760988708724,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -39,8 +39,9 @@\n   parking: require('../../assets/images/pios/parking.png'),\r\n };\r\n \r\n \r\n+\r\n const { width } = Dimensions.get(\"window\");\r\n \r\n type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n \r\n@@ -516,8 +517,9 @@\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n         let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        \r\n         function bboxContains(b, lat, lng) {\r\n           return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n         }\r\n \r\n"
                },
                {
                    "date": 1760988772043,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -517,9 +517,22 @@\n \r\n         let poiLayer = L.layerGroup().addTo(map);\r\n         let landmarkLayer = L.layerGroup().addTo(map);\r\n         let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        \r\n+        let userMarkerPlaced = false; // <‚Äî NEW\r\n+\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip({ permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+          userMarkerPlaced = true; // <‚Äî NEW\r\n+        }\r\n+\r\n         function bboxContains(b, lat, lng) {\r\n           return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n         }\r\n \r\n"
                },
                {
                    "date": 1760988925899,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -688,8 +688,21 @@\n         document.addEventListener('message', function(event){\r\n           let msg = {};\r\n           try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n \r\n+          if (msg.type === 'ensureUserMarker') {\r\n+            const lat = Number(msg.latitude);\r\n+            const lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n+              upsertUserMarker(lat, lng);\r\n+            }\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'userMarkerEnsured',\r\n+              placed: !!userMarker,\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n           // Live passenger location (blue marker only)\r\n           if (msg.type === 'updateUserLoc'){\r\n             upsertUserMarker(msg.latitude, msg.longitude);\r\n             return;\r\n"
                },
                {
                    "date": 1760988975399,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -151,10 +151,28 @@\n   const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n   // --- Booking type + party size ---\r\n   const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n   const [partySize, setPartySize] = useState<number>(2);\r\n+  const userMarkerOkRef = useRef(false);\r\n \r\n+  function ensureUserMarker(lat: number, lng: number) {\r\n+    let attempts = 0;\r\n+    userMarkerOkRef.current = false;\r\n \r\n+    const tryOnce = () => {\r\n+      attempts += 1;\r\n+      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n+\r\n+      if (!userMarkerOkRef.current && attempts < 6) {\r\n+        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n+      }\r\n+    };\r\n+\r\n+    tryOnce();\r\n+  }\r\n+\r\n+\r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n"
                },
                {
                    "date": 1760989003989,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -169,10 +169,8 @@\n \r\n     tryOnce();\r\n   }\r\n \r\n-\r\n-\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n@@ -975,8 +973,12 @@\n         } catch {\r\n           setDropoffName(\"Selected Location\");\r\n         }\r\n       }\r\n+      if (parsed.type === 'userMarkerEnsured') {\r\n+        userMarkerOkRef.current = !!parsed.placed;\r\n+        return;\r\n+      }\r\n       if (parsed.type === 'bbox' && parsed.bbox) {\r\n         const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n         const zoom = Number(parsed.zoom) || 0;\r\n         lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n"
                },
                {
                    "date": 1760989045990,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -218,10 +218,16 @@\n       messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n       messageQueue.current = [];\r\n     }\r\n   }, [mapReady]);\r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapReady, location]);\r\n \r\n \r\n+\r\n   const canShowChatNotice =\r\n     bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n"
                },
                {
                    "date": 1760989086220,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -367,19 +367,21 @@\n     (async () => {\r\n       const { status } = await Location.requestForegroundPermissionsAsync();\r\n       if (status !== \"granted\") return;\r\n \r\n-      // fire once right away, so the dot appears even before watch ticks\r\n       if (location && mapRef.current) {\r\n         mapRef.current.postMessage(JSON.stringify({\r\n           type: \"updateUserLoc\",\r\n           latitude: location.latitude,\r\n           longitude: location.longitude,\r\n           accuracy: 15,\r\n           avatarUrl,\r\n         }));\r\n+        // NEW: force-check pin\r\n+        ensureUserMarker(location.latitude, location.longitude);\r\n       }\r\n \r\n+\r\n       sub = await Location.watchPositionAsync(\r\n         {\r\n           accuracy: Location.Accuracy.Balanced,\r\n           timeInterval: 5000,\r\n"
                },
                {
                    "date": 1760989102391,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -400,9 +400,15 @@\n     })();\r\n \r\n     return () => sub?.remove();\r\n   }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapHtml]);\r\n \r\n+\r\n   useEffect(() => {\r\n     let headSub: Location.LocationSubscription | null = null;\r\n \r\n     (async () => {\r\n"
                },
                {
                    "date": 1761228948675,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,2071 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, \r\n+  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n+  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n+  Keyboard, Image, BackHandler, ScrollView, AppState, Linking  } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+import * as IntentLauncher from 'expo-intent-launcher';\r\n+import { useFocusEffect } from '@react-navigation/native';\r\n+\r\n+\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n+\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n+\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); \r\n+};\r\n+\r\n+async function ensureLocationEnabled() {\r\n+  const services = await Location.hasServicesEnabledAsync();\r\n+  const perm = await Location.getForegroundPermissionsAsync();\r\n+\r\n+  if (!services || perm.status !== 'granted') {\r\n+    Alert.alert(\r\n+      \"Enable Location\",\r\n+      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n+      [\r\n+        { text: \"Cancel\", style: \"cancel\" },\r\n+        {\r\n+          text: \"Open Settings\",\r\n+          onPress: () => {\r\n+            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n+            else Linking.openURL('app-settings:');\r\n+          }\r\n+        }\r\n+      ]\r\n+    );\r\n+    return false;\r\n+  }\r\n+  return true;\r\n+}\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default function PHome() {\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+  const inflightRef  = useRef<Set<string>>(new Set());\r\n+  const lastReqIdRef = useRef(0);\r\n+  const [showPOIs, setShowPOIs] = useState(false);\r\n+  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n+  // --- Booking type + party size ---\r\n+  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n+  const [partySize, setPartySize] = useState<number>(2);\r\n+  const userMarkerOkRef = useRef(false);\r\n+  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n+  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n+\r\n+  function ensureUserMarker(lat: number, lng: number) {\r\n+    let attempts = 0;\r\n+    userMarkerOkRef.current = false;\r\n+\r\n+    const tryOnce = () => {\r\n+      attempts += 1;\r\n+      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n+\r\n+      if (!userMarkerOkRef.current && attempts < 6) {\r\n+        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n+      }\r\n+    };\r\n+\r\n+    tryOnce();\r\n+  }\r\n+\r\n+  function roundByZoom(value: number, zoom: number) {\r\n+    const decimals =\r\n+      zoom >= 18 ? 3 :\r\n+      zoom >= 16 ? 3 :\r\n+      zoom >= 15 ? 2 :\r\n+      /* <=14 */   2;\r\n+    const m = Math.pow(10, decimals);\r\n+    return Math.round(value * m) / m;\r\n+  }\r\n+\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapReady, location]);\r\n+\r\n+  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n+\r\n+  // call on mount\r\n+  useEffect(() => { ensureLocationEnabled(); }, []);\r\n+\r\n+  // call on resume\r\n+  useEffect(() => {\r\n+    const sub = AppState.addEventListener('change', (s) => {\r\n+      if (s === 'active') ensureLocationEnabled();\r\n+    });\r\n+    return () => sub.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+  const canShowChatNotice =\r\n+    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+\r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to: { latitude: number; longitude: number }\r\n+  ) => {\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end: [to.longitude, to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n+        console.error(\"üõë Invalid ORS response:\", data);\r\n+        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n+        return;\r\n+      }\r\n+\r\n+      const coords = data.features[0].geometry.coordinates; \r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n+\r\n+      const summary = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM = summary.distance ?? 0;\r\n+      const durationS = summary.duration ?? 0;\r\n+\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60\r\n+        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n+        : `${mins} min`;\r\n+\r\n+      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n+      const fareText = `‚Ç±${computedFare} est`;\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm, \r\n+        distanceText,     \r\n+        durationText,\r\n+        fareText,  \r\n+      });\r\n+\r\n+    } catch (err) {\r\n+      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n+      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n+    }\r\n+  };\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n+      try {\r\n+        const lat = location.latitude;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+\r\n+    // update UI\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n+    // draw route immediately\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest\r\n+    );\r\n+\r\n+    // (optional) update markers\r\n+    sendToMap({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    });\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+        // NEW: force-check pin\r\n+        ensureUserMarker(location.latitude, location.longitude);\r\n+      }\r\n+\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          const { latitude, longitude, accuracy } = pos.coords;\r\n+          setLivePos({ latitude, longitude });             \r\n+          sendToMap({                                       \r\n+            type: \"updateUserLoc\",\r\n+            latitude,\r\n+            longitude,\r\n+            accuracy: accuracy ?? 15,\r\n+            avatarUrl,\r\n+          });\r\n+          if (accuracy && accuracy > 80) return;\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl]); \r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapHtml, location]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            sendToMap({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            });\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n+  // ---------------------------------------------------------\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!livePos) return;\r\n+    console.log(\"LIVE POS ‚Üí\", livePos.latitude, livePos.longitude);\r\n+  }, [livePos]);\r\n+\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+  if (!iconData || !location || mapHtml) return;\r\n+\r\n+  // lock the very first location for the initial setView\r\n+  if (!initialLocRef.current) {\r\n+    initialLocRef.current = {\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+    };\r\n+  }\r\n+\r\n+  const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n+\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        if (!window.L) {\r\n+          window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'error', msg:'Leaflet failed to load' }));\r\n+        }\r\n+        // --- Map init ---\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n+          noWrap: true\r\n+        }).setView([${initLat}, ${initLng}], 15);\r\n+\r\n+\r\n+        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n+        }).addTo(map);\r\n+\r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n+\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n+\r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        let userMarkerPlaced = false; // <‚Äî NEW\r\n+\r\n+        let tweenHandle = null;\r\n+        function tweenMarkerTo(lat, lng, durationMs = 300) {\r\n+          if (!userMarker) return upsertUserMarker(lat, lng);\r\n+          if (tweenHandle) cancelAnimationFrame(tweenHandle);\r\n+\r\n+          const start = userMarker.getLatLng();\r\n+          const end = L.latLng(lat, lng);\r\n+          const t0 = performance.now();\r\n+\r\n+          const step = (t) => {\r\n+            const p = Math.min(1, (t - t0) / durationMs);\r\n+            const latI = start.lat + (end.lat - start.lat) * p;\r\n+            const lngI = start.lng + (end.lng - start.lng) * p;\r\n+            userMarker.setLatLng([latI, lngI]);\r\n+            if (p < 1) tweenHandle = requestAnimationFrame(step);\r\n+          };\r\n+          tweenHandle = requestAnimationFrame(step);\r\n+        }\r\n+\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip({ permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+          userMarkerPlaced = true; \r\n+        }\r\n+\r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+        function addOrUpdatePOIMarker(it, poiIcons) {\r\n+          const existing = poiMarkers.get(it.id);\r\n+          if (existing) {\r\n+            // update position if it changed\r\n+            const curr = existing.getLatLng();\r\n+            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n+              existing.setLatLng([it.lat, it.lng]);\r\n+            }\r\n+            return;\r\n+          }\r\n+          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n+          const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+          // build popup with \"Set Destination\"\r\n+          const container = document.createElement('div');\r\n+          const title = document.createElement('b');\r\n+          title.textContent = it.name || it.category || 'POI';\r\n+          container.appendChild(title);\r\n+          container.appendChild(document.createElement('br'));\r\n+          const btn = document.createElement('button');\r\n+          btn.textContent = 'Set Destination';\r\n+          btn.style.marginTop = '6px';\r\n+          btn.onclick = function () {\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'setDestinationFromPOI',\r\n+              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+            }));\r\n+          };\r\n+          container.appendChild(btn);\r\n+          marker.bindPopup(container);\r\n+\r\n+          marker.addTo(poiLayer);\r\n+          poiMarkers.set(it.id, marker);\r\n+        }\r\n+        \r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n+\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n+\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n+\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n+\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n+\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n+\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n+\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n+\r\n+          if (msg.type === 'ensureUserMarker') {\r\n+            const lat = Number(msg.latitude);\r\n+            const lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n+              upsertUserMarker(lat, lng);\r\n+            }\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'userMarkerEnsured',\r\n+              placed: !!userMarker,\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n+            return;\r\n+          }\r\n+\r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n+\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+            clearRoute();\r\n+\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n+              .setContent(label || '')\r\n+              .setLatLng(mid)\r\n+              .addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n+            }\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+          if (msg.type === 'requestBbox') {\r\n+            const b = map.getBounds();\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'bbox',\r\n+              bbox: {\r\n+                minLng: b.getWest(),\r\n+                minLat: b.getSouth(),\r\n+                maxLng: b.getEast(),\r\n+                maxLat: b.getNorth()\r\n+              },\r\n+              zoom: map.getZoom()\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n+\r\n+            const z = Number(msg.zoom) || currentZoomLevel;\r\n+            const b = msg.bbox || null;\r\n+\r\n+            // Collect desired items from payload\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n+            const desiredIds = new Set(desired.keys());\r\n+\r\n+            // Decide strategy based on zoom direction\r\n+            if (z > currentZoomLevel) {\r\n+              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n+              if (b) {\r\n+                for (const [id, marker] of poiMarkers) {\r\n+                  const p = marker.getLatLng();\r\n+                  if (!bboxContains(b, p.lat, p.lng)) {\r\n+                    poiLayer.removeLayer(marker);\r\n+                    poiMarkers.delete(id);\r\n+                  }\r\n+                }\r\n+              }\r\n+            } else if (z < currentZoomLevel) {\r\n+              // ---- ZOOM OUT: shrink to what backend sent\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const keep = desiredIds.has(id);\r\n+                const p = marker.getLatLng();\r\n+                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n+                if (!keep || !onScreen) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            } else {\r\n+              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const p = marker.getLatLng();\r\n+                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n+                if (drop) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            }\r\n+\r\n+            // Build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n+\r\n+            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n+            const total = toAdd.length;\r\n+            const BATCH =\r\n+              total > 300 ? 80 :\r\n+              total > 150 ? 50 :\r\n+              total > 60  ? 35 :\r\n+              25; // small = faster draw\r\n+            const DELAY = total > 150 ? 20 : 10;\r\n+\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+\r\n+            let i = 0;\r\n+            const addBatch = () => {\r\n+              const end = Math.min(i + BATCH, total);\r\n+              for (; i < end; i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n+                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n+\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n+\r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+\r\n+                // üî• Fade-in animation\r\n+                let op = 0;\r\n+                const fade = () => {\r\n+                  op += 0.15;\r\n+                  if (op <= 1) {\r\n+                    marker.setOpacity(op);\r\n+                    requestAnimationFrame(fade);\r\n+                  } else {\r\n+                    marker.setOpacity(1);\r\n+                  }\r\n+                };\r\n+                requestAnimationFrame(fade);\r\n+              }\r\n+\r\n+              if (i < total) {\r\n+                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n+              } else {\r\n+                poiBatchHandle = null;\r\n+              }\r\n+            };\r\n+\r\n+\r\n+            addBatch();\r\n+\r\n+            currentZoomLevel = z;\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n+  }, [iconData, mapHtml, location]);  \r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+  }, [location, avatarUrl]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!initialLocRef.current && location) {\r\n+      initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  useEffect(() => {\r\n+    console.log(\"[PHome] HTML built once?\", !!mapHtml);\r\n+  }, [mapHtml]);\r\n+\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+      if (parsed.type === 'userMarkerEnsured') {\r\n+        userMarkerOkRef.current = !!parsed.placed;\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = Number(parsed.zoom) || 0;\r\n+        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n+        if (!showPOIs || zoom < 14) {\r\n+          sendToMap({ type: 'setPOIs', items: [] });\r\n+          return;\r\n+        };\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = [\r\n+          zoom,\r\n+          roundByZoom(minLng, zoom),\r\n+          roundByZoom(minLat, zoom),\r\n+          roundByZoom(maxLng, zoom),\r\n+          roundByZoom(maxLat, zoom),\r\n+        ].join('|');\r\n+\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            if (inflightRef.current.has(key)) {\r\n+              return;\r\n+            }\r\n+\r\n+            inflightRef.current.add(key);\r\n+\r\n+            const reqId = ++lastReqIdRef.current;\r\n+            \r\n+            try {\r\n+              const qs: string[] = [\r\n+                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+                `zoom=${zoom}`,\r\n+              ];\r\n+              if (center?.lat != null && center?.lng != null) {\r\n+                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+              }\r\n+              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+\r\n+              const r = await fetch(url);\r\n+              const items = await r.json();\r\n+\r\n+              if (reqId !== lastReqIdRef.current) {\r\n+                return; // a newer request finished after this one\r\n+              }\r\n+\r\n+              if (Array.isArray(items)) {\r\n+                poiCacheRef.current.set(key, items);\r\n+                sendToMap({ type: 'setPOIs', items });\r\n+              } else {\r\n+                sendToMap({ type: 'setPOIs', items: [] });\r\n+              }\r\n+            } catch (e) {\r\n+              console.log('[ERR] POI fetch failed for', key, e);\r\n+              sendToMap({ type: 'setPOIs', items: [] });\r\n+            } finally {\r\n+              inflightRef.current.delete(key);\r\n+            }\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({\r\n+                type: 'setPOIs',\r\n+                items,\r\n+                zoom,                       \r\n+                bbox: { minLng, minLat, maxLng, maxLat },  \r\n+              });\r\n+            }\r\n+\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 500);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+\r\n+    // Normalize party size based on type\r\n+    const normalizedParty =\r\n+      bookingType === 'GROUP'\r\n+        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n+        : 1; // CLASSIC & SOLO always 1\r\n+\r\n+    setSearching(true);\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId,\r\n+\r\n+      // NEW: booking type + group seats\r\n+      bookingType,\r\n+      partySize: normalizedParty,\r\n+    };\r\n+\r\n+    try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n+\r\n+  \r\n+  \r\n+\r\n+  // Set markers & trigger route drawing when destination is picked\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+      : null;\r\n+\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+    }\r\n+\r\n+    // üëâ draw route as soon as we have both ends\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+\r\n+          setFare(0);\r\n+        }\r\n+\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n+        }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n+    };\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+\r\n+  const cancelRideNow = async () => {\r\n+    try {\r\n+      if (!bookingId) {\r\n+        return;\r\n+      }\r\n+\r\n+      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ bookingId }),\r\n+      });\r\n+      const body = await resp.text();\r\n+\r\n+      // UI reset after server confirms\r\n+      setSearching(false);\r\n+      setBookingId(null);\r\n+      setMatchedDriver(null);\r\n+      setBookingConfirmed(false);\r\n+      setDestination(null);\r\n+      setTripCompleted(false);\r\n+      setAlertedBookingComplete(false);\r\n+      setShowBookingForm(false);\r\n+\r\n+      // Clear map + cached state\r\n+      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+      sendToMap({ type: \"clearRoute\" });\r\n+      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+      setFare(0);\r\n+    } catch (e) {\r\n+      console.log(\"[PHOME] cancel error\", e);\r\n+      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              mixedContentMode=\"always\"\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.searchcont}>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showPOIs) {\r\n+                  setShowPOIs(false);\r\n+                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                  sendToMap({ type: 'setPOIs', items: [] });\r\n+                } else {\r\n+                  setShowPOIs(true);\r\n+                  const b = lastBBoxRef.current;\r\n+                  if (b) {\r\n+                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n+                    if (zoom >= 14) {\r\n+                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                      poiFetchTimerRef.current = setTimeout(async () => {\r\n+                        try {\r\n+                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n+                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n+                          const r = await fetch(url);\r\n+                          const items = await r.json();\r\n+                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+                        } catch {\r\n+                          sendToMap({ type: 'setPOIs', items: [] });\r\n+                        }\r\n+                      }, 0);\r\n+                    } else {\r\n+                      sendToMap({ type: 'setPOIs', items: [] });\r\n+                    }\r\n+                  } else {\r\n+                    sendToMap({ type: 'requestBbox' });\r\n+                  }\r\n+                }\r\n+              }}\r\n+\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n+\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>\r\n+                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n+                  </Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={cancelRideNow}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {infoBoxMinimized ? (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  ) : (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {matchedDriver.selfieImage && (\r\n+                          <Image\r\n+                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n+                            style={{\r\n+                              width: 50,\r\n+                              height: 50,\r\n+                              borderRadius: 25,\r\n+                              marginRight: 10,\r\n+                            }}\r\n+                          />\r\n+                        )}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          {/* Chat button here */}\r\n+                          <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId: bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId: passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n+                            }}\r\n+                            style={{\r\n+                              marginTop: 8,\r\n+                              backgroundColor: \"#007bff\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 16,\r\n+                              borderRadius: 8,\r\n+                              alignSelf: \"flex-start\",\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                          </TouchableOpacity>\r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              const body = await resp.text();\r\n+\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch (e) {\r\n+                              console.log(\"[PHOME] cancel error\", e);\r\n+                            }\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n+                            setFare(0);\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+\r\n+                {/* Booking Type Selector */}\r\n+                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n+                  {[\r\n+                    { key: 'CLASSIC', label: 'Classic' },\r\n+                    { key: 'GROUP', label: 'Group' },\r\n+                    { key: 'SOLO', label: 'Solo' },\r\n+                  ].map((opt) => {\r\n+                    const active = bookingType === (opt.key as any);\r\n+                    return (\r\n+                      <TouchableOpacity\r\n+                        key={opt.key}\r\n+                        onPress={() => {\r\n+                          setBookingType(opt.key as any);\r\n+                          if (opt.key !== 'GROUP') setPartySize(2);\r\n+                        }}\r\n+                        style={{\r\n+                          flex: 1,\r\n+                          backgroundColor: active ? '#111' : '#fff',\r\n+                          borderWidth: 1,\r\n+                          borderColor: active ? '#111' : '#ccc',\r\n+                          paddingVertical: 10,\r\n+                          borderRadius: 10,\r\n+                          alignItems: 'center',\r\n+                        }}\r\n+                      >\r\n+                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n+                          {opt.label}\r\n+                        </Text>\r\n+                      </TouchableOpacity>\r\n+                    );\r\n+                  })}\r\n+                </View>\r\n+\r\n+                {/* Notes for Solo & Group */}\r\n+                {bookingType === 'SOLO' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n+                  </Text>\r\n+                )}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n+                  </Text>\r\n+                )}\r\n+\r\n+                {/* Group Party Size Stepper */}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n+                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n+                      </TouchableOpacity>\r\n+                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+                )}\r\n+\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <Text>From:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <Text>To:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  {/* <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  /> */}\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n+                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" placeholderTextColor=\"#A0A0A0\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                </ScrollView>\r\n+\r\n+                <View style={styles.fareContainer}>\r\n+                  <View>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Fare:\r\n+                    </Text>\r\n+                    <Text style={{ paddingLeft: 20 }}>\r\n+                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n+                    </Text>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Total Fare: ‚Ç±\r\n+                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n+                    </Text>\r\n+                  </View>\r\n+                  <TouchableOpacity\r\n+                    style={[\r\n+                      styles.bookButton,\r\n+                      // disable if invalid group count or no destination\r\n+                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n+                    ]}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n+                    onPress={handleBookNow}\r\n+                  >\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n+  panel: {\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n+  },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n+  dropdownItem: { padding: 10 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n+  \r\n+});\r\n"
                },
                {
                    "date": 1761228949486,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2068,1987 +2068,4 @@\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n   \r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, Keyboard, Image, BackHandler, ScrollView } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync(); // ensures we have a real file on device\r\n-  const uri = asset.localUri || asset.uri; // localUri preferred\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),          \r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-\r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-  const inflightRef  = useRef<Set<string>>(new Set());\r\n-  const lastReqIdRef = useRef(0);\r\n-  const [showPOIs, setShowPOIs] = useState(false);\r\n-  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n-  // --- Booking type + party size ---\r\n-  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n-  const [partySize, setPartySize] = useState<number>(2);\r\n-  const userMarkerOkRef = useRef(false);\r\n-\r\n-  function ensureUserMarker(lat: number, lng: number) {\r\n-    let attempts = 0;\r\n-    userMarkerOkRef.current = false;\r\n-\r\n-    const tryOnce = () => {\r\n-      attempts += 1;\r\n-      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n-\r\n-      if (!userMarkerOkRef.current && attempts < 6) {\r\n-        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n-      }\r\n-    };\r\n-\r\n-    tryOnce();\r\n-  }\r\n-\r\n-  function roundByZoom(value: number, zoom: number) {\r\n-    const decimals =\r\n-      zoom >= 18 ? 3 :\r\n-      zoom >= 16 ? 3 :\r\n-      zoom >= 15 ? 2 :\r\n-      /* <=14 */   2;\r\n-    const m = Math.pow(10, decimals);\r\n-    return Math.round(value * m) / m;\r\n-  }\r\n-\r\n-\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1)); \r\n-  }\r\n-\r\n-\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) {\r\n-      messageQueue.current.push(json);\r\n-      return;\r\n-    }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapReady, location]);\r\n-\r\n-\r\n-\r\n-  const canShowChatNotice =\r\n-    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n-\r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n-  ) => {\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n-\r\n-      const coords = data.features[0].geometry.coordinates; \r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n-\r\n-      const summary = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM = summary.distance ?? 0;\r\n-      const durationS = summary.duration ?? 0;\r\n-\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60\r\n-        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n-        : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n-      const fareText = `‚Ç±${computedFare} est`;\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm, \r\n-        distanceText,     \r\n-        durationText,\r\n-        fareText,  \r\n-      });\r\n-\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n-    }\r\n-  };\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lng = location.longitude; // NOTE: lng\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    sendToMap({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    });\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-        // NEW: force-check pin\r\n-        ensureUserMarker(location.latitude, location.longitude);\r\n-      }\r\n-\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          sendToMap({\r\n-            type: \"updateUserLoc\",\r\n-            latitude: pos.coords.latitude,\r\n-            longitude: pos.coords.longitude,\r\n-            accuracy: pos.coords.accuracy ?? 15,\r\n-            avatarUrl,\r\n-          });\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl, mapHtml]); // reattach if HTML reloaded\r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapHtml]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            sendToMap({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            });\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  // useEffect(() => {\r\n-  //   const backAction = () => {\r\n-  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-  //       {\r\n-  //         text: \"Logout\",\r\n-  //         onPress: async () => {\r\n-  //           await AsyncStorage.removeItem(\"passengerId\");\r\n-  //           router.replace(\"/login_and_reg/plogin\");\r\n-  //         },\r\n-  //       },\r\n-  //     ]);\r\n-  //     return true;\r\n-  //   };\r\n-  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-  //   return () => backHandler.remove();\r\n-  // }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location) return;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        // --- Map init ---\r\n-        const map = L.map('map', {\r\n-          zoomControl: true,\r\n-          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n-          maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n-          maxZoom: 19, \r\n-          noWrap: true\r\n-        }).setView([${location.latitude}, ${location.longitude}], 15);\r\n-\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        let poiLayer = L.layerGroup().addTo(map);\r\n-        let landmarkLayer = L.layerGroup().addTo(map);\r\n-        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        let userMarkerPlaced = false; // <‚Äî NEW\r\n-\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip({ permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-          userMarkerPlaced = true; // <‚Äî NEW\r\n-        }\r\n-\r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        const poiMarkers = new Map();        // id -> L.Marker\r\n-        const iconCache  = {};               // category -> L.Icon\r\n-        let poiBatchHandle = null;           // cancel previous batch\r\n-\r\n-        function getPoiIcon(cat, poiIcons) {\r\n-          if (iconCache[cat]) return iconCache[cat];\r\n-\r\n-          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n-            ? poiIcons[cat]\r\n-            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n-\r\n-          iconCache[cat] = L.icon({\r\n-            iconUrl: url,\r\n-            iconSize: [28, 28],\r\n-            iconAnchor: [14, 28],\r\n-          });\r\n-          return iconCache[cat];\r\n-        }\r\n-\r\n-        function addOrUpdatePOIMarker(it, poiIcons) {\r\n-          const existing = poiMarkers.get(it.id);\r\n-          if (existing) {\r\n-            // update position if it changed\r\n-            const curr = existing.getLatLng();\r\n-            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n-              existing.setLatLng([it.lat, it.lng]);\r\n-            }\r\n-            return;\r\n-          }\r\n-          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n-          const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-          // build popup with \"Set Destination\"\r\n-          const container = document.createElement('div');\r\n-          const title = document.createElement('b');\r\n-          title.textContent = it.name || it.category || 'POI';\r\n-          container.appendChild(title);\r\n-          container.appendChild(document.createElement('br'));\r\n-          const btn = document.createElement('button');\r\n-          btn.textContent = 'Set Destination';\r\n-          btn.style.marginTop = '6px';\r\n-          btn.onclick = function () {\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'setDestinationFromPOI',\r\n-              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-            }));\r\n-          };\r\n-          container.appendChild(btn);\r\n-          marker.bindPopup(container);\r\n-\r\n-          marker.addTo(poiLayer);\r\n-          poiMarkers.set(it.id, marker);\r\n-        }\r\n-        \r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        // --- Helpers ---\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip( { permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-        }\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        map.on('moveend', function () {\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        });\r\n-\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          if (msg.type === 'ensureUserMarker') {\r\n-            const lat = Number(msg.latitude);\r\n-            const lng = Number(msg.longitude);\r\n-            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n-              upsertUserMarker(lat, lng);\r\n-            }\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'userMarkerEnsured',\r\n-              placed: !!userMarker,\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            upsertUserMarker(msg.latitude, msg.longitude);\r\n-            return;\r\n-          }\r\n-\r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n-            clearRoute();\r\n-\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n-              .setContent(label || '')\r\n-              .setLatLng(mid)\r\n-              .addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n-            }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-          if (msg.type === 'requestBbox') {\r\n-            const b = map.getBounds();\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'bbox',\r\n-              bbox: {\r\n-                minLng: b.getWest(),\r\n-                minLat: b.getSouth(),\r\n-                maxLng: b.getEast(),\r\n-                maxLat: b.getNorth()\r\n-              },\r\n-              zoom: map.getZoom()\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-          const poiIcons = ${iconJson};\r\n-          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n-\r\n-            const z = Number(msg.zoom) || currentZoomLevel;\r\n-            const b = msg.bbox || null;\r\n-\r\n-            // Collect desired items from payload\r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n-            const desiredIds = new Set(desired.keys());\r\n-\r\n-            // Decide strategy based on zoom direction\r\n-            if (z > currentZoomLevel) {\r\n-              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n-              if (b) {\r\n-                for (const [id, marker] of poiMarkers) {\r\n-                  const p = marker.getLatLng();\r\n-                  if (!bboxContains(b, p.lat, p.lng)) {\r\n-                    poiLayer.removeLayer(marker);\r\n-                    poiMarkers.delete(id);\r\n-                  }\r\n-                }\r\n-              }\r\n-            } else if (z < currentZoomLevel) {\r\n-              // ---- ZOOM OUT: shrink to what backend sent\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const keep = desiredIds.has(id);\r\n-                const p = marker.getLatLng();\r\n-                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n-                if (!keep || !onScreen) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            } else {\r\n-              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const p = marker.getLatLng();\r\n-                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n-                if (drop) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            }\r\n-\r\n-            // Build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n-\r\n-            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n-            const total = toAdd.length;\r\n-            const BATCH =\r\n-              total > 300 ? 80 :\r\n-              total > 150 ? 50 :\r\n-              total > 60  ? 35 :\r\n-              25; // small = faster draw\r\n-            const DELAY = total > 150 ? 20 : 10;\r\n-\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n-\r\n-            let i = 0;\r\n-            const addBatch = () => {\r\n-              const end = Math.min(i + BATCH, total);\r\n-              for (; i < end; i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n-                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n-\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n-\r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-\r\n-                // üî• Fade-in animation\r\n-                let op = 0;\r\n-                const fade = () => {\r\n-                  op += 0.15;\r\n-                  if (op <= 1) {\r\n-                    marker.setOpacity(op);\r\n-                    requestAnimationFrame(fade);\r\n-                  } else {\r\n-                    marker.setOpacity(1);\r\n-                  }\r\n-                };\r\n-                requestAnimationFrame(fade);\r\n-              }\r\n-\r\n-              if (i < total) {\r\n-                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n-              } else {\r\n-                poiBatchHandle = null;\r\n-              }\r\n-            };\r\n-\r\n-\r\n-            addBatch();\r\n-\r\n-            currentZoomLevel = z;\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-          // Render Landmarks (pin markers)\r\n-          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n-            landmarkLayer.clearLayers();\r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n-              L.marker([it.lat, it.lng])\r\n-                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n-                .addTo(landmarkLayer);\r\n-            });\r\n-            return;\r\n-          }\r\n-          if (msg.type === 'clearLandmarks') {\r\n-            landmarkLayer.clearLayers();\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [location, iconData]);\r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-  }, [mapHtml, location, avatarUrl]);\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      // Always see what's coming in:\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-      if (parsed.type === 'userMarkerEnsured') {\r\n-        userMarkerOkRef.current = !!parsed.placed;\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = Number(parsed.zoom) || 0;\r\n-        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n-        if (!showPOIs || zoom < 14) {\r\n-          sendToMap({ type: 'setPOIs', items: [] });\r\n-          return;\r\n-        };\r\n-\r\n-        const center = parsed.center;\r\n-        if (center && lastCenterRef.current) {\r\n-          const moved = haversine(lastCenterRef.current, center);\r\n-          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n-        }\r\n-        if (center) lastCenterRef.current = center;\r\n-\r\n-        const key = [\r\n-          zoom,\r\n-          roundByZoom(minLng, zoom),\r\n-          roundByZoom(minLat, zoom),\r\n-          roundByZoom(maxLng, zoom),\r\n-          roundByZoom(maxLat, zoom),\r\n-        ].join('|');\r\n-\r\n-        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n-        lastPoiKeyRef.current = key;\r\n-\r\n-        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-        poiFetchTimerRef.current = setTimeout(async () => {\r\n-          try {\r\n-            const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-              `zoom=${zoom}`,\r\n-            ];\r\n-            if (center?.lat != null && center?.lng != null) {\r\n-              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-            }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            if (poiCacheRef.current.has(key)) {\r\n-              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n-              return;\r\n-            }\r\n-\r\n-            if (inflightRef.current.has(key)) {\r\n-              return;\r\n-            }\r\n-\r\n-            inflightRef.current.add(key);\r\n-\r\n-            const reqId = ++lastReqIdRef.current;\r\n-            \r\n-            try {\r\n-              const qs: string[] = [\r\n-                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-                `zoom=${zoom}`,\r\n-              ];\r\n-              if (center?.lat != null && center?.lng != null) {\r\n-                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-              }\r\n-              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-\r\n-              const r = await fetch(url);\r\n-              const items = await r.json();\r\n-\r\n-              if (reqId !== lastReqIdRef.current) {\r\n-                return; // a newer request finished after this one\r\n-              }\r\n-\r\n-              if (Array.isArray(items)) {\r\n-                poiCacheRef.current.set(key, items);\r\n-                sendToMap({ type: 'setPOIs', items });\r\n-              } else {\r\n-                sendToMap({ type: 'setPOIs', items: [] });\r\n-              }\r\n-            } catch (e) {\r\n-              console.log('[ERR] POI fetch failed for', key, e);\r\n-              sendToMap({ type: 'setPOIs', items: [] });\r\n-            } finally {\r\n-              inflightRef.current.delete(key);\r\n-            }\r\n-            const r = await fetch(url);\r\n-            const items = await r.json();\r\n-            if (Array.isArray(items)) {\r\n-              poiCacheRef.current.set(key, items);\r\n-              sendToMap({\r\n-                type: 'setPOIs',\r\n-                items,\r\n-                zoom,                       \r\n-                bbox: { minLng, minLat, maxLng, maxLat },  \r\n-              });\r\n-            }\r\n-\r\n-          } catch {\r\n-            sendToMap({ type: 'setPOIs', items: [] });\r\n-          }\r\n-        }, 500);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'setDestinationFromPOI') {\r\n-        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n-        setDestination(dest);\r\n-        setDropoffName(parsed.label || 'POI Destination');\r\n-\r\n-        if (!location) {\r\n-          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-          return;\r\n-        }\r\n-        const { latitude, longitude } = location;\r\n-\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          dest\r\n-        );\r\n-        sendToMap({\r\n-          type: 'setMarkers',\r\n-          destination: dest,\r\n-          driver: null,\r\n-        });\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-\r\n-    // Normalize party size based on type\r\n-    const normalizedParty =\r\n-      bookingType === 'GROUP'\r\n-        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n-        : 1; // CLASSIC & SOLO always 1\r\n-\r\n-    setSearching(true);\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId,\r\n-\r\n-      // NEW: booking type + group seats\r\n-      bookingType,\r\n-      partySize: normalizedParty,\r\n-    };\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  // {status === \"accepted\" && bookingId && (\r\n-  //   <ChatNotice\r\n-  //     bookingId={bookingId}\r\n-  //     role=\"passenger\"\r\n-  //     onGoToChat={() =>\r\n-  //       router.push({\r\n-  //         pathname: \"/chatcomponent\",\r\n-  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-  //       })\r\n-  //     }\r\n-  //   />\r\n-  // )}\r\n-\r\n-  \r\n-  \r\n-\r\n-  // Set markers & trigger route drawing when destination is picked\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n-\r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-\r\n-  const cancelRideNow = async () => {\r\n-    try {\r\n-      if (!bookingId) {\r\n-        return;\r\n-      }\r\n-\r\n-      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ bookingId }),\r\n-      });\r\n-      const body = await resp.text();\r\n-\r\n-      // UI reset after server confirms\r\n-      setSearching(false);\r\n-      setBookingId(null);\r\n-      setMatchedDriver(null);\r\n-      setBookingConfirmed(false);\r\n-      setDestination(null);\r\n-      setTripCompleted(false);\r\n-      setAlertedBookingComplete(false);\r\n-      setShowBookingForm(false);\r\n-\r\n-      // Clear map + cached state\r\n-      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-      sendToMap({ type: \"clearRoute\" });\r\n-      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-      setFare(0);\r\n-    } catch (e) {\r\n-      console.log(\"[PHOME] cancel error\", e);\r\n-      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.searchcont}>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lng}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showLandmarks) {\r\n-                  sendToMap({ type: 'clearLandmarks' });\r\n-                  setShowLandmarks(false);\r\n-                } else {\r\n-                  loadLandmarks(); // same function we made before\r\n-                  setShowLandmarks(true);\r\n-                }\r\n-              }}\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n-            </TouchableOpacity>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showPOIs) {\r\n-                  setShowPOIs(false);\r\n-                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                  sendToMap({ type: 'setPOIs', items: [] });\r\n-                } else {\r\n-                  setShowPOIs(true);\r\n-                  const b = lastBBoxRef.current;\r\n-                  if (b) {\r\n-                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n-                    if (zoom >= 14) {\r\n-                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                      poiFetchTimerRef.current = setTimeout(async () => {\r\n-                        try {\r\n-                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n-                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n-                          const r = await fetch(url);\r\n-                          const items = await r.json();\r\n-                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n-                        } catch {\r\n-                          sendToMap({ type: 'setPOIs', items: [] });\r\n-                        }\r\n-                      }, 0);\r\n-                    } else {\r\n-                      sendToMap({ type: 'setPOIs', items: [] });\r\n-                    }\r\n-                  } else {\r\n-                    sendToMap({ type: 'requestBbox' });\r\n-                  }\r\n-                }\r\n-              }}\r\n-\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n-            </TouchableOpacity>\r\n-\r\n-\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>\r\n-                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n-                  </Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={cancelRideNow}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{\r\n-                              width: 50,\r\n-                              height: 50,\r\n-                              borderRadius: 25,\r\n-                              marginRight: 10,\r\n-                            }}\r\n-                          />\r\n-                        )}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n-\r\n-                          {/* Chat button here */}\r\n-                          <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              router.push({\r\n-                                pathname: \"/ChatRoom\",\r\n-                                params: {\r\n-                                  bookingId: bookingId,\r\n-                                  driverId: matchedDriver?.driverId,\r\n-                                  passengerId: passengerId,\r\n-                                  role: \"passenger\",\r\n-                                },\r\n-                              });\r\n-                            }}\r\n-                            style={{\r\n-                              marginTop: 8,\r\n-                              backgroundColor: \"#007bff\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 16,\r\n-                              borderRadius: 8,\r\n-                              alignSelf: \"flex-start\",\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n-                          </TouchableOpacity>\r\n-                        </View>\r\n-                      </View>\r\n-\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              const body = await resp.text();\r\n-\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch (e) {\r\n-                              console.log(\"[PHOME] cancel error\", e);\r\n-                            }\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-                            sendToMap({ type: \"clearRoute\" });\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-\r\n-                {/* Booking Type Selector */}\r\n-                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n-                  {[\r\n-                    { key: 'CLASSIC', label: 'Classic' },\r\n-                    { key: 'GROUP', label: 'Group' },\r\n-                    { key: 'SOLO', label: 'Solo' },\r\n-                  ].map((opt) => {\r\n-                    const active = bookingType === (opt.key as any);\r\n-                    return (\r\n-                      <TouchableOpacity\r\n-                        key={opt.key}\r\n-                        onPress={() => {\r\n-                          setBookingType(opt.key as any);\r\n-                          if (opt.key !== 'GROUP') setPartySize(2);\r\n-                        }}\r\n-                        style={{\r\n-                          flex: 1,\r\n-                          backgroundColor: active ? '#111' : '#fff',\r\n-                          borderWidth: 1,\r\n-                          borderColor: active ? '#111' : '#ccc',\r\n-                          paddingVertical: 10,\r\n-                          borderRadius: 10,\r\n-                          alignItems: 'center',\r\n-                        }}\r\n-                      >\r\n-                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n-                          {opt.label}\r\n-                        </Text>\r\n-                      </TouchableOpacity>\r\n-                    );\r\n-                  })}\r\n-                </View>\r\n-\r\n-                {/* Notes for Solo & Group */}\r\n-                {bookingType === 'SOLO' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n-                  </Text>\r\n-                )}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n-                  </Text>\r\n-                )}\r\n-\r\n-                {/* Group Party Size Stepper */}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n-                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n-                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n-                      </TouchableOpacity>\r\n-                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n-                  </View>\r\n-                )}\r\n-\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <Text>From:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <Text>To:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  {/* <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                    value={destinationLabel}\r\n-                    onChangeText={setDestinationLabel}\r\n-                  /> */}\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" value={notes} onChangeText={setNotes} />\r\n-                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n-                </ScrollView>\r\n-\r\n-                <View style={styles.fareContainer}>\r\n-                  <View>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Fare:\r\n-                    </Text>\r\n-                    <Text style={{ paddingLeft: 20 }}>\r\n-                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n-                    </Text>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Total Fare: ‚Ç±\r\n-                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n-                    </Text>\r\n-                  </View>\r\n-                  <TouchableOpacity\r\n-                    style={[\r\n-                      styles.bookButton,\r\n-                      // disable if invalid group count or no destination\r\n-                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n-                    ]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n-                    onPress={handleBookNow}\r\n-                  >\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-  \r\n-});\r\n"
                },
                {
                    "date": 1761228979631,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -553,9 +553,9 @@\n \r\n \r\n   // Generate map HTML when location changes\r\n   useEffect(() => {\r\n-  if (!iconData || !location || mapHtml) return;\r\n+  if (!location || mapHtml) return;\r\n \r\n   // lock the very first location for the initial setView\r\n   if (!initialLocRef.current) {\r\n     initialLocRef.current = {\r\n"
                },
                {
                    "date": 1761228990092,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -564,9 +564,8 @@\n     };\r\n   }\r\n \r\n   const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n \r\n   const html = String.raw`\r\n   <!DOCTYPE html>\r\n   <html>\r\n"
                },
                {
                    "date": 1761229021370,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -564,8 +564,9 @@\n     };\r\n   }\r\n \r\n   const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n \r\n   const html = String.raw`\r\n   <!DOCTYPE html>\r\n   <html>\r\n@@ -1026,9 +1027,9 @@\n     </body>\r\n   </html>\r\n   `;\r\n   setMapHtml(html);\r\n-  }, [iconData, mapHtml, location]);  \r\n+  }, [mapHtml, location]);  \r\n \r\n \r\n \r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1761229090624,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -234,9 +234,15 @@\n     }\r\n     mapRef.current.postMessage(json);\r\n   };\r\n \r\n+  useEffect(() => {\r\n+    if (!mapReady || !iconData) return;\r\n+    // If you add a handler in WebView for type:'preloadIcons', send them here:\r\n+    sendToMap({ type: 'preloadIcons', icons: iconData });\r\n+  }, [mapReady, iconData]);\r\n \r\n+\r\n   useEffect(() => {\r\n     (async () => {\r\n       const out: Record<string, string> = {};\r\n       for (const k of Object.keys(POI_ICON_FILES)) {\r\n"
                },
                {
                    "date": 1761229130374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -236,9 +236,8 @@\n   };\r\n \r\n   useEffect(() => {\r\n     if (!mapReady || !iconData) return;\r\n-    // If you add a handler in WebView for type:'preloadIcons', send them here:\r\n     sendToMap({ type: 'preloadIcons', icons: iconData });\r\n   }, [mapReady, iconData]);\r\n \r\n \r\n@@ -1580,8 +1579,9 @@\n               pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n               originWhitelist={[\"*\"]}\r\n               source={{ html: mapHtml }}\r\n               javaScriptEnabled\r\n+              allowFileAccess\r\n               onLoadEnd={() => setMapReady(true)}\r\n               style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n               mixedContentMode=\"always\"\r\n               onMessage={handleMapMessage}\r\n"
                },
                {
                    "date": 1761229166690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1057,9 +1057,18 @@\n   useEffect(() => {\r\n     console.log(\"[PHome] HTML built once?\", !!mapHtml);\r\n   }, [mapHtml]);\r\n \r\n+  useEffect(() => {\r\n+    console.log('[PHome] guards:',\r\n+      'hasLocation=', !!location,\r\n+      'hasIconData=', !!iconData,\r\n+      'hasMapHtml=', !!mapHtml\r\n+    );\r\n+  }, [location, iconData, mapHtml]);\r\n \r\n+\r\n+\r\n   // Reverse geocode for drop-off location\r\n   const handleMapMessage = async (event: any) => {\r\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n"
                },
                {
                    "date": 1761238043026,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -330,13 +330,14 @@\n         distanceKm, \r\n         distanceText,     \r\n         durationText,\r\n         fareText,  \r\n+        \r\n       });\r\n \r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Could not fetch route.\");\r\n+      Alert.alert(\"Route error\", \"Your Destination is outside of our Driver's Reach.\");\r\n     }\r\n   };\r\n \r\n   const onChangeQuery = (t: string) => {\r\n@@ -455,13 +456,9 @@\n     })();\r\n \r\n     return () => sub?.remove();\r\n   }, [avatarUrl]); \r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapHtml, location]);\r\n+  \r\n \r\n \r\n   useEffect(() => {\r\n     let headSub: Location.LocationSubscription | null = null;\r\n@@ -510,9 +507,16 @@\n       }).catch(() => setPickupName(\"Current Location\"));\r\n     }\r\n   }, [location]);\r\n \r\n+  \r\n   useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapHtml, location]);\r\n+\r\n+  useEffect(() => {\r\n     if (!livePos) return;\r\n     console.log(\"LIVE POS ‚Üí\", livePos.latitude, livePos.longitude);\r\n   }, [livePos]);\r\n \r\n@@ -1217,8 +1221,39 @@\n       }\r\n     } catch {}\r\n   };\r\n \r\n+    // Set markers & trigger route drawing when destination is picked\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+    const driverCoords = matchedDriver?.location\r\n+      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+      : null;\r\n+\r\n+    if (driverCoords && destination) {\r\n+      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+    }\r\n+\r\n+    // üëâ draw route as soon as we have both ends\r\n+    if (destination && location) {\r\n+      fetchORSRoute(location, destination);\r\n+    }\r\n+  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n       return;\r\n@@ -1295,27 +1330,9 @@\n \r\n   \r\n   \r\n \r\n-  // Set markers & trigger route drawing when destination is picked\r\n   useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n-\r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n-\r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  useEffect(() => {\r\n     const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n     const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n     return () => { showSub.remove(); hideSub.remove(); };\r\n   }, []);\r\n@@ -1562,21 +1579,10 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n+  \r\n \r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n"
                },
                {
                    "date": 1761238480686,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -284,9 +284,10 @@\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number }\r\n+    to: { latitude: number; longitude: number },\r\n+    reframe = false,\r\n   ) => {\r\n     try {\r\n       const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n         method: 'POST',\r\n@@ -330,9 +331,9 @@\n         distanceKm, \r\n         distanceText,     \r\n         durationText,\r\n         fareText,  \r\n-        \r\n+        reframe\r\n       });\r\n \r\n     } catch (err) {\r\n       console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n"
                },
                {
                    "date": 1761238520596,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -832,9 +832,11 @@\n           if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n             clearRoute();\r\n \r\n             routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-            map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+            if (msg.reframe) {\r\n+              map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+            }\r\n \r\n             const mid = msg.route[Math.floor(msg.route.length/2)];\r\n             const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n             distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n"
                },
                {
                    "date": 1761238544701,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -186,8 +186,11 @@\n   const [partySize, setPartySize] = useState<number>(2);\r\n   const userMarkerOkRef = useRef(false);\r\n   const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n   const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n+  const routeFramedRef = useRef(false);\r\n+  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n+  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n \r\n   function ensureUserMarker(lat: number, lng: number) {\r\n     let attempts = 0;\r\n     userMarkerOkRef.current = false;\r\n"
                },
                {
                    "date": 1761238561918,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -279,10 +279,25 @@\n     });\r\n     return () => sub.remove();\r\n   }, []);\r\n \r\n+  useEffect(() => {\r\n+    if (!destination || !location) return;\r\n \r\n+    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n \r\n+    // If destination changed, (re)draw and frame once\r\n+    if (lastRouteDestKeyRef.current !== destKey) {\r\n+      fetchORSRoute(location, destination, true); // reframe = true\r\n+      routeFramedRef.current = true;\r\n+      lastRouteDestKeyRef.current = destKey;\r\n+      lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n+    }\r\n+  }, [destination, location]);\r\n+\r\n+\r\n+\r\n+\r\n   const canShowChatNotice =\r\n     bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n"
                },
                {
                    "date": 1761238568452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -284,9 +284,8 @@\n     if (!destination || !location) return;\r\n \r\n     const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n \r\n-    // If destination changed, (re)draw and frame once\r\n     if (lastRouteDestKeyRef.current !== destKey) {\r\n       fetchORSRoute(location, destination, true); // reframe = true\r\n       routeFramedRef.current = true;\r\n       lastRouteDestKeyRef.current = destKey;\r\n"
                },
                {
                    "date": 1761238676250,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1242,24 +1242,24 @@\n     } catch {}\r\n   };\r\n \r\n     // Set markers & trigger route drawing when destination is picked\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || bookingConfirmed) return;\r\n+  // useEffect(() => {\r\n+  //   if (!mapRef.current || bookingConfirmed) return;\r\n \r\n-    const driverCoords = matchedDriver?.location\r\n-      ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-      : null;\r\n+  //   const driverCoords = matchedDriver?.location\r\n+  //     ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+  //     : null;\r\n \r\n-    if (driverCoords && destination) {\r\n-      mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-    }\r\n+  //   if (driverCoords && destination) {\r\n+  //     mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+  //   }\r\n \r\n-    // üëâ draw route as soon as we have both ends\r\n-    if (destination && location) {\r\n-      fetchORSRoute(location, destination);\r\n-    }\r\n-  }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+  //   // üëâ draw route as soon as we have both ends\r\n+  //   if (destination && location) {\r\n+  //     fetchORSRoute(location, destination);\r\n+  //   }\r\n+  // }, [destination, matchedDriver, bookingConfirmed, location]);\r\n \r\n   const loadLandmarks = async () => {\r\n     try {\r\n       const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n"
                },
                {
                    "date": 1761238710972,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1089,10 +1089,23 @@\n       'hasMapHtml=', !!mapHtml\r\n     );\r\n   }, [location, iconData, mapHtml]);\r\n \r\n+  useEffect(() => {\r\n+    if (!destination || !location || !routeFramedRef.current) return;\r\n \r\n+    const now = { lat: location.latitude, lng: location.longitude };\r\n+    const moved = lastOriginRef.current ? haversine(lastOriginRef.current, now) : Infinity;\r\n \r\n+    if (moved > 150) {                 // tweak threshold as you like\r\n+      fetchORSRoute(location, destination, false); // reframe = false\r\n+      lastOriginRef.current = now;\r\n+    }\r\n+  }, [location, destination]);\r\n+\r\n+\r\n+\r\n+\r\n   // Reverse geocode for drop-off location\r\n   const handleMapMessage = async (event: any) => {\r\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n"
                },
                {
                    "date": 1761246204452,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -285,9 +285,9 @@\n \r\n     const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n \r\n     if (lastRouteDestKeyRef.current !== destKey) {\r\n-      fetchORSRoute(location, destination, true); // reframe = true\r\n+      fetchORSRoute(location, destination, true); \r\n       routeFramedRef.current = true;\r\n       lastRouteDestKeyRef.current = destKey;\r\n       lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n     }\r\n@@ -295,70 +295,63 @@\n \r\n \r\n \r\n \r\n-  const canShowChatNotice =\r\n-    bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+  const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const routeReqIdRef = useRef(0);\r\n+\r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n-    to: { latitude: number; longitude: number },\r\n-    reframe = false,\r\n+    to:   { latitude: number; longitude: number },\r\n+    reframe: boolean = false\r\n   ) => {\r\n+    const myReqId = ++routeReqIdRef.current;\r\n+\r\n     try {\r\n       const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n         method: 'POST',\r\n         headers: { 'Content-Type': 'application/json' },\r\n         body: JSON.stringify({\r\n           start: [from.longitude, from.latitude],\r\n-          end: [to.longitude, to.latitude],\r\n+          end:   [to.longitude,   to.latitude],\r\n         }),\r\n       });\r\n \r\n       const data = await res.json();\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n \r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) {\r\n-        console.error(\"üõë Invalid ORS response:\", data);\r\n-        Alert.alert(\"Route error\", \"Failed to get route from ORS.\");\r\n-        return;\r\n-      }\r\n+      if (myReqId !== routeReqIdRef.current) return; \r\n \r\n       const coords = data.features[0].geometry.coordinates; \r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]); \r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n \r\n-      const summary = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM = summary.distance ?? 0;\r\n-      const durationS = summary.duration ?? 0;\r\n-\r\n+      const summary    = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM  = summary.distance ?? 0;\r\n+      const durationS  = summary.duration ?? 0;\r\n       const distanceKm = distanceM / 1000;\r\n-\r\n       const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60\r\n-        ? `${Math.floor(mins / 60)}h ${mins % 60}m`\r\n-        : `${mins} min`;\r\n+      const mins         = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n \r\n-      const computedFare = calculateFare(distanceKm, discount); // or 'none'\r\n-      const fareText = `‚Ç±${computedFare} est`;\r\n+      const computedFare = calculateFare(distanceKm, discount);\r\n       setFare(computedFare);\r\n \r\n       sendToMap({\r\n         type: 'drawRoute',\r\n         route: polylinePoints,\r\n-        distanceKm, \r\n-        distanceText,     \r\n+        distanceKm,\r\n+        distanceText,\r\n         durationText,\r\n-        fareText,  \r\n-        reframe\r\n+        fareText: `‚Ç±${computedFare} est`,\r\n+        reframe,           \r\n       });\r\n-\r\n-    } catch (err) {\r\n-      console.error(\"‚ùå Failed to fetch ORS route:\", err);\r\n-      Alert.alert(\"Route error\", \"Your Destination is outside of our Driver's Reach.\");\r\n+    } catch (e) {\r\n     }\r\n   };\r\n \r\n+\r\n   const onChangeQuery = (t: string) => {\r\n     setQuery(t);\r\n \r\n     if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n"
                },
                {
                    "date": 1761246315484,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -393,9 +393,10 @@\n \r\n     // draw route immediately\r\n     fetchORSRoute(\r\n       { latitude: location.latitude, longitude: location.longitude },\r\n-      dest\r\n+      dest,\r\n+      true\r\n     );\r\n \r\n     // (optional) update markers\r\n     sendToMap({\r\n@@ -1089,9 +1090,9 @@\n     const now = { lat: location.latitude, lng: location.longitude };\r\n     const moved = lastOriginRef.current ? haversine(lastOriginRef.current, now) : Infinity;\r\n \r\n     if (moved > 150) {                 // tweak threshold as you like\r\n-      fetchORSRoute(location, destination, false); // reframe = false\r\n+      fetchORSRoute(location, destination, false); \r\n       lastOriginRef.current = now;\r\n     }\r\n   }, [location, destination]);\r\n \r\n"
                },
                {
                    "date": 1761246347414,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -189,9 +189,18 @@\n   const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n   const routeFramedRef = useRef(false);\r\n   const lastRouteDestKeyRef = useRef<string | null>(null);\r\n   const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteAtRef   = useRef(0);\r\n \r\n+  const ROUTE_MIN_MOVE_M   = 35;   // recompute if user moved >= 35 m\r\n+  const ROUTE_MIN_INTERVAL = 8000; // or every 8s, whichever comes first\r\n+\r\n+  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n+\r\n+\r\n   function ensureUserMarker(lat: number, lng: number) {\r\n     let attempts = 0;\r\n     userMarkerOkRef.current = false;\r\n \r\n"
                },
                {
                    "date": 1761246759680,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -472,8 +472,9 @@\n             avatarUrl,\r\n           });\r\n           if (accuracy && accuracy > 80) return;\r\n         }\r\n+        \r\n       );\r\n     })();\r\n \r\n     return () => sub?.remove();\r\n@@ -1065,17 +1066,47 @@\n \r\n \r\n   useEffect(() => {\r\n     if (!mapRef.current || !location) return;\r\n+\r\n+    // üîµ Update passenger marker live\r\n     mapRef.current.postMessage(JSON.stringify({\r\n       type: \"updateUserLoc\",\r\n       latitude: location.latitude,\r\n       longitude: location.longitude,\r\n       accuracy: 15,\r\n       avatarUrl,\r\n     }));\r\n-  }, [location, avatarUrl]);\r\n \r\n+    // üß≠ Recompute route occasionally (no zoom)\r\n+    const now = Date.now();\r\n+    if (destination) {\r\n+      const fromLL = { lat: location.latitude, lng: location.longitude };\r\n+      const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n+\r\n+      const movedM = haversine(\r\n+        lastRouteFromRef.current ?? fromLL,\r\n+        fromLL\r\n+      );\r\n+\r\n+      const shouldRecompute =\r\n+        movedM >= ROUTE_MIN_MOVE_M ||\r\n+        (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+\r\n+      if (shouldRecompute) {\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          destination,\r\n+          false // ‚ö†Ô∏è never reframe on live updates\r\n+        );\r\n+        lastRouteFromRef.current = fromLL;\r\n+        lastRouteToRef.current   = toLL;\r\n+        lastRouteAtRef.current   = now;\r\n+      }\r\n+    }\r\n+  }, [location, avatarUrl, destination]);\r\n+\r\n+\r\n   useEffect(() => {\r\n     if (!initialLocRef.current && location) {\r\n       initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n     }\r\n@@ -1105,10 +1136,13 @@\n     }\r\n   }, [location, destination]);\r\n \r\n \r\n+  \r\n \r\n \r\n+\r\n+\r\n   // Reverse geocode for drop-off location\r\n   const handleMapMessage = async (event: any) => {\r\n     try {\r\n       const parsed = JSON.parse(event.nativeEvent.data);\r\n"
                },
                {
                    "date": 1761247084487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -312,9 +312,9 @@\n \r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n     to:   { latitude: number; longitude: number },\r\n-    reframe: boolean = false\r\n+    reframe: boolean = false         // <-- NEW\r\n   ) => {\r\n     const myReqId = ++routeReqIdRef.current;\r\n \r\n     try {\r\n@@ -328,18 +328,18 @@\n       });\r\n \r\n       const data = await res.json();\r\n       if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n-\r\n       if (myReqId !== routeReqIdRef.current) return; \r\n \r\n-      const coords = data.features[0].geometry.coordinates; \r\n+      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n       const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n \r\n       const summary    = data.features?.[0]?.properties?.summary || {};\r\n       const distanceM  = summary.distance ?? 0;\r\n       const durationS  = summary.duration ?? 0;\r\n       const distanceKm = distanceM / 1000;\r\n+\r\n       const distanceText = `${distanceKm.toFixed(2)} km`;\r\n       const mins         = Math.round(durationS / 60);\r\n       const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n \r\n@@ -352,15 +352,15 @@\n         distanceKm,\r\n         distanceText,\r\n         durationText,\r\n         fareText: `‚Ç±${computedFare} est`,\r\n-        reframe,           \r\n+        reframe,                        \r\n       });\r\n-    } catch (e) {\r\n-    }\r\n+    } catch {}\r\n   };\r\n \r\n \r\n+\r\n   const onChangeQuery = (t: string) => {\r\n     setQuery(t);\r\n \r\n     if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n"
                },
                {
                    "date": 1761247128895,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -400,8 +400,11 @@\n       return;\r\n     }\r\n \r\n     // draw route immediately\r\n+    lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n+    lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n+    lastRouteAtRef.current   = Date.now();\r\n     fetchORSRoute(\r\n       { latitude: location.latitude, longitude: location.longitude },\r\n       dest,\r\n       true\r\n"
                },
                {
                    "date": 1761247524064,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -473,8 +473,34 @@\n             longitude,\r\n             accuracy: accuracy ?? 15,\r\n             avatarUrl,\r\n           });\r\n+          if (destination) {\r\n+            const fromLL = { lat: latitude, lng: longitude };\r\n+            const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n+\r\n+            const movedM = haversine(\r\n+              lastRouteFromRef.current ?? fromLL,\r\n+              fromLL\r\n+            );\r\n+\r\n+            const now = Date.now();\r\n+            const shouldRecompute =\r\n+              movedM >= ROUTE_MIN_MOVE_M ||\r\n+              (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+\r\n+            if (shouldRecompute) {\r\n+              fetchORSRoute(\r\n+                { latitude, longitude },\r\n+                destination,\r\n+                false                       // <-- DO NOT reframe on live updates\r\n+              );\r\n+              lastRouteFromRef.current = fromLL;\r\n+              lastRouteToRef.current   = toLL;\r\n+              lastRouteAtRef.current   = now;\r\n+            }\r\n+          };\r\n+\r\n           if (accuracy && accuracy > 80) return;\r\n         }\r\n         \r\n       );\r\n@@ -852,25 +878,26 @@\n           // Heading intentionally ignored (no cone)\r\n           if (msg.type === 'updateHeading'){ return; }\r\n \r\n           // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n             clearRoute();\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n \r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n             if (msg.reframe) {\r\n               map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n             }\r\n \r\n             const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({ permanent:true, direction:'top', offset:[0,-6], className:'distance-label' })\r\n-              .setContent(label || '')\r\n-              .setLatLng(mid)\r\n-              .addTo(map);\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText]\r\n+              .filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({\r\n+              permanent:true, direction:'top', offset:[0,-6], className:'distance-label'\r\n+            }).setContent(label || '').setLatLng(mid).addTo(map);\r\n             return;\r\n           }\r\n \r\n+\r\n           // Clear route\r\n           if (msg.type === 'clearRoute'){\r\n             clearRoute();\r\n             return;\r\n@@ -1280,8 +1307,12 @@\n           return;\r\n         }\r\n         const { latitude, longitude } = location;\r\n \r\n+        lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n+        lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n+        lastRouteAtRef.current   = Date.now();\r\n+\r\n         fetchORSRoute(\r\n           { latitude: location.latitude, longitude: location.longitude },\r\n           dest\r\n         );\r\n"
                },
                {
                    "date": 1761247733505,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -437,8 +437,11 @@\n       }\r\n     })();\r\n   }, []);\r\n \r\n+  const destinationRef = useRef<typeof destination>(null);\r\n+  useEffect(() => { destinationRef.current = destination; }, [destination]);\r\n+\r\n   useEffect(() => {\r\n     let sub: Location.LocationSubscription | null = null;\r\n \r\n     (async () => {\r\n@@ -452,63 +455,61 @@\n           longitude: location.longitude,\r\n           accuracy: 15,\r\n           avatarUrl,\r\n         }));\r\n-        // NEW: force-check pin\r\n         ensureUserMarker(location.latitude, location.longitude);\r\n       }\r\n \r\n-\r\n       sub = await Location.watchPositionAsync(\r\n         {\r\n           accuracy: Location.Accuracy.Balanced,\r\n           timeInterval: 5000,\r\n           distanceInterval: 5,\r\n         },\r\n         (pos) => {\r\n           const { latitude, longitude, accuracy } = pos.coords;\r\n-          setLivePos({ latitude, longitude });             \r\n-          sendToMap({                                       \r\n+\r\n+          setLivePos({ latitude, longitude });\r\n+          sendToMap({\r\n             type: \"updateUserLoc\",\r\n             latitude,\r\n             longitude,\r\n             accuracy: accuracy ?? 15,\r\n             avatarUrl,\r\n           });\r\n-          if (destination) {\r\n+\r\n+          // ‚úÖ Recompute route without reframe\r\n+          const dest = destinationRef.current;\r\n+          if (dest) {\r\n             const fromLL = { lat: latitude, lng: longitude };\r\n-            const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n+            const toLL   = { lat: dest.latitude, lng: dest.longitude };\r\n \r\n-            const movedM = haversine(\r\n-              lastRouteFromRef.current ?? fromLL,\r\n-              fromLL\r\n-            );\r\n-\r\n+            const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n             const now = Date.now();\r\n             const shouldRecompute =\r\n               movedM >= ROUTE_MIN_MOVE_M ||\r\n               (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n \r\n             if (shouldRecompute) {\r\n               fetchORSRoute(\r\n                 { latitude, longitude },\r\n-                destination,\r\n-                false                       // <-- DO NOT reframe on live updates\r\n+                dest,\r\n+                false // <-- no reframe on live updates\r\n               );\r\n               lastRouteFromRef.current = fromLL;\r\n               lastRouteToRef.current   = toLL;\r\n               lastRouteAtRef.current   = now;\r\n             }\r\n-          };\r\n+          }\r\n \r\n           if (accuracy && accuracy > 80) return;\r\n         }\r\n-        \r\n       );\r\n     })();\r\n \r\n     return () => sub?.remove();\r\n   }, [avatarUrl]); \r\n+\r\n   \r\n \r\n \r\n   useEffect(() => {\r\n"
                },
                {
                    "date": 1761253820634,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -475,9 +475,15 @@\n             longitude,\r\n             accuracy: accuracy ?? 15,\r\n             avatarUrl,\r\n           });\r\n+          sendToMap({\r\n+            type: \"nudgeRouteStart\",\r\n+            latitude,\r\n+            longitude,\r\n+          });\r\n \r\n+\r\n           // ‚úÖ Recompute route without reframe\r\n           const dest = destinationRef.current;\r\n           if (dest) {\r\n             const fromLL = { lat: latitude, lng: longitude };\r\n"
                },
                {
                    "date": 1761253920725,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -881,8 +881,24 @@\n             if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n             return;\r\n           }\r\n \r\n+          if (msg.type === 'nudgeRouteStart') {\r\n+            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n+            if (routeLine && Number.isFinite(lat) && Number.isFinite(lng)) {\r\n+              const pts = routeLine.getLatLngs();\r\n+              if (Array.isArray(pts) && pts.length > 0) {\r\n+                pts[0] = L.latLng(lat, lng);       // move route‚Äôs start to new CL\r\n+                routeLine.setLatLngs(pts);\r\n+\r\n+                if (distanceTooltip && pts.length > 2) {\r\n+                  const mid = pts[Math.floor(pts.length / 2)];\r\n+                  distanceTooltip.setLatLng(mid);  // keep tooltip centered\r\n+                }\r\n+              }\r\n+            }\r\n+            return;\r\n+          }\r\n           // Heading intentionally ignored (no cone)\r\n           if (msg.type === 'updateHeading'){ return; }\r\n \r\n           // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n"
                },
                {
                    "date": 1761346052612,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -881,24 +881,53 @@\n             if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n             return;\r\n           }\r\n \r\n+          // Keep route line's head glued to the moving CL marker\r\n           if (msg.type === 'nudgeRouteStart') {\r\n             const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n-            if (routeLine && Number.isFinite(lat) && Number.isFinite(lng)) {\r\n-              const pts = routeLine.getLatLngs();\r\n-              if (Array.isArray(pts) && pts.length > 0) {\r\n-                pts[0] = L.latLng(lat, lng);       // move route‚Äôs start to new CL\r\n-                routeLine.setLatLngs(pts);\r\n \r\n-                if (distanceTooltip && pts.length > 2) {\r\n-                  const mid = pts[Math.floor(pts.length / 2)];\r\n-                  distanceTooltip.setLatLng(mid);  // keep tooltip centered\r\n-                }\r\n-              }\r\n+            // Debug: tell RN what we have\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'dbg',\r\n+              tag: 'nudgeRouteStart',\r\n+              lat, lng,\r\n+              hasRoute: !!routeLine\r\n+            }));\r\n+\r\n+            // No route drawn yet? Nothing to nudge\r\n+            if (!routeLine || !Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+\r\n+            // Update the first vertex of the current polyline\r\n+            let pts = routeLine.getLatLngs(); // may be LatLng[] or LatLng[][] if multi\r\n+            if (!Array.isArray(pts) || !pts.length) return;\r\n+\r\n+            // If this is a multi-polyline, take the first segment\r\n+            if (Array.isArray(pts[0]) && pts[0].length) {\r\n+              pts = pts[0];\r\n             }\r\n+\r\n+            pts[0] = L.latLng(lat, lng);\r\n+            routeLine.setLatLngs(pts);\r\n+\r\n+            if (pts.length > 1) {\r\n+              const p1 = pts[0], p2 = pts[1];\r\n+              const mid = L.latLng(\r\n+                p1.lat + (p2.lat - p1.lat) * 0.15,\r\n+                p1.lng + (p2.lng - p1.lng) * 0.15\r\n+              );\r\n+              routeLine.setLatLngs([p1, mid, ...pts.slice(1)]);\r\n+            }\r\n+\r\n+\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'nudgeAck',\r\n+              ok: true\r\n+            }));\r\n             return;\r\n           }\r\n+\r\n+            \r\n           // Heading intentionally ignored (no cone)\r\n           if (msg.type === 'updateHeading'){ return; }\r\n \r\n           // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n@@ -1215,8 +1244,17 @@\n         } catch {\r\n           setDropoffName(\"Selected Location\");\r\n         }\r\n       }\r\n+\r\n+      if (parsed.type === 'dbg' && parsed.tag === 'nudgeRouteStart') {\r\n+        console.log('[MAP] nudge dbg:', parsed);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'nudgeAck') {\r\n+        console.log('[MAP] nudgeAck ok=', parsed.ok);\r\n+        return;\r\n+      }\r\n       if (parsed.type === 'userMarkerEnsured') {\r\n         userMarkerOkRef.current = !!parsed.placed;\r\n         return;\r\n       }\r\n@@ -1409,8 +1447,10 @@\n       fare,\r\n       paymentMethod,\r\n       notes,\r\n       passengerId,\r\n+      pickupPlace: pickupName,\r\n+      destinationPlace: dropoffName,\r\n \r\n       // NEW: booking type + group seats\r\n       bookingType,\r\n       partySize: normalizedParty,\r\n"
                },
                {
                    "date": 1761346059855,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1449,10 +1449,8 @@\n       notes,\r\n       passengerId,\r\n       pickupPlace: pickupName,\r\n       destinationPlace: dropoffName,\r\n-\r\n-      // NEW: booking type + group seats\r\n       bookingType,\r\n       partySize: normalizedParty,\r\n     };\r\n \r\n"
                },
                {
                    "date": 1761348582798,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1452,8 +1452,9 @@\n       destinationPlace: dropoffName,\r\n       bookingType,\r\n       partySize: normalizedParty,\r\n     };\r\n+    console.log(bookingData);\r\n \r\n     try {\r\n       // reset any old polling\r\n       if (searchTimeoutRef.current) {\r\n"
                },
                {
                    "date": 1762010287175,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1901,17 +1901,9 @@\n                   ) : (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n                         {matchedDriver.selfieImage && (\r\n-                          <Image\r\n-                            source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }}\r\n-                            style={{\r\n-                              width: 50,\r\n-                              height: 50,\r\n-                              borderRadius: 25,\r\n-                              marginRight: 10,\r\n-                            }}\r\n-                          />\r\n+                          <Image source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }} />\r\n                         )}\r\n                         <View style={{ flex: 1 }}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver.driverName}</Text>\r\n"
                },
                {
                    "date": 1762010313786,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1745,8 +1745,25 @@\n       Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n     }\r\n   };\r\n \r\n+  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n+    if (!raw) return null;\r\n+\r\n+    // If it's already an absolute URL (Cloudinary, etc.)\r\n+    if (/^https?:\\/\\//i.test(raw)) {\r\n+      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n+    }\r\n+\r\n+    // Else treat as relative path served by your backend\r\n+    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n+    const path = String(raw).replace(/^\\//, \"\"); // strip leading slash if any\r\n+    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+    return `${base}/${path}?v=${v}`;\r\n+  };\r\n+\r\n+\r\n   \r\n \r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n"
                },
                {
                    "date": 1762010601401,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1910,33 +1910,38 @@\n                     padding: 10,\r\n                     elevation: 3,\r\n                   }}\r\n                 >\r\n-                  {infoBoxMinimized ? (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  ) : (\r\n+                  {!infoBoxMinimized ? (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {matchedDriver.selfieImage && (\r\n-                          <Image source={{ uri: `${API_BASE_URL}/${matchedDriver.selfieImage}` }} />\r\n-                        )}\r\n+                        {(() => {\r\n+                          const selfieUri = buildImageUri(\r\n+                            matchedDriver?.selfieImage,\r\n+                            (matchedDriver as any)?.updatedAt || Date.now()\r\n+                          );\r\n+                          return selfieUri ? (\r\n+                            <Image\r\n+                              source={{ uri: selfieUri }}\r\n+                              style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n+                              resizeMode=\"cover\"\r\n+                            />\r\n+                          ) : null;\r\n+                        })()}\r\n                         <View style={{ flex: 1 }}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver.experienceYears || \"N/A\"} years</Text>\r\n+                          <Text>Name: {matchedDriver?.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n \r\n-                          {/* Chat button here */}\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n                               router.push({\r\n                                 pathname: \"/ChatRoom\",\r\n                                 params: {\r\n-                                  bookingId: bookingId,\r\n+                                  bookingId,\r\n                                   driverId: matchedDriver?.driverId,\r\n-                                  passengerId: passengerId,\r\n+                                  passengerId,\r\n                                   role: \"passenger\",\r\n                                 },\r\n                               });\r\n                             }}\r\n@@ -1992,8 +1997,12 @@\n                           <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                     </>\r\n+                  ) : (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n                   )}\r\n                 </View>\r\n               )}\r\n             </View>\r\n"
                },
                {
                    "date": 1762010750518,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1921,9 +1921,9 @@\n                           );\r\n                           return selfieUri ? (\r\n                             <Image\r\n                               source={{ uri: selfieUri }}\r\n-                              style={{ width: 50, height: 50, borderRadius: 25, marginRight: 10 }}\r\n+                              style={{ width: 80, height: 80, borderRadius: 25, marginRight: 10 }}\r\n                               resizeMode=\"cover\"\r\n                             />\r\n                           ) : null;\r\n                         })()}\r\n"
                },
                {
                    "date": 1762010786175,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1921,9 +1921,9 @@\n                           );\r\n                           return selfieUri ? (\r\n                             <Image\r\n                               source={{ uri: selfieUri }}\r\n-                              style={{ width: 80, height: 80, borderRadius: 25, marginRight: 10 }}\r\n+                              style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n                               resizeMode=\"cover\"\r\n                             />\r\n                           ) : null;\r\n                         })()}\r\n"
                },
                {
                    "date": 1762378431722,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -309,8 +309,15 @@\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const routeReqIdRef = useRef(0);\r\n \r\n+  const [paymentInfo, setPaymentInfo] = useState<{\r\n+    paymentMethod?: string;\r\n+    paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\";\r\n+    driverPayment?: { number?: string; qrUrl?: string|null };\r\n+  } | null>(null);\r\n+\r\n+\r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n     to:   { latitude: number; longitude: number },\r\n     reframe: boolean = false         // <-- NEW\r\n"
                },
                {
                    "date": 1762378438202,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -300,12 +300,8 @@\n       lastRouteDestKeyRef.current = destKey;\r\n       lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n     }\r\n   }, [destination, location]);\r\n-\r\n-\r\n-\r\n-\r\n   const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const routeReqIdRef = useRef(0);\r\n"
                },
                {
                    "date": 1762378529317,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -300,8 +300,9 @@\n       lastRouteDestKeyRef.current = destKey;\r\n       lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n     }\r\n   }, [destination, location]);\r\n+\r\n   const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n \r\n   // ---------- ORS: fetch route and draw in WebView ----------\r\n   const routeReqIdRef = useRef(0);\r\n@@ -311,9 +312,34 @@\n     paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\";\r\n     driverPayment?: { number?: string; qrUrl?: string|null };\r\n   } | null>(null);\r\n \r\n+  const loadPaymentInfo = async (id: string) => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo({\r\n+        paymentMethod: j.paymentMethod,\r\n+        paymentStatus: j.paymentStatus,\r\n+        driverPayment: j.driverPayment || {},\r\n+      });\r\n+    } catch {}\r\n+  };\r\n \r\n+  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\":\"application/json\" },\r\n+        body: JSON.stringify({ status }),\r\n+      });\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n+    } catch {}\r\n+  };\r\n+\r\n+\r\n+\r\n   const fetchORSRoute = async (\r\n     from: { latitude: number; longitude: number },\r\n     to:   { latitude: number; longitude: number },\r\n     reframe: boolean = false         // <-- NEW\r\n"
                },
                {
                    "date": 1762378582681,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1556,9 +1556,9 @@\n         if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n           setBookingConfirmed(true);\r\n           setSearching(false);\r\n           Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-\r\n+          if (bookingId) loadPaymentInfo(String(bookingId));\r\n           if (myBooking.driverId) {\r\n             try {\r\n               const [driverRes, statusRes] = await Promise.all([\r\n                 fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n@@ -1586,8 +1586,15 @@\n     return () => clearInterval(interval);\r\n   }, [bookingId, bookingConfirmed]);\r\n \r\n   useEffect(() => {\r\n+    if (!bookingId || !bookingConfirmed) return;\r\n+    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n+    return () => clearInterval(t);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n     let interval: any;\r\n     const pollForBookingCompletion = async () => {\r\n       if (!bookingId) return;\r\n       try {\r\n"
                },
                {
                    "date": 1762378622506,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2229,8 +2229,56 @@\n                   </TouchableOpacity>\r\n                 </View>\r\n               </View>\r\n             )}\r\n+\r\n+            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n+              <View style={{ marginTop: 8, padding: 10, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n+                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+\r\n+                {!!paymentInfo?.driverPayment?.number && (\r\n+                  <TouchableOpacity\r\n+                    onPress={() => {\r\n+                      const n = paymentInfo.driverPayment!.number!;\r\n+                      // copy to clipboard (expo-clipboard)\r\n+                      // import * as Clipboard from \"expo-clipboard\";\r\n+                      // await Clipboard.setStringAsync(n);\r\n+                      Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n+                    }}\r\n+                    style={{ paddingVertical: 6 }}\r\n+                  >\r\n+                    <Text>Number: <Text style={{ fontWeight: \"600\" }}>{paymentInfo.driverPayment.number}</Text></Text>\r\n+                    <Text style={{ fontSize:12, color:\"#666\" }}>(tap to copy)</Text>\r\n+                  </TouchableOpacity>\r\n+                )}\r\n+\r\n+                {!!paymentInfo?.driverPayment?.qrUrl && (\r\n+                  <Image\r\n+                    source={{ uri: paymentInfo.driverPayment.qrUrl! }}\r\n+                    style={{ width: 160, height: 160, alignSelf: \"center\", marginTop: 6, borderRadius: 8, backgroundColor:\"#eee\" }}\r\n+                    resizeMode=\"contain\"\r\n+                  />\r\n+                )}\r\n+\r\n+                <View style={{ marginTop: 10, flexDirection:\"row\", alignItems:\"center\", justifyContent:\"space-between\" }}>\r\n+                  <Text>Status: <Text style={{ fontWeight:\"700\" }}>{paymentInfo?.paymentStatus || \"none\"}</Text></Text>\r\n+\r\n+                  <TouchableOpacity\r\n+                    onPress={() => bookingId && setPaymentStatus(String(bookingId), \"paid\")}\r\n+                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                    style={{\r\n+                      backgroundColor: paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                      paddingVertical: 8, paddingHorizontal: 14, borderRadius: 8\r\n+                    }}\r\n+                  >\r\n+                    <Text style={{ color:\"#fff\", fontWeight:\"700\" }}>\r\n+                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                    </Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n"
                },
                {
                    "date": 1762378720565,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2233,16 +2233,12 @@\n \r\n             {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n               <View style={{ marginTop: 8, padding: 10, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n                 <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-\r\n                 {!!paymentInfo?.driverPayment?.number && (\r\n                   <TouchableOpacity\r\n                     onPress={() => {\r\n                       const n = paymentInfo.driverPayment!.number!;\r\n-                      // copy to clipboard (expo-clipboard)\r\n-                      // import * as Clipboard from \"expo-clipboard\";\r\n-                      // await Clipboard.setStringAsync(n);\r\n                       Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n                     }}\r\n                     style={{ paddingVertical: 6 }}\r\n                   >\r\n"
                },
                {
                    "date": 1762379434791,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2125,9 +2125,33 @@\n                     value={destinationLabel}\r\n                     onChangeText={setDestinationLabel}\r\n                   /> */}\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n-                  <TextInput style={styles.input} placeholder=\"Paano ka magbabayad?\" placeholderTextColor=\"#A0A0A0\" value={paymentMethod} onChangeText={setPaymentMethod} />\r\n+                  <View style={styles.input}>\r\n+                    <Text>Paano ka magbabayad?</Text>\r\n+                    <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPaymentMethod(\"Cash\")}\r\n+                        style={[\r\n+                          styles.paymentOption,\r\n+                          paymentMethod === \"Cash\" && styles.paymentSelected\r\n+                        ]}\r\n+                      >\r\n+                        <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n+                      </TouchableOpacity>\r\n+\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPaymentMethod(\"GCash\")}\r\n+                        style={[\r\n+                          styles.paymentOption,\r\n+                          paymentMethod === \"GCash\" && styles.paymentSelected\r\n+                        ]}\r\n+                      >\r\n+                        <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+\r\n                 </ScrollView>\r\n \r\n                 <View style={styles.fareContainer}>\r\n                   <View>\r\n@@ -2351,6 +2375,30 @@\n     position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n     width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n     alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n   },\r\n+\r\n+  paymentOption: {\r\n+    flex: 1,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+    paddingVertical: 12,\r\n+    borderRadius: 10,\r\n+    alignItems: \"center\",\r\n+    marginHorizontal: 5,\r\n+    backgroundColor: \"#fff\",\r\n+  },\r\n+  paymentSelected: {\r\n+    backgroundColor: \"#22c55e\",\r\n+    borderColor: \"#22c55e\",\r\n+  },\r\n+  paymentText: {\r\n+    color: \"#333\",\r\n+    fontWeight: \"600\",\r\n+  },\r\n+  paymentSelectedText: {\r\n+    color: \"#fff\",\r\n+    fontWeight: \"700\",\r\n+  },\r\n+\r\n   \r\n });\r\n"
                },
                {
                    "date": 1762379527680,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2380,9 +2380,9 @@\n   paymentOption: {\r\n     flex: 1,\r\n     borderWidth: 1,\r\n     borderColor: \"#ccc\",\r\n-    paddingVertical: 12,\r\n+    paddingVertical: 6,\r\n     borderRadius: 10,\r\n     alignItems: \"center\",\r\n     marginHorizontal: 5,\r\n     backgroundColor: \"#fff\",\r\n"
                },
                {
                    "date": 1762379604482,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2125,10 +2125,10 @@\n                     value={destinationLabel}\r\n                     onChangeText={setDestinationLabel}\r\n                   /> */}\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n+                  <Text>Paano ka magbabayad?</Text>\r\n                   <View style={styles.input}>\r\n-                    <Text>Paano ka magbabayad?</Text>\r\n                     <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n                       <TouchableOpacity\r\n                         onPress={() => setPaymentMethod(\"Cash\")}\r\n                         style={[\r\n"
                },
                {
                    "date": 1762379665999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2126,30 +2126,28 @@\n                     onChangeText={setDestinationLabel}\r\n                   /> */}\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n                   <Text>Paano ka magbabayad?</Text>\r\n-                  <View style={styles.input}>\r\n                     <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPaymentMethod(\"Cash\")}\r\n-                        style={[\r\n-                          styles.paymentOption,\r\n-                          paymentMethod === \"Cash\" && styles.paymentSelected\r\n-                        ]}\r\n-                      >\r\n-                        <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n-                      </TouchableOpacity>\r\n+                    <TouchableOpacity\r\n+                      onPress={() => setPaymentMethod(\"Cash\")}\r\n+                      style={[\r\n+                        styles.paymentOption,\r\n+                        paymentMethod === \"Cash\" && styles.paymentSelected\r\n+                      ]}\r\n+                    >\r\n+                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n+                    </TouchableOpacity>\r\n \r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPaymentMethod(\"GCash\")}\r\n-                        style={[\r\n-                          styles.paymentOption,\r\n-                          paymentMethod === \"GCash\" && styles.paymentSelected\r\n-                        ]}\r\n-                      >\r\n-                        <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n+                    <TouchableOpacity\r\n+                      onPress={() => setPaymentMethod(\"GCash\")}\r\n+                      style={[\r\n+                        styles.paymentOption,\r\n+                        paymentMethod === \"GCash\" && styles.paymentSelected\r\n+                      ]}\r\n+                    >\r\n+                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n+                    </TouchableOpacity>\r\n                   </View>\r\n \r\n                 </ScrollView>\r\n \r\n"
                },
                {
                    "date": 1762379683451,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2126,9 +2126,9 @@\n                     onChangeText={setDestinationLabel}\r\n                   /> */}\r\n                   <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n                   <Text>Paano ka magbabayad?</Text>\r\n-                    <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n+                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n                     <TouchableOpacity\r\n                       onPress={() => setPaymentMethod(\"Cash\")}\r\n                       style={[\r\n                         styles.paymentOption,\r\n@@ -2385,9 +2385,9 @@\n     marginHorizontal: 5,\r\n     backgroundColor: \"#fff\",\r\n   },\r\n   paymentSelected: {\r\n-    backgroundColor: \"#22c55e\",\r\n+    backgroundColor: \"#000\",\r\n     borderColor: \"#22c55e\",\r\n   },\r\n   paymentText: {\r\n     color: \"#333\",\r\n"
                },
                {
                    "date": 1762379691408,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2386,9 +2386,9 @@\n     backgroundColor: \"#fff\",\r\n   },\r\n   paymentSelected: {\r\n     backgroundColor: \"#000\",\r\n-    borderColor: \"#22c55e\",\r\n+    borderColor: \"#333\",\r\n   },\r\n   paymentText: {\r\n     color: \"#333\",\r\n     fontWeight: \"600\",\r\n"
                },
                {
                    "date": 1762379864400,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1936,9 +1936,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: -100,\r\n+                    bottom: -200,\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1762379869999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1936,9 +1936,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: -200,\r\n+                    bottom: -100,\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1762379876194,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1936,9 +1936,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: -100,\r\n+                    bottom: 0,\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1762379882829,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1936,9 +1936,9 @@\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n-                    bottom: 0,\r\n+                    bottom: -100,\r\n                     left: 0,\r\n                     right: 0,\r\n                     marginHorizontal: 20,\r\n                     backgroundColor: \"#d1fcd3\",\r\n"
                },
                {
                    "date": 1762379931202,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2253,9 +2253,9 @@\n               </View>\r\n             )}\r\n \r\n             {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-              <View style={{ marginTop: 8, padding: 10, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n+              <View style={{ marginTop: 8, padding: 10, bottom: 100, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n                 <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n                 {!!paymentInfo?.driverPayment?.number && (\r\n                   <TouchableOpacity\r\n                     onPress={() => {\r\n"
                },
                {
                    "date": 1762380057879,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2253,9 +2253,9 @@\n               </View>\r\n             )}\r\n \r\n             {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-              <View style={{ marginTop: 8, padding: 10, bottom: 100, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n+              <View style={{ marginTop: 8, padding: 10, bottom: 200, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n                 <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n                 {!!paymentInfo?.driverPayment?.number && (\r\n                   <TouchableOpacity\r\n                     onPress={() => {\r\n"
                },
                {
                    "date": 1762380258356,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2252,51 +2252,86 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-              <View style={{ marginTop: 8, padding: 10, bottom: 200, backgroundColor: \"#fff\", borderRadius: 8 }}>\r\n+            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n+              <View\r\n+                style={{\r\n+                  marginTop: 8,\r\n+                  padding: 10,\r\n+                  bottom: 200,\r\n+                  backgroundColor: \"#fff\",\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n                 <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-                {!!paymentInfo?.driverPayment?.number && (\r\n-                  <TouchableOpacity\r\n-                    onPress={() => {\r\n-                      const n = paymentInfo.driverPayment!.number!;\r\n-                      Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n-                    }}\r\n-                    style={{ paddingVertical: 6 }}\r\n-                  >\r\n-                    <Text>Number: <Text style={{ fontWeight: \"600\" }}>{paymentInfo.driverPayment.number}</Text></Text>\r\n-                    <Text style={{ fontSize:12, color:\"#666\" }}>(tap to copy)</Text>\r\n-                  </TouchableOpacity>\r\n-                )}\r\n \r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    const n = paymentInfo.driverPayment!.number!;\r\n+                    Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n+                  }}\r\n+                  style={{ paddingVertical: 6 }}\r\n+                >\r\n+                  <Text>\r\n+                    Number:{\" \"}\r\n+                    <Text style={{ fontWeight: \"600\" }}>\r\n+                      {paymentInfo.driverPayment.number}\r\n+                    </Text>\r\n+                  </Text>\r\n+                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                </TouchableOpacity>\r\n+\r\n                 {!!paymentInfo?.driverPayment?.qrUrl && (\r\n                   <Image\r\n                     source={{ uri: paymentInfo.driverPayment.qrUrl! }}\r\n-                    style={{ width: 160, height: 160, alignSelf: \"center\", marginTop: 6, borderRadius: 8, backgroundColor:\"#eee\" }}\r\n+                    style={{\r\n+                      width: 160,\r\n+                      height: 160,\r\n+                      alignSelf: \"center\",\r\n+                      marginTop: 6,\r\n+                      borderRadius: 8,\r\n+                      backgroundColor: \"#eee\",\r\n+                    }}\r\n                     resizeMode=\"contain\"\r\n                   />\r\n                 )}\r\n \r\n-                <View style={{ marginTop: 10, flexDirection:\"row\", alignItems:\"center\", justifyContent:\"space-between\" }}>\r\n-                  <Text>Status: <Text style={{ fontWeight:\"700\" }}>{paymentInfo?.paymentStatus || \"none\"}</Text></Text>\r\n+                <View\r\n+                  style={{\r\n+                    marginTop: 10,\r\n+                    flexDirection: \"row\",\r\n+                    alignItems: \"center\",\r\n+                    justifyContent: \"space-between\",\r\n+                  }}\r\n+                >\r\n+                  <Text>\r\n+                    Status:{\" \"}\r\n+                    <Text style={{ fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus || \"none\"}\r\n+                    </Text>\r\n+                  </Text>\r\n \r\n                   <TouchableOpacity\r\n-                    onPress={() => bookingId && setPaymentStatus(String(bookingId), \"paid\")}\r\n+                    onPress={() =>\r\n+                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                    }\r\n                     disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n                     style={{\r\n-                      backgroundColor: paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                      paddingVertical: 8, paddingHorizontal: 14, borderRadius: 8\r\n+                      backgroundColor:\r\n+                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                      paddingVertical: 8,\r\n+                      paddingHorizontal: 14,\r\n+                      borderRadius: 8,\r\n                     }}\r\n                   >\r\n-                    <Text style={{ color:\"#fff\", fontWeight:\"700\" }}>\r\n+                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n                       {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n                     </Text>\r\n                   </TouchableOpacity>\r\n                 </View>\r\n               </View>\r\n             )}\r\n-\r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n"
                },
                {
                    "date": 1762380467117,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1951,10 +1951,9 @@\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n                         {(() => {\r\n                           const selfieUri = buildImageUri(\r\n-                            matchedDriver?.selfieImage,\r\n-                            (matchedDriver as any)?.updatedAt || Date.now()\r\n+                            matchedDriver?.selfieImage\r\n                           );\r\n                           return selfieUri ? (\r\n                             <Image\r\n                               source={{ uri: selfieUri }}\r\n"
                },
                {
                    "date": 1762380501657,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1951,9 +1951,10 @@\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n                         {(() => {\r\n                           const selfieUri = buildImageUri(\r\n-                            matchedDriver?.selfieImage\r\n+                            matchedDriver?.selfieImage,\r\n+                            (matchedDriver as any)?.updatedAt || Date.now()\r\n                           );\r\n                           return selfieUri ? (\r\n                             <Image\r\n                               source={{ uri: selfieUri }}\r\n"
                },
                {
                    "date": 1762380540301,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1797,11 +1797,24 @@\n     const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n     return `${base}/${path}?v=${v}`;\r\n   };\r\n \r\n+  const driverSelfieUri = React.useMemo(() => {\r\n+    if (!matchedDriver?.selfieImage) return null;\r\n \r\n-  \r\n+    // Use a stable version key if you have one; NEVER Date.now()\r\n+    const ver =\r\n+      (matchedDriver as any)?.updatedAt ||\r\n+      (matchedDriver as any)?.selfieUpdatedAt ||\r\n+      matchedDriver?.driverId || // last resort: driverId keeps it stable\r\n+      1;\r\n \r\n+    return buildImageUri(matchedDriver.selfieImage, ver);\r\n+  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n+\r\n+\r\n+    \r\n+\r\n   return (\r\n     <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n       <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n         <View style={styles.container}>\r\n"
                },
                {
                    "date": 1762380571583,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1962,21 +1962,15 @@\n                 >\r\n                   {!infoBoxMinimized ? (\r\n                     <>\r\n                       <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {(() => {\r\n-                          const selfieUri = buildImageUri(\r\n-                            matchedDriver?.selfieImage,\r\n-                            (matchedDriver as any)?.updatedAt || Date.now()\r\n-                          );\r\n-                          return selfieUri ? (\r\n-                            <Image\r\n-                              source={{ uri: selfieUri }}\r\n-                              style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n-                              resizeMode=\"cover\"\r\n-                            />\r\n-                          ) : null;\r\n-                        })()}\r\n+                        {driverSelfieUri ? (\r\n+                          <Image\r\n+                            source={{ uri: driverSelfieUri }}\r\n+                            style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n+                            resizeMode=\"cover\"\r\n+                          />\r\n+                        ) : null}\r\n                         <View style={{ flex: 1 }}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver?.driverName}</Text>\r\n                           <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n"
                },
                {
                    "date": 1762381667940,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,2445 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, \r\n+  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n+  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n+  Keyboard, Image, BackHandler, ScrollView, AppState, Linking  } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+import * as IntentLauncher from 'expo-intent-launcher';\r\n+import { useFocusEffect } from '@react-navigation/native';\r\n+\r\n+\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n+\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n+\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); \r\n+};\r\n+\r\n+async function ensureLocationEnabled() {\r\n+  const services = await Location.hasServicesEnabledAsync();\r\n+  const perm = await Location.getForegroundPermissionsAsync();\r\n+\r\n+  if (!services || perm.status !== 'granted') {\r\n+    Alert.alert(\r\n+      \"Enable Location\",\r\n+      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n+      [\r\n+        { text: \"Cancel\", style: \"cancel\" },\r\n+        {\r\n+          text: \"Open Settings\",\r\n+          onPress: () => {\r\n+            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n+            else Linking.openURL('app-settings:');\r\n+          }\r\n+        }\r\n+      ]\r\n+    );\r\n+    return false;\r\n+  }\r\n+  return true;\r\n+}\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default function PHome() {\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  const { location, loading } = useLocation();\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+  const inflightRef  = useRef<Set<string>>(new Set());\r\n+  const lastReqIdRef = useRef(0);\r\n+  const [showPOIs, setShowPOIs] = useState(false);\r\n+  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n+  // --- Booking type + party size ---\r\n+  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n+  const [partySize, setPartySize] = useState<number>(2);\r\n+  const userMarkerOkRef = useRef(false);\r\n+  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n+  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n+  const routeFramedRef = useRef(false);\r\n+  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n+  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteAtRef   = useRef(0);\r\n+\r\n+  const ROUTE_MIN_MOVE_M   = 35;   // recompute if user moved >= 35 m\r\n+  const ROUTE_MIN_INTERVAL = 8000; // or every 8s, whichever comes first\r\n+\r\n+  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n+\r\n+\r\n+  function ensureUserMarker(lat: number, lng: number) {\r\n+    let attempts = 0;\r\n+    userMarkerOkRef.current = false;\r\n+\r\n+    const tryOnce = () => {\r\n+      attempts += 1;\r\n+      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n+\r\n+      if (!userMarkerOkRef.current && attempts < 6) {\r\n+        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n+      }\r\n+    };\r\n+\r\n+    tryOnce();\r\n+  }\r\n+\r\n+  function roundByZoom(value: number, zoom: number) {\r\n+    const decimals =\r\n+      zoom >= 18 ? 3 :\r\n+      zoom >= 16 ? 3 :\r\n+      zoom >= 15 ? 2 :\r\n+      /* <=14 */   2;\r\n+    const m = Math.pow(10, decimals);\r\n+    return Math.round(value * m) / m;\r\n+  }\r\n+\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapReady || !iconData) return;\r\n+    sendToMap({ type: 'preloadIcons', icons: iconData });\r\n+  }, [mapReady, iconData]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapReady, location]);\r\n+\r\n+  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n+\r\n+  // call on mount\r\n+  useEffect(() => { ensureLocationEnabled(); }, []);\r\n+\r\n+  // call on resume\r\n+  useEffect(() => {\r\n+    const sub = AppState.addEventListener('change', (s) => {\r\n+      if (s === 'active') ensureLocationEnabled();\r\n+    });\r\n+    return () => sub.remove();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    if (!destination || !location) return;\r\n+\r\n+    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n+\r\n+    if (lastRouteDestKeyRef.current !== destKey) {\r\n+      fetchORSRoute(location, destination, true); \r\n+      routeFramedRef.current = true;\r\n+      lastRouteDestKeyRef.current = destKey;\r\n+      lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n+    }\r\n+  }, [destination, location]);\r\n+\r\n+  const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+\r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const routeReqIdRef = useRef(0);\r\n+\r\n+  const [paymentInfo, setPaymentInfo] = useState<{\r\n+    paymentMethod?: string;\r\n+    paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\";\r\n+    driverPayment?: { number?: string; qrUrl?: string|null };\r\n+  } | null>(null);\r\n+\r\n+  const loadPaymentInfo = async (id: string) => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo({\r\n+        paymentMethod: j.paymentMethod,\r\n+        paymentStatus: j.paymentStatus,\r\n+        driverPayment: j.driverPayment || {},\r\n+      });\r\n+    } catch {}\r\n+  };\r\n+\r\n+  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\":\"application/json\" },\r\n+        body: JSON.stringify({ status }),\r\n+      });\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n+    } catch {}\r\n+  };\r\n+\r\n+\r\n+\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to:   { latitude: number; longitude: number },\r\n+    reframe: boolean = false         // <-- NEW\r\n+  ) => {\r\n+    const myReqId = ++routeReqIdRef.current;\r\n+\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end:   [to.longitude,   to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n+      if (myReqId !== routeReqIdRef.current) return; \r\n+\r\n+      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n+\r\n+      const summary    = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM  = summary.distance ?? 0;\r\n+      const durationS  = summary.duration ?? 0;\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins         = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n+\r\n+      const computedFare = calculateFare(distanceKm, discount);\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm,\r\n+        distanceText,\r\n+        durationText,\r\n+        fareText: `‚Ç±${computedFare} est`,\r\n+        reframe,                        \r\n+      });\r\n+    } catch {}\r\n+  };\r\n+\r\n+\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n+      try {\r\n+        const lat = location.latitude;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+\r\n+    // update UI\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n+    // draw route immediately\r\n+    lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n+    lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n+    lastRouteAtRef.current   = Date.now();\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest,\r\n+      true\r\n+    );\r\n+\r\n+    // (optional) update markers\r\n+    sendToMap({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    });\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  const destinationRef = useRef<typeof destination>(null);\r\n+  useEffect(() => { destinationRef.current = destination; }, [destination]);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+        ensureUserMarker(location.latitude, location.longitude);\r\n+      }\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          const { latitude, longitude, accuracy } = pos.coords;\r\n+\r\n+          setLivePos({ latitude, longitude });\r\n+          sendToMap({\r\n+            type: \"updateUserLoc\",\r\n+            latitude,\r\n+            longitude,\r\n+            accuracy: accuracy ?? 15,\r\n+            avatarUrl,\r\n+          });\r\n+          sendToMap({\r\n+            type: \"nudgeRouteStart\",\r\n+            latitude,\r\n+            longitude,\r\n+          });\r\n+\r\n+\r\n+          // ‚úÖ Recompute route without reframe\r\n+          const dest = destinationRef.current;\r\n+          if (dest) {\r\n+            const fromLL = { lat: latitude, lng: longitude };\r\n+            const toLL   = { lat: dest.latitude, lng: dest.longitude };\r\n+\r\n+            const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n+            const now = Date.now();\r\n+            const shouldRecompute =\r\n+              movedM >= ROUTE_MIN_MOVE_M ||\r\n+              (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+\r\n+            if (shouldRecompute) {\r\n+              fetchORSRoute(\r\n+                { latitude, longitude },\r\n+                dest,\r\n+                false // <-- no reframe on live updates\r\n+              );\r\n+              lastRouteFromRef.current = fromLL;\r\n+              lastRouteToRef.current   = toLL;\r\n+              lastRouteAtRef.current   = now;\r\n+            }\r\n+          }\r\n+\r\n+          if (accuracy && accuracy > 80) return;\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl]); \r\n+\r\n+  \r\n+\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            sendToMap({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            });\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n+  // ---------------------------------------------------------\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  \r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapHtml, location]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!livePos) return;\r\n+    console.log(\"LIVE POS ‚Üí\", livePos.latitude, livePos.longitude);\r\n+  }, [livePos]);\r\n+\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+  if (!location || mapHtml) return;\r\n+\r\n+  // lock the very first location for the initial setView\r\n+  if (!initialLocRef.current) {\r\n+    initialLocRef.current = {\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+    };\r\n+  }\r\n+\r\n+  const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n+\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        if (!window.L) {\r\n+          window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'error', msg:'Leaflet failed to load' }));\r\n+        }\r\n+        // --- Map init ---\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n+          noWrap: true\r\n+        }).setView([${initLat}, ${initLng}], 15);\r\n+\r\n+\r\n+        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n+          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n+        }).addTo(map);\r\n+\r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n+\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n+\r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        let userMarkerPlaced = false; // <‚Äî NEW\r\n+\r\n+        let tweenHandle = null;\r\n+        function tweenMarkerTo(lat, lng, durationMs = 300) {\r\n+          if (!userMarker) return upsertUserMarker(lat, lng);\r\n+          if (tweenHandle) cancelAnimationFrame(tweenHandle);\r\n+\r\n+          const start = userMarker.getLatLng();\r\n+          const end = L.latLng(lat, lng);\r\n+          const t0 = performance.now();\r\n+\r\n+          const step = (t) => {\r\n+            const p = Math.min(1, (t - t0) / durationMs);\r\n+            const latI = start.lat + (end.lat - start.lat) * p;\r\n+            const lngI = start.lng + (end.lng - start.lng) * p;\r\n+            userMarker.setLatLng([latI, lngI]);\r\n+            if (p < 1) tweenHandle = requestAnimationFrame(step);\r\n+          };\r\n+          tweenHandle = requestAnimationFrame(step);\r\n+        }\r\n+\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip({ permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+          userMarkerPlaced = true; \r\n+        }\r\n+\r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+        function addOrUpdatePOIMarker(it, poiIcons) {\r\n+          const existing = poiMarkers.get(it.id);\r\n+          if (existing) {\r\n+            // update position if it changed\r\n+            const curr = existing.getLatLng();\r\n+            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n+              existing.setLatLng([it.lat, it.lng]);\r\n+            }\r\n+            return;\r\n+          }\r\n+          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n+          const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+          // build popup with \"Set Destination\"\r\n+          const container = document.createElement('div');\r\n+          const title = document.createElement('b');\r\n+          title.textContent = it.name || it.category || 'POI';\r\n+          container.appendChild(title);\r\n+          container.appendChild(document.createElement('br'));\r\n+          const btn = document.createElement('button');\r\n+          btn.textContent = 'Set Destination';\r\n+          btn.style.marginTop = '6px';\r\n+          btn.onclick = function () {\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'setDestinationFromPOI',\r\n+              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+            }));\r\n+          };\r\n+          container.appendChild(btn);\r\n+          marker.bindPopup(container);\r\n+\r\n+          marker.addTo(poiLayer);\r\n+          poiMarkers.set(it.id, marker);\r\n+        }\r\n+        \r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n+\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n+\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n+\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n+\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n+\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n+\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n+\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n+\r\n+          if (msg.type === 'ensureUserMarker') {\r\n+            const lat = Number(msg.latitude);\r\n+            const lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n+              upsertUserMarker(lat, lng);\r\n+            }\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'userMarkerEnsured',\r\n+              placed: !!userMarker,\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n+            return;\r\n+          }\r\n+\r\n+          // Keep route line's head glued to the moving CL marker\r\n+          if (msg.type === 'nudgeRouteStart') {\r\n+            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n+\r\n+            // Debug: tell RN what we have\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'dbg',\r\n+              tag: 'nudgeRouteStart',\r\n+              lat, lng,\r\n+              hasRoute: !!routeLine\r\n+            }));\r\n+\r\n+            // No route drawn yet? Nothing to nudge\r\n+            if (!routeLine || !Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+\r\n+            // Update the first vertex of the current polyline\r\n+            let pts = routeLine.getLatLngs(); // may be LatLng[] or LatLng[][] if multi\r\n+            if (!Array.isArray(pts) || !pts.length) return;\r\n+\r\n+            // If this is a multi-polyline, take the first segment\r\n+            if (Array.isArray(pts[0]) && pts[0].length) {\r\n+              pts = pts[0];\r\n+            }\r\n+\r\n+            pts[0] = L.latLng(lat, lng);\r\n+            routeLine.setLatLngs(pts);\r\n+\r\n+            if (pts.length > 1) {\r\n+              const p1 = pts[0], p2 = pts[1];\r\n+              const mid = L.latLng(\r\n+                p1.lat + (p2.lat - p1.lat) * 0.15,\r\n+                p1.lng + (p2.lng - p1.lng) * 0.15\r\n+              );\r\n+              routeLine.setLatLngs([p1, mid, ...pts.slice(1)]);\r\n+            }\r\n+\r\n+\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'nudgeAck',\r\n+              ok: true\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+            \r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n+\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n+            clearRoute();\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+\r\n+            if (msg.reframe) {\r\n+              map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+            }\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText]\r\n+              .filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({\r\n+              permanent:true, direction:'top', offset:[0,-6], className:'distance-label'\r\n+            }).setContent(label || '').setLatLng(mid).addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n+            }\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+          if (msg.type === 'requestBbox') {\r\n+            const b = map.getBounds();\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'bbox',\r\n+              bbox: {\r\n+                minLng: b.getWest(),\r\n+                minLat: b.getSouth(),\r\n+                maxLng: b.getEast(),\r\n+                maxLat: b.getNorth()\r\n+              },\r\n+              zoom: map.getZoom()\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n+\r\n+            const z = Number(msg.zoom) || currentZoomLevel;\r\n+            const b = msg.bbox || null;\r\n+\r\n+            // Collect desired items from payload\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n+            const desiredIds = new Set(desired.keys());\r\n+\r\n+            // Decide strategy based on zoom direction\r\n+            if (z > currentZoomLevel) {\r\n+              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n+              if (b) {\r\n+                for (const [id, marker] of poiMarkers) {\r\n+                  const p = marker.getLatLng();\r\n+                  if (!bboxContains(b, p.lat, p.lng)) {\r\n+                    poiLayer.removeLayer(marker);\r\n+                    poiMarkers.delete(id);\r\n+                  }\r\n+                }\r\n+              }\r\n+            } else if (z < currentZoomLevel) {\r\n+              // ---- ZOOM OUT: shrink to what backend sent\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const keep = desiredIds.has(id);\r\n+                const p = marker.getLatLng();\r\n+                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n+                if (!keep || !onScreen) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            } else {\r\n+              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const p = marker.getLatLng();\r\n+                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n+                if (drop) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            }\r\n+\r\n+            // Build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n+\r\n+            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n+            const total = toAdd.length;\r\n+            const BATCH =\r\n+              total > 300 ? 80 :\r\n+              total > 150 ? 50 :\r\n+              total > 60  ? 35 :\r\n+              25; // small = faster draw\r\n+            const DELAY = total > 150 ? 20 : 10;\r\n+\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+\r\n+            let i = 0;\r\n+            const addBatch = () => {\r\n+              const end = Math.min(i + BATCH, total);\r\n+              for (; i < end; i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n+                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n+\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n+\r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+\r\n+                // üî• Fade-in animation\r\n+                let op = 0;\r\n+                const fade = () => {\r\n+                  op += 0.15;\r\n+                  if (op <= 1) {\r\n+                    marker.setOpacity(op);\r\n+                    requestAnimationFrame(fade);\r\n+                  } else {\r\n+                    marker.setOpacity(1);\r\n+                  }\r\n+                };\r\n+                requestAnimationFrame(fade);\r\n+              }\r\n+\r\n+              if (i < total) {\r\n+                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n+              } else {\r\n+                poiBatchHandle = null;\r\n+              }\r\n+            };\r\n+\r\n+\r\n+            addBatch();\r\n+\r\n+            currentZoomLevel = z;\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n+  }, [mapHtml, location]);  \r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+\r\n+    // üîµ Update passenger marker live\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+\r\n+    // üß≠ Recompute route occasionally (no zoom)\r\n+    const now = Date.now();\r\n+    if (destination) {\r\n+      const fromLL = { lat: location.latitude, lng: location.longitude };\r\n+      const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n+\r\n+      const movedM = haversine(\r\n+        lastRouteFromRef.current ?? fromLL,\r\n+        fromLL\r\n+      );\r\n+\r\n+      const shouldRecompute =\r\n+        movedM >= ROUTE_MIN_MOVE_M ||\r\n+        (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+\r\n+      if (shouldRecompute) {\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          destination,\r\n+          false // ‚ö†Ô∏è never reframe on live updates\r\n+        );\r\n+        lastRouteFromRef.current = fromLL;\r\n+        lastRouteToRef.current   = toLL;\r\n+        lastRouteAtRef.current   = now;\r\n+      }\r\n+    }\r\n+  }, [location, avatarUrl, destination]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!initialLocRef.current && location) {\r\n+      initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  useEffect(() => {\r\n+    console.log(\"[PHome] HTML built once?\", !!mapHtml);\r\n+  }, [mapHtml]);\r\n+\r\n+  useEffect(() => {\r\n+    console.log('[PHome] guards:',\r\n+      'hasLocation=', !!location,\r\n+      'hasIconData=', !!iconData,\r\n+      'hasMapHtml=', !!mapHtml\r\n+    );\r\n+  }, [location, iconData, mapHtml]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!destination || !location || !routeFramedRef.current) return;\r\n+\r\n+    const now = { lat: location.latitude, lng: location.longitude };\r\n+    const moved = lastOriginRef.current ? haversine(lastOriginRef.current, now) : Infinity;\r\n+\r\n+    if (moved > 150) {                 // tweak threshold as you like\r\n+      fetchORSRoute(location, destination, false); \r\n+      lastOriginRef.current = now;\r\n+    }\r\n+  }, [location, destination]);\r\n+\r\n+\r\n+  \r\n+\r\n+\r\n+\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+\r\n+      if (parsed.type === 'dbg' && parsed.tag === 'nudgeRouteStart') {\r\n+        console.log('[MAP] nudge dbg:', parsed);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'nudgeAck') {\r\n+        console.log('[MAP] nudgeAck ok=', parsed.ok);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'userMarkerEnsured') {\r\n+        userMarkerOkRef.current = !!parsed.placed;\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = Number(parsed.zoom) || 0;\r\n+        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n+        if (!showPOIs || zoom < 14) {\r\n+          sendToMap({ type: 'setPOIs', items: [] });\r\n+          return;\r\n+        };\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = [\r\n+          zoom,\r\n+          roundByZoom(minLng, zoom),\r\n+          roundByZoom(minLat, zoom),\r\n+          roundByZoom(maxLng, zoom),\r\n+          roundByZoom(maxLat, zoom),\r\n+        ].join('|');\r\n+\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            if (inflightRef.current.has(key)) {\r\n+              return;\r\n+            }\r\n+\r\n+            inflightRef.current.add(key);\r\n+\r\n+            const reqId = ++lastReqIdRef.current;\r\n+            \r\n+            try {\r\n+              const qs: string[] = [\r\n+                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+                `zoom=${zoom}`,\r\n+              ];\r\n+              if (center?.lat != null && center?.lng != null) {\r\n+                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+              }\r\n+              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+\r\n+              const r = await fetch(url);\r\n+              const items = await r.json();\r\n+\r\n+              if (reqId !== lastReqIdRef.current) {\r\n+                return; // a newer request finished after this one\r\n+              }\r\n+\r\n+              if (Array.isArray(items)) {\r\n+                poiCacheRef.current.set(key, items);\r\n+                sendToMap({ type: 'setPOIs', items });\r\n+              } else {\r\n+                sendToMap({ type: 'setPOIs', items: [] });\r\n+              }\r\n+            } catch (e) {\r\n+              console.log('[ERR] POI fetch failed for', key, e);\r\n+              sendToMap({ type: 'setPOIs', items: [] });\r\n+            } finally {\r\n+              inflightRef.current.delete(key);\r\n+            }\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({\r\n+                type: 'setPOIs',\r\n+                items,\r\n+                zoom,                       \r\n+                bbox: { minLng, minLat, maxLng, maxLat },  \r\n+              });\r\n+            }\r\n+\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 500);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n+        lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n+        lastRouteAtRef.current   = Date.now();\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+    // Set markers & trigger route drawing when destination is picked\r\n+  // useEffect(() => {\r\n+  //   if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+  //   const driverCoords = matchedDriver?.location\r\n+  //     ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+  //     : null;\r\n+\r\n+  //   if (driverCoords && destination) {\r\n+  //     mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+  //   }\r\n+\r\n+  //   // üëâ draw route as soon as we have both ends\r\n+  //   if (destination && location) {\r\n+  //     fetchORSRoute(location, destination);\r\n+  //   }\r\n+  // }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  if (loading || !location) return null;\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+\r\n+    // Normalize party size based on type\r\n+    const normalizedParty =\r\n+      bookingType === 'GROUP'\r\n+        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n+        : 1; // CLASSIC & SOLO always 1\r\n+\r\n+    setSearching(true);\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId,\r\n+      pickupPlace: pickupName,\r\n+      destinationPlace: dropoffName,\r\n+      bookingType,\r\n+      partySize: normalizedParty,\r\n+    };\r\n+    console.log(bookingData);\r\n+\r\n+    try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n+\r\n+  \r\n+  \r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+          if (bookingId) loadPaymentInfo(String(bookingId));\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!bookingId || !bookingConfirmed) return;\r\n+    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n+    return () => clearInterval(t);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+\r\n+          setFare(0);\r\n+        }\r\n+\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n+        }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n+    };\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+\r\n+  const cancelRideNow = async () => {\r\n+    try {\r\n+      if (!bookingId) {\r\n+        return;\r\n+      }\r\n+\r\n+      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ bookingId }),\r\n+      });\r\n+      const body = await resp.text();\r\n+\r\n+      // UI reset after server confirms\r\n+      setSearching(false);\r\n+      setBookingId(null);\r\n+      setMatchedDriver(null);\r\n+      setBookingConfirmed(false);\r\n+      setDestination(null);\r\n+      setTripCompleted(false);\r\n+      setAlertedBookingComplete(false);\r\n+      setShowBookingForm(false);\r\n+\r\n+      // Clear map + cached state\r\n+      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+      sendToMap({ type: \"clearRoute\" });\r\n+      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+      setFare(0);\r\n+    } catch (e) {\r\n+      console.log(\"[PHOME] cancel error\", e);\r\n+      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n+    if (!raw) return null;\r\n+\r\n+    // If it's already an absolute URL (Cloudinary, etc.)\r\n+    if (/^https?:\\/\\//i.test(raw)) {\r\n+      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n+    }\r\n+\r\n+    // Else treat as relative path served by your backend\r\n+    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n+    const path = String(raw).replace(/^\\//, \"\"); // strip leading slash if any\r\n+    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+    return `${base}/${path}?v=${v}`;\r\n+  };\r\n+\r\n+  const driverSelfieUri = React.useMemo(() => {\r\n+    if (!matchedDriver?.selfieImage) return null;\r\n+\r\n+    // Use a stable version key if you have one; NEVER Date.now()\r\n+    const ver =\r\n+      (matchedDriver as any)?.updatedAt ||\r\n+      (matchedDriver as any)?.selfieUpdatedAt ||\r\n+      matchedDriver?.driverId || // last resort: driverId keeps it stable\r\n+      1;\r\n+\r\n+    return buildImageUri(matchedDriver.selfieImage, ver);\r\n+  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n+\r\n+\r\n+\r\n+    \r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              allowFileAccess\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              mixedContentMode=\"always\"\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.searchcont}>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showPOIs) {\r\n+                  setShowPOIs(false);\r\n+                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                  sendToMap({ type: 'setPOIs', items: [] });\r\n+                } else {\r\n+                  setShowPOIs(true);\r\n+                  const b = lastBBoxRef.current;\r\n+                  if (b) {\r\n+                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n+                    if (zoom >= 14) {\r\n+                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                      poiFetchTimerRef.current = setTimeout(async () => {\r\n+                        try {\r\n+                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n+                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n+                          const r = await fetch(url);\r\n+                          const items = await r.json();\r\n+                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+                        } catch {\r\n+                          sendToMap({ type: 'setPOIs', items: [] });\r\n+                        }\r\n+                      }, 0);\r\n+                    } else {\r\n+                      sendToMap({ type: 'setPOIs', items: [] });\r\n+                    }\r\n+                  } else {\r\n+                    sendToMap({ type: 'requestBbox' });\r\n+                  }\r\n+                }\r\n+              }}\r\n+\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n+\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>\r\n+                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n+                  </Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={cancelRideNow}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {!infoBoxMinimized ? (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {driverSelfieUri ? (\r\n+                          <Image\r\n+                            source={{ uri: driverSelfieUri }}\r\n+                            style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n+                            resizeMode=\"cover\"\r\n+                          />\r\n+                        ) : null}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver?.driverName}</Text>\r\n+                          <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n+                            }}\r\n+                            style={{\r\n+                              marginTop: 8,\r\n+                              backgroundColor: \"#007bff\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 16,\r\n+                              borderRadius: 8,\r\n+                              alignSelf: \"flex-start\",\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                          </TouchableOpacity>\r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              const body = await resp.text();\r\n+\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch (e) {\r\n+                              console.log(\"[PHOME] cancel error\", e);\r\n+                            }\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n+                            setFare(0);\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </>\r\n+                  ) : (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+\r\n+                {/* Booking Type Selector */}\r\n+                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n+                  {[\r\n+                    { key: 'CLASSIC', label: 'Classic' },\r\n+                    { key: 'GROUP', label: 'Group' },\r\n+                    { key: 'SOLO', label: 'Solo' },\r\n+                  ].map((opt) => {\r\n+                    const active = bookingType === (opt.key as any);\r\n+                    return (\r\n+                      <TouchableOpacity\r\n+                        key={opt.key}\r\n+                        onPress={() => {\r\n+                          setBookingType(opt.key as any);\r\n+                          if (opt.key !== 'GROUP') setPartySize(2);\r\n+                        }}\r\n+                        style={{\r\n+                          flex: 1,\r\n+                          backgroundColor: active ? '#111' : '#fff',\r\n+                          borderWidth: 1,\r\n+                          borderColor: active ? '#111' : '#ccc',\r\n+                          paddingVertical: 10,\r\n+                          borderRadius: 10,\r\n+                          alignItems: 'center',\r\n+                        }}\r\n+                      >\r\n+                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n+                          {opt.label}\r\n+                        </Text>\r\n+                      </TouchableOpacity>\r\n+                    );\r\n+                  })}\r\n+                </View>\r\n+\r\n+                {/* Notes for Solo & Group */}\r\n+                {bookingType === 'SOLO' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n+                  </Text>\r\n+                )}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n+                  </Text>\r\n+                )}\r\n+\r\n+                {/* Group Party Size Stepper */}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n+                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n+                      </TouchableOpacity>\r\n+                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+                )}\r\n+\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <Text>From:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <Text>To:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  {/* <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  /> */}\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n+                  <Text>Paano ka magbabayad?</Text>\r\n+                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n+                    <TouchableOpacity\r\n+                      onPress={() => setPaymentMethod(\"Cash\")}\r\n+                      style={[\r\n+                        styles.paymentOption,\r\n+                        paymentMethod === \"Cash\" && styles.paymentSelected\r\n+                      ]}\r\n+                    >\r\n+                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n+                    </TouchableOpacity>\r\n+\r\n+                    <TouchableOpacity\r\n+                      onPress={() => setPaymentMethod(\"GCash\")}\r\n+                      style={[\r\n+                        styles.paymentOption,\r\n+                        paymentMethod === \"GCash\" && styles.paymentSelected\r\n+                      ]}\r\n+                    >\r\n+                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n+                    </TouchableOpacity>\r\n+                  </View>\r\n+\r\n+                </ScrollView>\r\n+\r\n+                <View style={styles.fareContainer}>\r\n+                  <View>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Fare:\r\n+                    </Text>\r\n+                    <Text style={{ paddingLeft: 20 }}>\r\n+                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n+                    </Text>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Total Fare: ‚Ç±\r\n+                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n+                    </Text>\r\n+                  </View>\r\n+                  <TouchableOpacity\r\n+                    style={[\r\n+                      styles.bookButton,\r\n+                      // disable if invalid group count or no destination\r\n+                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n+                    ]}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n+                    onPress={handleBookNow}\r\n+                  >\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n+              <View\r\n+                style={{\r\n+                  marginTop: 8,\r\n+                  padding: 10,\r\n+                  bottom: 200,\r\n+                  backgroundColor: \"#fff\",\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    const n = paymentInfo.driverPayment!.number!;\r\n+                    Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n+                  }}\r\n+                  style={{ paddingVertical: 6 }}\r\n+                >\r\n+                  <Text>\r\n+                    Number:{\" \"}\r\n+                    <Text style={{ fontWeight: \"600\" }}>\r\n+                      {paymentInfo.driverPayment.number}\r\n+                    </Text>\r\n+                  </Text>\r\n+                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                </TouchableOpacity>\r\n+\r\n+                {!!paymentInfo?.driverPayment?.qrUrl && (\r\n+                  <Image\r\n+                    source={{ uri: paymentInfo.driverPayment.qrUrl! }}\r\n+                    style={{\r\n+                      width: 160,\r\n+                      height: 160,\r\n+                      alignSelf: \"center\",\r\n+                      marginTop: 6,\r\n+                      borderRadius: 8,\r\n+                      backgroundColor: \"#eee\",\r\n+                    }}\r\n+                    resizeMode=\"contain\"\r\n+                  />\r\n+                )}\r\n+\r\n+                <View\r\n+                  style={{\r\n+                    marginTop: 10,\r\n+                    flexDirection: \"row\",\r\n+                    alignItems: \"center\",\r\n+                    justifyContent: \"space-between\",\r\n+                  }}\r\n+                >\r\n+                  <Text>\r\n+                    Status:{\" \"}\r\n+                    <Text style={{ fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus || \"none\"}\r\n+                    </Text>\r\n+                  </Text>\r\n+\r\n+                  <TouchableOpacity\r\n+                    onPress={() =>\r\n+                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                    }\r\n+                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                    style={{\r\n+                      backgroundColor:\r\n+                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                      paddingVertical: 8,\r\n+                      paddingHorizontal: 14,\r\n+                      borderRadius: 8,\r\n+                    }}\r\n+                  >\r\n+                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                    </Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n+  panel: {\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n+  },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n+  dropdownItem: { padding: 10 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n+\r\n+  paymentOption: {\r\n+    flex: 1,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+    paddingVertical: 6,\r\n+    borderRadius: 10,\r\n+    alignItems: \"center\",\r\n+    marginHorizontal: 5,\r\n+    backgroundColor: \"#fff\",\r\n+  },\r\n+  paymentSelected: {\r\n+    backgroundColor: \"#000\",\r\n+    borderColor: \"#333\",\r\n+  },\r\n+  paymentText: {\r\n+    color: \"#333\",\r\n+    fontWeight: \"600\",\r\n+  },\r\n+  paymentSelectedText: {\r\n+    color: \"#fff\",\r\n+    fontWeight: \"700\",\r\n+  },\r\n+\r\n+  \r\n+});\r\n"
                },
                {
                    "date": 1762381686545,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2260,2452 +2260,8 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-              <View\r\n-                style={{\r\n-                  marginTop: 8,\r\n-                  padding: 10,\r\n-                  bottom: 200,\r\n-                  backgroundColor: \"#fff\",\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    const n = paymentInfo.driverPayment!.number!;\r\n-                    Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n-                  }}\r\n-                  style={{ paddingVertical: 6 }}\r\n-                >\r\n-                  <Text>\r\n-                    Number:{\" \"}\r\n-                    <Text style={{ fontWeight: \"600\" }}>\r\n-                      {paymentInfo.driverPayment.number}\r\n-                    </Text>\r\n-                  </Text>\r\n-                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n-                </TouchableOpacity>\r\n-\r\n-                {!!paymentInfo?.driverPayment?.qrUrl && (\r\n-                  <Image\r\n-                    source={{ uri: paymentInfo.driverPayment.qrUrl! }}\r\n-                    style={{\r\n-                      width: 160,\r\n-                      height: 160,\r\n-                      alignSelf: \"center\",\r\n-                      marginTop: 6,\r\n-                      borderRadius: 8,\r\n-                      backgroundColor: \"#eee\",\r\n-                    }}\r\n-                    resizeMode=\"contain\"\r\n-                  />\r\n-                )}\r\n-\r\n-                <View\r\n-                  style={{\r\n-                    marginTop: 10,\r\n-                    flexDirection: \"row\",\r\n-                    alignItems: \"center\",\r\n-                    justifyContent: \"space-between\",\r\n-                  }}\r\n-                >\r\n-                  <Text>\r\n-                    Status:{\" \"}\r\n-                    <Text style={{ fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus || \"none\"}\r\n-                    </Text>\r\n-                  </Text>\r\n-\r\n-                  <TouchableOpacity\r\n-                    onPress={() =>\r\n-                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                    }\r\n-                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                    style={{\r\n-                      backgroundColor:\r\n-                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                      paddingVertical: 8,\r\n-                      paddingHorizontal: 14,\r\n-                      borderRadius: 8,\r\n-                    }}\r\n-                  >\r\n-                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n-                    </Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-\r\n-  paymentOption: {\r\n-    flex: 1,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n-    paddingVertical: 6,\r\n-    borderRadius: 10,\r\n-    alignItems: \"center\",\r\n-    marginHorizontal: 5,\r\n-    backgroundColor: \"#fff\",\r\n-  },\r\n-  paymentSelected: {\r\n-    backgroundColor: \"#000\",\r\n-    borderColor: \"#333\",\r\n-  },\r\n-  paymentText: {\r\n-    color: \"#333\",\r\n-    fontWeight: \"600\",\r\n-  },\r\n-  paymentSelectedText: {\r\n-    color: \"#fff\",\r\n-    fontWeight: \"700\",\r\n-  },\r\n-\r\n-  \r\n-});\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, \r\n-  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n-  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n-  Keyboard, Image, BackHandler, ScrollView, AppState, Linking  } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-import * as IntentLauncher from 'expo-intent-launcher';\r\n-import { useFocusEffect } from '@react-navigation/native';\r\n-\r\n-\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync(); // ensures we have a real file on device\r\n-  const uri = asset.localUri || asset.uri; // localUri preferred\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),          \r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-\r\n-async function ensureLocationEnabled() {\r\n-  const services = await Location.hasServicesEnabledAsync();\r\n-  const perm = await Location.getForegroundPermissionsAsync();\r\n-\r\n-  if (!services || perm.status !== 'granted') {\r\n-    Alert.alert(\r\n-      \"Enable Location\",\r\n-      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n-      [\r\n-        { text: \"Cancel\", style: \"cancel\" },\r\n-        {\r\n-          text: \"Open Settings\",\r\n-          onPress: () => {\r\n-            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n-            else Linking.openURL('app-settings:');\r\n-          }\r\n-        }\r\n-      ]\r\n-    );\r\n-    return false;\r\n-  }\r\n-  return true;\r\n-}\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-\r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  const { location, loading } = useLocation();\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-  const inflightRef  = useRef<Set<string>>(new Set());\r\n-  const lastReqIdRef = useRef(0);\r\n-  const [showPOIs, setShowPOIs] = useState(false);\r\n-  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n-  // --- Booking type + party size ---\r\n-  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n-  const [partySize, setPartySize] = useState<number>(2);\r\n-  const userMarkerOkRef = useRef(false);\r\n-  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n-  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n-  const routeFramedRef = useRef(false);\r\n-  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n-  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteAtRef   = useRef(0);\r\n-\r\n-  const ROUTE_MIN_MOVE_M   = 35;   // recompute if user moved >= 35 m\r\n-  const ROUTE_MIN_INTERVAL = 8000; // or every 8s, whichever comes first\r\n-\r\n-  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n-\r\n-\r\n-  function ensureUserMarker(lat: number, lng: number) {\r\n-    let attempts = 0;\r\n-    userMarkerOkRef.current = false;\r\n-\r\n-    const tryOnce = () => {\r\n-      attempts += 1;\r\n-      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n-\r\n-      if (!userMarkerOkRef.current && attempts < 6) {\r\n-        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n-      }\r\n-    };\r\n-\r\n-    tryOnce();\r\n-  }\r\n-\r\n-  function roundByZoom(value: number, zoom: number) {\r\n-    const decimals =\r\n-      zoom >= 18 ? 3 :\r\n-      zoom >= 16 ? 3 :\r\n-      zoom >= 15 ? 2 :\r\n-      /* <=14 */   2;\r\n-    const m = Math.pow(10, decimals);\r\n-    return Math.round(value * m) / m;\r\n-  }\r\n-\r\n-\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1)); \r\n-  }\r\n-\r\n-\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) {\r\n-      messageQueue.current.push(json);\r\n-      return;\r\n-    }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapReady || !iconData) return;\r\n-    sendToMap({ type: 'preloadIcons', icons: iconData });\r\n-  }, [mapReady, iconData]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapReady, location]);\r\n-\r\n-  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n-\r\n-  // call on mount\r\n-  useEffect(() => { ensureLocationEnabled(); }, []);\r\n-\r\n-  // call on resume\r\n-  useEffect(() => {\r\n-    const sub = AppState.addEventListener('change', (s) => {\r\n-      if (s === 'active') ensureLocationEnabled();\r\n-    });\r\n-    return () => sub.remove();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    if (!destination || !location) return;\r\n-\r\n-    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n-\r\n-    if (lastRouteDestKeyRef.current !== destKey) {\r\n-      fetchORSRoute(location, destination, true); \r\n-      routeFramedRef.current = true;\r\n-      lastRouteDestKeyRef.current = destKey;\r\n-      lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n-    }\r\n-  }, [destination, location]);\r\n-\r\n-  const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n-\r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const routeReqIdRef = useRef(0);\r\n-\r\n-  const [paymentInfo, setPaymentInfo] = useState<{\r\n-    paymentMethod?: string;\r\n-    paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\";\r\n-    driverPayment?: { number?: string; qrUrl?: string|null };\r\n-  } | null>(null);\r\n-\r\n-  const loadPaymentInfo = async (id: string) => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n-      const j = await r.json();\r\n-      if (j?.ok) setPaymentInfo({\r\n-        paymentMethod: j.paymentMethod,\r\n-        paymentStatus: j.paymentStatus,\r\n-        driverPayment: j.driverPayment || {},\r\n-      });\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\":\"application/json\" },\r\n-        body: JSON.stringify({ status }),\r\n-      });\r\n-      const j = await r.json();\r\n-      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n-    } catch {}\r\n-  };\r\n-\r\n-\r\n-\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to:   { latitude: number; longitude: number },\r\n-    reframe: boolean = false         // <-- NEW\r\n-  ) => {\r\n-    const myReqId = ++routeReqIdRef.current;\r\n-\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end:   [to.longitude,   to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n-      if (myReqId !== routeReqIdRef.current) return; \r\n-\r\n-      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n-\r\n-      const summary    = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM  = summary.distance ?? 0;\r\n-      const durationS  = summary.duration ?? 0;\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins         = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount);\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm,\r\n-        distanceText,\r\n-        durationText,\r\n-        fareText: `‚Ç±${computedFare} est`,\r\n-        reframe,                        \r\n-      });\r\n-    } catch {}\r\n-  };\r\n-\r\n-\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lng = location.longitude; // NOTE: lng\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n-    lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n-    lastRouteAtRef.current   = Date.now();\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest,\r\n-      true\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    sendToMap({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    });\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  const destinationRef = useRef<typeof destination>(null);\r\n-  useEffect(() => { destinationRef.current = destination; }, [destination]);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-        ensureUserMarker(location.latitude, location.longitude);\r\n-      }\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          const { latitude, longitude, accuracy } = pos.coords;\r\n-\r\n-          setLivePos({ latitude, longitude });\r\n-          sendToMap({\r\n-            type: \"updateUserLoc\",\r\n-            latitude,\r\n-            longitude,\r\n-            accuracy: accuracy ?? 15,\r\n-            avatarUrl,\r\n-          });\r\n-          sendToMap({\r\n-            type: \"nudgeRouteStart\",\r\n-            latitude,\r\n-            longitude,\r\n-          });\r\n-\r\n-\r\n-          // ‚úÖ Recompute route without reframe\r\n-          const dest = destinationRef.current;\r\n-          if (dest) {\r\n-            const fromLL = { lat: latitude, lng: longitude };\r\n-            const toLL   = { lat: dest.latitude, lng: dest.longitude };\r\n-\r\n-            const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n-            const now = Date.now();\r\n-            const shouldRecompute =\r\n-              movedM >= ROUTE_MIN_MOVE_M ||\r\n-              (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n-\r\n-            if (shouldRecompute) {\r\n-              fetchORSRoute(\r\n-                { latitude, longitude },\r\n-                dest,\r\n-                false // <-- no reframe on live updates\r\n-              );\r\n-              lastRouteFromRef.current = fromLL;\r\n-              lastRouteToRef.current   = toLL;\r\n-              lastRouteAtRef.current   = now;\r\n-            }\r\n-          }\r\n-\r\n-          if (accuracy && accuracy > 80) return;\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl]); \r\n-\r\n-  \r\n-\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            sendToMap({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            });\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  \r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapHtml, location]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!livePos) return;\r\n-    console.log(\"LIVE POS ‚Üí\", livePos.latitude, livePos.longitude);\r\n-  }, [livePos]);\r\n-\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  // useEffect(() => {\r\n-  //   const backAction = () => {\r\n-  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-  //       {\r\n-  //         text: \"Logout\",\r\n-  //         onPress: async () => {\r\n-  //           await AsyncStorage.removeItem(\"passengerId\");\r\n-  //           router.replace(\"/login_and_reg/plogin\");\r\n-  //         },\r\n-  //       },\r\n-  //     ]);\r\n-  //     return true;\r\n-  //   };\r\n-  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-  //   return () => backHandler.remove();\r\n-  // }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location || mapHtml) return;\r\n-\r\n-  // lock the very first location for the initial setView\r\n-  if (!initialLocRef.current) {\r\n-    initialLocRef.current = {\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-    };\r\n-  }\r\n-\r\n-  const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        if (!window.L) {\r\n-          window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'error', msg:'Leaflet failed to load' }));\r\n-        }\r\n-        // --- Map init ---\r\n-        const map = L.map('map', {\r\n-          zoomControl: true,\r\n-          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n-          maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n-          maxZoom: 19, \r\n-          noWrap: true\r\n-        }).setView([${initLat}, ${initLng}], 15);\r\n-\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        let poiLayer = L.layerGroup().addTo(map);\r\n-        let landmarkLayer = L.layerGroup().addTo(map);\r\n-        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        let userMarkerPlaced = false; // <‚Äî NEW\r\n-\r\n-        let tweenHandle = null;\r\n-        function tweenMarkerTo(lat, lng, durationMs = 300) {\r\n-          if (!userMarker) return upsertUserMarker(lat, lng);\r\n-          if (tweenHandle) cancelAnimationFrame(tweenHandle);\r\n-\r\n-          const start = userMarker.getLatLng();\r\n-          const end = L.latLng(lat, lng);\r\n-          const t0 = performance.now();\r\n-\r\n-          const step = (t) => {\r\n-            const p = Math.min(1, (t - t0) / durationMs);\r\n-            const latI = start.lat + (end.lat - start.lat) * p;\r\n-            const lngI = start.lng + (end.lng - start.lng) * p;\r\n-            userMarker.setLatLng([latI, lngI]);\r\n-            if (p < 1) tweenHandle = requestAnimationFrame(step);\r\n-          };\r\n-          tweenHandle = requestAnimationFrame(step);\r\n-        }\r\n-\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip({ permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-          userMarkerPlaced = true; \r\n-        }\r\n-\r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        const poiMarkers = new Map();        // id -> L.Marker\r\n-        const iconCache  = {};               // category -> L.Icon\r\n-        let poiBatchHandle = null;           // cancel previous batch\r\n-\r\n-        function getPoiIcon(cat, poiIcons) {\r\n-          if (iconCache[cat]) return iconCache[cat];\r\n-\r\n-          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n-            ? poiIcons[cat]\r\n-            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n-\r\n-          iconCache[cat] = L.icon({\r\n-            iconUrl: url,\r\n-            iconSize: [28, 28],\r\n-            iconAnchor: [14, 28],\r\n-          });\r\n-          return iconCache[cat];\r\n-        }\r\n-\r\n-        function addOrUpdatePOIMarker(it, poiIcons) {\r\n-          const existing = poiMarkers.get(it.id);\r\n-          if (existing) {\r\n-            // update position if it changed\r\n-            const curr = existing.getLatLng();\r\n-            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n-              existing.setLatLng([it.lat, it.lng]);\r\n-            }\r\n-            return;\r\n-          }\r\n-          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n-          const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-          // build popup with \"Set Destination\"\r\n-          const container = document.createElement('div');\r\n-          const title = document.createElement('b');\r\n-          title.textContent = it.name || it.category || 'POI';\r\n-          container.appendChild(title);\r\n-          container.appendChild(document.createElement('br'));\r\n-          const btn = document.createElement('button');\r\n-          btn.textContent = 'Set Destination';\r\n-          btn.style.marginTop = '6px';\r\n-          btn.onclick = function () {\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'setDestinationFromPOI',\r\n-              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-            }));\r\n-          };\r\n-          container.appendChild(btn);\r\n-          marker.bindPopup(container);\r\n-\r\n-          marker.addTo(poiLayer);\r\n-          poiMarkers.set(it.id, marker);\r\n-        }\r\n-        \r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        map.on('moveend', function () {\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        });\r\n-\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          if (msg.type === 'ensureUserMarker') {\r\n-            const lat = Number(msg.latitude);\r\n-            const lng = Number(msg.longitude);\r\n-            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n-              upsertUserMarker(lat, lng);\r\n-            }\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'userMarkerEnsured',\r\n-              placed: !!userMarker,\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n-            if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n-            return;\r\n-          }\r\n-\r\n-          // Keep route line's head glued to the moving CL marker\r\n-          if (msg.type === 'nudgeRouteStart') {\r\n-            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n-\r\n-            // Debug: tell RN what we have\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'dbg',\r\n-              tag: 'nudgeRouteStart',\r\n-              lat, lng,\r\n-              hasRoute: !!routeLine\r\n-            }));\r\n-\r\n-            // No route drawn yet? Nothing to nudge\r\n-            if (!routeLine || !Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-\r\n-            // Update the first vertex of the current polyline\r\n-            let pts = routeLine.getLatLngs(); // may be LatLng[] or LatLng[][] if multi\r\n-            if (!Array.isArray(pts) || !pts.length) return;\r\n-\r\n-            // If this is a multi-polyline, take the first segment\r\n-            if (Array.isArray(pts[0]) && pts[0].length) {\r\n-              pts = pts[0];\r\n-            }\r\n-\r\n-            pts[0] = L.latLng(lat, lng);\r\n-            routeLine.setLatLngs(pts);\r\n-\r\n-            if (pts.length > 1) {\r\n-              const p1 = pts[0], p2 = pts[1];\r\n-              const mid = L.latLng(\r\n-                p1.lat + (p2.lat - p1.lat) * 0.15,\r\n-                p1.lng + (p2.lng - p1.lng) * 0.15\r\n-              );\r\n-              routeLine.setLatLngs([p1, mid, ...pts.slice(1)]);\r\n-            }\r\n-\r\n-\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'nudgeAck',\r\n-              ok: true\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-            \r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n-            clearRoute();\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-\r\n-            if (msg.reframe) {\r\n-              map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-            }\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText]\r\n-              .filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({\r\n-              permanent:true, direction:'top', offset:[0,-6], className:'distance-label'\r\n-            }).setContent(label || '').setLatLng(mid).addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n-            }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-          if (msg.type === 'requestBbox') {\r\n-            const b = map.getBounds();\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'bbox',\r\n-              bbox: {\r\n-                minLng: b.getWest(),\r\n-                minLat: b.getSouth(),\r\n-                maxLng: b.getEast(),\r\n-                maxLat: b.getNorth()\r\n-              },\r\n-              zoom: map.getZoom()\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-          const poiIcons = ${iconJson};\r\n-          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n-\r\n-            const z = Number(msg.zoom) || currentZoomLevel;\r\n-            const b = msg.bbox || null;\r\n-\r\n-            // Collect desired items from payload\r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n-            const desiredIds = new Set(desired.keys());\r\n-\r\n-            // Decide strategy based on zoom direction\r\n-            if (z > currentZoomLevel) {\r\n-              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n-              if (b) {\r\n-                for (const [id, marker] of poiMarkers) {\r\n-                  const p = marker.getLatLng();\r\n-                  if (!bboxContains(b, p.lat, p.lng)) {\r\n-                    poiLayer.removeLayer(marker);\r\n-                    poiMarkers.delete(id);\r\n-                  }\r\n-                }\r\n-              }\r\n-            } else if (z < currentZoomLevel) {\r\n-              // ---- ZOOM OUT: shrink to what backend sent\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const keep = desiredIds.has(id);\r\n-                const p = marker.getLatLng();\r\n-                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n-                if (!keep || !onScreen) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            } else {\r\n-              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const p = marker.getLatLng();\r\n-                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n-                if (drop) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            }\r\n-\r\n-            // Build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n-\r\n-            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n-            const total = toAdd.length;\r\n-            const BATCH =\r\n-              total > 300 ? 80 :\r\n-              total > 150 ? 50 :\r\n-              total > 60  ? 35 :\r\n-              25; // small = faster draw\r\n-            const DELAY = total > 150 ? 20 : 10;\r\n-\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n-\r\n-            let i = 0;\r\n-            const addBatch = () => {\r\n-              const end = Math.min(i + BATCH, total);\r\n-              for (; i < end; i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n-                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n-\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n-\r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-\r\n-                // üî• Fade-in animation\r\n-                let op = 0;\r\n-                const fade = () => {\r\n-                  op += 0.15;\r\n-                  if (op <= 1) {\r\n-                    marker.setOpacity(op);\r\n-                    requestAnimationFrame(fade);\r\n-                  } else {\r\n-                    marker.setOpacity(1);\r\n-                  }\r\n-                };\r\n-                requestAnimationFrame(fade);\r\n-              }\r\n-\r\n-              if (i < total) {\r\n-                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n-              } else {\r\n-                poiBatchHandle = null;\r\n-              }\r\n-            };\r\n-\r\n-\r\n-            addBatch();\r\n-\r\n-            currentZoomLevel = z;\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-          // Render Landmarks (pin markers)\r\n-          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n-            landmarkLayer.clearLayers();\r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n-              L.marker([it.lat, it.lng])\r\n-                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n-                .addTo(landmarkLayer);\r\n-            });\r\n-            return;\r\n-          }\r\n-          if (msg.type === 'clearLandmarks') {\r\n-            landmarkLayer.clearLayers();\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [mapHtml, location]);  \r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-\r\n-    // üîµ Update passenger marker live\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-\r\n-    // üß≠ Recompute route occasionally (no zoom)\r\n-    const now = Date.now();\r\n-    if (destination) {\r\n-      const fromLL = { lat: location.latitude, lng: location.longitude };\r\n-      const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n-\r\n-      const movedM = haversine(\r\n-        lastRouteFromRef.current ?? fromLL,\r\n-        fromLL\r\n-      );\r\n-\r\n-      const shouldRecompute =\r\n-        movedM >= ROUTE_MIN_MOVE_M ||\r\n-        (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n-\r\n-      if (shouldRecompute) {\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          destination,\r\n-          false // ‚ö†Ô∏è never reframe on live updates\r\n-        );\r\n-        lastRouteFromRef.current = fromLL;\r\n-        lastRouteToRef.current   = toLL;\r\n-        lastRouteAtRef.current   = now;\r\n-      }\r\n-    }\r\n-  }, [location, avatarUrl, destination]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!initialLocRef.current && location) {\r\n-      initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  useEffect(() => {\r\n-    console.log(\"[PHome] HTML built once?\", !!mapHtml);\r\n-  }, [mapHtml]);\r\n-\r\n-  useEffect(() => {\r\n-    console.log('[PHome] guards:',\r\n-      'hasLocation=', !!location,\r\n-      'hasIconData=', !!iconData,\r\n-      'hasMapHtml=', !!mapHtml\r\n-    );\r\n-  }, [location, iconData, mapHtml]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!destination || !location || !routeFramedRef.current) return;\r\n-\r\n-    const now = { lat: location.latitude, lng: location.longitude };\r\n-    const moved = lastOriginRef.current ? haversine(lastOriginRef.current, now) : Infinity;\r\n-\r\n-    if (moved > 150) {                 // tweak threshold as you like\r\n-      fetchORSRoute(location, destination, false); \r\n-      lastOriginRef.current = now;\r\n-    }\r\n-  }, [location, destination]);\r\n-\r\n-\r\n-  \r\n-\r\n-\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      // Always see what's coming in:\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-\r\n-      if (parsed.type === 'dbg' && parsed.tag === 'nudgeRouteStart') {\r\n-        console.log('[MAP] nudge dbg:', parsed);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'nudgeAck') {\r\n-        console.log('[MAP] nudgeAck ok=', parsed.ok);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'userMarkerEnsured') {\r\n-        userMarkerOkRef.current = !!parsed.placed;\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = Number(parsed.zoom) || 0;\r\n-        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n-        if (!showPOIs || zoom < 14) {\r\n-          sendToMap({ type: 'setPOIs', items: [] });\r\n-          return;\r\n-        };\r\n-\r\n-        const center = parsed.center;\r\n-        if (center && lastCenterRef.current) {\r\n-          const moved = haversine(lastCenterRef.current, center);\r\n-          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n-        }\r\n-        if (center) lastCenterRef.current = center;\r\n-\r\n-        const key = [\r\n-          zoom,\r\n-          roundByZoom(minLng, zoom),\r\n-          roundByZoom(minLat, zoom),\r\n-          roundByZoom(maxLng, zoom),\r\n-          roundByZoom(maxLat, zoom),\r\n-        ].join('|');\r\n-\r\n-        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n-        lastPoiKeyRef.current = key;\r\n-\r\n-        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-        poiFetchTimerRef.current = setTimeout(async () => {\r\n-          try {\r\n-            const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-              `zoom=${zoom}`,\r\n-            ];\r\n-            if (center?.lat != null && center?.lng != null) {\r\n-              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-            }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            if (poiCacheRef.current.has(key)) {\r\n-              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n-              return;\r\n-            }\r\n-\r\n-            if (inflightRef.current.has(key)) {\r\n-              return;\r\n-            }\r\n-\r\n-            inflightRef.current.add(key);\r\n-\r\n-            const reqId = ++lastReqIdRef.current;\r\n-            \r\n-            try {\r\n-              const qs: string[] = [\r\n-                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-                `zoom=${zoom}`,\r\n-              ];\r\n-              if (center?.lat != null && center?.lng != null) {\r\n-                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-              }\r\n-              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-\r\n-              const r = await fetch(url);\r\n-              const items = await r.json();\r\n-\r\n-              if (reqId !== lastReqIdRef.current) {\r\n-                return; // a newer request finished after this one\r\n-              }\r\n-\r\n-              if (Array.isArray(items)) {\r\n-                poiCacheRef.current.set(key, items);\r\n-                sendToMap({ type: 'setPOIs', items });\r\n-              } else {\r\n-                sendToMap({ type: 'setPOIs', items: [] });\r\n-              }\r\n-            } catch (e) {\r\n-              console.log('[ERR] POI fetch failed for', key, e);\r\n-              sendToMap({ type: 'setPOIs', items: [] });\r\n-            } finally {\r\n-              inflightRef.current.delete(key);\r\n-            }\r\n-            const r = await fetch(url);\r\n-            const items = await r.json();\r\n-            if (Array.isArray(items)) {\r\n-              poiCacheRef.current.set(key, items);\r\n-              sendToMap({\r\n-                type: 'setPOIs',\r\n-                items,\r\n-                zoom,                       \r\n-                bbox: { minLng, minLat, maxLng, maxLat },  \r\n-              });\r\n-            }\r\n-\r\n-          } catch {\r\n-            sendToMap({ type: 'setPOIs', items: [] });\r\n-          }\r\n-        }, 500);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'setDestinationFromPOI') {\r\n-        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n-        setDestination(dest);\r\n-        setDropoffName(parsed.label || 'POI Destination');\r\n-\r\n-        if (!location) {\r\n-          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-          return;\r\n-        }\r\n-        const { latitude, longitude } = location;\r\n-\r\n-        lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n-        lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n-        lastRouteAtRef.current   = Date.now();\r\n-\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          dest\r\n-        );\r\n-        sendToMap({\r\n-          type: 'setMarkers',\r\n-          destination: dest,\r\n-          driver: null,\r\n-        });\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-    // Set markers & trigger route drawing when destination is picked\r\n-  // useEffect(() => {\r\n-  //   if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-  //   const driverCoords = matchedDriver?.location\r\n-  //     ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-  //     : null;\r\n-\r\n-  //   if (driverCoords && destination) {\r\n-  //     mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-  //   }\r\n-\r\n-  //   // üëâ draw route as soon as we have both ends\r\n-  //   if (destination && location) {\r\n-  //     fetchORSRoute(location, destination);\r\n-  //   }\r\n-  // }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  if (loading || !location) return null;\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-\r\n-    // Normalize party size based on type\r\n-    const normalizedParty =\r\n-      bookingType === 'GROUP'\r\n-        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n-        : 1; // CLASSIC & SOLO always 1\r\n-\r\n-    setSearching(true);\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId,\r\n-      pickupPlace: pickupName,\r\n-      destinationPlace: dropoffName,\r\n-      bookingType,\r\n-      partySize: normalizedParty,\r\n-    };\r\n-    console.log(bookingData);\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  // {status === \"accepted\" && bookingId && (\r\n-  //   <ChatNotice\r\n-  //     bookingId={bookingId}\r\n-  //     role=\"passenger\"\r\n-  //     onGoToChat={() =>\r\n-  //       router.push({\r\n-  //         pathname: \"/chatcomponent\",\r\n-  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-  //       })\r\n-  //     }\r\n-  //   />\r\n-  // )}\r\n-\r\n-  \r\n-  \r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-          if (bookingId) loadPaymentInfo(String(bookingId));\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!bookingId || !bookingConfirmed) return;\r\n-    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n-    return () => clearInterval(t);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-\r\n-  const cancelRideNow = async () => {\r\n-    try {\r\n-      if (!bookingId) {\r\n-        return;\r\n-      }\r\n-\r\n-      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ bookingId }),\r\n-      });\r\n-      const body = await resp.text();\r\n-\r\n-      // UI reset after server confirms\r\n-      setSearching(false);\r\n-      setBookingId(null);\r\n-      setMatchedDriver(null);\r\n-      setBookingConfirmed(false);\r\n-      setDestination(null);\r\n-      setTripCompleted(false);\r\n-      setAlertedBookingComplete(false);\r\n-      setShowBookingForm(false);\r\n-\r\n-      // Clear map + cached state\r\n-      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-      sendToMap({ type: \"clearRoute\" });\r\n-      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-      setFare(0);\r\n-    } catch (e) {\r\n-      console.log(\"[PHOME] cancel error\", e);\r\n-      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n-    if (!raw) return null;\r\n-\r\n-    // If it's already an absolute URL (Cloudinary, etc.)\r\n-    if (/^https?:\\/\\//i.test(raw)) {\r\n-      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n-      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n-    }\r\n-\r\n-    // Else treat as relative path served by your backend\r\n-    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n-    const path = String(raw).replace(/^\\//, \"\"); // strip leading slash if any\r\n-    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n-    return `${base}/${path}?v=${v}`;\r\n-  };\r\n-\r\n-  const driverSelfieUri = React.useMemo(() => {\r\n-    if (!matchedDriver?.selfieImage) return null;\r\n-\r\n-    // Use a stable version key if you have one; NEVER Date.now()\r\n-    const ver =\r\n-      (matchedDriver as any)?.updatedAt ||\r\n-      (matchedDriver as any)?.selfieUpdatedAt ||\r\n-      matchedDriver?.driverId || // last resort: driverId keeps it stable\r\n-      1;\r\n-\r\n-    return buildImageUri(matchedDriver.selfieImage, ver);\r\n-  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n-\r\n-\r\n-    \r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              allowFileAccess\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              mixedContentMode=\"always\"\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.searchcont}>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lng}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showLandmarks) {\r\n-                  sendToMap({ type: 'clearLandmarks' });\r\n-                  setShowLandmarks(false);\r\n-                } else {\r\n-                  loadLandmarks(); // same function we made before\r\n-                  setShowLandmarks(true);\r\n-                }\r\n-              }}\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n-            </TouchableOpacity>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showPOIs) {\r\n-                  setShowPOIs(false);\r\n-                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                  sendToMap({ type: 'setPOIs', items: [] });\r\n-                } else {\r\n-                  setShowPOIs(true);\r\n-                  const b = lastBBoxRef.current;\r\n-                  if (b) {\r\n-                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n-                    if (zoom >= 14) {\r\n-                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                      poiFetchTimerRef.current = setTimeout(async () => {\r\n-                        try {\r\n-                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n-                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n-                          const r = await fetch(url);\r\n-                          const items = await r.json();\r\n-                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n-                        } catch {\r\n-                          sendToMap({ type: 'setPOIs', items: [] });\r\n-                        }\r\n-                      }, 0);\r\n-                    } else {\r\n-                      sendToMap({ type: 'setPOIs', items: [] });\r\n-                    }\r\n-                  } else {\r\n-                    sendToMap({ type: 'requestBbox' });\r\n-                  }\r\n-                }\r\n-              }}\r\n-\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n-            </TouchableOpacity>\r\n-\r\n-\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>\r\n-                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n-                  </Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={cancelRideNow}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {!infoBoxMinimized ? (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {driverSelfieUri ? (\r\n-                          <Image\r\n-                            source={{ uri: driverSelfieUri }}\r\n-                            style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n-                            resizeMode=\"cover\"\r\n-                          />\r\n-                        ) : null}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n-\r\n-                          <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              router.push({\r\n-                                pathname: \"/ChatRoom\",\r\n-                                params: {\r\n-                                  bookingId,\r\n-                                  driverId: matchedDriver?.driverId,\r\n-                                  passengerId,\r\n-                                  role: \"passenger\",\r\n-                                },\r\n-                              });\r\n-                            }}\r\n-                            style={{\r\n-                              marginTop: 8,\r\n-                              backgroundColor: \"#007bff\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 16,\r\n-                              borderRadius: 8,\r\n-                              alignSelf: \"flex-start\",\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n-                          </TouchableOpacity>\r\n-                        </View>\r\n-                      </View>\r\n-\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              const body = await resp.text();\r\n-\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch (e) {\r\n-                              console.log(\"[PHOME] cancel error\", e);\r\n-                            }\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-                            sendToMap({ type: \"clearRoute\" });\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </>\r\n-                  ) : (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-\r\n-                {/* Booking Type Selector */}\r\n-                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n-                  {[\r\n-                    { key: 'CLASSIC', label: 'Classic' },\r\n-                    { key: 'GROUP', label: 'Group' },\r\n-                    { key: 'SOLO', label: 'Solo' },\r\n-                  ].map((opt) => {\r\n-                    const active = bookingType === (opt.key as any);\r\n-                    return (\r\n-                      <TouchableOpacity\r\n-                        key={opt.key}\r\n-                        onPress={() => {\r\n-                          setBookingType(opt.key as any);\r\n-                          if (opt.key !== 'GROUP') setPartySize(2);\r\n-                        }}\r\n-                        style={{\r\n-                          flex: 1,\r\n-                          backgroundColor: active ? '#111' : '#fff',\r\n-                          borderWidth: 1,\r\n-                          borderColor: active ? '#111' : '#ccc',\r\n-                          paddingVertical: 10,\r\n-                          borderRadius: 10,\r\n-                          alignItems: 'center',\r\n-                        }}\r\n-                      >\r\n-                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n-                          {opt.label}\r\n-                        </Text>\r\n-                      </TouchableOpacity>\r\n-                    );\r\n-                  })}\r\n-                </View>\r\n-\r\n-                {/* Notes for Solo & Group */}\r\n-                {bookingType === 'SOLO' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n-                  </Text>\r\n-                )}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n-                  </Text>\r\n-                )}\r\n-\r\n-                {/* Group Party Size Stepper */}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n-                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n-                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n-                      </TouchableOpacity>\r\n-                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n-                  </View>\r\n-                )}\r\n-\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <Text>From:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <Text>To:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  {/* <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                    value={destinationLabel}\r\n-                    onChangeText={setDestinationLabel}\r\n-                  /> */}\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n-                  <Text>Paano ka magbabayad?</Text>\r\n-                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n-                    <TouchableOpacity\r\n-                      onPress={() => setPaymentMethod(\"Cash\")}\r\n-                      style={[\r\n-                        styles.paymentOption,\r\n-                        paymentMethod === \"Cash\" && styles.paymentSelected\r\n-                      ]}\r\n-                    >\r\n-                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n-                    </TouchableOpacity>\r\n-\r\n-                    <TouchableOpacity\r\n-                      onPress={() => setPaymentMethod(\"GCash\")}\r\n-                      style={[\r\n-                        styles.paymentOption,\r\n-                        paymentMethod === \"GCash\" && styles.paymentSelected\r\n-                      ]}\r\n-                    >\r\n-                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n-                    </TouchableOpacity>\r\n-                  </View>\r\n-\r\n-                </ScrollView>\r\n-\r\n-                <View style={styles.fareContainer}>\r\n-                  <View>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Fare:\r\n-                    </Text>\r\n-                    <Text style={{ paddingLeft: 20 }}>\r\n-                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n-                    </Text>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Total Fare: ‚Ç±\r\n-                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n-                    </Text>\r\n-                  </View>\r\n-                  <TouchableOpacity\r\n-                    style={[\r\n-                      styles.bookButton,\r\n-                      // disable if invalid group count or no destination\r\n-                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n-                    ]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n-                    onPress={handleBookNow}\r\n-                  >\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n             {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n               <View\r\n                 style={{\r\n                   marginTop: 8,\r\n"
                },
                {
                    "date": 1762381750110,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1975,9 +1975,13 @@\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver?.driverName}</Text>\r\n                           <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n+                          <Text style={{ color: \"red\", fontSize: 12 }}>\r\n+                            DEBUG: {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n+                          </Text>\r\n \r\n+\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n                               router.push({\r\n                                 pathname: \"/ChatRoom\",\r\n"
                },
                {
                    "date": 1762381829502,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1975,13 +1975,9 @@\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver?.driverName}</Text>\r\n                           <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n-                          <Text style={{ color: \"red\", fontSize: 12 }}>\r\n-                            DEBUG: {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n-                          </Text>\r\n \r\n-\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n                               router.push({\r\n                                 pathname: \"/ChatRoom\",\r\n"
                },
                {
                    "date": 1762381911160,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2287,9 +2287,13 @@\n                     </Text>\r\n                   </Text>\r\n                   <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n                 </TouchableOpacity>\r\n+                <Text style={{ color: \"red\", fontSize: 12 }}>\r\n+                  DEBUG: {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n+                </Text>\r\n \r\n+\r\n                 {!!paymentInfo?.driverPayment?.qrUrl && (\r\n                   <Image\r\n                     source={{ uri: paymentInfo.driverPayment.qrUrl! }}\r\n                     style={{\r\n"
                },
                {
                    "date": 1762382018165,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2260,8 +2260,16 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n+            <Text style={{ color: \"red\", fontSize: 12, marginVertical: 4 }}>\r\n+              DEBUG:\r\n+              {\"\\n\"}paymentMethod = {JSON.stringify(paymentInfo?.paymentMethod)}\r\n+              {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n+              {\"\\n\"}driverPayment.qrUrl = {JSON.stringify(paymentInfo?.driverPayment?.qrUrl)}\r\n+            </Text>\r\n+\r\n+\r\n             {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n               <View\r\n                 style={{\r\n                   marginTop: 8,\r\n"
                },
                {
                    "date": 1762382080113,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2260,9 +2260,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            <Text style={{ color: \"red\", fontSize: 12, marginVertical: 4 }}>\r\n+            <Text style={{ color: \"red\", fontSize: 12, bottom: 200, marginVertical: 4 }}>\r\n               DEBUG:\r\n               {\"\\n\"}paymentMethod = {JSON.stringify(paymentInfo?.paymentMethod)}\r\n               {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n               {\"\\n\"}driverPayment.qrUrl = {JSON.stringify(paymentInfo?.driverPayment?.qrUrl)}\r\n"
                },
                {
                    "date": 1762382087364,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2260,9 +2260,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            <Text style={{ color: \"red\", fontSize: 12, bottom: 200, marginVertical: 4 }}>\r\n+            <Text style={{ color: \"red\", fontSize: 12, bottom: 300, marginVertical: 4 }}>\r\n               DEBUG:\r\n               {\"\\n\"}paymentMethod = {JSON.stringify(paymentInfo?.paymentMethod)}\r\n               {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n               {\"\\n\"}driverPayment.qrUrl = {JSON.stringify(paymentInfo?.driverPayment?.qrUrl)}\r\n"
                },
                {
                    "date": 1762382123965,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2264,8 +2264,9 @@\n             <Text style={{ color: \"red\", fontSize: 12, bottom: 300, marginVertical: 4 }}>\r\n               DEBUG:\r\n               {\"\\n\"}paymentMethod = {JSON.stringify(paymentInfo?.paymentMethod)}\r\n               {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n+              {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.gcashNumber)}\r\n               {\"\\n\"}driverPayment.qrUrl = {JSON.stringify(paymentInfo?.driverPayment?.qrUrl)}\r\n             </Text>\r\n \r\n \r\n"
                },
                {
                    "date": 1762382136581,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2264,9 +2264,8 @@\n             <Text style={{ color: \"red\", fontSize: 12, bottom: 300, marginVertical: 4 }}>\r\n               DEBUG:\r\n               {\"\\n\"}paymentMethod = {JSON.stringify(paymentInfo?.paymentMethod)}\r\n               {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n-              {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.gcashNumber)}\r\n               {\"\\n\"}driverPayment.qrUrl = {JSON.stringify(paymentInfo?.driverPayment?.qrUrl)}\r\n             </Text>\r\n \r\n \r\n"
                },
                {
                    "date": 1762384585276,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2260,16 +2260,9 @@\n                 </View>\r\n               </View>\r\n             )}\r\n \r\n-            <Text style={{ color: \"red\", fontSize: 12, bottom: 300, marginVertical: 4 }}>\r\n-              DEBUG:\r\n-              {\"\\n\"}paymentMethod = {JSON.stringify(paymentInfo?.paymentMethod)}\r\n-              {\"\\n\"}driverPayment.number = {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n-              {\"\\n\"}driverPayment.qrUrl = {JSON.stringify(paymentInfo?.driverPayment?.qrUrl)}\r\n-            </Text>\r\n \r\n-\r\n             {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n               <View\r\n                 style={{\r\n                   marginTop: 8,\r\n"
                },
                {
                    "date": 1762384604348,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2292,24 +2292,8 @@\n                 <Text style={{ color: \"red\", fontSize: 12 }}>\r\n                   DEBUG: {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n                 </Text>\r\n \r\n-\r\n-                {!!paymentInfo?.driverPayment?.qrUrl && (\r\n-                  <Image\r\n-                    source={{ uri: paymentInfo.driverPayment.qrUrl! }}\r\n-                    style={{\r\n-                      width: 160,\r\n-                      height: 160,\r\n-                      alignSelf: \"center\",\r\n-                      marginTop: 6,\r\n-                      borderRadius: 8,\r\n-                      backgroundColor: \"#eee\",\r\n-                    }}\r\n-                    resizeMode=\"contain\"\r\n-                  />\r\n-                )}\r\n-\r\n                 <View\r\n                   style={{\r\n                     marginTop: 10,\r\n                     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1762384614743,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2288,12 +2288,8 @@\n                     </Text>\r\n                   </Text>\r\n                   <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n                 </TouchableOpacity>\r\n-                <Text style={{ color: \"red\", fontSize: 12 }}>\r\n-                  DEBUG: {JSON.stringify(paymentInfo?.driverPayment?.number)}\r\n-                </Text>\r\n-\r\n                 <View\r\n                   style={{\r\n                     marginTop: 10,\r\n                     flexDirection: \"row\",\r\n"
                },
                {
                    "date": 1762384725506,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2276,9 +2276,8 @@\n \r\n                 <TouchableOpacity\r\n                   onPress={() => {\r\n                     const n = paymentInfo.driverPayment!.number!;\r\n-                    Alert.alert(\"Copied\", `GCash Number: ${n}`);\r\n                   }}\r\n                   style={{ paddingVertical: 6 }}\r\n                 >\r\n                   <Text>\r\n"
                },
                {
                    "date": 1762384793647,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2266,9 +2266,9 @@\n               <View\r\n                 style={{\r\n                   marginTop: 8,\r\n                   padding: 10,\r\n-                  bottom: 200,\r\n+                  bottom: 300,\r\n                   backgroundColor: \"#fff\",\r\n                   borderRadius: 8,\r\n                 }}\r\n               >\r\n"
                },
                {
                    "date": 1762384825690,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2008,9 +2008,9 @@\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report Driver</Text>\r\n+                          <Text style={{ color: \"white\" }}>Report</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n                           onPress={async () => {\r\n"
                },
                {
                    "date": 1762384834704,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2037,9 +2037,9 @@\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n                           style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n-                          <Text style={{ color: \"white\" }}>Cancel Ride</Text>\r\n+                          <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                     </>\r\n                   ) : (\r\n"
                },
                {
                    "date": 1762384865775,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1976,9 +1976,18 @@\n                           <Text>Name: {matchedDriver?.driverName}</Text>\r\n                           <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n \r\n-                          <TouchableOpacity\r\n+                          \r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n                             onPress={() => {\r\n                               router.push({\r\n                                 pathname: \"/ChatRoom\",\r\n                                 params: {\r\n@@ -1997,18 +2006,11 @@\n                               borderRadius: 8,\r\n                               alignSelf: \"flex-start\",\r\n                             }}\r\n                           >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>üí¨ Chat</Text>\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n                           </TouchableOpacity>\r\n-                        </View>\r\n-                      </View>\r\n \r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n                         <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Report</Text>\r\n                         </TouchableOpacity>\r\n \r\n"
                },
                {
                    "date": 1762384901102,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1997,16 +1997,9 @@\n                                   role: \"passenger\",\r\n                                 },\r\n                               });\r\n                             }}\r\n-                            style={{\r\n-                              marginTop: 8,\r\n-                              backgroundColor: \"#007bff\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 16,\r\n-                              borderRadius: 8,\r\n-                              alignSelf: \"flex-start\",\r\n-                            }}\r\n+                            style={{ backgroundColor: \"#007bff\", borderRadius: 5, padding: 5 }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n                           </TouchableOpacity>\r\n \r\n"
                },
                {
                    "date": 1762385070087,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1980,9 +1980,9 @@\n                           \r\n                         </View>\r\n                       </View>\r\n \r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                      <View style={{ flexDirection: \"row\", marginTop: 10 }}>\r\n                         <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n"
                },
                {
                    "date": 1762385134564,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1997,9 +1997,9 @@\n                                   role: \"passenger\",\r\n                                 },\r\n                               });\r\n                             }}\r\n-                            style={{ backgroundColor: \"#007bff\", borderRadius: 5, padding: 5 }}\r\n+                            style={{ backgroundColor: \"#007bff\", flexGrow: 1, borderRadius: 5, padding: 5 }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n                           </TouchableOpacity>\r\n \r\n"
                },
                {
                    "date": 1762385147463,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1981,9 +1981,9 @@\n                         </View>\r\n                       </View>\r\n \r\n                       <View style={{ flexDirection: \"row\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", borderRadius: 5, padding: 5 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flexGrow: 1, borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n"
                },
                {
                    "date": 1762385168183,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2002,9 +2002,9 @@\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n                           </TouchableOpacity>\r\n \r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}>\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flexGrow: 1, borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Report</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n@@ -2030,9 +2030,9 @@\n                             sendToMap({ type: \"clearRoute\" });\r\n                             setFare(0);\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n-                          style={{ backgroundColor: \"#f44336\", borderRadius: 5, padding: 5 }}\r\n+                          style={{ backgroundColor: \"#f44336\", flexGrow: 1, borderRadius: 5, padding: 5 }}\r\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n"
                },
                {
                    "date": 1762385241933,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1981,9 +1981,9 @@\n                         </View>\r\n                       </View>\r\n \r\n                       <View style={{ flexDirection: \"row\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flexGrow: 1, borderRadius: 5, padding: 5 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n@@ -1997,14 +1997,14 @@\n                                   role: \"passenger\",\r\n                                 },\r\n                               });\r\n                             }}\r\n-                            style={{ backgroundColor: \"#007bff\", flexGrow: 1, borderRadius: 5, padding: 5 }}\r\n+                            style={{ backgroundColor: \"#007bff\", flex: 1, borderRadius: 5, padding: 5 }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n                           </TouchableOpacity>\r\n \r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flexGrow: 1, borderRadius: 5, padding: 5 }}>\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flex: 1, borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Report</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n@@ -2030,9 +2030,9 @@\n                             sendToMap({ type: \"clearRoute\" });\r\n                             setFare(0);\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n-                          style={{ backgroundColor: \"#f44336\", flexGrow: 1, borderRadius: 5, padding: 5 }}\r\n+                          style={{ backgroundColor: \"#f44336\", flex: 1, borderRadius: 5, padding: 5 }}\r\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n"
                },
                {
                    "date": 1762385334374,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1981,9 +1981,9 @@\n                         </View>\r\n                       </View>\r\n \r\n                       <View style={{ flexDirection: \"row\", marginTop: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, borderRadius: 5, padding: 5 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n"
                },
                {
                    "date": 1762385354216,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1997,14 +1997,14 @@\n                                   role: \"passenger\",\r\n                                 },\r\n                               });\r\n                             }}\r\n-                            style={{ backgroundColor: \"#007bff\", flex: 1, borderRadius: 5, padding: 5 }}\r\n+                            style={{ backgroundColor: \"#007bff\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n                           </TouchableOpacity>\r\n \r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flex: 1, borderRadius: 5, padding: 5 }}>\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Report</Text>\r\n                         </TouchableOpacity>\r\n \r\n                         <TouchableOpacity\r\n@@ -2030,9 +2030,9 @@\n                             sendToMap({ type: \"clearRoute\" });\r\n                             setFare(0);\r\n                             if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n                           }}\r\n-                          style={{ backgroundColor: \"#f44336\", flex: 1, borderRadius: 5, padding: 5 }}\r\n+                          style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n"
                },
                {
                    "date": 1762385435430,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1980,9 +1980,9 @@\n                           \r\n                         </View>\r\n                       </View>\r\n \r\n-                      <View style={{ flexDirection: \"row\", marginTop: 10 }}>\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n                         <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n"
                },
                {
                    "date": 1762385961218,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1980,9 +1980,9 @@\n                           \r\n                         </View>\r\n                       </View>\r\n \r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10 }}>\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10, gap: 10 }}>\r\n                         <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n                           <Text style={{ color: \"white\" }}>Minimize</Text>\r\n                         </TouchableOpacity>\r\n \r\n"
                },
                {
                    "date": 1762386015745,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1946,8 +1946,70 @@\n                   </TouchableOpacity>\r\n                 </View>\r\n               )}\r\n \r\n+              {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n+              <View\r\n+                style={{\r\n+                  marginTop: 8,\r\n+                  padding: 10,\r\n+                  bottom: 300,\r\n+                  backgroundColor: \"#fff\",\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    const n = paymentInfo.driverPayment!.number!;\r\n+                  }}\r\n+                  style={{ paddingVertical: 6 }}\r\n+                >\r\n+                  <Text>\r\n+                    Number:{\" \"}\r\n+                    <Text style={{ fontWeight: \"600\" }}>\r\n+                      {paymentInfo.driverPayment.number}\r\n+                    </Text>\r\n+                  </Text>\r\n+                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                </TouchableOpacity>\r\n+                <View\r\n+                  style={{\r\n+                    marginTop: 10,\r\n+                    flexDirection: \"row\",\r\n+                    alignItems: \"center\",\r\n+                    justifyContent: \"space-between\",\r\n+                  }}\r\n+                >\r\n+                  <Text>\r\n+                    Status:{\" \"}\r\n+                    <Text style={{ fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus || \"none\"}\r\n+                    </Text>\r\n+                  </Text>\r\n+\r\n+                  <TouchableOpacity\r\n+                    onPress={() =>\r\n+                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                    }\r\n+                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                    style={{\r\n+                      backgroundColor:\r\n+                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                      paddingVertical: 8,\r\n+                      paddingHorizontal: 14,\r\n+                      borderRadius: 8,\r\n+                    }}\r\n+                  >\r\n+                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                    </Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n@@ -2256,69 +2318,9 @@\n               </View>\r\n             )}\r\n \r\n \r\n-            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n-              <View\r\n-                style={{\r\n-                  marginTop: 8,\r\n-                  padding: 10,\r\n-                  bottom: 300,\r\n-                  backgroundColor: \"#fff\",\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    const n = paymentInfo.driverPayment!.number!;\r\n-                  }}\r\n-                  style={{ paddingVertical: 6 }}\r\n-                >\r\n-                  <Text>\r\n-                    Number:{\" \"}\r\n-                    <Text style={{ fontWeight: \"600\" }}>\r\n-                      {paymentInfo.driverPayment.number}\r\n-                    </Text>\r\n-                  </Text>\r\n-                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n-                </TouchableOpacity>\r\n-                <View\r\n-                  style={{\r\n-                    marginTop: 10,\r\n-                    flexDirection: \"row\",\r\n-                    alignItems: \"center\",\r\n-                    justifyContent: \"space-between\",\r\n-                  }}\r\n-                >\r\n-                  <Text>\r\n-                    Status:{\" \"}\r\n-                    <Text style={{ fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus || \"none\"}\r\n-                    </Text>\r\n-                  </Text>\r\n-\r\n-                  <TouchableOpacity\r\n-                    onPress={() =>\r\n-                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                    }\r\n-                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                    style={{\r\n-                      backgroundColor:\r\n-                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                      paddingVertical: 8,\r\n-                      paddingHorizontal: 14,\r\n-                      borderRadius: 8,\r\n-                    }}\r\n-                  >\r\n-                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n-                    </Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n+            \r\n           </View>\r\n         </View>\r\n       </TouchableWithoutFeedback>\r\n     </KeyboardAvoidingView>\r\n"
                },
                {
                    "date": 1762386023361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1946,70 +1946,10 @@\n                   </TouchableOpacity>\r\n                 </View>\r\n               )}\r\n \r\n-              {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n-              <View\r\n-                style={{\r\n-                  marginTop: 8,\r\n-                  padding: 10,\r\n-                  bottom: 300,\r\n-                  backgroundColor: \"#fff\",\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+              \r\n \r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    const n = paymentInfo.driverPayment!.number!;\r\n-                  }}\r\n-                  style={{ paddingVertical: 6 }}\r\n-                >\r\n-                  <Text>\r\n-                    Number:{\" \"}\r\n-                    <Text style={{ fontWeight: \"600\" }}>\r\n-                      {paymentInfo.driverPayment.number}\r\n-                    </Text>\r\n-                  </Text>\r\n-                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n-                </TouchableOpacity>\r\n-                <View\r\n-                  style={{\r\n-                    marginTop: 10,\r\n-                    flexDirection: \"row\",\r\n-                    alignItems: \"center\",\r\n-                    justifyContent: \"space-between\",\r\n-                  }}\r\n-                >\r\n-                  <Text>\r\n-                    Status:{\" \"}\r\n-                    <Text style={{ fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus || \"none\"}\r\n-                    </Text>\r\n-                  </Text>\r\n-\r\n-                  <TouchableOpacity\r\n-                    onPress={() =>\r\n-                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                    }\r\n-                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                    style={{\r\n-                      backgroundColor:\r\n-                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                      paddingVertical: 8,\r\n-                      paddingHorizontal: 14,\r\n-                      borderRadius: 8,\r\n-                    }}\r\n-                  >\r\n-                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n-                    </Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n               {matchedDriver && (\r\n                 <View\r\n                   style={{\r\n                     position: \"absolute\",\r\n"
                },
                {
                    "date": 1762386030464,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2047,8 +2047,70 @@\n                 </View>\r\n               )}\r\n             </View>\r\n \r\n+            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n+              <View\r\n+                style={{\r\n+                  marginTop: 8,\r\n+                  padding: 10,\r\n+                  bottom: 300,\r\n+                  backgroundColor: \"#fff\",\r\n+                  borderRadius: 8,\r\n+                }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+\r\n+                <TouchableOpacity\r\n+                  onPress={() => {\r\n+                    const n = paymentInfo.driverPayment!.number!;\r\n+                  }}\r\n+                  style={{ paddingVertical: 6 }}\r\n+                >\r\n+                  <Text>\r\n+                    Number:{\" \"}\r\n+                    <Text style={{ fontWeight: \"600\" }}>\r\n+                      {paymentInfo.driverPayment.number}\r\n+                    </Text>\r\n+                  </Text>\r\n+                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                </TouchableOpacity>\r\n+                <View\r\n+                  style={{\r\n+                    marginTop: 10,\r\n+                    flexDirection: \"row\",\r\n+                    alignItems: \"center\",\r\n+                    justifyContent: \"space-between\",\r\n+                  }}\r\n+                >\r\n+                  <Text>\r\n+                    Status:{\" \"}\r\n+                    <Text style={{ fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus || \"none\"}\r\n+                    </Text>\r\n+                  </Text>\r\n+\r\n+                  <TouchableOpacity\r\n+                    onPress={() =>\r\n+                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                    }\r\n+                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                    style={{\r\n+                      backgroundColor:\r\n+                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                      paddingVertical: 8,\r\n+                      paddingHorizontal: 14,\r\n+                      borderRadius: 8,\r\n+                    }}\r\n+                  >\r\n+                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                    </Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n             {showBookingForm && (\r\n               <View style={styles.panel}>\r\n                 <Text style={styles.panelTitle}>Booking Details</Text>\r\n \r\n"
                },
                {
                    "date": 1762386150169,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2036,8 +2036,27 @@\n                           style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n+                        {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n+                          <TouchableOpacity\r\n+                            onPress={() =>\r\n+                              bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                            }\r\n+                            disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                            style={{\r\n+                              backgroundColor:\r\n+                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                              paddingVertical: 8,\r\n+                              paddingHorizontal: 14,\r\n+                              borderRadius: 8,\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                            </Text>\r\n+                          </TouchableOpacity>\r\n+                        )}\r\n                       </View>\r\n                     </>\r\n                   ) : (\r\n                     <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n"
                },
                {
                    "date": 1762386171208,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2051,9 +2051,9 @@\n                               borderRadius: 8,\r\n                             }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n                             </Text>\r\n                           </TouchableOpacity>\r\n                         )}\r\n                       </View>\r\n"
                },
                {
                    "date": 1762386229026,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2045,11 +2045,9 @@\n                             disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n                             style={{\r\n                               backgroundColor:\r\n                                 paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                              paddingVertical: 8,\r\n-                              paddingHorizontal: 14,\r\n-                              borderRadius: 8,\r\n+                              flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5\r\n                             }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n                               {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n"
                },
                {
                    "date": 1762386268418,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2036,25 +2036,8 @@\n                           style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n-                        {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-                          <TouchableOpacity\r\n-                            onPress={() =>\r\n-                              bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                            }\r\n-                            disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                            style={{\r\n-                              backgroundColor:\r\n-                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                              flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n-                            </Text>\r\n-                          </TouchableOpacity>\r\n-                        )}\r\n                       </View>\r\n                     </>\r\n                   ) : (\r\n                     <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n"
                },
                {
                    "date": 1762386275391,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2037,8 +2037,25 @@\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n+                      {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n+                          <TouchableOpacity\r\n+                            onPress={() =>\r\n+                              bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                            }\r\n+                            disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                            style={{\r\n+                              backgroundColor:\r\n+                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n+                              flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n+                            </Text>\r\n+                          </TouchableOpacity>\r\n+                        )}\r\n                     </>\r\n                   ) : (\r\n                     <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n                       <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n"
                },
                {
                    "date": 1762386300064,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2045,10 +2045,10 @@\n                             }\r\n                             disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n                             style={{\r\n                               backgroundColor:\r\n-                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                              flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5\r\n+                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n+                              alignItems: \"center\", borderRadius: 5, padding: 5\r\n                             }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n                               {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n"
                },
                {
                    "date": 1762386317773,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,24 +2038,24 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-                          <TouchableOpacity\r\n-                            onPress={() =>\r\n-                              bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                            }\r\n-                            disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                            style={{\r\n-                              backgroundColor:\r\n-                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                              alignItems: \"center\", borderRadius: 5, padding: 5\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n-                            </Text>\r\n-                          </TouchableOpacity>\r\n-                        )}\r\n+                        <TouchableOpacity\r\n+                          onPress={() =>\r\n+                            bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                          }\r\n+                          disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                          style={{\r\n+                            backgroundColor:\r\n+                              paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n+                            alignItems: \"center\", borderRadius: 5, padding: 5\r\n+                          }}\r\n+                        >\r\n+                          <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                            {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n+                          </Text>\r\n+                        </TouchableOpacity>\r\n+                      )}\r\n                     </>\r\n                   ) : (\r\n                     <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n                       <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n"
                },
                {
                    "date": 1762386341580,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2037,25 +2037,28 @@\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n-                      {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n-                        <TouchableOpacity\r\n-                          onPress={() =>\r\n-                            bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                          }\r\n-                          disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                          style={{\r\n-                            backgroundColor:\r\n-                              paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                            alignItems: \"center\", borderRadius: 5, padding: 5\r\n-                          }}\r\n-                        >\r\n-                          <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                            {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n-                          </Text>\r\n-                        </TouchableOpacity>\r\n-                      )}\r\n+                      <View>\r\n+                        {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n+                          <TouchableOpacity\r\n+                            onPress={() =>\r\n+                              bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                            }\r\n+                            disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                            style={{\r\n+                              backgroundColor:\r\n+                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n+                              alignItems: \"center\", borderRadius: 5, padding: 5\r\n+                            }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n+                            </Text>\r\n+                          </TouchableOpacity>\r\n+                        )}\r\n+                      </View>\r\n+                      \r\n                     </>\r\n                   ) : (\r\n                     <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n                       <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n"
                },
                {
                    "date": 1762386369563,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2037,9 +2037,9 @@\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n-                      <View>\r\n+                      <View style={{paddingTop:5}}>\r\n                         {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n                           <TouchableOpacity\r\n                             onPress={() =>\r\n                               bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n"
                },
                {
                    "date": 1762386385964,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2037,9 +2037,9 @@\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n-                      <View style={{paddingTop:5}}>\r\n+                      <View style={{paddingTop:5, flexDirection: \"row\"}}>\r\n                         {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n                           <TouchableOpacity\r\n                             onPress={() =>\r\n                               bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n"
                },
                {
                    "date": 1762386591868,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2037,11 +2037,26 @@\n                         >\r\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n-                      <View style={{paddingTop:5, flexDirection: \"row\"}}>\r\n-                        {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && (\r\n+                      {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n+                        <View style={{paddingTop:5, flexDirection: \"row\"}}>\r\n+                          <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n                           <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              const n = paymentInfo.driverPayment!.number!;\r\n+                            }}\r\n+                            style={{ paddingVertical: 6 }}\r\n+                          >\r\n+                            <Text>\r\n+                              Number:{\" \"}\r\n+                              <Text style={{ fontWeight: \"600\" }}>\r\n+                                {paymentInfo.driverPayment.number}\r\n+                              </Text>\r\n+                            </Text>\r\n+                            <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                          </TouchableOpacity>\r\n+                          <TouchableOpacity\r\n                             onPress={() =>\r\n                               bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n                             }\r\n                             disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n@@ -2051,14 +2066,13 @@\n                               alignItems: \"center\", borderRadius: 5, padding: 5\r\n                             }}\r\n                           >\r\n                             <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Paid\"}\r\n+                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n                             </Text>\r\n                           </TouchableOpacity>\r\n-                        )}\r\n-                      </View>\r\n-                      \r\n+                        </View>\r\n+                      )}\r\n                     </>\r\n                   ) : (\r\n                     <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n                       <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n"
                },
                {
                    "date": 1762386609309,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2039,9 +2039,8 @@\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n                         <View style={{paddingTop:5, flexDirection: \"row\"}}>\r\n-                          <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n                               const n = paymentInfo.driverPayment!.number!;\r\n                             }}\r\n"
                },
                {
                    "date": 1762386626887,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,9 +2038,9 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View style={{paddingTop:5, flexDirection: \"row\"}}>\r\n+                        <View style={{paddingTop:5, flexDirection: \"row\", justifyContent: \"space-around\"}}>\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n                               const n = paymentInfo.driverPayment!.number!;\r\n                             }}\r\n"
                },
                {
                    "date": 1762386689324,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,9 +2038,9 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View style={{paddingTop:5, flexDirection: \"row\", justifyContent: \"space-around\"}}>\r\n+                        <View style={{paddingTop:5, flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n                           <TouchableOpacity\r\n                             onPress={() => {\r\n                               const n = paymentInfo.driverPayment!.number!;\r\n                             }}\r\n"
                },
                {
                    "date": 1762386751105,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,38 +2038,41 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View style={{paddingTop:5, flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n-                          <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              const n = paymentInfo.driverPayment!.number!;\r\n-                            }}\r\n-                            style={{ paddingVertical: 6 }}\r\n-                          >\r\n-                            <Text>\r\n-                              Number:{\" \"}\r\n-                              <Text style={{ fontWeight: \"600\" }}>\r\n-                                {paymentInfo.driverPayment.number}\r\n+                        <View>\r\n+                          <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+                          <View style={{paddingTop:5, flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n+                            <TouchableOpacity\r\n+                              onPress={() => {\r\n+                                const n = paymentInfo.driverPayment!.number!;\r\n+                              }}\r\n+                              style={{ paddingVertical: 6 }}\r\n+                            >\r\n+                              <Text>\r\n+                                Number:{\" \"}\r\n+                                <Text style={{ fontWeight: \"600\" }}>\r\n+                                  {paymentInfo.driverPayment.number}\r\n+                                </Text>\r\n                               </Text>\r\n-                            </Text>\r\n-                            <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n-                          </TouchableOpacity>\r\n-                          <TouchableOpacity\r\n-                            onPress={() =>\r\n-                              bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                            }\r\n-                            disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                            style={{\r\n-                              backgroundColor:\r\n-                                paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                              alignItems: \"center\", borderRadius: 5, padding: 5\r\n-                            }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                              {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n-                            </Text>\r\n-                          </TouchableOpacity>\r\n+                              <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                            </TouchableOpacity>\r\n+                            <TouchableOpacity\r\n+                              onPress={() =>\r\n+                                bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                              }\r\n+                              disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                              style={{\r\n+                                backgroundColor:\r\n+                                  paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n+                                alignItems: \"center\", borderRadius: 5, padding: 5\r\n+                              }}\r\n+                            >\r\n+                              <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                                {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                              </Text>\r\n+                            </TouchableOpacity>\r\n+                          </View>\r\n                         </View>\r\n                       )}\r\n                     </>\r\n                   ) : (\r\n"
                },
                {
                    "date": 1762386776102,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,11 +2038,11 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View>\r\n+                        <View style={{paddingTop:5}}>\r\n                           <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-                          <View style={{paddingTop:5, flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n+                          <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n                             <TouchableOpacity\r\n                               onPress={() => {\r\n                                 const n = paymentInfo.driverPayment!.number!;\r\n                               }}\r\n"
                },
                {
                    "date": 1762386814092,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2063,9 +2063,9 @@\n                               disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n                               style={{\r\n                                 backgroundColor:\r\n                                   paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                                alignItems: \"center\", borderRadius: 5, padding: 5\r\n+                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5\r\n                               }}\r\n                             >\r\n                               <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n                                 {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n"
                },
                {
                    "date": 1762386832882,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,9 +2038,9 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View style={{paddingTop:5}}>\r\n+                        <View style={{paddingTop:10}}>\r\n                           <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n                           <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n                             <TouchableOpacity\r\n                               onPress={() => {\r\n"
                },
                {
                    "date": 1762386845777,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2038,9 +2038,9 @@\n                           <Text style={{ color: \"white\" }}>Cancel</Text>\r\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View style={{paddingTop:10}}>\r\n+                        <View style={{paddingTop:5}}>\r\n                           <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n                           <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n                             <TouchableOpacity\r\n                               onPress={() => {\r\n"
                },
                {
                    "date": 1762386858276,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2063,9 +2063,9 @@\n                               disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n                               style={{\r\n                                 backgroundColor:\r\n                                   paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5\r\n+                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5\r\n                               }}\r\n                             >\r\n                               <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n                                 {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n"
                },
                {
                    "date": 1762386897365,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2045,9 +2045,9 @@\n                             <TouchableOpacity\r\n                               onPress={() => {\r\n                                 const n = paymentInfo.driverPayment!.number!;\r\n                               }}\r\n-                              style={{ paddingVertical: 6 }}\r\n+                              style={{ paddingVertical: 3 }}\r\n                             >\r\n                               <Text>\r\n                                 Number:{\" \"}\r\n                                 <Text style={{ fontWeight: \"600\" }}>\r\n@@ -2063,9 +2063,9 @@\n                               disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n                               style={{\r\n                                 backgroundColor:\r\n                                   paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5\r\n+                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5\r\n                               }}\r\n                             >\r\n                               <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n                                 {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n"
                },
                {
                    "date": 1762386906883,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2045,9 +2045,8 @@\n                             <TouchableOpacity\r\n                               onPress={() => {\r\n                                 const n = paymentInfo.driverPayment!.number!;\r\n                               }}\r\n-                              style={{ paddingVertical: 3 }}\r\n                             >\r\n                               <Text>\r\n                                 Number:{\" \"}\r\n                                 <Text style={{ fontWeight: \"600\" }}>\r\n"
                },
                {
                    "date": 1762387053840,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2039,9 +2039,17 @@\n                         </TouchableOpacity>\r\n                       </View>\r\n                       {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n                         <View style={{paddingTop:5}}>\r\n-                          <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+                          <View style={{flexDirection:\"row\", justifyContent:\"space-between\"}}>\r\n+                            <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+                            <Text>\r\n+                              Status:{\" \"}\r\n+                              <Text style={{ fontWeight: \"700\" }}>\r\n+                                {paymentInfo?.paymentStatus || \"none\"}\r\n+                              </Text>\r\n+                            </Text>\r\n+                          </View>\r\n                           <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n                             <TouchableOpacity\r\n                               onPress={() => {\r\n                                 const n = paymentInfo.driverPayment!.number!;\r\n@@ -2116,14 +2124,9 @@\n                     alignItems: \"center\",\r\n                     justifyContent: \"space-between\",\r\n                   }}\r\n                 >\r\n-                  <Text>\r\n-                    Status:{\" \"}\r\n-                    <Text style={{ fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus || \"none\"}\r\n-                    </Text>\r\n-                  </Text>\r\n+                  \r\n \r\n                   <TouchableOpacity\r\n                     onPress={() =>\r\n                       bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n"
                },
                {
                    "date": 1762387076642,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2090,65 +2090,8 @@\n                 </View>\r\n               )}\r\n             </View>\r\n \r\n-            {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number && (\r\n-              <View\r\n-                style={{\r\n-                  marginTop: 8,\r\n-                  padding: 10,\r\n-                  bottom: 300,\r\n-                  backgroundColor: \"#fff\",\r\n-                  borderRadius: 8,\r\n-                }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-\r\n-                <TouchableOpacity\r\n-                  onPress={() => {\r\n-                    const n = paymentInfo.driverPayment!.number!;\r\n-                  }}\r\n-                  style={{ paddingVertical: 6 }}\r\n-                >\r\n-                  <Text>\r\n-                    Number:{\" \"}\r\n-                    <Text style={{ fontWeight: \"600\" }}>\r\n-                      {paymentInfo.driverPayment.number}\r\n-                    </Text>\r\n-                  </Text>\r\n-                  <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n-                </TouchableOpacity>\r\n-                <View\r\n-                  style={{\r\n-                    marginTop: 10,\r\n-                    flexDirection: \"row\",\r\n-                    alignItems: \"center\",\r\n-                    justifyContent: \"space-between\",\r\n-                  }}\r\n-                >\r\n-                  \r\n-\r\n-                  <TouchableOpacity\r\n-                    onPress={() =>\r\n-                      bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                    }\r\n-                    disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                    style={{\r\n-                      backgroundColor:\r\n-                        paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\",\r\n-                      paddingVertical: 8,\r\n-                      paddingHorizontal: 14,\r\n-                      borderRadius: 8,\r\n-                    }}\r\n-                  >\r\n-                    <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                      {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n-                    </Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n             {showBookingForm && (\r\n               <View style={styles.panel}>\r\n                 <Text style={styles.panelTitle}>Booking Details</Text>\r\n \r\n"
                },
                {
                    "date": 1762387322411,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,8 +18,9 @@\n import { Asset } from 'expo-asset';\r\n import * as FileSystem from 'expo-file-system';\r\n import * as IntentLauncher from 'expo-intent-launcher';\r\n import { useFocusEffect } from '@react-navigation/native';\r\n+import * as Clipboard from 'expo-clipboard';\r\n \r\n \r\n \r\n async function getLocalIconBase64(localPath: any) {\r\n"
                },
                {
                    "date": 1762387367999,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -127,8 +127,9 @@\n   }, []);\r\n \r\n \r\n   const { location, loading } = useLocation();\r\n+  const [copied, setCopied] = useState(false);\r\n   const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n   const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n   const [notes, setNotes] = useState(\"\");\r\n   const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n"
                },
                {
                    "date": 1762387404005,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -217,8 +217,17 @@\n \r\n     tryOnce();\r\n   }\r\n \r\n+  const handleCopy = async () => {\r\n+    const n = paymentInfo?.driverPayment?.number;\r\n+    if (!n) return;\r\n+\r\n+    await Clipboard.setStringAsync(n);\r\n+    setCopied(true);\r\n+    setTimeout(() => setCopied(false), 2000);\r\n+  };\r\n+\r\n   function roundByZoom(value: number, zoom: number) {\r\n     const decimals =\r\n       zoom >= 18 ? 3 :\r\n       zoom >= 16 ? 3 :\r\n"
                },
                {
                    "date": 1762387434228,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2061,11 +2061,9 @@\n                             </Text>\r\n                           </View>\r\n                           <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n                             <TouchableOpacity\r\n-                              onPress={() => {\r\n-                                const n = paymentInfo.driverPayment!.number!;\r\n-                              }}\r\n+                              onPress={() => {handleCopy}}\r\n                             >\r\n                               <Text>\r\n                                 Number:{\" \"}\r\n                                 <Text style={{ fontWeight: \"600\" }}>\r\n"
                },
                {
                    "date": 1762387528526,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2060,18 +2060,18 @@\n                               </Text>\r\n                             </Text>\r\n                           </View>\r\n                           <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n-                            <TouchableOpacity\r\n-                              onPress={() => {handleCopy}}\r\n-                            >\r\n+                            <TouchableOpacity onPress={handleCopy}>\r\n                               <Text>\r\n-                                Number:{\" \"}\r\n-                                <Text style={{ fontWeight: \"600\" }}>\r\n-                                  {paymentInfo.driverPayment.number}\r\n+                                Number:{' '}\r\n+                                <Text style={{ fontWeight: '600' }}>\r\n+                                  {paymentInfo.driverPayment?.number}\r\n                                 </Text>\r\n                               </Text>\r\n-                              <Text style={{ fontSize: 12, color: \"#666\" }}>(tap to copy)</Text>\r\n+                              <Text style={{ fontSize: 12, color: copied ? 'green' : '#666' }}>\r\n+                                {copied ? '‚úî Copied to clipboard' : 'Tap to copy'}\r\n+                              </Text>\r\n                             </TouchableOpacity>\r\n                             <TouchableOpacity\r\n                               onPress={() =>\r\n                                 bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n"
                },
                {
                    "date": 1762387571447,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2067,9 +2067,9 @@\n                                 <Text style={{ fontWeight: '600' }}>\r\n                                   {paymentInfo.driverPayment?.number}\r\n                                 </Text>\r\n                               </Text>\r\n-                              <Text style={{ fontSize: 12, color: copied ? 'green' : '#666' }}>\r\n+                              <Text style={{ fontSize: 12, color: copied ? '#81C3E1' : '#666' }}>\r\n                                 {copied ? '‚úî Copied to clipboard' : 'Tap to copy'}\r\n                               </Text>\r\n                             </TouchableOpacity>\r\n                             <TouchableOpacity\r\n"
                },
                {
                    "date": 1762387628425,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1986,9 +1986,9 @@\n                         ) : null}\r\n                         <View style={{ flex: 1 }}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                          <Text>Franchise #: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Franchise: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n \r\n                           \r\n                         </View>\r\n"
                },
                {
                    "date": 1762387636802,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1986,9 +1986,9 @@\n                         ) : null}\r\n                         <View style={{ flex: 1 }}>\r\n                           <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n                           <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                          <Text>Franchise: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Franchise No.: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n                           <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n \r\n                           \r\n                         </View>\r\n"
                },
                {
                    "date": 1762424715890,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1455,9 +1455,9 @@\n     }\r\n   };\r\n \r\n \r\n-  if (loading || !location) return null;\r\n+  const gate = loading || !location;\r\n \r\n   const handleBookNow = async () => {\r\n     if (!location || !destination) {\r\n       Alert.alert(\"Missing location info\");\r\n"
                },
                {
                    "date": 1762524461663,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,2419 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, \r\n+  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n+  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n+  Keyboard, Image, BackHandler, ScrollView, AppState, Linking  } from \"react-native\";\r\n+import { Picker } from \"@react-native-picker/picker\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import ChatNotice from \"../../components/ChatNotice\";\r\n+import { useNavigation } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+import * as IntentLauncher from 'expo-intent-launcher';\r\n+import { useFocusEffect } from '@react-navigation/native';\r\n+import * as Clipboard from 'expo-clipboard';\r\n+\r\n+\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync(); // ensures we have a real file on device\r\n+  const uri = asset.localUri || asset.uri; // localUri preferred\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),          \r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n+\r\n+  const BASE_FARE = 20;   \r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;      \r\n+\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+\r\n+  // 20% discount for senior/student/PWD\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+\r\n+  return Math.round(fare); \r\n+};\r\n+\r\n+async function ensureLocationEnabled() {\r\n+  const services = await Location.hasServicesEnabledAsync();\r\n+  const perm = await Location.getForegroundPermissionsAsync();\r\n+\r\n+  if (!services || perm.status !== 'granted') {\r\n+    Alert.alert(\r\n+      \"Enable Location\",\r\n+      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n+      [\r\n+        { text: \"Cancel\", style: \"cancel\" },\r\n+        {\r\n+          text: \"Open Settings\",\r\n+          onPress: () => {\r\n+            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n+            else Linking.openURL('app-settings:');\r\n+          }\r\n+        }\r\n+      ]\r\n+    );\r\n+    return false;\r\n+  }\r\n+  return true;\r\n+}\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+export default function PHome() {\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+\r\n+        // 2) fallback to legacy key (keeps old screens working)\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) {\r\n+          setPassengerId(legacy);\r\n+          return;\r\n+        }\r\n+\r\n+        // 3) no id ‚Üí force re-login\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  const { location, loading } = useLocation();\r\n+  const [copied, setCopied] = useState(false);\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+  const [matchedDriver, setMatchedDriver] = useState<{\r\n+    driverName: string;\r\n+    driverId: string;\r\n+    franchiseNumber: string;\r\n+    experienceYears: string;\r\n+    selfieImage: string;\r\n+    location: { latitude: number; longitude: number };\r\n+  } | null>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+  const [showReportModal, setShowReportModal] = useState(false);\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+  const [discount] = useState<DiscountType>('none'); \r\n+  const [query, setQuery] = useState('');\r\n+  const navigation = useNavigation();\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n+  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n+  const driverId = currentBooking?.driverId;\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+  const inflightRef  = useRef<Set<string>>(new Set());\r\n+  const lastReqIdRef = useRef(0);\r\n+  const [showPOIs, setShowPOIs] = useState(false);\r\n+  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n+  // --- Booking type + party size ---\r\n+  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n+  const [partySize, setPartySize] = useState<number>(2);\r\n+  const userMarkerOkRef = useRef(false);\r\n+  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n+  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n+  const routeFramedRef = useRef(false);\r\n+  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n+  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteAtRef   = useRef(0);\r\n+\r\n+  const ROUTE_MIN_MOVE_M   = 35;   // recompute if user moved >= 35 m\r\n+  const ROUTE_MIN_INTERVAL = 8000; // or every 8s, whichever comes first\r\n+\r\n+  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n+\r\n+\r\n+  function ensureUserMarker(lat: number, lng: number) {\r\n+    let attempts = 0;\r\n+    userMarkerOkRef.current = false;\r\n+\r\n+    const tryOnce = () => {\r\n+      attempts += 1;\r\n+      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n+\r\n+      if (!userMarkerOkRef.current && attempts < 6) {\r\n+        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n+      }\r\n+    };\r\n+\r\n+    tryOnce();\r\n+  }\r\n+\r\n+  const handleCopy = async () => {\r\n+    const n = paymentInfo?.driverPayment?.number;\r\n+    if (!n) return;\r\n+\r\n+    await Clipboard.setStringAsync(n);\r\n+    setCopied(true);\r\n+    setTimeout(() => setCopied(false), 2000);\r\n+  };\r\n+\r\n+  function roundByZoom(value: number, zoom: number) {\r\n+    const decimals =\r\n+      zoom >= 18 ? 3 :\r\n+      zoom >= 16 ? 3 :\r\n+      zoom >= 15 ? 2 :\r\n+      /* <=14 */   2;\r\n+    const m = Math.pow(10, decimals);\r\n+    return Math.round(value * m) / m;\r\n+  }\r\n+\r\n+\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1)); \r\n+  }\r\n+\r\n+\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) {\r\n+      messageQueue.current.push(json);\r\n+      return;\r\n+    }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapReady || !iconData) return;\r\n+    sendToMap({ type: 'preloadIcons', icons: iconData });\r\n+  }, [mapReady, iconData]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapReady, location]);\r\n+\r\n+  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n+\r\n+  // call on mount\r\n+  useEffect(() => { ensureLocationEnabled(); }, []);\r\n+\r\n+  // call on resume\r\n+  useEffect(() => {\r\n+    const sub = AppState.addEventListener('change', (s) => {\r\n+      if (s === 'active') ensureLocationEnabled();\r\n+    });\r\n+    return () => sub.remove();\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    if (!destination || !location) return;\r\n+\r\n+    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n+\r\n+    if (lastRouteDestKeyRef.current !== destKey) {\r\n+      fetchORSRoute(location, destination, true); \r\n+      routeFramedRef.current = true;\r\n+      lastRouteDestKeyRef.current = destKey;\r\n+      lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n+    }\r\n+  }, [destination, location]);\r\n+\r\n+  const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n+\r\n+  // ---------- ORS: fetch route and draw in WebView ----------\r\n+  const routeReqIdRef = useRef(0);\r\n+\r\n+  const [paymentInfo, setPaymentInfo] = useState<{\r\n+    paymentMethod?: string;\r\n+    paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\";\r\n+    driverPayment?: { number?: string; qrUrl?: string|null };\r\n+  } | null>(null);\r\n+\r\n+  const loadPaymentInfo = async (id: string) => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo({\r\n+        paymentMethod: j.paymentMethod,\r\n+        paymentStatus: j.paymentStatus,\r\n+        driverPayment: j.driverPayment || {},\r\n+      });\r\n+    } catch {}\r\n+  };\r\n+\r\n+  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\":\"application/json\" },\r\n+        body: JSON.stringify({ status }),\r\n+      });\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n+    } catch {}\r\n+  };\r\n+\r\n+\r\n+\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to:   { latitude: number; longitude: number },\r\n+    reframe: boolean = false         // <-- NEW\r\n+  ) => {\r\n+    const myReqId = ++routeReqIdRef.current;\r\n+\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({\r\n+          start: [from.longitude, from.latitude],\r\n+          end:   [to.longitude,   to.latitude],\r\n+        }),\r\n+      });\r\n+\r\n+      const data = await res.json();\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n+      if (myReqId !== routeReqIdRef.current) return; \r\n+\r\n+      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n+\r\n+      const summary    = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM  = summary.distance ?? 0;\r\n+      const durationS  = summary.duration ?? 0;\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins         = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n+\r\n+      const computedFare = calculateFare(distanceKm, discount);\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm,\r\n+        distanceText,\r\n+        durationText,\r\n+        fareText: `‚Ç±${computedFare} est`,\r\n+        reframe,                        \r\n+      });\r\n+    } catch {}\r\n+  };\r\n+\r\n+\r\n+\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      if (!location) { setHits([]); return; }\r\n+\r\n+      try {\r\n+        const lat = location.latitude;\r\n+        const lng = location.longitude; // NOTE: lng\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch {\r\n+        setHits([]);\r\n+      }\r\n+    }, 300);\r\n+  };\r\n+\r\n+\r\n+\r\n+  // When a user taps a suggestion\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label);\r\n+    setHits([]);\r\n+\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+\r\n+    // update UI\r\n+    setDestination(dest);\r\n+    setDropoffName(p.label);\r\n+\r\n+    // ‚úÖ make sure we actually have current location\r\n+    if (!location) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+      return;\r\n+    }\r\n+\r\n+    // draw route immediately\r\n+    lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n+    lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n+    lastRouteAtRef.current   = Date.now();\r\n+    fetchORSRoute(\r\n+      { latitude: location.latitude, longitude: location.longitude },\r\n+      dest,\r\n+      true\r\n+    );\r\n+\r\n+    // (optional) update markers\r\n+    sendToMap({\r\n+      type: 'setMarkers',\r\n+      destination: dest,\r\n+      driver: null,\r\n+    });\r\n+  };\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return setAvatarUrl(fallback);\r\n+\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const img =\r\n+          j?.passenger?.profileImage ||\r\n+          j?.passenger?.selfieImage ||\r\n+          j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch {\r\n+        setAvatarUrl(fallback);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  const destinationRef = useRef<typeof destination>(null);\r\n+  useEffect(() => { destinationRef.current = destination; }, [destination]);\r\n+\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+\r\n+      if (location && mapRef.current) {\r\n+        mapRef.current.postMessage(JSON.stringify({\r\n+          type: \"updateUserLoc\",\r\n+          latitude: location.latitude,\r\n+          longitude: location.longitude,\r\n+          accuracy: 15,\r\n+          avatarUrl,\r\n+        }));\r\n+        ensureUserMarker(location.latitude, location.longitude);\r\n+      }\r\n+\r\n+      sub = await Location.watchPositionAsync(\r\n+        {\r\n+          accuracy: Location.Accuracy.Balanced,\r\n+          timeInterval: 5000,\r\n+          distanceInterval: 5,\r\n+        },\r\n+        (pos) => {\r\n+          const { latitude, longitude, accuracy } = pos.coords;\r\n+\r\n+          setLivePos({ latitude, longitude });\r\n+          sendToMap({\r\n+            type: \"updateUserLoc\",\r\n+            latitude,\r\n+            longitude,\r\n+            accuracy: accuracy ?? 15,\r\n+            avatarUrl,\r\n+          });\r\n+          sendToMap({\r\n+            type: \"nudgeRouteStart\",\r\n+            latitude,\r\n+            longitude,\r\n+          });\r\n+\r\n+\r\n+          // ‚úÖ Recompute route without reframe\r\n+          const dest = destinationRef.current;\r\n+          if (dest) {\r\n+            const fromLL = { lat: latitude, lng: longitude };\r\n+            const toLL   = { lat: dest.latitude, lng: dest.longitude };\r\n+\r\n+            const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n+            const now = Date.now();\r\n+            const shouldRecompute =\r\n+              movedM >= ROUTE_MIN_MOVE_M ||\r\n+              (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+\r\n+            if (shouldRecompute) {\r\n+              fetchORSRoute(\r\n+                { latitude, longitude },\r\n+                dest,\r\n+                false // <-- no reframe on live updates\r\n+              );\r\n+              lastRouteFromRef.current = fromLL;\r\n+              lastRouteToRef.current   = toLL;\r\n+              lastRouteAtRef.current   = now;\r\n+            }\r\n+          }\r\n+\r\n+          if (accuracy && accuracy > 80) return;\r\n+        }\r\n+      );\r\n+    })();\r\n+\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl]); \r\n+\r\n+  \r\n+\r\n+\r\n+  useEffect(() => {\r\n+    let headSub: Location.LocationSubscription | null = null;\r\n+\r\n+    (async () => {\r\n+      try {\r\n+        headSub = await Location.watchHeadingAsync((h) => {\r\n+          const bearing =\r\n+            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n+            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n+          if (bearing !== null) {\r\n+            sendToMap({\r\n+              type: \"updateHeading\",\r\n+              bearingDeg: bearing,\r\n+            });\r\n+          }\r\n+        });\r\n+      } catch {\r\n+        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n+      }\r\n+    })();\r\n+\r\n+    return () => headSub?.remove();\r\n+  }, []);\r\n+\r\n+\r\n+\r\n+\r\n+  // ---------------------------------------------------------\r\n+\r\n+  // Reverse geocode for pick-up location\r\n+  useEffect(() => {\r\n+    if (location) {\r\n+      Location.reverseGeocodeAsync({\r\n+        latitude: location.latitude,\r\n+        longitude: location.longitude,\r\n+      }).then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(\r\n+            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n+          );\r\n+        } else {\r\n+          setPickupName(\"Current Location\");\r\n+        }\r\n+      }).catch(() => setPickupName(\"Current Location\"));\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  \r\n+  useEffect(() => {\r\n+    if (mapReady && location) {\r\n+      ensureUserMarker(location.latitude, location.longitude);\r\n+    }\r\n+  }, [mapHtml, location]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!livePos) return;\r\n+    console.log(\"LIVE POS ‚Üí\", livePos.latitude, livePos.longitude);\r\n+  }, [livePos]);\r\n+\r\n+\r\n+  // Handle Android hardware back button (logout prompt)\r\n+  // useEffect(() => {\r\n+  //   const backAction = () => {\r\n+  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n+  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n+  //       {\r\n+  //         text: \"Logout\",\r\n+  //         onPress: async () => {\r\n+  //           await AsyncStorage.removeItem(\"passengerId\");\r\n+  //           router.replace(\"/login_and_reg/plogin\");\r\n+  //         },\r\n+  //       },\r\n+  //     ]);\r\n+  //     return true;\r\n+  //   };\r\n+  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n+  //   return () => backHandler.remove();\r\n+  // }, []);\r\n+\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!passengerId) return;\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n+        const j = await r.json();\r\n+        const path: string | undefined =\r\n+          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n+        if (path) {\r\n+          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n+        } else {\r\n+          setAvatarUrl(null); // no image, still show blue dot\r\n+        }\r\n+      } catch {\r\n+        setAvatarUrl(null);\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+\r\n+  // Generate map HTML when location changes\r\n+  useEffect(() => {\r\n+  if (!location || mapHtml) return;\r\n+\r\n+  // lock the very first location for the initial setView\r\n+  if (!initialLocRef.current) {\r\n+    initialLocRef.current = {\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+    };\r\n+  }\r\n+\r\n+  const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n+  const iconJson = JSON.stringify(iconData || {});\r\n+\r\n+  const html = String.raw`\r\n+  <!DOCTYPE html>\r\n+  <html>\r\n+    <head>\r\n+      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+      <style>\r\n+        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n+        .distance-label.leaflet-tooltip{\r\n+          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n+          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n+          font-size:12px;line-height:1;white-space:nowrap;\r\n+        }\r\n+        .distance-label.leaflet-tooltip:before{ display:none; }\r\n+      </style>\r\n+    </head>\r\n+    <body>\r\n+      <div id=\"map\"></div>\r\n+      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+      <script>\r\n+        if (!window.L) {\r\n+          window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'error', msg:'Leaflet failed to load' }));\r\n+        }\r\n+        // --- Map init ---\r\n+        const map = L.map('map', {\r\n+          zoomControl: true,\r\n+          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n+          maxBoundsViscosity: 0.5,\r\n+          minZoom: 13,\r\n+          maxZoom: 19, \r\n+          noWrap: true\r\n+        }).setView([${initLat}, ${initLng}], 15);\r\n+\r\n+\r\n+        L.tileLayer('https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=7yQg8w68otDEssrPk9wU', {\r\n+          maxZoom: 19,\r\n+          attribution: '¬© <a href=\"https://www.openstreetmap.org/\">OpenStreetMap</a> contributors | ¬© <a href=\"https://www.maptiler.com/\">MapTiler</a>'\r\n+        }).addTo(map);\r\n+\r\n+        // --- State ---\r\n+        let userMarker = null;       // blue marker for passenger\r\n+        let destMarker = null;       // green dot\r\n+        let driverMarker = null;     // car icon\r\n+        let destinationLocked = false;\r\n+\r\n+        let routeLine = null;        // drawn polyline\r\n+        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n+\r\n+        let poiLayer = L.layerGroup().addTo(map);\r\n+        let landmarkLayer = L.layerGroup().addTo(map);\r\n+        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n+        let userMarkerPlaced = false; // <‚Äî NEW\r\n+\r\n+        let tweenHandle = null;\r\n+        function tweenMarkerTo(lat, lng, durationMs = 300) {\r\n+          if (!userMarker) return upsertUserMarker(lat, lng);\r\n+          if (tweenHandle) cancelAnimationFrame(tweenHandle);\r\n+\r\n+          const start = userMarker.getLatLng();\r\n+          const end = L.latLng(lat, lng);\r\n+          const t0 = performance.now();\r\n+\r\n+          const step = (t) => {\r\n+            const p = Math.min(1, (t - t0) / durationMs);\r\n+            const latI = start.lat + (end.lat - start.lat) * p;\r\n+            const lngI = start.lng + (end.lng - start.lng) * p;\r\n+            userMarker.setLatLng([latI, lngI]);\r\n+            if (p < 1) tweenHandle = requestAnimationFrame(step);\r\n+          };\r\n+          tweenHandle = requestAnimationFrame(step);\r\n+        }\r\n+\r\n+        function upsertUserMarker(lat, lng){\r\n+          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+          if (!userMarker){\r\n+            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n+              .addTo(map)\r\n+              .bindTooltip({ permanent:true, direction:\"top\" });\r\n+          } else {\r\n+            userMarker.setLatLng([lat,lng]);\r\n+          }\r\n+          userMarkerPlaced = true; \r\n+        }\r\n+\r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        const poiMarkers = new Map();        // id -> L.Marker\r\n+        const iconCache  = {};               // category -> L.Icon\r\n+        let poiBatchHandle = null;           // cancel previous batch\r\n+\r\n+        function getPoiIcon(cat, poiIcons) {\r\n+          if (iconCache[cat]) return iconCache[cat];\r\n+\r\n+          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n+            ? poiIcons[cat]\r\n+            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n+\r\n+          iconCache[cat] = L.icon({\r\n+            iconUrl: url,\r\n+            iconSize: [28, 28],\r\n+            iconAnchor: [14, 28],\r\n+          });\r\n+          return iconCache[cat];\r\n+        }\r\n+\r\n+        function addOrUpdatePOIMarker(it, poiIcons) {\r\n+          const existing = poiMarkers.get(it.id);\r\n+          if (existing) {\r\n+            // update position if it changed\r\n+            const curr = existing.getLatLng();\r\n+            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n+              existing.setLatLng([it.lat, it.lng]);\r\n+            }\r\n+            return;\r\n+          }\r\n+          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n+          const marker = L.marker([it.lat, it.lng], { icon });\r\n+\r\n+          // build popup with \"Set Destination\"\r\n+          const container = document.createElement('div');\r\n+          const title = document.createElement('b');\r\n+          title.textContent = it.name || it.category || 'POI';\r\n+          container.appendChild(title);\r\n+          container.appendChild(document.createElement('br'));\r\n+          const btn = document.createElement('button');\r\n+          btn.textContent = 'Set Destination';\r\n+          btn.style.marginTop = '6px';\r\n+          btn.onclick = function () {\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'setDestinationFromPOI',\r\n+              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+            }));\r\n+          };\r\n+          container.appendChild(btn);\r\n+          marker.bindPopup(container);\r\n+\r\n+          marker.addTo(poiLayer);\r\n+          poiMarkers.set(it.id, marker);\r\n+        }\r\n+        \r\n+        function bboxContains(b, lat, lng) {\r\n+          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n+        }\r\n+\r\n+        // --- Icons ---\r\n+        const userIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30], // bottom center\r\n+        });\r\n+\r\n+        const destIcon = L.icon({\r\n+          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n+          iconSize: [30, 30],\r\n+          iconAnchor: [15, 30],\r\n+        });\r\n+\r\n+        const carIcon = L.icon({\r\n+          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n+          iconSize: [40, 40],\r\n+          iconAnchor: [20, 40],\r\n+        });\r\n+\r\n+        function setDestination(lat, lng){\r\n+          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n+          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n+            .addTo(map)\r\n+            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n+        }\r\n+\r\n+        function setDriver(lat, lng){\r\n+          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n+          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n+            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n+              .addTo(map)\r\n+              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n+              .setZIndexOffset(1100);\r\n+          }\r\n+        }\r\n+\r\n+        function clearRoute(){\r\n+          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n+          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n+        }\r\n+\r\n+        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n+        map.on('click', function(e){\r\n+          if (destinationLocked) return;\r\n+          const { lat, lng } = e.latlng;\r\n+          setDestination(lat, lng);\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n+        });\r\n+\r\n+        (function sendInitialBBox(){\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        })();\r\n+\r\n+        map.on('moveend', function () {\r\n+          const b = map.getBounds();\r\n+          const c = map.getCenter();\r\n+          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+            type: 'bbox',\r\n+            bbox: {\r\n+              minLng: b.getWest(), minLat: b.getSouth(),\r\n+              maxLng: b.getEast(), maxLat: b.getNorth()\r\n+            },\r\n+            zoom: map.getZoom(),\r\n+            center: { lat: c.lat, lng: c.lng }\r\n+          }));\r\n+        });\r\n+\r\n+\r\n+        // --- Message bridge ---\r\n+        document.addEventListener('message', function(event){\r\n+          let msg = {};\r\n+          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n+\r\n+          if (msg.type === 'ensureUserMarker') {\r\n+            const lat = Number(msg.latitude);\r\n+            const lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n+              upsertUserMarker(lat, lng);\r\n+            }\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'userMarkerEnsured',\r\n+              placed: !!userMarker,\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          // Live passenger location (blue marker only)\r\n+          if (msg.type === 'updateUserLoc'){\r\n+            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n+            if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n+            return;\r\n+          }\r\n+\r\n+          // Keep route line's head glued to the moving CL marker\r\n+          if (msg.type === 'nudgeRouteStart') {\r\n+            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n+\r\n+            // Debug: tell RN what we have\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'dbg',\r\n+              tag: 'nudgeRouteStart',\r\n+              lat, lng,\r\n+              hasRoute: !!routeLine\r\n+            }));\r\n+\r\n+            // No route drawn yet? Nothing to nudge\r\n+            if (!routeLine || !Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n+\r\n+            // Update the first vertex of the current polyline\r\n+            let pts = routeLine.getLatLngs(); // may be LatLng[] or LatLng[][] if multi\r\n+            if (!Array.isArray(pts) || !pts.length) return;\r\n+\r\n+            // If this is a multi-polyline, take the first segment\r\n+            if (Array.isArray(pts[0]) && pts[0].length) {\r\n+              pts = pts[0];\r\n+            }\r\n+\r\n+            pts[0] = L.latLng(lat, lng);\r\n+            routeLine.setLatLngs(pts);\r\n+\r\n+            if (pts.length > 1) {\r\n+              const p1 = pts[0], p2 = pts[1];\r\n+              const mid = L.latLng(\r\n+                p1.lat + (p2.lat - p1.lat) * 0.15,\r\n+                p1.lng + (p2.lng - p1.lng) * 0.15\r\n+              );\r\n+              routeLine.setLatLngs([p1, mid, ...pts.slice(1)]);\r\n+            }\r\n+\r\n+\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'nudgeAck',\r\n+              ok: true\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+            \r\n+          // Heading intentionally ignored (no cone)\r\n+          if (msg.type === 'updateHeading'){ return; }\r\n+\r\n+          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n+          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n+            clearRoute();\r\n+            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n+\r\n+            if (msg.reframe) {\r\n+              map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n+            }\r\n+\r\n+            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n+            const label = [msg.distanceText, msg.durationText, msg.fareText]\r\n+              .filter(Boolean).join(' ‚Ä¢ ');\r\n+            distanceTooltip = L.tooltip({\r\n+              permanent:true, direction:'top', offset:[0,-6], className:'distance-label'\r\n+            }).setContent(label || '').setLatLng(mid).addTo(map);\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+          // Clear route\r\n+          if (msg.type === 'clearRoute'){\r\n+            clearRoute();\r\n+            return;\r\n+          }\r\n+\r\n+          // Driver + Destination markers\r\n+          if (msg.type === 'setMarkers'){\r\n+            destinationLocked = !!msg.driver;\r\n+\r\n+            // destination\r\n+            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n+              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n+            } else if (destMarker){\r\n+              map.removeLayer(destMarker); destMarker = null;\r\n+            }\r\n+\r\n+            // driver\r\n+            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n+              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n+            } else if (driverMarker){\r\n+              map.removeLayer(driverMarker); driverMarker = null;\r\n+            }\r\n+\r\n+            return;\r\n+          }\r\n+\r\n+          if (msg.type === 'requestBbox') {\r\n+            const b = map.getBounds();\r\n+            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+              type: 'bbox',\r\n+              bbox: {\r\n+                minLng: b.getWest(),\r\n+                minLat: b.getSouth(),\r\n+                maxLng: b.getEast(),\r\n+                maxLat: b.getNorth()\r\n+              },\r\n+              zoom: map.getZoom()\r\n+            }));\r\n+            return;\r\n+          }\r\n+\r\n+          const poiIcons = ${iconJson};\r\n+          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n+            if (poiBatchHandle) {\r\n+              cancelAnimationFrame(poiBatchHandle);\r\n+              poiBatchHandle = null;\r\n+            }\r\n+\r\n+            const z = Number(msg.zoom) || currentZoomLevel;\r\n+            const b = msg.bbox || null;\r\n+\r\n+            // Collect desired items from payload\r\n+            const desired = new Map();\r\n+            for (const it of msg.items) {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n+              desired.set(it.id, it);\r\n+            }\r\n+            const desiredIds = new Set(desired.keys());\r\n+\r\n+            // Decide strategy based on zoom direction\r\n+            if (z > currentZoomLevel) {\r\n+              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n+              if (b) {\r\n+                for (const [id, marker] of poiMarkers) {\r\n+                  const p = marker.getLatLng();\r\n+                  if (!bboxContains(b, p.lat, p.lng)) {\r\n+                    poiLayer.removeLayer(marker);\r\n+                    poiMarkers.delete(id);\r\n+                  }\r\n+                }\r\n+              }\r\n+            } else if (z < currentZoomLevel) {\r\n+              // ---- ZOOM OUT: shrink to what backend sent\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const keep = desiredIds.has(id);\r\n+                const p = marker.getLatLng();\r\n+                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n+                if (!keep || !onScreen) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            } else {\r\n+              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n+              for (const [id, marker] of poiMarkers) {\r\n+                const p = marker.getLatLng();\r\n+                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n+                if (drop) {\r\n+                  poiLayer.removeLayer(marker);\r\n+                  poiMarkers.delete(id);\r\n+                }\r\n+              }\r\n+            }\r\n+\r\n+            // Build list of new ones to add\r\n+            const toAdd = [];\r\n+            for (const [id, it] of desired) {\r\n+              if (!poiMarkers.has(id)) toAdd.push(it);\r\n+            }\r\n+\r\n+            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n+            const total = toAdd.length;\r\n+            const BATCH =\r\n+              total > 300 ? 80 :\r\n+              total > 150 ? 50 :\r\n+              total > 60  ? 35 :\r\n+              25; // small = faster draw\r\n+            const DELAY = total > 150 ? 20 : 10;\r\n+\r\n+            const poiIcons = ${JSON.stringify(iconData || {})};\r\n+\r\n+            let i = 0;\r\n+            const addBatch = () => {\r\n+              const end = Math.min(i + BATCH, total);\r\n+              for (; i < end; i++) {\r\n+                const it = toAdd[i];\r\n+                const icon = getPoiIcon(it.category, poiIcons);\r\n+                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n+\r\n+                const container = document.createElement('div');\r\n+                const title = document.createElement('b');\r\n+                title.textContent = it.name || it.category || 'POI';\r\n+                container.appendChild(title);\r\n+                container.appendChild(document.createElement('br'));\r\n+\r\n+                const btn = document.createElement('button');\r\n+                btn.textContent = 'Set Destination';\r\n+                btn.style.marginTop = '6px';\r\n+                btn.onclick = function () {\r\n+                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n+                    type: 'setDestinationFromPOI',\r\n+                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n+                  }));\r\n+                };\r\n+                container.appendChild(btn);\r\n+\r\n+                marker.bindPopup(container);\r\n+                marker.addTo(poiLayer);\r\n+                poiMarkers.set(it.id, marker);\r\n+\r\n+                // üî• Fade-in animation\r\n+                let op = 0;\r\n+                const fade = () => {\r\n+                  op += 0.15;\r\n+                  if (op <= 1) {\r\n+                    marker.setOpacity(op);\r\n+                    requestAnimationFrame(fade);\r\n+                  } else {\r\n+                    marker.setOpacity(1);\r\n+                  }\r\n+                };\r\n+                requestAnimationFrame(fade);\r\n+              }\r\n+\r\n+              if (i < total) {\r\n+                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n+              } else {\r\n+                poiBatchHandle = null;\r\n+              }\r\n+            };\r\n+\r\n+\r\n+            addBatch();\r\n+\r\n+            currentZoomLevel = z;\r\n+            return;\r\n+          }\r\n+\r\n+\r\n+\r\n+\r\n+\r\n+          // Render Landmarks (pin markers)\r\n+          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n+            landmarkLayer.clearLayers();\r\n+            msg.items.forEach(it => {\r\n+              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n+              L.marker([it.lat, it.lng])\r\n+                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n+                .addTo(landmarkLayer);\r\n+            });\r\n+            return;\r\n+          }\r\n+          if (msg.type === 'clearLandmarks') {\r\n+            landmarkLayer.clearLayers();\r\n+            return;\r\n+          }\r\n+        });\r\n+      </script>\r\n+    </body>\r\n+  </html>\r\n+  `;\r\n+  setMapHtml(html);\r\n+  }, [mapHtml, location]);  \r\n+\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!mapRef.current || !location) return;\r\n+\r\n+    // üîµ Update passenger marker live\r\n+    mapRef.current.postMessage(JSON.stringify({\r\n+      type: \"updateUserLoc\",\r\n+      latitude: location.latitude,\r\n+      longitude: location.longitude,\r\n+      accuracy: 15,\r\n+      avatarUrl,\r\n+    }));\r\n+\r\n+    // üß≠ Recompute route occasionally (no zoom)\r\n+    const now = Date.now();\r\n+    if (destination) {\r\n+      const fromLL = { lat: location.latitude, lng: location.longitude };\r\n+      const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n+\r\n+      const movedM = haversine(\r\n+        lastRouteFromRef.current ?? fromLL,\r\n+        fromLL\r\n+      );\r\n+\r\n+      const shouldRecompute =\r\n+        movedM >= ROUTE_MIN_MOVE_M ||\r\n+        (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+\r\n+      if (shouldRecompute) {\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          destination,\r\n+          false // ‚ö†Ô∏è never reframe on live updates\r\n+        );\r\n+        lastRouteFromRef.current = fromLL;\r\n+        lastRouteToRef.current   = toLL;\r\n+        lastRouteAtRef.current   = now;\r\n+      }\r\n+    }\r\n+  }, [location, avatarUrl, destination]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    if (!initialLocRef.current && location) {\r\n+      initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n+    }\r\n+  }, [location]);\r\n+\r\n+  useEffect(() => {\r\n+    console.log(\"[PHome] HTML built once?\", !!mapHtml);\r\n+  }, [mapHtml]);\r\n+\r\n+  useEffect(() => {\r\n+    console.log('[PHome] guards:',\r\n+      'hasLocation=', !!location,\r\n+      'hasIconData=', !!iconData,\r\n+      'hasMapHtml=', !!mapHtml\r\n+    );\r\n+  }, [location, iconData, mapHtml]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!destination || !location || !routeFramedRef.current) return;\r\n+\r\n+    const now = { lat: location.latitude, lng: location.longitude };\r\n+    const moved = lastOriginRef.current ? haversine(lastOriginRef.current, now) : Infinity;\r\n+\r\n+    if (moved > 150) {                 // tweak threshold as you like\r\n+      fetchORSRoute(location, destination, false); \r\n+      lastOriginRef.current = now;\r\n+    }\r\n+  }, [location, destination]);\r\n+\r\n+\r\n+  \r\n+\r\n+\r\n+\r\n+\r\n+  // Reverse geocode for drop-off location\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      // Always see what's coming in:\r\n+      if (parsed.latitude && parsed.longitude) {\r\n+        setDestination(parsed);\r\n+        try {\r\n+          const results = await Location.reverseGeocodeAsync({\r\n+            latitude: parsed.latitude, longitude: parsed.longitude,\r\n+          });\r\n+          if (results && results.length > 0) {\r\n+            const addr = results[0];\r\n+            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+          } else {\r\n+            setDropoffName(\"Selected Location\");\r\n+          }\r\n+        } catch {\r\n+          setDropoffName(\"Selected Location\");\r\n+        }\r\n+      }\r\n+\r\n+      if (parsed.type === 'dbg' && parsed.tag === 'nudgeRouteStart') {\r\n+        console.log('[MAP] nudge dbg:', parsed);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'nudgeAck') {\r\n+        console.log('[MAP] nudgeAck ok=', parsed.ok);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'userMarkerEnsured') {\r\n+        userMarkerOkRef.current = !!parsed.placed;\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n+        const zoom = Number(parsed.zoom) || 0;\r\n+        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n+        if (!showPOIs || zoom < 14) {\r\n+          sendToMap({ type: 'setPOIs', items: [] });\r\n+          return;\r\n+        };\r\n+\r\n+        const center = parsed.center;\r\n+        if (center && lastCenterRef.current) {\r\n+          const moved = haversine(lastCenterRef.current, center);\r\n+          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n+        }\r\n+        if (center) lastCenterRef.current = center;\r\n+\r\n+        const key = [\r\n+          zoom,\r\n+          roundByZoom(minLng, zoom),\r\n+          roundByZoom(minLat, zoom),\r\n+          roundByZoom(maxLng, zoom),\r\n+          roundByZoom(maxLat, zoom),\r\n+        ].join('|');\r\n+\r\n+        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n+        lastPoiKeyRef.current = key;\r\n+\r\n+        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+        poiFetchTimerRef.current = setTimeout(async () => {\r\n+          try {\r\n+            const qs: string[] = [\r\n+              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+              `zoom=${zoom}`,\r\n+            ];\r\n+            if (center?.lat != null && center?.lng != null) {\r\n+              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+            }\r\n+            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+            if (poiCacheRef.current.has(key)) {\r\n+              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n+              return;\r\n+            }\r\n+\r\n+            if (inflightRef.current.has(key)) {\r\n+              return;\r\n+            }\r\n+\r\n+            inflightRef.current.add(key);\r\n+\r\n+            const reqId = ++lastReqIdRef.current;\r\n+            \r\n+            try {\r\n+              const qs: string[] = [\r\n+                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n+                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n+                `zoom=${zoom}`,\r\n+              ];\r\n+              if (center?.lat != null && center?.lng != null) {\r\n+                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n+              }\r\n+              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n+\r\n+              const r = await fetch(url);\r\n+              const items = await r.json();\r\n+\r\n+              if (reqId !== lastReqIdRef.current) {\r\n+                return; // a newer request finished after this one\r\n+              }\r\n+\r\n+              if (Array.isArray(items)) {\r\n+                poiCacheRef.current.set(key, items);\r\n+                sendToMap({ type: 'setPOIs', items });\r\n+              } else {\r\n+                sendToMap({ type: 'setPOIs', items: [] });\r\n+              }\r\n+            } catch (e) {\r\n+              console.log('[ERR] POI fetch failed for', key, e);\r\n+              sendToMap({ type: 'setPOIs', items: [] });\r\n+            } finally {\r\n+              inflightRef.current.delete(key);\r\n+            }\r\n+            const r = await fetch(url);\r\n+            const items = await r.json();\r\n+            if (Array.isArray(items)) {\r\n+              poiCacheRef.current.set(key, items);\r\n+              sendToMap({\r\n+                type: 'setPOIs',\r\n+                items,\r\n+                zoom,                       \r\n+                bbox: { minLng, minLat, maxLng, maxLat },  \r\n+              });\r\n+            }\r\n+\r\n+          } catch {\r\n+            sendToMap({ type: 'setPOIs', items: [] });\r\n+          }\r\n+        }, 500);\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'setDestinationFromPOI') {\r\n+        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n+        setDestination(dest);\r\n+        setDropoffName(parsed.label || 'POI Destination');\r\n+\r\n+        if (!location) {\r\n+          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n+          return;\r\n+        }\r\n+        const { latitude, longitude } = location;\r\n+\r\n+        lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n+        lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n+        lastRouteAtRef.current   = Date.now();\r\n+\r\n+        fetchORSRoute(\r\n+          { latitude: location.latitude, longitude: location.longitude },\r\n+          dest\r\n+        );\r\n+        sendToMap({\r\n+          type: 'setMarkers',\r\n+          destination: dest,\r\n+          driver: null,\r\n+        });\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+    // Set markers & trigger route drawing when destination is picked\r\n+  // useEffect(() => {\r\n+  //   if (!mapRef.current || bookingConfirmed) return;\r\n+\r\n+  //   const driverCoords = matchedDriver?.location\r\n+  //     ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n+  //     : null;\r\n+\r\n+  //   if (driverCoords && destination) {\r\n+  //     mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n+  //   }\r\n+\r\n+  //   // üëâ draw route as soon as we have both ends\r\n+  //   if (destination && location) {\r\n+  //     fetchORSRoute(location, destination);\r\n+  //   }\r\n+  // }, [destination, matchedDriver, bookingConfirmed, location]);\r\n+\r\n+  const loadLandmarks = async () => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n+      const items = await r.json();\r\n+      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n+    } catch {\r\n+      sendToMap({ type: 'setLandmarks', items: [] });\r\n+    }\r\n+  };\r\n+\r\n+\r\n+  const gate = loading || !location;\r\n+\r\n+  const handleBookNow = async () => {\r\n+    if (!location || !destination) {\r\n+      Alert.alert(\"Missing location info\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+\r\n+    // Normalize party size based on type\r\n+    const normalizedParty =\r\n+      bookingType === 'GROUP'\r\n+        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n+        : 1; // CLASSIC & SOLO always 1\r\n+\r\n+    setSearching(true);\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: location.latitude,\r\n+      pickupLng: location.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId,\r\n+      pickupPlace: pickupName,\r\n+      destinationPlace: dropoffName,\r\n+      bookingType,\r\n+      partySize: normalizedParty,\r\n+    };\r\n+    console.log(bookingData);\r\n+\r\n+    try {\r\n+      // reset any old polling\r\n+      if (searchTimeoutRef.current) {\r\n+        clearTimeout(searchTimeoutRef.current);\r\n+        searchTimeoutRef.current = null;\r\n+      }\r\n+\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  // {status === \"accepted\" && bookingId && (\r\n+  //   <ChatNotice\r\n+  //     bookingId={bookingId}\r\n+  //     role=\"passenger\"\r\n+  //     onGoToChat={() =>\r\n+  //       router.push({\r\n+  //         pathname: \"/chatcomponent\",\r\n+  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n+  //       })\r\n+  //     }\r\n+  //   />\r\n+  // )}\r\n+\r\n+  \r\n+  \r\n+\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    const saveDriverId = async () => {\r\n+      if (matchedDriver && bookingId) {\r\n+        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n+        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n+      }\r\n+    };\r\n+    saveDriverId();\r\n+  }, [matchedDriver, bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+\r\n+        if (!myBooking) return;\r\n+\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+          if (bookingId) loadPaymentInfo(String(bookingId));\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  useEffect(() => {\r\n+    if (!bookingId || !bookingConfirmed) return;\r\n+    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n+    return () => clearInterval(t);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+\r\n+        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // üîß reset session so user can book again\r\n+          setSearching(false);                                     // <-- key line\r\n+          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n+            clearTimeout(searchTimeoutRef.current);\r\n+            searchTimeoutRef.current = null;\r\n+          }\r\n+\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setShowBookingForm(false);\r\n+          setTripCompleted(true);\r\n+\r\n+          // optional: tidy UI state\r\n+          setQuery('');\r\n+          setHits([]);\r\n+\r\n+          // clear saved ‚Äúsearching:true‚Äù from storage\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+\r\n+          // clear map\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+\r\n+          setFare(0);\r\n+        }\r\n+\r\n+      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n+\r\n+  useEffect(() => {\r\n+    const loadBookingState = async () => {\r\n+      try {\r\n+        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n+        if (savedState) {\r\n+          const s = JSON.parse(savedState);\r\n+          if (s.destination) setDestination(s.destination);\r\n+          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n+          if (s.notes) setNotes(s.notes);\r\n+          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n+          if (s.fare) setFare(s.fare);\r\n+          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n+          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n+          if (s.bookingId) setBookingId(s.bookingId);\r\n+          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n+          if (s.searching) setSearching(s.searching);\r\n+        }\r\n+      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n+    };\r\n+    loadBookingState();\r\n+  }, []);\r\n+\r\n+\r\n+  const cancelRideNow = async () => {\r\n+    try {\r\n+      if (!bookingId) {\r\n+        return;\r\n+      }\r\n+\r\n+      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ bookingId }),\r\n+      });\r\n+      const body = await resp.text();\r\n+\r\n+      // UI reset after server confirms\r\n+      setSearching(false);\r\n+      setBookingId(null);\r\n+      setMatchedDriver(null);\r\n+      setBookingConfirmed(false);\r\n+      setDestination(null);\r\n+      setTripCompleted(false);\r\n+      setAlertedBookingComplete(false);\r\n+      setShowBookingForm(false);\r\n+\r\n+      // Clear map + cached state\r\n+      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+      sendToMap({ type: \"clearRoute\" });\r\n+      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+      setFare(0);\r\n+    } catch (e) {\r\n+      console.log(\"[PHOME] cancel error\", e);\r\n+      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n+    }\r\n+  };\r\n+\r\n+\r\n+\r\n+  const submitDriverRating = async () => {\r\n+    try {\r\n+      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+      if (!driverIdToRate || !bookingIdToRate) {\r\n+        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n+        return;\r\n+      }\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+      });\r\n+\r\n+      if (res.ok && notes) {\r\n+        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+          method: \"POST\",\r\n+          headers: { \"Content-Type\": \"application/json\" },\r\n+          body: JSON.stringify({\r\n+            bookingId: bookingIdToRate,\r\n+            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n+            driverId: driverIdToRate,\r\n+            feedback: notes,\r\n+          }),\r\n+        });\r\n+      }\r\n+\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+        setShowRatingModal(false);\r\n+        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit rating:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n+\r\n+  const submitReport = async () => {\r\n+    try {\r\n+      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n+      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({\r\n+          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n+        }),\r\n+      });\r\n+      if (res.ok) {\r\n+        Alert.alert(\"Success\", \"Report submitted!\");\r\n+        setShowReportModal(false);\r\n+      } else {\r\n+        const data = await res.json();\r\n+        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n+      }\r\n+    } catch (error) {\r\n+      console.error(\"‚ùå Failed to submit report:\", error);\r\n+      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n+    if (!raw) return null;\r\n+\r\n+    // If it's already an absolute URL (Cloudinary, etc.)\r\n+    if (/^https?:\\/\\//i.test(raw)) {\r\n+      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n+    }\r\n+\r\n+    // Else treat as relative path served by your backend\r\n+    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n+    const path = String(raw).replace(/^\\//, \"\"); // strip leading slash if any\r\n+    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+    return `${base}/${path}?v=${v}`;\r\n+  };\r\n+\r\n+  const driverSelfieUri = React.useMemo(() => {\r\n+    if (!matchedDriver?.selfieImage) return null;\r\n+\r\n+    // Use a stable version key if you have one; NEVER Date.now()\r\n+    const ver =\r\n+      (matchedDriver as any)?.updatedAt ||\r\n+      (matchedDriver as any)?.selfieUpdatedAt ||\r\n+      matchedDriver?.driverId || // last resort: driverId keeps it stable\r\n+      1;\r\n+\r\n+    return buildImageUri(matchedDriver.selfieImage, ver);\r\n+  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n+\r\n+\r\n+\r\n+    \r\n+\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              allowFileAccess\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              mixedContentMode=\"always\"\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          <View style={styles.searchcont}>\r\n+            {/* Destination search */}\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity\r\n+                      key={`${h.lat},${h.lng}-${i}`}\r\n+                      onPress={() => choosePlace(h)}\r\n+                      style={styles.searchItem}\r\n+                    >\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showLandmarks) {\r\n+                  sendToMap({ type: 'clearLandmarks' });\r\n+                  setShowLandmarks(false);\r\n+                } else {\r\n+                  loadLandmarks(); // same function we made before\r\n+                  setShowLandmarks(true);\r\n+                }\r\n+              }}\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n+            </TouchableOpacity>\r\n+            <TouchableOpacity\r\n+              onPress={() => {\r\n+                if (showPOIs) {\r\n+                  setShowPOIs(false);\r\n+                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                  sendToMap({ type: 'setPOIs', items: [] });\r\n+                } else {\r\n+                  setShowPOIs(true);\r\n+                  const b = lastBBoxRef.current;\r\n+                  if (b) {\r\n+                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n+                    if (zoom >= 14) {\r\n+                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n+                      poiFetchTimerRef.current = setTimeout(async () => {\r\n+                        try {\r\n+                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n+                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n+                          const r = await fetch(url);\r\n+                          const items = await r.json();\r\n+                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n+                        } catch {\r\n+                          sendToMap({ type: 'setPOIs', items: [] });\r\n+                        }\r\n+                      }, 0);\r\n+                    } else {\r\n+                      sendToMap({ type: 'setPOIs', items: [] });\r\n+                    }\r\n+                  } else {\r\n+                    sendToMap({ type: 'requestBbox' });\r\n+                  }\r\n+                }\r\n+              }}\r\n+\r\n+              style={{\r\n+                alignSelf: 'center',\r\n+                marginTop: 6,\r\n+                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n+                paddingHorizontal: 10,\r\n+                paddingVertical: 6,\r\n+                borderRadius: 8\r\n+              }}\r\n+            >\r\n+              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n+            </TouchableOpacity>\r\n+\r\n+\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>\r\n+                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n+                  </Text>\r\n+                  <TouchableOpacity\r\n+                    onPress={cancelRideNow}\r\n+                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n+                  >\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              \r\n+\r\n+              {matchedDriver && (\r\n+                <View\r\n+                  style={{\r\n+                    position: \"absolute\",\r\n+                    bottom: -100,\r\n+                    left: 0,\r\n+                    right: 0,\r\n+                    marginHorizontal: 20,\r\n+                    backgroundColor: \"#d1fcd3\",\r\n+                    borderRadius: 10,\r\n+                    padding: 10,\r\n+                    elevation: 3,\r\n+                  }}\r\n+                >\r\n+                  {!infoBoxMinimized ? (\r\n+                    <>\r\n+                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                        {driverSelfieUri ? (\r\n+                          <Image\r\n+                            source={{ uri: driverSelfieUri }}\r\n+                            style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n+                            resizeMode=\"cover\"\r\n+                          />\r\n+                        ) : null}\r\n+                        <View style={{ flex: 1 }}>\r\n+                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                          <Text>Name: {matchedDriver?.driverName}</Text>\r\n+                          <Text>Franchise No.: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n+                          <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n+\r\n+                          \r\n+                        </View>\r\n+                      </View>\r\n+\r\n+                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10, gap: 10 }}>\r\n+                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                            onPress={() => {\r\n+                              router.push({\r\n+                                pathname: \"/ChatRoom\",\r\n+                                params: {\r\n+                                  bookingId,\r\n+                                  driverId: matchedDriver?.driverId,\r\n+                                  passengerId,\r\n+                                  role: \"passenger\",\r\n+                                },\r\n+                              });\r\n+                            }}\r\n+                            style={{ backgroundColor: \"#007bff\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n+                          >\r\n+                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n+                          </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"white\" }}>Report</Text>\r\n+                        </TouchableOpacity>\r\n+\r\n+                        <TouchableOpacity\r\n+                          onPress={async () => {\r\n+                            try {\r\n+                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+                                method: \"POST\",\r\n+                                headers: { \"Content-Type\": \"application/json\" },\r\n+                                body: JSON.stringify({ bookingId }),\r\n+                              });\r\n+                              const body = await resp.text();\r\n+\r\n+                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+                            } catch (e) {\r\n+                              console.log(\"[PHOME] cancel error\", e);\r\n+                            }\r\n+                            setSearching(false);\r\n+                            setBookingId(null);\r\n+                            setMatchedDriver(null);\r\n+                            setDestination(null);\r\n+                            setBookingConfirmed(false);\r\n+                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+                            sendToMap({ type: \"clearRoute\" });\r\n+                            setFare(0);\r\n+                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n+                          }}\r\n+                          style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n+                        >\r\n+                          <Text style={{ color: \"white\" }}>Cancel</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                      {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n+                        <View style={{paddingTop:5}}>\r\n+                          <View style={{flexDirection:\"row\", justifyContent:\"space-between\"}}>\r\n+                            <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+                            <Text>\r\n+                              Status:{\" \"}\r\n+                              <Text style={{ fontWeight: \"700\" }}>\r\n+                                {paymentInfo?.paymentStatus || \"none\"}\r\n+                              </Text>\r\n+                            </Text>\r\n+                          </View>\r\n+                          <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n+                            <TouchableOpacity onPress={handleCopy}>\r\n+                              <Text>\r\n+                                Number:{' '}\r\n+                                <Text style={{ fontWeight: '600' }}>\r\n+                                  {paymentInfo.driverPayment?.number}\r\n+                                </Text>\r\n+                              </Text>\r\n+                              <Text style={{ fontSize: 12, color: copied ? '#81C3E1' : '#666' }}>\r\n+                                {copied ? '‚úî Copied to clipboard' : 'Tap to copy'}\r\n+                              </Text>\r\n+                            </TouchableOpacity>\r\n+                            <TouchableOpacity\r\n+                              onPress={() =>\r\n+                                bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n+                              }\r\n+                              disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n+                              style={{\r\n+                                backgroundColor:\r\n+                                  paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n+                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5\r\n+                              }}\r\n+                            >\r\n+                              <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n+                                {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n+                              </Text>\r\n+                            </TouchableOpacity>\r\n+                          </View>\r\n+                        </View>\r\n+                      )}\r\n+                    </>\r\n+                  ) : (\r\n+                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n+                    </TouchableOpacity>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+\r\n+                {/* Booking Type Selector */}\r\n+                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n+                  {[\r\n+                    { key: 'CLASSIC', label: 'Classic' },\r\n+                    { key: 'GROUP', label: 'Group' },\r\n+                    { key: 'SOLO', label: 'Solo' },\r\n+                  ].map((opt) => {\r\n+                    const active = bookingType === (opt.key as any);\r\n+                    return (\r\n+                      <TouchableOpacity\r\n+                        key={opt.key}\r\n+                        onPress={() => {\r\n+                          setBookingType(opt.key as any);\r\n+                          if (opt.key !== 'GROUP') setPartySize(2);\r\n+                        }}\r\n+                        style={{\r\n+                          flex: 1,\r\n+                          backgroundColor: active ? '#111' : '#fff',\r\n+                          borderWidth: 1,\r\n+                          borderColor: active ? '#111' : '#ccc',\r\n+                          paddingVertical: 10,\r\n+                          borderRadius: 10,\r\n+                          alignItems: 'center',\r\n+                        }}\r\n+                      >\r\n+                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n+                          {opt.label}\r\n+                        </Text>\r\n+                      </TouchableOpacity>\r\n+                    );\r\n+                  })}\r\n+                </View>\r\n+\r\n+                {/* Notes for Solo & Group */}\r\n+                {bookingType === 'SOLO' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n+                  </Text>\r\n+                )}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n+                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n+                  </Text>\r\n+                )}\r\n+\r\n+                {/* Group Party Size Stepper */}\r\n+                {bookingType === 'GROUP' && (\r\n+                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n+                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n+                      </TouchableOpacity>\r\n+                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n+                      <TouchableOpacity\r\n+                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n+                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n+                      >\r\n+                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n+                      </TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+                )}\r\n+\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <Text>From:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n+                  <Text>To:</Text>\r\n+                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n+                  {/* <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n+                    value={destinationLabel}\r\n+                    onChangeText={setDestinationLabel}\r\n+                  /> */}\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n+                  <Text>Paano ka magbabayad?</Text>\r\n+                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n+                    <TouchableOpacity\r\n+                      onPress={() => setPaymentMethod(\"Cash\")}\r\n+                      style={[\r\n+                        styles.paymentOption,\r\n+                        paymentMethod === \"Cash\" && styles.paymentSelected\r\n+                      ]}\r\n+                    >\r\n+                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n+                    </TouchableOpacity>\r\n+\r\n+                    <TouchableOpacity\r\n+                      onPress={() => setPaymentMethod(\"GCash\")}\r\n+                      style={[\r\n+                        styles.paymentOption,\r\n+                        paymentMethod === \"GCash\" && styles.paymentSelected\r\n+                      ]}\r\n+                    >\r\n+                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n+                    </TouchableOpacity>\r\n+                  </View>\r\n+\r\n+                </ScrollView>\r\n+\r\n+                <View style={styles.fareContainer}>\r\n+                  <View>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Fare:\r\n+                    </Text>\r\n+                    <Text style={{ paddingLeft: 20 }}>\r\n+                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n+                    </Text>\r\n+                    <Text style={styles.totalFare}>\r\n+                      Total Fare: ‚Ç±\r\n+                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n+                    </Text>\r\n+                  </View>\r\n+                  <TouchableOpacity\r\n+                    style={[\r\n+                      styles.bookButton,\r\n+                      // disable if invalid group count or no destination\r\n+                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n+                    ]}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n+                    onPress={handleBookNow}\r\n+                  >\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity\r\n+                onPress={() => setShowBookingForm(true)}\r\n+                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n+              >\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1, 2, 3, 4, 5].map((star) => (\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {showReportModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+\r\n+                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n+\r\n+                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n+                  <View style={styles.dropdownContainer}>\r\n+                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n+                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n+                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n+                    </TouchableOpacity>\r\n+\r\n+                    {showDropdown && (\r\n+                      <View style={styles.dropdownMenu}>\r\n+                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n+                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n+                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n+                          </TouchableOpacity>\r\n+                        ))}\r\n+                      </View>\r\n+                    )}\r\n+                  </View>\r\n+\r\n+                  {reportType === \"Other\" && (\r\n+                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n+                  )}\r\n+\r\n+                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n+                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+\r\n+            \r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n+  searchWrap: {\r\n+    width: '90%',\r\n+    alignSelf: 'center',\r\n+    zIndex: 20,            // stay above map\r\n+  },\r\n+  searchInput: {\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    padding: 10,\r\n+  },\r\n+  searchResults: {\r\n+    marginTop: 4,\r\n+    backgroundColor: '#FFF',\r\n+    borderRadius: 10,\r\n+    borderWidth: 1,\r\n+    borderColor: '#ddd',\r\n+    maxHeight: 200,\r\n+    overflow: 'hidden',\r\n+  },\r\n+  searchItem: {\r\n+    paddingVertical: 10,\r\n+    paddingHorizontal: 12,\r\n+    borderBottomWidth: 1,\r\n+    borderBottomColor: '#eee',\r\n+  },\r\n+  searchItemText: {\r\n+    color: '#111',\r\n+  },\r\n+\r\n+  panel: {\r\n+    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n+    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n+  },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n+  ratingModalOverlay: {\r\n+    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n+    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n+  },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n+  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n+  dropdownButton: {\r\n+    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n+    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n+  },\r\n+  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n+  dropdownItem: { padding: 10 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+  bottomNav: {\r\n+    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n+    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n+    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n+  },\r\n+\r\n+  paymentOption: {\r\n+    flex: 1,\r\n+    borderWidth: 1,\r\n+    borderColor: \"#ccc\",\r\n+    paddingVertical: 6,\r\n+    borderRadius: 10,\r\n+    alignItems: \"center\",\r\n+    marginHorizontal: 5,\r\n+    backgroundColor: \"#fff\",\r\n+  },\r\n+  paymentSelected: {\r\n+    backgroundColor: \"#000\",\r\n+    borderColor: \"#333\",\r\n+  },\r\n+  paymentText: {\r\n+    color: \"#333\",\r\n+    fontWeight: \"600\",\r\n+  },\r\n+  paymentSelectedText: {\r\n+    color: \"#fff\",\r\n+    fontWeight: \"700\",\r\n+  },\r\n+\r\n+  \r\n+});\r\n"
                },
                {
                    "date": 1762524463364,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2416,2422 +2416,4 @@\n   },\r\n \r\n   \r\n });\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, \r\n-  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n-  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n-  Keyboard, Image, BackHandler, ScrollView, AppState, Linking  } from \"react-native\";\r\n-import { Picker } from \"@react-native-picker/picker\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL, MAPTILER_KEY } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import ChatNotice from \"../../components/ChatNotice\";\r\n-import { useNavigation } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-import * as IntentLauncher from 'expo-intent-launcher';\r\n-import { useFocusEffect } from '@react-navigation/native';\r\n-import * as Clipboard from 'expo-clipboard';\r\n-\r\n-\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync(); // ensures we have a real file on device\r\n-  const uri = asset.localUri || asset.uri; // localUri preferred\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),          \r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0; \r\n-\r\n-  const BASE_FARE = 20;   \r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;      \r\n-\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-\r\n-  // 20% discount for senior/student/PWD\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-\r\n-  return Math.round(fare); \r\n-};\r\n-\r\n-async function ensureLocationEnabled() {\r\n-  const services = await Location.hasServicesEnabledAsync();\r\n-  const perm = await Location.getForegroundPermissionsAsync();\r\n-\r\n-  if (!services || perm.status !== 'granted') {\r\n-    Alert.alert(\r\n-      \"Enable Location\",\r\n-      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n-      [\r\n-        { text: \"Cancel\", style: \"cancel\" },\r\n-        {\r\n-          text: \"Open Settings\",\r\n-          onPress: () => {\r\n-            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n-            else Linking.openURL('app-settings:');\r\n-          }\r\n-        }\r\n-      ]\r\n-    );\r\n-    return false;\r\n-  }\r\n-  return true;\r\n-}\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-export default function PHome() {\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-\r\n-        // 2) fallback to legacy key (keeps old screens working)\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) {\r\n-          setPassengerId(legacy);\r\n-          return;\r\n-        }\r\n-\r\n-        // 3) no id ‚Üí force re-login\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  const { location, loading } = useLocation();\r\n-  const [copied, setCopied] = useState(false);\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-  const [matchedDriver, setMatchedDriver] = useState<{\r\n-    driverName: string;\r\n-    driverId: string;\r\n-    franchiseNumber: string;\r\n-    experienceYears: string;\r\n-    selfieImage: string;\r\n-    location: { latitude: number; longitude: number };\r\n-  } | null>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [infoBoxMinimized, setInfoBoxMinimized] = useState(false);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-  const [showReportModal, setShowReportModal] = useState(false);\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-  const [discount] = useState<DiscountType>('none'); \r\n-  const [query, setQuery] = useState('');\r\n-  const navigation = useNavigation();\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-  const [currentBooking, setCurrentBooking] = useState<any>(null);\r\n-  const status = currentBooking?.status as 'accepted' | 'pending' | 'completed' | 'canceled' | undefined;\r\n-  const driverId = currentBooking?.driverId;\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-  const inflightRef  = useRef<Set<string>>(new Set());\r\n-  const lastReqIdRef = useRef(0);\r\n-  const [showPOIs, setShowPOIs] = useState(false);\r\n-  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n-  // --- Booking type + party size ---\r\n-  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n-  const [partySize, setPartySize] = useState<number>(2);\r\n-  const userMarkerOkRef = useRef(false);\r\n-  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n-  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n-  const routeFramedRef = useRef(false);\r\n-  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n-  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteAtRef   = useRef(0);\r\n-\r\n-  const ROUTE_MIN_MOVE_M   = 35;   // recompute if user moved >= 35 m\r\n-  const ROUTE_MIN_INTERVAL = 8000; // or every 8s, whichever comes first\r\n-\r\n-  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n-\r\n-\r\n-  function ensureUserMarker(lat: number, lng: number) {\r\n-    let attempts = 0;\r\n-    userMarkerOkRef.current = false;\r\n-\r\n-    const tryOnce = () => {\r\n-      attempts += 1;\r\n-      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n-\r\n-      if (!userMarkerOkRef.current && attempts < 6) {\r\n-        setTimeout(tryOnce, 400);  // retry every 400ms up to ~2s\r\n-      }\r\n-    };\r\n-\r\n-    tryOnce();\r\n-  }\r\n-\r\n-  const handleCopy = async () => {\r\n-    const n = paymentInfo?.driverPayment?.number;\r\n-    if (!n) return;\r\n-\r\n-    await Clipboard.setStringAsync(n);\r\n-    setCopied(true);\r\n-    setTimeout(() => setCopied(false), 2000);\r\n-  };\r\n-\r\n-  function roundByZoom(value: number, zoom: number) {\r\n-    const decimals =\r\n-      zoom >= 18 ? 3 :\r\n-      zoom >= 16 ? 3 :\r\n-      zoom >= 15 ? 2 :\r\n-      /* <=14 */   2;\r\n-    const m = Math.pow(10, decimals);\r\n-    return Math.round(value * m) / m;\r\n-  }\r\n-\r\n-\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1)); \r\n-  }\r\n-\r\n-\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) {\r\n-      messageQueue.current.push(json);\r\n-      return;\r\n-    }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapReady || !iconData) return;\r\n-    sendToMap({ type: 'preloadIcons', icons: iconData });\r\n-  }, [mapReady, iconData]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapReady, location]);\r\n-\r\n-  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n-\r\n-  // call on mount\r\n-  useEffect(() => { ensureLocationEnabled(); }, []);\r\n-\r\n-  // call on resume\r\n-  useEffect(() => {\r\n-    const sub = AppState.addEventListener('change', (s) => {\r\n-      if (s === 'active') ensureLocationEnabled();\r\n-    });\r\n-    return () => sub.remove();\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    if (!destination || !location) return;\r\n-\r\n-    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n-\r\n-    if (lastRouteDestKeyRef.current !== destKey) {\r\n-      fetchORSRoute(location, destination, true); \r\n-      routeFramedRef.current = true;\r\n-      lastRouteDestKeyRef.current = destKey;\r\n-      lastOriginRef.current = { lat: location.latitude, lng: location.longitude };\r\n-    }\r\n-  }, [destination, location]);\r\n-\r\n-  const canShowChatNotice = bookingConfirmed && !!bookingId && !!matchedDriver?.driverId && !!passengerId;\r\n-\r\n-  // ---------- ORS: fetch route and draw in WebView ----------\r\n-  const routeReqIdRef = useRef(0);\r\n-\r\n-  const [paymentInfo, setPaymentInfo] = useState<{\r\n-    paymentMethod?: string;\r\n-    paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\";\r\n-    driverPayment?: { number?: string; qrUrl?: string|null };\r\n-  } | null>(null);\r\n-\r\n-  const loadPaymentInfo = async (id: string) => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n-      const j = await r.json();\r\n-      if (j?.ok) setPaymentInfo({\r\n-        paymentMethod: j.paymentMethod,\r\n-        paymentStatus: j.paymentStatus,\r\n-        driverPayment: j.driverPayment || {},\r\n-      });\r\n-    } catch {}\r\n-  };\r\n-\r\n-  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\":\"application/json\" },\r\n-        body: JSON.stringify({ status }),\r\n-      });\r\n-      const j = await r.json();\r\n-      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n-    } catch {}\r\n-  };\r\n-\r\n-\r\n-\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to:   { latitude: number; longitude: number },\r\n-    reframe: boolean = false         // <-- NEW\r\n-  ) => {\r\n-    const myReqId = ++routeReqIdRef.current;\r\n-\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({\r\n-          start: [from.longitude, from.latitude],\r\n-          end:   [to.longitude,   to.latitude],\r\n-        }),\r\n-      });\r\n-\r\n-      const data = await res.json();\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n-      if (myReqId !== routeReqIdRef.current) return; \r\n-\r\n-      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n-\r\n-      const summary    = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM  = summary.distance ?? 0;\r\n-      const durationS  = summary.duration ?? 0;\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins         = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n-\r\n-      const computedFare = calculateFare(distanceKm, discount);\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm,\r\n-        distanceText,\r\n-        durationText,\r\n-        fareText: `‚Ç±${computedFare} est`,\r\n-        reframe,                        \r\n-      });\r\n-    } catch {}\r\n-  };\r\n-\r\n-\r\n-\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      if (!location) { setHits([]); return; }\r\n-\r\n-      try {\r\n-        const lat = location.latitude;\r\n-        const lng = location.longitude; // NOTE: lng\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch {\r\n-        setHits([]);\r\n-      }\r\n-    }, 300);\r\n-  };\r\n-\r\n-\r\n-\r\n-  // When a user taps a suggestion\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label);\r\n-    setHits([]);\r\n-\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-\r\n-    // update UI\r\n-    setDestination(dest);\r\n-    setDropoffName(p.label);\r\n-\r\n-    // ‚úÖ make sure we actually have current location\r\n-    if (!location) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-      return;\r\n-    }\r\n-\r\n-    // draw route immediately\r\n-    lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n-    lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n-    lastRouteAtRef.current   = Date.now();\r\n-    fetchORSRoute(\r\n-      { latitude: location.latitude, longitude: location.longitude },\r\n-      dest,\r\n-      true\r\n-    );\r\n-\r\n-    // (optional) update markers\r\n-    sendToMap({\r\n-      type: 'setMarkers',\r\n-      destination: dest,\r\n-      driver: null,\r\n-    });\r\n-  };\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\"; // simple silhouette\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return setAvatarUrl(fallback);\r\n-\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const img =\r\n-          j?.passenger?.profileImage ||\r\n-          j?.passenger?.selfieImage ||\r\n-          j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch {\r\n-        setAvatarUrl(fallback);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  const destinationRef = useRef<typeof destination>(null);\r\n-  useEffect(() => { destinationRef.current = destination; }, [destination]);\r\n-\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-\r\n-      if (location && mapRef.current) {\r\n-        mapRef.current.postMessage(JSON.stringify({\r\n-          type: \"updateUserLoc\",\r\n-          latitude: location.latitude,\r\n-          longitude: location.longitude,\r\n-          accuracy: 15,\r\n-          avatarUrl,\r\n-        }));\r\n-        ensureUserMarker(location.latitude, location.longitude);\r\n-      }\r\n-\r\n-      sub = await Location.watchPositionAsync(\r\n-        {\r\n-          accuracy: Location.Accuracy.Balanced,\r\n-          timeInterval: 5000,\r\n-          distanceInterval: 5,\r\n-        },\r\n-        (pos) => {\r\n-          const { latitude, longitude, accuracy } = pos.coords;\r\n-\r\n-          setLivePos({ latitude, longitude });\r\n-          sendToMap({\r\n-            type: \"updateUserLoc\",\r\n-            latitude,\r\n-            longitude,\r\n-            accuracy: accuracy ?? 15,\r\n-            avatarUrl,\r\n-          });\r\n-          sendToMap({\r\n-            type: \"nudgeRouteStart\",\r\n-            latitude,\r\n-            longitude,\r\n-          });\r\n-\r\n-\r\n-          // ‚úÖ Recompute route without reframe\r\n-          const dest = destinationRef.current;\r\n-          if (dest) {\r\n-            const fromLL = { lat: latitude, lng: longitude };\r\n-            const toLL   = { lat: dest.latitude, lng: dest.longitude };\r\n-\r\n-            const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n-            const now = Date.now();\r\n-            const shouldRecompute =\r\n-              movedM >= ROUTE_MIN_MOVE_M ||\r\n-              (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n-\r\n-            if (shouldRecompute) {\r\n-              fetchORSRoute(\r\n-                { latitude, longitude },\r\n-                dest,\r\n-                false // <-- no reframe on live updates\r\n-              );\r\n-              lastRouteFromRef.current = fromLL;\r\n-              lastRouteToRef.current   = toLL;\r\n-              lastRouteAtRef.current   = now;\r\n-            }\r\n-          }\r\n-\r\n-          if (accuracy && accuracy > 80) return;\r\n-        }\r\n-      );\r\n-    })();\r\n-\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl]); \r\n-\r\n-  \r\n-\r\n-\r\n-  useEffect(() => {\r\n-    let headSub: Location.LocationSubscription | null = null;\r\n-\r\n-    (async () => {\r\n-      try {\r\n-        headSub = await Location.watchHeadingAsync((h) => {\r\n-          const bearing =\r\n-            Number.isFinite(h.trueHeading) ? h.trueHeading :\r\n-            (Number.isFinite(h.magHeading) ? h.magHeading : null);\r\n-          if (bearing !== null) {\r\n-            sendToMap({\r\n-              type: \"updateHeading\",\r\n-              bearingDeg: bearing,\r\n-            });\r\n-          }\r\n-        });\r\n-      } catch {\r\n-        // If heading isn‚Äôt available (some devices), we simply won‚Äôt show the cone.\r\n-      }\r\n-    })();\r\n-\r\n-    return () => headSub?.remove();\r\n-  }, []);\r\n-\r\n-\r\n-\r\n-\r\n-  // ---------------------------------------------------------\r\n-\r\n-  // Reverse geocode for pick-up location\r\n-  useEffect(() => {\r\n-    if (location) {\r\n-      Location.reverseGeocodeAsync({\r\n-        latitude: location.latitude,\r\n-        longitude: location.longitude,\r\n-      }).then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(\r\n-            `${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`\r\n-          );\r\n-        } else {\r\n-          setPickupName(\"Current Location\");\r\n-        }\r\n-      }).catch(() => setPickupName(\"Current Location\"));\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  \r\n-  useEffect(() => {\r\n-    if (mapReady && location) {\r\n-      ensureUserMarker(location.latitude, location.longitude);\r\n-    }\r\n-  }, [mapHtml, location]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!livePos) return;\r\n-    console.log(\"LIVE POS ‚Üí\", livePos.latitude, livePos.longitude);\r\n-  }, [livePos]);\r\n-\r\n-\r\n-  // Handle Android hardware back button (logout prompt)\r\n-  // useEffect(() => {\r\n-  //   const backAction = () => {\r\n-  //     Alert.alert(\"Logout Confirmation\", \"Do you want to log out?\", [\r\n-  //       { text: \"Cancel\", onPress: () => null, style: \"cancel\" },\r\n-  //       {\r\n-  //         text: \"Logout\",\r\n-  //         onPress: async () => {\r\n-  //           await AsyncStorage.removeItem(\"passengerId\");\r\n-  //           router.replace(\"/login_and_reg/plogin\");\r\n-  //         },\r\n-  //       },\r\n-  //     ]);\r\n-  //     return true;\r\n-  //   };\r\n-  //   const backHandler = BackHandler.addEventListener(\"hardwareBackPress\", backAction);\r\n-  //   return () => backHandler.remove();\r\n-  // }, []);\r\n-\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!passengerId) return;\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${passengerId}`);\r\n-        const j = await r.json();\r\n-        const path: string | undefined =\r\n-          j?.passenger?.selfieImage || j?.passenger?.avatarUrl;\r\n-        if (path) {\r\n-          setAvatarUrl(path.startsWith(\"http\") ? path : `${API_BASE_URL}/${path}`);\r\n-        } else {\r\n-          setAvatarUrl(null); // no image, still show blue dot\r\n-        }\r\n-      } catch {\r\n-        setAvatarUrl(null);\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-\r\n-  // Generate map HTML when location changes\r\n-  useEffect(() => {\r\n-  if (!location || mapHtml) return;\r\n-\r\n-  // lock the very first location for the initial setView\r\n-  if (!initialLocRef.current) {\r\n-    initialLocRef.current = {\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-    };\r\n-  }\r\n-\r\n-  const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n-  const iconJson = JSON.stringify(iconData || {});\r\n-\r\n-  const html = String.raw`\r\n-  <!DOCTYPE html>\r\n-  <html>\r\n-    <head>\r\n-      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-      <link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-      <style>\r\n-        html, body, #map { height: 100%; margin: 0; padding: 0; }\r\n-        .distance-label.leaflet-tooltip{\r\n-          background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;\r\n-          padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);\r\n-          font-size:12px;line-height:1;white-space:nowrap;\r\n-        }\r\n-        .distance-label.leaflet-tooltip:before{ display:none; }\r\n-      </style>\r\n-    </head>\r\n-    <body>\r\n-      <div id=\"map\"></div>\r\n-      <script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-      <script>\r\n-        if (!window.L) {\r\n-          window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'error', msg:'Leaflet failed to load' }));\r\n-        }\r\n-        // --- Map init ---\r\n-        const map = L.map('map', {\r\n-          zoomControl: true,\r\n-          maxBounds: [[13.96,121.643],[13.88,121.588]],\r\n-          maxBoundsViscosity: 0.5,\r\n-          minZoom: 13,\r\n-          maxZoom: 19, \r\n-          noWrap: true\r\n-        }).setView([${initLat}, ${initLng}], 15);\r\n-\r\n-\r\n-        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {\r\n-          maxZoom:19, attribution:'¬© OpenStreetMap contributors'\r\n-        }).addTo(map);\r\n-\r\n-        // --- State ---\r\n-        let userMarker = null;       // blue marker for passenger\r\n-        let destMarker = null;       // green dot\r\n-        let driverMarker = null;     // car icon\r\n-        let destinationLocked = false;\r\n-\r\n-        let routeLine = null;        // drawn polyline\r\n-        let distanceTooltip = null;  // route label (distance ‚Ä¢ time ‚Ä¢ fare)\r\n-\r\n-        let poiLayer = L.layerGroup().addTo(map);\r\n-        let landmarkLayer = L.layerGroup().addTo(map);\r\n-        let currentZoomLevel = map.getZoom();    // track last zoom to know in/out\r\n-        let userMarkerPlaced = false; // <‚Äî NEW\r\n-\r\n-        let tweenHandle = null;\r\n-        function tweenMarkerTo(lat, lng, durationMs = 300) {\r\n-          if (!userMarker) return upsertUserMarker(lat, lng);\r\n-          if (tweenHandle) cancelAnimationFrame(tweenHandle);\r\n-\r\n-          const start = userMarker.getLatLng();\r\n-          const end = L.latLng(lat, lng);\r\n-          const t0 = performance.now();\r\n-\r\n-          const step = (t) => {\r\n-            const p = Math.min(1, (t - t0) / durationMs);\r\n-            const latI = start.lat + (end.lat - start.lat) * p;\r\n-            const lngI = start.lng + (end.lng - start.lng) * p;\r\n-            userMarker.setLatLng([latI, lngI]);\r\n-            if (p < 1) tweenHandle = requestAnimationFrame(step);\r\n-          };\r\n-          tweenHandle = requestAnimationFrame(step);\r\n-        }\r\n-\r\n-        function upsertUserMarker(lat, lng){\r\n-          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-          if (!userMarker){\r\n-            userMarker = L.marker([lat,lng], { icon: userIcon, zIndexOffset: 1000 })\r\n-              .addTo(map)\r\n-              .bindTooltip({ permanent:true, direction:\"top\" });\r\n-          } else {\r\n-            userMarker.setLatLng([lat,lng]);\r\n-          }\r\n-          userMarkerPlaced = true; \r\n-        }\r\n-\r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        const poiMarkers = new Map();        // id -> L.Marker\r\n-        const iconCache  = {};               // category -> L.Icon\r\n-        let poiBatchHandle = null;           // cancel previous batch\r\n-\r\n-        function getPoiIcon(cat, poiIcons) {\r\n-          if (iconCache[cat]) return iconCache[cat];\r\n-\r\n-          const url = (poiIcons[cat] && poiIcons[cat].includes('base64,'))\r\n-            ? poiIcons[cat]\r\n-            : 'https://cdn-icons-png.flaticon.com/512/854/854878.png'; // fallback\r\n-\r\n-          iconCache[cat] = L.icon({\r\n-            iconUrl: url,\r\n-            iconSize: [28, 28],\r\n-            iconAnchor: [14, 28],\r\n-          });\r\n-          return iconCache[cat];\r\n-        }\r\n-\r\n-        function addOrUpdatePOIMarker(it, poiIcons) {\r\n-          const existing = poiMarkers.get(it.id);\r\n-          if (existing) {\r\n-            // update position if it changed\r\n-            const curr = existing.getLatLng();\r\n-            if (curr.lat !== it.lat || curr.lng !== it.lng) {\r\n-              existing.setLatLng([it.lat, it.lng]);\r\n-            }\r\n-            return;\r\n-          }\r\n-          const icon = getPoiIcon(it.category, poiIcons); // your cached icon getter\r\n-          const marker = L.marker([it.lat, it.lng], { icon });\r\n-\r\n-          // build popup with \"Set Destination\"\r\n-          const container = document.createElement('div');\r\n-          const title = document.createElement('b');\r\n-          title.textContent = it.name || it.category || 'POI';\r\n-          container.appendChild(title);\r\n-          container.appendChild(document.createElement('br'));\r\n-          const btn = document.createElement('button');\r\n-          btn.textContent = 'Set Destination';\r\n-          btn.style.marginTop = '6px';\r\n-          btn.onclick = function () {\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'setDestinationFromPOI',\r\n-              lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-            }));\r\n-          };\r\n-          container.appendChild(btn);\r\n-          marker.bindPopup(container);\r\n-\r\n-          marker.addTo(poiLayer);\r\n-          poiMarkers.set(it.id, marker);\r\n-        }\r\n-        \r\n-        function bboxContains(b, lat, lng) {\r\n-          return lng >= b.minLng && lng <= b.maxLng && lat >= b.minLat && lat <= b.maxLat;\r\n-        }\r\n-\r\n-        // --- Icons ---\r\n-        const userIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30], // bottom center\r\n-        });\r\n-\r\n-        const destIcon = L.icon({\r\n-          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',\r\n-          iconSize: [30, 30],\r\n-          iconAnchor: [15, 30],\r\n-        });\r\n-\r\n-        const carIcon = L.icon({\r\n-          iconUrl: 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',\r\n-          iconSize: [40, 40],\r\n-          iconAnchor: [20, 40],\r\n-        });\r\n-\r\n-        function setDestination(lat, lng){\r\n-          if (destMarker) { map.removeLayer(destMarker); destMarker = null; }\r\n-          destMarker = L.marker([lat,lng], { icon: destIcon })\r\n-            .addTo(map)\r\n-            .bindTooltip(\"Destination\", { permanent:true, direction:\"top\" });\r\n-        }\r\n-\r\n-        function setDriver(lat, lng){\r\n-          if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }\r\n-          if (Number.isFinite(lat) && Number.isFinite(lng)){\r\n-            driverMarker = L.marker([lat,lng], { icon: carIcon })\r\n-              .addTo(map)\r\n-              .bindTooltip(\"üöï Driver\", { permanent:true, direction:\"top\" })\r\n-              .setZIndexOffset(1100);\r\n-          }\r\n-        }\r\n-\r\n-        function clearRoute(){\r\n-          if (routeLine){ map.removeLayer(routeLine); routeLine = null; }\r\n-          if (distanceTooltip){ map.removeLayer(distanceTooltip); distanceTooltip = null; }\r\n-        }\r\n-\r\n-        // --- Pick destination by tapping map (when not locked by active driver) ---\r\n-        map.on('click', function(e){\r\n-          if (destinationLocked) return;\r\n-          const { lat, lng } = e.latlng;\r\n-          setDestination(lat, lng);\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({ latitude: lat, longitude: lng }));\r\n-        });\r\n-\r\n-        (function sendInitialBBox(){\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        })();\r\n-\r\n-        map.on('moveend', function () {\r\n-          const b = map.getBounds();\r\n-          const c = map.getCenter();\r\n-          window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-            type: 'bbox',\r\n-            bbox: {\r\n-              minLng: b.getWest(), minLat: b.getSouth(),\r\n-              maxLng: b.getEast(), maxLat: b.getNorth()\r\n-            },\r\n-            zoom: map.getZoom(),\r\n-            center: { lat: c.lat, lng: c.lng }\r\n-          }));\r\n-        });\r\n-\r\n-\r\n-        // --- Message bridge ---\r\n-        document.addEventListener('message', function(event){\r\n-          let msg = {};\r\n-          try { msg = JSON.parse(event.data || '{}'); } catch(e){ return; }\r\n-\r\n-          if (msg.type === 'ensureUserMarker') {\r\n-            const lat = Number(msg.latitude);\r\n-            const lng = Number(msg.longitude);\r\n-            if (Number.isFinite(lat) && Number.isFinite(lng)) {\r\n-              upsertUserMarker(lat, lng);\r\n-            }\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'userMarkerEnsured',\r\n-              placed: !!userMarker,\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-          // Live passenger location (blue marker only)\r\n-          if (msg.type === 'updateUserLoc'){\r\n-            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n-            if (Number.isFinite(lat) && Number.isFinite(lng)) tweenMarkerTo(lat, lng, 300);\r\n-            return;\r\n-          }\r\n-\r\n-          // Keep route line's head glued to the moving CL marker\r\n-          if (msg.type === 'nudgeRouteStart') {\r\n-            const lat = Number(msg.latitude), lng = Number(msg.longitude);\r\n-\r\n-            // Debug: tell RN what we have\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'dbg',\r\n-              tag: 'nudgeRouteStart',\r\n-              lat, lng,\r\n-              hasRoute: !!routeLine\r\n-            }));\r\n-\r\n-            // No route drawn yet? Nothing to nudge\r\n-            if (!routeLine || !Number.isFinite(lat) || !Number.isFinite(lng)) return;\r\n-\r\n-            // Update the first vertex of the current polyline\r\n-            let pts = routeLine.getLatLngs(); // may be LatLng[] or LatLng[][] if multi\r\n-            if (!Array.isArray(pts) || !pts.length) return;\r\n-\r\n-            // If this is a multi-polyline, take the first segment\r\n-            if (Array.isArray(pts[0]) && pts[0].length) {\r\n-              pts = pts[0];\r\n-            }\r\n-\r\n-            pts[0] = L.latLng(lat, lng);\r\n-            routeLine.setLatLngs(pts);\r\n-\r\n-            if (pts.length > 1) {\r\n-              const p1 = pts[0], p2 = pts[1];\r\n-              const mid = L.latLng(\r\n-                p1.lat + (p2.lat - p1.lat) * 0.15,\r\n-                p1.lng + (p2.lng - p1.lng) * 0.15\r\n-              );\r\n-              routeLine.setLatLngs([p1, mid, ...pts.slice(1)]);\r\n-            }\r\n-\r\n-\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'nudgeAck',\r\n-              ok: true\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-            \r\n-          // Heading intentionally ignored (no cone)\r\n-          if (msg.type === 'updateHeading'){ return; }\r\n-\r\n-          // Draw route with label (distance ‚Ä¢ duration ‚Ä¢ fare)\r\n-          if (msg.type === 'drawRoute' && Array.isArray(msg.route) && msg.route.length) {\r\n-            clearRoute();\r\n-            routeLine = L.polyline(msg.route, { weight:4, color:'#1a73e8' }).addTo(map);\r\n-\r\n-            if (msg.reframe) {\r\n-              map.fitBounds(routeLine.getBounds(), { padding:[50,50] });\r\n-            }\r\n-\r\n-            const mid = msg.route[Math.floor(msg.route.length/2)];\r\n-            const label = [msg.distanceText, msg.durationText, msg.fareText]\r\n-              .filter(Boolean).join(' ‚Ä¢ ');\r\n-            distanceTooltip = L.tooltip({\r\n-              permanent:true, direction:'top', offset:[0,-6], className:'distance-label'\r\n-            }).setContent(label || '').setLatLng(mid).addTo(map);\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-          // Clear route\r\n-          if (msg.type === 'clearRoute'){\r\n-            clearRoute();\r\n-            return;\r\n-          }\r\n-\r\n-          // Driver + Destination markers\r\n-          if (msg.type === 'setMarkers'){\r\n-            destinationLocked = !!msg.driver;\r\n-\r\n-            // destination\r\n-            if (msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)){\r\n-              setDestination(msg.destination.latitude, msg.destination.longitude);\r\n-            } else if (destMarker){\r\n-              map.removeLayer(destMarker); destMarker = null;\r\n-            }\r\n-\r\n-            // driver\r\n-            if (msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)){\r\n-              setDriver(msg.driver.latitude, msg.driver.longitude);\r\n-            } else if (driverMarker){\r\n-              map.removeLayer(driverMarker); driverMarker = null;\r\n-            }\r\n-\r\n-            return;\r\n-          }\r\n-\r\n-          if (msg.type === 'requestBbox') {\r\n-            const b = map.getBounds();\r\n-            window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-              type: 'bbox',\r\n-              bbox: {\r\n-                minLng: b.getWest(),\r\n-                minLat: b.getSouth(),\r\n-                maxLng: b.getEast(),\r\n-                maxLat: b.getNorth()\r\n-              },\r\n-              zoom: map.getZoom()\r\n-            }));\r\n-            return;\r\n-          }\r\n-\r\n-          const poiIcons = ${iconJson};\r\n-          if (msg.type === 'setPOIs' && Array.isArray(msg.items)) {\r\n-            if (poiBatchHandle) {\r\n-              cancelAnimationFrame(poiBatchHandle);\r\n-              poiBatchHandle = null;\r\n-            }\r\n-\r\n-            const z = Number(msg.zoom) || currentZoomLevel;\r\n-            const b = msg.bbox || null;\r\n-\r\n-            // Collect desired items from payload\r\n-            const desired = new Map();\r\n-            for (const it of msg.items) {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) continue;\r\n-              desired.set(it.id, it);\r\n-            }\r\n-            const desiredIds = new Set(desired.keys());\r\n-\r\n-            // Decide strategy based on zoom direction\r\n-            if (z > currentZoomLevel) {\r\n-              // ---- ZOOM IN: accumulate (add new), but prune anything far outside screen\r\n-              if (b) {\r\n-                for (const [id, marker] of poiMarkers) {\r\n-                  const p = marker.getLatLng();\r\n-                  if (!bboxContains(b, p.lat, p.lng)) {\r\n-                    poiLayer.removeLayer(marker);\r\n-                    poiMarkers.delete(id);\r\n-                  }\r\n-                }\r\n-              }\r\n-            } else if (z < currentZoomLevel) {\r\n-              // ---- ZOOM OUT: shrink to what backend sent\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const keep = desiredIds.has(id);\r\n-                const p = marker.getLatLng();\r\n-                const onScreen = !b || bboxContains(b, p.lat, p.lng);\r\n-                if (!keep || !onScreen) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            } else {\r\n-              // ---- SAME ZOOM (pan): replace by diff within current screen\r\n-              for (const [id, marker] of poiMarkers) {\r\n-                const p = marker.getLatLng();\r\n-                const drop = !desiredIds.has(id) || (b && !bboxContains(b, p.lat, p.lng));\r\n-                if (drop) {\r\n-                  poiLayer.removeLayer(marker);\r\n-                  poiMarkers.delete(id);\r\n-                }\r\n-              }\r\n-            }\r\n-\r\n-            // Build list of new ones to add\r\n-            const toAdd = [];\r\n-            for (const [id, it] of desired) {\r\n-              if (!poiMarkers.has(id)) toAdd.push(it);\r\n-            }\r\n-\r\n-            // ‚úÖ UPDATED PART: adaptive batching for smoother render\r\n-            const total = toAdd.length;\r\n-            const BATCH =\r\n-              total > 300 ? 80 :\r\n-              total > 150 ? 50 :\r\n-              total > 60  ? 35 :\r\n-              25; // small = faster draw\r\n-            const DELAY = total > 150 ? 20 : 10;\r\n-\r\n-            const poiIcons = ${JSON.stringify(iconData || {})};\r\n-\r\n-            let i = 0;\r\n-            const addBatch = () => {\r\n-              const end = Math.min(i + BATCH, total);\r\n-              for (; i < end; i++) {\r\n-                const it = toAdd[i];\r\n-                const icon = getPoiIcon(it.category, poiIcons);\r\n-                const marker = L.marker([it.lat, it.lng], { icon, opacity: 0 }); // start transparent\r\n-\r\n-                const container = document.createElement('div');\r\n-                const title = document.createElement('b');\r\n-                title.textContent = it.name || it.category || 'POI';\r\n-                container.appendChild(title);\r\n-                container.appendChild(document.createElement('br'));\r\n-\r\n-                const btn = document.createElement('button');\r\n-                btn.textContent = 'Set Destination';\r\n-                btn.style.marginTop = '6px';\r\n-                btn.onclick = function () {\r\n-                  window.ReactNativeWebView.postMessage(JSON.stringify({\r\n-                    type: 'setDestinationFromPOI',\r\n-                    lat: it.lat, lng: it.lng, label: it.name || it.category || 'POI'\r\n-                  }));\r\n-                };\r\n-                container.appendChild(btn);\r\n-\r\n-                marker.bindPopup(container);\r\n-                marker.addTo(poiLayer);\r\n-                poiMarkers.set(it.id, marker);\r\n-\r\n-                // üî• Fade-in animation\r\n-                let op = 0;\r\n-                const fade = () => {\r\n-                  op += 0.15;\r\n-                  if (op <= 1) {\r\n-                    marker.setOpacity(op);\r\n-                    requestAnimationFrame(fade);\r\n-                  } else {\r\n-                    marker.setOpacity(1);\r\n-                  }\r\n-                };\r\n-                requestAnimationFrame(fade);\r\n-              }\r\n-\r\n-              if (i < total) {\r\n-                poiBatchHandle = requestAnimationFrame(() => setTimeout(addBatch, DELAY));\r\n-              } else {\r\n-                poiBatchHandle = null;\r\n-              }\r\n-            };\r\n-\r\n-\r\n-            addBatch();\r\n-\r\n-            currentZoomLevel = z;\r\n-            return;\r\n-          }\r\n-\r\n-\r\n-\r\n-\r\n-\r\n-          // Render Landmarks (pin markers)\r\n-          if (msg.type === 'setLandmarks' && Array.isArray(msg.items)) {\r\n-            landmarkLayer.clearLayers();\r\n-            msg.items.forEach(it => {\r\n-              if (!Number.isFinite(it.lat) || !Number.isFinite(it.lng)) return;\r\n-              L.marker([it.lat, it.lng])\r\n-                .bindTooltip(it.name || 'Landmark', { direction: 'top' })\r\n-                .addTo(landmarkLayer);\r\n-            });\r\n-            return;\r\n-          }\r\n-          if (msg.type === 'clearLandmarks') {\r\n-            landmarkLayer.clearLayers();\r\n-            return;\r\n-          }\r\n-        });\r\n-      </script>\r\n-    </body>\r\n-  </html>\r\n-  `;\r\n-  setMapHtml(html);\r\n-  }, [mapHtml, location]);  \r\n-\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!mapRef.current || !location) return;\r\n-\r\n-    // üîµ Update passenger marker live\r\n-    mapRef.current.postMessage(JSON.stringify({\r\n-      type: \"updateUserLoc\",\r\n-      latitude: location.latitude,\r\n-      longitude: location.longitude,\r\n-      accuracy: 15,\r\n-      avatarUrl,\r\n-    }));\r\n-\r\n-    // üß≠ Recompute route occasionally (no zoom)\r\n-    const now = Date.now();\r\n-    if (destination) {\r\n-      const fromLL = { lat: location.latitude, lng: location.longitude };\r\n-      const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n-\r\n-      const movedM = haversine(\r\n-        lastRouteFromRef.current ?? fromLL,\r\n-        fromLL\r\n-      );\r\n-\r\n-      const shouldRecompute =\r\n-        movedM >= ROUTE_MIN_MOVE_M ||\r\n-        (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n-\r\n-      if (shouldRecompute) {\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          destination,\r\n-          false // ‚ö†Ô∏è never reframe on live updates\r\n-        );\r\n-        lastRouteFromRef.current = fromLL;\r\n-        lastRouteToRef.current   = toLL;\r\n-        lastRouteAtRef.current   = now;\r\n-      }\r\n-    }\r\n-  }, [location, avatarUrl, destination]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    if (!initialLocRef.current && location) {\r\n-      initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n-    }\r\n-  }, [location]);\r\n-\r\n-  useEffect(() => {\r\n-    console.log(\"[PHome] HTML built once?\", !!mapHtml);\r\n-  }, [mapHtml]);\r\n-\r\n-  useEffect(() => {\r\n-    console.log('[PHome] guards:',\r\n-      'hasLocation=', !!location,\r\n-      'hasIconData=', !!iconData,\r\n-      'hasMapHtml=', !!mapHtml\r\n-    );\r\n-  }, [location, iconData, mapHtml]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!destination || !location || !routeFramedRef.current) return;\r\n-\r\n-    const now = { lat: location.latitude, lng: location.longitude };\r\n-    const moved = lastOriginRef.current ? haversine(lastOriginRef.current, now) : Infinity;\r\n-\r\n-    if (moved > 150) {                 // tweak threshold as you like\r\n-      fetchORSRoute(location, destination, false); \r\n-      lastOriginRef.current = now;\r\n-    }\r\n-  }, [location, destination]);\r\n-\r\n-\r\n-  \r\n-\r\n-\r\n-\r\n-\r\n-  // Reverse geocode for drop-off location\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      // Always see what's coming in:\r\n-      if (parsed.latitude && parsed.longitude) {\r\n-        setDestination(parsed);\r\n-        try {\r\n-          const results = await Location.reverseGeocodeAsync({\r\n-            latitude: parsed.latitude, longitude: parsed.longitude,\r\n-          });\r\n-          if (results && results.length > 0) {\r\n-            const addr = results[0];\r\n-            setDropoffName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-          } else {\r\n-            setDropoffName(\"Selected Location\");\r\n-          }\r\n-        } catch {\r\n-          setDropoffName(\"Selected Location\");\r\n-        }\r\n-      }\r\n-\r\n-      if (parsed.type === 'dbg' && parsed.tag === 'nudgeRouteStart') {\r\n-        console.log('[MAP] nudge dbg:', parsed);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'nudgeAck') {\r\n-        console.log('[MAP] nudgeAck ok=', parsed.ok);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'userMarkerEnsured') {\r\n-        userMarkerOkRef.current = !!parsed.placed;\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        const { minLng, minLat, maxLng, maxLat } = parsed.bbox;\r\n-        const zoom = Number(parsed.zoom) || 0;\r\n-        lastBBoxRef.current = { minLng, minLat, maxLng, maxLat, zoom };\r\n-        if (!showPOIs || zoom < 14) {\r\n-          sendToMap({ type: 'setPOIs', items: [] });\r\n-          return;\r\n-        };\r\n-\r\n-        const center = parsed.center;\r\n-        if (center && lastCenterRef.current) {\r\n-          const moved = haversine(lastCenterRef.current, center);\r\n-          if (moved < 300) return; // <300m ‚Üí skip fetch\r\n-        }\r\n-        if (center) lastCenterRef.current = center;\r\n-\r\n-        const key = [\r\n-          zoom,\r\n-          roundByZoom(minLng, zoom),\r\n-          roundByZoom(minLat, zoom),\r\n-          roundByZoom(maxLng, zoom),\r\n-          roundByZoom(maxLat, zoom),\r\n-        ].join('|');\r\n-\r\n-        if (lastPoiKeyRef.current === key) return; // avoid duplicates\r\n-        lastPoiKeyRef.current = key;\r\n-\r\n-        if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-        poiFetchTimerRef.current = setTimeout(async () => {\r\n-          try {\r\n-            const qs: string[] = [\r\n-              `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-              `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-              `zoom=${zoom}`,\r\n-            ];\r\n-            if (center?.lat != null && center?.lng != null) {\r\n-              qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-            }\r\n-            const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-            if (poiCacheRef.current.has(key)) {\r\n-              sendToMap({ type: 'setPOIs', items: poiCacheRef.current.get(key) });\r\n-              return;\r\n-            }\r\n-\r\n-            if (inflightRef.current.has(key)) {\r\n-              return;\r\n-            }\r\n-\r\n-            inflightRef.current.add(key);\r\n-\r\n-            const reqId = ++lastReqIdRef.current;\r\n-            \r\n-            try {\r\n-              const qs: string[] = [\r\n-                `types=${encodeURIComponent('cafe,convenience,pharmacy,bank,supermarket,restaurant,fast_food,hospital,school,market,parking,terminal')}`,\r\n-                `bbox=${minLng},${minLat},${maxLng},${maxLat}`,\r\n-                `zoom=${zoom}`,\r\n-              ];\r\n-              if (center?.lat != null && center?.lng != null) {\r\n-                qs.push(`clat=${center.lat}`, `clng=${center.lng}`);\r\n-              }\r\n-              const url = `${API_BASE_URL}/api/pois?${qs.join('&')}`;\r\n-\r\n-              const r = await fetch(url);\r\n-              const items = await r.json();\r\n-\r\n-              if (reqId !== lastReqIdRef.current) {\r\n-                return; // a newer request finished after this one\r\n-              }\r\n-\r\n-              if (Array.isArray(items)) {\r\n-                poiCacheRef.current.set(key, items);\r\n-                sendToMap({ type: 'setPOIs', items });\r\n-              } else {\r\n-                sendToMap({ type: 'setPOIs', items: [] });\r\n-              }\r\n-            } catch (e) {\r\n-              console.log('[ERR] POI fetch failed for', key, e);\r\n-              sendToMap({ type: 'setPOIs', items: [] });\r\n-            } finally {\r\n-              inflightRef.current.delete(key);\r\n-            }\r\n-            const r = await fetch(url);\r\n-            const items = await r.json();\r\n-            if (Array.isArray(items)) {\r\n-              poiCacheRef.current.set(key, items);\r\n-              sendToMap({\r\n-                type: 'setPOIs',\r\n-                items,\r\n-                zoom,                       \r\n-                bbox: { minLng, minLat, maxLng, maxLat },  \r\n-              });\r\n-            }\r\n-\r\n-          } catch {\r\n-            sendToMap({ type: 'setPOIs', items: [] });\r\n-          }\r\n-        }, 500);\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'setDestinationFromPOI') {\r\n-        const dest = { latitude: parsed.lat, longitude: parsed.lng };\r\n-        setDestination(dest);\r\n-        setDropoffName(parsed.label || 'POI Destination');\r\n-\r\n-        if (!location) {\r\n-          Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n-          return;\r\n-        }\r\n-        const { latitude, longitude } = location;\r\n-\r\n-        lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n-        lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n-        lastRouteAtRef.current   = Date.now();\r\n-\r\n-        fetchORSRoute(\r\n-          { latitude: location.latitude, longitude: location.longitude },\r\n-          dest\r\n-        );\r\n-        sendToMap({\r\n-          type: 'setMarkers',\r\n-          destination: dest,\r\n-          driver: null,\r\n-        });\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-    // Set markers & trigger route drawing when destination is picked\r\n-  // useEffect(() => {\r\n-  //   if (!mapRef.current || bookingConfirmed) return;\r\n-\r\n-  //   const driverCoords = matchedDriver?.location\r\n-  //     ? { latitude: matchedDriver.location.latitude, longitude: matchedDriver.location.longitude }\r\n-  //     : null;\r\n-\r\n-  //   if (driverCoords && destination) {\r\n-  //     mapRef.current.postMessage(JSON.stringify({ type: \"setMarkers\", destination, driver: driverCoords }));\r\n-  //   }\r\n-\r\n-  //   // üëâ draw route as soon as we have both ends\r\n-  //   if (destination && location) {\r\n-  //     fetchORSRoute(location, destination);\r\n-  //   }\r\n-  // }, [destination, matchedDriver, bookingConfirmed, location]);\r\n-\r\n-  const loadLandmarks = async () => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/landmarks`);\r\n-      const items = await r.json();\r\n-      sendToMap({ type: 'setLandmarks', items: Array.isArray(items) ? items : [] });\r\n-    } catch {\r\n-      sendToMap({ type: 'setLandmarks', items: [] });\r\n-    }\r\n-  };\r\n-\r\n-\r\n-  const gate = loading || !location;\r\n-\r\n-  const handleBookNow = async () => {\r\n-    if (!location || !destination) {\r\n-      Alert.alert(\"Missing location info\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-\r\n-    // Normalize party size based on type\r\n-    const normalizedParty =\r\n-      bookingType === 'GROUP'\r\n-        ? Math.min(5, Math.max(1, Number(partySize) || 1))\r\n-        : 1; // CLASSIC & SOLO always 1\r\n-\r\n-    setSearching(true);\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId,\r\n-      pickupPlace: pickupName,\r\n-      destinationPlace: dropoffName,\r\n-      bookingType,\r\n-      partySize: normalizedParty,\r\n-    };\r\n-    console.log(bookingData);\r\n-\r\n-    try {\r\n-      // reset any old polling\r\n-      if (searchTimeoutRef.current) {\r\n-        clearTimeout(searchTimeoutRef.current);\r\n-        searchTimeoutRef.current = null;\r\n-      }\r\n-\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  // {status === \"accepted\" && bookingId && (\r\n-  //   <ChatNotice\r\n-  //     bookingId={bookingId}\r\n-  //     role=\"passenger\"\r\n-  //     onGoToChat={() =>\r\n-  //       router.push({\r\n-  //         pathname: \"/chatcomponent\",\r\n-  //         query: { bookingId, driverId, passengerId, role: \"passenger\" },\r\n-  //       })\r\n-  //     }\r\n-  //   />\r\n-  // )}\r\n-\r\n-  \r\n-  \r\n-\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  useEffect(() => {\r\n-    const saveDriverId = async () => {\r\n-      if (matchedDriver && bookingId) {\r\n-        await AsyncStorage.setItem(\"driverIdToRate\", matchedDriver.driverId);\r\n-        await AsyncStorage.setItem(\"bookingIdToRate\", String(bookingId));\r\n-      }\r\n-    };\r\n-    saveDriverId();\r\n-  }, [matchedDriver, bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-\r\n-        if (!myBooking) return;\r\n-\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-          if (bookingId) loadPaymentInfo(String(bookingId));\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!bookingId || !bookingConfirmed) return;\r\n-    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n-    return () => clearInterval(t);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-\r\n-        if (myBooking.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // üîß reset session so user can book again\r\n-          setSearching(false);                                     // <-- key line\r\n-          if (searchTimeoutRef.current) {                          // clear any pending timers\r\n-            clearTimeout(searchTimeoutRef.current);\r\n-            searchTimeoutRef.current = null;\r\n-          }\r\n-\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setShowBookingForm(false);\r\n-          setTripCompleted(true);\r\n-\r\n-          // optional: tidy UI state\r\n-          setQuery('');\r\n-          setHits([]);\r\n-\r\n-          // clear saved ‚Äúsearching:true‚Äù from storage\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-\r\n-          // clear map\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-\r\n-          setFare(0);\r\n-        }\r\n-\r\n-      } catch (err) { console.error(\"‚ùå Poll error:\", err); }\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch (err) { console.warn(\"Error saving booking state:\", err); }\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching]);\r\n-\r\n-  useEffect(() => {\r\n-    const loadBookingState = async () => {\r\n-      try {\r\n-        const savedState = await AsyncStorage.getItem(\"phomeBookingState\");\r\n-        if (savedState) {\r\n-          const s = JSON.parse(savedState);\r\n-          if (s.destination) setDestination(s.destination);\r\n-          if (s.destinationLabel) setDestinationLabel(s.destinationLabel);\r\n-          if (s.notes) setNotes(s.notes);\r\n-          if (s.paymentMethod) setPaymentMethod(s.paymentMethod);\r\n-          if (s.fare) setFare(s.fare);\r\n-          if (s.matchedDriver) setMatchedDriver(s.matchedDriver);\r\n-          if (s.bookingConfirmed) setBookingConfirmed(s.bookingConfirmed);\r\n-          if (s.bookingId) setBookingId(s.bookingId);\r\n-          if (s.showBookingForm) setShowBookingForm(s.showBookingForm);\r\n-          if (s.searching) setSearching(s.searching);\r\n-        }\r\n-      } catch (err) { console.warn(\"Error loading booking state:\", err); }\r\n-    };\r\n-    loadBookingState();\r\n-  }, []);\r\n-\r\n-\r\n-  const cancelRideNow = async () => {\r\n-    try {\r\n-      if (!bookingId) {\r\n-        return;\r\n-      }\r\n-\r\n-      const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ bookingId }),\r\n-      });\r\n-      const body = await resp.text();\r\n-\r\n-      // UI reset after server confirms\r\n-      setSearching(false);\r\n-      setBookingId(null);\r\n-      setMatchedDriver(null);\r\n-      setBookingConfirmed(false);\r\n-      setDestination(null);\r\n-      setTripCompleted(false);\r\n-      setAlertedBookingComplete(false);\r\n-      setShowBookingForm(false);\r\n-\r\n-      // Clear map + cached state\r\n-      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-      sendToMap({ type: \"clearRoute\" });\r\n-      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-      setFare(0);\r\n-    } catch (e) {\r\n-      console.log(\"[PHOME] cancel error\", e);\r\n-      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n-    }\r\n-  };\r\n-\r\n-\r\n-\r\n-  const submitDriverRating = async () => {\r\n-    try {\r\n-      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-      if (!driverIdToRate || !bookingIdToRate) {\r\n-        Alert.alert(\"Error\", \"No driver or booking ID found to rate.\");\r\n-        return;\r\n-      }\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-      });\r\n-\r\n-      if (res.ok && notes) {\r\n-        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-          method: \"POST\",\r\n-          headers: { \"Content-Type\": \"application/json\" },\r\n-          body: JSON.stringify({\r\n-            bookingId: bookingIdToRate,\r\n-            passengerId: await AsyncStorage.getItem(\"passengerId\"),\r\n-            driverId: driverIdToRate,\r\n-            feedback: notes,\r\n-          }),\r\n-        });\r\n-      }\r\n-\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-        setShowRatingModal(false);\r\n-        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit rating:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  const reportOptions = [\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"];\r\n-\r\n-  const submitReport = async () => {\r\n-    try {\r\n-      const passengerId = await AsyncStorage.getItem(\"passengerId\");\r\n-      const res = await fetch(`${API_BASE_URL}/api/feedback/submit-report`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({\r\n-          bookingId, passengerId, driverId: matchedDriver?.driverId, reportType, otherReport,\r\n-        }),\r\n-      });\r\n-      if (res.ok) {\r\n-        Alert.alert(\"Success\", \"Report submitted!\");\r\n-        setShowReportModal(false);\r\n-      } else {\r\n-        const data = await res.json();\r\n-        Alert.alert(\"Error\", data.message || \"Failed to submit report.\");\r\n-      }\r\n-    } catch (error) {\r\n-      console.error(\"‚ùå Failed to submit report:\", error);\r\n-      Alert.alert(\"Error\", \"Something went wrong. Please try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n-    if (!raw) return null;\r\n-\r\n-    // If it's already an absolute URL (Cloudinary, etc.)\r\n-    if (/^https?:\\/\\//i.test(raw)) {\r\n-      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n-      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n-    }\r\n-\r\n-    // Else treat as relative path served by your backend\r\n-    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n-    const path = String(raw).replace(/^\\//, \"\"); // strip leading slash if any\r\n-    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n-    return `${base}/${path}?v=${v}`;\r\n-  };\r\n-\r\n-  const driverSelfieUri = React.useMemo(() => {\r\n-    if (!matchedDriver?.selfieImage) return null;\r\n-\r\n-    // Use a stable version key if you have one; NEVER Date.now()\r\n-    const ver =\r\n-      (matchedDriver as any)?.updatedAt ||\r\n-      (matchedDriver as any)?.selfieUpdatedAt ||\r\n-      matchedDriver?.driverId || // last resort: driverId keeps it stable\r\n-      1;\r\n-\r\n-    return buildImageUri(matchedDriver.selfieImage, ver);\r\n-  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n-\r\n-\r\n-\r\n-    \r\n-\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={showReportModal ? \"none\" : \"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              allowFileAccess\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              mixedContentMode=\"always\"\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          <View style={styles.searchcont}>\r\n-            {/* Destination search */}\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity\r\n-                      key={`${h.lat},${h.lng}-${i}`}\r\n-                      onPress={() => choosePlace(h)}\r\n-                      style={styles.searchItem}\r\n-                    >\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showLandmarks) {\r\n-                  sendToMap({ type: 'clearLandmarks' });\r\n-                  setShowLandmarks(false);\r\n-                } else {\r\n-                  loadLandmarks(); // same function we made before\r\n-                  setShowLandmarks(true);\r\n-                }\r\n-              }}\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showLandmarks ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showLandmarks ? 'Hide Landmarks' : 'Explore Landmarks'}</Text>\r\n-            </TouchableOpacity>\r\n-            <TouchableOpacity\r\n-              onPress={() => {\r\n-                if (showPOIs) {\r\n-                  setShowPOIs(false);\r\n-                  if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                  sendToMap({ type: 'setPOIs', items: [] });\r\n-                } else {\r\n-                  setShowPOIs(true);\r\n-                  const b = lastBBoxRef.current;\r\n-                  if (b) {\r\n-                    const { minLng, minLat, maxLng, maxLat, zoom } = b;\r\n-                    if (zoom >= 14) {\r\n-                      if (poiFetchTimerRef.current) clearTimeout(poiFetchTimerRef.current);\r\n-                      poiFetchTimerRef.current = setTimeout(async () => {\r\n-                        try {\r\n-                          const types = 'cafe,convenience,pharmacy,restaurant,fast_food,bank,supermarket,hospital,school,parking,market';\r\n-                          const url = `${API_BASE_URL}/api/pois?types=${encodeURIComponent(types)}&bbox=${minLng},${minLat},${maxLng},${maxLat}`;\r\n-                          const r = await fetch(url);\r\n-                          const items = await r.json();\r\n-                          sendToMap({ type: 'setPOIs', items: Array.isArray(items) ? items : [] });\r\n-                        } catch {\r\n-                          sendToMap({ type: 'setPOIs', items: [] });\r\n-                        }\r\n-                      }, 0);\r\n-                    } else {\r\n-                      sendToMap({ type: 'setPOIs', items: [] });\r\n-                    }\r\n-                  } else {\r\n-                    sendToMap({ type: 'requestBbox' });\r\n-                  }\r\n-                }\r\n-              }}\r\n-\r\n-              style={{\r\n-                alignSelf: 'center',\r\n-                marginTop: 6,\r\n-                backgroundColor: showPOIs ? '#81C3E1' : '#eee',\r\n-                paddingHorizontal: 10,\r\n-                paddingVertical: 6,\r\n-                borderRadius: 8\r\n-              }}\r\n-            >\r\n-              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n-            </TouchableOpacity>\r\n-\r\n-\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>\r\n-                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n-                  </Text>\r\n-                  <TouchableOpacity\r\n-                    onPress={cancelRideNow}\r\n-                    style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}\r\n-                  >\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              \r\n-\r\n-              {matchedDriver && (\r\n-                <View\r\n-                  style={{\r\n-                    position: \"absolute\",\r\n-                    bottom: -100,\r\n-                    left: 0,\r\n-                    right: 0,\r\n-                    marginHorizontal: 20,\r\n-                    backgroundColor: \"#d1fcd3\",\r\n-                    borderRadius: 10,\r\n-                    padding: 10,\r\n-                    elevation: 3,\r\n-                  }}\r\n-                >\r\n-                  {!infoBoxMinimized ? (\r\n-                    <>\r\n-                      <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                        {driverSelfieUri ? (\r\n-                          <Image\r\n-                            source={{ uri: driverSelfieUri }}\r\n-                            style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }}\r\n-                            resizeMode=\"cover\"\r\n-                          />\r\n-                        ) : null}\r\n-                        <View style={{ flex: 1 }}>\r\n-                          <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                          <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                          <Text>Franchise No.: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n-                          <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n-\r\n-                          \r\n-                        </View>\r\n-                      </View>\r\n-\r\n-                      <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10, gap: 10 }}>\r\n-                        <TouchableOpacity onPress={() => setInfoBoxMinimized(true)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                            onPress={() => {\r\n-                              router.push({\r\n-                                pathname: \"/ChatRoom\",\r\n-                                params: {\r\n-                                  bookingId,\r\n-                                  driverId: matchedDriver?.driverId,\r\n-                                  passengerId,\r\n-                                  role: \"passenger\",\r\n-                                },\r\n-                              });\r\n-                            }}\r\n-                            style={{ backgroundColor: \"#007bff\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n-                          >\r\n-                            <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n-                          </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity onPress={() => setShowReportModal(true)} style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"white\" }}>Report</Text>\r\n-                        </TouchableOpacity>\r\n-\r\n-                        <TouchableOpacity\r\n-                          onPress={async () => {\r\n-                            try {\r\n-                              const resp = await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-                                method: \"POST\",\r\n-                                headers: { \"Content-Type\": \"application/json\" },\r\n-                                body: JSON.stringify({ bookingId }),\r\n-                              });\r\n-                              const body = await resp.text();\r\n-\r\n-                              await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-                            } catch (e) {\r\n-                              console.log(\"[PHOME] cancel error\", e);\r\n-                            }\r\n-                            setSearching(false);\r\n-                            setBookingId(null);\r\n-                            setMatchedDriver(null);\r\n-                            setDestination(null);\r\n-                            setBookingConfirmed(false);\r\n-                            sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-                            sendToMap({ type: \"clearRoute\" });\r\n-                            setFare(0);\r\n-                            if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);\r\n-                          }}\r\n-                          style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}\r\n-                        >\r\n-                          <Text style={{ color: \"white\" }}>Cancel</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                      {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                        <View style={{paddingTop:5}}>\r\n-                          <View style={{flexDirection:\"row\", justifyContent:\"space-between\"}}>\r\n-                            <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-                            <Text>\r\n-                              Status:{\" \"}\r\n-                              <Text style={{ fontWeight: \"700\" }}>\r\n-                                {paymentInfo?.paymentStatus || \"none\"}\r\n-                              </Text>\r\n-                            </Text>\r\n-                          </View>\r\n-                          <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n-                            <TouchableOpacity onPress={handleCopy}>\r\n-                              <Text>\r\n-                                Number:{' '}\r\n-                                <Text style={{ fontWeight: '600' }}>\r\n-                                  {paymentInfo.driverPayment?.number}\r\n-                                </Text>\r\n-                              </Text>\r\n-                              <Text style={{ fontSize: 12, color: copied ? '#81C3E1' : '#666' }}>\r\n-                                {copied ? '‚úî Copied to clipboard' : 'Tap to copy'}\r\n-                              </Text>\r\n-                            </TouchableOpacity>\r\n-                            <TouchableOpacity\r\n-                              onPress={() =>\r\n-                                bookingId && setPaymentStatus(String(bookingId), \"paid\")\r\n-                              }\r\n-                              disabled={paymentInfo?.paymentStatus === \"paid\"}\r\n-                              style={{\r\n-                                backgroundColor:\r\n-                                  paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", \r\n-                                alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5\r\n-                              }}\r\n-                            >\r\n-                              <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>\r\n-                                {paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}\r\n-                              </Text>\r\n-                            </TouchableOpacity>\r\n-                          </View>\r\n-                        </View>\r\n-                      )}\r\n-                    </>\r\n-                  ) : (\r\n-                    <TouchableOpacity style={{ alignItems: \"center\", padding: 10 }} onPress={() => setInfoBoxMinimized(false)}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>View Driver Info</Text>\r\n-                    </TouchableOpacity>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-\r\n-                {/* Booking Type Selector */}\r\n-                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n-                  {[\r\n-                    { key: 'CLASSIC', label: 'Classic' },\r\n-                    { key: 'GROUP', label: 'Group' },\r\n-                    { key: 'SOLO', label: 'Solo' },\r\n-                  ].map((opt) => {\r\n-                    const active = bookingType === (opt.key as any);\r\n-                    return (\r\n-                      <TouchableOpacity\r\n-                        key={opt.key}\r\n-                        onPress={() => {\r\n-                          setBookingType(opt.key as any);\r\n-                          if (opt.key !== 'GROUP') setPartySize(2);\r\n-                        }}\r\n-                        style={{\r\n-                          flex: 1,\r\n-                          backgroundColor: active ? '#111' : '#fff',\r\n-                          borderWidth: 1,\r\n-                          borderColor: active ? '#111' : '#ccc',\r\n-                          paddingVertical: 10,\r\n-                          borderRadius: 10,\r\n-                          alignItems: 'center',\r\n-                        }}\r\n-                      >\r\n-                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>\r\n-                          {opt.label}\r\n-                        </Text>\r\n-                      </TouchableOpacity>\r\n-                    );\r\n-                  })}\r\n-                </View>\r\n-\r\n-                {/* Notes for Solo & Group */}\r\n-                {bookingType === 'SOLO' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.\r\n-                  </Text>\r\n-                )}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <Text style={{ marginTop: 6, color: '#444' }}>\r\n-                    ‚Ä¢ Group ride ‚Äî specify how many passengers (including you).\r\n-                  </Text>\r\n-                )}\r\n-\r\n-                {/* Group Party Size Stepper */}\r\n-                {bookingType === 'GROUP' && (\r\n-                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n-                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n-                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.max(2, p - 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginRight: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>‚Äì</Text>\r\n-                      </TouchableOpacity>\r\n-                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n-                      <TouchableOpacity\r\n-                        onPress={() => setPartySize((p) => Math.min(6, p + 1))}\r\n-                        style={{ paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginLeft: 10 }}\r\n-                      >\r\n-                        <Text style={{ fontSize: 18 }}>Ôºã</Text>\r\n-                      </TouchableOpacity>\r\n-                    </View>\r\n-                  </View>\r\n-                )}\r\n-\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <Text>From:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang pick-up?\" value={pickupName} editable />\r\n-                  <Text>To:</Text>\r\n-                  <TextInput style={styles.input} placeholder=\"Saan ang drop-off?\" value={dropoffName} editable />\r\n-                  {/* <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Name this location (optional: Home, Work, etc.)\"\r\n-                    value={destinationLabel}\r\n-                    onChangeText={setDestinationLabel}\r\n-                  /> */}\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n-                  <Text>Paano ka magbabayad?</Text>\r\n-                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n-                    <TouchableOpacity\r\n-                      onPress={() => setPaymentMethod(\"Cash\")}\r\n-                      style={[\r\n-                        styles.paymentOption,\r\n-                        paymentMethod === \"Cash\" && styles.paymentSelected\r\n-                      ]}\r\n-                    >\r\n-                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n-                    </TouchableOpacity>\r\n-\r\n-                    <TouchableOpacity\r\n-                      onPress={() => setPaymentMethod(\"GCash\")}\r\n-                      style={[\r\n-                        styles.paymentOption,\r\n-                        paymentMethod === \"GCash\" && styles.paymentSelected\r\n-                      ]}\r\n-                    >\r\n-                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n-                    </TouchableOpacity>\r\n-                  </View>\r\n-\r\n-                </ScrollView>\r\n-\r\n-                <View style={styles.fareContainer}>\r\n-                  <View>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Fare:\r\n-                    </Text>\r\n-                    <Text style={{ paddingLeft: 20 }}>\r\n-                      ‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}\r\n-                    </Text>\r\n-                    <Text style={styles.totalFare}>\r\n-                      Total Fare: ‚Ç±\r\n-                      {bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}\r\n-                    </Text>\r\n-                  </View>\r\n-                  <TouchableOpacity\r\n-                    style={[\r\n-                      styles.bookButton,\r\n-                      // disable if invalid group count or no destination\r\n-                      ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination) && { opacity: 0.4 },\r\n-                    ]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination}\r\n-                    onPress={handleBookNow}\r\n-                  >\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity\r\n-                onPress={() => setShowBookingForm(true)}\r\n-                style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}\r\n-              >\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1, 2, 3, 4, 5].map((star) => (\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={submitDriverRating}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {showReportModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={[styles.ratingModal, { alignItems: \"stretch\" }]}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => setShowReportModal(false)}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-\r\n-                  <Text style={styles.modalTitle}>Report Driver</Text>\r\n-\r\n-                  <Text style={styles.modalLabel}>Select Report Type:</Text>\r\n-                  <View style={styles.dropdownContainer}>\r\n-                    <TouchableOpacity style={styles.dropdownButton} onPress={() => setShowDropdown(!showDropdown)}>\r\n-                      <Text style={{ color: reportType ? \"#000\" : \"#999\" }}>{reportType || \"Select a violation\"}</Text>\r\n-                      <Ionicons name={showDropdown ? \"chevron-up\" : \"chevron-down\"} size={20} color=\"#999\" />\r\n-                    </TouchableOpacity>\r\n-\r\n-                    {showDropdown && (\r\n-                      <View style={styles.dropdownMenu}>\r\n-                        {[\"Overcharging\",\"Harassment\",\"Unproper Attire\",\"Refusal to Convey Passenger\",\"Other\"].map((option) => (\r\n-                          <TouchableOpacity key={option} style={styles.dropdownItem} onPress={() => { setReportType(option); setShowDropdown(false); }}>\r\n-                            <Text style={{ color: \"#000\" }}>{option}</Text>\r\n-                          </TouchableOpacity>\r\n-                        ))}\r\n-                      </View>\r\n-                    )}\r\n-                  </View>\r\n-\r\n-                  {reportType === \"Other\" && (\r\n-                    <TextInput style={styles.feedbackInput} placeholder=\"Describe the issue\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} value={otherReport} onChangeText={setOtherReport} />\r\n-                  )}\r\n-\r\n-                  <TouchableOpacity style={[styles.submitButton, { backgroundColor: \"#4CAF50\" }]} onPress={submitReport}>\r\n-                    <Text style={styles.submitButtonText}>Submit Report</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-\r\n-            \r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"center\", marginLeft: 40},\r\n-  searchWrap: {\r\n-    width: '90%',\r\n-    alignSelf: 'center',\r\n-    zIndex: 20,            // stay above map\r\n-  },\r\n-  searchInput: {\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    padding: 10,\r\n-  },\r\n-  searchResults: {\r\n-    marginTop: 4,\r\n-    backgroundColor: '#FFF',\r\n-    borderRadius: 10,\r\n-    borderWidth: 1,\r\n-    borderColor: '#ddd',\r\n-    maxHeight: 200,\r\n-    overflow: 'hidden',\r\n-  },\r\n-  searchItem: {\r\n-    paddingVertical: 10,\r\n-    paddingHorizontal: 12,\r\n-    borderBottomWidth: 1,\r\n-    borderBottomColor: '#eee',\r\n-  },\r\n-  searchItemText: {\r\n-    color: '#111',\r\n-  },\r\n-\r\n-  panel: {\r\n-    position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF',\r\n-    borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10,\r\n-  },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1, },\r\n-  ratingModalOverlay: {\r\n-    position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10,\r\n-    backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999,\r\n-  },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-  modalLabel: { marginTop: 5, marginBottom: 5, fontSize: 14, color: \"#333\", fontWeight: \"500\" },\r\n-  dropdownContainer: { width: \"100%\", marginVertical: 5 },\r\n-  dropdownButton: {\r\n-    flexDirection: \"row\", justifyContent: \"space-between\", alignItems: \"center\",\r\n-    padding: 10, backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\",\r\n-  },\r\n-  dropdownMenu: { backgroundColor: \"#FFF\", borderRadius: 8, borderWidth: 1, borderColor: \"#ccc\", marginTop: 2 },\r\n-  dropdownItem: { padding: 10 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-  bottomNav: {\r\n-    position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\",\r\n-    width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30,\r\n-    alignItems: \"center\", borderWidth: 1, borderColor: \"black\"\r\n-  },\r\n-\r\n-  paymentOption: {\r\n-    flex: 1,\r\n-    borderWidth: 1,\r\n-    borderColor: \"#ccc\",\r\n-    paddingVertical: 6,\r\n-    borderRadius: 10,\r\n-    alignItems: \"center\",\r\n-    marginHorizontal: 5,\r\n-    backgroundColor: \"#fff\",\r\n-  },\r\n-  paymentSelected: {\r\n-    backgroundColor: \"#000\",\r\n-    borderColor: \"#333\",\r\n-  },\r\n-  paymentText: {\r\n-    color: \"#333\",\r\n-    fontWeight: \"600\",\r\n-  },\r\n-  paymentSelectedText: {\r\n-    color: \"#fff\",\r\n-    fontWeight: \"700\",\r\n-  },\r\n-\r\n-  \r\n-});\r\n"
                },
                {
                    "date": 1762524522697,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1935,9 +1935,9 @@\n                 paddingVertical: 6,\r\n                 borderRadius: 8\r\n               }}\r\n             >\r\n-              <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text>\r\n+              {/* <Text>{showPOIs ? 'Hide Places' : 'Show Places'}</Text> */}\r\n             </TouchableOpacity>\r\n \r\n \r\n           </View>\r\n"
                },
                {
                    "date": 1762771156905,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,1135 @@\n+import React, { useState, useEffect, useRef } from \"react\";\r\n+import { View, \r\n+  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n+  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n+  Keyboard, Image, ScrollView, AppState, Linking  } from \"react-native\";\r\n+import { WebView } from \"react-native-webview\";\r\n+import type { WebView as WebViewType } from \"react-native-webview\";\r\n+import { Ionicons } from \"@expo/vector-icons\";\r\n+import { useLocation } from \"../location/GlobalLocation\";\r\n+import { router } from 'expo-router';\r\n+import AsyncStorage from '@react-native-async-storage/async-storage';\r\n+import { API_BASE_URL } from \"../../config\";\r\n+import * as Location from 'expo-location';\r\n+import { useNavigation, useFocusEffect } from \"@react-navigation/native\";\r\n+import { getAuth } from \"../utils/authStorage\";\r\n+import { Asset } from 'expo-asset';\r\n+import * as FileSystem from 'expo-file-system';\r\n+import * as IntentLauncher from 'expo-intent-launcher';\r\n+import * as Clipboard from 'expo-clipboard';\r\n+\r\n+async function getLocalIconBase64(localPath: any) {\r\n+  const asset = Asset.fromModule(localPath);\r\n+  await asset.downloadAsync();\r\n+  const uri = asset.localUri || asset.uri;\r\n+  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n+  return `data:image/png;base64,${base64}`;\r\n+}\r\n+\r\n+// POI icons (keep your assets)\r\n+const POI_ICON_FILES: Record<string, any> = {\r\n+  cafe: require('../../assets/images/pios/cafe.png'),\r\n+  convenience: require('../../assets/images/pios/convenience.png'),\r\n+  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n+  bank: require('../../assets/images/pios/bank.png'),\r\n+  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n+  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n+  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n+  hospital: require('../../assets/images/pios/hospital.png'),\r\n+  school: require('../../assets/images/pios/school.png'),\r\n+  market: require('../../assets/images/pios/market.png'),\r\n+  parking: require('../../assets/images/pios/parking.png'),\r\n+};\r\n+\r\n+const { width } = Dimensions.get(\"window\");\r\n+type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n+\r\n+const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n+  if (!isFinite(distanceKm) || distanceKm <= 0) return 0;\r\n+  const BASE_FARE = 20;\r\n+  const INCLUDED_KM = 2;\r\n+  const PER_KM = 5;\r\n+  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n+  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n+  if (discount !== 'none') fare *= 0.8;\r\n+  return Math.round(fare);\r\n+};\r\n+\r\n+async function ensureLocationEnabled() {\r\n+  const services = await Location.hasServicesEnabledAsync();\r\n+  const perm = await Location.getForegroundPermissionsAsync();\r\n+  if (!services || perm.status !== 'granted') {\r\n+    Alert.alert(\r\n+      \"Enable Location\",\r\n+      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n+      [\r\n+        { text: \"Cancel\", style: \"cancel\" },\r\n+        {\r\n+          text: \"Open Settings\",\r\n+          onPress: () => {\r\n+            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n+            else Linking.openURL('app-settings:');\r\n+          }\r\n+        }\r\n+      ]\r\n+    );\r\n+    return false;\r\n+  }\r\n+  return true;\r\n+}\r\n+\r\n+export default function PHome() {\r\n+  // ---------- session ----------\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      try {\r\n+        const auth = await getAuth();\r\n+        if (auth?.role === \"passenger\" && auth?.userId) {\r\n+          setPassengerId(String(auth.userId));\r\n+          return;\r\n+        }\r\n+        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (legacy) { setPassengerId(legacy); return; }\r\n+        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      } catch {\r\n+        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n+        router.replace(\"/login_and_reg/plogin\");\r\n+      }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  // ---------- map & geoloc ----------\r\n+  const { location, loading } = useLocation();\r\n+  const [mapHtml, setMapHtml] = useState(\"\");\r\n+  const mapRef = useRef<WebViewType>(null);\r\n+  const [mapReady, setMapReady] = useState(false);\r\n+  const messageQueue = useRef<any[]>([]);\r\n+  const sendToMap = (msg: any) => {\r\n+    const json = JSON.stringify(msg);\r\n+    if (!mapReady || !mapRef.current) { messageQueue.current.push(json); return; }\r\n+    mapRef.current.postMessage(json);\r\n+  };\r\n+\r\n+  // ---------- feature: Book for Someone Else ----------\r\n+  const [bookedFor, setBookedFor] = useState(false);\r\n+  const [riderName, setRiderName] = useState(\"\");\r\n+  const [riderPhone, setRiderPhone] = useState(\"\");\r\n+  const [selectMode, setSelectMode] = useState<'pickup' | 'dest'>('dest'); // which point the next tap sets\r\n+  const [customPickup, setCustomPickup] = useState<{ latitude:number; longitude:number } | null>(null);\r\n+\r\n+  // ---------- trip inputs ----------\r\n+  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n+  const [pickupName, setPickupName] = useState(\"\");\r\n+  const [dropoffName, setDropoffName] = useState(\"\");\r\n+  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n+\r\n+  const [notes, setNotes] = useState(\"\");\r\n+  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n+  const [fare, setFare] = useState(0);\r\n+  const [discount] = useState<DiscountType>('none');\r\n+  const [query, setQuery] = useState('');\r\n+  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n+  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+\r\n+  // ---------- booking flow ----------\r\n+  const [matchedDriver, setMatchedDriver] = useState<any>(null);\r\n+  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n+  const [bookingId, setBookingId] = useState<any>(null);\r\n+  const [showBookingForm, setShowBookingForm] = useState(false);\r\n+  const [searching, setSearching] = useState(false);\r\n+  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n+  const [tripCompleted, setTripCompleted] = useState(false);\r\n+\r\n+  const [showRatingModal, setShowRatingModal] = useState(false);\r\n+  const [selectedRating, setSelectedRating] = useState(0);\r\n+\r\n+  const [reportType, setReportType] = useState(\"\");\r\n+  const [otherReport, setOtherReport] = useState(\"\");\r\n+  const [showDropdown, setShowDropdown] = useState(false);\r\n+\r\n+  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n+\r\n+  // booking types\r\n+  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n+  const [partySize, setPartySize] = useState<number>(2);\r\n+\r\n+  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n+\r\n+  // POIs/landmarks infra (kept)\r\n+  const [showLandmarks, setShowLandmarks] = useState(false);\r\n+  const [showPOIs, setShowPOIs] = useState(false);\r\n+  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n+  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n+  const inflightRef  = useRef<Set<string>>(new Set());\r\n+  const lastReqIdRef = useRef(0);\r\n+  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n+  const lastPoiKeyRef = useRef<string>('');\r\n+  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n+\r\n+  // routing helpers/state\r\n+  const userMarkerOkRef = useRef(false);\r\n+  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n+  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n+  const routeFramedRef = useRef(false);\r\n+  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n+  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n+  const lastRouteAtRef   = useRef(0);\r\n+  const ROUTE_MIN_MOVE_M   = 35;\r\n+  const ROUTE_MIN_INTERVAL = 8000;\r\n+\r\n+  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n+\r\n+  // small utils\r\n+  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n+    const R = 6371000;\r\n+    const toRad = (x:number)=>x*Math.PI/180;\r\n+    const dLat = toRad(b.lat-a.lat);\r\n+    const dLng = toRad(b.lng-a.lng);\r\n+    const s1 = Math.sin(dLat/2)**2 +\r\n+              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n+    return 2*R*Math.asin(Math.sqrt(s1));\r\n+  }\r\n+  function roundByZoom(value: number, zoom: number) {\r\n+    const decimals = zoom >= 18 ? 3 : zoom >= 16 ? 3 : zoom >= 15 ? 2 : 2;\r\n+    const m = Math.pow(10, decimals);\r\n+    return Math.round(value * m) / m;\r\n+  }\r\n+\r\n+  // origin resolver (GPS vs custom pickup)\r\n+  const resolveOrigin = () => {\r\n+    if (bookedFor && customPickup) return customPickup;\r\n+    return location ? { latitude: location.latitude, longitude: location.longitude } : null;\r\n+  };\r\n+\r\n+  // ensure blue marker\r\n+  function ensureUserMarker(lat: number, lng: number) {\r\n+    let attempts = 0;\r\n+    userMarkerOkRef.current = false;\r\n+    const tryOnce = () => {\r\n+      attempts += 1;\r\n+      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n+      if (!userMarkerOkRef.current && attempts < 6) setTimeout(tryOnce, 400);\r\n+    };\r\n+    tryOnce();\r\n+  }\r\n+\r\n+  const handleCopy = async () => {\r\n+    const n = paymentInfo?.driverPayment?.number;\r\n+    if (!n) return;\r\n+    await Clipboard.setStringAsync(n);\r\n+    Alert.alert(\"Copied\", \"GCash number copied to clipboard.\");\r\n+  };\r\n+\r\n+  // icons preload\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const out: Record<string, string> = {};\r\n+      for (const k of Object.keys(POI_ICON_FILES)) {\r\n+        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n+      }\r\n+      setIconData(out);\r\n+    })();\r\n+  }, []);\r\n+  useEffect(() => { if (mapReady && iconData) sendToMap({ type: 'preloadIcons', icons: iconData }); }, [mapReady, iconData]);\r\n+\r\n+  // permission nudges\r\n+  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n+  useEffect(() => { ensureLocationEnabled(); }, []);\r\n+  useEffect(() => {\r\n+    const sub = AppState.addEventListener('change', (s) => { if (s === 'active') ensureLocationEnabled(); });\r\n+    return () => sub.remove();\r\n+  }, []);\r\n+\r\n+  // avatar load (kept)\r\n+  useEffect(() => {\r\n+    (async () => {\r\n+      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\";\r\n+      try {\r\n+        const pid = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (!pid) return setAvatarUrl(fallback);\r\n+        const r = await fetch(`${API_BASE_URL}/api/passenger/${pid}`);\r\n+        const j = await r.json();\r\n+        const img = j?.passenger?.profileImage || j?.passenger?.selfieImage || j?.passenger?.avatar;\r\n+        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n+      } catch { setAvatarUrl(fallback); }\r\n+    })();\r\n+  }, []);\r\n+\r\n+  // reverse geocode current pickup label\r\n+  useEffect(() => {\r\n+    if (!location) return;\r\n+    Location.reverseGeocodeAsync({ latitude: location.latitude, longitude: location.longitude })\r\n+      .then((results) => {\r\n+        if (results && results.length > 0) {\r\n+          const addr = results[0];\r\n+          setPickupName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n+        } else setPickupName(\"Current Location\");\r\n+      })\r\n+      .catch(() => setPickupName(\"Current Location\"));\r\n+  }, [location]);\r\n+\r\n+  // map HTML build (unchanged except standard)\r\n+  useEffect(() => {\r\n+    if (!location || mapHtml) return;\r\n+    if (!initialLocRef.current) initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n+    const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n+    const iconJson = JSON.stringify(iconData || {});\r\n+    const html = String.raw`\r\n+<!DOCTYPE html><html><head>\r\n+<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n+<link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n+<style>\r\n+html,body,#map{height:100%;margin:0;padding:0}\r\n+.distance-label.leaflet-tooltip{background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);font-size:12px;line-height:1;white-space:nowrap}\r\n+.distance-label.leaflet-tooltip:before{display:none}\r\n+</style>\r\n+</head><body>\r\n+<div id=\"map\"></div>\r\n+<script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n+<script>\r\n+const map = L.map('map',{zoomControl:true,maxBounds:[[13.96,121.643],[13.88,121.588]],maxBoundsViscosity:0.5,minZoom:13,maxZoom:19,noWrap:true}).setView([${initLat},${initLng}],15);\r\n+L.tileLayer('https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=7yQg8w68otDEssrPk9wU',{maxZoom:19,attribution:'¬© OpenStreetMap | ¬© MapTiler'}).addTo(map);\r\n+\r\n+let userMarker=null,destMarker=null,driverMarker=null,routeLine=null,distanceTooltip=null;\r\n+let destinationLocked=false; // locked when driver present\r\n+function clearRoute(){ if(routeLine){map.removeLayer(routeLine);routeLine=null} if(distanceTooltip){map.removeLayer(distanceTooltip);distanceTooltip=null} }\r\n+\r\n+const userIcon=L.icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',iconSize:[30,30],iconAnchor:[15,30]});\r\n+const destIcon=L.icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',iconSize:[30,30],iconAnchor:[15,30]});\r\n+const carIcon =L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',iconSize:[40,40],iconAnchor:[20,40]});\r\n+\r\n+function upsertUserMarker(lat,lng){ if(!Number.isFinite(lat)||!Number.isFinite(lng))return;\r\n+  if(!userMarker){ userMarker=L.marker([lat,lng],{icon:userIcon,zIndexOffset:1000}).addTo(map).bindTooltip({permanent:true,direction:\"top\"}); }\r\n+  else userMarker.setLatLng([lat,lng]);\r\n+}\r\n+function setDestination(lat,lng){ if(destMarker){map.removeLayer(destMarker);destMarker=null}\r\n+  destMarker=L.marker([lat,lng],{icon:destIcon}).addTo(map).bindTooltip(\"Destination\",{permanent:true,direction:\"top\"});\r\n+}\r\n+function setDriver(lat,lng){ if(driverMarker){map.removeLayer(driverMarker);driverMarker=null}\r\n+  if(Number.isFinite(lat)&&Number.isFinite(lng)){ driverMarker=L.marker([lat,lng],{icon:carIcon}).addTo(map).bindTooltip(\"üöï Driver\",{permanent:true,direction:\"top\"}).setZIndexOffset(1100); }\r\n+}\r\n+\r\n+// map click ‚Üí RN decides whether it's pickup or destination\r\n+map.on('click', (e)=>{ const {lat,lng}=e.latlng;\r\n+  window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'mapClick', lat, lng }));\r\n+});\r\n+\r\n+// message bridge\r\n+document.addEventListener('message', (ev)=>{\r\n+  let msg={}; try{ msg=JSON.parse(ev.data||'{}') }catch{return}\r\n+  if(msg.type==='ensureUserMarker'){ const {latitude,longitude}=msg; upsertUserMarker(latitude,longitude);\r\n+    window.ReactNativeWebView?.postMessage(JSON.stringify({type:'userMarkerEnsured',placed:!!userMarker})); return; }\r\n+  if(msg.type==='updateUserLoc'){ const {latitude,longitude}=msg; if(Number.isFinite(latitude)&&Number.isFinite(longitude)) upsertUserMarker(latitude,longitude); return; }\r\n+  if(msg.type==='drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n+    clearRoute(); routeLine=L.polyline(msg.route,{weight:4,color:'#1a73e8'}).addTo(map);\r\n+    if(msg.reframe){ map.fitBounds(routeLine.getBounds(),{padding:[50,50]}); }\r\n+    const mid=msg.route[Math.floor(msg.route.length/2)];\r\n+    const label=[msg.distanceText,msg.durationText,msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n+    distanceTooltip=L.tooltip({permanent:true,direction:'top',offset:[0,-6],className:'distance-label'}).setContent(label||'').setLatLng(mid).addTo(map);\r\n+    return;\r\n+  }\r\n+  if(msg.type==='clearRoute'){ clearRoute(); return; }\r\n+  if(msg.type==='setMarkers'){\r\n+    destinationLocked=!!msg.driver;\r\n+    if(msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)) setDestination(msg.destination.latitude,msg.destination.longitude);\r\n+    else if(destMarker){ map.removeLayer(destMarker); destMarker=null; }\r\n+    if(msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)) setDriver(msg.driver.latitude,msg.driver.longitude);\r\n+    else if(driverMarker){ map.removeLayer(driverMarker); driverMarker=null; }\r\n+    return;\r\n+  }\r\n+});\r\n+</script>\r\n+</body></html>`;\r\n+    setMapHtml(html);\r\n+  }, [mapHtml, location, iconData]);\r\n+\r\n+  // flush queued map messages\r\n+  useEffect(() => {\r\n+    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n+      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n+      messageQueue.current = [];\r\n+    }\r\n+  }, [mapReady]);\r\n+\r\n+  // after map ready, show initial marker (customPickup when bookedFor else GPS)\r\n+  useEffect(() => {\r\n+    const origin = resolveOrigin();\r\n+    if (mapReady && origin) ensureUserMarker(origin.latitude, origin.longitude);\r\n+  }, [mapReady]);\r\n+\r\n+  // live GPS watcher ‚Äì disabled while bookedFor so we don't overwrite custom pickup\r\n+  useEffect(() => {\r\n+    let sub: Location.LocationSubscription | null = null;\r\n+    (async () => {\r\n+      const { status } = await Location.requestForegroundPermissionsAsync();\r\n+      if (status !== \"granted\") return;\r\n+      sub = await Location.watchPositionAsync(\r\n+        { accuracy: Location.Accuracy.Balanced, timeInterval: 5000, distanceInterval: 5 },\r\n+        (pos) => {\r\n+          if (bookedFor) return; // üîí don't send user GPS while booking for others\r\n+          const { latitude, longitude } = pos.coords;\r\n+          setLivePos({ latitude, longitude });\r\n+          sendToMap({ type: \"updateUserLoc\", latitude, longitude, accuracy: 15, avatarUrl });\r\n+          // nudge route start if previewing self-ride\r\n+          if (destination && !bookedFor) {\r\n+            const nowFrom = { lat: latitude, lng: longitude };\r\n+            const movedM = haversine(lastRouteFromRef.current ?? nowFrom, nowFrom);\r\n+            const now = Date.now();\r\n+            if (movedM >= ROUTE_MIN_MOVE_M || (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL) {\r\n+              fetchORSRoute({ latitude, longitude }, destination, false);\r\n+              lastRouteFromRef.current = nowFrom;\r\n+              lastRouteAtRef.current = now;\r\n+            }\r\n+          }\r\n+        }\r\n+      );\r\n+    })();\r\n+    return () => sub?.remove();\r\n+  }, [avatarUrl, bookedFor, destination]);\r\n+\r\n+  // reverse geocode helper\r\n+  const reverseName = async (lat: number, lng: number) => {\r\n+    try {\r\n+      const results = await Location.reverseGeocodeAsync({ latitude: lat, longitude: lng });\r\n+      if (results && results.length > 0) {\r\n+        const a = results[0];\r\n+        return `${a.street || \"\"}${a.street ? \", \" : \"\"}${a.city || a.subregion || \"\"}` || \"Selected Location\";\r\n+      }\r\n+    } catch {}\r\n+    return \"Selected Location\";\r\n+  };\r\n+\r\n+  // route draw\r\n+  const routeReqIdRef = useRef(0);\r\n+  const fetchORSRoute = async (\r\n+    from: { latitude: number; longitude: number },\r\n+    to:   { latitude: number; longitude: number },\r\n+    reframe: boolean = false\r\n+  ) => {\r\n+    const myReqId = ++routeReqIdRef.current;\r\n+    try {\r\n+      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n+        method: 'POST',\r\n+        headers: { 'Content-Type': 'application/json' },\r\n+        body: JSON.stringify({ start: [from.longitude, from.latitude], end: [to.longitude, to.latitude] }),\r\n+      });\r\n+      const data = await res.json();\r\n+      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n+      if (myReqId !== routeReqIdRef.current) return;\r\n+      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n+      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n+\r\n+      const summary    = data.features?.[0]?.properties?.summary || {};\r\n+      const distanceM  = summary.distance ?? 0;\r\n+      const durationS  = summary.duration ?? 0;\r\n+      const distanceKm = distanceM / 1000;\r\n+\r\n+      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n+      const mins         = Math.round(durationS / 60);\r\n+      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n+      const computedFare = calculateFare(distanceKm, discount);\r\n+      setFare(computedFare);\r\n+\r\n+      sendToMap({\r\n+        type: 'drawRoute',\r\n+        route: polylinePoints,\r\n+        distanceKm,\r\n+        distanceText,\r\n+        durationText,\r\n+        fareText: `‚Ç±${computedFare} est`,\r\n+        reframe,\r\n+      });\r\n+    } catch {}\r\n+  };\r\n+\r\n+  // when destination selected and origin known ‚Üí draw preview route\r\n+  useEffect(() => {\r\n+    if (!destination) return;\r\n+    const origin = resolveOrigin();\r\n+    if (!origin) return;\r\n+    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n+    if (lastRouteDestKeyRef.current !== destKey) {\r\n+      fetchORSRoute(origin, destination, true);\r\n+      routeFramedRef.current = true;\r\n+      lastRouteDestKeyRef.current = destKey;\r\n+      lastOriginRef.current = { lat: origin.latitude, lng: origin.longitude };\r\n+    }\r\n+  }, [destination, bookedFor, customPickup, location]);\r\n+\r\n+  // search box (destination search)\r\n+  const onChangeQuery = (t: string) => {\r\n+    setQuery(t);\r\n+    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n+    searchTimerRef.current = setTimeout(async () => {\r\n+      if (!t || t.length < 3) { setHits([]); return; }\r\n+      const origin = resolveOrigin();\r\n+      if (!origin) { setHits([]); return; }\r\n+      try {\r\n+        const lat = origin.latitude, lng = origin.longitude;\r\n+        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n+        const r = await fetch(url);\r\n+        const data = await r.json();\r\n+        setHits(Array.isArray(data) ? data : []);\r\n+      } catch { setHits([]); }\r\n+    }, 300);\r\n+  };\r\n+\r\n+  // choose from search ‚Üí destination\r\n+  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n+    setQuery(p.label); setHits([]);\r\n+    const dest = { latitude: p.lat, longitude: p.lng };\r\n+    setDestination(dest); setDropoffName(p.label);\r\n+    const origin = resolveOrigin();\r\n+    if (!origin) {\r\n+      Alert.alert('Location unavailable', 'Waiting for GPS or set pickup first.');\r\n+      return;\r\n+    }\r\n+    fetchORSRoute(origin, dest, true);\r\n+    sendToMap({ type: 'setMarkers', destination: dest, driver: null });\r\n+  };\r\n+\r\n+  // map messages\r\n+  const handleMapMessage = async (event: any) => {\r\n+    try {\r\n+      const parsed = JSON.parse(event.nativeEvent.data);\r\n+      if (parsed.type === 'userMarkerEnsured') { userMarkerOkRef.current = !!parsed.placed; return; }\r\n+      if (parsed.type === 'mapClick' && Number.isFinite(parsed.lat) && Number.isFinite(parsed.lng)) {\r\n+        const lat = parsed.lat, lng = parsed.lng;\r\n+        if (bookedFor && selectMode === 'pickup') {\r\n+          // set custom pickup\r\n+          setCustomPickup({ latitude: lat, longitude: lng });\r\n+          const name = await reverseName(lat, lng);\r\n+          setPickupName(name);\r\n+          // place blue marker at custom pickup\r\n+          sendToMap({ type: 'updateUserLoc', latitude: lat, longitude: lng });\r\n+          // after choosing pickup, auto-switch to destination mode\r\n+          setSelectMode('dest');\r\n+          // draw route if destination already set\r\n+          if (destination) fetchORSRoute({ latitude: lat, longitude: lng }, destination, true);\r\n+          return;\r\n+        }\r\n+        // else it's a destination tap\r\n+        const dest = { latitude: lat, longitude: lng };\r\n+        setDestination(dest);\r\n+        const label = await reverseName(lat, lng);\r\n+        setDropoffName(label);\r\n+        const origin = resolveOrigin();\r\n+        if (!origin) { Alert.alert('Set pickup first', 'Tap the map to choose pickup.'); return; }\r\n+        fetchORSRoute(origin, dest, true);\r\n+        sendToMap({ type: 'setMarkers', destination: dest, driver: null });\r\n+        return;\r\n+      }\r\n+      if (parsed.type === 'bbox' && parsed.bbox) {\r\n+        // (POI logic kept out to keep this focused)\r\n+        lastBBoxRef.current = { ...parsed.bbox, zoom: Number(parsed.zoom) || 0 };\r\n+        return;\r\n+      }\r\n+    } catch {}\r\n+  };\r\n+\r\n+  // payment polling (kept)\r\n+  const [paymentInfo, setPaymentInfo] = useState<{ paymentMethod?: string; paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\"; driverPayment?: { number?: string; qrUrl?: string|null } } | null>(null);\r\n+  const loadPaymentInfo = async (id: string) => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo({ paymentMethod: j.paymentMethod, paymentStatus: j.paymentStatus, driverPayment: j.driverPayment || {} });\r\n+    } catch {}\r\n+  };\r\n+  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n+    try {\r\n+      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n+        method: \"POST\", headers: { \"Content-Type\":\"application/json\" }, body: JSON.stringify({ status }),\r\n+      });\r\n+      const j = await r.json();\r\n+      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n+    } catch {}\r\n+  };\r\n+\r\n+  // DEST & ORIGIN auto recompute on live GPS ‚Äî disabled when bookedFor\r\n+  useEffect(() => {\r\n+    if (!location || !destination || bookedFor) return;\r\n+    const now = Date.now();\r\n+    const fromLL = { lat: location.latitude, lng: location.longitude };\r\n+    const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n+    const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n+    const should = movedM >= ROUTE_MIN_MOVE_M || (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n+    if (should) {\r\n+      fetchORSRoute({ latitude: location.latitude, longitude: location.longitude }, destination, false);\r\n+      lastRouteFromRef.current = fromLL; lastRouteToRef.current = toLL; lastRouteAtRef.current = now;\r\n+    }\r\n+  }, [location, destination, bookedFor]);\r\n+\r\n+  // booking submit\r\n+  const handleBookNow = async () => {\r\n+    const origin = resolveOrigin();\r\n+    if (!origin || !destination) {\r\n+      Alert.alert(\"Missing location info\", bookedFor ? \"Please select pickup and destination.\" : \"Please pick a destination.\");\r\n+      return;\r\n+    }\r\n+    if (!passengerId) {\r\n+      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n+      router.replace(\"/login_and_reg/plogin\");\r\n+      return;\r\n+    }\r\n+    if (bookedFor && !riderName.trim()) {\r\n+      Alert.alert(\"Rider name required\", \"Please enter the rider‚Äôs name.\");\r\n+      return;\r\n+    }\r\n+\r\n+    const normalizedParty =\r\n+      bookingType === 'GROUP' ? Math.min(5, Math.max(1, Number(partySize) || 1)) : 1;\r\n+\r\n+    setSearching(true);\r\n+    setAlertedBookingComplete(false);\r\n+    setTripCompleted(false);\r\n+\r\n+    const bookingData = {\r\n+      pickupLat: origin.latitude,\r\n+      pickupLng: origin.longitude,\r\n+      destinationLat: destination.latitude,\r\n+      destinationLng: destination.longitude,\r\n+      fare,\r\n+      paymentMethod,\r\n+      notes,\r\n+      passengerId,\r\n+      pickupPlace: pickupName,\r\n+      destinationPlace: dropoffName,\r\n+      bookingType,\r\n+      partySize: normalizedParty,\r\n+\r\n+      // üîµ new fields\r\n+      bookedFor,\r\n+      riderName: riderName.trim(),\r\n+      riderPhone: riderPhone.trim(),\r\n+    };\r\n+\r\n+    try {\r\n+      if (searchTimeoutRef.current) { clearTimeout(searchTimeoutRef.current); searchTimeoutRef.current = null; }\r\n+      setShowBookingForm(false);\r\n+      setSearching(true);\r\n+\r\n+      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n+        method: \"POST\",\r\n+        headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify(bookingData),\r\n+      });\r\n+\r\n+      const result = await response.json();\r\n+      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n+      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n+    } catch (e: any) {\r\n+      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n+      setSearching(false);\r\n+    }\r\n+  };\r\n+\r\n+  // poll for driver accept\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForDriverMatch = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        if (!myBooking) return;\r\n+        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n+          setBookingConfirmed(true);\r\n+          setSearching(false);\r\n+          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n+          if (bookingId) loadPaymentInfo(String(bookingId));\r\n+          if (myBooking.driverId) {\r\n+            try {\r\n+              const [driverRes, statusRes] = await Promise.all([\r\n+                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n+                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n+              ]);\r\n+              const driverData = await driverRes.json();\r\n+              const statusData = await statusRes.json();\r\n+              if (driverData?.driver) {\r\n+                setMatchedDriver({\r\n+                  driverName: driverData.driver.driverName,\r\n+                  driverId: driverData.driver._id,\r\n+                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n+                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n+                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n+                  location: statusData.location || null,\r\n+                });\r\n+              }\r\n+            } catch {}\r\n+          }\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForDriverMatch, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  // poll payment info when accepted\r\n+  useEffect(() => {\r\n+    if (!bookingId || !bookingConfirmed) return;\r\n+    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n+    return () => clearInterval(t);\r\n+  }, [bookingId, bookingConfirmed]);\r\n+\r\n+  // poll for completion\r\n+  useEffect(() => {\r\n+    let interval: any;\r\n+    const pollForBookingCompletion = async () => {\r\n+      if (!bookingId) return;\r\n+      try {\r\n+        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n+        const allBookings = await res.json();\r\n+        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n+        setAlertedBookingComplete(false);\r\n+        setTripCompleted(false);\r\n+        if (myBooking?.status === \"completed\" && !alertedBookingComplete) {\r\n+          setAlertedBookingComplete(true);\r\n+          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n+\r\n+          // reset session for next booking\r\n+          setSearching(false);\r\n+          if (searchTimeoutRef.current) { clearTimeout(searchTimeoutRef.current); searchTimeoutRef.current = null; }\r\n+          setBookingConfirmed(false);\r\n+          setBookingId(null);\r\n+          setMatchedDriver(null);\r\n+          setDestination(null);\r\n+          setTripCompleted(true);\r\n+          setQuery(''); setHits([]);\r\n+          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n+          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+          sendToMap({ type: \"clearRoute\" });\r\n+          setFare(0);\r\n+\r\n+          // bookedFor UI reset\r\n+          setBookedFor(false);\r\n+          setRiderName(\"\"); setRiderPhone(\"\");\r\n+          setCustomPickup(null);\r\n+          setSelectMode('dest');\r\n+        }\r\n+      } catch {}\r\n+    };\r\n+    interval = setInterval(pollForBookingCompletion, 4000);\r\n+    return () => clearInterval(interval);\r\n+  }, [bookingId]);\r\n+\r\n+  // persist basic UI state\r\n+  useEffect(() => {\r\n+    const saveBookingState = async () => {\r\n+      const bookingState = {\r\n+        destination, destinationLabel, notes, paymentMethod, fare,\r\n+        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n+        bookedFor, riderName, riderPhone, customPickup, pickupName, dropoffName\r\n+      };\r\n+      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n+      catch {}\r\n+    };\r\n+    saveBookingState();\r\n+  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching, bookedFor, riderName, riderPhone, customPickup, pickupName, dropoffName]);\r\n+\r\n+  // rating modal\r\n+  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n+\r\n+  // cancel ride\r\n+  const cancelRideNow = async () => {\r\n+    try {\r\n+      if (!bookingId) return;\r\n+      await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n+        method: \"POST\", headers: { \"Content-Type\": \"application/json\" },\r\n+        body: JSON.stringify({ bookingId }),\r\n+      });\r\n+      // UI reset\r\n+      setSearching(false); setBookingId(null); setMatchedDriver(null);\r\n+      setBookingConfirmed(false); setDestination(null);\r\n+      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n+      sendToMap({ type: \"clearRoute\" });\r\n+      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n+      setFare(0);\r\n+      // booked-for reset\r\n+      setBookedFor(false); setRiderName(\"\"); setRiderPhone(\"\"); setCustomPickup(null); setSelectMode('dest');\r\n+    } catch (e) {\r\n+      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n+    }\r\n+  };\r\n+\r\n+  // minor UI\r\n+  useEffect(() => {\r\n+    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n+    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n+    return () => { showSub.remove(); hideSub.remove(); };\r\n+  }, []);\r\n+\r\n+  // driver selfie cache-busted url\r\n+  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n+    if (!raw) return null;\r\n+    if (/^https?:\\/\\//i.test(raw)) {\r\n+      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n+    }\r\n+    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n+    const path = String(raw).replace(/^\\//, \"\");\r\n+    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n+    return `${base}/${path}?v=${v}`;\r\n+  };\r\n+  const driverSelfieUri = React.useMemo(() => {\r\n+    if (!matchedDriver?.selfieImage) return null;\r\n+    const ver = (matchedDriver as any)?.updatedAt || (matchedDriver as any)?.selfieUpdatedAt || matchedDriver?.driverId || 1;\r\n+    return buildImageUri(matchedDriver.selfieImage, ver);\r\n+  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n+\r\n+  // ---------- RENDER ----------\r\n+  return (\r\n+    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n+      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n+        <View style={styles.container}>\r\n+          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n+          {mapHtml && (\r\n+            <WebView\r\n+              scrollEnabled\r\n+              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n+              pointerEvents={\"auto\"}\r\n+              originWhitelist={[\"*\"]}\r\n+              source={{ html: mapHtml }}\r\n+              javaScriptEnabled\r\n+              allowFileAccess\r\n+              onLoadEnd={() => setMapReady(true)}\r\n+              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n+              mixedContentMode=\"always\"\r\n+              onMessage={handleMapMessage}\r\n+              nestedScrollEnabled\r\n+            />\r\n+          )}\r\n+\r\n+          {/* Search & quick toggles */}\r\n+          <View style={styles.searchcont}>\r\n+            <View style={styles.searchWrap}>\r\n+              <TextInput\r\n+                value={query}\r\n+                onChangeText={onChangeQuery}\r\n+                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n+                placeholderTextColor=\"#777\"\r\n+                style={styles.searchInput}\r\n+              />\r\n+              {hits.length > 0 && (\r\n+                <View style={styles.searchResults}>\r\n+                  {hits.map((h, i) => (\r\n+                    <TouchableOpacity key={`${h.lat},${h.lng}-${i}`} onPress={() => choosePlace(h)} style={styles.searchItem}>\r\n+                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n+                    </TouchableOpacity>\r\n+                  ))}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {/* Book-for-others toggle */}\r\n+            <View style={{ flexDirection: 'row', gap: 8, marginTop: 8, alignItems: 'center' }}>\r\n+              <TouchableOpacity\r\n+                onPress={() => {\r\n+                  const next = !bookedFor;\r\n+                  setBookedFor(next);\r\n+                  if (next) {\r\n+                    setSelectMode('pickup');\r\n+                    Alert.alert(\"Book for someone else\", \"Tap the map to set the rider‚Äôs PICKUP, then tap again to set DESTINATION.\");\r\n+                  } else {\r\n+                    // reset custom pickup when turning off\r\n+                    setCustomPickup(null);\r\n+                    setRiderName(\"\"); setRiderPhone(\"\");\r\n+                    setSelectMode('dest');\r\n+                    // re-pin blue marker back to GPS if available\r\n+                    if (location) ensureUserMarker(location.latitude, location.longitude);\r\n+                  }\r\n+                }}\r\n+                style={[styles.toggleChip, bookedFor && styles.toggleChipActive]}\r\n+              >\r\n+                <Text style={[styles.toggleChipText, bookedFor && styles.toggleChipTextActive]}>\r\n+                  {bookedFor ? \"‚úì Book for someone else\" : \"Book for someone else\"}\r\n+                </Text>\r\n+              </TouchableOpacity>\r\n+\r\n+              {bookedFor && (\r\n+                <View style={{ flexDirection:'row', gap:8 }}>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => setSelectMode('pickup')}\r\n+                    style={[styles.modeChip, selectMode==='pickup' && styles.modeChipActive]}\r\n+                  >\r\n+                    <Text style={[styles.modeChipText, selectMode==='pickup' && styles.modeChipTextActive]}>Pick Pickup</Text>\r\n+                  </TouchableOpacity>\r\n+                  <TouchableOpacity\r\n+                    onPress={() => setSelectMode('dest')}\r\n+                    style={[styles.modeChip, selectMode==='dest' && styles.modeChipActive]}\r\n+                  >\r\n+                    <Text style={[styles.modeChipText, selectMode==='dest' && styles.modeChipTextActive]}>Pick Destination</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+          </View>\r\n+\r\n+          <View style={styles.overlayContainer}>\r\n+            <View style={styles.overlay}>\r\n+\r\n+              {searching && (\r\n+                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n+                  <Text style={{ fontWeight: \"bold\" }}>\r\n+                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n+                  </Text>\r\n+                  <TouchableOpacity onPress={cancelRideNow} style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}>\r\n+                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              )}\r\n+\r\n+              {matchedDriver && (\r\n+                <View style={{ position: \"absolute\", bottom: -100, left: 0, right: 0, marginHorizontal: 20, backgroundColor: \"#d1fcd3\", borderRadius: 10, padding: 10, elevation: 3 }}>\r\n+                  <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n+                    {driverSelfieUri ? (\r\n+                      <Image source={{ uri: driverSelfieUri }} style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }} resizeMode=\"cover\" />\r\n+                    ) : null}\r\n+                    <View style={{ flex: 1 }}>\r\n+                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n+                      <Text>Name: {matchedDriver?.driverName}</Text>\r\n+                      <Text>Franchise No.: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n+                      <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n+                    </View>\r\n+                  </View>\r\n+\r\n+                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10, gap: 10 }}>\r\n+                    <TouchableOpacity onPress={() => router.push({ pathname: \"/ChatRoom\", params: { bookingId, driverId: matchedDriver?.driverId, passengerId, role: \"passenger\" }})} style={{ backgroundColor: \"#007bff\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n+                      <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n+                    </TouchableOpacity>\r\n+                    <TouchableOpacity onPress={() => setShowRatingModal(false)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n+                      <Text style={{ color: \"white\" }}>Minimize</Text>\r\n+                    </TouchableOpacity>\r\n+                    <TouchableOpacity onPress={cancelRideNow} style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n+                      <Text style={{ color: \"white\" }}>Cancel</Text>\r\n+                    </TouchableOpacity>\r\n+                  </View>\r\n+\r\n+                  {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n+                    <View style={{paddingTop:5}}>\r\n+                      <View style={{flexDirection:\"row\", justifyContent:\"space-between\"}}>\r\n+                        <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n+                        <Text> Status: <Text style={{ fontWeight: \"700\" }}>{paymentInfo?.paymentStatus || \"none\"}</Text></Text>\r\n+                      </View>\r\n+                      <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n+                        <TouchableOpacity onPress={handleCopy}>\r\n+                          <Text>Number: <Text style={{ fontWeight: '600' }}>{paymentInfo.driverPayment?.number}</Text></Text>\r\n+                          <Text style={{ fontSize: 12, color: '#666' }}>Tap to copy</Text>\r\n+                        </TouchableOpacity>\r\n+                        <TouchableOpacity onPress={() => bookingId && setPaymentStatus(String(bookingId), \"paid\")} disabled={paymentInfo?.paymentStatus === \"paid\"} style={{ backgroundColor: paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5 }}>\r\n+                          <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>{paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}</Text>\r\n+                        </TouchableOpacity>\r\n+                      </View>\r\n+                    </View>\r\n+                  )}\r\n+                </View>\r\n+              )}\r\n+            </View>\r\n+\r\n+            {showBookingForm && (\r\n+              <View style={styles.panel}>\r\n+                <Text style={styles.panelTitle}>Booking Details</Text>\r\n+\r\n+                {/* Booking Type */}\r\n+                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n+                  {[\r\n+                    { key: 'CLASSIC', label: 'Classic' },\r\n+                    { key: 'GROUP', label: 'Group' },\r\n+                    { key: 'SOLO', label: 'Solo' },\r\n+                  ].map((opt) => {\r\n+                    const active = bookingType === (opt.key as any);\r\n+                    return (\r\n+                      <TouchableOpacity\r\n+                        key={opt.key}\r\n+                        onPress={() => { setBookingType(opt.key as any); if (opt.key !== 'GROUP') setPartySize(2); }}\r\n+                        style={{ flex: 1, backgroundColor: active ? '#111' : '#fff', borderWidth: 1, borderColor: active ? '#111' : '#ccc', paddingVertical: 10, borderRadius: 10, alignItems: 'center' }}\r\n+                      >\r\n+                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>{opt.label}</Text>\r\n+                      </TouchableOpacity>\r\n+                    );\r\n+                  })}\r\n+                </View>\r\n+\r\n+                {bookingType === 'SOLO' && <Text style={{ marginTop: 6, color: '#444' }}>‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.</Text>}\r\n+                {bookingType === 'GROUP' && <Text style={{ marginTop: 6, color: '#444' }}>‚Ä¢ Group ride ‚Äî specify how many passengers (including you).</Text>}\r\n+\r\n+                {bookingType === 'GROUP' && (\r\n+                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n+                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n+                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n+                      <TouchableOpacity onPress={() => setPartySize((p) => Math.max(2, p - 1))} style={styles.stepBtn}><Text style={{ fontSize: 18 }}>‚Äì</Text></TouchableOpacity>\r\n+                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n+                      <TouchableOpacity onPress={() => setPartySize((p) => Math.min(6, p + 1))} style={styles.stepBtn}><Text style={{ fontSize: 18 }}>Ôºã</Text></TouchableOpacity>\r\n+                    </View>\r\n+                  </View>\r\n+                )}\r\n+\r\n+                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n+                  <Text>From:</Text>\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder={bookedFor ? \"Tap the map to set pickup\" : \"GPS pickup\"}\r\n+                    value={pickupName}\r\n+                    editable={false}\r\n+                  />\r\n+\r\n+                  <Text>To:</Text>\r\n+                  <TextInput\r\n+                    style={styles.input}\r\n+                    placeholder=\"Tap the map or search\"\r\n+                    value={dropoffName}\r\n+                    editable={false}\r\n+                  />\r\n+\r\n+                  {bookedFor && (\r\n+                    <>\r\n+                      <Text>Rider Name (required):</Text>\r\n+                      <TextInput style={styles.input} placeholder=\"Juan Dela Cruz\" value={riderName} onChangeText={setRiderName} />\r\n+                      <Text>Rider Phone (optional):</Text>\r\n+                      <TextInput style={styles.input} placeholder=\"09xxxxxxxxx\" keyboardType=\"phone-pad\" value={riderPhone} onChangeText={setRiderPhone} />\r\n+                    </>\r\n+                  )}\r\n+\r\n+                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n+                  <Text>Paano ka magbabayad?</Text>\r\n+                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n+                    <TouchableOpacity onPress={() => setPaymentMethod(\"Cash\")} style={[styles.paymentOption, paymentMethod === \"Cash\" && styles.paymentSelected]}>\r\n+                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n+                    </TouchableOpacity>\r\n+                    <TouchableOpacity onPress={() => setPaymentMethod(\"GCash\")} style={[styles.paymentOption, paymentMethod === \"GCash\" && styles.paymentSelected]}>\r\n+                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n+                    </TouchableOpacity>\r\n+                  </View>\r\n+                </ScrollView>\r\n+\r\n+                <View style={styles.fareContainer}>\r\n+                  <View>\r\n+                    <Text style={styles.totalFare}>Fare:</Text>\r\n+                    <Text style={{ paddingLeft: 20 }}>‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}</Text>\r\n+                    <Text style={styles.totalFare}>Total Fare: ‚Ç±{bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}</Text>\r\n+                  </View>\r\n+                  <TouchableOpacity\r\n+                    style={[styles.bookButton, ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination || (bookedFor && !customPickup)) && { opacity: 0.4 }]}\r\n+                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination || (bookedFor && !customPickup)}\r\n+                    onPress={handleBookNow}\r\n+                  >\r\n+                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+\r\n+            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n+              <TouchableOpacity onPress={() => setShowBookingForm(true)} style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}>\r\n+                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n+              </TouchableOpacity>\r\n+            )}\r\n+\r\n+            {/* Rating modal (kept) */}\r\n+            {showRatingModal && (\r\n+              <View style={styles.ratingModalOverlay}>\r\n+                <View style={styles.ratingModal}>\r\n+                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n+                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n+                  </TouchableOpacity>\r\n+                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n+                  <View style={styles.starsContainer}>\r\n+                    {[1,2,3,4,5].map((star)=>(\r\n+                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n+                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n+                      </TouchableOpacity>\r\n+                    ))}\r\n+                  </View>\r\n+                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n+                  <TouchableOpacity style={styles.submitButton} onPress={async () => {\r\n+                    try {\r\n+                      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n+                      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n+                      if (!driverIdToRate || !bookingIdToRate) { Alert.alert(\"Error\",\"No driver/booking to rate.\"); return; }\r\n+                      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n+                        method: \"POST\", headers: { \"Content-Type\": \"application/json\" },\r\n+                        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n+                      });\r\n+                      if (res.ok && notes) {\r\n+                        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n+                          method: \"POST\", headers: { \"Content-Type\": \"application/json\" },\r\n+                          body: JSON.stringify({ bookingId: bookingIdToRate, passengerId: await AsyncStorage.getItem(\"passengerId\"), driverId: driverIdToRate, feedback: notes }),\r\n+                        });\r\n+                      }\r\n+                      if (res.ok) {\r\n+                        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n+                        setShowRatingModal(false);\r\n+                        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n+                        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n+                      } else {\r\n+                        const data = await res.json();\r\n+                        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n+                      }\r\n+                    } catch { Alert.alert(\"Error\",\"Something went wrong.\"); }\r\n+                  }}>\r\n+                    <Text style={styles.submitButtonText}>Submit</Text>\r\n+                  </TouchableOpacity>\r\n+                </View>\r\n+              </View>\r\n+            )}\r\n+          </View>\r\n+        </View>\r\n+      </TouchableWithoutFeedback>\r\n+    </KeyboardAvoidingView>\r\n+  );\r\n+}\r\n+\r\n+const styles = StyleSheet.create({\r\n+  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n+  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n+  overlay: { width: width, margin: 60 },\r\n+  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"flex-start\", marginLeft: 20},\r\n+  searchWrap: { width: '90%', alignSelf: 'center', zIndex: 20 },\r\n+  searchInput: { backgroundColor: '#FFF', borderRadius: 10, borderWidth: 1, borderColor: '#ddd', padding: 10 },\r\n+  searchResults: { marginTop: 4, backgroundColor: '#FFF', borderRadius: 10, borderWidth: 1, borderColor: '#ddd', maxHeight: 200, overflow: 'hidden' },\r\n+  searchItem: { paddingVertical: 10, paddingHorizontal: 12, borderBottomWidth: 1, borderBottomColor: '#eee' },\r\n+  searchItemText: { color: '#111' },\r\n+\r\n+  toggleChip: { backgroundColor:'#eee', paddingHorizontal:10, paddingVertical:6, borderRadius:10 },\r\n+  toggleChipActive: { backgroundColor:'#111' },\r\n+  toggleChipText: { color:'#111', fontWeight:'600' },\r\n+  toggleChipTextActive: { color:'#fff' },\r\n+\r\n+  modeChip: { backgroundColor:'#eee', paddingHorizontal:10, paddingVertical:6, borderRadius:10 },\r\n+  modeChipActive: { backgroundColor:'#81C3E1' },\r\n+  modeChipText: { color:'#111', fontWeight:'600' },\r\n+  modeChipTextActive: { color:'#fff' },\r\n+\r\n+  panel: { position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF', borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10 },\r\n+  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n+  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n+  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n+\r\n+  stepBtn: { paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginHorizontal: 10 },\r\n+\r\n+  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1 },\r\n+  totalFare: { fontWeight: 'bold' },\r\n+  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n+  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n+\r\n+  ratingModalOverlay: { position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10, backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999 },\r\n+  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n+  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n+  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n+  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n+  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n+  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n+  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n+\r\n+  paymentOption: { flex: 1, borderWidth: 1, borderColor: \"#ccc\", paddingVertical: 6, borderRadius: 10, alignItems: \"center\", marginHorizontal: 5, backgroundColor: \"#fff\" },\r\n+  paymentSelected: { backgroundColor: \"#000\", borderColor: \"#333\" },\r\n+  paymentText: { color: \"#333\", fontWeight: \"600\" },\r\n+  paymentSelectedText: { color: \"#fff\", fontWeight: \"700\" },\r\n+});\r\n"
                },
                {
                    "date": 1762772268281,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,1143 +1,8 @@\n import React, { useState, useEffect, useRef } from \"react\";\r\n import { View, \r\n   Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n   TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n-  Keyboard, Image, ScrollView, AppState, Linking  } from \"react-native\";\r\n-import { WebView } from \"react-native-webview\";\r\n-import type { WebView as WebViewType } from \"react-native-webview\";\r\n-import { Ionicons } from \"@expo/vector-icons\";\r\n-import { useLocation } from \"../location/GlobalLocation\";\r\n-import { router } from 'expo-router';\r\n-import AsyncStorage from '@react-native-async-storage/async-storage';\r\n-import { API_BASE_URL } from \"../../config\";\r\n-import * as Location from 'expo-location';\r\n-import { useNavigation, useFocusEffect } from \"@react-navigation/native\";\r\n-import { getAuth } from \"../utils/authStorage\";\r\n-import { Asset } from 'expo-asset';\r\n-import * as FileSystem from 'expo-file-system';\r\n-import * as IntentLauncher from 'expo-intent-launcher';\r\n-import * as Clipboard from 'expo-clipboard';\r\n-\r\n-async function getLocalIconBase64(localPath: any) {\r\n-  const asset = Asset.fromModule(localPath);\r\n-  await asset.downloadAsync();\r\n-  const uri = asset.localUri || asset.uri;\r\n-  const base64 = await FileSystem.readAsStringAsync(uri!, { encoding: 'base64' });\r\n-  return `data:image/png;base64,${base64}`;\r\n-}\r\n-\r\n-// POI icons (keep your assets)\r\n-const POI_ICON_FILES: Record<string, any> = {\r\n-  cafe: require('../../assets/images/pios/cafe.png'),\r\n-  convenience: require('../../assets/images/pios/convenience.png'),\r\n-  pharmacy: require('../../assets/images/pios/pharmacy.png'),\r\n-  bank: require('../../assets/images/pios/bank.png'),\r\n-  supermarket: require('../../assets/images/pios/supermarket.png'),\r\n-  restaurant: require('../../assets/images/pios/restaurant.png'),\r\n-  fast_food: require('../../assets/images/pios/restaurant.png'),\r\n-  hospital: require('../../assets/images/pios/hospital.png'),\r\n-  school: require('../../assets/images/pios/school.png'),\r\n-  market: require('../../assets/images/pios/market.png'),\r\n-  parking: require('../../assets/images/pios/parking.png'),\r\n-};\r\n-\r\n-const { width } = Dimensions.get(\"window\");\r\n-type DiscountType = 'none' | 'senior' | 'student' | 'pwd';\r\n-\r\n-const calculateFare = (distanceKm: number, discount: DiscountType = 'none') => {\r\n-  if (!isFinite(distanceKm) || distanceKm <= 0) return 0;\r\n-  const BASE_FARE = 20;\r\n-  const INCLUDED_KM = 2;\r\n-  const PER_KM = 5;\r\n-  const succeedingWholeKm = Math.max(0, Math.floor(distanceKm - INCLUDED_KM));\r\n-  let fare = BASE_FARE + succeedingWholeKm * PER_KM;\r\n-  if (discount !== 'none') fare *= 0.8;\r\n-  return Math.round(fare);\r\n-};\r\n-\r\n-async function ensureLocationEnabled() {\r\n-  const services = await Location.hasServicesEnabledAsync();\r\n-  const perm = await Location.getForegroundPermissionsAsync();\r\n-  if (!services || perm.status !== 'granted') {\r\n-    Alert.alert(\r\n-      \"Enable Location\",\r\n-      \"We need your location for live tracking. Please enable GPS and grant permission.\",\r\n-      [\r\n-        { text: \"Cancel\", style: \"cancel\" },\r\n-        {\r\n-          text: \"Open Settings\",\r\n-          onPress: () => {\r\n-            if (Platform.OS === 'android') IntentLauncher.startActivityAsync(IntentLauncher.ActivityAction.LOCATION_SOURCE_SETTINGS);\r\n-            else Linking.openURL('app-settings:');\r\n-          }\r\n-        }\r\n-      ]\r\n-    );\r\n-    return false;\r\n-  }\r\n-  return true;\r\n-}\r\n-\r\n-export default function PHome() {\r\n-  // ---------- session ----------\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      try {\r\n-        const auth = await getAuth();\r\n-        if (auth?.role === \"passenger\" && auth?.userId) {\r\n-          setPassengerId(String(auth.userId));\r\n-          return;\r\n-        }\r\n-        const legacy = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (legacy) { setPassengerId(legacy); return; }\r\n-        Alert.alert(\"Session expired\", \"Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      } catch {\r\n-        Alert.alert(\"Error\", \"Could not load your session. Please log in again.\");\r\n-        router.replace(\"/login_and_reg/plogin\");\r\n-      }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  // ---------- map & geoloc ----------\r\n-  const { location, loading } = useLocation();\r\n-  const [mapHtml, setMapHtml] = useState(\"\");\r\n-  const mapRef = useRef<WebViewType>(null);\r\n-  const [mapReady, setMapReady] = useState(false);\r\n-  const messageQueue = useRef<any[]>([]);\r\n-  const sendToMap = (msg: any) => {\r\n-    const json = JSON.stringify(msg);\r\n-    if (!mapReady || !mapRef.current) { messageQueue.current.push(json); return; }\r\n-    mapRef.current.postMessage(json);\r\n-  };\r\n-\r\n-  // ---------- feature: Book for Someone Else ----------\r\n-  const [bookedFor, setBookedFor] = useState(false);\r\n-  const [riderName, setRiderName] = useState(\"\");\r\n-  const [riderPhone, setRiderPhone] = useState(\"\");\r\n-  const [selectMode, setSelectMode] = useState<'pickup' | 'dest'>('dest'); // which point the next tap sets\r\n-  const [customPickup, setCustomPickup] = useState<{ latitude:number; longitude:number } | null>(null);\r\n-\r\n-  // ---------- trip inputs ----------\r\n-  const [destination, setDestination] = useState<{ latitude: number; longitude: number } | null>(null);\r\n-  const [pickupName, setPickupName] = useState(\"\");\r\n-  const [dropoffName, setDropoffName] = useState(\"\");\r\n-  const [destinationLabel, setDestinationLabel] = useState(\"\");\r\n-\r\n-  const [notes, setNotes] = useState(\"\");\r\n-  const [paymentMethod, setPaymentMethod] = useState(\"\");\r\n-  const [fare, setFare] = useState(0);\r\n-  const [discount] = useState<DiscountType>('none');\r\n-  const [query, setQuery] = useState('');\r\n-  const [hits, setHits] = useState<Array<{ label: string; lat: number; lng: number }>>([]);\r\n-  const searchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-\r\n-  // ---------- booking flow ----------\r\n-  const [matchedDriver, setMatchedDriver] = useState<any>(null);\r\n-  const [bookingConfirmed, setBookingConfirmed] = useState(false);\r\n-  const [bookingId, setBookingId] = useState<any>(null);\r\n-  const [showBookingForm, setShowBookingForm] = useState(false);\r\n-  const [searching, setSearching] = useState(false);\r\n-  const searchTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-  const [alertedBookingComplete, setAlertedBookingComplete] = useState(false);\r\n-  const [tripCompleted, setTripCompleted] = useState(false);\r\n-\r\n-  const [showRatingModal, setShowRatingModal] = useState(false);\r\n-  const [selectedRating, setSelectedRating] = useState(0);\r\n-\r\n-  const [reportType, setReportType] = useState(\"\");\r\n-  const [otherReport, setOtherReport] = useState(\"\");\r\n-  const [showDropdown, setShowDropdown] = useState(false);\r\n-\r\n-  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);\r\n-\r\n-  // booking types\r\n-  const [bookingType, setBookingType] = useState<'CLASSIC' | 'GROUP' | 'SOLO'>('CLASSIC');\r\n-  const [partySize, setPartySize] = useState<number>(2);\r\n-\r\n-  const [keyboardOffset, setKeyboardOffset] = useState(0);\r\n-\r\n-  // POIs/landmarks infra (kept)\r\n-  const [showLandmarks, setShowLandmarks] = useState(false);\r\n-  const [showPOIs, setShowPOIs] = useState(false);\r\n-  const [iconData, setIconData] = useState<Record<string, string> | null>(null);\r\n-  const lastCenterRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const poiCacheRef = useRef<Map<string, any[]>>(new Map());\r\n-  const inflightRef  = useRef<Set<string>>(new Set());\r\n-  const lastReqIdRef = useRef(0);\r\n-  const lastBBoxRef = useRef<{ minLng:number; minLat:number; maxLng:number; maxLat:number; zoom:number } | null>(null);\r\n-  const lastPoiKeyRef = useRef<string>('');\r\n-  const poiFetchTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\r\n-\r\n-  // routing helpers/state\r\n-  const userMarkerOkRef = useRef(false);\r\n-  const [livePos, setLivePos] = useState<{latitude:number; longitude:number} | null>(null);\r\n-  const initialLocRef = useRef<{ latitude:number; longitude:number } | null>(null);\r\n-  const routeFramedRef = useRef(false);\r\n-  const lastRouteDestKeyRef = useRef<string | null>(null);\r\n-  const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n-  const lastRouteAtRef   = useRef(0);\r\n-  const ROUTE_MIN_MOVE_M   = 35;\r\n-  const ROUTE_MIN_INTERVAL = 8000;\r\n-\r\n-  const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n-\r\n-  // small utils\r\n-  function haversine(a:{lat:number,lng:number}, b:{lat:number,lng:number}) {\r\n-    const R = 6371000;\r\n-    const toRad = (x:number)=>x*Math.PI/180;\r\n-    const dLat = toRad(b.lat-a.lat);\r\n-    const dLng = toRad(b.lng-a.lng);\r\n-    const s1 = Math.sin(dLat/2)**2 +\r\n-              Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;\r\n-    return 2*R*Math.asin(Math.sqrt(s1));\r\n-  }\r\n-  function roundByZoom(value: number, zoom: number) {\r\n-    const decimals = zoom >= 18 ? 3 : zoom >= 16 ? 3 : zoom >= 15 ? 2 : 2;\r\n-    const m = Math.pow(10, decimals);\r\n-    return Math.round(value * m) / m;\r\n-  }\r\n-\r\n-  // origin resolver (GPS vs custom pickup)\r\n-  const resolveOrigin = () => {\r\n-    if (bookedFor && customPickup) return customPickup;\r\n-    return location ? { latitude: location.latitude, longitude: location.longitude } : null;\r\n-  };\r\n-\r\n-  // ensure blue marker\r\n-  function ensureUserMarker(lat: number, lng: number) {\r\n-    let attempts = 0;\r\n-    userMarkerOkRef.current = false;\r\n-    const tryOnce = () => {\r\n-      attempts += 1;\r\n-      sendToMap({ type: 'ensureUserMarker', latitude: lat, longitude: lng });\r\n-      if (!userMarkerOkRef.current && attempts < 6) setTimeout(tryOnce, 400);\r\n-    };\r\n-    tryOnce();\r\n-  }\r\n-\r\n-  const handleCopy = async () => {\r\n-    const n = paymentInfo?.driverPayment?.number;\r\n-    if (!n) return;\r\n-    await Clipboard.setStringAsync(n);\r\n-    Alert.alert(\"Copied\", \"GCash number copied to clipboard.\");\r\n-  };\r\n-\r\n-  // icons preload\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const out: Record<string, string> = {};\r\n-      for (const k of Object.keys(POI_ICON_FILES)) {\r\n-        out[k] = await getLocalIconBase64(POI_ICON_FILES[k]);\r\n-      }\r\n-      setIconData(out);\r\n-    })();\r\n-  }, []);\r\n-  useEffect(() => { if (mapReady && iconData) sendToMap({ type: 'preloadIcons', icons: iconData }); }, [mapReady, iconData]);\r\n-\r\n-  // permission nudges\r\n-  useFocusEffect(React.useCallback(() => { ensureLocationEnabled(); }, []));\r\n-  useEffect(() => { ensureLocationEnabled(); }, []);\r\n-  useEffect(() => {\r\n-    const sub = AppState.addEventListener('change', (s) => { if (s === 'active') ensureLocationEnabled(); });\r\n-    return () => sub.remove();\r\n-  }, []);\r\n-\r\n-  // avatar load (kept)\r\n-  useEffect(() => {\r\n-    (async () => {\r\n-      const fallback = \"https://cdn-icons-png.flaticon.com/512/847/847969.png\";\r\n-      try {\r\n-        const pid = await AsyncStorage.getItem(\"passengerId\");\r\n-        if (!pid) return setAvatarUrl(fallback);\r\n-        const r = await fetch(`${API_BASE_URL}/api/passenger/${pid}`);\r\n-        const j = await r.json();\r\n-        const img = j?.passenger?.profileImage || j?.passenger?.selfieImage || j?.passenger?.avatar;\r\n-        setAvatarUrl(img ? `${API_BASE_URL}/${img}` : fallback);\r\n-      } catch { setAvatarUrl(fallback); }\r\n-    })();\r\n-  }, []);\r\n-\r\n-  // reverse geocode current pickup label\r\n-  useEffect(() => {\r\n-    if (!location) return;\r\n-    Location.reverseGeocodeAsync({ latitude: location.latitude, longitude: location.longitude })\r\n-      .then((results) => {\r\n-        if (results && results.length > 0) {\r\n-          const addr = results[0];\r\n-          setPickupName(`${addr.street || \"\"}${addr.street ? \", \" : \"\"}${addr.city || addr.subregion || \"\"}`);\r\n-        } else setPickupName(\"Current Location\");\r\n-      })\r\n-      .catch(() => setPickupName(\"Current Location\"));\r\n-  }, [location]);\r\n-\r\n-  // map HTML build (unchanged except standard)\r\n-  useEffect(() => {\r\n-    if (!location || mapHtml) return;\r\n-    if (!initialLocRef.current) initialLocRef.current = { latitude: location.latitude, longitude: location.longitude };\r\n-    const { latitude: initLat, longitude: initLng } = initialLocRef.current;\r\n-    const iconJson = JSON.stringify(iconData || {});\r\n-    const html = String.raw`\r\n-<!DOCTYPE html><html><head>\r\n-<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n-<link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.css\" />\r\n-<style>\r\n-html,body,#map{height:100%;margin:0;padding:0}\r\n-.distance-label.leaflet-tooltip{background:rgba(0,0,0,.85);color:#fff;border:none;border-radius:12px;padding:4px 8px;box-shadow:0 1px 4px rgba(0,0,0,.3);font-size:12px;line-height:1;white-space:nowrap}\r\n-.distance-label.leaflet-tooltip:before{display:none}\r\n-</style>\r\n-</head><body>\r\n-<div id=\"map\"></div>\r\n-<script src=\"https://unpkg.com/leaflet@1.9.3/dist/leaflet.js\"></script>\r\n-<script>\r\n-const map = L.map('map',{zoomControl:true,maxBounds:[[13.96,121.643],[13.88,121.588]],maxBoundsViscosity:0.5,minZoom:13,maxZoom:19,noWrap:true}).setView([${initLat},${initLng}],15);\r\n-L.tileLayer('https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=7yQg8w68otDEssrPk9wU',{maxZoom:19,attribution:'¬© OpenStreetMap | ¬© MapTiler'}).addTo(map);\r\n-\r\n-let userMarker=null,destMarker=null,driverMarker=null,routeLine=null,distanceTooltip=null;\r\n-let destinationLocked=false; // locked when driver present\r\n-function clearRoute(){ if(routeLine){map.removeLayer(routeLine);routeLine=null} if(distanceTooltip){map.removeLayer(distanceTooltip);distanceTooltip=null} }\r\n-\r\n-const userIcon=L.icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',iconSize:[30,30],iconAnchor:[15,30]});\r\n-const destIcon=L.icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',iconSize:[30,30],iconAnchor:[15,30]});\r\n-const carIcon =L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/2972/2972185.png',iconSize:[40,40],iconAnchor:[20,40]});\r\n-\r\n-function upsertUserMarker(lat,lng){ if(!Number.isFinite(lat)||!Number.isFinite(lng))return;\r\n-  if(!userMarker){ userMarker=L.marker([lat,lng],{icon:userIcon,zIndexOffset:1000}).addTo(map).bindTooltip({permanent:true,direction:\"top\"}); }\r\n-  else userMarker.setLatLng([lat,lng]);\r\n-}\r\n-function setDestination(lat,lng){ if(destMarker){map.removeLayer(destMarker);destMarker=null}\r\n-  destMarker=L.marker([lat,lng],{icon:destIcon}).addTo(map).bindTooltip(\"Destination\",{permanent:true,direction:\"top\"});\r\n-}\r\n-function setDriver(lat,lng){ if(driverMarker){map.removeLayer(driverMarker);driverMarker=null}\r\n-  if(Number.isFinite(lat)&&Number.isFinite(lng)){ driverMarker=L.marker([lat,lng],{icon:carIcon}).addTo(map).bindTooltip(\"üöï Driver\",{permanent:true,direction:\"top\"}).setZIndexOffset(1100); }\r\n-}\r\n-\r\n-// map click ‚Üí RN decides whether it's pickup or destination\r\n-map.on('click', (e)=>{ const {lat,lng}=e.latlng;\r\n-  window.ReactNativeWebView?.postMessage(JSON.stringify({ type:'mapClick', lat, lng }));\r\n-});\r\n-\r\n-// message bridge\r\n-document.addEventListener('message', (ev)=>{\r\n-  let msg={}; try{ msg=JSON.parse(ev.data||'{}') }catch{return}\r\n-  if(msg.type==='ensureUserMarker'){ const {latitude,longitude}=msg; upsertUserMarker(latitude,longitude);\r\n-    window.ReactNativeWebView?.postMessage(JSON.stringify({type:'userMarkerEnsured',placed:!!userMarker})); return; }\r\n-  if(msg.type==='updateUserLoc'){ const {latitude,longitude}=msg; if(Number.isFinite(latitude)&&Number.isFinite(longitude)) upsertUserMarker(latitude,longitude); return; }\r\n-  if(msg.type==='drawRoute' && Array.isArray(msg.route) && msg.route.length){\r\n-    clearRoute(); routeLine=L.polyline(msg.route,{weight:4,color:'#1a73e8'}).addTo(map);\r\n-    if(msg.reframe){ map.fitBounds(routeLine.getBounds(),{padding:[50,50]}); }\r\n-    const mid=msg.route[Math.floor(msg.route.length/2)];\r\n-    const label=[msg.distanceText,msg.durationText,msg.fareText].filter(Boolean).join(' ‚Ä¢ ');\r\n-    distanceTooltip=L.tooltip({permanent:true,direction:'top',offset:[0,-6],className:'distance-label'}).setContent(label||'').setLatLng(mid).addTo(map);\r\n-    return;\r\n-  }\r\n-  if(msg.type==='clearRoute'){ clearRoute(); return; }\r\n-  if(msg.type==='setMarkers'){\r\n-    destinationLocked=!!msg.driver;\r\n-    if(msg.destination && Number.isFinite(msg.destination.latitude) && Number.isFinite(msg.destination.longitude)) setDestination(msg.destination.latitude,msg.destination.longitude);\r\n-    else if(destMarker){ map.removeLayer(destMarker); destMarker=null; }\r\n-    if(msg.driver && Number.isFinite(msg.driver.latitude) && Number.isFinite(msg.driver.longitude)) setDriver(msg.driver.latitude,msg.driver.longitude);\r\n-    else if(driverMarker){ map.removeLayer(driverMarker); driverMarker=null; }\r\n-    return;\r\n-  }\r\n-});\r\n-</script>\r\n-</body></html>`;\r\n-    setMapHtml(html);\r\n-  }, [mapHtml, location, iconData]);\r\n-\r\n-  // flush queued map messages\r\n-  useEffect(() => {\r\n-    if (mapReady && mapRef.current && messageQueue.current.length) {\r\n-      messageQueue.current.forEach((m) => mapRef.current?.postMessage(m));\r\n-      messageQueue.current = [];\r\n-    }\r\n-  }, [mapReady]);\r\n-\r\n-  // after map ready, show initial marker (customPickup when bookedFor else GPS)\r\n-  useEffect(() => {\r\n-    const origin = resolveOrigin();\r\n-    if (mapReady && origin) ensureUserMarker(origin.latitude, origin.longitude);\r\n-  }, [mapReady]);\r\n-\r\n-  // live GPS watcher ‚Äì disabled while bookedFor so we don't overwrite custom pickup\r\n-  useEffect(() => {\r\n-    let sub: Location.LocationSubscription | null = null;\r\n-    (async () => {\r\n-      const { status } = await Location.requestForegroundPermissionsAsync();\r\n-      if (status !== \"granted\") return;\r\n-      sub = await Location.watchPositionAsync(\r\n-        { accuracy: Location.Accuracy.Balanced, timeInterval: 5000, distanceInterval: 5 },\r\n-        (pos) => {\r\n-          if (bookedFor) return; // üîí don't send user GPS while booking for others\r\n-          const { latitude, longitude } = pos.coords;\r\n-          setLivePos({ latitude, longitude });\r\n-          sendToMap({ type: \"updateUserLoc\", latitude, longitude, accuracy: 15, avatarUrl });\r\n-          // nudge route start if previewing self-ride\r\n-          if (destination && !bookedFor) {\r\n-            const nowFrom = { lat: latitude, lng: longitude };\r\n-            const movedM = haversine(lastRouteFromRef.current ?? nowFrom, nowFrom);\r\n-            const now = Date.now();\r\n-            if (movedM >= ROUTE_MIN_MOVE_M || (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL) {\r\n-              fetchORSRoute({ latitude, longitude }, destination, false);\r\n-              lastRouteFromRef.current = nowFrom;\r\n-              lastRouteAtRef.current = now;\r\n-            }\r\n-          }\r\n-        }\r\n-      );\r\n-    })();\r\n-    return () => sub?.remove();\r\n-  }, [avatarUrl, bookedFor, destination]);\r\n-\r\n-  // reverse geocode helper\r\n-  const reverseName = async (lat: number, lng: number) => {\r\n-    try {\r\n-      const results = await Location.reverseGeocodeAsync({ latitude: lat, longitude: lng });\r\n-      if (results && results.length > 0) {\r\n-        const a = results[0];\r\n-        return `${a.street || \"\"}${a.street ? \", \" : \"\"}${a.city || a.subregion || \"\"}` || \"Selected Location\";\r\n-      }\r\n-    } catch {}\r\n-    return \"Selected Location\";\r\n-  };\r\n-\r\n-  // route draw\r\n-  const routeReqIdRef = useRef(0);\r\n-  const fetchORSRoute = async (\r\n-    from: { latitude: number; longitude: number },\r\n-    to:   { latitude: number; longitude: number },\r\n-    reframe: boolean = false\r\n-  ) => {\r\n-    const myReqId = ++routeReqIdRef.current;\r\n-    try {\r\n-      const res = await fetch(`${API_BASE_URL}/api/route`, {\r\n-        method: 'POST',\r\n-        headers: { 'Content-Type': 'application/json' },\r\n-        body: JSON.stringify({ start: [from.longitude, from.latitude], end: [to.longitude, to.latitude] }),\r\n-      });\r\n-      const data = await res.json();\r\n-      if (!res.ok || !data?.features?.[0]?.geometry?.coordinates) return;\r\n-      if (myReqId !== routeReqIdRef.current) return;\r\n-      const coords = data.features[0].geometry.coordinates; // [lng,lat]\r\n-      const polylinePoints = coords.map(([lng, lat]: number[]) => [lat, lng]);\r\n-\r\n-      const summary    = data.features?.[0]?.properties?.summary || {};\r\n-      const distanceM  = summary.distance ?? 0;\r\n-      const durationS  = summary.duration ?? 0;\r\n-      const distanceKm = distanceM / 1000;\r\n-\r\n-      const distanceText = `${distanceKm.toFixed(2)} km`;\r\n-      const mins         = Math.round(durationS / 60);\r\n-      const durationText = mins >= 60 ? `${Math.floor(mins/60)}h ${mins%60}m` : `${mins} min`;\r\n-      const computedFare = calculateFare(distanceKm, discount);\r\n-      setFare(computedFare);\r\n-\r\n-      sendToMap({\r\n-        type: 'drawRoute',\r\n-        route: polylinePoints,\r\n-        distanceKm,\r\n-        distanceText,\r\n-        durationText,\r\n-        fareText: `‚Ç±${computedFare} est`,\r\n-        reframe,\r\n-      });\r\n-    } catch {}\r\n-  };\r\n-\r\n-  // when destination selected and origin known ‚Üí draw preview route\r\n-  useEffect(() => {\r\n-    if (!destination) return;\r\n-    const origin = resolveOrigin();\r\n-    if (!origin) return;\r\n-    const destKey = `${destination.latitude.toFixed(6)},${destination.longitude.toFixed(6)}`;\r\n-    if (lastRouteDestKeyRef.current !== destKey) {\r\n-      fetchORSRoute(origin, destination, true);\r\n-      routeFramedRef.current = true;\r\n-      lastRouteDestKeyRef.current = destKey;\r\n-      lastOriginRef.current = { lat: origin.latitude, lng: origin.longitude };\r\n-    }\r\n-  }, [destination, bookedFor, customPickup, location]);\r\n-\r\n-  // search box (destination search)\r\n-  const onChangeQuery = (t: string) => {\r\n-    setQuery(t);\r\n-    if (searchTimerRef.current) clearTimeout(searchTimerRef.current);\r\n-    searchTimerRef.current = setTimeout(async () => {\r\n-      if (!t || t.length < 3) { setHits([]); return; }\r\n-      const origin = resolveOrigin();\r\n-      if (!origin) { setHits([]); return; }\r\n-      try {\r\n-        const lat = origin.latitude, lng = origin.longitude;\r\n-        const url = `${API_BASE_URL}/api/places-search?q=${encodeURIComponent(t)}&lat=${lat}&lng=${lng}`;\r\n-        const r = await fetch(url);\r\n-        const data = await r.json();\r\n-        setHits(Array.isArray(data) ? data : []);\r\n-      } catch { setHits([]); }\r\n-    }, 300);\r\n-  };\r\n-\r\n-  // choose from search ‚Üí destination\r\n-  const choosePlace = (p: { label: string; lat: number; lng: number }) => {\r\n-    setQuery(p.label); setHits([]);\r\n-    const dest = { latitude: p.lat, longitude: p.lng };\r\n-    setDestination(dest); setDropoffName(p.label);\r\n-    const origin = resolveOrigin();\r\n-    if (!origin) {\r\n-      Alert.alert('Location unavailable', 'Waiting for GPS or set pickup first.');\r\n-      return;\r\n-    }\r\n-    fetchORSRoute(origin, dest, true);\r\n-    sendToMap({ type: 'setMarkers', destination: dest, driver: null });\r\n-  };\r\n-\r\n-  // map messages\r\n-  const handleMapMessage = async (event: any) => {\r\n-    try {\r\n-      const parsed = JSON.parse(event.nativeEvent.data);\r\n-      if (parsed.type === 'userMarkerEnsured') { userMarkerOkRef.current = !!parsed.placed; return; }\r\n-      if (parsed.type === 'mapClick' && Number.isFinite(parsed.lat) && Number.isFinite(parsed.lng)) {\r\n-        const lat = parsed.lat, lng = parsed.lng;\r\n-        if (bookedFor && selectMode === 'pickup') {\r\n-          // set custom pickup\r\n-          setCustomPickup({ latitude: lat, longitude: lng });\r\n-          const name = await reverseName(lat, lng);\r\n-          setPickupName(name);\r\n-          // place blue marker at custom pickup\r\n-          sendToMap({ type: 'updateUserLoc', latitude: lat, longitude: lng });\r\n-          // after choosing pickup, auto-switch to destination mode\r\n-          setSelectMode('dest');\r\n-          // draw route if destination already set\r\n-          if (destination) fetchORSRoute({ latitude: lat, longitude: lng }, destination, true);\r\n-          return;\r\n-        }\r\n-        // else it's a destination tap\r\n-        const dest = { latitude: lat, longitude: lng };\r\n-        setDestination(dest);\r\n-        const label = await reverseName(lat, lng);\r\n-        setDropoffName(label);\r\n-        const origin = resolveOrigin();\r\n-        if (!origin) { Alert.alert('Set pickup first', 'Tap the map to choose pickup.'); return; }\r\n-        fetchORSRoute(origin, dest, true);\r\n-        sendToMap({ type: 'setMarkers', destination: dest, driver: null });\r\n-        return;\r\n-      }\r\n-      if (parsed.type === 'bbox' && parsed.bbox) {\r\n-        // (POI logic kept out to keep this focused)\r\n-        lastBBoxRef.current = { ...parsed.bbox, zoom: Number(parsed.zoom) || 0 };\r\n-        return;\r\n-      }\r\n-    } catch {}\r\n-  };\r\n-\r\n-  // payment polling (kept)\r\n-  const [paymentInfo, setPaymentInfo] = useState<{ paymentMethod?: string; paymentStatus?: \"none\"|\"awaiting\"|\"paid\"|\"failed\"; driverPayment?: { number?: string; qrUrl?: string|null } } | null>(null);\r\n-  const loadPaymentInfo = async (id: string) => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-info`);\r\n-      const j = await r.json();\r\n-      if (j?.ok) setPaymentInfo({ paymentMethod: j.paymentMethod, paymentStatus: j.paymentStatus, driverPayment: j.driverPayment || {} });\r\n-    } catch {}\r\n-  };\r\n-  const setPaymentStatus = async (id: string, status: \"paid\"|\"failed\") => {\r\n-    try {\r\n-      const r = await fetch(`${API_BASE_URL}/api/booking/${id}/payment-status`, {\r\n-        method: \"POST\", headers: { \"Content-Type\":\"application/json\" }, body: JSON.stringify({ status }),\r\n-      });\r\n-      const j = await r.json();\r\n-      if (j?.ok) setPaymentInfo((p)=> p ? { ...p, paymentStatus: status } : p);\r\n-    } catch {}\r\n-  };\r\n-\r\n-  // DEST & ORIGIN auto recompute on live GPS ‚Äî disabled when bookedFor\r\n-  useEffect(() => {\r\n-    if (!location || !destination || bookedFor) return;\r\n-    const now = Date.now();\r\n-    const fromLL = { lat: location.latitude, lng: location.longitude };\r\n-    const toLL   = { lat: destination.latitude, lng: destination.longitude };\r\n-    const movedM = haversine(lastRouteFromRef.current ?? fromLL, fromLL);\r\n-    const should = movedM >= ROUTE_MIN_MOVE_M || (now - lastRouteAtRef.current) >= ROUTE_MIN_INTERVAL;\r\n-    if (should) {\r\n-      fetchORSRoute({ latitude: location.latitude, longitude: location.longitude }, destination, false);\r\n-      lastRouteFromRef.current = fromLL; lastRouteToRef.current = toLL; lastRouteAtRef.current = now;\r\n-    }\r\n-  }, [location, destination, bookedFor]);\r\n-\r\n-  // booking submit\r\n-  const handleBookNow = async () => {\r\n-    const origin = resolveOrigin();\r\n-    if (!origin || !destination) {\r\n-      Alert.alert(\"Missing location info\", bookedFor ? \"Please select pickup and destination.\" : \"Please pick a destination.\");\r\n-      return;\r\n-    }\r\n-    if (!passengerId) {\r\n-      Alert.alert(\"Not logged in\", \"Please log in again.\");\r\n-      router.replace(\"/login_and_reg/plogin\");\r\n-      return;\r\n-    }\r\n-    if (bookedFor && !riderName.trim()) {\r\n-      Alert.alert(\"Rider name required\", \"Please enter the rider‚Äôs name.\");\r\n-      return;\r\n-    }\r\n-\r\n-    const normalizedParty =\r\n-      bookingType === 'GROUP' ? Math.min(5, Math.max(1, Number(partySize) || 1)) : 1;\r\n-\r\n-    setSearching(true);\r\n-    setAlertedBookingComplete(false);\r\n-    setTripCompleted(false);\r\n-\r\n-    const bookingData = {\r\n-      pickupLat: origin.latitude,\r\n-      pickupLng: origin.longitude,\r\n-      destinationLat: destination.latitude,\r\n-      destinationLng: destination.longitude,\r\n-      fare,\r\n-      paymentMethod,\r\n-      notes,\r\n-      passengerId,\r\n-      pickupPlace: pickupName,\r\n-      destinationPlace: dropoffName,\r\n-      bookingType,\r\n-      partySize: normalizedParty,\r\n-\r\n-      // üîµ new fields\r\n-      bookedFor,\r\n-      riderName: riderName.trim(),\r\n-      riderPhone: riderPhone.trim(),\r\n-    };\r\n-\r\n-    try {\r\n-      if (searchTimeoutRef.current) { clearTimeout(searchTimeoutRef.current); searchTimeoutRef.current = null; }\r\n-      setShowBookingForm(false);\r\n-      setSearching(true);\r\n-\r\n-      const response = await fetch(`${API_BASE_URL}/api/book`, {\r\n-        method: \"POST\",\r\n-        headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify(bookingData),\r\n-      });\r\n-\r\n-      const result = await response.json();\r\n-      if (!response.ok) throw new Error(result.message || \"Something went wrong\");\r\n-      setBookingId(result.booking.bookingId || result.booking.id || result.booking._id);\r\n-    } catch (e: any) {\r\n-      Alert.alert(\"Error\", e?.message || \"Failed to send booking. Please try again.\");\r\n-      setSearching(false);\r\n-    }\r\n-  };\r\n-\r\n-  // poll for driver accept\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForDriverMatch = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        if (!myBooking) return;\r\n-        if (myBooking.status === \"accepted\" && !bookingConfirmed) {\r\n-          setBookingConfirmed(true);\r\n-          setSearching(false);\r\n-          Alert.alert(\"Driver Accepted!\", \"The driver has accepted your ride and is on the way!\");\r\n-          if (bookingId) loadPaymentInfo(String(bookingId));\r\n-          if (myBooking.driverId) {\r\n-            try {\r\n-              const [driverRes, statusRes] = await Promise.all([\r\n-                fetch(`${API_BASE_URL}/api/driver/${myBooking.driverId}`),\r\n-                fetch(`${API_BASE_URL}/api/driver-status/${myBooking.driverId}`)\r\n-              ]);\r\n-              const driverData = await driverRes.json();\r\n-              const statusData = await statusRes.json();\r\n-              if (driverData?.driver) {\r\n-                setMatchedDriver({\r\n-                  driverName: driverData.driver.driverName,\r\n-                  driverId: driverData.driver._id,\r\n-                  franchiseNumber: driverData.driver.franchiseNumber || \"N/A\",\r\n-                  experienceYears: driverData.driver.experienceYears || \"N/A\",\r\n-                  selfieImage: driverData.driver.selfieImage || \"N/A\",\r\n-                  location: statusData.location || null,\r\n-                });\r\n-              }\r\n-            } catch {}\r\n-          }\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForDriverMatch, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  // poll payment info when accepted\r\n-  useEffect(() => {\r\n-    if (!bookingId || !bookingConfirmed) return;\r\n-    const t = setInterval(() => loadPaymentInfo(String(bookingId)), 5000);\r\n-    return () => clearInterval(t);\r\n-  }, [bookingId, bookingConfirmed]);\r\n-\r\n-  // poll for completion\r\n-  useEffect(() => {\r\n-    let interval: any;\r\n-    const pollForBookingCompletion = async () => {\r\n-      if (!bookingId) return;\r\n-      try {\r\n-        const res = await fetch(`${API_BASE_URL}/api/bookings`);\r\n-        const allBookings = await res.json();\r\n-        const myBooking = allBookings.find((b: any) => b && b.id === bookingId);\r\n-        setAlertedBookingComplete(false);\r\n-        setTripCompleted(false);\r\n-        if (myBooking?.status === \"completed\" && !alertedBookingComplete) {\r\n-          setAlertedBookingComplete(true);\r\n-          Alert.alert(\"Booking Completed\", \"The driver has marked this ride as completed.\");\r\n-\r\n-          // reset session for next booking\r\n-          setSearching(false);\r\n-          if (searchTimeoutRef.current) { clearTimeout(searchTimeoutRef.current); searchTimeoutRef.current = null; }\r\n-          setBookingConfirmed(false);\r\n-          setBookingId(null);\r\n-          setMatchedDriver(null);\r\n-          setDestination(null);\r\n-          setTripCompleted(true);\r\n-          setQuery(''); setHits([]);\r\n-          AsyncStorage.removeItem(\"phomeBookingState\").catch(() => {});\r\n-          sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-          sendToMap({ type: \"clearRoute\" });\r\n-          setFare(0);\r\n-\r\n-          // bookedFor UI reset\r\n-          setBookedFor(false);\r\n-          setRiderName(\"\"); setRiderPhone(\"\");\r\n-          setCustomPickup(null);\r\n-          setSelectMode('dest');\r\n-        }\r\n-      } catch {}\r\n-    };\r\n-    interval = setInterval(pollForBookingCompletion, 4000);\r\n-    return () => clearInterval(interval);\r\n-  }, [bookingId]);\r\n-\r\n-  // persist basic UI state\r\n-  useEffect(() => {\r\n-    const saveBookingState = async () => {\r\n-      const bookingState = {\r\n-        destination, destinationLabel, notes, paymentMethod, fare,\r\n-        matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching,\r\n-        bookedFor, riderName, riderPhone, customPickup, pickupName, dropoffName\r\n-      };\r\n-      try { await AsyncStorage.setItem(\"phomeBookingState\", JSON.stringify(bookingState)); }\r\n-      catch {}\r\n-    };\r\n-    saveBookingState();\r\n-  }, [destination, destinationLabel, notes, paymentMethod, fare, matchedDriver, bookingConfirmed, bookingId, showBookingForm, searching, bookedFor, riderName, riderPhone, customPickup, pickupName, dropoffName]);\r\n-\r\n-  // rating modal\r\n-  useEffect(() => { if (tripCompleted) setShowRatingModal(true); }, [tripCompleted]);\r\n-\r\n-  // cancel ride\r\n-  const cancelRideNow = async () => {\r\n-    try {\r\n-      if (!bookingId) return;\r\n-      await fetch(`${API_BASE_URL}/api/cancel-booking`, {\r\n-        method: \"POST\", headers: { \"Content-Type\": \"application/json\" },\r\n-        body: JSON.stringify({ bookingId }),\r\n-      });\r\n-      // UI reset\r\n-      setSearching(false); setBookingId(null); setMatchedDriver(null);\r\n-      setBookingConfirmed(false); setDestination(null);\r\n-      sendToMap({ type: \"setMarkers\", destination: null, driver: null });\r\n-      sendToMap({ type: \"clearRoute\" });\r\n-      await AsyncStorage.removeItem(\"phomeBookingState\");\r\n-      setFare(0);\r\n-      // booked-for reset\r\n-      setBookedFor(false); setRiderName(\"\"); setRiderPhone(\"\"); setCustomPickup(null); setSelectMode('dest');\r\n-    } catch (e) {\r\n-      Alert.alert(\"Cancel error\", \"Could not cancel ride. Check your connection and try again.\");\r\n-    }\r\n-  };\r\n-\r\n-  // minor UI\r\n-  useEffect(() => {\r\n-    const hideSub = Keyboard.addListener(\"keyboardDidHide\", () => setKeyboardOffset(-35));\r\n-    const showSub = Keyboard.addListener(\"keyboardDidShow\", () => setKeyboardOffset(0));\r\n-    return () => { showSub.remove(); hideSub.remove(); };\r\n-  }, []);\r\n-\r\n-  // driver selfie cache-busted url\r\n-  const buildImageUri = (raw?: string, updatedAt?: string | number) => {\r\n-    if (!raw) return null;\r\n-    if (/^https?:\\/\\//i.test(raw)) {\r\n-      const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n-      return `${raw}${raw.includes(\"?\") ? \"&\" : \"?\"}v=${v}`;\r\n-    }\r\n-    const base = API_BASE_URL.replace(/\\/$/, \"\");\r\n-    const path = String(raw).replace(/^\\//, \"\");\r\n-    const v = encodeURIComponent(String(updatedAt ?? Date.now()));\r\n-    return `${base}/${path}?v=${v}`;\r\n-  };\r\n-  const driverSelfieUri = React.useMemo(() => {\r\n-    if (!matchedDriver?.selfieImage) return null;\r\n-    const ver = (matchedDriver as any)?.updatedAt || (matchedDriver as any)?.selfieUpdatedAt || matchedDriver?.driverId || 1;\r\n-    return buildImageUri(matchedDriver.selfieImage, ver);\r\n-  }, [matchedDriver?.selfieImage, (matchedDriver as any)?.updatedAt, matchedDriver?.driverId]);\r\n-\r\n-  // ---------- RENDER ----------\r\n-  return (\r\n-    <KeyboardAvoidingView style={{ flex: 1}} behavior={Platform.OS === \"ios\" ? \"padding\" : undefined} keyboardVerticalOffset={keyboardOffset}>\r\n-      <TouchableWithoutFeedback onPress={Keyboard.dismiss}>\r\n-        <View style={styles.container}>\r\n-          <StatusBar barStyle=\"light-content\" translucent backgroundColor=\"black\" />\r\n-          {mapHtml && (\r\n-            <WebView\r\n-              scrollEnabled\r\n-              ref={(ref) => { if (ref && !mapRef.current) mapRef.current = ref; }}\r\n-              pointerEvents={\"auto\"}\r\n-              originWhitelist={[\"*\"]}\r\n-              source={{ html: mapHtml }}\r\n-              javaScriptEnabled\r\n-              allowFileAccess\r\n-              onLoadEnd={() => setMapReady(true)}\r\n-              style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: -30, zIndex: 0 }}\r\n-              mixedContentMode=\"always\"\r\n-              onMessage={handleMapMessage}\r\n-              nestedScrollEnabled\r\n-            />\r\n-          )}\r\n-\r\n-          {/* Search & quick toggles */}\r\n-          <View style={styles.searchcont}>\r\n-            <View style={styles.searchWrap}>\r\n-              <TextInput\r\n-                value={query}\r\n-                onChangeText={onChangeQuery}\r\n-                placeholder=\"Search destination (e.g., SM Lucena)\"\r\n-                placeholderTextColor=\"#777\"\r\n-                style={styles.searchInput}\r\n-              />\r\n-              {hits.length > 0 && (\r\n-                <View style={styles.searchResults}>\r\n-                  {hits.map((h, i) => (\r\n-                    <TouchableOpacity key={`${h.lat},${h.lng}-${i}`} onPress={() => choosePlace(h)} style={styles.searchItem}>\r\n-                      <Text style={styles.searchItemText}>{h.label}</Text>\r\n-                    </TouchableOpacity>\r\n-                  ))}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {/* Book-for-others toggle */}\r\n-            <View style={{ flexDirection: 'row', gap: 8, marginTop: 8, alignItems: 'center' }}>\r\n-              <TouchableOpacity\r\n-                onPress={() => {\r\n-                  const next = !bookedFor;\r\n-                  setBookedFor(next);\r\n-                  if (next) {\r\n-                    setSelectMode('pickup');\r\n-                    Alert.alert(\"Book for someone else\", \"Tap the map to set the rider‚Äôs PICKUP, then tap again to set DESTINATION.\");\r\n-                  } else {\r\n-                    // reset custom pickup when turning off\r\n-                    setCustomPickup(null);\r\n-                    setRiderName(\"\"); setRiderPhone(\"\");\r\n-                    setSelectMode('dest');\r\n-                    // re-pin blue marker back to GPS if available\r\n-                    if (location) ensureUserMarker(location.latitude, location.longitude);\r\n-                  }\r\n-                }}\r\n-                style={[styles.toggleChip, bookedFor && styles.toggleChipActive]}\r\n-              >\r\n-                <Text style={[styles.toggleChipText, bookedFor && styles.toggleChipTextActive]}>\r\n-                  {bookedFor ? \"‚úì Book for someone else\" : \"Book for someone else\"}\r\n-                </Text>\r\n-              </TouchableOpacity>\r\n-\r\n-              {bookedFor && (\r\n-                <View style={{ flexDirection:'row', gap:8 }}>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => setSelectMode('pickup')}\r\n-                    style={[styles.modeChip, selectMode==='pickup' && styles.modeChipActive]}\r\n-                  >\r\n-                    <Text style={[styles.modeChipText, selectMode==='pickup' && styles.modeChipTextActive]}>Pick Pickup</Text>\r\n-                  </TouchableOpacity>\r\n-                  <TouchableOpacity\r\n-                    onPress={() => setSelectMode('dest')}\r\n-                    style={[styles.modeChip, selectMode==='dest' && styles.modeChipActive]}\r\n-                  >\r\n-                    <Text style={[styles.modeChipText, selectMode==='dest' && styles.modeChipTextActive]}>Pick Destination</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-          </View>\r\n-\r\n-          <View style={styles.overlayContainer}>\r\n-            <View style={styles.overlay}>\r\n-\r\n-              {searching && (\r\n-                <View style={{ backgroundColor: \"#fff3cd\", padding: 10, marginTop: 10, borderRadius: 8 }}>\r\n-                  <Text style={{ fontWeight: \"bold\" }}>\r\n-                    üîç Finding a driver... {bookingType === 'GROUP' ? `Group (${partySize})` : bookingType === 'SOLO' ? 'Solo (VIP)' : 'Classic'}\r\n-                  </Text>\r\n-                  <TouchableOpacity onPress={cancelRideNow} style={{ backgroundColor: \"#f44336\", padding: 10, marginTop: 10, borderRadius: 5 }}>\r\n-                    <Text style={{ color: \"white\", textAlign: \"center\" }}>CANCEL RIDE</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              )}\r\n-\r\n-              {matchedDriver && (\r\n-                <View style={{ position: \"absolute\", bottom: -100, left: 0, right: 0, marginHorizontal: 20, backgroundColor: \"#d1fcd3\", borderRadius: 10, padding: 10, elevation: 3 }}>\r\n-                  <View style={{ flexDirection: \"row\", alignItems: \"center\" }}>\r\n-                    {driverSelfieUri ? (\r\n-                      <Image source={{ uri: driverSelfieUri }} style={{ width: 80, height: 80, borderRadius: 50, marginRight: 10 }} resizeMode=\"cover\" />\r\n-                    ) : null}\r\n-                    <View style={{ flex: 1 }}>\r\n-                      <Text style={{ fontWeight: \"bold\", color: \"#000\" }}>‚úÖ Driver Found!</Text>\r\n-                      <Text>Name: {matchedDriver?.driverName}</Text>\r\n-                      <Text>Franchise No.: {matchedDriver?.franchiseNumber || \"N/A\"}</Text>\r\n-                      <Text>Experience: {matchedDriver?.experienceYears || \"N/A\"} years</Text>\r\n-                    </View>\r\n-                  </View>\r\n-\r\n-                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 10, gap: 10 }}>\r\n-                    <TouchableOpacity onPress={() => router.push({ pathname: \"/ChatRoom\", params: { bookingId, driverId: matchedDriver?.driverId, passengerId, role: \"passenger\" }})} style={{ backgroundColor: \"#007bff\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n-                      <Text style={{ color: \"#fff\", fontWeight: \"bold\" }}>Chat</Text>\r\n-                    </TouchableOpacity>\r\n-                    <TouchableOpacity onPress={() => setShowRatingModal(false)} style={{ backgroundColor: \"#81C3E1\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n-                      <Text style={{ color: \"white\" }}>Minimize</Text>\r\n-                    </TouchableOpacity>\r\n-                    <TouchableOpacity onPress={cancelRideNow} style={{ backgroundColor: \"#f44336\", flex: 1, alignItems: \"center\", borderRadius: 5, padding: 5 }}>\r\n-                      <Text style={{ color: \"white\" }}>Cancel</Text>\r\n-                    </TouchableOpacity>\r\n-                  </View>\r\n-\r\n-                  {paymentInfo?.paymentMethod?.toLowerCase() === \"gcash\" && paymentInfo?.driverPayment?.number &&(\r\n-                    <View style={{paddingTop:5}}>\r\n-                      <View style={{flexDirection:\"row\", justifyContent:\"space-between\"}}>\r\n-                        <Text style={{ fontWeight: \"700\", marginBottom: 6 }}>GCash Payment</Text>\r\n-                        <Text> Status: <Text style={{ fontWeight: \"700\" }}>{paymentInfo?.paymentStatus || \"none\"}</Text></Text>\r\n-                      </View>\r\n-                      <View style={{flexDirection: \"row\", justifyContent: \"space-between\"}}>\r\n-                        <TouchableOpacity onPress={handleCopy}>\r\n-                          <Text>Number: <Text style={{ fontWeight: '600' }}>{paymentInfo.driverPayment?.number}</Text></Text>\r\n-                          <Text style={{ fontSize: 12, color: '#666' }}>Tap to copy</Text>\r\n-                        </TouchableOpacity>\r\n-                        <TouchableOpacity onPress={() => bookingId && setPaymentStatus(String(bookingId), \"paid\")} disabled={paymentInfo?.paymentStatus === \"paid\"} style={{ backgroundColor: paymentInfo?.paymentStatus === \"paid\" ? \"#9e9e9e\" : \"#2e7d32\", alignItems: \"center\", justifyContent: \"center\", borderRadius: 5, padding: 5 }}>\r\n-                          <Text style={{ color: \"#fff\", fontWeight: \"700\" }}>{paymentInfo?.paymentStatus === \"paid\" ? \"Paid\" : \"Mark Paid\"}</Text>\r\n-                        </TouchableOpacity>\r\n-                      </View>\r\n-                    </View>\r\n-                  )}\r\n-                </View>\r\n-              )}\r\n-            </View>\r\n-\r\n-            {showBookingForm && (\r\n-              <View style={styles.panel}>\r\n-                <Text style={styles.panelTitle}>Booking Details</Text>\r\n-\r\n-                {/* Booking Type */}\r\n-                <View style={{ flexDirection: 'row', gap: 8, marginTop: 6 }}>\r\n-                  {[\r\n-                    { key: 'CLASSIC', label: 'Classic' },\r\n-                    { key: 'GROUP', label: 'Group' },\r\n-                    { key: 'SOLO', label: 'Solo' },\r\n-                  ].map((opt) => {\r\n-                    const active = bookingType === (opt.key as any);\r\n-                    return (\r\n-                      <TouchableOpacity\r\n-                        key={opt.key}\r\n-                        onPress={() => { setBookingType(opt.key as any); if (opt.key !== 'GROUP') setPartySize(2); }}\r\n-                        style={{ flex: 1, backgroundColor: active ? '#111' : '#fff', borderWidth: 1, borderColor: active ? '#111' : '#ccc', paddingVertical: 10, borderRadius: 10, alignItems: 'center' }}\r\n-                      >\r\n-                        <Text style={{ color: active ? '#fff' : '#111', fontWeight: '600' }}>{opt.label}</Text>\r\n-                      </TouchableOpacity>\r\n-                    );\r\n-                  })}\r\n-                </View>\r\n-\r\n-                {bookingType === 'SOLO' && <Text style={{ marginTop: 6, color: '#444' }}>‚Ä¢ VIP ride ‚Äî driver will be dedicated to you.</Text>}\r\n-                {bookingType === 'GROUP' && <Text style={{ marginTop: 6, color: '#444' }}>‚Ä¢ Group ride ‚Äî specify how many passengers (including you).</Text>}\r\n-\r\n-                {bookingType === 'GROUP' && (\r\n-                  <View style={{ marginTop: 8, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>\r\n-                    <Text style={{ fontWeight: '600' }}>Passengers (2-6)</Text>\r\n-                    <View style={{ flexDirection: 'row', alignItems: 'center' }}>\r\n-                      <TouchableOpacity onPress={() => setPartySize((p) => Math.max(2, p - 1))} style={styles.stepBtn}><Text style={{ fontSize: 18 }}>‚Äì</Text></TouchableOpacity>\r\n-                      <Text style={{ minWidth: 28, textAlign: 'center', fontWeight: '700' }}>{partySize}</Text>\r\n-                      <TouchableOpacity onPress={() => setPartySize((p) => Math.min(6, p + 1))} style={styles.stepBtn}><Text style={{ fontSize: 18 }}>Ôºã</Text></TouchableOpacity>\r\n-                    </View>\r\n-                  </View>\r\n-                )}\r\n-\r\n-                <ScrollView style={styles.inputsContainer} keyboardDismissMode=\"on-drag\">\r\n-                  <Text>From:</Text>\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder={bookedFor ? \"Tap the map to set pickup\" : \"GPS pickup\"}\r\n-                    value={pickupName}\r\n-                    editable={false}\r\n-                  />\r\n-\r\n-                  <Text>To:</Text>\r\n-                  <TextInput\r\n-                    style={styles.input}\r\n-                    placeholder=\"Tap the map or search\"\r\n-                    value={dropoffName}\r\n-                    editable={false}\r\n-                  />\r\n-\r\n-                  {bookedFor && (\r\n-                    <>\r\n-                      <Text>Rider Name (required):</Text>\r\n-                      <TextInput style={styles.input} placeholder=\"Juan Dela Cruz\" value={riderName} onChangeText={setRiderName} />\r\n-                      <Text>Rider Phone (optional):</Text>\r\n-                      <TextInput style={styles.input} placeholder=\"09xxxxxxxxx\" keyboardType=\"phone-pad\" value={riderPhone} onChangeText={setRiderPhone} />\r\n-                    </>\r\n-                  )}\r\n-\r\n-                  <TextInput style={styles.input} placeholder=\"Notes sa driver\" placeholderTextColor=\"#A0A0A0\" value={notes} onChangeText={setNotes} />\r\n-                  <Text>Paano ka magbabayad?</Text>\r\n-                  <View style={{ flexDirection: \"row\", justifyContent: \"space-between\", marginTop: 8 }}>\r\n-                    <TouchableOpacity onPress={() => setPaymentMethod(\"Cash\")} style={[styles.paymentOption, paymentMethod === \"Cash\" && styles.paymentSelected]}>\r\n-                      <Text style={paymentMethod === \"Cash\" ? styles.paymentSelectedText : styles.paymentText}>Cash</Text>\r\n-                    </TouchableOpacity>\r\n-                    <TouchableOpacity onPress={() => setPaymentMethod(\"GCash\")} style={[styles.paymentOption, paymentMethod === \"GCash\" && styles.paymentSelected]}>\r\n-                      <Text style={paymentMethod === \"GCash\" ? styles.paymentSelectedText : styles.paymentText}>GCash</Text>\r\n-                    </TouchableOpacity>\r\n-                  </View>\r\n-                </ScrollView>\r\n-\r\n-                <View style={styles.fareContainer}>\r\n-                  <View>\r\n-                    <Text style={styles.totalFare}>Fare:</Text>\r\n-                    <Text style={{ paddingLeft: 20 }}>‚Ç±{fare} {bookingType === 'SOLO' ? '(VIP)' : bookingType === 'GROUP' ? `x${partySize}` : ''}</Text>\r\n-                    <Text style={styles.totalFare}>Total Fare: ‚Ç±{bookingType === 'GROUP' ? (fare * partySize).toFixed(2) : fare.toFixed(2)}</Text>\r\n-                  </View>\r\n-                  <TouchableOpacity\r\n-                    style={[styles.bookButton, ((bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination || (bookedFor && !customPickup)) && { opacity: 0.4 }]}\r\n-                    disabled={(bookingType === 'GROUP' && (partySize < 2 || partySize > 6)) || !destination || (bookedFor && !customPickup)}\r\n-                    onPress={handleBookNow}\r\n-                  >\r\n-                    <Text style={styles.bookButtonText}>BOOK NOW</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-\r\n-            {!showBookingForm && !(searching || !!bookingId || bookingConfirmed || !!matchedDriver) && (\r\n-              <TouchableOpacity onPress={() => setShowBookingForm(true)} style={{ position: \"absolute\", bottom: 10, backgroundColor: \"#81C3E1\", padding: 10, borderRadius: 8 }}>\r\n-                <Text style={{ fontWeight: \"bold\", fontSize: 16, color: \"white\" }}>START BOOKING</Text>\r\n-              </TouchableOpacity>\r\n-            )}\r\n-\r\n-            {/* Rating modal (kept) */}\r\n-            {showRatingModal && (\r\n-              <View style={styles.ratingModalOverlay}>\r\n-                <View style={styles.ratingModal}>\r\n-                  <TouchableOpacity style={styles.dismissButton} onPress={() => { setShowRatingModal(false); AsyncStorage.removeItem(\"driverIdToRate\"); }}>\r\n-                    <Ionicons name=\"close\" size={24} color=\"gray\" />\r\n-                  </TouchableOpacity>\r\n-                  <Text style={styles.modalTitle}>Rate Your Driver</Text>\r\n-                  <View style={styles.starsContainer}>\r\n-                    {[1,2,3,4,5].map((star)=>(\r\n-                      <TouchableOpacity key={star} onPress={() => setSelectedRating(star)}>\r\n-                        <Ionicons name={selectedRating >= star ? \"star\" : \"star-outline\"} size={30} color=\"#FFD700\" />\r\n-                      </TouchableOpacity>\r\n-                    ))}\r\n-                  </View>\r\n-                  <TextInput style={styles.feedbackInput} placeholder=\"Leave a comment (optional)\" placeholderTextColor=\"#A0A0A0\" multiline numberOfLines={3} onChangeText={setNotes} value={notes} />\r\n-                  <TouchableOpacity style={styles.submitButton} onPress={async () => {\r\n-                    try {\r\n-                      const driverIdToRate = await AsyncStorage.getItem(\"driverIdToRate\");\r\n-                      const bookingIdToRate = await AsyncStorage.getItem(\"bookingIdToRate\");\r\n-                      if (!driverIdToRate || !bookingIdToRate) { Alert.alert(\"Error\",\"No driver/booking to rate.\"); return; }\r\n-                      const res = await fetch(`${API_BASE_URL}/api/feedback/rate-driver`, {\r\n-                        method: \"POST\", headers: { \"Content-Type\": \"application/json\" },\r\n-                        body: JSON.stringify({ driverId: driverIdToRate, rating: selectedRating }),\r\n-                      });\r\n-                      if (res.ok && notes) {\r\n-                        await fetch(`${API_BASE_URL}/api/feedback/submit-feedback`, {\r\n-                          method: \"POST\", headers: { \"Content-Type\": \"application/json\" },\r\n-                          body: JSON.stringify({ bookingId: bookingIdToRate, passengerId: await AsyncStorage.getItem(\"passengerId\"), driverId: driverIdToRate, feedback: notes }),\r\n-                        });\r\n-                      }\r\n-                      if (res.ok) {\r\n-                        Alert.alert(\"Success\", \"Thank you for your feedback!\");\r\n-                        setShowRatingModal(false);\r\n-                        await AsyncStorage.removeItem(\"driverIdToRate\");\r\n-                        await AsyncStorage.removeItem(\"bookingIdToRate\");\r\n-                      } else {\r\n-                        const data = await res.json();\r\n-                        Alert.alert(\"Error\", data.message || \"Failed to submit rating.\");\r\n-                      }\r\n-                    } catch { Alert.alert(\"Error\",\"Something went wrong.\"); }\r\n-                  }}>\r\n-                    <Text style={styles.submitButtonText}>Submit</Text>\r\n-                  </TouchableOpacity>\r\n-                </View>\r\n-              </View>\r\n-            )}\r\n-          </View>\r\n-        </View>\r\n-      </TouchableWithoutFeedback>\r\n-    </KeyboardAvoidingView>\r\n-  );\r\n-}\r\n-\r\n-const styles = StyleSheet.create({\r\n-  container: { paddingTop: 40, flex: 1, backgroundColor: \"#fff\" },\r\n-  overlayContainer: { position: \"absolute\", bottom: 0, width: \"100%\", alignItems: 'center', height: 180 },\r\n-  overlay: { width: width, margin: 60 },\r\n-  searchcont: {position: \"absolute\", top: 50, width: \"90%\", alignItems: \"flex-start\", marginLeft: 20},\r\n-  searchWrap: { width: '90%', alignSelf: 'center', zIndex: 20 },\r\n-  searchInput: { backgroundColor: '#FFF', borderRadius: 10, borderWidth: 1, borderColor: '#ddd', padding: 10 },\r\n-  searchResults: { marginTop: 4, backgroundColor: '#FFF', borderRadius: 10, borderWidth: 1, borderColor: '#ddd', maxHeight: 200, overflow: 'hidden' },\r\n-  searchItem: { paddingVertical: 10, paddingHorizontal: 12, borderBottomWidth: 1, borderBottomColor: '#eee' },\r\n-  searchItemText: { color: '#111' },\r\n-\r\n-  toggleChip: { backgroundColor:'#eee', paddingHorizontal:10, paddingVertical:6, borderRadius:10 },\r\n-  toggleChipActive: { backgroundColor:'#111' },\r\n-  toggleChipText: { color:'#111', fontWeight:'600' },\r\n-  toggleChipTextActive: { color:'#fff' },\r\n-\r\n-  modeChip: { backgroundColor:'#eee', paddingHorizontal:10, paddingVertical:6, borderRadius:10 },\r\n-  modeChipActive: { backgroundColor:'#81C3E1' },\r\n-  modeChipText: { color:'#111', fontWeight:'600' },\r\n-  modeChipTextActive: { color:'#fff' },\r\n-\r\n-  panel: { position: 'absolute', bottom: 10, width: '100%', backgroundColor: '#E0F0FF', borderTopLeftRadius: 20, borderTopRightRadius: 20, padding: 15, zIndex: 10 },\r\n-  panelTitle: { fontWeight: 'bold', marginBottom: 5 },\r\n-  inputsContainer: { marginTop: 10, maxHeight: 180 },\r\n-  input: { backgroundColor: '#FFF', borderRadius: 10, padding: 10, marginVertical: 5 },\r\n-\r\n-  stepBtn: { paddingHorizontal: 12, paddingVertical: 6, backgroundColor: '#eee', borderRadius: 8, marginHorizontal: 10 },\r\n-\r\n-  fareContainer: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginTop: 10, borderTopWidth:1 },\r\n-  totalFare: { fontWeight: 'bold' },\r\n-  bookButton: { backgroundColor: '#000', borderRadius: 10, padding: 10 },\r\n-  bookButtonText: { color: '#FFF', fontWeight: 'bold' },\r\n-\r\n-  ratingModalOverlay: { position: \"absolute\", top: -100, left: 0, right: 0, bottom: 10, backgroundColor: \"rgba(0,0,0,0.5)\", justifyContent: \"center\", alignItems: \"center\", zIndex: 999 },\r\n-  ratingModal: { width: \"80%\", backgroundColor: \"#fff\", borderRadius: 10, padding: 20, alignItems: \"center\" },\r\n-  dismissButton: { position: \"absolute\", top: 10, right: 10, zIndex: 10 },\r\n-  modalTitle: { fontSize: 18, fontWeight: \"bold\", marginBottom: 5 },\r\n-  starsContainer: { flexDirection: \"row\", marginBottom: 10 },\r\n-  feedbackInput: { width: \"100%\", borderWidth: 1, borderColor: \"#ddd\", borderRadius: 8, padding: 10, marginBottom: 10, textAlignVertical: \"top\" },\r\n-  submitButton: { backgroundColor: \"#4caf50\", paddingVertical: 10, paddingHorizontal: 20, borderRadius: 8 },\r\n-  submitButtonText: { color: \"#fff\", fontWeight: \"bold\" },\r\n-\r\n-  paymentOption: { flex: 1, borderWidth: 1, borderColor: \"#ccc\", paddingVertical: 6, borderRadius: 10, alignItems: \"center\", marginHorizontal: 5, backgroundColor: \"#fff\" },\r\n-  paymentSelected: { backgroundColor: \"#000\", borderColor: \"#333\" },\r\n-  paymentText: { color: \"#333\", fontWeight: \"600\" },\r\n-  paymentSelectedText: { color: \"#fff\", fontWeight: \"700\" },\r\n-});\r\n-import React, { useState, useEffect, useRef } from \"react\";\r\n-import { View, \r\n-  Text, StyleSheet, Dimensions, TouchableOpacity, StatusBar, \r\n-  TextInput, Alert, KeyboardAvoidingView, Platform, TouchableWithoutFeedback, \r\n   Keyboard, Image, BackHandler, ScrollView, AppState, Linking  } from \"react-native\";\r\n import { Picker } from \"@react-native-picker/picker\";\r\n import { WebView } from \"react-native-webview\";\r\n import type { WebView as WebViewType } from \"react-native-webview\";\r\n@@ -1329,9 +194,11 @@\n   const lastOriginRef = useRef<{lat:number; lng:number} | null>(null);\r\n   const lastRouteFromRef = useRef<{lat:number; lng:number} | null>(null);\r\n   const lastRouteToRef   = useRef<{lat:number; lng:number} | null>(null);\r\n   const lastRouteAtRef   = useRef(0);\r\n+  const [pickupLoc, setPickupLoc] = useState<{ latitude:number; longitude:number } | null>(null);\r\n \r\n+\r\n   const ROUTE_MIN_MOVE_M   = 35;   // recompute if user moved >= 35 m\r\n   const ROUTE_MIN_INTERVAL = 8000; // or every 8s, whichever comes first\r\n \r\n   const toLatLng = (p:{latitude:number; longitude:number}) => ({ lat: p.latitude, lng: p.longitude });\r\n"
                },
                {
                    "date": 1762772694746,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -441,8 +441,15 @@\n       Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n       return;\r\n     }\r\n \r\n+    // after you confirm location exists (e.g., inside the effect that runs when location changes and map is ready)\r\n+    if (location && mapReady) {\r\n+      setPickupLoc({ latitude: location.latitude, longitude: location.longitude });\r\n+      sendToMap({ type: 'setPickup', latitude: location.latitude, longitude: location.longitude });\r\n+    }\r\n+\r\n+\r\n     // draw route immediately\r\n     lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n     lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n     lastRouteAtRef.current   = Date.now();\r\n"
                },
                {
                    "date": 1762779440707,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -440,16 +440,10 @@\n     if (!location) {\r\n       Alert.alert('Location unavailable', 'Waiting for GPS, please try again in a moment.');\r\n       return;\r\n     }\r\n+    \r\n \r\n-    // after you confirm location exists (e.g., inside the effect that runs when location changes and map is ready)\r\n-    if (location && mapReady) {\r\n-      setPickupLoc({ latitude: location.latitude, longitude: location.longitude });\r\n-      sendToMap({ type: 'setPickup', latitude: location.latitude, longitude: location.longitude });\r\n-    }\r\n-\r\n-\r\n     // draw route immediately\r\n     lastRouteFromRef.current = { lat: location.latitude, lng: location.longitude };\r\n     lastRouteToRef.current   = { lat: dest.latitude,     lng: dest.longitude };\r\n     lastRouteAtRef.current   = Date.now();\r\n@@ -1489,10 +1483,10 @@\n     setAlertedBookingComplete(false);\r\n     setTripCompleted(false);\r\n \r\n     const bookingData = {\r\n-      pickupLat: location.latitude,\r\n-      pickupLng: location.longitude,\r\n+      pickupLat: (pickupLoc?.latitude ?? location.latitude),\r\n+      pickupLng: (pickupLoc?.longitude ?? location.longitude),\r\n       destinationLat: destination.latitude,\r\n       destinationLng: destination.longitude,\r\n       fare,\r\n       paymentMethod,\r\n@@ -1501,8 +1495,9 @@\n       pickupPlace: pickupName,\r\n       destinationPlace: dropoffName,\r\n       bookingType,\r\n       partySize: normalizedParty,\r\n+      \r\n     };\r\n     console.log(bookingData);\r\n \r\n     try {\r\n"
                }
            ],
            "date": 1745770351244,
            "name": "Commit-0",
            "content": "import React from \"react\";\r\nimport { View, Text, TouchableOpacity, StyleSheet, StatusBar, Dimensions } from \"react-native\";\r\nimport { useRouter } from \"expo-router\";\r\n\r\nconst { width } = Dimensions.get(\"window\");\r\n\r\nexport default function PassengerHome() {\r\n  const router = useRouter();\r\n\r\n  return (\r\n    <View style={styles.container}>\r\n      <StatusBar barStyle=\"dark-content\" translucent backgroundColor=\"transparent\" />\r\n      \r\n      <View style={styles.inner}>\r\n        <Text style={styles.title}>Welcome, Passenger!</Text>\r\n        <Text style={styles.subtitle}>You are now logged in.</Text>\r\n\r\n        <TouchableOpacity\r\n          style={styles.button}\r\n        //   onPress={() => router.push(\"/somewhere\")} // Replace with your real pages later\r\n        >\r\n          <Text style={styles.buttonText}>Go to Available Rides</Text>\r\n        </TouchableOpacity>\r\n\r\n        <TouchableOpacity\r\n          style={[styles.button, { backgroundColor: \"#DD1F1F\" }]}\r\n          onPress={() => router.push(\"/login_and_reg/plogin\")} // Simulate logout (go back to login)\r\n        >\r\n          <Text style={styles.buttonText}>Log Out</Text>\r\n        </TouchableOpacity>\r\n      </View>\r\n    </View>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { flex: 1, backgroundColor: \"#fff\", alignItems: \"center\", justifyContent: \"center\" },\r\n  inner: { width: width * 0.85, alignItems: \"center\" },\r\n  title: { fontSize: 26, fontWeight: \"bold\", color: \"#414141\", marginBottom: 10 },\r\n  subtitle: { fontSize: 16, color: \"#666\", marginBottom: 30 },\r\n  button: {\r\n    width: \"100%\",\r\n    backgroundColor: \"#5089A3\",\r\n    borderRadius: 8,\r\n    paddingVertical: 14,\r\n    alignItems: \"center\",\r\n    marginBottom: 15,\r\n  },\r\n  buttonText: { color: \"#fff\", fontSize: 16, fontWeight: \"bold\" },\r\n});\r\n"
        }
    ]
}