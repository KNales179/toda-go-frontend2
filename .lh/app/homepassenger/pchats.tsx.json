{
    "sourceFile": "app/homepassenger/pchats.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 10,
            "patches": [
                {
                    "date": 1748350364815,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1748350552062,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,11 +8,11 @@\n   return (\r\n     <View style={styles.container}>\r\n         <Text>Passenger Chats Page</Text>\r\n         <View style={styles.bottomNav}>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n+            <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n             <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n         </View>\r\n     </View>\r\n   );\r\n"
                },
                {
                    "date": 1748350840435,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,24 +1,43 @@\n import React from 'react';\r\n-import { View, Text, StyleSheet, TouchableOpacity, Dimensions } from 'react-native';\r\n-import { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\n-import { router } from 'expo-router'; \r\n-const { width, height } = Dimensions.get(\"window\");\r\n+import { View, Text, StyleSheet, TouchableOpacity, Dimensions, Image } from 'react-native';\r\n+import { Ionicons } from \"@expo/vector-icons\";\r\n+import { router } from 'expo-router';\r\n \r\n-export default function PHistory() {\r\n+const { width } = Dimensions.get(\"window\");\r\n+\r\n+export default function PChats() {\r\n   return (\r\n     <View style={styles.container}>\r\n-        <Text>Passenger Chats Page</Text>\r\n-        <View style={styles.bottomNav}>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home-outline\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n-            <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n-        </View>\r\n+      <Text style={styles.heading}>MESSAGES</Text>\r\n+      <Image source={require('../../assets/chat-image.png')} style={styles.chatImage} />\r\n+      <Text style={styles.message}>Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.</Text>\r\n+\r\n+      <View style={styles.bottomNav}>\r\n+        <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}>\r\n+          <Ionicons name=\"home-outline\" size={30} color=\"black\" />\r\n+          <Text>Home</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}>\r\n+          <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n+          <Text>History</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}>\r\n+          <Ionicons name=\"chatbubbles\" size={30} color=\"black\" />\r\n+          <Text>Chats</Text>\r\n+        </TouchableOpacity>\r\n+        <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}>\r\n+          <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n+          <Text>Profile</Text>\r\n+        </TouchableOpacity>\r\n+      </View>\r\n     </View>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, justifyContent: 'center', alignItems: 'center' },\r\n+  container: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n+  heading: { fontWeight: 'bold', fontSize: 18, marginBottom: 20 },\r\n+  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n+  message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n   bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n });\r\n"
                },
                {
                    "date": 1748351139792,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n export default function PChats() {\r\n   return (\r\n     <View style={styles.container}>\r\n       <Text style={styles.heading}>MESSAGES</Text>\r\n-      <Image source={require('../../assets/chat-image.png')} style={styles.chatImage} />\r\n+      <Image source={require('../../assets/chat.png')} style={styles.chatImage} />\r\n       <Text style={styles.message}>Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.</Text>\r\n \r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}>\r\n"
                },
                {
                    "date": 1748351176561,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,9 @@\n export default function PChats() {\r\n   return (\r\n     <View style={styles.container}>\r\n       <Text style={styles.heading}>MESSAGES</Text>\r\n-      <Image source={require('../../assets/chat.png')} style={styles.chatImage} />\r\n+      <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n       <Text style={styles.message}>Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.</Text>\r\n \r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}>\r\n"
                },
                {
                    "date": 1748422907984,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -7,12 +7,20 @@\n \r\n export default function PChats() {\r\n   return (\r\n     <View style={styles.container}>\r\n-      <Text style={styles.heading}>MESSAGES</Text>\r\n-      <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n-      <Text style={styles.message}>Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.</Text>\r\n+      {/* Top bar with Messages text */}\r\n+      <View style={styles.topBar}>\r\n+        <Text style={styles.heading}>MESSAGES</Text>\r\n+      </View>\r\n \r\n+      <View style={styles.contentContainer}>\r\n+        <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n+        <Text style={styles.message}>\r\n+          Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.\r\n+        </Text>\r\n+      </View>\r\n+\r\n       <View style={styles.bottomNav}>\r\n         <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}>\r\n           <Ionicons name=\"home-outline\" size={30} color=\"black\" />\r\n           <Text>Home</Text>\r\n@@ -34,10 +42,25 @@\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n-  heading: { fontWeight: 'bold', fontSize: 18, marginBottom: 20 },\r\n+  container: { flex: 1, backgroundColor: \"#fff\" },\r\n+  topBar: { marginTop: 40, marginLeft: 20, marginBottom: 20 },\r\n+  heading: { fontWeight: 'bold', fontSize: 22 },\r\n+  contentContainer: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n   chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n   message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n-  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n+  bottomNav: {\r\n+    position: \"absolute\",\r\n+    bottom: 0,\r\n+    flexDirection: \"row\",\r\n+    justifyContent: \"space-around\",\r\n+    width: width,\r\n+    height: 70,\r\n+    backgroundColor: \"white\",\r\n+    borderTopLeftRadius: 30,\r\n+    borderTopRightRadius: 30,\r\n+    alignItems: \"center\",\r\n+    borderWidth: 1,\r\n+    borderColor: \"black\"\r\n+  },\r\n });\r\n"
                },
                {
                    "date": 1757648828089,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,50 +1,99 @@\n-import React from 'react';\r\n-import { View, Text, StyleSheet, TouchableOpacity, Dimensions, Image } from 'react-native';\r\n-import { Ionicons } from \"@expo/vector-icons\";\r\n-import { router } from 'expo-router';\r\n+// PChats.tsx\r\n+import React, { useEffect, useState } from \"react\";\r\n+import { View, Text, FlatList, TouchableOpacity, StyleSheet, Dimensions, ActivityIndicator, Image } from \"react-native\";\r\n+import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n+import { API_BASE_URL } from \"../../config\";\r\n+import { router } from \"expo-router\";\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n+const API = `${API_BASE_URL.replace(/\\/$/, \"\")}/api/chat`;\r\n \r\n export default function PChats() {\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const [sessions, setSessions] = useState<any[]>([]);\r\n+  const [loading, setLoading] = useState(true);\r\n+\r\n+  useEffect(() => {\r\n+    AsyncStorage.getItem(\"passengerId\").then(v => setPassengerId(v)).catch(() => setPassengerId(null));\r\n+  }, []);\r\n+\r\n+  useEffect(() => {\r\n+    if (!passengerId) return;\r\n+    const fetchSessions = async () => {\r\n+      setLoading(true);\r\n+      try {\r\n+        const res = await fetch(`${API}/sessions/passenger/${passengerId}`);\r\n+        const data = await res.json();\r\n+        setSessions(Array.isArray(data) ? data : []);\r\n+      } catch (err) {\r\n+        console.error(\"❌ fetch passenger sessions:\", err);\r\n+      } finally {\r\n+        setLoading(false);\r\n+      }\r\n+    };\r\n+    fetchSessions();\r\n+  }, [passengerId]);\r\n+\r\n+  const renderItem = ({ item }: { item: any }) => (\r\n+    \r\n+    <TouchableOpacity\r\n+      style={styles.row}\r\n+      onPress={() => {\r\n+        router.push({\r\n+          pathname: \"/PChatRoom\",\r\n+          params: {\r\n+            bookingId: String(item.bookingId),\r\n+            driverId: (item.participants || [])[0] || \"\",\r\n+            passengerId: passengerId,\r\n+            role: \"passenger\",\r\n+          },\r\n+        });\r\n+      }}\r\n+    >\r\n+\r\n+      <View style={{ flex: 1 }}>\r\n+        <Text style={styles.booking}>Booking #{item.bookingId}</Text>\r\n+        <Text numberOfLines={1} style={styles.preview}>{item.lastMessage || \"— no messages yet —\"}</Text>\r\n+      </View>\r\n+      <Text style={styles.time}>{item.lastAt ? new Date(item.lastAt).toLocaleString() : \"\"}</Text>\r\n+    </TouchableOpacity>\r\n+  );\r\n+\r\n+  if (loading) return <View style={styles.loading}><ActivityIndicator /></View>;\r\n+\r\n   return (\r\n     <View style={styles.container}>\r\n-      {/* Top bar with Messages text */}\r\n-      <View style={styles.topBar}>\r\n-        <Text style={styles.heading}>MESSAGES</Text>\r\n-      </View>\r\n+      <Text style={styles.title}>Messages</Text>\r\n+      {sessions.length === 0 ? (\r\n+        <View style={styles.container}>\r\n+          {/* Top bar with Messages text */}\r\n+          <View style={styles.topBar}>\r\n+            <Text style={styles.heading}>MESSAGES</Text>\r\n+          </View>\r\n \r\n-      <View style={styles.contentContainer}>\r\n-        <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n-        <Text style={styles.message}>\r\n-          Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.\r\n-        </Text>\r\n-      </View>\r\n-\r\n-      <View style={styles.bottomNav}>\r\n-        <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}>\r\n-          <Ionicons name=\"home-outline\" size={30} color=\"black\" />\r\n-          <Text>Home</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}>\r\n-          <Ionicons name=\"document-text-outline\" size={30} color=\"black\" />\r\n-          <Text>History</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}>\r\n-          <Ionicons name=\"chatbubbles\" size={30} color=\"black\" />\r\n-          <Text>Chats</Text>\r\n-        </TouchableOpacity>\r\n-        <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}>\r\n-          <Ionicons name=\"person-outline\" size={30} color=\"black\" />\r\n-          <Text>Profile</Text>\r\n-        </TouchableOpacity>\r\n-      </View>\r\n+          <View style={styles.contentContainer}>\r\n+            <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n+            <Text style={styles.message}>\r\n+              Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.\r\n+            </Text>\r\n+          </View>\r\n+        </View>\r\n+      ) : (\r\n+        <FlatList data={sessions} keyExtractor={(i) => String(i.bookingId)} renderItem={renderItem} />\r\n+      )}\r\n     </View>\r\n   );\r\n }\r\n \r\n const styles = StyleSheet.create({\r\n-  container: { flex: 1, backgroundColor: \"#fff\" },\r\n+  container: { flex: 1, padding: 16, paddingTop: 50 },\r\n+  title: { fontSize: 20, fontWeight: \"700\", marginBottom: 12 },\r\n+  row: { padding: 12, borderBottomWidth: 1, borderColor: \"#eee\", flexDirection: \"row\", alignItems: \"center\" },\r\n+  booking: { fontWeight: \"700\" },\r\n+  preview: { color: \"#333\", marginTop: 4, maxWidth: 220 },\r\n+  time: { fontSize: 11, color: \"#888\" },\r\n+  loading: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n   topBar: { marginTop: 40, marginLeft: 20, marginBottom: 20 },\r\n   heading: { fontWeight: 'bold', fontSize: 22 },\r\n   contentContainer: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n   chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n"
                },
                {
                    "date": 1757651052037,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -62,15 +62,11 @@\n   if (loading) return <View style={styles.loading}><ActivityIndicator /></View>;\r\n \r\n   return (\r\n     <View style={styles.container}>\r\n-      <Text style={styles.title}>Messages</Text>\r\n+      <Text style={styles.title}>MESSAGES</Text>\r\n       {sessions.length === 0 ? (\r\n         <View style={styles.container}>\r\n-          {/* Top bar with Messages text */}\r\n-          <View style={styles.topBar}>\r\n-            <Text style={styles.heading}>MESSAGES</Text>\r\n-          </View>\r\n \r\n           <View style={styles.contentContainer}>\r\n             <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n             <Text style={styles.message}>\r\n"
                },
                {
                    "date": 1760947044097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,82 +1,153 @@\n-// PChats.tsx\r\n-import React, { useEffect, useState } from \"react\";\r\n-import { View, Text, FlatList, TouchableOpacity, StyleSheet, Dimensions, ActivityIndicator, Image } from \"react-native\";\r\n-import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n+import React, { useEffect, useRef, useState, useCallback } from \"react\";\r\n+import {\r\n+  View, Text, FlatList, TouchableOpacity, StyleSheet,\r\n+  Dimensions, ActivityIndicator, Image\r\n+} from \"react-native\";\r\n import { API_BASE_URL } from \"../../config\";\r\n import { router } from \"expo-router\";\r\n+import { io } from \"socket.io-client\";\r\n+import type { Socket } from \"socket.io-client\";\r\n+import { useAuth } from \"../utils/authContext\"; // ⬅️ from the tiny provider we added\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n const API = `${API_BASE_URL.replace(/\\/$/, \"\")}/api/chat`;\r\n+const SOCKET_URL = API_BASE_URL.replace(/\\/api\\/?$/, \"\");\r\n \r\n export default function PChats() {\r\n-  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n+  const { user, bootstrapped } = useAuth(); // ⬅️ single source of truth\r\n   const [sessions, setSessions] = useState<any[]>([]);\r\n   const [loading, setLoading] = useState(true);\r\n+  const socketRef = useRef<Socket | null>(null);\r\n \r\n+  // Derived passengerId from auth (null if not logged / wrong role)\r\n+  const passengerId = user?.role === \"passenger\" ? user.userId : null;\r\n+\r\n+  const fetchSessions = useCallback(async () => {\r\n+    if (!passengerId) return;\r\n+    try {\r\n+      const res = await fetch(`${API}/sessions/passenger/${passengerId}`);\r\n+      const data = await res.json();\r\n+      setSessions(Array.isArray(data) ? data : []);\r\n+    } catch (err) {\r\n+      console.error(\"❌ fetch passenger sessions:\", err);\r\n+    } finally {\r\n+      setLoading(false);\r\n+    }\r\n+  }, [passengerId]);\r\n+\r\n+  // Mount logs to confirm context works here\r\n   useEffect(() => {\r\n-    AsyncStorage.getItem(\"passengerId\").then(v => setPassengerId(v)).catch(() => setPassengerId(null));\r\n+    console.log(\"AUTH:S1:pchats:mount\");\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n-    if (!passengerId) return;\r\n-    const fetchSessions = async () => {\r\n-      setLoading(true);\r\n-      try {\r\n-        const res = await fetch(`${API}/sessions/passenger/${passengerId}`);\r\n-        const data = await res.json();\r\n-        setSessions(Array.isArray(data) ? data : []);\r\n-      } catch (err) {\r\n-        console.error(\"❌ fetch passenger sessions:\", err);\r\n-      } finally {\r\n-        setLoading(false);\r\n-      }\r\n-    };\r\n+    console.log(\"AUTH:S2:pchats:ctx\", { bootstrapped, user });\r\n+  }, [bootstrapped, user]);\r\n+\r\n+  // Socket + initial fetch whenever passengerId becomes available\r\n+  useEffect(() => {\r\n+    if (!bootstrapped) return;          \r\n+    if (!passengerId) {                  // no user or not a passenger\r\n+      setSessions([]);\r\n+      setLoading(false);\r\n+      return;\r\n+    }\r\n+\r\n+    // connect socket once per passengerId\r\n+    const s = io(SOCKET_URL, { transports: [\"websocket\"] });\r\n+    socketRef.current = s;\r\n+\r\n+    // initial fetch\r\n     fetchSessions();\r\n-  }, [passengerId]);\r\n \r\n+    // subscribe for updates\r\n+    const onUpd = () => {\r\n+      fetchSessions();\r\n+    };\r\n+    s.emit(\"sessions:subscribe\", { passengerId, role: \"passenger\" });\r\n+    s.on(\"sessions:update\", onUpd);\r\n+\r\n+    return () => {\r\n+      s.off(\"sessions:update\", onUpd);\r\n+      s.disconnect();\r\n+      socketRef.current = null;\r\n+    };\r\n+  }, [bootstrapped, passengerId, fetchSessions]);\r\n+\r\n+  if (!bootstrapped) {\r\n+    // Context not hydrated yet\r\n+    return (\r\n+      <View style={styles.loading}>\r\n+        <ActivityIndicator />\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n+  if (user?.role !== \"passenger\") {\r\n+    // Friendly guard if a driver somehow reaches this screen\r\n+    return (\r\n+      <View style={styles.container}>\r\n+        <Text style={styles.title}>MESSAGES</Text>\r\n+        <Text style={{ marginTop: 12 }}>This page is for passenger accounts.</Text>\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n+  if (loading) {\r\n+    return (\r\n+      <View style={styles.loading}>\r\n+        <ActivityIndicator />\r\n+      </View>\r\n+    );\r\n+  }\r\n+\r\n   const renderItem = ({ item }: { item: any }) => (\r\n-    \r\n     <TouchableOpacity\r\n       style={styles.row}\r\n-      onPress={() => {\r\n+      onPress={() =>\r\n         router.push({\r\n-          pathname: \"/PChatRoom\",\r\n+          pathname: \"/ChatRoom\",\r\n           params: {\r\n-            bookingId: String(item.bookingId),\r\n-            driverId: (item.participants || [])[0] || \"\",\r\n-            passengerId: passengerId,\r\n+            bookingId: String(item.bookingId ?? \"\"),\r\n+            driverId: item.driverId,\r\n+            passengerId: passengerId!, // from auth\r\n             role: \"passenger\",\r\n           },\r\n-        });\r\n-      }}\r\n+        })\r\n+      }\r\n     >\r\n-\r\n       <View style={{ flex: 1 }}>\r\n-        <Text style={styles.booking}>Booking #{item.bookingId}</Text>\r\n-        <Text numberOfLines={1} style={styles.preview}>{item.lastMessage || \"— no messages yet —\"}</Text>\r\n+        <Text style={styles.booking}>{item.driverName || \"Driver\"}</Text>\r\n+        <Text numberOfLines={1} style={styles.preview}>\r\n+          {item.lastMessage || \"— no messages yet —\"}\r\n+        </Text>\r\n       </View>\r\n-      <Text style={styles.time}>{item.lastAt ? new Date(item.lastAt).toLocaleString() : \"\"}</Text>\r\n+      <Text style={styles.time}>\r\n+        {item.lastAt ? new Date(item.lastAt).toLocaleString() : \"\"}\r\n+      </Text>\r\n     </TouchableOpacity>\r\n   );\r\n \r\n-  if (loading) return <View style={styles.loading}><ActivityIndicator /></View>;\r\n-\r\n   return (\r\n     <View style={styles.container}>\r\n       <Text style={styles.title}>MESSAGES</Text>\r\n       {sessions.length === 0 ? (\r\n-        <View style={styles.container}>\r\n-\r\n-          <View style={styles.contentContainer}>\r\n-            <Image source={require('../../assets/images/chat.png')} style={styles.chatImage} />\r\n-            <Text style={styles.message}>\r\n-              Ang message dito ay lalabas kapag naka pag book ka na ng ride sa iyong driver.\r\n-            </Text>\r\n-          </View>\r\n+        <View style={styles.contentContainer}>\r\n+          <Image\r\n+            source={require(\"../../assets/images/chat.png\")}\r\n+            style={styles.chatImage}\r\n+          />\r\n+          <Text style={styles.message}>\r\n+            Ang message dito ay lalabas kapag nakapag-book ka na at may kausap na driver.\r\n+          </Text>\r\n         </View>\r\n       ) : (\r\n-        <FlatList data={sessions} keyExtractor={(i) => String(i.bookingId)} renderItem={renderItem} />\r\n+        <FlatList\r\n+          data={sessions}\r\n+          keyExtractor={(i) => `${i.driverId}-${i.bookingId ?? \"\"}`}\r\n+          renderItem={renderItem}\r\n+        />\r\n       )}\r\n     </View>\r\n   );\r\n }\r\n@@ -88,24 +159,8 @@\n   booking: { fontWeight: \"700\" },\r\n   preview: { color: \"#333\", marginTop: 4, maxWidth: 220 },\r\n   time: { fontSize: 11, color: \"#888\" },\r\n   loading: { flex: 1, justifyContent: \"center\", alignItems: \"center\" },\r\n-  topBar: { marginTop: 40, marginLeft: 20, marginBottom: 20 },\r\n-  heading: { fontWeight: 'bold', fontSize: 22 },\r\n-  contentContainer: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 20 },\r\n-  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: 'contain' },\r\n-  message: { textAlign: 'center', fontSize: 14, color: '#333' },\r\n-  bottomNav: {\r\n-    position: \"absolute\",\r\n-    bottom: 0,\r\n-    flexDirection: \"row\",\r\n-    justifyContent: \"space-around\",\r\n-    width: width,\r\n-    height: 70,\r\n-    backgroundColor: \"white\",\r\n-    borderTopLeftRadius: 30,\r\n-    borderTopRightRadius: 30,\r\n-    alignItems: \"center\",\r\n-    borderWidth: 1,\r\n-    borderColor: \"black\"\r\n-  },\r\n+  contentContainer: { flex: 1, justifyContent: \"center\", alignItems: \"center\", paddingHorizontal: 20 },\r\n+  chatImage: { width: 150, height: 150, marginBottom: 20, resizeMode: \"contain\" },\r\n+  message: { textAlign: \"center\", fontSize: 14, color: \"#333\" },\r\n });\r\n"
                },
                {
                    "date": 1760960785376,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -6,16 +6,16 @@\n import { API_BASE_URL } from \"../../config\";\r\n import { router } from \"expo-router\";\r\n import { io } from \"socket.io-client\";\r\n import type { Socket } from \"socket.io-client\";\r\n-import { useAuth } from \"../utils/authContext\"; // ⬅️ from the tiny provider we added\r\n+import { useAuth } from \"../utils/authContext\";\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n const API = `${API_BASE_URL.replace(/\\/$/, \"\")}/api/chat`;\r\n const SOCKET_URL = API_BASE_URL.replace(/\\/api\\/?$/, \"\");\r\n \r\n export default function PChats() {\r\n-  const { user, bootstrapped } = useAuth(); // ⬅️ single source of truth\r\n+  const { user, bootstrapped } = useAuth();\r\n   const [sessions, setSessions] = useState<any[]>([]);\r\n   const [loading, setLoading] = useState(true);\r\n   const socketRef = useRef<Socket | null>(null);\r\n \r\n@@ -34,34 +34,29 @@\n       setLoading(false);\r\n     }\r\n   }, [passengerId]);\r\n \r\n-  // Mount logs to confirm context works here\r\n   useEffect(() => {\r\n     console.log(\"AUTH:S1:pchats:mount\");\r\n   }, []);\r\n \r\n   useEffect(() => {\r\n     console.log(\"AUTH:S2:pchats:ctx\", { bootstrapped, user });\r\n   }, [bootstrapped, user]);\r\n \r\n-  // Socket + initial fetch whenever passengerId becomes available\r\n   useEffect(() => {\r\n-    if (!bootstrapped) return;          \r\n-    if (!passengerId) {                  // no user or not a passenger\r\n+    if (!bootstrapped) return;\r\n+    if (!passengerId) {\r\n       setSessions([]);\r\n       setLoading(false);\r\n       return;\r\n     }\r\n \r\n-    // connect socket once per passengerId\r\n     const s = io(SOCKET_URL, { transports: [\"websocket\"] });\r\n     socketRef.current = s;\r\n \r\n-    // initial fetch\r\n     fetchSessions();\r\n \r\n-    // subscribe for updates\r\n     const onUpd = () => {\r\n       fetchSessions();\r\n     };\r\n     s.emit(\"sessions:subscribe\", { passengerId, role: \"passenger\" });\r\n@@ -74,18 +69,16 @@\n     };\r\n   }, [bootstrapped, passengerId, fetchSessions]);\r\n \r\n   if (!bootstrapped) {\r\n-    // Context not hydrated yet\r\n     return (\r\n       <View style={styles.loading}>\r\n         <ActivityIndicator />\r\n       </View>\r\n     );\r\n   }\r\n \r\n   if (user?.role !== \"passenger\") {\r\n-    // Friendly guard if a driver somehow reaches this screen\r\n     return (\r\n       <View style={styles.container}>\r\n         <Text style={styles.title}>MESSAGES</Text>\r\n         <Text style={{ marginTop: 12 }}>This page is for passenger accounts.</Text>\r\n@@ -109,9 +102,9 @@\n           pathname: \"/ChatRoom\",\r\n           params: {\r\n             bookingId: String(item.bookingId ?? \"\"),\r\n             driverId: item.driverId,\r\n-            passengerId: passengerId!, // from auth\r\n+            passengerId: passengerId!,\r\n             role: \"passenger\",\r\n           },\r\n         })\r\n       }\r\n"
                },
                {
                    "date": 1760983383582,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,27 +1,41 @@\n+// PChats.tsx – no auth context; uses AsyncStorage(passengerId)\r\n+\r\n import React, { useEffect, useRef, useState, useCallback } from \"react\";\r\n import {\r\n   View, Text, FlatList, TouchableOpacity, StyleSheet,\r\n   Dimensions, ActivityIndicator, Image\r\n } from \"react-native\";\r\n+import AsyncStorage from \"@react-native-async-storage/async-storage\";\r\n import { API_BASE_URL } from \"../../config\";\r\n import { router } from \"expo-router\";\r\n import { io } from \"socket.io-client\";\r\n import type { Socket } from \"socket.io-client\";\r\n-import { useAuth } from \"../utils/authContext\";\r\n \r\n const { width } = Dimensions.get(\"window\");\r\n const API = `${API_BASE_URL.replace(/\\/$/, \"\")}/api/chat`;\r\n const SOCKET_URL = API_BASE_URL.replace(/\\/api\\/?$/, \"\");\r\n \r\n export default function PChats() {\r\n-  const { user, bootstrapped } = useAuth();\r\n+  const [passengerId, setPassengerId] = useState<string | null>(null);\r\n   const [sessions, setSessions] = useState<any[]>([]);\r\n   const [loading, setLoading] = useState(true);\r\n+  const [hydrating, setHydrating] = useState(true); // wait for AsyncStorage\r\n   const socketRef = useRef<Socket | null>(null);\r\n \r\n-  // Derived passengerId from auth (null if not logged / wrong role)\r\n-  const passengerId = user?.role === \"passenger\" ? user.userId : null;\r\n+  // Hydrate passengerId from storage\r\n+  useEffect(() => {\r\n+    let mounted = true;\r\n+    (async () => {\r\n+      try {\r\n+        const pid = await AsyncStorage.getItem(\"passengerId\");\r\n+        if (mounted) setPassengerId(pid);\r\n+      } finally {\r\n+        if (mounted) setHydrating(false);\r\n+      }\r\n+    })();\r\n+    return () => { mounted = false; };\r\n+  }, []);\r\n \r\n   const fetchSessions = useCallback(async () => {\r\n     if (!passengerId) return;\r\n     try {\r\n@@ -34,55 +48,50 @@\n       setLoading(false);\r\n     }\r\n   }, [passengerId]);\r\n \r\n+  // Socket + initial fetch whenever passengerId becomes available\r\n   useEffect(() => {\r\n-    console.log(\"AUTH:S1:pchats:mount\");\r\n-  }, []);\r\n+    if (!passengerId) return;\r\n \r\n-  useEffect(() => {\r\n-    console.log(\"AUTH:S2:pchats:ctx\", { bootstrapped, user });\r\n-  }, [bootstrapped, user]);\r\n-\r\n-  useEffect(() => {\r\n-    if (!bootstrapped) return;\r\n-    if (!passengerId) {\r\n-      setSessions([]);\r\n-      setLoading(false);\r\n-      return;\r\n-    }\r\n-\r\n     const s = io(SOCKET_URL, { transports: [\"websocket\"] });\r\n     socketRef.current = s;\r\n \r\n     fetchSessions();\r\n \r\n-    const onUpd = () => {\r\n-      fetchSessions();\r\n-    };\r\n+    const onUpd = () => fetchSessions();\r\n     s.emit(\"sessions:subscribe\", { passengerId, role: \"passenger\" });\r\n     s.on(\"sessions:update\", onUpd);\r\n \r\n     return () => {\r\n       s.off(\"sessions:update\", onUpd);\r\n       s.disconnect();\r\n       socketRef.current = null;\r\n     };\r\n-  }, [bootstrapped, passengerId, fetchSessions]);\r\n+  }, [passengerId, fetchSessions]);\r\n \r\n-  if (!bootstrapped) {\r\n+  // UI states\r\n+  if (hydrating) {\r\n     return (\r\n       <View style={styles.loading}>\r\n         <ActivityIndicator />\r\n       </View>\r\n     );\r\n   }\r\n \r\n-  if (user?.role !== \"passenger\") {\r\n+  if (!passengerId) {\r\n     return (\r\n       <View style={styles.container}>\r\n         <Text style={styles.title}>MESSAGES</Text>\r\n-        <Text style={{ marginTop: 12 }}>This page is for passenger accounts.</Text>\r\n+        <Text style={{ marginTop: 12, marginBottom: 16 }}>\r\n+          You’re not logged in as a passenger.\r\n+        </Text>\r\n+        <TouchableOpacity\r\n+          onPress={() => router.replace(\"/login_and_reg/plogin\")}\r\n+          style={{ padding: 10, backgroundColor: \"#5089A3\", borderRadius: 8 }}\r\n+        >\r\n+          <Text style={{ color: \"#fff\" }}>Go to Passenger Login</Text>\r\n+        </TouchableOpacity>\r\n       </View>\r\n     );\r\n   }\r\n \r\n@@ -102,9 +111,9 @@\n           pathname: \"/ChatRoom\",\r\n           params: {\r\n             bookingId: String(item.bookingId ?? \"\"),\r\n             driverId: item.driverId,\r\n-            passengerId: passengerId!,\r\n+            passengerId, // from AsyncStorage\r\n             role: \"passenger\",\r\n           },\r\n         })\r\n       }\r\n"
                }
            ],
            "date": 1748350364815,
            "name": "Commit-0",
            "content": "import React from 'react';\r\nimport { View, Text, StyleSheet, TouchableOpacity, Dimensions } from 'react-native';\r\nimport { Ionicons, MaterialIcons } from \"@expo/vector-icons\";\r\nimport { router } from 'expo-router'; \r\nconst { width, height } = Dimensions.get(\"window\");\r\n\r\nexport default function PHistory() {\r\n  return (\r\n    <View style={styles.container}>\r\n        <Text>Passenger Chats Page</Text>\r\n        <View style={styles.bottomNav}>\r\n            <TouchableOpacity onPress={() => router.push(\"/homepassenger/phome\")}><Ionicons name=\"home\" size={30} color=\"black\" /><Text>Home</Text></TouchableOpacity>\r\n            <TouchableOpacity onPress={() => router.push(\"/homepassenger/phistory\")}><Ionicons name=\"document-text-outline\" size={30} color=\"black\" /><Text>History</Text></TouchableOpacity>\r\n            <TouchableOpacity onPress={() => router.push(\"/homepassenger/pchats\")}><Ionicons name=\"chatbubbles-outline\" size={30} color=\"black\" /><Text>Chats</Text></TouchableOpacity>\r\n            <TouchableOpacity onPress={() => router.push(\"/homepassenger/pprofile\")}><Ionicons name=\"person-outline\" size={30} color=\"black\" /><Text>Profile</Text></TouchableOpacity>\r\n        </View>\r\n    </View>\r\n  );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n  container: { flex: 1, justifyContent: 'center', alignItems: 'center' },\r\n  bottomNav: { position: \"absolute\", bottom: 0, flexDirection: \"row\", justifyContent: \"space-around\", width: width, height: 70, backgroundColor: \"white\", borderTopLeftRadius: 30, borderTopRightRadius: 30, alignItems: \"center\", borderWidth: 1, borderColor: \"black\" },\r\n});\r\n"
        }
    ]
}